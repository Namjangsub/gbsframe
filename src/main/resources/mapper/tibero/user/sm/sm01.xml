<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm01.mapper.SM01Mapper">
	<!-- 구매목록리스트 -->
	<select id="selectBomSalesCount" parameterType="Map" resultType="int">
        SELECT
        COUNT(*)
        FROM TB_CR02M01 AS A
	       JOIN TB_CR02D02 AS B  ON B.CO_CD    = A.CO_CD AND B.ORDRS_NO = A.ORDRS_NO
	       LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = A.ORDRS_CLNT_CD
	       LEFT OUTER JOIN TB_BM01M01 AS P ON P.PRDT_CD = B.PRDT_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = B.ITEM_DIV
	       LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = B.ORDRS_DTL_DIV20
	       LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = B.ORDRS_DTL_DIV30
		   WHERE  1 = 1
		     AND NVL2(#{coCd},A.CO_CD,'.') = NVL(#{coCd},'.')
		     AND NVL2(#{itemDiv},B.ITEM_DIV,'.') = NVL(#{itemDiv},'.')
		     AND NVL(B.SALES_CD, '.') LIKE '%'||#{salesCd}||'%'
		     AND NVL(C.CLNT_NM, '.') LIKE '%'||#{clntNm}||'%'
		     AND NVL(A.CLNT_PJT, '.') LIKE '%'||#{clntPjt}||'%'
		     AND NVL(P.PRDT_NM, '.') LIKE '%'||#{prdtNm}||'%'
		     AND NVL(B.EQP_NM, '.') LIKE '%'||#{eqpNm}||'%'
	</select>
	
	<select id="selectBomSalesList" parameterType="Map" resultType="camelMap">
        SELECT
        *
        FROM(
        SELECT
        ROWNUM AS RNUM, A.*

        FROM
        (
        SELECT BOM.FILE_TRGT_KEY
		     , A.CO_CD                    --회사코드
		     , R.CODE_NM       AS CO_NM
		     , A.ORDRS_NO                 --수주번호
		     , B.SALES_CD                 --SalesCode
		     , A.ORDRS_CLNT_CD AS CLNT_CD --고객사
		     , C.CLNT_NM                  --고객사
		     , A.CLNT_PJT                 --고객사PJT
		     , B.PRDT_CD                  --제품구분
		     , P.PRDT_NM
		     , B.ITEM_DIV                 --아이템구분
		     , R1.CODE_NM       AS ITEM_DIV_NM
		     , B.ORDRS_DTL_DIV20          --수주설비작업구분
		     , R2.CODE_NM       AS ORDRS_DTL_DIV20_NM
		     , B.ORDRS_DTL_DIV30          --수주설비자체구분
		     , R3.CODE_NM       AS ORDRS_DTL_DIV30_NM
		     , B.DUDT_INTEND_DT           --납기예정일
		     , B.EQP_NM                   --설비명
		     , (SELECT COUNT(*) FROM TB_SM01M01NEW WHERE CO_CD = A.CO_CD AND SALES_CD = B.SALES_CD) AS BOM_CNT
		     , (SELECT COUNT(*) FROM TB_SM01D01NEW WHERE CO_CD = A.CO_CD AND SALES_CD = B.SALES_CD) AS MATR_CNT
        FROM TB_CR02M01 AS A
	       JOIN TB_CR02D02 AS B  ON B.CO_CD    = A.CO_CD AND B.ORDRS_NO = A.ORDRS_NO
	       LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = A.ORDRS_CLNT_CD
	       LEFT OUTER JOIN TB_BM01M01 AS P ON P.PRDT_CD = B.PRDT_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = B.ITEM_DIV
	       LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = B.ORDRS_DTL_DIV20
	       LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = B.ORDRS_DTL_DIV30
	       LEFT OUTER JOIN (
				SELECT FILE_TRGT_KEY, CO_CD, SALES_CD 
				  FROM TB_SM01M01NEW X1
				 WHERE LEVEL = 1
		        START WITH X1.UPPER_CD = '.'
		        CONNECT BY PRIOR X1.LOWER_CD = X1.UPPER_CD
	       ) AS BOM ON A.CO_CD = BOM.CO_CD AND B.SALES_CD = BOM.SALES_CD
		   WHERE  1 = 1
		     AND NVL2(#{coCd},A.CO_CD,'.') = NVL(#{coCd},'.')
		     AND NVL2(#{itemDiv},B.ITEM_DIV,'.') = NVL(#{itemDiv},'.')
		     AND NVL(B.SALES_CD, '.') LIKE '%'||#{salesCd}||'%'
		     AND NVL(C.CLNT_NM, '.') LIKE '%'||#{clntNm}||'%'
		     AND NVL(A.CLNT_PJT, '.') LIKE '%'||#{clntPjt}||'%'
		     AND NVL(P.PRDT_NM, '.') LIKE '%'||#{prdtNm}||'%'
		     AND NVL(B.EQP_NM, '.') LIKE '%'||#{eqpNm}||'%'
        ORDER BY A.CO_CD, CASE WHEN MATR_CNT = 0 THEN 1 ELSE 0 END, CASE WHEN BOM_CNT = 0 THEN 1 ELSE 0 END, B.SALES_CD
        ) AS a
        ) A
        WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>
	
	<!-- 구매BOM 자재 리스트 -->
	<select id="selectBomDetailCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
        FROM TB_SM01M01 T
        WHERE 1=1
        START WITH T.UPPER_CD = '.' AND FILE_TRGT_KEY = #{fileTrgtKey}
        CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
	</select>
	
	<select id="selectBomDetailList" parameterType="Map" resultType="camelMap">
        SELECT T.FILE_TRGT_KEY
        , T.LVL
        , T.CO_CD
        , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
		, T.SALES_CD
		, T.PART_NO
		, T.UNIT_NO
		, T.REV_NO
		, T.DSGN_NO
		, T.UPPER_CD
		, T.LOWER_CD
		, D.MATR_SEQ
		, D.ORDRG_DIV_10
		, D.ORDRG_DIV_20
		, D.NEXT_PRCSN_NM
		, D.DLVPLC_NM
		, D.MATR_CD
		, D.MATR_NM
		, D.GOODS_DIV
		, D.MATR_CLNT_DIV
		, D.MATR_DIV
		, D.MATR_GRP
		, D.MATR_MAT
		, D.MATR_SIZE
		, D.MATR_SPEC
		, D.MATR_MAKR_NM
		, D.MATR_MNO
		, D.MATR_WT
		, D.MATR_UNIT
		, D.ORIGIN_NM
		, D.MATR_DRW_NO
		, D.MATR_TEST_DIV
		, D.DLVR_RQM_DAY
		, D.MATR_PURC_DIV
		, D.MIN_ORDRG_QTY
		, D.MATR_SAFT_QTY
		, D.MATR_STOCK_CD
		, D.DSGN_2D_MD
		, D.AVRG_2D_MD
		, D.DSGN_3D_MD
		, D.AVRG_3D_MD
		, D.PRDCTN_RQM_MD
		, D.PRDCTN_AVRG_MD
		, D.USE_YN
		, D.MATR_PART_NO
		, D.PCHS_CLNT_CD1
		, D.PCHS_CLNT_PCT1
		, D.PCHS_CLNT_CD2
		, D.PCHS_CLNT_PCT2
		, D.PCHS_CLNT_CD3
		, D.PCHS_CLNT_PCT3
		, D.MATR_UPR
		, D.MATR_AVRG_UPR
		, D.MATR_RMK
		, D.MATR_LAST_TRST_DT
		, D.MATR_ATNT_CD
		, D.MATR_NO
		, T.ETC_FIELD1
		, T.ETC_FIELD2
		, T.ETC_FIELD3
        , T.CREAT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS CREAT_NM
        , TO_CHAR(T.CREAT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS CREAT_DTTM
        , T.UDT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.UDT_ID) AS UDT_NM
        , TO_CHAR(T.UDT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS UDT_DTTM
        FROM
  		( SELECT X1.*, LEVEL AS LVL FROM TB_SM01M01NEW X1
           START WITH X1.UPPER_CD = '.' AND X1.SALES_CD = #{salesCd}
          CONNECT BY PRIOR X1.LOWER_CD = X1.UPPER_CD
        ) T
        INNER JOIN TB_SM01D01NEW D
		ON T.CO_CD = D.CO_CD AND T.SALES_CD = D.SALES_CD AND T.UPPER_CD = D.UPPER_CD AND T.LOWER_CD = D.LOWER_CD
        LEFT OUTER JOIN
        ( SELECT T1.CO_CD
		        , T2.SALES_CD
		        , T2.PRDT_CD
		        , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_NM
		        , T2.ITEM_DIV
		        , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
		        , T1.CLNT_PJT
		        , T2.EQP_NM
		        , T3.CLNT_NM
		        FROM TB_CR02M01 AS T1
		        JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
		        LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
        ) A
        ON T.CO_CD = A.CO_CD AND T.SALES_CD = A.SALES_CD
		WHERE 1=1
		ORDER BY T.CO_CD, NVL(T.PART_NO,'0'), NVL(T.UNIT_NO,'0'), NVL(T.REV_NO,'0'),T.LOWER_CD, T.UPPER_CD
		         , D.MATR_SEQ
	</select>

	<!-- 매출등록팝업 -->
	<select id="addSellDscnCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) AS RESULT_COUNT
			FROM TB_CR02M01 AS ORDRS
			JOIN TB_CR02D01 AS CLMN ON CLMN.CO_CD = ORDRS.CO_CD AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
			LEFT JOIN (
			    SELECT CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ, MAX(CD.CURR_CD) AS CONF_CURR_CD, NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT
			    FROM TB_CR03M01 AS CM
			    JOIN TB_CR03D01 AS CD ON CD.CO_CD = CM.CO_CD AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			    GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			) AS CONF ON CONF.CO_CD = CLMN.CO_CD AND CONF.ORDRS_NO = CLMN.ORDRS_NO AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
			LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD
			LEFT JOIN TB_CM05M01 AS R ON R.CODE_ID = ORDRS.CO_CD
			LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV
			LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD
			LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV
			LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD
			WHERE ORDRS.CO_CD LIKE '%${coCd}%' --회사
			AND NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${clntCd}%' --고객사
			AND NVL(C.CLNT_NM, '.') LIKE '%${clntNm}%' --고객사명

	</select>
	
	<select id="addSellDscnList" parameterType="Map" resultType="camelMap">
		SELECT DISTINCT ORDRS.FILE_TRGT_KEY AS FILE_TRGT_KEY --파일대상KEY
			 , ROWNUM	AS 	RN
		     , ORDRS.CO_CD             AS CO_CD             --회사코드
		     , R.CODE_NM               AS CO_CD_NM          --회사명
		     , ORDRS.ORDRS_NO          AS ORDRS_NO          --수주번호
		     , TO_CHAR(ORDRS.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT --수주일자
		     , ORDRS.ORDRS_CLNT_CD     AS ORDRS_CLNT_CD     --고객사
		     , C.CLNT_NM               AS ORDRS_CLNT_NM     --고객사명
		     , ORDRS.CLNT_PJT          AS CLNT_PJT          --고객사PJT
		     , ORDRS.CTRT_NM           AS CTRT_NM           --계약명
		     , ORDRS.CURR_CD           AS ORDRS_CURR_CD     --통화단위
		     , R2.CODE_NM              AS ORDRS_CURR_NM     --통화단위명
		     , NVL(ORDRS.EXRATE, 1)    AS ORDRS_EXRATE      --환율
		     <!-- 수주수금계획 -->
		     , CLMN.CLMN_PLAN_SEQ      AS CLMN_PLAN_SEQ     --수금계획순번
		     , CLMN.CLMN_PLAN_DIV      AS CLMN_PLAN_DIV     --수금구분
		     , R3.CODE_NM              AS CLMN_PLAN_DIV_NM  --수금구분명
		     , CLMN.CLMN_DIV_SEQ       AS CLMN_DIV_SEQ      --수금구분차수
		     , CLMN.CLMN_RATE          AS CLMN_RATE         --수금비율
		     , CLMN.CURR_CD            AS CLMN_CURR_CD      --통화단위
		     , R4.CODE_NM              AS CLMN_CURR_NM      --통화단위명
		     , NVL(CLMN.EXRATE, 1)     AS CLMN_EXRATE       --환율
		     , CLMN.CLMN_AMT           AS CLMN_AMT          --수금금액
		     , TO_CHAR(CLMN.BILL_PBLS_DT, 'YYYY-MM-DD') AS CLMN_BILL_PBLS_DT --계산서발행일자
		     , TO_CHAR(CLMN.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT           --수금일자
		     , CONF.CONF_AMT                 AS BEF_CONF_AMT --기 확정금액
		     , CLMN.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT   --미 확정금액
		     , 'N'                           AS CHK          --체크여부
		     , 0                             AS CONF_AMT     --확정금액
		     <!-- 계산서 발행 후 지급시기 -->
		     <!-- , CLMN.PMNT_DT_AFTER_BILL AS CLMN_PMNT_DT_AFTER_BILL  -->
		     <!-- 비고 -->
		     <!-- , CLMN.CLMN_PLAN_RMK      AS CLMN_PLAN_RMK      -->
		     <!--  수금관리상황 -->
		     <!-- , CLMN.CLMN_MGMT_STATUS   AS CLMN_MGMT_STATUS -->  
		FROM   TB_CR02M01 AS ORDRS
		       <!-- 수주수금계획 -->
		       JOIN TB_CR02D01 AS CLMN  ON CLMN.CO_CD    = ORDRS.CO_CD
				                       AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
		       <!-- 매출확정 -->
		       LEFT JOIN (
			              SELECT CM.CO_CD                                          --회사코드
			                   , CD.ORDRS_NO                                       --수주번호
			                   , CD.CLMN_PLAN_SEQ                                  --수금계획순번
			                   , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
			                   , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
			              FROM   TB_CR03M01 AS CM
			                     JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
									                  AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			              GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			             ) AS CONF  ON CONF.CO_CD         = CLMN.CO_CD
					               AND CONF.ORDRS_NO      = CLMN.ORDRS_NO
					               AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
		       LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD     --고객사
		       LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD	--회사
		       LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV	--수주구분
		       LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD		--통화단위
		       LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV	--수금구분
		       LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD	--통화단위
		WHERE  ORDRS.CO_CD LIKE '%${coCd}%' --회사
		AND    NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${clntCd}%' --고객사
		AND    NVL(C.CLNT_NM      , '.') LIKE '%${clntNm}%' --고객사명
		ORDER BY ORDRS.CO_CD, ORDRS.ORDRS_NO, CLMN.CLMN_PLAN_SEQ
	</select>

	 

</mapper>