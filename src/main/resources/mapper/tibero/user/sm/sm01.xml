<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dksys.biz.user.sm.sm01.mapper.SM01Mapper">
    <select id="selectBomCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_SM01M01 A
        WHERE 1 = 1
    </select>
    <select id="selectBomDetailCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_SM01D01 A
        WHERE 1 = 1
    </select>


    <select id="selectBomInfo" resultType="CamelMap">
        SELECT *
        FROM (
            SELECT T.*,row_number() OVER (ORDER BY file_trgt_key)
            AS RNUM FROM (
            SELECT *
            FROM TB_SM01M01
            <where> 1 = 1

                <if test="salesCd != null and !salesCd.equals('')">
                    AND sales_cd = #{salesCd}
                </if>

            </where>
            ) T
            ) Z
            LEFT JOIN (
            SELECT
                PRDT_CD,
                ITEM_DIV,
                ORDRS_DTL_DIV20,
                ORDRS_DTL_DIV30,
                TO_CHAR(DUDT_INTEND_DT, 'YYYY-MM-DD') AS DUDT_INTEND_DT,
                SALES_CD,
                ORDRS_NO,
                CO_CD
            FROM TB_CR02D02
            ) D
            ON Z.SALES_CD = D.SALES_CD
            LEFT JOIN (
            SELECT *
            FROM TB_CR02M01
            ) M
            ON D.CO_CD = M.CO_CD
            AND D.ORDRS_NO = M.ORDRS_NO
            LEFT JOIN TB_BM02M01 B ON M.ORDRS_CLNT_CD = B.CLNT_CD

    </select>
    <select id="selectBomListMatr" resultType="CamelMap">
        SELECT *
        FROM (
                SELECT T.*,row_number() OVER (ORDER BY file_trgt_key)
        AS RNUM FROM (
        SELECT *
        FROM TB_SM01M01
        <where> 1 = 1
            <if test="coCd != null and !coCd.equals('')">
                AND co_cd = #{coCd}
            </if>
            <if test="salesCd != null and !salesCd.equals('')">
                AND sales_cd = #{salesCd}
            </if>
            <if test="fileTrgtKey != null and !fileTrgtKey.equals('')">
                AND file_trgt_key = #{fileTrgtKey}
            </if>



        </where>
        ) T ) Z
        LEFT JOIN (
            SELECT
                PRDT_CD,
                ITEM_DIV,
                ORDRS_DTL_DIV20,
                ORDRS_DTL_DIV30 ,
                TO_CHAR(DUDT_INTEND_DT, 'YYYY-MM-DD') AS DUDT_INTEND_DT,
                SALES_CD,
                ORDRS_NO,
                CO_CD
            FROM TB_CR02D02
        ) D
        ON Z.SALES_CD = D.SALES_CD
        LEFT JOIN (
            SELECT *
            FROM TB_CR02M01
        ) M
        ON D.CO_CD = M.CO_CD
        AND D.ORDRS_NO = M.ORDRS_NO
        LEFT JOIN TB_BM02M01 B ON M.ORDRS_CLNT_CD = B.CLNT_CD
        <where>
            <if test="clntCd != null and !clntCd.equals('')">
                AND B.CLNT_CD = #{clntCd}
            </if>
            <if test="clntPjt != null and !clntPjt.equals('')">
                AND UPPER(M.CLNT_PJT) LIKE '%' || UPPER(#{clntPjt}) || '%'

            </if>
            <if test="prdtCd != null and !prdtCd.equals('')">
                AND UPPER(D.PRDT_CD) LIKE '%' || UPPER(#{prdtCd}) || '%'

            </if>
            AND matr_drw_no IS NOT NULL
        </where>


    </select>
    <select id="selectBomList" resultType="CamelMap">
        SELECT *
        FROM (
        SELECT T.*,row_number() OVER (ORDER BY file_trgt_key)
        AS RNUM FROM (
        SELECT *
        FROM TB_SM01M01
        <where> 1 = 1
            <if test="coCd != null and !coCd.equals('')">
                AND co_cd = #{coCd}
            </if>
            <if test="salesCd != null and !salesCd.equals('')">
                AND sales_cd = #{salesCd}
            </if>
            <if test="fileTrgtKey != null and !fileTrgtKey.equals('')">
                AND file_trgt_key = #{fileTrgtKey}
            </if>



        </where>
        ) T ) Z
        LEFT JOIN (
        SELECT
        PRDT_CD,
        ITEM_DIV,
        ORDRS_DTL_DIV20,
        ORDRS_DTL_DIV30 ,
        TO_CHAR(DUDT_INTEND_DT, 'YYYY-MM-DD') AS DUDT_INTEND_DT,
        SALES_CD,
        ORDRS_NO,
        CO_CD
        FROM TB_CR02D02
        ) D
        ON Z.SALES_CD = D.SALES_CD
        LEFT JOIN (
        SELECT *
        FROM TB_CR02M01
        ) M
        ON D.CO_CD = M.CO_CD
        AND D.ORDRS_NO = M.ORDRS_NO
        LEFT JOIN TB_BM02M01 B ON M.ORDRS_CLNT_CD = B.CLNT_CD
        <where>
            <if test="clntCd != null and !clntCd.equals('')">
                AND B.CLNT_CD = #{clntCd}
            </if>
            <if test="clntPjt != null and !clntPjt.equals('')">
                AND UPPER(M.CLNT_PJT) LIKE '%' || UPPER(#{clntPjt}) || '%'

            </if>
            <if test="prdtCd != null and !prdtCd.equals('')">
                AND UPPER(D.PRDT_CD) LIKE '%' || UPPER(#{prdtCd}) || '%'

            </if>
        </where>


    </select>


    <select id="selectBomDetailList" resultType="CamelMap">
        SELECT * FROM ( SELECT T.*,row_number() OVER (ORDER BY file_trgt_key)
		AS RNUM FROM (SELECT * FROM TB_SM01D01
                      where 1 = 1
                        AND co_cd = #{coCd}
                        AND sales_cd = #{salesCd}
                                                                          ) T ) Z
    </select>

    <delete id="deleteBom">
        DELETE
        FROM TB_SM01M01
        WHERE CO_CD = #{coCd}
    </delete>

    <delete id="deleteBomDetail">
        DELETE
        FROM TB_SM01D01
        WHERE CO_CD = #{coCd}
    </delete>

    <delete id="deleteAllBomDetails">
        DELETE
        FROM TB_SM01D01
        WHERE 1 = 1
          AND CO_CD = #{coCd}
    </delete>
    <update id="updateBom" parameterType="map">
        UPDATE TB_SM01M01
        SET UNIT_NO = #{unitNo},
            REV_NO = #{revNo}
        WHERE CO_CD = #{coCd}
          AND SALES_CD = #{salesCd}
    </update>
    <insert id="insertBomDetailList" parameterType="map">
        INSERT INTO TB_SM01D01
            (CO_CD, SALES_CD, BOM_SEQ,PART_NO, UNIT_NO,REV_NO)
        VALUES
            (#{coCd}, #{salesCd}, #{bomSeq}, #{partNo},
             #{unitNo}, #{revNo})
    </insert>
    <insert id="insertBom" parameterType="map">
        INSERT INTO GUNYANG_DEV.TB_SM01M01 (
            FILE_TRGT_KEY,
            CO_CD,
            SALES_CD,
            PART_NO,
            UNIT_NO,
            REV_NO,
            DSGN_NO,
            MATR_SEQ,
            UPPER_CD,
            LOWER_CD,
            /* additional fields here... */
            UDT_DTTM
        ) VALUES (
                     #{fileTrgtKey},
                     #{coCd},
                     #{salesCd},
                     #{partNo},
                     #{unitNo},
                     #{revNo},
                     #{dsgnNo},
                     #{matrSeq},
                     #{upperCd},
                     #{lowerCd},
                     /* additional values here... */
                     CURRENT_TIMESTAMP
                 )
    </insert>

</mapper>