<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm01.mapper.SM01Mapper">

	<select id="selectBomSalesCount" parameterType="Map" resultType="int">
        SELECT
        COUNT(*)
        FROM TB_CR02M01 AS A
	       JOIN TB_CR02D02 AS B  ON B.CO_CD    = A.CO_CD AND B.ORDRS_NO = A.ORDRS_NO
	       LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = A.ORDRS_CLNT_CD
	       LEFT OUTER JOIN TB_BM01M01 AS P ON P.PRDT_CD = B.PRDT_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = B.ITEM_DIV
	       LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = B.ORDRS_DTL_DIV20
	       LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = B.ORDRS_DTL_DIV30
		   WHERE  1 = 1
		     AND NVL2(#{coCd},A.CO_CD,'.') = NVL(#{coCd},'.')
		     AND NVL2(#{itemDiv},B.ITEM_DIV,'.') = NVL(#{itemDiv},'.')
		     AND NVL(B.SALES_CD, '.') LIKE '%'||#{salesCd}||'%'
		     AND NVL(C.CLNT_NM, '.') LIKE '%'||#{clntNm}||'%'
		     AND NVL(A.CLNT_PJT, '.') LIKE '%'||#{clntPjt}||'%'
		     AND NVL(P.PRDT_NM, '.') LIKE '%'||#{prdtNm}||'%'
		     AND NVL(B.EQP_NM, '.') LIKE '%'||#{eqpNm}||'%'
	</select>

	<select id="selectBomSalesList" parameterType="Map" resultType="CamelMap">
        SELECT
        *
        FROM(
        SELECT
        ROWNUM AS RNUM, A.*

        FROM
        (
        SELECT BOM.FILE_TRGT_KEY
		     , A.CO_CD                    --회사코드
		     , R.CODE_NM       AS CO_NM
		     , A.ORDRS_NO                 --수주번호
		     , B.SALES_CD                 --SalesCode
		     , A.ORDRS_CLNT_CD AS CLNT_CD --고객사
		     , C.CLNT_NM                  --고객사
		     , A.CLNT_PJT                 --고객사PJT
		     , B.PRDT_CD                  --제품구분
		     , P.PRDT_NM
		     , B.ITEM_DIV                 --아이템구분
		     , R1.CODE_NM       AS ITEM_DIV_NM
		     , B.ORDRS_DTL_DIV20          --수주설비작업구분
		     , R2.CODE_NM       AS ORDRS_DTL_DIV20_NM
		     , B.ORDRS_DTL_DIV30          --수주설비자체구분
		     , R3.CODE_NM       AS ORDRS_DTL_DIV30_NM
		     , B.DUDT_INTEND_DT           --납기예정일
		     , B.EQP_NM                   --설비명
		     , (SELECT COUNT(*) FROM TB_SM01M01 WHERE CO_CD = A.CO_CD AND SALES_CD = B.SALES_CD) AS BOM_CNT
		     , (SELECT COUNT(*) FROM TB_SM01D01 WHERE CO_CD = A.CO_CD AND SALES_CD = B.SALES_CD) AS MATR_CNT
        FROM TB_CR02M01 AS A
	       JOIN TB_CR02D02 AS B  ON B.CO_CD    = A.CO_CD AND B.ORDRS_NO = A.ORDRS_NO
	       LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = A.ORDRS_CLNT_CD
	       LEFT OUTER JOIN TB_BM01M01 AS P ON P.PRDT_CD = B.PRDT_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD
	       LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = B.ITEM_DIV
	       LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = B.ORDRS_DTL_DIV20
	       LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = B.ORDRS_DTL_DIV30
	       LEFT OUTER JOIN (
				SELECT FILE_TRGT_KEY, CO_CD, SALES_CD 
				  FROM TB_SM01M01 X1
				 WHERE LEVEL = 1
		        START WITH X1.UPPER_CD = '.'
		        CONNECT BY PRIOR X1.LOWER_CD = X1.UPPER_CD
	       ) AS BOM ON A.CO_CD = BOM.CO_CD AND B.SALES_CD = BOM.SALES_CD
		   WHERE  1 = 1
		     AND NVL2(#{coCd},A.CO_CD,'.') = NVL(#{coCd},'.')
		     AND NVL2(#{itemDiv},B.ITEM_DIV,'.') = NVL(#{itemDiv},'.')
		     AND NVL(B.SALES_CD, '.') LIKE '%'||#{salesCd}||'%'
		     AND NVL(C.CLNT_NM, '.') LIKE '%'||#{clntNm}||'%'
		     AND NVL(A.CLNT_PJT, '.') LIKE '%'||#{clntPjt}||'%'
		     AND NVL(P.PRDT_NM, '.') LIKE '%'||#{prdtNm}||'%'
		     AND NVL(B.EQP_NM, '.') LIKE '%'||#{eqpNm}||'%'
        ORDER BY A.CO_CD, CASE WHEN MATR_CNT = 0 THEN 1 ELSE 0 END, CASE WHEN BOM_CNT = 0 THEN 1 ELSE 0 END, B.SALES_CD
        ) AS a
        ) A
        WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>
	
	<select id="selectBomDetailList" parameterType="Map" resultType="camelMap">
        SELECT T.FILE_TRGT_KEY
        , T.LVL
        , T.CO_CD
        , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
		, T.SALES_CD
		, T.PART_NO
		, T.UNIT_NO
		, T.REV_NO
		, T.DSGN_NO
		, T.UPPER_CD
		, T.LOWER_CD
		, D.MATR_SEQ
		, D.ORDRG_DIV_10
		, D.ORDRG_DIV_20
		, D.NEXT_PRCSN_NM
		, D.DLVPLC_NM
		, D.MATR_CD
		, D.MATR_NM
		, D.GOODS_DIV
		, D.MATR_CLNT_DIV
		, D.MATR_DIV
		, D.MATR_GRP
		, D.MATR_MAT
		, D.MATR_SIZE
		, D.MATR_SPEC
		, D.MATR_MAKR_NM
		, D.MATR_MNO
		, D.MATR_WT
		, D.MATR_UNIT
		, D.ORIGIN_NM
		, D.MATR_DRW_NO
		, D.MATR_TEST_DIV
		, D.DLVR_RQM_DAY
		, D.MATR_PURC_DIV
		, D.MIN_ORDRG_QTY
		, D.MATR_SAFT_QTY
		, D.MATR_STOCK_CD
		, D.DSGN_2D_MD
		, D.AVRG_2D_MD
		, D.DSGN_3D_MD
		, D.AVRG_3D_MD
		, D.PRDCTN_RQM_MD
		, D.PRDCTN_AVRG_MD
		, D.USE_YN
		, D.MATR_PART_NO
		, D.PCHS_CLNT_CD1
		, D.PCHS_CLNT_PCT1
		, D.PCHS_CLNT_CD2
		, D.PCHS_CLNT_PCT2
		, D.PCHS_CLNT_CD3
		, D.PCHS_CLNT_PCT3
		, D.MATR_UPR
		, D.MATR_AVRG_UPR
		, D.MATR_RMK
		, D.MATR_LAST_TRST_DT
		, D.MATR_ATNT_CD
		, D.MATR_NO
		, T.ETC_FIELD1
		, T.ETC_FIELD2
		, T.ETC_FIELD3
        , T.CREAT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS CREAT_NM
        , TO_CHAR(T.CREAT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS CREAT_DTTM
        , T.UDT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.UDT_ID) AS UDT_NM
        , TO_CHAR(T.UDT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS UDT_DTTM
        FROM
  		( SELECT X1.*, LEVEL AS LVL FROM TB_SM01M01 X1
           START WITH X1.UPPER_CD = '.' AND X1.SALES_CD = #{salesCd}
          CONNECT BY PRIOR X1.LOWER_CD = X1.UPPER_CD
        ) T
        LEFT OUTER JOIN TB_SM01D01 D
		ON T.CO_CD = D.CO_CD AND T.SALES_CD = D.SALES_CD AND T.UPPER_CD = D.UPPER_CD AND T.LOWER_CD = D.LOWER_CD
        LEFT OUTER JOIN
        ( SELECT T1.CO_CD
		        , T2.SALES_CD
		        , T2.PRDT_CD
		        , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_NM
		        , T2.ITEM_DIV
		        , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
		        , T1.CLNT_PJT
		        , T2.EQP_NM
		        , T3.CLNT_NM
		        FROM TB_CR02M01 AS T1
		        JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
		        LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
        ) A
        ON T.CO_CD = A.CO_CD AND T.SALES_CD = A.SALES_CD
		WHERE 1=1
		ORDER BY T.CO_CD, NVL(T.PART_NO,'0'), NVL(T.UNIT_NO,'0'), NVL(T.REV_NO,'0'),T.LOWER_CD, T.UPPER_CD
		         , D.MATR_SEQ
	</select>

	<!-- 구매Bom 조회 -->
	<select id="selectBuyBomList" resultType="CamelMap">
		SELECT LEVEL - 1 AS LVL
			, T.FILE_TRGT_KEY
			, T.CO_CD
			, T.SALES_CD
			, T.PART_NO
			, T.UNIT_NO
			, T.REV_NO
			, T.DSGN_NO
			, T.UPPER_CD
			, T.LOWER_CD
			, T.PART_NO AS OLD_PART_NO
			, T.UNIT_NO AS OLD_UNIT_NO
			, T.REV_NO AS OLD_REV_NO
			, T.LOWER_CD AS OLD_LOWER_CD
		FROM TB_SM01M01 T
		START WITH T.UPPER_CD = '.' AND T.SALES_CD = #{salesCd}
		CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
		ORDER BY T.CO_CD, NVL(T.PART_NO,'0'), NVL(T.UNIT_NO,'0'), NVL(T.REV_NO,'0'),T.LOWER_CD, T.UPPER_CD
	</select>

	<!-- 자재정보 조회 -->
	<select id="selectBomMatrList" resultType="CamelMap">
		SELECT CO_CD
			, SALES_CD
			, MATR_SEQ
			, UPPER_CD
			, LOWER_CD
			, LOWER_CD AS DSGN_NO
			, ORDRG_DIV_10
			, ORDRG_DIV_20
			, NEXT_PRCSN_NM
			, DLVPLC_NM
			, MATR_CD
			, MATR_NM
			, GOODS_DIV
			, MATR_CLNT_DIV
			, MATR_DIV
			, MATR_GRP
			, MATR_MAT
			, MATR_SIZE
			, MATR_SPEC
			, MATR_MAKR_NM
			, MATR_MNO
			, MATR_WT
			, MATR_UNIT
			, ORIGIN_NM
			, MATR_DRW_NO
			, MATR_TEST_DIV
			, DLVR_RQM_DAY
			, MATR_PURC_DIV
			, MIN_ORDRG_QTY
			, MATR_SAFT_QTY
			, MATR_STOCK_CD
			, DSGN_2D_MD
			, AVRG_2D_MD
			, DSGN_3D_MD
			, AVRG_3D_MD
			, PRDCTN_RQM_MD
			, PRDCTN_AVRG_MD
			, USE_YN
			, MATR_PART_NO
			, PCHS_CLNT_CD1
			, PCHS_CLNT_PCT1
			, PCHS_CLNT_CD2
			, PCHS_CLNT_PCT2
			, PCHS_CLNT_CD3
			, PCHS_CLNT_PCT3
			, MATR_UPR
			, MATR_AVRG_UPR
			, MATR_RMK
			, MATR_LAST_TRST_DT
			, MATR_ATNT_CD
		FROM TB_SM01D01 T
		WHERE SALES_CD = #{salesCd}
		ORDER BY T.CO_CD, T.LOWER_CD, T.UPPER_CD, T.MATR_SEQ
	</select>

    <insert id="insertBom" parameterType="Map">
        <selectKey keyProperty="fileTrgtKey" resultType="String" order="BEFORE">
            SELECT MAX(TO_NUMBER(FILE_TRGT_KEY)) + 1 FROM TB_SM01M01
        </selectKey>
        INSERT INTO TB_SM01M01
        ( FILE_TRGT_KEY
		, CO_CD
		, SALES_CD
		, PART_NO
		, UNIT_NO
		, REV_NO
		, DSGN_NO
		, UPPER_CD
		, LOWER_CD
        , ETC_FIELD1
        , ETC_FIELD2
        , ETC_FIELD3
        , CREAT_ID
        , CREAT_PGM
        , CREAT_DTTM
        )
        VALUES
        ( #{fileTrgtKey}
		, #{coCd}
		, #{salesCd}
		, #{partNo, jdbcType=VARCHAR}
		, #{unitNo, jdbcType=VARCHAR}
		, #{revNo, jdbcType=VARCHAR}
		, #{dsgnNo}
		, #{upperCd}
		, #{lowerCd}
        , #{etcField1, jdbcType=VARCHAR}
        , #{etcField2, jdbcType=VARCHAR}
        , #{etcField3, jdbcType=VARCHAR}
        , #{userId}
        , #{pgmId}
        , SYSDATE
        )
    </insert>

    <update id="updateBom" parameterType="Map">
        UPDATE TB_PM01M01
        SET   CO_CD 		= #{coCd}
			, SALES_CD 		= #{salesCd}
			, PART_NO 		= #{partNo, jdbcType=VARCHAR}
			, UNIT_NO 		= #{unitNo, jdbcType=VARCHAR}
			, REV_NO 		= #{revNo, jdbcType=VARCHAR}
			, DSGN_NO 		= #{dsgnNo}
			, MATR_SEQ 		= #{matrSeq}
			, UPPER_CD 		= #{upperCd}
			, LOWER_CD 		= #{lowerCd}
            , ETC_FIELD1    = #{etcField1, jdbcType=VARCHAR}
            , ETC_FIELD2    = #{etcField2, jdbcType=VARCHAR}
            , ETC_FIELD3    = #{etcField3, jdbcType=VARCHAR}
            , UDT_ID        = #{userId}
            , UDT_PGM       = #{pgmId}
            , UDT_DTTM      = SYSDATE
        WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </update>

	<delete id="deleteBom" parameterType="Map">
	  DELETE TB_SM01M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
	</delete>
	
	<delete id="deleteBomMatrAll" parameterType="Map">
	  DELETE TB_SM01D01
	  WHERE CO_CD = #{coCd}
	    AND SALES_CD = #{salesCd}
	</delete>
	
    <insert id="insertBomMatr" parameterType="Map">
        <selectKey keyProperty="matrSeq" resultType="String" order="BEFORE">
            SELECT NVL(MAX(MATR_SEQ), 0) + 1 FROM TB_SM01D01
			  WHERE CO_CD = #{coCd}
			    AND SALES_CD = #{salesCd}
			    AND UPPER_CD = #{upperCd}
			    AND LOWER_CD = #{lowerCd}
        </selectKey>
        INSERT INTO TB_SM01D01
        ( CO_CD
		, SALES_CD
		, MATR_SEQ
		, UPPER_CD
		, LOWER_CD
		, ORDRG_DIV_10
		, ORDRG_DIV_20
		, NEXT_PRCSN_NM
		, DLVPLC_NM
		, MATR_CD
		, MATR_NM
		, GOODS_DIV
		, MATR_CLNT_DIV
		, MATR_DIV
		, MATR_GRP
		, MATR_MAT
		, MATR_SIZE
		, MATR_SPEC
		, MATR_MAKR_NM
		, MATR_MNO
		, MATR_WT
		, MATR_UNIT
		, ORIGIN_NM
		, MATR_DRW_NO
		, MATR_TEST_DIV
		, DLVR_RQM_DAY
		, MATR_PURC_DIV
		, MIN_ORDRG_QTY
		, MATR_SAFT_QTY
		, MATR_STOCK_CD
		, DSGN_2D_MD
		, AVRG_2D_MD
		, DSGN_3D_MD
		, AVRG_3D_MD
		, PRDCTN_RQM_MD
		, PRDCTN_AVRG_MD
		, USE_YN
		, MATR_PART_NO
		, PCHS_CLNT_CD1
		, PCHS_CLNT_PCT1
		, PCHS_CLNT_CD2
		, PCHS_CLNT_PCT2
		, PCHS_CLNT_CD3
		, PCHS_CLNT_PCT3
		, MATR_UPR
		, MATR_AVRG_UPR
		, MATR_RMK
		, MATR_LAST_TRST_DT
		, MATR_ATNT_CD
        , ETC_FIELD1
        , ETC_FIELD2
        , ETC_FIELD3
        , CREAT_ID
        , CREAT_PGM
        , CREAT_DTTM
        )
        VALUES
        ( #{coCd}
		, #{salesCd}
		, #{matrSeq}
		, #{upperCd}
		, #{lowerCd}
		, #{ordrgDiv10, jdbcType=VARCHAR}
		, #{ordrgDiv20, jdbcType=VARCHAR}
		, #{nextPrcsnNm, jdbcType=VARCHAR}
		, #{dlvplcNm, jdbcType=VARCHAR}
		, #{matrCd, jdbcType=VARCHAR}
		, #{matrNm, jdbcType=VARCHAR}
		, #{goodsDiv, jdbcType=VARCHAR}
		, #{matrClntDiv, jdbcType=VARCHAR}
		, #{matrDiv, jdbcType=VARCHAR}
		, #{matrGrp, jdbcType=VARCHAR}
		, #{matrMat, jdbcType=VARCHAR}
		, #{matrSize, jdbcType=VARCHAR}
		, #{matrSpec, jdbcType=VARCHAR}
		, #{matrMakrNm, jdbcType=VARCHAR}
		, #{matrMno, jdbcType=VARCHAR}
		, #{matrWt, jdbcType=VARCHAR}
		, #{matrUnit, jdbcType=VARCHAR}
		, #{originNm, jdbcType=VARCHAR}
		, #{matrDrwNo, jdbcType=VARCHAR}
		, #{matrTestDiv, jdbcType=VARCHAR}
		, #{dlvrRqmDay, jdbcType=VARCHAR}
		, #{matrPurcDiv, jdbcType=VARCHAR}
		, #{minOrdrgQty, jdbcType=VARCHAR}
		, #{matrSaftQty, jdbcType=VARCHAR}
		, #{matrStockCd, jdbcType=VARCHAR}
		, #{dsgn2DMd, jdbcType=VARCHAR}
		, #{avrg2DMd, jdbcType=VARCHAR}
		, #{dsgn3DMd, jdbcType=VARCHAR}
		, #{avrg3DMd, jdbcType=VARCHAR}
		, #{prdctnRqmMd, jdbcType=VARCHAR}
		, #{prdctnAvrgMd, jdbcType=VARCHAR}
		, #{useYn, jdbcType=VARCHAR}
		, #{matrPartNo, jdbcType=VARCHAR}
		, #{pchsClntCd1, jdbcType=VARCHAR}
		, #{pchsClntPct1, jdbcType=VARCHAR}
		, #{pchsClntCd2, jdbcType=VARCHAR}
		, #{pchsClntPct2, jdbcType=VARCHAR}
		, #{pchsClntCd3, jdbcType=VARCHAR}
		, #{pchsClntPct3, jdbcType=VARCHAR}
		, #{matrUpr, jdbcType=VARCHAR}
		, #{matrAvrgUpr, jdbcType=VARCHAR}
		, #{matrRmk, jdbcType=VARCHAR}
		, #{matrLastTrstDt, jdbcType=VARCHAR}
		, #{matrAtntCd, jdbcType=VARCHAR}
        , #{etcField1, jdbcType=VARCHAR}
        , #{etcField2, jdbcType=VARCHAR}
        , #{etcField3, jdbcType=VARCHAR}
        , #{userId}
        , #{pgmId}
        , SYSDATE
        )
    </insert>
	
    <update id="updateBomMatr" parameterType="Map">
        UPDATE TB_SM01D01
        SET   ORDRG_DIV_10 		= #{ordrgDiv10}
			, ORDRG_DIV_20 		= #{ordrgDiv20}
			, NEXT_PRCSN_NM 	= #{nextPrcsnNm}
			, DLVPLC_NM 		= #{dlvplcNm}
			, MATR_CD 			= #{matrCd}
			, MATR_NM 			= #{matrNm}
			, GOODS_DIV 		= #{goodsDiv}
			, MATR_CLNT_DIV 	= #{matrClntDiv}
			, MATR_DIV 			= #{matrDiv}
			, MATR_GRP 			= #{matrGrp}
			, MATR_MAT 			= #{matrMat}
			, MATR_SIZE 		= #{matrSize}
			, MATR_SPEC 		= #{matrSpec}
			, MATR_MAKR_NM 		= #{matrMakrNm}
			, MATR_MNO 			= #{matrMno}
			, MATR_WT 			= #{matrWt}
			, MATR_UNIT 		= #{matrUnit}
			, ORIGIN_NM 		= #{originNm}
			, MATR_DRW_NO 		= #{matrDrwNo}
			, MATR_TEST_DIV 	= #{matrTestDiv}
			, DLVR_RQM_DAY 		= #{dlvrRqmDay}
			, MATR_PURC_DIV 	= #{matrPurcDiv}
			, MIN_ORDRG_QTY 	= #{minOrdrgQty}
			, MATR_SAFT_QTY 	= #{matrSaftQty}
			, MATR_STOCK_CD 	= #{matrStockCd}
			, DSGN_2D_MD 		= #{dsgn2DMd}
			, AVRG_2D_MD 		= #{avrg2DMd}
			, DSGN_3D_MD 		= #{dsgn3DMd}
			, AVRG_3D_MD 		= #{avrg3DMd}
			, PRDCTN_RQM_MD 	= #{prdctnRqmMd}
			, PRDCTN_AVRG_MD 	= #{prdctnAvrgMd}
			, USE_YN 			= #{useYn}
			, MATR_PART_NO 		= #{matrPartNo}
			, PCHS_CLNT_CD1 	= #{pchsClntCd1}
			, PCHS_CLNT_PCT1 	= #{pchsClntPct1}
			, PCHS_CLNT_CD2 	= #{pchsClntCd2}
			, PCHS_CLNT_PCT2 	= #{pchsClntPct2}
			, PCHS_CLNT_CD3 	= #{pchsClntCd3}
			, PCHS_CLNT_PCT3 	= #{pchsClntPct3}
			, MATR_UPR 			= #{matrUpr}
			, MATR_AVRG_UPR 	= #{matrAvrgUpr}
			, MATR_RMK 			= #{matrRmk}
			, MATR_LAST_TRST_DT = #{matrLastTrstDt}
			, MATR_ATNT_CD 		= #{matrAtntCd}
			, MATR_NO = #{matrNo}
            , ETC_FIELD1    = #{etcField1, jdbcType=VARCHAR}
            , ETC_FIELD2    = #{etcField2, jdbcType=VARCHAR}
            , ETC_FIELD3    = #{etcField3, jdbcType=VARCHAR}
            , UDT_ID        = #{userId}
            , UDT_PGM       = #{pgmId}
            , UDT_DTTM      = SYSDATE
	  WHERE CO_CD = #{coCd}
	    AND SALES_CD = #{salesCd}
	    AND MATR_SEQ = #{matrSeq}
	    AND UPPER_CD = #{upperCd}
	    AND LOWER_CD = #{lowerCd}

    </update>

	<delete id="deleteBomMatr" parameterType="Map">
	  DELETE TB_SM01D01
	  WHERE CO_CD = #{coCd}
	    AND SALES_CD = #{salesCd}
	    AND MATR_SEQ = #{matrSeq}
	    AND UPPER_CD = #{upperCd}
	    AND LOWER_CD = #{lowerCd}
	</delete>

	<resultMap id="resultInfoMap" type="CamelMap">
		<collection select="selectBomMatrList" property="PRDT_LIST" column="{prjctSeq=PRJCT_SEQ}" ofType="CamelMap"/>
	</resultMap>

	<select id="selectPrjctInfo" resultMap="resultInfoMap">
              SELECT PRJCT_SEQ
					 , T.CO_CD
                     , T.INPEXP_CD
                     , FN_CM05M01_CD_TO_NM(T.INPEXP_CD) INPEXP_NM
					 , T.NEW_PRDT_CD
                     , FN_CM05M01_CD_TO_NM(T.NEW_PRDT_CD) NEW_PRDT_NM
					 , T.CLNT_CD
					 , A.CLNT_NM
					 , T.CLNT_MNG_NM
					 , T.PRJCT_NM
					 , T.EQP_NM
					 , T.EQP_QTY
					 , T.ODR_CD
					 , T.ODR_RMK
					 , T.EPCT_AMT
					 , T.ORDRS_PLAN_AMT
					 , T.WINBD_RMK
					 , TO_CHAR(T.ORDRS_PLAN_DT, 'YYYY-MM-DD') AS ORDRS_PLAN_DT
					 , T.ORDRS_AMT
					 , T.WINBD_CD
					 , TO_CHAR(T.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT
					 , TO_CHAR(T.DUDT_PLAN_DT, 'YYYY-MM-DD') AS DUDT_PLAN_DT
					 , T.MNG_ID
					 , B.NAME as MNG_NM
					 , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
					 , SUBSTR(T.YYYYMM,1,4) || '-' || SUBSTR(T.YYYYMM,5,2) AS YYYYMM
					 , T.PRJCT_CD
					 , T.PRJCT_RMK
					 , T.CREAT_ID
					 , T.CREAT_PGM
					 , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM
					 , T.UDT_ID
					 , T.UDT_PGM
					 , TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM
           			 , ORDRS_PCT
        FROM TB_BM06M01 T 
             LEFT OUTER JOIN TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
             LEFT OUTER JOIN TB_CM06M01 B ON T.MNG_ID = B.ID
       WHERE PRJCT_SEQ = #{prjctSeq}
  </select>

  
  <select id="selectPrjctIssueInfo" parameterType="Map" resultType="CamelMap">
       SELECT 
					   T.PRJCT_SEQ
					 , T.ISS_NO
			         , TO_CHAR(T.ISS_DT, 'YYYY-MM-DD') AS ISS_DT
			         , TO_CHAR(T.ACT_DT, 'YYYY-MM-DD') AS ACT_DT					 
					 , T.ISS_CNTS
					 , T.CAUSE_CNTS
					 , T.ACT_CNTS
					 , T.ISS_STS
					 , A.CODE_NM AS ISS_STS_NM
					 , A.CODE_RPRC AS ISS_YN  
					 , T.ETC_FIELD1
					 , T.ETC_FIELD2
					 , T.ETC_FIELD3
					 , T.CREAT_ID
					 , (SELECT NAME FROM TB_CM06M01 B WHERE T.CREAT_ID = B.ID) AS CREAT_NM
					 , T.CREAT_PGM
					 , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
					 , T.UDT_ID
					 , (SELECT NAME FROM TB_CM06M01 B WHERE T.UDT_ID = B.ID) AS UDT_NM
					 , T.UDT_PGM
					 , TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM	
        FROM TB_BM06D03 T
        				LEFT OUTER JOIN  TB_CM05M01 A ON T.ISS_STS = A.CODE_ID
       WHERE PRJCT_SEQ = #{prjctSeq}
  </select>


  <insert id="insertBomIssue" parameterType="Map">
    INSERT INTO TB_BM06D03
    (
          PRJCT_SEQ
        , ISS_NO
        , ISS_DT
        , ACT_DT
        , ISS_CNTS
        , CAUSE_CNTS
        , ACT_CNTS
        , ISS_STS
        , ETC_FIELD1
        , ETC_FIELD2
        , ETC_FIELD3
        , CREAT_ID
        , CREAT_PGM
        , CREAT_DTTM
      )
    VALUES
    (
          #{prjctSeq}
        , 1
        , #{issDt}
        , #{actDt, jdbcType=VARCHAR}
        , #{issCnts}
        , #{causeCnts, jdbcType=VARCHAR}
        , #{actCnts, jdbcType=VARCHAR}
        , #{issSts}
        , #{etcField1, jdbcType=VARCHAR}
        , #{etcField2, jdbcType=VARCHAR}
        , #{etcField3, jdbcType=VARCHAR}
		, #{userId}
		, #{pgmId}
		, SYSDATE
    )
  </insert>
  
  <update id="updateBomIssue" parameterType="Map">
    UPDATE TB_BM06D03
       SET
	          ISS_DT            = #{issDt}
	        , ACT_DT            = #{actDt, jdbcType=VARCHAR}
	        , ISS_CNTS          = #{issCnts}
	        , CAUSE_CNTS        = #{causeCnts, jdbcType=VARCHAR}
	        , ACT_CNTS          = #{actCnts, jdbcType=VARCHAR}
	        , ISS_STS           = #{issSts}
	        , ETC_FIELD1        = #{etcField1, jdbcType=VARCHAR}
	        , ETC_FIELD2        = #{etcField2, jdbcType=VARCHAR}
	        , ETC_FIELD3        = #{etcField3, jdbcType=VARCHAR}
	        , UDT_ID            = #{userId}
	        , UDT_PGM           = #{pgmId}
	        , UDT_DTTM          = SYSDATE    
     WHERE PRJCT_SEQ			= #{prjctSeq}
           AND ISS_NO   		= #{issNo}
  </update>
  
</mapper>
