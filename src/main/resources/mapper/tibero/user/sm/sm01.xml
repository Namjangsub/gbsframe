<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm01.mapper.SM01Mapper">
	<!-- 구매목록리스트 -->
	<select id="selectBomSalesCount" parameterType="Map" resultType="int">
        SELECT
        COUNT(*)
        FROM TB_SM01M01 T
        LEFT OUTER JOIN
        ( SELECT T1.CO_CD
        , T2.SALES_CD
        , T2.PRDT_CD
        , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_NM
        , T2.ITEM_DIV
        , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
        , T1.CLNT_PJT
        , T2.EQP_NM
        , T3.CLNT_NM
        FROM TB_CR02M01 AS T1
        JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
        LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
        ) A
        ON T.CO_CD = A.CO_CD AND T.SALES_CD = A.SALES_CD
        WHERE 1=1 AND LEVEL = 1
        START WITH T.UPPER_CD = '.'
        CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
        <if test="coCd !=null and !coCd.equals('')">
            AND T.CO_CD = #{coCd}
        </if>
        <if test="salesCd != null and !salesCd.equals('')">
            AND T.SALES_CD LIKE '%${salesCd}%'
        </if>
        <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
            AND A.CLNT_NM LIKE '%${ordrsClntNm}%'
        </if>
        <if test="clntPjt != null and !clntPjt.equals('')">
            AND A.CLNT_PJT LIKE '%${clntPjt}%'
        </if>
        <if test="prdtNm != null and !prdtNm.equals('')">
            AND A.PRDT_NM LIKE '%${prdtNm}%'
        </if>
        <if test="itemDiv != null and !itemDiv.equals('')">
            AND A.ITEM_DIV = #{itemDiv}
        </if>
        <if test="eqpNm != null and !eqpNm.equals('')">
            AND A.EQP_NM LIKE '%${eqpNm}%'
        </if>
	</select>
	
	<select id="selectBomSalesList" parameterType="Map" resultType="camelMap">
        SELECT
        *
        FROM(
        SELECT
        ROWNUM AS RNUM, A.*

        FROM
        (
        SELECT T.FILE_TRGT_KEY
        , T.CO_CD
        , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
		, T.SALES_CD
		, T.PART_NO
		, T.UNIT_NO
		, T.REV_NO
		, T.DSGN_NO
		, T.MATR_SEQ
		, T.UPPER_CD
		, T.LOWER_CD
		, T.ORDRG_DIV_10
		, T.ORDRG_DIV_20
		, T.NEXT_PRCSN_NM
		, T.DLVPLC_NM
		, T.MATR_CD
		, T.MATR_NM
		, T.GOODS_DIV
		, T.MATR_CLNT_DIV
		, T.MATR_DIV
		, T.MATR_GRP
		, T.MATR_MAT
		, T.MATR_SIZE
		, T.MATR_SPEC
		, T.MATR_MAKR_NM
		, T.MATR_MNO
		, T.MATR_WT
		, T.MATR_UNIT
		, T.ORIGIN_NM
		, T.MATR_DRW_NO
		, T.MATR_TEST_DIV
		, T.DLVR_RQM_DAY
		, T.MATR_PURC_DIV
		, T.MIN_ORDRG_QTY
		, T.MATR_SAFT_QTY
		, T.MATR_STOCK_CD
		, T.DSGN_2D_MD
		, T.AVRG_2D_MD
		, T.DSGN_3D_MD
		, T.AVRG_3D_MD
		, T.PRDCTN_RQM_MD
		, T.PRDCTN_AVRG_MD
		, T.USE_YN
		, T.MATR_PART_NO
		, T.PCHS_CLNT_CD1
		, T.PCHS_CLNT_PCT1
		, T.PCHS_CLNT_CD2
		, T.PCHS_CLNT_PCT2
		, T.PCHS_CLNT_CD3
		, T.PCHS_CLNT_PCT3
		, T.MATR_UPR
		, T.MATR_AVRG_UPR
		, T.MATR_RMK
		, T.MATR_LAST_TRST_DT
		, T.MATR_ATNT_CD
		, T.MATR_NO
		, T.ETC_FIELD1
		, T.ETC_FIELD2
		, T.ETC_FIELD3
        , T.CREAT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS CREAT_NM
        , TO_CHAR(T.CREAT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS CREAT_DTTM
        , T.UDT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.UDT_ID) AS UDT_NM
        , TO_CHAR(T.UDT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS UDT_DTTM
        FROM TB_SM01M01 T
        LEFT OUTER JOIN
        ( SELECT T1.CO_CD
        , T2.SALES_CD
        , T2.PRDT_CD
        , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_NM
        , T2.ITEM_DIV
        , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
        , T1.CLNT_PJT
        , T2.EQP_NM
        , T3.CLNT_NM
        FROM TB_CR02M01 AS T1
        JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
        LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
        ) A
        ON T.CO_CD = A.CO_CD AND T.SALES_CD = A.SALES_CD
        WHERE 1=1 AND LEVEL = 1
        START WITH T.UPPER_CD = '.'
        CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
        <if test="coCd !=null and !coCd.equals('')">
            AND T.CO_CD = #{coCd}
        </if>
        <if test="salesCd != null and !salesCd.equals('')">
            AND T.SALES_CD LIKE '%${salesCd}%'
        </if>
        <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
            AND A.CLNT_NM LIKE '%${ordrsClntNm}%'
        </if>
        <if test="clntPjt != null and !clntPjt.equals('')">
            AND A.CLNT_PJT LIKE '%${clntPjt}%'
        </if>
        <if test="prdtNm != null and !prdtNm.equals('')">
            AND A.PRDT_NM LIKE '%${prdtNm}%'
        </if>
        <if test="itemDiv != null and !itemDiv.equals('')">
            AND A.ITEM_DIV = #{itemDiv}
        </if>
        <if test="eqpNm != null and !eqpNm.equals('')">
            AND A.EQP_NM LIKE '%${eqpNm}%'
        </if>

        ORDER BY T.CO_CD, T.FILE_TRGT_KEY DESC
        ) AS a
        ) A
        WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>
	
	<!-- 구매BOM 자재 리스트 -->
	<select id="selectBomMakerCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
        FROM TB_SM01M01 T
        WHERE 1=1
        START WITH T.UPPER_CD = '.' AND FILE_TRGT_KEY = #{fileTrgtKey}
        CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
	</select>
	
	<select id="selectBomMakerList" parameterType="Map" resultType="camelMap">
        SELECT
        *
        FROM(
        SELECT
        ROWNUM AS RNUM, A.*

        FROM
        (
        SELECT T.FILE_TRGT_KEY
        , T.CO_CD
        , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
		, T.SALES_CD
		, T.PART_NO
		, T.UNIT_NO
		, T.REV_NO
		, T.DSGN_NO
		, T.MATR_SEQ
		, T.UPPER_CD
		, T.LOWER_CD
		, T.ORDRG_DIV_10
		, T.ORDRG_DIV_20
		, T.NEXT_PRCSN_NM
		, T.DLVPLC_NM
		, T.MATR_CD
		, T.MATR_NM
		, T.GOODS_DIV
		, T.MATR_CLNT_DIV
		, T.MATR_DIV
		, T.MATR_GRP
		, T.MATR_MAT
		, T.MATR_SIZE
		, T.MATR_SPEC
		, T.MATR_MAKR_NM
		, T.MATR_MNO
		, T.MATR_WT
		, T.MATR_UNIT
		, T.ORIGIN_NM
		, T.MATR_DRW_NO
		, T.MATR_TEST_DIV
		, T.DLVR_RQM_DAY
		, T.MATR_PURC_DIV
		, T.MIN_ORDRG_QTY
		, T.MATR_SAFT_QTY
		, T.MATR_STOCK_CD
		, T.DSGN_2D_MD
		, T.AVRG_2D_MD
		, T.DSGN_3D_MD
		, T.AVRG_3D_MD
		, T.PRDCTN_RQM_MD
		, T.PRDCTN_AVRG_MD
		, T.USE_YN
		, T.MATR_PART_NO
		, T.PCHS_CLNT_CD1
		, T.PCHS_CLNT_PCT1
		, T.PCHS_CLNT_CD2
		, T.PCHS_CLNT_PCT2
		, T.PCHS_CLNT_CD3
		, T.PCHS_CLNT_PCT3
		, T.MATR_UPR
		, T.MATR_AVRG_UPR
		, T.MATR_RMK
		, T.MATR_LAST_TRST_DT
		, T.MATR_ATNT_CD
		, T.MATR_NO
		, T.ETC_FIELD1
		, T.ETC_FIELD2
		, T.ETC_FIELD3
        , T.CREAT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS CREAT_NM
        , TO_CHAR(T.CREAT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS CREAT_DTTM
        , T.UDT_ID
        , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.UDT_ID) AS UDT_NM
        , TO_CHAR(T.UDT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS UDT_DTTM
        FROM TB_SM01M01 T
        LEFT OUTER JOIN
        ( SELECT T1.CO_CD
        , T2.SALES_CD
        , T2.PRDT_CD
        , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_NM
        , T2.ITEM_DIV
        , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
        , T1.CLNT_PJT
        , T2.EQP_NM
        , T3.CLNT_NM
        FROM TB_CR02M01 AS T1
        JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
        LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
        ) A
        ON T.CO_CD = A.CO_CD AND T.SALES_CD = A.SALES_CD
        WHERE 1=1
        START WITH T.UPPER_CD = '.' AND FILE_TRGT_KEY = #{fileTrgtKey}
        CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
        ORDER BY T.CO_CD, T.FILE_TRGT_KEY DESC
        ) AS a
        ) A
        WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>

	<!-- 매출등록팝업 -->
	<select id="addSellDscnCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) AS RESULT_COUNT
			FROM TB_CR02M01 AS ORDRS
			JOIN TB_CR02D01 AS CLMN ON CLMN.CO_CD = ORDRS.CO_CD AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
			LEFT JOIN (
			    SELECT CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ, MAX(CD.CURR_CD) AS CONF_CURR_CD, NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT
			    FROM TB_CR03M01 AS CM
			    JOIN TB_CR03D01 AS CD ON CD.CO_CD = CM.CO_CD AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			    GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			) AS CONF ON CONF.CO_CD = CLMN.CO_CD AND CONF.ORDRS_NO = CLMN.ORDRS_NO AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
			LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD
			LEFT JOIN TB_CM05M01 AS R ON R.CODE_ID = ORDRS.CO_CD
			LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV
			LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD
			LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV
			LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD
			WHERE ORDRS.CO_CD LIKE '%${coCd}%' --회사
			AND NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명

	</select>
	
	<select id="addSellDscnList" parameterType="Map" resultType="camelMap">
		SELECT DISTINCT ORDRS.FILE_TRGT_KEY AS FILE_TRGT_KEY --파일대상KEY
			 , ROWNUM	AS 	RN
		     , ORDRS.CO_CD             AS CO_CD             --회사코드
		     , R.CODE_NM               AS CO_CD_NM          --회사명
		     , ORDRS.ORDRS_NO          AS ORDRS_NO          --수주번호
		     , TO_CHAR(ORDRS.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT --수주일자
		     , ORDRS.ORDRS_CLNT_CD     AS ORDRS_CLNT_CD     --고객사
		     , C.CLNT_NM               AS ORDRS_CLNT_NM     --고객사명
		     , ORDRS.CLNT_PJT          AS CLNT_PJT          --고객사PJT
		     , ORDRS.CTRT_NM           AS CTRT_NM           --계약명
		     , ORDRS.CURR_CD           AS ORDRS_CURR_CD     --통화단위
		     , R2.CODE_NM              AS ORDRS_CURR_NM     --통화단위명
		     , NVL(ORDRS.EXRATE, 1)    AS ORDRS_EXRATE      --환율
		     <!-- 수주수금계획 -->
		     , CLMN.CLMN_PLAN_SEQ      AS CLMN_PLAN_SEQ     --수금계획순번
		     , CLMN.CLMN_PLAN_DIV      AS CLMN_PLAN_DIV     --수금구분
		     , R3.CODE_NM              AS CLMN_PLAN_DIV_NM  --수금구분명
		     , CLMN.CLMN_DIV_SEQ       AS CLMN_DIV_SEQ      --수금구분차수
		     , CLMN.CLMN_RATE          AS CLMN_RATE         --수금비율
		     , CLMN.CURR_CD            AS CLMN_CURR_CD      --통화단위
		     , R4.CODE_NM              AS CLMN_CURR_NM      --통화단위명
		     , NVL(CLMN.EXRATE, 1)     AS CLMN_EXRATE       --환율
		     , CLMN.CLMN_AMT           AS CLMN_AMT          --수금금액
		     , TO_CHAR(CLMN.BILL_PBLS_DT, 'YYYY-MM-DD') AS CLMN_BILL_PBLS_DT --계산서발행일자
		     , TO_CHAR(CLMN.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT           --수금일자
		     , CONF.CONF_AMT                 AS BEF_CONF_AMT --기 확정금액
		     , CLMN.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT   --미 확정금액
		     , 'N'                           AS CHK          --체크여부
		     , 0                             AS CONF_AMT     --확정금액
		     <!-- 계산서 발행 후 지급시기 -->
		     <!-- , CLMN.PMNT_DT_AFTER_BILL AS CLMN_PMNT_DT_AFTER_BILL  -->
		     <!-- 비고 -->
		     <!-- , CLMN.CLMN_PLAN_RMK      AS CLMN_PLAN_RMK      -->
		     <!--  수금관리상황 -->
		     <!-- , CLMN.CLMN_MGMT_STATUS   AS CLMN_MGMT_STATUS -->  
		FROM   TB_CR02M01 AS ORDRS
		       <!-- 수주수금계획 -->
		       JOIN TB_CR02D01 AS CLMN  ON CLMN.CO_CD    = ORDRS.CO_CD
				                       AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
		       <!-- 매출확정 -->
		       LEFT JOIN (
			              SELECT CM.CO_CD                                          --회사코드
			                   , CD.ORDRS_NO                                       --수주번호
			                   , CD.CLMN_PLAN_SEQ                                  --수금계획순번
			                   , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
			                   , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
			              FROM   TB_CR03M01 AS CM
			                     JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
									                  AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			              GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			             ) AS CONF  ON CONF.CO_CD         = CLMN.CO_CD
					               AND CONF.ORDRS_NO      = CLMN.ORDRS_NO
					               AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
		       LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD     --고객사
		       LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD	--회사
		       LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV	--수주구분
		       LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD		--통화단위
		       LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV	--수금구분
		       LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD	--통화단위
		WHERE  ORDRS.CO_CD LIKE '%${coCd}%' --회사
		AND    NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
		AND    NVL(C.CLNT_NM      , '.') LIKE '%${ordrsClntNm}%' --고객사명
		ORDER BY ORDRS.CO_CD, ORDRS.ORDRS_NO, CLMN.CLMN_PLAN_SEQ
	</select>

	 

</mapper>