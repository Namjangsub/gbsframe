<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm02.mapper.SM02Mapper">

	<!-- 매입관리 - 발주관리 조회 리스트  조회조건 -->
	<sql id="selectOrderListCondition">

		<!-- 회사코드 -->         
		<if test="coCd != null and !coCd.equals('')">
			AND CO_CD = #{coCd}   
		</if>
		<!-- 발주일자 -->         
		<if test="ordrgDtFrom != null and !ordrgDtFrom.equals('')">
			<if test="ordrgDtTo != null and !ordrgDtTo.equals('')">
            			AND ORDRG_DT BETWEEN #{ordrgDtFrom} AND #{ordrgDtTo}
            		</if>   
		</if>							
		<!-- 구매처 -->         
		<if test="pchsClntCd != null and !pchsClntCd.equals('')">
			AND PCHS_CLNT_CD = #{pchsClntCd}   
		</if>							
	</sql>	
		
	<!-- 기준관리 - 결재선 조회 리스트  카운트 -->
	<select id="selectOrderListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) 
			FROM TB_SM02M01
		WHERE 1=1
		<include refid="selectOrderListCondition"></include>
	</select>
	
	<!-- 기준관리 - 발주관리 리스트  -->
	<select id="selectOrderList" parameterType="Map" resultType="camelMap">   
		/* No. 내림차순 */
		SELECT *
			FROM
			(
			SELECT X.*
					, ROWNUM AS RN
					FROM
						(
						SELECT A.FILE_TRGT_KEY
								, A.CO_CD
								, A.ORDRG_NO
								, A.REQ_NO
								, A.SALES_CD
								, A.PCHS_CLNT_CD
								, B.CLNT_NM								
								, TO_CHAR(A.ORDRG_DT, 'YYYY-MM-DD') ORDRG_DT
								, A.ORDRG_DIV10					/* 발주구분 */
								, FN_CM05M01_CD_TO_NM(A.ORDRG_DIV10) AS ORDRG_DIV10_NM	/* 발주구분명 */
								, A.ORDRG_DIV20					/* 용도구분 */
								, FN_CM05M01_CD_TO_NM(A.ORDRG_DIV20) AS ORDRG_DIV20_NM	/* 용도구분명 */
								, A.ORDRG_DIV30					/* 특성구분 */
								, FN_CM05M01_CD_TO_NM(A.ORDRG_DIV30) AS ORDRG_DIV30_NM	/* 특성구분명 */								
								, A.CURR_CD						/* 통화단위 */
								, A.EXRATE
								, A.ORDRG_AMT
								, TO_CHAR(A.DUDT_DEQ_DT, 'YYYY-MM-DD') DUDT_DEQ_DT
								, A.ORDRG_RMK
								, A.IN_CMPLET_YN
								, A.ETC_FIELD1
								, A.ETC_FIELD2
								, A.ETC_FIELD3
								, A.CREAT_ID
								, A.CREAT_PGM
								, A.CREAT_DTTM
							FROM TB_SM02M01 A
							LEFT OUTER JOIN TB_BM02M01 B ON(A.PCHS_CLNT_CD=B.CLNT_CD)						
						WHERE 1=1						
						<include refid="selectOrderListCondition"></include>
						ORDER BY A.CO_CD DESC, A.ORDRG_NO DESC, A.CREAT_DTTM DESC, A.UDT_DTTM DESC		
						) X		
			)							
			WHERE 1=1
				AND RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>


	<!-- 기준관리 - 일정계획 등록 메인 화면 엑셀 조회 리스트  -->
	<select id="selectApprovalExcelList" parameterType="Map" resultType="camelMap">   
		/* No. 내림차순 */
		SELECT *
			FROM
			(
			SELECT X.*
					, ROWNUM AS RN
					FROM
						(
						SELECT A.FILE_TRGT_KEY
								, A.CO_CD
								, A.ORDRG_NO
								, A.REQ_NO
								, A.SALES_CD
								, A.PCHS_CLNT_CD
								, B.CLNT_NM								
								, TO_CHAR(A.ORDRG_DT, 'YYYY-MM-DD') ORDRG_DT
								, A.ORDRG_DIV10					/* 발주구분 */
								, FN_CM05M01_CD_TO_NM(A.ORDRG_DIV10) AS ORDRG_DIV10_NM	/* 발주구분명 */
								, A.ORDRG_DIV20					/* 용도구분 */
								, FN_CM05M01_CD_TO_NM(A.ORDRG_DIV20) AS ORDRG_DIV20_NM	/* 용도구분명 */
								, A.ORDRG_DIV30					/* 특성구분 */
								, FN_CM05M01_CD_TO_NM(A.ORDRG_DIV30) AS ORDRG_DIV30_NM	/* 특성구분명 */								
								, A.CURR_CD						/* 통화단위 */
								, A.EXRATE
								, A.ORDRG_AMT
								, TO_CHAR(A.DUDT_DEQ_DT, 'YYYY-MM-DD') DUDT_DEQ_DT
								, A.ORDRG_RMK
								, A.IN_CMPLET_YN
								, A.ETC_FIELD1
								, A.ETC_FIELD2
								, A.ETC_FIELD3
								, A.CREAT_ID
								, A.CREAT_PGM
								, A.CREAT_DTTM
							FROM TB_SM02M01 A
							LEFT OUTER JOIN TB_BM02M01 B ON(A.PCHS_CLNT_CD=B.CLNT_CD)						
						WHERE 1=1						
						<include refid="selectOrderListCondition"></include>
						ORDER BY A.CO_CD DESC, A.ORDRG_NO DESC, A.CREAT_DTTM DESC, A.UDT_DTTM DESC					
						) X		
			)							
			WHERE 1=1
			/* 엑셀은 전체 조회 */
	</select>
	
	<!--  file target key -->
	<select id="selectMaxTrgtKey" parameterType="Map" resultType="int">
    	SELECT NVL(MAX(TO_NUMBER(FILE_TRGT_KEY)),0) + 1 FROM TB_SM02M01
	</select>	
	
	<!-- 발주번호 max -->	
	<select id="selectMaxOrdrgNo" parameterType="Map" resultType="String">
		SELECT NVL(MAX_ORDRG_NO, 'BAL'||TO_CHAR(SYSDATE, 'YY')||'00001') AS MAX_ORDRG_NO
			FROM
			(
			SELECT DISTINCT DECODE( INSTR(ORDRG_NO, 'BAL'||TO_CHAR(SYSDATE, 'YY')), 0, 'BAL'||TO_CHAR(SYSDATE, 'YY')||'00001'
							, 'BAL' || MAX( TO_CHAR(SYSDATE, 'YY')|| LPAD( SUBSTRING(ORDRG_NO, -5)+1, 5, '0') ) OVER()
						  ) AS MAX_ORDRG_NO
				FROM TB_SM02M01
			UNION ALL
			SELECT NULL AS MAX_ORDRG_NO
				FROM DUAL		
			)		
			WHERE MAX_ORDRG_NO IS NOT NULL OR ROWNUM = 1	
	</select>		
	
	<!-- 발주관리 - 발주마스터 등록 -->
	<insert id="insertOrderMaster" parameterType="Map">	
		INSERT INTO TB_SM02M01
	      (
			FILE_TRGT_KEY
			, CO_CD
			, ORDRG_NO
			, REQ_NO
			, SALES_CD
			, PCHS_CLNT_CD
			, ORDRG_DT
			, ORDRG_DIV10
			, ORDRG_DIV20
			, ORDRG_DIV30
			, CURR_CD
			, EXRATE
			, ORDRG_AMT
			, DUDT_DEQ_DT
			, ORDRG_RMK
			, IN_CMPLET_YN
			, ETC_FIELD1
			, ETC_FIELD2
			, ETC_FIELD3
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM
	      )
	    VALUES
	    (
			#{fileTrgtKey}
			, #{coCd}
			, #{maxOrdrgNo}
			, #{reqNo,  jdbcType=VARCHAR}
			, #{salesCd,  jdbcType=VARCHAR}
			, #{pchsClntCd,  jdbcType=VARCHAR}
			, #{ordrgDt,  jdbcType=VARCHAR}
			, #{ordrgDiv10,  jdbcType=VARCHAR}
			, #{ordrgDiv20,  jdbcType=VARCHAR}
			, #{ordrgDiv30,  jdbcType=VARCHAR}
			, #{currCd,  jdbcType=VARCHAR}
			, #{exrate,  jdbcType=VARCHAR}
			, #{ordrgAmt,  jdbcType=VARCHAR}
			, #{dudtDeqDt,  jdbcType=VARCHAR}
			, #{ordrgRmk,  jdbcType=VARCHAR}
			, #{inCmpletYn,  jdbcType=VARCHAR}
			, #{etcField1,  jdbcType=VARCHAR}
			, #{etcField2,  jdbcType=VARCHAR}
			, #{etcField3,  jdbcType=VARCHAR}
			, #{userId}
			, #{pgmId}
			, SYSDATE
	    )
	</insert>	
	
	<!-- 발주 detail 등록 -->
	<insert id="insertOrderDetail" parameterType="Map">

	    <selectKey keyProperty="ordrgSeq" resultType="String" order="BEFORE">
			SELECT NVL(MAX(ORDRG_SEQ)+1, 1) FROM TB_SM02D01 
				WHERE CO_CD = #{coCd}
						AND ORDRG_NO = #{maxOrdrgNo}
	    </selectKey>		    
	    INSERT INTO TB_SM02D01
	    (
			CO_CD
			, ORDRG_NO
			, ORDRG_SEQ
			, SALES_CD
			, PART_NO
			, UNIT_NO
			, REV_NO
			, DSGN_NO
			, MATR_CD
			, MATR_TEST_DIV
			, ORDRG_PRC
			, ORDRG_QTY
			, ORDRG_AMT
			, DUDT_DEQ_DT
			, DUDT_INTEND_DT
			, ORDRG_DTL_RMK
			, ETC_FIELD1
			, ETC_FIELD2
			, ETC_FIELD3
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM
			, IN_CMPLET_YN
			, WH_CD
	      )
	    VALUES
	    (
			#{coCd}
			, #{maxOrdrgNo}
			, #{ordrgSeq}
			, #{salesCd}
			, #{partNo}
			, #{unitNo}
			, #{revNo}
			, #{dsgnNo,  jdbcType=VARCHAR}	  
			, #{matrCd}
			, #{matrTestDiv}
			, #{ordrgPrc,  jdbcType=VARCHAR}	  
			, #{ordrgQty,  jdbcType=VARCHAR}	  
			, #{ordrgAmt,  jdbcType=VARCHAR}	   
			, #{dudtDeqDt,  jdbcType=VARCHAR}	  
			, #{dudtIntendDt,  jdbcType=VARCHAR}	  
			, #{ordrgDtlRmk,  jdbcType=VARCHAR}	   
			, #{etcField1,  jdbcType=VARCHAR}
			, #{etcField2,  jdbcType=VARCHAR}
			, #{etcField3,  jdbcType=VARCHAR}
			, #{userId}
			, #{pgmId}
			, SYSDATE
			, #{inCmpletYn,			jdbcType=VARCHAR}			
			, #{whCd,  				jdbcType=VARCHAR}	 			   
	    )
	</insert>	
		
 </mapper>