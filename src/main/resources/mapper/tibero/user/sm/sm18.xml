<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm18.mapper.SM18Mapper">
	
	
	<!-- 구매현황 카운트 -->
	<select id="sm18_gridView_selectCount" parameterType="Map" resultType="int">
	SELECT COUNT(*)	
			FROM
		 	(	
		 	SELECT *
		 		FROM
		 		(	
				SELECT A.CO_CD	
					, A.PCHS_NO			/* 매입번호 */
					, A.PCHS_NO_GRID		/* 매입번호 그리드 출력용 */
					, A.ORDRG_NO
					, A.SALES_CD
					, A.PCHS_CLNT_CD
					, A.PCHS_CLNT_NM		/* 구매처명 */
					, A.MATR_CD
					, A.ORDRG_QTY
					, A.ORDRG_AMT	
					, A.ORDRG_DT	
					, A.PCHS_AMT
					, A.PCHS_VAT		/* 부가세 */
					, A.PCHS_QTY			/* 수량 */
					, 
					(
					  CASE 
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND NVL(A.PCHS_VAT, 0) > 0 )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND A.PCHS_VAT IS NOT NULL  )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))							  	 
					    ELSE NULL
					  END
					) AS PCHS_SUM_AMT			/* 합계금액 */
					, CASE  
						WHEN ( SUBSTR(A.ORDRG_NO, 0, 3) = 'BAL' )		/* 발주와 기타구매비용 분리 */
							THEN NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0)
						/* ELSE NVL(A.ORDRG_AMT, 0) + NVL(A.PCHS_VAT, 0)  */
						ELSE NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0) 
					  END AS REMAIN_AMT	/* 잔여금액 구매비용일 경우 부가세 포함으로 작업함 */							
					, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
					, A.DSGN_NO			/* 도번 MIN */
					, A.CMPLET_YN
					, A.USER_CHK_V
					, A.IS_COST
					, A.CRN		 /*사업자등록번호*/
					, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
					, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
					, A.PCHS_PMNT_MTD_CD  --결제조건 코드
				    , A.PCHS_PMNT_MTD_NM /*결제조건명*/
				    , A.CLOSE_YM /*마감년월*/
				  FROM
				  (
					SELECT DISTINCT 
							  A.CO_CD                                               AS CO_CD          --회사코드
							, A.ORDRG_NO                                             AS ORDRG_NO       --발주번호
							, A.SALES_CD                                             AS SALES_CD       --SALES CODE
							, A.PCHS_CLNT_CD                                         AS PCHS_CLNT_CD   --구매처cd
							, C.CLNT_NM                                              AS PCHS_CLNT_NM   --구매처명
							, '' AS MATR_CD --자재명 없음
							, A.ORDRG_DT											 AS ORDRG_DT       --발주일자									
							, D.DSGN_NO 											 AS DSGN_NO			/* 도번 MIN */
							, D.ORDRG_QTY				/* 발주수량 */
							, D.ORDRG_AMT				/*발주 금액 */
							, NVL(E.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */
							, E.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/					
							, E.PCHS_AMT				/* 매입금액 */
							, E.PCHS_VAT				/* 매입금액 */
							, E.PCHS_QTY				/* 매입수량 */
							, E.PCHS_DT					/* 매입확정일자 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS CMPLET_YN	 		/* 확정여부 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS USER_CHK_V	 		/* 확정여부 */											            
							, 'N' IS_COST			/* 기타비용여부 */		
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(E.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
						FROM TB_SM02M01 A --발주마스터
					    INNER 	 JOIN TB_SM02D01 B ON(A.ORDRG_NO=B.ORDRG_NO)		/* 발주디테일 */
					    INNER      JOIN TB_BM02M01 AS C ON A.PCHS_CLNT_CD = C.CLNT_CD--거래처마스터   
					    LEFT OUTER JOIN (SELECT A.CO_CD
												, A.ORDRG_NO
												, A.SALES_CD
												, SUM(A.ORDRG_QTY) ORDRG_QTY
												, SUM(A.ORDRG_AMT) ORDRG_AMT
												, ( SELECT MIN(B.DSGN_NO) FROM TB_SM02D01 B WHERE A.SALES_CD=B.SALES_CD AND A.ORDRG_NO=B.ORDRG_NO) AS DSGN_NO
											FROM TB_SM02D01 A
					                     WHERE 1=1
					                     	GROUP BY A.CO_CD
					                                 , A.ORDRG_NO
					                                 , A.SALES_CD
					                     ) AS D ON A.SALES_CD = D.SALES_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
						LEFT OUTER JOIN(
										SELECT ORDRG_NO
												, SUM(A.PCHS_AMT) AS PCHS_AMT
												, SUM(A.PCHS_VAT) AS PCHS_VAT
												, SUM(A.PCHS_QTY) AS PCHS_QTY
												, PCHS_NO
												, COUNT(A.PCHS_NO) PCHS_CNT 
												, SUM(DECODE(A.CMPLET_YN, 'Y', 1, 0)) AS CMPLET_SUM
												, MAX(A.PCHS_DT) AS PCHS_DT
											FROM TB_SM12D01 A 
										WHERE 1=1
											AND ORDRG_NO LIKE 'BAL%'
											GROUP BY A.CO_CD
													, A.ORDRG_NO
													, A.PCHS_NO															
										) E ON(A.ORDRG_NO=E.ORDRG_NO)	/* 매입 DETAIL */    	
						LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = A.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1
					UNION ALL		       
						SELECT E.CO_CD
							, E.COST_NO AS ORDRG_NO
							, NVL(E.SALES_CD, E.COST_NO) AS SALES_CD
							, E.PCHS_CLNT_CD				/* 구매처cd */
							,
							(
								SELECT D.CLNT_NM
									FROM TB_BM02M01 D
								WHERE E.PCHS_CLNT_CD=D.CLNT_CD
							) AS PCHS_CLNT_NM		/* 구매처명 */
							, E.PCHS_COST_DIV10 AS MATR_CD
							, E.COST_DT AS ORDRG_DT			
							, '' AS DSGN_NO							
							, 1 AS ORDRG_QTY				/*발주수량 */
							, E.COST_AMT AS ORDRG_AMT		/*발주 금액 */												
							, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
							, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
							, D.PCHS_AMT /*- TRUNC(E.COST_AMT * 10/110 ) */ AS PCHS_AMT		/* 매입금액  - 부가세 미포함으로설정  */
							, TRUNC(E.COST_AMT * 10/110 ) AS PCHS_VAT		/* 부가세 */
							, D.PCHS_QTY			/* 수량 */										
							, D.PCHS_DT
							, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
							, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
							, 'Y' IS_COST			/* 기타비용여부 */
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(D.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
							FROM TB_SM10M01 E		/* 구매비용 */		
							LEFT OUTER JOIN TB_SM12D01 D ON(D.ORDRG_NO=E.COST_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */
							LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1													
				  ) A		/* 발주+기타비용 내역 */
				WHERE 1=1
				) Z
				WHERE 1=1
			<if test="coCd != null and !coCd.equals('')">
				AND Z.CO_CD = #{coCd}   
			</if>
			<!-- 일자  -->
			<if test="closeYmFrom != null and !closeYmFrom.equals('') and closeYmTo != null and !closeYmTo.equals('')" >
				AND	Z.PCHS_DT BETWEEN TO_DATE( #{closeYmFrom},'YYYYMMDD') AND TO_DATE( #{closeYmTo},'YYYYMMDD') --발주일자
			</if>				
			<if test="pchsClmnDay != null and !pchsClmnDay.equals('')">
				AND Z.PCHS_CLMN_DAY = #{pchsClmnDay}
			</if>			
			AND NVL(Z.CMPLET_YN, 'N') = 'Y'	/* 체크항목 CHKBOX 표시를 안하기 위해서 '' 처리후 USER_CHK_V 로 검색 */	
			ORDER BY Z.SALES_CD, Z.CO_CD, Z.PCHS_DT
			) T		
	</select>
	
	<!-- 구매현황 리스트 -->
	<select id="sm18_gridView_selectList" parameterType="Map" resultType="camelMap">
	SELECT *
			FROM
			(	
			SELECT X.*
				, ROWNUM AS RN
				FROM
				(
				SELECT *
					FROM
					(
					SELECT A.CO_CD	
					, A.PCHS_NO			/* 매입번호 */
					, A.PCHS_NO_GRID		/* 매입번호 그리드 출력용 */
					, A.ORDRG_NO
					, A.SALES_CD
					, A.PCHS_CLNT_CD
					, A.PCHS_CLNT_NM		/* 구매처명 */
					, A.MATR_CD
					, A.ORDRG_QTY
					, A.ORDRG_AMT	
					, A.ORDRG_DT	
					, A.PCHS_AMT
					, A.PCHS_VAT		/* 부가세 */
					, A.PCHS_QTY			/* 수량 */
					, 
					(
					  CASE 
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND NVL(A.PCHS_VAT, 0) > 0 )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND A.PCHS_VAT IS NOT NULL  )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))							  	 
					    ELSE NULL
					  END
					) AS PCHS_SUM_AMT			/* 합계금액 */
					, CASE  
						WHEN ( SUBSTR(A.ORDRG_NO, 0, 3) = 'BAL' )		/* 발주와 기타구매비용 분리 */
							THEN NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0)
						/* ELSE NVL(A.ORDRG_AMT, 0) + NVL(A.PCHS_VAT, 0)  */
						ELSE NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0) 
					  END AS REMAIN_AMT	/* 잔여금액 구매비용일 경우 부가세 포함으로 작업함 */							
					, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
					, A.DSGN_NO			/* 도번 MIN */
					, A.CMPLET_YN
					, A.USER_CHK_V
					, A.IS_COST
					, A.CRN		 /*사업자등록번호*/
					, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
					, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
					, A.PCHS_PMNT_MTD_CD  --결제조건 코드
				    , A.PCHS_PMNT_MTD_NM /*결제조건명*/
				    , A.CLOSE_YM /*마감년월*/
				  FROM
				  (
					SELECT DISTINCT 
							  A.CO_CD                                               AS CO_CD          --회사코드
							, A.ORDRG_NO                                             AS ORDRG_NO       --발주번호
							, A.SALES_CD                                             AS SALES_CD       --SALES CODE
							, A.PCHS_CLNT_CD                                         AS PCHS_CLNT_CD   --구매처cd
							, C.CLNT_NM                                              AS PCHS_CLNT_NM   --구매처명
							, '' AS MATR_CD --자재명 없음
							, A.ORDRG_DT											 AS ORDRG_DT       --발주일자									
							, D.DSGN_NO 											 AS DSGN_NO			/* 도번 MIN */
							, D.ORDRG_QTY				/* 발주수량 */
							, D.ORDRG_AMT				/*발주 금액 */
							, NVL(E.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */
							, E.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/					
							, E.PCHS_AMT				/* 매입금액 */
							, E.PCHS_VAT				/* 매입금액 */
							, E.PCHS_QTY				/* 매입수량 */
							, E.PCHS_DT					/* 매입확정일자 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS CMPLET_YN	 		/* 확정여부 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS USER_CHK_V	 		/* 확정여부 */											            
							, 'N' IS_COST			/* 기타비용여부 */		
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(E.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
						FROM TB_SM02M01 A --발주마스터
					    INNER 	 JOIN TB_SM02D01 B ON(A.ORDRG_NO=B.ORDRG_NO)		/* 발주디테일 */
					    INNER      JOIN TB_BM02M01 AS C ON A.PCHS_CLNT_CD = C.CLNT_CD--거래처마스터   
					    LEFT OUTER JOIN (SELECT A.CO_CD
												, A.ORDRG_NO
												, A.SALES_CD
												, SUM(A.ORDRG_QTY) ORDRG_QTY
												, SUM(A.ORDRG_AMT) ORDRG_AMT
												, ( SELECT MIN(B.DSGN_NO) FROM TB_SM02D01 B WHERE A.SALES_CD=B.SALES_CD AND A.ORDRG_NO=B.ORDRG_NO) AS DSGN_NO
											FROM TB_SM02D01 A
					                     WHERE 1=1
					                     	GROUP BY A.CO_CD
					                                 , A.ORDRG_NO
					                                 , A.SALES_CD
					                     ) AS D ON A.SALES_CD = D.SALES_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
						LEFT OUTER JOIN(
										SELECT ORDRG_NO
												, SUM(A.PCHS_AMT) AS PCHS_AMT
												, SUM(A.PCHS_VAT) AS PCHS_VAT
												, SUM(A.PCHS_QTY) AS PCHS_QTY
												, PCHS_NO
												, COUNT(A.PCHS_NO) PCHS_CNT 
												, SUM(DECODE(A.CMPLET_YN, 'Y', 1, 0)) AS CMPLET_SUM
												, MAX(A.PCHS_DT) AS PCHS_DT
											FROM TB_SM12D01 A 
										WHERE 1=1
											AND ORDRG_NO LIKE 'BAL%'
											GROUP BY A.CO_CD
													, A.ORDRG_NO
													, A.PCHS_NO															
										) E ON(A.ORDRG_NO=E.ORDRG_NO)	/* 매입 DETAIL */    	
						LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = A.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1
					UNION ALL		       
						SELECT E.CO_CD
							, E.COST_NO AS ORDRG_NO
							, NVL(E.SALES_CD, E.COST_NO) AS SALES_CD
							, E.PCHS_CLNT_CD				/* 구매처cd */
							,
							(
								SELECT D.CLNT_NM
									FROM TB_BM02M01 D
								WHERE E.PCHS_CLNT_CD=D.CLNT_CD
							) AS PCHS_CLNT_NM		/* 구매처명 */
							, E.PCHS_COST_DIV10 AS MATR_CD
							, E.COST_DT AS ORDRG_DT			
							, '' AS DSGN_NO							
							, 1 AS ORDRG_QTY				/*발주수량 */
							, E.COST_AMT AS ORDRG_AMT		/*발주 금액 */												
							, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
							, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
							, D.PCHS_AMT /*- TRUNC(E.COST_AMT * 10/110 ) */ AS PCHS_AMT		/* 매입금액  - 부가세 미포함으로설정  */
							, TRUNC(E.COST_AMT * 10/110 ) AS PCHS_VAT		/* 부가세 */
							, D.PCHS_QTY			/* 수량 */										
							, D.PCHS_DT
							, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
							, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
							, 'Y' IS_COST			/* 기타비용여부 */
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(D.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
							FROM TB_SM10M01 E		/* 구매비용 */		
							LEFT OUTER JOIN TB_SM12D01 D ON(D.ORDRG_NO=E.COST_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */
							LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1													
				  ) A		/* 발주+기타비용 내역 */
				  WHERE 1=1
				  ) Z
				WHERE 1=1
				<if test="coCd != null and !coCd.equals('')">
					AND Z.CO_CD = #{coCd}   
				</if>
				<!-- 일자  -->
				<if test="closeYmFrom != null and !closeYmFrom.equals('') and closeYmTo != null and !closeYmTo.equals('')" >
					AND	Z.PCHS_DT BETWEEN TO_DATE( #{closeYmFrom},'YYYYMMDD') AND TO_DATE( #{closeYmTo},'YYYYMMDD') --발주일자
				</if>
				<if test="pchsClmnDay != null and !pchsClmnDay.equals('')">
					AND Z.PCHS_CLMN_DAY = #{pchsClmnDay}
				</if>			
				AND NVL(Z.CMPLET_YN, 'N') = 'Y'	/* 체크항목 CHKBOX 표시를 안하기 위해서 '' 처리후 USER_CHK_V 로 검색 */		
				ORDER BY Z.SALES_CD, Z.CO_CD, Z.PCHS_DT
				) X
			)
			WHERE 1=1
			AND RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
</mapper>