<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm18.mapper.SM18Mapper">
	
	
	<!-- 구매현황 카운트 -->
	<select id="sm18_gridView_selectCount" parameterType="Map" resultType="int">
	SELECT COUNT(*)	
			FROM
		 	(	
		 	SELECT *
		 		FROM
		 		(	
				SELECT A.CO_CD	
					, A.PCHS_NO			/* 매입번호 */
					, A.PCHS_NO_GRID		/* 매입번호 그리드 출력용 */
					, A.ORDRG_NO
					, A.SALES_CD
					, A.PCHS_CLNT_CD
					, A.PCHS_CLNT_NM		/* 구매처명 */
					, A.MATR_CD
					, A.ORDRG_QTY
					, A.ORDRG_AMT	
					, A.ORDRG_DT	
					, A.PCHS_AMT
					, A.PCHS_VAT		/* 부가세 */
					, A.PCHS_QTY			/* 수량 */
					, 
					(
					  CASE 
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND NVL(A.PCHS_VAT, 0) > 0 )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND A.PCHS_VAT IS NOT NULL  )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))							  	 
					    ELSE NULL
					  END
					) AS PCHS_SUM_AMT			/* 합계금액 */
					, CASE  
						WHEN ( SUBSTR(A.ORDRG_NO, 0, 3) = 'BAL' )		/* 발주와 기타구매비용 분리 */
							THEN NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0)
						/* ELSE NVL(A.ORDRG_AMT, 0) + NVL(A.PCHS_VAT, 0)  */
						ELSE NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0) 
					  END AS REMAIN_AMT	/* 잔여금액 구매비용일 경우 부가세 포함으로 작업함 */							
					, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
					, A.DSGN_NO			/* 도번 MIN */
					, A.CMPLET_YN
					, A.USER_CHK_V
					, A.IS_COST
					, A.CRN		 /*사업자등록번호*/
					, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
					, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
					, A.PCHS_PMNT_MTD_CD  --결제조건 코드
				    , A.PCHS_PMNT_MTD_NM /*결제조건명*/
				    , A.CLOSE_YM /*마감년월*/
				  FROM
				  (
					SELECT DISTINCT 
							  A.CO_CD                                               AS CO_CD          --회사코드
							, A.ORDRG_NO                                             AS ORDRG_NO       --발주번호
							, A.SALES_CD                                             AS SALES_CD       --SALES CODE
							, A.PCHS_CLNT_CD                                         AS PCHS_CLNT_CD   --구매처cd
							, C.CLNT_NM                                              AS PCHS_CLNT_NM   --구매처명
							, '' AS MATR_CD --자재명 없음
							, A.ORDRG_DT											 AS ORDRG_DT       --발주일자									
							, D.DSGN_NO 											 AS DSGN_NO			/* 도번 MIN */
							, D.ORDRG_QTY				/* 발주수량 */
							, D.ORDRG_AMT				/*발주 금액 */
							, NVL(E.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */
							, E.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/					
							, E.PCHS_AMT				/* 매입금액 */
							, E.PCHS_VAT				/* 매입금액 */
							, E.PCHS_QTY				/* 매입수량 */
							, E.PCHS_DT					/* 매입확정일자 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS CMPLET_YN	 		/* 확정여부 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS USER_CHK_V	 		/* 확정여부 */											            
							, 'N' IS_COST			/* 기타비용여부 */		
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(E.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
						FROM TB_SM02M01 A --발주마스터
					    INNER 	 JOIN TB_SM02D01 B ON(A.ORDRG_NO=B.ORDRG_NO)		/* 발주디테일 */
					    INNER      JOIN TB_BM02M01 AS C ON A.PCHS_CLNT_CD = C.CLNT_CD--거래처마스터   
					    LEFT OUTER JOIN (SELECT A.CO_CD
												, A.ORDRG_NO
												, A.SALES_CD
												, SUM(A.ORDRG_QTY) ORDRG_QTY
												, SUM(A.ORDRG_AMT) ORDRG_AMT
												, ( SELECT MIN(B.DSGN_NO) FROM TB_SM02D01 B WHERE A.SALES_CD=B.SALES_CD AND A.ORDRG_NO=B.ORDRG_NO) AS DSGN_NO
											FROM TB_SM02D01 A
					                     WHERE 1=1
					                     	GROUP BY A.CO_CD
					                                 , A.ORDRG_NO
					                                 , A.SALES_CD
					                     ) AS D ON A.SALES_CD = D.SALES_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
						LEFT OUTER JOIN(
										SELECT ORDRG_NO
												, SUM(A.PCHS_AMT) AS PCHS_AMT
												, SUM(A.PCHS_VAT) AS PCHS_VAT
												, SUM(A.PCHS_QTY) AS PCHS_QTY
												, PCHS_NO
												, COUNT(A.PCHS_NO) PCHS_CNT 
												, SUM(DECODE(A.CMPLET_YN, 'Y', 1, 0)) AS CMPLET_SUM
												, MAX(A.PCHS_DT) AS PCHS_DT
											FROM TB_SM12D01 A 
										WHERE 1=1
											AND ORDRG_NO LIKE 'BAL%'
											GROUP BY A.CO_CD
													, A.ORDRG_NO
													, A.PCHS_NO															
										) E ON(A.ORDRG_NO=E.ORDRG_NO)	/* 매입 DETAIL */    	
						LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = A.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1
					UNION ALL		       
						SELECT E.CO_CD
							, E.COST_NO AS ORDRG_NO
							, NVL(E.SALES_CD, E.COST_NO) AS SALES_CD
							, E.PCHS_CLNT_CD				/* 구매처cd */
							,
							(
								SELECT D.CLNT_NM
									FROM TB_BM02M01 D
								WHERE E.PCHS_CLNT_CD=D.CLNT_CD
							) AS PCHS_CLNT_NM		/* 구매처명 */
							, E.PCHS_COST_DIV10 AS MATR_CD
							, E.COST_DT AS ORDRG_DT			
							, '' AS DSGN_NO							
							, 1 AS ORDRG_QTY				/*발주수량 */
							, E.COST_AMT AS ORDRG_AMT		/*발주 금액 */												
							, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
							, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
							, D.PCHS_AMT /*- TRUNC(E.COST_AMT * 10/110 ) */ AS PCHS_AMT		/* 매입금액  - 부가세 미포함으로설정  */
							, TRUNC(E.COST_AMT * 10/110 ) AS PCHS_VAT		/* 부가세 */
							, D.PCHS_QTY			/* 수량 */										
							, D.PCHS_DT
							, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
							, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
							, 'Y' IS_COST			/* 기타비용여부 */
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(D.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
							FROM TB_SM10M01 E		/* 구매비용 */		
							LEFT OUTER JOIN TB_SM12D01 D ON(D.ORDRG_NO=E.COST_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */
							LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1													
				  ) A		/* 발주+기타비용 내역 */
				WHERE 1=1
				) Z
				WHERE 1=1
			<if test="coCd != null and !coCd.equals('')">
				AND Z.CO_CD = #{coCd}   
			</if>
			<!-- 일자  -->
			<if test="closeYmFrom != null and !closeYmFrom.equals('') and closeYmTo != null and !closeYmTo.equals('')" >
				AND	Z.PCHS_DT BETWEEN TO_DATE( #{closeYmFrom},'YYYYMMDD') AND TO_DATE( #{closeYmTo},'YYYYMMDD') --발주일자
			</if>				
			<if test="pchsClmnDay != null and !pchsClmnDay.equals('')">
				AND Z.PCHS_CLMN_DAY = #{pchsClmnDay}
			</if>			
			AND NVL(Z.CMPLET_YN, 'N') = 'Y'	/* 체크항목 CHKBOX 표시를 안하기 위해서 '' 처리후 USER_CHK_V 로 검색 */	
			ORDER BY Z.SALES_CD, Z.CO_CD, Z.PCHS_DT
			) T		
	</select>
	
	<!-- 구매현황 리스트 -->
	<select id="sm18_gridView_selectList" parameterType="Map" resultType="camelMap">
	SELECT *
			FROM
			(	
			SELECT X.*
				, ROWNUM AS RN
				FROM
				(
				SELECT *
					FROM
					(
					SELECT A.CO_CD	
					, A.PCHS_NO			/* 매입번호 */
					, A.PCHS_NO_GRID		/* 매입번호 그리드 출력용 */
					, A.ORDRG_NO
					, A.SALES_CD
					, A.PCHS_CLNT_CD
					, A.PCHS_CLNT_NM		/* 구매처명 */
					, A.MATR_CD
					, A.ORDRG_QTY
					, A.ORDRG_AMT	
					, A.ORDRG_DT	
					, A.PCHS_AMT
					, A.PCHS_VAT		/* 부가세 */
					, A.PCHS_QTY			/* 수량 */
					, 
					(
					  CASE 
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND NVL(A.PCHS_VAT, 0) > 0 )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))
					  	WHEN( NVL(A.PCHS_AMT, 0) > 0 AND A.PCHS_VAT IS NOT NULL  )
					  		THEN TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))							  	 
					    ELSE NULL
					  END
					) AS PCHS_SUM_AMT			/* 합계금액 */
					, CASE  
						WHEN ( SUBSTR(A.ORDRG_NO, 0, 3) = 'BAL' )		/* 발주와 기타구매비용 분리 */
							THEN NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0)
						/* ELSE NVL(A.ORDRG_AMT, 0) + NVL(A.PCHS_VAT, 0)  */
						ELSE NVL(A.ORDRG_AMT, 0) - NVL(A.PCHS_AMT, 0) 
					  END AS REMAIN_AMT	/* 잔여금액 구매비용일 경우 부가세 포함으로 작업함 */							
					, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
					, A.DSGN_NO			/* 도번 MIN */
					, A.CMPLET_YN
					, A.USER_CHK_V
					, A.IS_COST
					, A.CRN		 /*사업자등록번호*/
					, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
					, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
					, A.PCHS_PMNT_MTD_CD  --결제조건 코드
				    , A.PCHS_PMNT_MTD_NM /*결제조건명*/
				    , A.CLOSE_YM /*마감년월*/
				  FROM
				  (
					SELECT DISTINCT 
							  A.CO_CD                                               AS CO_CD          --회사코드
							, A.ORDRG_NO                                             AS ORDRG_NO       --발주번호
							, A.SALES_CD                                             AS SALES_CD       --SALES CODE
							, A.PCHS_CLNT_CD                                         AS PCHS_CLNT_CD   --구매처cd
							, C.CLNT_NM                                              AS PCHS_CLNT_NM   --구매처명
							, '' AS MATR_CD --자재명 없음
							, A.ORDRG_DT											 AS ORDRG_DT       --발주일자									
							, D.DSGN_NO 											 AS DSGN_NO			/* 도번 MIN */
							, D.ORDRG_QTY				/* 발주수량 */
							, D.ORDRG_AMT				/*발주 금액 */
							, NVL(E.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */
							, E.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/					
							, E.PCHS_AMT				/* 매입금액 */
							, E.PCHS_VAT				/* 매입금액 */
							, E.PCHS_QTY				/* 매입수량 */
							, E.PCHS_DT					/* 매입확정일자 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS CMPLET_YN	 		/* 확정여부 */
							, CASE
								WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
									THEN 'Y'
								ELSE 'N'
							  END AS USER_CHK_V	 		/* 확정여부 */											            
							, 'N' IS_COST			/* 기타비용여부 */		
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(E.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
						FROM TB_SM02M01 A --발주마스터
					    INNER 	 JOIN TB_SM02D01 B ON(A.ORDRG_NO=B.ORDRG_NO)		/* 발주디테일 */
					    INNER      JOIN TB_BM02M01 AS C ON A.PCHS_CLNT_CD = C.CLNT_CD--거래처마스터   
					    LEFT OUTER JOIN (SELECT A.CO_CD
												, A.ORDRG_NO
												, A.SALES_CD
												, SUM(A.ORDRG_QTY) ORDRG_QTY
												, SUM(A.ORDRG_AMT) ORDRG_AMT
												, ( SELECT MIN(B.DSGN_NO) FROM TB_SM02D01 B WHERE A.SALES_CD=B.SALES_CD AND A.ORDRG_NO=B.ORDRG_NO) AS DSGN_NO
											FROM TB_SM02D01 A
					                     WHERE 1=1
					                     	GROUP BY A.CO_CD
					                                 , A.ORDRG_NO
					                                 , A.SALES_CD
					                     ) AS D ON A.SALES_CD = D.SALES_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
						LEFT OUTER JOIN(
										SELECT ORDRG_NO
												, SUM(A.PCHS_AMT) AS PCHS_AMT
												, SUM(A.PCHS_VAT) AS PCHS_VAT
												, SUM(A.PCHS_QTY) AS PCHS_QTY
												, PCHS_NO
												, COUNT(A.PCHS_NO) PCHS_CNT 
												, SUM(DECODE(A.CMPLET_YN, 'Y', 1, 0)) AS CMPLET_SUM
												, MAX(A.PCHS_DT) AS PCHS_DT
											FROM TB_SM12D01 A 
										WHERE 1=1
											AND ORDRG_NO LIKE 'BAL%'
											GROUP BY A.CO_CD
													, A.ORDRG_NO
													, A.PCHS_NO															
										) E ON(A.ORDRG_NO=E.ORDRG_NO)	/* 매입 DETAIL */    	
						LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = A.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1
					UNION ALL		       
						SELECT E.CO_CD
							, E.COST_NO AS ORDRG_NO
							, NVL(E.SALES_CD, E.COST_NO) AS SALES_CD
							, E.PCHS_CLNT_CD				/* 구매처cd */
							,
							(
								SELECT D.CLNT_NM
									FROM TB_BM02M01 D
								WHERE E.PCHS_CLNT_CD=D.CLNT_CD
							) AS PCHS_CLNT_NM		/* 구매처명 */
							, E.PCHS_COST_DIV10 AS MATR_CD
							, E.COST_DT AS ORDRG_DT			
							, '' AS DSGN_NO							
							, 1 AS ORDRG_QTY				/*발주수량 */
							, E.COST_AMT AS ORDRG_AMT		/*발주 금액 */												
							, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
							, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
							, D.PCHS_AMT /*- TRUNC(E.COST_AMT * 10/110 ) */ AS PCHS_AMT		/* 매입금액  - 부가세 미포함으로설정  */
							, TRUNC(E.COST_AMT * 10/110 ) AS PCHS_VAT		/* 부가세 */
							, D.PCHS_QTY			/* 수량 */										
							, D.PCHS_DT
							, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
							, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
							, 'Y' IS_COST			/* 기타비용여부 */
							, BM2.CRN /*사업자등록번호*/
							, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
						    , TO_CHAR(D.PCHS_DT, 'YYYY-MM') AS CLOSE_YM /*마감년월*/
							FROM TB_SM10M01 E		/* 구매비용 */		
							LEFT OUTER JOIN TB_SM12D01 D ON(D.ORDRG_NO=E.COST_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */
							LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/
						WHERE 1=1													
				  ) A		/* 발주+기타비용 내역 */
				  WHERE 1=1
				  ) Z
				WHERE 1=1
				<if test="coCd != null and !coCd.equals('')">
					AND Z.CO_CD = #{coCd}   
				</if>
				<!-- 일자  -->
				<if test="closeYmFrom != null and !closeYmFrom.equals('') and closeYmTo != null and !closeYmTo.equals('')" >
					AND	Z.PCHS_DT BETWEEN TO_DATE( #{closeYmFrom},'YYYYMMDD') AND TO_DATE( #{closeYmTo},'YYYYMMDD') --발주일자
				</if>
				<if test="pchsClmnDay != null and !pchsClmnDay.equals('')">
					AND Z.PCHS_CLMN_DAY = #{pchsClmnDay}
				</if>			
				AND NVL(Z.CMPLET_YN, 'N') = 'Y'	/* 체크항목 CHKBOX 표시를 안하기 위해서 '' 처리후 USER_CHK_V 로 검색 */		
				ORDER BY Z.SALES_CD, Z.CO_CD, Z.PCHS_DT
				) X
			)
			WHERE 1=1
			AND RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
		<!-- 구매현황 카운트 -->
	<select id="sm18_gridView_selectCountNew" parameterType="Map" resultType="int">
	SELECT COUNT(*)	
			FROM
			(
			SELECT X.*
					, ROWNUM AS RN
					FROM
						(
						SELECT A.CO_CD	
							, A.PCHS_NO			/* 매입번호 */
							, A.PCHS_NO_GRID		/* 매입번호 그리드 출력용 */
							, A.ORDRG_NO
							, A.SALES_CD
							, A.PCHS_CLNT_CD
							, A.PCHS_CLNT_NM		/* 구매처명 */
							, A.MATR_CD
							, A.ORDRG_QTY
							, A.ORDRG_AMT	
							, A.IN_DTL_AMT	
							, A.IN_DTL_AMT_GRID	
							, A.ORDRG_DT
							, A.DSGN_NO			/* 대표도번 */	
							, A.PCHS_AMT
							, A.PCHS_VAT		/* 부가세 */
							, A.PCHS_QTY			/* 수량 */
							, 
							(
							  CASE 
							  	WHEN NVL(A.PCHS_AMT,'0') = '0' 
							  	THEN NULL
							  		ELSE TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))						  	 
							  END	
							) AS PCHS_SUM_AMT			/* 합계금액 */
							, CASE  
								WHEN ( SUBSTR(A.ORDRG_NO, 0, 3) = 'RET' )		/* 발주와 기타구매비용 분리 */
									THEN NVL(A.IN_DTL_AMT, 0) + NVL(A.PCHS_AMT, 0)
								/* ELSE NVL(A.IN_DTL_AMT, 0) + NVL(A.PCHS_VAT, 0)  */
								ELSE NVL(A.IN_DTL_AMT, 0) - NVL(A.PCHS_AMT, 0) 
							  END AS REMAIN_AMT	/* 잔여금액 구매비용일 경우 부가세 포함으로 작업함 */							
							, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
							, NVL(A.CMPLET_YN,'') AS CMPLET_YN
							, A.USER_CHK_V
							, A.IS_COST
							, A.IS_CNT
							, A.IS_DIV
							, A.BILL_YN   /*계산서 여부*/
							, A.FILE_TRGT_KEY
							, A.CRN /*사업자등록번호*/
							, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, A.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , A.PCHS_PMNT_MTD_NM /*결제조건명*/
						  FROM
						  (
							SELECT DISTINCT 
									  A.CO_CD                                               AS CO_CD          --회사코드
									, A.ORDRG_NO                                             AS ORDRG_NO       --발주번호
									, A.SALES_CD                                             AS SALES_CD       --SALES CODE
									, A.PCHS_CLNT_CD                                         AS PCHS_CLNT_CD   --구매처cd
									, C.CLNT_NM                                              AS PCHS_CLNT_NM   --구매처명
									, '' AS MATR_CD --자재명 없음
									, A.ORDRG_DT											 AS ORDRG_DT       --발주일자									
									, D.DSGN_NO 											 AS DSGN_NO			/* 도번 MIN */
									, D.ORDRG_QTY				/* 발주수량 */
									, D.ORDRG_AMT				/*발주 금액 */
									, F.IN_DTL_AMT              /*입고 금액 */
									, F.IN_DTL_AMT AS IN_DTL_AMT_GRID         /*입고 금액 */
									, NVL(E.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */
									, E.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/					
									, E.PCHS_AMT				/* 매입금액 */
									, E.PCHS_VAT				/* 매입금액 */
									, E.PCHS_QTY				/* 매입수량 */
									, E.PCHS_QTY AS IS_CNT
									, E.PCHS_DT					/* 매입확정일자 */
									, CASE
										WHEN ( TO_NUMBER(E.PCHS_AMT) = TO_NUMBER(F.IN_DTL_AMT) )
											THEN 'Y'
										ELSE ''
									  END AS CMPLET_YN	 		/* 확정여부 */
									, CASE
										WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
											THEN 'Y'
										ELSE 'N'
									  END AS USER_CHK_V	 		/* 확정여부 */											            
									, 'N' IS_COST			/* 기타비용여부 */	
									, '발주' IS_DIV			/* 구분 */
									, '' AS BILL_YN		  /*계산서 여부*/
									, A.FILE_TRGT_KEY
									, BM2.CRN /*사업자등록번호*/
									, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
									, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
									, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
								    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
								FROM TB_SM02M01 A --발주마스터
				                INNER 	 JOIN TB_SM02D01 B ON(A.ORDRG_NO=B.ORDRG_NO)		/* 발주디테일 */
				                INNER      JOIN TB_BM02M01 AS C ON A.PCHS_CLNT_CD = C.CLNT_CD--거래처마스터   
				                LEFT OUTER JOIN (SELECT A.CO_CD
														, A.ORDRG_NO
														, A.SALES_CD
														, SUM(A.ORDRG_QTY) ORDRG_QTY
														, SUM(A.ORDRG_AMT) ORDRG_AMT
														, ( SELECT MIN(B.DSGN_NO) FROM TB_SM02D01 B WHERE A.SALES_CD=B.SALES_CD AND A.ORDRG_NO=B.ORDRG_NO) AS DSGN_NO
													FROM TB_SM02D01 A
						                         WHERE 1=1
						                         	GROUP BY A.CO_CD
						                                     , A.ORDRG_NO
						                                     , A.SALES_CD
				                                 ) AS D ON A.CO_CD = D.CO_CD AND A.SALES_CD = D.SALES_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
								LEFT OUTER JOIN(
												SELECT ORDRG_NO
														, SUM(A.PCHS_AMT) AS PCHS_AMT
														, SUM(A.PCHS_VAT) AS PCHS_VAT
														, SUM(A.PCHS_QTY) AS PCHS_QTY
														, PCHS_NO
														, COUNT(A.PCHS_NO) PCHS_CNT 
														, SUM(DECODE(A.CMPLET_YN, 'Y', 1, 0)) AS CMPLET_SUM
														, MAX(A.PCHS_DT) AS PCHS_DT
													FROM TB_SM12D01 A 
												WHERE 1=1
													AND ORDRG_NO LIKE 'BAL%'
													GROUP BY A.CO_CD
															, A.ORDRG_NO
															, A.PCHS_NO															
												) E ON(A.ORDRG_NO=E.ORDRG_NO)	/* 매입 DETAIL */    
								LEFT OUTER JOIN (SELECT A.CO_CD
														, A.ORDRG_NO
														, A.SALES_CD
														, SUM(A.IN_DTL_AMT) IN_DTL_AMT
													FROM TB_SM03D01 A
						                         WHERE 1=1
						                         	GROUP BY A.CO_CD
						                                     , A.ORDRG_NO
						                                     , A.SALES_CD
				                                 ) AS F ON A.CO_CD = F.CO_CD AND A.SALES_CD = F.SALES_CD AND A.ORDRG_NO = F.ORDRG_NO --입고상세 
				                 LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = A.PCHS_CLNT_CD /*거래처 마스터*/                                 
									WHERE 1=1
									AND IN_DTL_AMT IS NOT NULL
							UNION ALL		       
								SELECT E.CO_CD
									, E.COST_NO AS ORDRG_NO
									, NVL(E.SALES_CD, E.COST_NO) AS SALES_CD
									, E.PCHS_CLNT_CD				/* 구매처cd */
									,
									(
										SELECT D.CLNT_NM
											FROM TB_BM02M01 D
										WHERE E.PCHS_CLNT_CD=D.CLNT_CD
									) AS PCHS_CLNT_NM		/* 구매처명 */
									, E.PCHS_COST_DIV10 AS MATR_CD
									, E.COST_DT AS ORDRG_DT			
									, '' AS DSGN_NO							
									, 1 AS ORDRG_QTY				/*발주수량 */
									, E.COST_AMT AS ORDRG_AMT		/*발주 금액 */		
									, E.COST_AMT AS IN_DTL_AMT										
									, E.COST_AMT AS IN_DTL_AMT_GRID										
									, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
									, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
									, D.PCHS_AMT /*- TRUNC(E.COST_AMT * 10/110 ) */ AS PCHS_AMT		/* 매입금액  - 부가세 미포함으로설정  */
									, /* TRUNC(E.COST_AMT * 10/110 ) */ D.PCHS_VAT AS PCHS_VAT		/* 부가세 */
									, D.PCHS_QTY			/* 수량 */	
									, D.PCHS_QTY AS IS_CNT									
									, D.PCHS_DT
									, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
									, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
									, 'Y' IS_COST			/* 기타비용여부 */
									, '비용' IS_DIV			/* 구분 */
									, D.BILL_YN AS BILL_YN  /*계산서 여부*/
									, E.FILE_TRGT_KEY
									, BM2.CRN /*사업자등록번호*/
									, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
									, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
									, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
								    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
									FROM TB_SM10M01 E		/* 구매비용 */		
									LEFT OUTER JOIN TB_SM12D01 D ON(D.CO_CD=E.CO_CD AND D.ORDRG_NO=E.COST_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */	
									LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/				
								WHERE 1=1				
							UNION ALL
								SELECT E.CO_CD
									, E.RET_NO AS ORDRG_NO
									, NVL(E.SALES_CD, E.RET_NO) AS SALES_CD
									, E.PCHS_CLNT_CD				/* 구매처cd */
									,
									(
										SELECT D.CLNT_NM
											FROM TB_BM02M01 D
										WHERE E.PCHS_CLNT_CD=D.CLNT_CD
									) AS PCHS_CLNT_NM		/* 구매처명 */
									, E.IO_DIV AS MATR_CD
									, E.RET_DT AS ORDRG_DT			
									, R.DSGN_NO AS DSGN_NO							
									, 1 AS ORDRG_QTY				/*발주수량 */
									, R.RET_DTL_AMT AS ORDRG_AMT		/*발주 금액 */	
									, R.RET_DTL_AMT AS IN_DTL_AMT											
									, -(R.RET_DTL_AMT) AS IN_DTL_AMT_GRID											
									, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
									, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
									, -(D.PCHS_AMT) AS PCHS_AMT		/* 매입금액  */
									, -(D.PCHS_VAT) AS PCHS_VAT		/* 부가세 */
									, D.PCHS_QTY			/* 수량 */	
									, D.PCHS_QTY AS CNT									
									, D.PCHS_DT
									, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
									, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
									, 'R' IS_COST			/* 반품여부 */
									, '반품' IS_DIV			/* 구분 */
									, D.BILL_YN AS BILL_YN  /*계산서 여부*/
									, FILE_TRGT_KEY
									, BM2.CRN /*사업자등록번호*/
									, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
									, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
									, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
								    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
									FROM TB_SM06M01 E		/* 반품 */	
									INNER JOIN (SELECT SUM(RET_DTL_AMT) AS RET_DTL_AMT, MIN(DSGN_NO) AS DSGN_NO, RET_NO, CO_CD FROM TB_SM06D01 GROUP BY RET_NO, CO_CD ) R 
									ON R.CO_CD = E.CO_CD AND R.RET_NO = E.RET_NO	
									LEFT OUTER JOIN TB_SM12D01 D ON(D.CO_CD=E.CO_CD AND D.ORDRG_NO=E.RET_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */	
									LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/
								WHERE 1=1										
						  ) A		/* 발주+기타비용+반품 내역 */
						  WHERE 1=1	
				<include refid="selectPurchaseListCondition"></include>	
				) X
			)
			WHERE 1=1
	</select>
	
	<!-- 구매현황 리스트 -->
	<select id="sm18_gridView_selectListNew" parameterType="Map" resultType="camelMap">
		SELECT *
			FROM
			(
			SELECT X.*
					, ROWNUM AS RN
					FROM
						(
						SELECT A.CO_CD	
							, A.PCHS_NO			/* 매입번호 */
							, A.PCHS_NO_GRID		/* 매입번호 그리드 출력용 */
							, A.ORDRG_NO
							, A.SALES_CD
							, A.PCHS_CLNT_CD
							, A.PCHS_CLNT_NM		/* 구매처명 */
							, A.MATR_CD
							, A.ORDRG_QTY
							, A.ORDRG_AMT	
							, A.IN_DTL_AMT	
							, A.IN_DTL_AMT_GRID	
							, A.ORDRG_DT
							, A.DSGN_NO			/* 대표도번 */	
							, A.PCHS_AMT
							, A.PCHS_VAT		/* 부가세 */
							, A.PCHS_QTY			/* 수량 */
							, 
							(
							  CASE 
							  	WHEN NVL(A.PCHS_AMT,'0') = '0' 
							  	THEN NULL
							  		ELSE TO_NUMBER(NVL(A.PCHS_AMT, 0)) + TO_NUMBER(NVL(A.PCHS_VAT, 0))						  	 
							  END	
							) AS PCHS_SUM_AMT			/* 합계금액 */
							, CASE  
								WHEN ( SUBSTR(A.ORDRG_NO, 0, 3) = 'RET' )		/* 발주와 기타구매비용 분리 */
									THEN NVL(A.IN_DTL_AMT, 0) + NVL(A.PCHS_AMT, 0)
								/* ELSE NVL(A.IN_DTL_AMT, 0) + NVL(A.PCHS_VAT, 0)  */
								ELSE NVL(A.IN_DTL_AMT, 0) - NVL(A.PCHS_AMT, 0) 
							  END AS REMAIN_AMT	/* 잔여금액 구매비용일 경우 부가세 포함으로 작업함 */							
							, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
							, NVL(A.CMPLET_YN,'') AS CMPLET_YN
							, A.USER_CHK_V
							, A.IS_COST
							, A.IS_CNT
							, A.IS_DIV
							, A.BILL_YN   /*계산서 여부*/
							, A.FILE_TRGT_KEY
							, A.CRN /*사업자등록번호*/
							, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, A.PCHS_PMNT_MTD_CD  --결제조건 코드
						    , A.PCHS_PMNT_MTD_NM /*결제조건명*/
						  FROM
						  (
							SELECT DISTINCT 
									  A.CO_CD                                               AS CO_CD          --회사코드
									, A.ORDRG_NO                                             AS ORDRG_NO       --발주번호
									, A.SALES_CD                                             AS SALES_CD       --SALES CODE
									, A.PCHS_CLNT_CD                                         AS PCHS_CLNT_CD   --구매처cd
									, C.CLNT_NM                                              AS PCHS_CLNT_NM   --구매처명
									, '' AS MATR_CD --자재명 없음
									, A.ORDRG_DT											 AS ORDRG_DT       --발주일자									
									, D.DSGN_NO 											 AS DSGN_NO			/* 도번 MIN */
									, D.ORDRG_QTY				/* 발주수량 */
									, D.ORDRG_AMT				/*발주 금액 */
									, F.IN_DTL_AMT              /*입고 금액 */
									, F.IN_DTL_AMT AS IN_DTL_AMT_GRID         /*입고 금액 */
									, NVL(E.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */
									, E.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/					
									, E.PCHS_AMT				/* 매입금액 */
									, E.PCHS_VAT				/* 매입금액 */
									, E.PCHS_QTY				/* 매입수량 */
									, E.PCHS_QTY AS IS_CNT
									, E.PCHS_DT					/* 매입확정일자 */
									, CASE
										WHEN ( TO_NUMBER(E.PCHS_AMT) = TO_NUMBER(F.IN_DTL_AMT) )
											THEN 'Y'
										ELSE ''
									  END AS CMPLET_YN	 		/* 확정여부 */
									, CASE
										WHEN ( COUNT(B.ORDRG_SEQ) OVER(PARTITION BY B.ORDRG_NO) = CMPLET_SUM )
											THEN 'Y'
										ELSE 'N'
									  END AS USER_CHK_V	 		/* 확정여부 */											            
									, 'N' IS_COST			/* 기타비용여부 */	
									, '발주' IS_DIV			/* 구분 */
									, '' AS BILL_YN		  /*계산서 여부*/
									, A.FILE_TRGT_KEY
									, BM2.CRN /*사업자등록번호*/
									, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
									, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
									, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
								    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
								FROM TB_SM02M01 A --발주마스터
				                INNER 	 JOIN TB_SM02D01 B ON(A.ORDRG_NO=B.ORDRG_NO)		/* 발주디테일 */
				                INNER      JOIN TB_BM02M01 AS C ON A.PCHS_CLNT_CD = C.CLNT_CD--거래처마스터   
				                LEFT OUTER JOIN (SELECT A.CO_CD
														, A.ORDRG_NO
														, A.SALES_CD
														, SUM(A.ORDRG_QTY) ORDRG_QTY
														, SUM(A.ORDRG_AMT) ORDRG_AMT
														, ( SELECT MIN(B.DSGN_NO) FROM TB_SM02D01 B WHERE A.SALES_CD=B.SALES_CD AND A.ORDRG_NO=B.ORDRG_NO) AS DSGN_NO
													FROM TB_SM02D01 A
						                         WHERE 1=1
						                         	GROUP BY A.CO_CD
						                                     , A.ORDRG_NO
						                                     , A.SALES_CD
				                                 ) AS D ON A.CO_CD = D.CO_CD AND A.SALES_CD = D.SALES_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
								LEFT OUTER JOIN(
												SELECT ORDRG_NO
														, SUM(A.PCHS_AMT) AS PCHS_AMT
														, SUM(A.PCHS_VAT) AS PCHS_VAT
														, SUM(A.PCHS_QTY) AS PCHS_QTY
														, PCHS_NO
														, COUNT(A.PCHS_NO) PCHS_CNT 
														, SUM(DECODE(A.CMPLET_YN, 'Y', 1, 0)) AS CMPLET_SUM
														, A.PCHS_DT AS PCHS_DT
													FROM TB_SM12D01 A 
												WHERE 1=1
													AND ORDRG_NO LIKE 'BAL%'
													GROUP BY A.CO_CD
															, A.ORDRG_NO
															, A.PCHS_NO	
															, A.PCHS_DT														
												) E ON(A.ORDRG_NO=E.ORDRG_NO)	/* 매입 DETAIL */    
								LEFT OUTER JOIN (SELECT A.CO_CD
														, A.ORDRG_NO
														, A.SALES_CD
														, SUM(A.IN_DTL_AMT) IN_DTL_AMT
													FROM TB_SM03D01 A
						                         WHERE 1=1
						                         	GROUP BY A.CO_CD
						                                     , A.ORDRG_NO
						                                     , A.SALES_CD
				                                 ) AS F ON A.CO_CD = F.CO_CD AND A.SALES_CD = F.SALES_CD AND A.ORDRG_NO = F.ORDRG_NO --입고상세 
				                 LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = A.PCHS_CLNT_CD /*거래처 마스터*/                                 
									WHERE 1=1
									AND IN_DTL_AMT IS NOT NULL
							UNION ALL		       
								SELECT E.CO_CD
									, E.COST_NO AS ORDRG_NO
									, NVL(E.SALES_CD, E.COST_NO) AS SALES_CD
									, E.PCHS_CLNT_CD				/* 구매처cd */
									,
									(
										SELECT D.CLNT_NM
											FROM TB_BM02M01 D
										WHERE E.PCHS_CLNT_CD=D.CLNT_CD
									) AS PCHS_CLNT_NM		/* 구매처명 */
									, E.PCHS_COST_DIV10 AS MATR_CD
									, E.COST_DT AS ORDRG_DT			
									, '' AS DSGN_NO							
									, 1 AS ORDRG_QTY				/*발주수량 */
									, E.COST_AMT AS ORDRG_AMT		/*발주 금액 */		
									, E.COST_AMT AS IN_DTL_AMT										
									, E.COST_AMT AS IN_DTL_AMT_GRID										
									, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
									, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
									, D.PCHS_AMT /*- TRUNC(E.COST_AMT * 10/110 ) */ AS PCHS_AMT		/* 매입금액  - 부가세 미포함으로설정  */
									, /* TRUNC(E.COST_AMT * 10/110 ) */ D.PCHS_VAT AS PCHS_VAT		/* 부가세 */
									, D.PCHS_QTY			/* 수량 */	
									, D.PCHS_QTY AS IS_CNT									
									, D.PCHS_DT
									, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
									, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
									, 'Y' IS_COST			/* 기타비용여부 */
									, '비용' IS_DIV			/* 구분 */
									, D.BILL_YN AS BILL_YN  /*계산서 여부*/
									, E.FILE_TRGT_KEY
									, BM2.CRN /*사업자등록번호*/
									, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
									, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
									, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
								    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
									FROM TB_SM10M01 E		/* 구매비용 */		
									LEFT OUTER JOIN TB_SM12D01 D ON(D.CO_CD=E.CO_CD AND D.ORDRG_NO=E.COST_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */	
									LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/				
								WHERE 1=1				
							UNION ALL
								SELECT E.CO_CD
									, E.RET_NO AS ORDRG_NO
									, NVL(E.SALES_CD, E.RET_NO) AS SALES_CD
									, E.PCHS_CLNT_CD				/* 구매처cd */
									,
									(
										SELECT D.CLNT_NM
											FROM TB_BM02M01 D
										WHERE E.PCHS_CLNT_CD=D.CLNT_CD
									) AS PCHS_CLNT_NM		/* 구매처명 */
									, E.IO_DIV AS MATR_CD
									, E.RET_DT AS ORDRG_DT			
									, R.DSGN_NO AS DSGN_NO							
									, 1 AS ORDRG_QTY				/*발주수량 */
									, R.RET_DTL_AMT AS ORDRG_AMT		/*발주 금액 */	
									, R.RET_DTL_AMT AS IN_DTL_AMT											
									, -(R.RET_DTL_AMT) AS IN_DTL_AMT_GRID											
									, NVL(D.PCHS_NO, 'PC'||TO_CHAR(SYSDATE, 'YY')||'00000') AS PCHS_NO	/*매입확정번호 */					
									, D.PCHS_NO AS PCHS_NO_GRID	/*매입확정번호 그리드용*/			 										
									, -(D.PCHS_AMT) AS PCHS_AMT		/* 매입금액  */
									, -(D.PCHS_VAT) AS PCHS_VAT		/* 부가세 */
									, D.PCHS_QTY			/* 수량 */	
									, D.PCHS_QTY AS CNT									
									, D.PCHS_DT
									, D.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
									, DECODE(D.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
									, 'R' IS_COST			/* 반품여부 */
									, '반품' IS_DIV			/* 구분 */
									, D.BILL_YN AS BILL_YN  /*계산서 여부*/
									, FILE_TRGT_KEY
									, BM2.CRN /*사업자등록번호*/
									, BM2.PCHS_CLMN_DAY  /*결제일 - 10*/	
									, BM2.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
									, BM2.PCHS_PMNT_MTD_CD  --결제조건 코드
								    , FN_CM05M01_CD_TO_NM(BM2.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
									FROM TB_SM06M01 E		/* 반품 */	
									INNER JOIN (SELECT SUM(RET_DTL_AMT) AS RET_DTL_AMT, MIN(DSGN_NO) AS DSGN_NO, RET_NO, CO_CD FROM TB_SM06D01 GROUP BY RET_NO, CO_CD ) R 
									ON R.CO_CD = E.CO_CD AND R.RET_NO = E.RET_NO	
									LEFT OUTER JOIN TB_SM12D01 D ON(D.CO_CD=E.CO_CD AND D.ORDRG_NO=E.RET_NO AND D.ORDRG_SEQ=1)	/* 매입 DETAIL */	
									LEFT OUTER JOIN TB_BM02M01 AS BM2  ON BM2.CLNT_CD = E.PCHS_CLNT_CD /*거래처 마스터*/
								WHERE 1=1										
						  ) A		/* 발주+기타비용+반품 내역 */
						  WHERE 1=1	
				<include refid="selectPurchaseListCondition"></include>	
				ORDER BY A.CO_CD, A.PCHS_CLNT_CD, A.ORDRG_NO, A.PCHS_NO
				) X
			)
			WHERE 1=1
			AND RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
		<!-- 매입확정관리 조회 리스트  조회조건 -->
	<sql id="selectPurchaseListCondition">

		<if test="coCd != null and !coCd.equals('')">
			AND A.CO_CD = #{coCd}   
		</if>
		<!-- 일자  -->
		<if test="closeYmFrom != null and !closeYmFrom.equals('') and closeYmTo != null and !closeYmTo.equals('')" >
			AND	A.PCHS_DT BETWEEN TO_DATE( #{closeYmFrom},'YYYYMMDD') AND TO_DATE( #{closeYmTo},'YYYYMMDD') --발주일자
		</if>
		<if test="pchsClmnDay != null and !pchsClmnDay.equals('')">
			AND A.PCHS_CLMN_DAY = #{pchsClmnDay}
		</if>																		
				
	</sql>	

	<!-- 구매현황 리스트 -->
	<select id="sm18_gridView_selectListNewNam" parameterType="Map" resultType="camelMap">
		WITH IPGO AS (
			SELECT    A.*
					, D1.CLNT_NM  AS PCHS_CLNT_NM
					, D1.CRN /*사업자등록번호*/
					, D1.PCHS_CLMN_DAY  /*결제일 - 10*/	
					, D1.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
					, D1.PCHS_PMNT_MTD_CD  --결제조건 코드
				    , FN_CM05M01_CD_TO_NM(D1.PCHS_PMNT_MTD_CD) AS PCHS_PMNT_MTD_NM /*결제조건명*/
			  FROM (
					SELECT A.* 
								, CASE WHEN substr(A.ORDRG_NO,0,3) = 'BAL' THEN 'N' 
								   	   WHEN substr(A.ORDRG_NO,0,3) = 'RET' THEN 'R' ELSE 'Y' END IS_COST
								, CASE WHEN substr(A.ORDRG_NO,0,3) = 'BAL' THEN '' 
								   	   WHEN substr(A.ORDRG_NO,0,3) = 'RET' THEN '' ELSE C.ORDRS_NO END ORDRS_NO --수주번호
								, CASE WHEN substr(A.ORDRG_NO,0,3) = 'BAL' THEN M.SALES_CD 
								   	   WHEN substr(A.ORDRG_NO,0,3) = 'RET' THEN RM.SALES_CD ELSE C.SALES_CD END SALES_CD
								, CASE WHEN substr(A.ORDRG_NO,0,3) = 'BAL' THEN M.PCHS_CLNT_CD 
								   	   WHEN substr(A.ORDRG_NO,0,3) = 'RET' THEN RM.PCHS_CLNT_CD ELSE C.PCHS_CLNT_CD END PCHS_CLNT_CD
								, CASE WHEN substr(A.ORDRG_NO,0,3) = 'BAL' THEN M.FILE_TRGT_KEY 
								   	   WHEN substr(A.ORDRG_NO,0,3) = 'RET' THEN RM.FILE_TRGT_KEY ELSE C.FILE_TRGT_KEY END FILE_TRGT_KEY
								, CASE WHEN substr(A.ORDRG_NO,0,3) = 'BAL' THEN '발주' 
								   	   WHEN substr(A.ORDRG_NO,0,3) = 'RET' THEN '반품' ELSE '비용' END IS_DIV
								, (SELECT FN_CM06M01_ID_TO_NM(A.CREAT_ID) FROM DUAL) AS CREAT_ID_NM
								
					FROM  TB_SM12D01 A /* 매입 확정 DETAIL */		
							LEFT OUTER JOIN TB_SM02M01 M ON(A.ORDRG_NO = M.ORDRG_NO)		/* 발주마스터 */
							LEFT OUTER JOIN TB_SM10M01 C ON(A.ORDRG_NO = C.COST_NO)			/* 비용마스터 */
							LEFT OUTER JOIN TB_SM06D01 R ON(A.ORDRG_NO = R.RET_NO)		/* 반품 상세 */
							LEFT OUTER JOIN TB_SM06M01 RM ON(RM.CO_CD = R.CO_CD AND RM.RET_NO = R.RET_NO)		/* 반품 상세 */
				  WHERE 1=1 
				    AND NVL(C.PAY_DIV,'PAYDIV02') = 'PAYDIV02'  --기타비용의 경우 청구(PAYDIV02)인 경우만 구매현황에 출력함.
				<!-- 회사코드 -->         
				<if test="coCd != null and !coCd.equals('')">
					AND A.CO_CD = #{coCd}   
				</if>	
				<!-- 일자  -->
				<if test="closeYmFrom != null and !closeYmFrom.equals('') and closeYmTo != null and !closeYmTo.equals('')" >
					AND	A.PCHS_DT BETWEEN #{closeYmFrom} AND #{closeYmTo} --발주일자
				</if>
				<!-- 구매처 -->         
				<if test="pchsClntCd != null and !pchsClntCd.equals('')">
					AND (M.PCHS_CLNT_CD = #{pchsClntCd} OR C.PCHS_CLNT_CD = #{pchsClntCd} OR RM.PCHS_CLNT_CD = #{pchsClntCd})  
				</if>       
				<!-- 매입구분 -->
				<if test="pchsGb != null and !pchsGb.equals('')">
					AND substr(D.ORDRG_NO,0,3) = #{pchsGb} /* 'BAL', 'RET', 'COS'*/
				</if>			
				) A
     									LEFT OUTER JOIN TB_BM02M01 D1 ON A.PCHS_CLNT_CD = D1.CLNT_CD   --거래처마스터
			 WHERE 1 = 1
			<if test="pchsClntNm != null and !pchsClntNm.equals('')">
				AND D1.CLNT_NM LIKE '%'||#{pchsClntNm}||'%'   
			</if>
			<if test="pchsClmnDay != null and !pchsClmnDay.equals('')">
				AND D1.PCHS_CLMN_DAY = #{pchsClmnDay}
			</if>				
		)
		,  IPGOAMT AS --입고집계
		(
 			 SELECT   CO_CD, ORDRG_NO
 			 	   , SUM(IN_QTY) AS IN_QTY
 			       , SUM(BAD_QTY) AS BAD_QTY
 			       , SUM(IN_DTL_AMT) AS IN_DTL_AMT 
				FROM  TB_SM03D01 A /* 입고 DETAIL */		
			  WHERE 1=1 
                   AND EXISTS (SELECT 1 FROM IPGO WHERE  IPGO.ORDRG_NO = A.ORDRG_NO)
			  GROUP BY CO_CD, ORDRG_NO
		)
		,  IPGOTOT AS --매입확정집계
		(
 			 SELECT   CO_CD, ORDRG_NO
 			 	   , SUM(PCHS_AMT) AS PCHS_AMT_TOT
 			       , SUM(PCHS_VAT) AS PCHS_VAT_TOT
 			       , SUM(PCHS_QTY) AS PCHS_QTY_TO --수량은 입고 건별 1로 불일치 발생
				FROM  TB_SM12D01 A /* 매입확정 DETAIL */		
			  WHERE 1=1 
                   AND EXISTS (SELECT 1 FROM IPGO WHERE  IPGO.ORDRG_NO = A.ORDRG_NO)
			  GROUP BY CO_CD, ORDRG_NO
		)
		,  BAL AS  --발주집계
		(
			SELECT A.CO_CD
					, A.ORDRG_NO
					, A.SALES_CD
					, SUM(A.ORDRG_QTY) ORDRG_QTY
					, SUM(A.ORDRG_AMT) ORDRG_AMT
					, MIN(A.DSGN_NO)   AS DSGN_NO
				FROM TB_SM02D01 A
                      WHERE 1=1
                        AND EXISTS (SELECT 1 FROM IPGO WHERE  IPGO.ORDRG_NO = A.ORDRG_NO)
                      GROUP BY A.CO_CD, A.ORDRG_NO, A.SALES_CD
		)
		,  QM AS 
		(
				SELECT 	DISTINCT  
						  M.CO_CD
						, M.ORDRG_NO
						, M.REQ_NO  --발행번호 REQ2300099
						, M.SALES_CD
						, Q.ORDRG_DT --발행일자
						, Q.PART_CD	--분류( 출도	 추가	 장애	 A/S유상	 A/S무상	 SPARE유상	 SPARE무상	 고객E/O	 설치시운전	 기타)
						, Q.ORDRG_ID	--발행자
				FROM TB_SM02M01 M
						LEFT OUTER JOIN TB_QM01M01 Q ON M.REQ_NO = Q.REQ_NO
	            WHERE 1=1
	              AND EXISTS (SELECT 1 FROM IPGO WHERE  IPGO.ORDRG_NO = M.ORDRG_NO)
		)
		SELECT T.*
		       , ROWNUM AS RN
		FROM  (
			SELECT A.CO_CD	
				, A.PCHS_NO			/* 매입번호 */
				, A.PCHS_SEQ
				, A.ORDRG_NO
				, A.DSGN_NO
				, A.SALES_CD
				, A.PCHS_CLNT_CD
				, A.PCHS_CLNT_NM		/* 구매처명 */
				, A.MATR_CD
				, A.ORDRG_QTY
				, A.ORDRG_AMT	
				, A.ORDRG_DT
				, A.DSGN_NO			/* 대표도번 */	
				, A.PCHS_AMT
				, A.PCHS_VAT		/* 부가세 */
				, A.PCHS_QTY			/* 수량 */
				, NVL(A.PCHS_AMT, 0) + NVL(A.PCHS_VAT, 0) AS PCHS_SUM_AMT			/* 합계금액 */
				, A.PCHS_AMT_TOT
				, A.PCHS_VAT_TOT
				, A.IN_DTL_AMT - A.PCHS_AMT_TOT AS REMAIN_AMT												
				, TO_CHAR(A.PCHS_DT, 'YYYY-MM-DD') AS PCHS_DT
				, A.CMPLET_YN
				, A.IS_COST
				, A.BILL_YN   /*계산서 여부*/
				, A.FILE_TRGT_KEY
				, A.CREAT_ID_NM
				, A.PCHS_SEQ
				, A.CRN /*사업자등록번호*/
				, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
				, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
				, A.PCHS_PMNT_MTD_CD  --결제조건 코드
				, A.PCHS_PMNT_MTD_NM  --결제조건 코드
				, A.IS_DIV
				, DECODE(substr(A.ORDRG_NO,0,3),'BAL', A.IN_DTL_AMT, A.PCHS_AMT_TOT) IN_DTL_AMT --입고금액계
				, A.REQ_NO		--발주요청서 번호
				, A.REQ_ORDRG_DT	--발주요청서 발행일자
				, A.PART_CD						--발주요청서 분류코드
				, A.PART_CD_NM
				, A.REQ_ORDRG_ID		---발주요청서 발행자ID
				, A.ORDRG_ID_NM
			  FROM
			  (
					SELECT 
						  A.CO_CD
							, A.ORDRG_NO
							, A.SALES_CD
							, A.PCHS_CLNT_CD
							, A.PCHS_CLNT_NM
							, '' AS MATR_CD --자재명 없음
							, A.PCHS_DT AS ORDRG_DT									
							, D.DSGN_NO  AS DSGN_NO			/* 도번 MIN */	
							, E.PCHS_AMT_TOT
							, E.PCHS_VAT_TOT		
							, D.ORDRG_QTY AS ORDRG_QTY				/*발주수량 */
							, D.ORDRG_AMT AS ORDRG_AMT		/*발주 금액 */		
							, F.IN_DTL_AMT - E.PCHS_AMT_TOT AS REMAIN_AMT										
							, A.PCHS_NO   AS PCHS_NO		/*매입확정번호 */					
							, A.PCHS_AMT  AS PCHS_AMT		/* 매입금액 */
							, A.PCHS_VAT AS PCHS_VAT		/* 부가세 */
							, A.PCHS_QTY AS PCHS_QTY		/* 수량  --> 매입확정시 무조건 1로 입력됨 의미없음*/										
							, A.PCHS_DT
							, A.CMPLET_YN AS CMPLET_YN	 		/* 확정여부 */
							, DECODE(A.CMPLET_YN, 'Y', 'Y', 'N') AS USER_CHK_V		/* DETAIL로 변경 */
							, A.IS_COST AS  IS_COST			/* 기타비용여부 */
							, A.BILL_YN AS BILL_YN  /*계산서 여부*/
							, A.FILE_TRGT_KEY
							, A.PCHS_SEQ
							, A.CREAT_ID_NM
							, A.CRN /*사업자등록번호*/
							, A.PCHS_CLMN_DAY  /*결제일 - 10*/	
							, A.PCHS_CLMN_RMK  /*결제일 - 다음달 10일*/
							, A.PCHS_PMNT_MTD_CD  --결제조건 코드
							, A.PCHS_PMNT_MTD_NM  --결제조건 코드
							, A.IS_DIV
							, F.IN_DTL_AMT  --입고금액계
							, Q.REQ_NO		--발주요청서 번호
							, Q.ORDRG_DT  	AS REQ_ORDRG_DT	--발주요청서 발행일자
							, Q.PART_CD						--발주요청서 분류코드
							, FN_CM05M01_CD_TO_NM(Q.PART_CD) AS PART_CD_NM
							, Q.ORDRG_ID 	AS REQ_ORDRG_ID		---발주요청서 발행자ID
							, FN_CM06M01_ID_TO_NM(Q.ORDRG_ID) AS ORDRG_ID_NM
					FROM  IPGO A /* 매입 확정 DETAIL */		
			                LEFT OUTER JOIN BAL AS D ON A.CO_CD = D.CO_CD AND A.ORDRG_NO = D.ORDRG_NO --발주상세
			                LEFT OUTER JOIN IPGOTOT AS E ON A.CO_CD = E.CO_CD AND A.ORDRG_NO = E.ORDRG_NO --매입확정집계
			                LEFT OUTER JOIN IPGOAMT AS F ON A.CO_CD = F.CO_CD AND A.ORDRG_NO = F.ORDRG_NO --입고 집계
			                LEFT OUTER JOIN QM AS Q ON A.CO_CD = Q.CO_CD AND A.ORDRG_NO = Q.ORDRG_NO --발주요청
				  WHERE 1=1 										
			  ) A		/* 발주+기타비용 내역 */
			  WHERE 1=1 
			<if test="salesCd != null and !salesCd.equals('')">
				AND A.SALES_CD LIKE '%'|| #{salesCd} || '%'   
			</if>		
			<if test="prjctCdNm != null and !prjctCdNm.equals('')">
				AND UPPER(CLNT_PJT_NM) LIKE '%'|| UPPER(#{prjctCdNm}) || '%'   
			</if>	
			  ORDER BY A.CO_CD, A.PCHS_CLNT_NM, A.PCHS_DT, A.ORDRG_NO, A.PCHS_NO
		) T
	</select>
</mapper>