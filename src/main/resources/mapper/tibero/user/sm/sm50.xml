<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm50.mapper.SM50Mapper">
	
	<select id="selectBomCostTreeList" parameterType="Map" resultType="CamelMap">
		WITH PCHS_BOM AS (
		     SELECT D.CO_CD, D.SALES_CD, D.UPPER_CD, COUNT(*) AS PCHS_BOM_CNT
		       FROM BOM_TEMP D
		     WHERE 1 = 1
			   AND D.CO_CD    = #{coCd}
			   AND D.SALES_CD = #{salesCd}
		     GROUP BY D.CO_CD, D.SALES_CD, D.UPPER_CD
		)
		SELECT
	         decode(T.UPPER_CD,'top','#',T.UPPER_CD) as PARENT,
	         T.LOWER_CD ID, 
	         T.UPPER_CD,
	         T.LOWER_CD,
	         <![CDATA[CASE WHEN NVL(D.PCHS_BOM_CNT, 0) > 0 THEN '<span style=''color: red;''>' || T.LOWER_NM || '(' || MATR_NM || ') x ' || T.BOM_QTY || '</span>'
	         								  ELSE T.LOWER_NM || '(' || MATR_NM || ') x ' || T.BOM_QTY END  
	         								  || '[' || TO_CHAR(STD_AMT+BAD_AMT,'FM999,999,999,999') ||']' AS TEXT, 
	         ]]>
	         (LEVEL-1)  LVL,
	         T.DSGN_NO,
	         CASE WHEN CONNECT_BY_ISLEAF = 1 THEN 'leaf' ELSE 'unit' END AS TYPE,
	         REGEXP_REPLACE(SYS_CONNECT_BY_PATH(T.LOWER_CD, ' -> '), '^\s+\-\>\s+', '') as PATH,
	         T.CO_CD,
	         T.SALES_CD,
	         T.MATR_NM,
	         T.BOM_QTY,
			 T.MATR_SPEC,
			 T.MATR_SIZE,
			 T.MATR_MAT,
			 T.MATR_RMK,
	         T.UPPER_NM,
	         T.LOWER_NM,
--	         T.FILE_TRGT_KEY,
	         T.ORDRS_NO,
			 NVL(D.PCHS_BOM_CNT, 0) AS PCHS_BOM_CNT
	     FROM BOM_TEMP T
			  				LEFT OUTER JOIN  PCHS_BOM   AS D   ON T.CO_CD  = D.CO_CD
			  				                                  AND T.SALES_CD  = D.SALES_CD
			  				                                  AND T.LOWER_CD  = D.UPPER_CD
	     WHERE T.SALES_CD = #{salesCd}
	       AND T.CO_CD = #{coCd}	 
		     START WITH T.LOWER_CD =  ( SELECT LOWER_CD 
							              FROM BOM_TEMP T		     
									     WHERE T.UPPER_CD = 'top'
									       AND T.CO_CD    = #{coCd}
										   AND T.LOWER_NM = #{salesCd}	)
		     CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
		     ORDER BY LOWER_NM  
	</select>
	
	<select id="selectBomSeqNext" parameterType="Map" resultType="int">
			SELECT TB_BM14M01_SQ01.NEXTVAL  FROM DUAL 
	</select>

	<!-- 삭제 체크 -->
	<select id="deleteMatrbomChk" parameterType="Map" resultType="camelMap">
		SELECT FN_BM14M01_DEL_CHK(#{coCd}, #{salesCd}, #{upperKey}, #{lowerKey}) AS DELYN
		FROM   DUAL
	</select>
	
    <insert id="insertBomTree" parameterType="Map">
        INSERT INTO TB_BM14M01
			(
			   CO_CD
			 , SALES_CD
			 , UPPER_KEY
			 , LOWER_KEY
			 , UPPER_CD
			 , LOWER_CD
			 , DSGN_NO
			 , BOM_SEQ
			 , PART_NO
			 , UNIT_NO
			 , REV_NO
			 , MATR_SEQ
			 , MATR_CD
			 , MATR_NM
			 , MATR_MAT
			 , MATR_MAKR_NM
			 , MATR_MNO
			 , MATR_SPEC
			 , MATR_RMK
			 , AVLB_STRT_DT
			 , AVLB_END_DT
			 , USE_YN
			 , MATR_YN
			 , ETC_FIELD1
			 , ETC_FIELD2
			 , ETC_FIELD3
			 , CREAT_ID
			 , CREAT_PGM
			 , CREAT_DTTM
			 , FILE_TRGT_KEY
			 , LOWER_QTY
			 , LOWER_UNIT
			 , MATR_UNIT_CD
			 , ORDRS_NO
			)
        VALUES
			(
			   #{coCd}
			 , #{salesCd}
			 , #{upperKey}
			 , #{fileTrgtKey}
			 , #{upperCd}
			 , #{lowerCd}
			 , #{dsgnNo}
			 , #{bomSeq, jdbcType=VARCHAR}
			 , #{partNo, jdbcType=VARCHAR}
			 , #{unitNo, jdbcType=VARCHAR}
			 , #{revNo, jdbcType=VARCHAR}
			 , #{matrSeq, jdbcType=VARCHAR}
			 , #{matrCd, jdbcType=VARCHAR}
			 , #{matrNm, jdbcType=VARCHAR}
			 , #{matrMat, jdbcType=VARCHAR}
			 , #{matrMakrNm, jdbcType=VARCHAR}
			 , #{matrMno, jdbcType=VARCHAR}
			 , #{matrSpec, jdbcType=VARCHAR}
			 , #{matrRmk, jdbcType=VARCHAR}
			 , #{avlbStrtDt, jdbcType=VARCHAR}
			 , #{avlbEndDt, jdbcType=VARCHAR}
			 , #{useYn, jdbcType=VARCHAR}
			 , #{matrYn, jdbcType=VARCHAR}
			 , #{etcField1, jdbcType=VARCHAR}
			 , #{etcField2, jdbcType=VARCHAR}
			 , #{etcField3, jdbcType=VARCHAR}
			 , #{userId}
			 , #{pgmId}
			 , SYSDATE
			 , #{fileTrgtKey}
			 , #{lowerQty, jdbcType=VARCHAR}
			 , #{lowerUnit, jdbcType=VARCHAR}
			 , #{matrUnitCd, jdbcType=VARCHAR}
			 , #{ordrsNo, jdbcType=VARCHAR}
			)
	</insert>

    <update id="updateBom" parameterType="Map">
        UPDATE TB_BM14M01
        SET   
				  DSGN_NO			= #{dsgnNo}
				, LOWER_CD			= #{lowerCd, jdbcType=VARCHAR}
				, BOM_SEQ			= #{bomSeq, jdbcType=VARCHAR}
				, PART_NO			= #{partNo, jdbcType=VARCHAR}
				, UNIT_NO			= #{unitNo, jdbcType=VARCHAR}
				, REV_NO			= #{revNo, jdbcType=VARCHAR}
				, MATR_SEQ			= #{matrSeq, jdbcType=VARCHAR}
				, MATR_CD			= #{matrCd, jdbcType=VARCHAR}
				, MATR_NM			= #{matrNm, jdbcType=VARCHAR}
				, MATR_MAT			= #{matrMat, jdbcType=VARCHAR}
				, MATR_MAKR_NM		= #{matrMakrNm, jdbcType=VARCHAR}
				, MATR_MNO			= #{matrMno, jdbcType=VARCHAR}
				, MATR_SPEC			= #{matrSpec, jdbcType=VARCHAR}
				, MATR_RMK			= #{matrRmk, jdbcType=VARCHAR}
				, AVLB_STRT_DT		= #{avlbStrtDt, jdbcType=VARCHAR}
				, AVLB_END_DT		= #{avlbEndDt, jdbcType=VARCHAR}
				, USE_YN			= #{useYn, jdbcType=VARCHAR}
				, MATR_YN			= #{matrYn, jdbcType=VARCHAR}
				, ETC_FIELD1		= #{etcField1, jdbcType=VARCHAR}
				, ETC_FIELD2		= #{etcField2, jdbcType=VARCHAR}
				, ETC_FIELD3		= #{etcField3, jdbcType=VARCHAR}
				, UDT_ID			= #{userId}
				, UDT_PGM			= #{pgmId}
				, UDT_DTTM			= SYSDATE
				, LOWER_QTY			= #{lowerQty}
				, LOWER_UNIT			= #{lowerUnit}
				, MATR_UNIT_CD		= #{matrUnitCd, jdbcType=VARCHAR}
				, ORDRS_NO		= #{ordrsNo, jdbcType=VARCHAR}
        WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </update>

	<delete id="deleteBom" parameterType="Map">
	  DELETE TB_BM14M01
	   WHERE FILE_TRGT_KEY IN (
				SELECT FILE_TRGT_KEY 
				  FROM TB_BM14M01 T
				 WHERE T.SALES_CD = #{salesCd}
				   AND T.CO_CD    = #{coCd}	 
				 START WITH T.LOWER_KEY =  #{fileTrgtKey}	
			     CONNECT BY PRIOR T.LOWER_KEY = T.UPPER_KEY
		     )
	    AND UPPER_KEY <![CDATA[<>]]> '#'
	</delete>

	
	<update id="moveBom">
		UPDATE
			TB_BM14M01
		SET
			UPPER_KEY	= #{upDeptId},
			UPPER_CD	= #{upperCd},
			UDT_ID		= #{userId},
			UDT_PGM		= #{pgmId},
			UDT_DTTM	= SYSDATE
		WHERE
			FILE_TRGT_KEY = #{deptId}
	</update>
		
<!--     <insert id="copyBomTree" parameterType="Map"> -->
<!-- 		INSERT INTO TB_BM14M01  -->
<!-- 			(CO_CD, SALES_CD, UPPER_KEY, LOWER_KEY, UPPER_CD, LOWER_CD, DSGN_NO,  -->
<!-- 			BOM_SEQ, PART_NO, UNIT_NO, REV_NO, MATR_SEQ, MATR_CD, MATR_NM, MATR_MAT,  -->
<!-- 			MATR_MAKR_NM, MATR_MNO, MATR_SPEC, MATR_RMK, AVLB_STRT_DT, AVLB_END_DT,  -->
<!-- 			USE_YN, MATR_YN, ETC_FIELD1, ETC_FIELD2, ETC_FIELD3, CREAT_ID, CREAT_PGM,  -->
<!-- 			CREAT_DTTM, UDT_ID, UDT_PGM, UDT_DTTM, LOWER_QTY, LOWER_UNIT, MATR_UNIT_CD, FILE_TRGT_KEY) -->
<!-- 			SELECT   -->
<!-- 			        CO_CD, SALES_CD, #{upperKey}, #{fileTrgtKey} LOWER_KEY, UPPER_CD, LOWER_CD, DSGN_NO,  -->
<!-- 			        BOM_SEQ, PART_NO, UNIT_NO, REV_NO, MATR_SEQ, MATR_CD, MATR_NM, MATR_MAT, -->
<!-- 			        MATR_MAKR_NM, MATR_MNO, MATR_SPEC, MATR_RMK, AVLB_STRT_DT, AVLB_END_DT,  -->
<!-- 			        USE_YN, MATR_YN, ETC_FIELD1, ETC_FIELD2, ETC_FIELD3, CREAT_ID, CREAT_PGM,  -->
<!-- 			        CREAT_DTTM, UDT_ID, UDT_PGM, UDT_DTTM, LOWER_QTY, LOWER_UNIT, MATR_UNIT_CD, #{fileTrgtKey} -->
<!-- 			FROM TB_BM14M01 -->
<!-- 			WHERE -->
<!-- 				FILE_TRGT_KEY = #{lowerKey} -->
<!-- 	</insert>	 -->
		
    <insert id="copyBomTree" parameterType="Map">
		INSERT INTO TB_BM14M01 
			(CO_CD, 
			SALES_CD, 
			UPPER_KEY, 
			LOWER_KEY, 
			UPPER_CD, LOWER_CD, 
			DSGN_NO, 
			BOM_SEQ, PART_NO, UNIT_NO, REV_NO, MATR_SEQ, MATR_CD, MATR_NM, MATR_MAT, 
			MATR_MAKR_NM, MATR_MNO, MATR_SPEC, MATR_RMK, AVLB_STRT_DT, AVLB_END_DT, 
			USE_YN, MATR_YN, ETC_FIELD1, ETC_FIELD2, ETC_FIELD3, CREAT_ID, CREAT_PGM, 
			CREAT_DTTM, UDT_ID, UDT_PGM, UDT_DTTM, LOWER_QTY, LOWER_UNIT, MATR_UNIT_CD, FILE_TRGT_KEY, ORDRS_NO)
			SELECT  
			        CO_CD, 
			        REPLACE(SALES_CD, #{salesCd}, #{salesCdTo}) SALES_CD, 
			        #{upperKey}, 
			        #{fileTrgtKey} LOWER_KEY, 
			        REPLACE(UPPER_CD, #{salesCd}, #{salesCdTo}) UPPER_CD, LOWER_CD, 
			        CASE WHEN #{changeYn} = 'Y' THEN REPLACE(DSGN_NO, #{salesCd}, #{salesCdTo}) ELSE DSGN_NO END DSGN_NO, 
			        BOM_SEQ, PART_NO, UNIT_NO, REV_NO, MATR_SEQ, MATR_CD, MATR_NM, MATR_MAT,
			        MATR_MAKR_NM, MATR_MNO, MATR_SPEC, MATR_RMK, AVLB_STRT_DT, AVLB_END_DT, 
			        USE_YN, MATR_YN, ETC_FIELD1, ETC_FIELD2, ETC_FIELD3, #{userId} CREAT_ID, #{pgmId} CREAT_PGM, 
			        SYSDATE CREAT_DTTM, '' UDT_ID, '' UDT_PGM, '' UDT_DTTM, LOWER_QTY, LOWER_UNIT, MATR_UNIT_CD, #{fileTrgtKey}, ORDRS_NO
			FROM TB_BM14M01
			WHERE
				FILE_TRGT_KEY = #{lowerKey}		
	</insert>
	
	<select id="selectBomlevelList" parameterType="Map" resultType="CamelMap">
		WITH PCHS_BOM AS (
		     SELECT D.CO_CD, D.SALES_CD, D.UPPER_CD, COUNT(*) AS PCHS_BOM_CNT
		       FROM TB_SM01D01 D
		     WHERE 1 = 1
			   AND D.CO_CD    = #{coCd}
			   AND D.SALES_CD = #{salesCd}
		     GROUP BY D.CO_CD, D.SALES_CD, D.UPPER_CD
		)
		SELECT TO_CHAR(T.AVLB_STRT_DT, 'YYYY-MM-DD') AS AVLB_STRT_DT
		     , TO_CHAR(T.AVLB_END_DT, 'YYYY-MM-DD') AS AVLB_END_DT
			 , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
			 , T.*
			 , FN_CM05M01_CD_TO_NM(T.MATR_UNIT_CD) MATR_UNIT_CD_NM
			 , NVL(C.CHANGE_YN, 'N') AS CHANGE_YN
			 , NVL(D.PCHS_BOM_CNT, 0) AS PCHS_BOM_CNT
			 , 'Y'  					AS MATR_ERROR --자재마스터 검증완료여부
		FROM   TB_BM14M01 AS T
		       LEFT OUTER JOIN TB_BM14M01_COMPARE AS C  ON T.CO_CD = C.CO_CD
			                                           AND T.SALES_CD = C.SALES_CD
													   AND T.UPPER_KEY = C.UPPER_KEY
													   AND T.LOWER_KEY = C.LOWER_KEY
				LEFT OUTER JOIN  PCHS_BOM   AS D   ON T.CO_CD  = D.CO_CD
				                                  AND T.SALES_CD  = D.SALES_CD
				                                  AND T.LOWER_KEY  = D.UPPER_CD
		WHERE  T.SALES_CD = #{salesCd}
		AND    T.CO_CD    = #{coCd}
		AND    T.UPPER_KEY  = #{upperKey}
		ORDER BY T.LOWER_CD
	</select>
	
	<select id="checkBomInfo" parameterType="Map" resultType="int">
			SELECT count(FILE_TRGT_KEY) 
			  FROM TB_BM14M01 T
			 WHERE  T.CO_CD     = #{coCd}
			   AND 	T.SALES_CD	= #{salesCdTo}
<!-- 			   AND 	UPPER_KEY   <![CDATA[<>]]> '#' -->
	</select>	
	
	
	<select id="selectBomRootSalesCdTree" parameterType="Map" resultType="CamelMap">
			SELECT * 
			  FROM TB_BM14M01 T
			 WHERE  T.CO_CD     = #{coCd}
			   AND 	T.SALES_CD	= #{salesCd}
			   AND 	T.UPPER_KEY	= '#' --SalesCd Root 구분자가 #임
	</select>	
	
	<select id="selectBomInfo" parameterType="Map" resultType="CamelMap">
			SELECT * 
			  FROM TB_BM14M01 T
			 WHERE  T.FILE_TRGT_KEY	= #{fileTrgtKey}	 
	</select>	
	

	<select id="selectBomAllCostList" parameterType="Map" resultType="CamelMap">
	/* selectBomAllCostList */
			SELECT 	CASE WHEN T.LOWER_CD = #{fileTrgtKey} THEN '' ELSE T.UPPER_CD END PID  
				   , T.LOWER_CD ID 
				   , decode(T.BOM_TYPE,'M',T.MATR_CD, T.LOWER_NM) VIEW_ID 	   
				   --, (LEVEL-1)  LVL
				   , REGEXP_REPLACE(SYS_CONNECT_BY_PATH('', '.'), '^\s+\-\>\s+', '.')|| (LEVEL-1) as LVL
				   , REGEXP_REPLACE(SYS_CONNECT_BY_PATH(T.LOWER_NM, ' -> '), '^\s+\-\>\s+', '') as PATH
				   , FN_CM05M01_CD_TO_NM(M.MATR_UNIT) MATR_UNIT_CD_NM
			       , M.MATR_WT
			       , M.MATR_UPR   --최종구매단가
			       , M.MATR_AVRG_UPR  --평균구매단가
			       , TO_CHAR(M.MATR_LAST_TRST_DT,'YYYY-MM-DD') MATR_LAST_TRST_DT  --최종거래일자
			       , M.MATR_UPR * T.BOM_QTY AS PART_AMT
			       , DECODE(T.BOM_TYPE, 'M', M.MATR_MAT, T.MATR_MAT)  	AS MATR_MAT
			       , DECODE(T.BOM_TYPE, 'M', M.MATR_SPEC, T.MATR_SPEC)  AS MATR_SPEC
			       , DECODE(T.BOM_TYPE, 'M', M.MATR_SIZE, T.MATR_SIZE)  AS MATR_SIZE
			       , DECODE(T.BOM_TYPE, 'M', M.MATR_RMK, T.MATR_RMK)   	AS MATR_RMK
			       , T.*
			       , C.CLNT_NM
			  FROM BOM_TEMP T
			  				LEFT OUTER JOIN TB_BM05M01 AS M   ON T.MATR_CD  = M.MATR_CD 
			  				LEFT OUTER JOIN BOM_TEMP   AS B   ON T.UPPER_CD = B.LOWER_CD
							LEFT OUTER JOIN TB_BM02M01 C      ON T.PCHS_CLNT_CD = C.CLNT_CD
			 WHERE T.SALES_CD = #{salesCd}
			   AND T.CO_CD    = #{coCd}		 
              <if test="bomLevel !=null and !bomLevel.equals('')">
			   AND (LEVEL-1) <![CDATA[ <= ]]> #{bomLevel}	 
              </if>
			 START WITH T.LOWER_CD =  #{fileTrgtKey}	
		     CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
		     ORDER BY PATH
	</select>	
	
	
	<select id="selectBomTrgtPchsPcostInfo" parameterType="Map" resultType="CamelMap">
			SELECT * 
			  FROM BOM_TEMP T
			 WHERE T.SALES_CD = #{salesCd}
			   AND T.CO_CD    = #{coCd}	  
			   AND T.UPPER_CD = 'top'	  
	</select>			
	
	<select id="selectBomAllEnterListCount" parameterType="Map" resultType="int">
	/* selectBomAllEnterListCount */
				SELECT 	count(*)
			       FROM
						(SELECT CO_CD, SALES_CD, LOWER_KEY, LOWER_CD, DSGN_NO, min(MATR_NM) MATR_NM, min(MATR_RMK) MATR_RMK
					              FROM TB_BM14M01 T		     
							     WHERE T.UPPER_CD = '#'
								<if test="coCd != null and !coCd.equals('')">
								   AND T.CO_CD   = #{coCd}
								</if>
								<if test="salesCd != null and !salesCd.equals('')">
								   AND T.SALES_CD  LIKE  '%'||#{salesCd}||'%'
								</if>
							     GROUP BY CO_CD, SALES_CD, LOWER_KEY, LOWER_CD, DSGN_NO
						) AS MST 
							     INNER JOIN (
							     				SELECT CO_CD, SALES_CD, count(LOWER_KEY) - 1 AS BOM_CNT
									              FROM TB_BM14M01 T
									             WHERE 1=1	
												<if test="coCd != null and !coCd.equals('')">
												   AND T.CO_CD   = #{coCd}
												</if>
												<if test="salesCd != null and !salesCd.equals('')">
												   AND T.SALES_CD  LIKE  '%'||#{salesCd}||'%'
												</if>
											     GROUP BY CO_CD, SALES_CD
							     			) AS DTL  ON MST.CO_CD      =  DTL.CO_CD
							     			         AND MST.SALES_CD   =  DTL.SALES_CD
						     LEFT OUTER JOIN TB_CR02D02 CD  ON MST.CO_CD      =  CD.CO_CD
						     			        	       AND MST.SALES_CD   =  CD.SALES_CD
						     LEFT OUTER JOIN TB_CR02M01 CM  ON MST.CO_CD      =  CM.CO_CD
						     			        	       AND CD.ORDRS_NO    =  CM.ORDRS_NO
						 	 LEFT OUTER JOIN TB_BM02M01  B  ON CM.ORDRS_CLNT_CD     =  B.CLNT_CD
				WHERE 1=1
					<if test="clntCd != null and !clntCd.equals('')">
					   AND CM.ORDRS_CLNT_CD   = #{clntCd}
					</if>
					<if test="clntNm != null and !clntNm.equals('')">
					   AND B.CLNT_NM   LIKE  '%'||#{clntNm}||'%'
					</if>
	</select>
	
	<select id="selectBomAllEnterList" parameterType="Map" resultType="CamelMap">
	/* selectBomAllEnterList */
		SELECT *
		  FROM
			(SELECT T.*
				     , ROWNUM AS RN 
			  FROM
				(SELECT 	MST.*, 
				     		FN_CM05M01_CD_TO_NM(MST.CO_CD)  CO_CD_NM,
				     		CD.ORDRS_NO,
				     		CD.EQP_NM,
				     		CD.ORDRS_DTL_DIV10, 
				     		FN_CM05M01_CD_TO_NM(CD.ORDRS_DTL_DIV10)  ORDRS_DTL_DIV10_NM,
				     		CD.PRDT_CD,
				     		FN_BM01M01_ID_TO_NM(CD.PRDT_CD) PRDT_CD_NM,
				     		CD.ITEM_DIV, 
				     		FN_CM05M01_CD_TO_NM(CD.ITEM_DIV)  ITEM_DIV_NM,
				     		CD.ORDRS_DTL_DIV20, 
				     		FN_CM05M01_CD_TO_NM(CD.ORDRS_DTL_DIV20)  ORDRS_DTL_DIV20_NM,
				     		CD.ORDRS_DTL_DIV30,
				     		FN_CM05M01_CD_TO_NM(CD.ORDRS_DTL_DIV30)  ORDRS_DTL_DIV30_NM,
				     		CM.ORDRS_CLNT_CD,
				     		B.CLNT_NM,
				     		FN_CM05M01_CD_TO_NM(CM.ORDRS_CLNT_CD)  ORDRS_CLNT_CD_NM,
				     		CM.CLNT_PJT,
				     		FN_CM05M01_CD_TO_NM(CM.CLNT_PJT)  CLNT_PJT_NM,
				     		CM.CTRT_NM,
				     		DTL.BOM_CNT
			       FROM
						(SELECT CO_CD, SALES_CD, LOWER_KEY, LOWER_CD, DSGN_NO, min(MATR_NM) MATR_NM, min(MATR_RMK) MATR_RMK
					              FROM TB_BM14M01 T		     
							     WHERE T.UPPER_CD = '#'
								<if test="coCd != null and !coCd.equals('')">
								   AND T.CO_CD   = #{coCd}
								</if>
								<if test="salesCd != null and !salesCd.equals('')">
												   AND T.SALES_CD  LIKE  '%'||#{salesCd}||'%'
								</if>
							     GROUP BY CO_CD, SALES_CD, LOWER_KEY, LOWER_CD, DSGN_NO
						) AS MST 
							     INNER JOIN (
							     				SELECT CO_CD, SALES_CD, count(LOWER_KEY) - 1 AS BOM_CNT
									              FROM TB_BM14M01 T
									             WHERE 1=1	
												<if test="coCd != null and !coCd.equals('')">
												   AND T.CO_CD   = #{coCd}
												</if>
												<if test="salesCd != null and !salesCd.equals('')">
												   AND T.SALES_CD  LIKE  '%'||#{salesCd}||'%'
												</if>
											     GROUP BY CO_CD, SALES_CD
							     			) AS DTL  ON MST.CO_CD      =  DTL.CO_CD
							     			         AND MST.SALES_CD   =  DTL.SALES_CD
						     LEFT OUTER JOIN TB_CR02D02 CD  ON MST.CO_CD      =  CD.CO_CD
						     			        	       AND MST.SALES_CD   =  CD.SALES_CD
						     LEFT OUTER JOIN TB_CR02M01 CM  ON MST.CO_CD      =  CM.CO_CD
						     			        	       AND CD.ORDRS_NO    =  CM.ORDRS_NO
						 	 LEFT OUTER JOIN TB_BM02M01  B  ON CM.ORDRS_CLNT_CD     =  B.CLNT_CD
				WHERE 1=1
					<if test="clntCd != null and !clntCd.equals('')">
					   AND CM.ORDRS_CLNT_CD   = #{clntCd}
					</if>
					<if test="clntNm != null and !clntNm.equals('')">
					   AND B.CLNT_NM   LIKE  '%'||#{clntNm}||'%'
					</if>
				) T
				ORDER BY CO_CD, CLNT_NM, CLNT_PJT_NM, SALES_CD, DSGN_NO
			) T
		WHERE  RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>	
	
	<select id="selectBomAllLevelTempList" parameterType="Map" resultType="CamelMap">
	/* selectBomAllLevelTempList */
				SELECT 	CASE WHEN T.LOWER_KEY = (SELECT LOWER_KEY FROM TB_BM14M01_TMP WHERE SALES_CD = T.SALES_CD AND CO_CD = T.CO_CD AND UPPER_CD = '#') THEN '' ELSE T.UPPER_KEY END PID,  
					T.LOWER_KEY ID ,
					(LEVEL-1)  LVL,
					REGEXP_REPLACE(SYS_CONNECT_BY_PATH(T.LOWER_CD, ' -> '), '^\s+\-\>\s+', '') as PATH,
					FN_CM05M01_CD_TO_NM(T.MATR_UNIT_CD) MATR_UNIT_CD_NM,
					T.* 
			       , M.MATR_WT
			       , M.MATR_UPR   --최종구매단가
			       , M.MATR_AVRG_UPR  --평균구매단가
			       , M.MATR_LAST_TRST_DT  --최종거래일자
			       , M.MATR_UPR * T.LOWER_QTY AS PART_AMT
			  FROM TB_BM14M01_TMP T
			  				LEFT OUTER JOIN  TB_BM05M01 AS M   ON T.MATR_CD  = M.MATR_CD 
			 WHERE T.SALES_CD = #{salesCd, jdbcType=VARCHAR}
			   AND T.CO_CD    = #{coCd, jdbcType=VARCHAR}	 
			 START WITH T.LOWER_KEY =  (SELECT LOWER_KEY FROM TB_BM14M01_TMP WHERE SALES_CD = T.SALES_CD AND CO_CD = T.CO_CD AND UPPER_CD = '#')
		     CONNECT BY PRIOR T.LOWER_KEY = T.UPPER_KEY
		     ORDER BY PATH
	</select>
	
	
	<select id="callBomTempUpd" statementType="CALLABLE" parameterType="map">
	/* callBomTempUpd */
        {call SP_BOM_TEMP_UPD(
	        #{coCd      , mode=IN, jdbcType=VARCHAR},
	        #{ordrsNo   , mode=IN, jdbcType=VARCHAR},
	        #{salesCd   , mode=IN, jdbcType=VARCHAR},
	        #{userId    , mode=IN, jdbcType=VARCHAR},
	        #{errMsg    , mode=OUT, jdbcType=VARCHAR}
	    )}
    </select>
    
	<update id="insertUpdateBomRemark" parameterType="Map">
		MERGE INTO TB_WB25M01 A
			USING DUAL
			ON (
					SALES_CD 	= #{salesCd}
			   )
		WHEN MATCHED THEN
			UPDATE SET
					  BOM_REMARK        = #{bomRemark}
					, CO_CD				= #{coCd}
					, UDT_ID			= #{userId}
					, UDT_DTTM			= SYSDATE
					, UDT_PGM			= #{pgmId}
		WHEN NOT MATCHED THEN
			<selectKey keyProperty="fileTrgtKey" resultType="String" order="BEFORE">
				SELECT 'BOM' || TO_CHAR(SYSDATE,'YY') ||
					LPAD( TO_CHAR( NVL(MAX(TO_NUMBER(SUBSTR(FILE_TRGT_KEY,6,4))),0) + 1 ), 4, '0') AS FILE_TRGT_KEY
				FROM TB_WB25M01
				WHERE SUBSTR(FILE_TRGT_KEY,1,5) = 'BOM' || TO_CHAR(SYSDATE,'YY')
			</selectKey>
			INSERT
			(
				  FILE_TRGT_KEY
				, SALES_CD
				, BOM_REMARK
				, EVL_ID
				, EVL_DT
				, CO_CD
				, CREAT_ID
				, CREAT_DTTM
				, CREAT_PGM
			)
			VALUES
			(
				  #{fileTrgtKey}
				, #{salesCd}
				, #{bomRemark}
				, #{userId}
				, SYSDATE
				, #{coCd}
				, #{userId}
				, SYSDATE
				, #{pgmId}
			)
	</update>

	<select id="selectSalesCdSearchSm50Info" parameterType="map" resultType="CamelMap">
     SELECT   T.*
            , ORDRS_CLNT_CD
            , ORDRS_DT
            , ORDRS_DIV
            , FN_CM05M01_CD_TO_NM(ORDRS_DIV) 	AS ORDRS_DIV_NM
            , (SELECT PRDT_NM FROM TB_BM01M01 A WHERE A.PRDT_CD = T.PRDT_CD) AS PRDT_CD_NM
            , FN_CM05M01_CD_TO_NM(ITEM_DIV) 	AS ITEM_DIV_NM
            , CLNT_PJT
            , FN_CM05M01_CD_TO_NM(CLNT_PJT) 	AS CLNT_PJT_NM
            , CTRT_NM
            , CURR_CD
            , FN_CM05M01_CD_TO_NM(CURR_CD) 	AS CURR_CD_NM
            , EXRATE
            , ORDRS_AMT
            , INPEXP_CD
            , FN_CM05M01_CD_TO_NM(INPEXP_CD) 	AS INPEXP_CD_NM
            , B.CLNT_NM  						AS ORDRS_CLNT_NM
            , T.TRGT_PCHS_PCOST_MACH
            , T .TRGT_PCHS_PCOST_ELCTY
            , T.TRGT_PCHS_PCOST_MACH + T.TRGT_PCHS_PCOST_ELCTY  AS TRGT_PCHS_PCOST
            , TOT.TOT_COST		--총원가(참조salesCd 포함 금액)
			<if test="userId != null and userId != ''">
			, (
				  SELECT CASE WHEN COUNT(1) <![CDATA[ > ]]> 0 THEN 'Y' ELSE 'N' END
				    FROM TB_CM06M01 C
				   WHERE C.ID = #{userId}
					 AND C.TEAM_MANAGER = 'TEAM01'
				) AS TEAM_MANAGER_YN	--팀장여부
			</if>
			, NVL(W.BOM_REMARK, '') AS BOM_REMARK
	   FROM   TB_CR02D02 AS T
			  LEFT OUTER JOIN TB_WB25M01 AS W ON T.SALES_CD = W.SALES_CD
	          INNER JOIN TB_CR02M01 AS M  ON M.CO_CD    = T.CO_CD
	                                     AND M.ORDRS_NO = T.ORDRS_NO
	          LEFT OUTER JOIN TB_BM02M01 B ON M.ORDRS_CLNT_CD = B.CLNT_CD
	          , (
			          SELECT SUM(TRGT_PCHS_PCOST_MACH+ TRGT_PCHS_PCOST_ELCTY) AS TOT_COST
						FROM TB_CR02D02
						WHERE CO_CD = #{ordCoCd}
						  AND (SALES_CD = #{salesCd}
						  OR ORGN_SALES_CD = #{salesCd})
			  ) AS TOT
	  WHERE  1 = 1
		AND T.SALES_CD = #{salesCd}
		AND T.CO_CD    = #{ordCoCd}
    </select>

	<select id="selectOrdrsSearchSm50Info" parameterType="map" resultType="CamelMap">
		WITH S AS (
			SELECT
				  CO_CD
				, ORDRS_NO
				, NVL(SUM(NVL(ORDRS_PRC_MACH,0)),0)                     AS TOT_ORDRS_PRC_MACH
				, NVL(SUM(NVL(ORDRS_PRC_ELCTY,0)),0)                    AS TOT_ORDRS_PRC_ELCTY
				, NVL(SUM(NVL(ORDRS_PRC,0)),0)                          AS TOT_ORDRS_PRC
				, NVL(SUM(NVL(EST_EPCT_MAT_PRC,0)),0)                   AS TOT_EST_EPCT_MAT_PRC
				, NVL(SUM(NVL(TRGT_PCHS_PCOST_MACH,0)),0)               AS TOT_TRGT_PCHS_PCOST_MACH
				, NVL(SUM(NVL(TRGT_PCHS_PCOST_ELCTY,0)),0)              AS TOT_TRGT_PCHS_PCOST_ELCTY
				, NVL(SUM(NVL(TRGT_PCHS_PCOST_IN_HOUSE_PRCSN,0)),0)     AS TOT_TRGT_PCHS_PCOST_IN_HOUSE_PRCSN
				, NVL(SUM(NVL(LABOR_COST_MFG_COST,0)),0)                AS TOT_LABOR_COST_MFG_COST
				, NVL(SUM(NVL(EST_TRGT_COST,0)),0)                      AS TOT_EST_TRGT_COST
			FROM TB_CR02D02
			WHERE CO_CD 	= #{coCd}
			  AND ORDRS_NO 	= #{ordrsNo}
			  AND SALES_CD IS NOT NULL
			GROUP BY CO_CD, ORDRS_NO
		)
		SELECT
			  M.CO_CD
			, M.ORDRS_NO
			, M.ORDRS_CLNT_CD
			, M.ORDRS_DT
			, M.ORDRS_DIV
			, FN_CM05M01_CD_TO_NM(M.ORDRS_DIV)          AS ORDRS_DIV_NM
			, M.CLNT_PJT
			, FN_CM05M01_CD_TO_NM(M.CLNT_PJT)           AS CLNT_PJT_NM
			, M.CTRT_NM
			, M.CURR_CD
			, FN_CM05M01_CD_TO_NM(M.CURR_CD)            AS CURR_CD_NM
			, M.EXRATE
			, M.ORDRS_AMT
			, M.INPEXP_CD
			, FN_CM05M01_CD_TO_NM(M.INPEXP_CD)          AS INPEXP_CD_NM
			, B.CLNT_NM                                  AS ORDRS_CLNT_NM
			, NVL(S.TOT_ORDRS_PRC_MACH,0)                AS TOT_ORDRS_PRC_MACH
			, NVL(S.TOT_ORDRS_PRC_ELCTY,0)               AS TOT_ORDRS_PRC_ELCTY
			, NVL(S.TOT_ORDRS_PRC,0)                     AS TOT_ORDRS_PRC
			, NVL(S.TOT_EST_EPCT_MAT_PRC,0)              AS TOT_EST_EPCT_MAT_PRC
			, NVL(S.TOT_TRGT_PCHS_PCOST_MACH,0)          AS TOT_TRGT_PCHS_PCOST_MACH
			, NVL(S.TOT_TRGT_PCHS_PCOST_ELCTY,0)         AS TOT_TRGT_PCHS_PCOST_ELCTY
			, NVL(S.TOT_TRGT_PCHS_PCOST_IN_HOUSE_PRCSN,0)AS TOT_TRGT_PCHS_PCOST_IN_HOUSE_PRCSN
			, NVL(S.TOT_LABOR_COST_MFG_COST,0)           AS TOT_LABOR_COST_MFG_COST
			, NVL(S.TOT_EST_TRGT_COST,0)                 AS TOT_EST_TRGT_COST
			, NVL(S.TOT_TRGT_PCHS_PCOST_MACH,0) + NVL(S.TOT_TRGT_PCHS_PCOST_ELCTY,0)         AS TOT_COST
		FROM TB_CR02M01 M
						LEFT JOIN S ON S.CO_CD = M.CO_CD
								   AND S.ORDRS_NO = M.ORDRS_NO
						LEFT JOIN TB_BM02M01 B ON B.CLNT_CD = M.ORDRS_CLNT_CD
		WHERE M.CO_CD 		= #{coCd}
		  AND M.ORDRS_NO 	= #{ordrsNo}
	</select>

	<select id="selectOrdrsBomCostTreeList" parameterType="Map" resultType="CamelMap">
		WITH
			SALES_LIST AS ( /* ORDRS_NO에 속한 SALES_CD 목록 */
				SELECT DISTINCT SALES_CD
				FROM BOM_TEMP
				WHERE CO_CD    = #{coCd}
				AND ORDRS_NO = #{ordrsNo}
				AND UPPER_CD = 'top'
			),
			SRC AS (        /* 해당 ORDRS_NO의 SALES_CD들만 범위로 */
				SELECT T.*
				FROM BOM_TEMP T
				JOIN SALES_LIST S
					ON T.SALES_CD = S.SALES_CD
				WHERE T.CO_CD = #{coCd}
			),
			PCHS_BOM AS (   /* 부모(UPPER_CD)별 자식 수 */
				SELECT CO_CD, UPPER_CD, COUNT(*) AS PCHS_BOM_CNT
				FROM SRC
				GROUP BY CO_CD, UPPER_CD
			)
			SELECT
				  '#'            AS PARENT
				, #{ordrsNo}     AS ID
				, 'top'          AS UPPER_CD
				, #{ordrsNo}     AS LOWER_CD
				, <![CDATA['<span style=''color: red;''>' || #{ordrsNo} || '</span>' ]]>  AS TEXT
				, 0              AS LVL
				, NULL           AS DSGN_NO
				, 'unit'         AS TYPE
				, #{ordrsNo}     AS PATH
				, #{coCd}        AS CO_CD
				, NULL           AS SALES_CD
				, NULL           AS MATR_NM
				, NULL           AS BOM_QTY
				, NULL           AS MATR_SPEC
				, NULL           AS MATR_SIZE
				, NULL           AS MATR_MAT
				, NULL           AS MATR_RMK
				, NULL           AS UPPER_NM
				, #{ordrsNo}     AS LOWER_NM
				, #{ordrsNo}     AS ORDRS_NO
				, 0              AS PCHS_BOM_CNT
				, #{ordrsNo}     AS RAW_ID
				, 'top'          AS RAW_PARENT
			FROM DUAL
			WHERE EXISTS (SELECT 1 FROM SRC)
			UNION ALL
			SELECT
				CASE WHEN T.UPPER_CD = 'top' THEN #{ordrsNo}
					ELSE T.SALES_CD || '/' || T.UPPER_CD END				AS PARENT
				, T.SALES_CD || '/' || T.LOWER_CD							AS ID
				, T.UPPER_CD
				, T.LOWER_CD
				, <![CDATA[
				(CASE WHEN NVL(D.PCHS_BOM_CNT,0) > 0
					THEN '<span style=''color: red;''>' || T.LOWER_NM ||
						CASE WHEN T.MATR_NM IS NOT NULL THEN '(' || T.MATR_NM || ')' ELSE '' END ||
						' x ' || T.BOM_QTY || '</span>'
					ELSE T.LOWER_NM ||
						CASE WHEN T.MATR_NM IS NOT NULL THEN '(' || T.MATR_NM || ')' ELSE '' END ||
						' x ' || T.BOM_QTY
				END
				|| ' [' || TO_CHAR(NVL(T.STD_AMT,0)+NVL(T.BAD_AMT,0),'FM999,999,999,999') || ']')
				]]>                                                                    AS TEXT
				, (LEVEL)                                                               AS LVL
				, T.DSGN_NO
				, CASE WHEN CONNECT_BY_ISLEAF = 1 THEN 'leaf' ELSE 'unit' END           AS TYPE
				, REGEXP_REPLACE(
					REPLACE(SYS_CONNECT_BY_PATH(T.LOWER_CD, ' -> '),
						' -> '||T.SALES_CD||' -> ',
						' -> '||#{ordrsNo}||' -> '||T.SALES_CD||' -> ')
					, '^\s+\-\>\s+', '')                                                  AS PATH
				, T.CO_CD
				, T.SALES_CD
				, T.MATR_NM
				, T.BOM_QTY
				, T.MATR_SPEC
				, T.MATR_SIZE
				, T.MATR_MAT
				, T.MATR_RMK
				, T.UPPER_NM
				, T.LOWER_NM
				, T.ORDRS_NO
				, NVL(D.PCHS_BOM_CNT,0)                                                 AS PCHS_BOM_CNT
				, T.LOWER_CD												AS RAW_ID      /* 서버 질의용 원본키 */
				, T.UPPER_CD												AS RAW_PARENT
			FROM SRC T
						LEFT JOIN PCHS_BOM D ON D.CO_CD    = T.CO_CD
											AND D.UPPER_CD = T.LOWER_CD
			/* 다중 루트: 해당 ORDRS_NO의 각 SALES_CD 최상위에서 시작 */
			START WITH T.UPPER_CD = 'top'
					AND T.ORDRS_NO = #{ordrsNo}
			CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
			ORDER BY LOWER_NM
	</select>

	<select id="selectSalesCdListByOrdrsNo" parameterType="Map" resultType="CamelMap">
		SELECT SALES_CD
		FROM TB_CR02D02
		WHERE ORDRS_NO = #{ordrsNo}
		AND SALES_CD IS NOT NULL
	</select>

	<select id="selectOrdrsBomAllCostList" parameterType="Map" resultType="CamelMap">
		<!-- 1) 루트(수주번호) 가상행: 합계는 bomLevel과 무관 -->
		WITH SRC AS (
			SELECT *
			FROM BOM_TEMP
			WHERE CO_CD    = #{coCd}
			AND ORDRS_NO = #{ordrsNo}
		)
		<if test="fileTrgtKey == ordrsNo">
			SELECT
				  ''				AS PID
				, #{ordrsNo}		AS ID
				, #{ordrsNo}		AS VIEW_ID
				, '.'||0			AS LVL
				, #{ordrsNo}		AS PATH
				, ''				AS MATR_UNIT_CD_NM
				, ''				AS MATR_WT
				, ''				AS MATR_UPR
				, ''				AS MATR_AVRG_UPR
				, ''				AS MATR_LAST_TRST_DT
				, ''				AS PART_AMT
				, ''				AS MATR_MAT
				, ''				AS MATR_SPEC
				, ''				AS MATR_SIZE
				, ''				AS MATR_RMK
				, #{coCd}			AS CO_CD
				, #{ordrsNo}		AS ORDRS_NO
				, ''				AS SALES_CD
				, 'top'				AS UPPER_CD
				, #{ordrsNo}		AS LOWER_CD
				, ''				AS BOM_LVL
				, ''				AS DSGN_NO
				, ''				AS BOM_QTY
				, ''				AS BOM_UPR
				, ''				AS BOM_AMT
				, '#'				AS UPPER_NM
				, #{ordrsNo}		AS LOWER_NM
				, ''				AS BOM_SEQ
				, ''				AS BOM_TYPE
				, ''				AS MATR_SEQ
				, ''				AS MATR_CD
				, ''				AS MATR_NM
				, ''				AS BOM_PATH
				, SUMS.STD_AMT		AS STD_AMT
				, SUMS.BAD_AMT		AS BAD_AMT
				, 0					AS AS_AMT
				, SUMS.GER_AMT		AS GER_AMT
				, SUMS.ELEC_AMT		AS ELEC_AMT
				, SUMS.TRUN_AMT		AS TRUN_AMT
				, 0					AS IN_PRC
				, 0					AS IN_QTY
				, 0					AS BAD_QTY
				, 0					AS IN_DTL_AMT
				, ''				AS CREAT_ID
				, SYSDATE			AS CREAT_DTTM
				, SUMS.PCHS_GOODS_AMT AS PCHS_GOODS_AMT
				, SUMS.RAW_MAT_AMT  AS RAW_MAT_AMT
				, SUMS.PROC_GOODS_AMT AS PROC_GOODS_AMT
				, SUMS.POST_PROC_AMT AS POST_PROC_AMT
				, SUMS.TRANS_AMT	AS TRANS_AMT
				, SUMS.ETC_AMT		AS ETC_AMT
				, ''				AS MATR_GOODS_DIV
				, ''				AS PCHS_CLNT_CD
				, SUMS.CAM_AMT		AS CAM_AMT
				, ''				AS MATR_SPEC2
				, ''				AS MATR_SIZE2
				, ''				AS MATR_MAT2
				, ''				AS MATR_RMK2
				, SUMS.AS_NON_PAY_AMT AS AS_NON_PAY_AMT
				, SUMS.AS_PAY_AMT   AS AS_PAY_AMT
				, SUMS.HUMAN_AMT    AS HUMAN_AMT
				, ''				AS CLNT_NM
			FROM (
				SELECT 
					  NVL(SUM(STD_AMT), 0) AS STD_AMT
					, NVL(SUM(BAD_AMT), 0) AS BAD_AMT
					, NVL(SUM(GER_AMT), 0) AS GER_AMT
					, NVL(SUM(ELEC_AMT), 0) AS ELEC_AMT
					, NVL(SUM(TRUN_AMT), 0) AS TRUN_AMT
					, NVL(SUM(PCHS_GOODS_AMT), 0) AS PCHS_GOODS_AMT
					, NVL(SUM(RAW_MAT_AMT), 0) AS RAW_MAT_AMT
					, NVL(SUM(PROC_GOODS_AMT), 0) AS PROC_GOODS_AMT
					, NVL(SUM(POST_PROC_AMT), 0) AS POST_PROC_AMT
					, NVL(SUM(TRANS_AMT), 0) AS TRANS_AMT
					, NVL(SUM(ETC_AMT), 0) AS ETC_AMT
					, NVL(SUM(CAM_AMT), 0) AS CAM_AMT
					, NVL(SUM(AS_NON_PAY_AMT), 0) AS AS_NON_PAY_AMT
					, NVL(SUM(AS_PAY_AMT), 0) AS AS_PAY_AMT
					, NVL(SUM(HUMAN_AMT), 0) AS HUMAN_AMT
				FROM SRC
				WHERE UPPER_CD = 'top'
				GROUP BY ORDRS_NO
			) SUMS
		UNION ALL
		</if>
		SELECT
			  CASE WHEN T.UPPER_CD = 'top' AND #{fileTrgtKey} = #{ordrsNo} THEN #{ordrsNo}
				ELSE (CASE WHEN T.LOWER_CD = #{fileTrgtKey} THEN '' ELSE T.UPPER_CD END)
			  END                                            AS PID
			, T.LOWER_CD                                     AS ID
			, DECODE(T.BOM_TYPE,'M', T.MATR_CD, T.LOWER_NM)  AS VIEW_ID
			, (CASE WHEN #{fileTrgtKey} = #{ordrsNo} THEN '.'||LEVEL ELSE '.'||(LEVEL-1) END) AS LVL
			, (CASE WHEN #{fileTrgtKey} = #{ordrsNo}
					THEN #{ordrsNo} || ' -> ' ||
						LTRIM(REGEXP_REPLACE(SYS_CONNECT_BY_PATH(T.LOWER_NM,' -> '),'^\s*\-\>\s*',''))
					ELSE LTRIM(REGEXP_REPLACE(SYS_CONNECT_BY_PATH(T.LOWER_NM,' -> '),'^\s*\-\>\s*',''))
			  END)                                         AS PATH
			, FN_CM05M01_CD_TO_NM(M.MATR_UNIT)               AS MATR_UNIT_CD_NM
			, M.MATR_WT
			, M.MATR_UPR
			, M.MATR_AVRG_UPR
			, TO_CHAR(M.MATR_LAST_TRST_DT,'YYYY-MM-DD')      AS MATR_LAST_TRST_DT
			, M.MATR_UPR * T.BOM_QTY                         AS PART_AMT
			, DECODE(T.BOM_TYPE,'M',M.MATR_MAT,  T.MATR_MAT) AS MATR_MAT
			, DECODE(T.BOM_TYPE,'M',M.MATR_SPEC, T.MATR_SPEC)AS MATR_SPEC
			, DECODE(T.BOM_TYPE,'M',M.MATR_SIZE, T.MATR_SIZE)AS MATR_SIZE
			, DECODE(T.BOM_TYPE,'M',M.MATR_RMK,  T.MATR_RMK) AS MATR_RMK
			, T.CO_CD
			, T.ORDRS_NO
			, T.SALES_CD
			, T.UPPER_CD
			, T.LOWER_CD
			, T.BOM_LVL
			, T.DSGN_NO
			, T.BOM_QTY
			, T.BOM_UPR
			, T.BOM_AMT
			, T.UPPER_NM
			, T.LOWER_NM
			, T.BOM_SEQ
			, T.BOM_TYPE
			, T.MATR_SEQ
			, T.MATR_CD
			, T.MATR_NM
			, T.BOM_PATH
			, T.STD_AMT
			, T.BAD_AMT
			, T.AS_AMT
			, T.GER_AMT
			, T.ELEC_AMT
			, T.TRUN_AMT
			, T.IN_PRC
			, T.IN_QTY
			, T.BAD_QTY
			, T.IN_DTL_AMT
			, T.CREAT_ID
			, T.CREAT_DTTM
			, T.PCHS_GOODS_AMT
			, T.RAW_MAT_AMT
			, T.PROC_GOODS_AMT
			, T.POST_PROC_AMT
			, T.TRANS_AMT
			, T.ETC_AMT
			, T.MATR_GOODS_DIV
			, T.PCHS_CLNT_CD
			, T.CAM_AMT
			, DECODE(T.BOM_TYPE,'M', M.MATR_SPEC, T.MATR_SPEC) AS MATR_SPEC2
			, DECODE(T.BOM_TYPE,'M', M.MATR_SIZE, T.MATR_SIZE) AS MATR_SIZE2
			, DECODE(T.BOM_TYPE,'M', M.MATR_MAT,  T.MATR_MAT)  AS MATR_MAT2
			, DECODE(T.BOM_TYPE,'M', M.MATR_RMK,  T.MATR_RMK)  AS MATR_RMK2
			, T.AS_NON_PAY_AMT
			, T.AS_PAY_AMT
			, T.HUMAN_AMT
			, C.CLNT_NM
		FROM SRC T
					LEFT OUTER JOIN TB_BM05M01 M ON T.MATR_CD = M.MATR_CD
					LEFT OUTER JOIN TB_BM02M01 C ON T.PCHS_CLNT_CD = C.CLNT_CD
		WHERE T.CO_CD    = #{coCd}
		  AND T.ORDRS_NO = #{ordrsNo}
		<if test="bomLevel != null and bomLevel != ''">
			<choose>
				<when test="fileTrgtKey == ordrsNo">
					AND LEVEL <![CDATA[<=]]> (#{bomLevel})
				</when>
				<otherwise>
					AND (LEVEL - 1) <![CDATA[<=]]> #{bomLevel}
				</otherwise>
			</choose>
		</if>
		<choose>
			<when test="fileTrgtKey == ordrsNo">
				START WITH T.UPPER_CD = 'top'
				AND T.ORDRS_NO = #{ordrsNo}
			</when>
			<otherwise>
				START WITH T.LOWER_CD = #{fileTrgtKey}
							AND UPPER_CD = #{parent}
			</otherwise>
		</choose>
		CONNECT BY PRIOR T.LOWER_CD = T.UPPER_CD
		ORDER BY PATH
	</select>

	<select id="selectOrdrsBomTrgtPchsPcostInfo" parameterType="Map" resultType="CamelMap">
		SELECT 
			T.CO_CD
			, T.ORDRS_NO
			, SUM(NVL(T.STD_AMT,0))  AS STD_AMT
			, SUM(NVL(T.BAD_AMT,0))  AS BAD_AMT
			, SUM(NVL(T.AS_AMT,0))   AS AS_AMT
			, SUM(NVL(T.HUMAN_AMT,0))AS HUMAN_AMT
		FROM BOM_TEMP T
		WHERE T.CO_CD = #{coCd}
		AND T.ORDRS_NO = #{ordrsNo}
		AND T.UPPER_CD = 'top'
		GROUP BY T.CO_CD, T.ORDRS_NO
	</select>
</mapper>