<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm10.mapper.SM10Mapper">

	<select id="selectPchsCostCount" parameterType="Map" resultType="int">
		SELECT
            count(*)
		FROM TB_SM10M01 T
					             LEFT OUTER JOIN TB_BM02M01 A ON T.PCHS_CLNT_CD = A.CLNT_CD
					             LEFT OUTER JOIN TB_CM06M01 B ON T.CREAT_ID = B.ID
					             LEFT OUTER JOIN TB_CM06M01 C ON T.UDT_ID = C.ID
					             
					             LEFT OUTER JOIN TB_BM05M01 M ON T.MATR_CD = M.MATR_CD  --자재마스터
			                                                 AND T.CO_CD   = M.CO_CD
					             LEFT OUTER JOIN TB_CR02D02 S ON T.SALES_CD = S.SALES_CD  --수주상세(Sales Code)
			                                                 AND T.CO_CD    = S.CO_CD 
					             LEFT OUTER JOIN TB_CR02M01 SM ON S.CO_CD    = SM.CO_CD  --수주상세(Sales Code)
					            							  AND S.ORDRS_NO = SM.ORDRS_NO
					             LEFT OUTER JOIN TB_BM02M01 X ON SM.ORDRS_CLNT_CD = X.CLNT_CD --거래처마스터
					             LEFT OUTER JOIN TB_BM01M01 P ON S.PRDT_CD = P.PRDT_CD  --제품마스터
         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.COST_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND SM.ORDRS_CLNT_CD = #{vendCd}
              </if>			  			  
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND X.CLNT_NM LIKE '%${vendNm}%'
              </if>			  			  
              <if test="salesCd !=null and !salesCd.equals('')">
     	           AND T.SALES_CD LIKE '%${salesCd}%'
              </if>			  			  
              <if test="prdtCd !=null and !prdtCd.equals('')">
     	           AND S.PRDT_CD = #{prdtCd}
              </if>			  			  
              <if test="prdtNm !=null and !prdtNm.equals('')">
     	           AND P.PRDT_NM LIKE '%${prdtNm}%'
              </if>			  			  
              <if test="itemCd !=null and !itemCd.equals('')">
     	           AND S.ITEM_DIV = #{itemCd}
              </if>			  			  
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND T.PCHS_CLNT_CD = #{clntCd}
              </if>			  			  
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND A.CLNT_NM LIKE '%${clntNm}%'
              </if>			  			  
              <if test="pchsCostDiv10 !=null and !pchsCostDiv10.equals('')">
     	           AND T.PCHS_COST_DIV10 = #{pchsCostDiv10}
              </if>				  			  
              <if test="pchsCostDiv20 !=null and !pchsCostDiv20.equals('')">
     	           AND T.PCHS_COST_DIV20 = #{pchsCostDiv20}
              </if>	

	</select>

	<select id="selectPchsCostList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
		          SELECT
							T.FILE_TRGT_KEY,
							T.CO_CD,
							FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM,
							T.COST_NO,
							T.SALES_CD,
							T.PCHS_CLNT_CD,
							A.CLNT_NM PCHS_CLNT_NM,
							TO_CHAR(T.COST_DT, 'YYYY-MM-DD') AS COST_DT,
							T.PCHS_COST_DIV10,
							FN_CM05M01_CD_TO_NM(T.PCHS_COST_DIV10) PCHS_COST_DIV10_NM,
							T.PCHS_COST_DIV20,
							FN_CM05M01_CD_TO_NM(T.PCHS_COST_DIV20) PCHS_COST_DIV20_NM,
							T.CURR_CD,
							FN_CM05M01_CD_TO_NM(T.CURR_CD) CURR_NM,
							T.EXRATE,
							T.COST_AMT,
							T.MATR_CD,
							M.MATR_NM,
							T.COST_RMK,
							T.ETC_FIELD1,
							T.ETC_FIELD2,
							T.ETC_FIELD3,
							T.CREAT_ID,
							B.NAME CREAT_NM,
							T.CREAT_PGM,
							TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM,
							T.UDT_ID,
							C.NAME UDT_NM,
							T.UDT_PGM,
							TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
				FROM TB_SM10M01 T
					             LEFT OUTER JOIN TB_BM02M01 A ON T.PCHS_CLNT_CD = A.CLNT_CD
					             LEFT OUTER JOIN TB_CM06M01 B ON T.CREAT_ID = B.ID
					             LEFT OUTER JOIN TB_CM06M01 C ON T.UDT_ID = C.ID
					             
					             LEFT OUTER JOIN TB_BM05M01 M ON T.MATR_CD = M.MATR_CD  --자재마스터
			                                                 AND T.CO_CD   = M.CO_CD
					             LEFT OUTER JOIN TB_CR02D02 S ON T.SALES_CD = S.SALES_CD  --수주상세(Sales Code)
			                                                 AND T.CO_CD    = S.CO_CD 
					             LEFT OUTER JOIN TB_CR02M01 SM ON S.CO_CD    = SM.CO_CD  --수주상세(Sales Code)
					            							  AND S.ORDRS_NO = SM.ORDRS_NO
					             LEFT OUTER JOIN TB_BM02M01 X ON SM.ORDRS_CLNT_CD = X.CLNT_CD --거래처마스터
					             LEFT OUTER JOIN TB_BM01M01 P ON S.PRDT_CD = P.PRDT_CD  --제품마스터

		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.COST_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND SM.ORDRS_CLNT_CD = #{vendCd}
              </if>			  			  
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND X.CLNT_NM LIKE '%${vendNm}%'
              </if>			  			  
              <if test="salesCd !=null and !salesCd.equals('')">
     	           AND T.SALES_CD LIKE '%${salesCd}%'
              </if>			  			  
              <if test="prdtCd !=null and !prdtCd.equals('')">
     	           AND S.PRDT_CD = #{prdtCd}
              </if>			  			  
              <if test="prdtNm !=null and !prdtNm.equals('')">
     	           AND P.PRDT_NM LIKE '%${prdtNm}%'
              </if>			  			  
              <if test="itemCd !=null and !itemCd.equals('')">
     	           AND S.ITEM_DIV = #{itemCd}
              </if>			  			  
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND T.PCHS_CLNT_CD = #{clntCd}
              </if>			  			  
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND A.CLNT_NM LIKE '%${clntNm}%'
              </if>			  			  
              <if test="pchsCostDiv10 !=null and !pchsCostDiv10.equals('')">
     	           AND T.PCHS_COST_DIV10 = #{pchsCostDiv10}
              </if>				  			  
              <if test="pchsCostDiv20 !=null and !pchsCostDiv20.equals('')">
     	           AND T.PCHS_COST_DIV20 = #{pchsCostDiv20}
              </if>				  			  
		         ORDER BY T.CO_CD, T.SALES_CD, T.COST_NO, A.CLNT_NM
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>


  <select id="selectPchsCostInfo" resultType="CamelMap">
          SELECT
					T.FILE_TRGT_KEY,
					T.CO_CD,
					FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM,
					T.COST_NO,
					S.PRDT_CD,
					P.PRDT_NM,
					S.ITEM_DIV,
					FN_CM05M01_CD_TO_NM(S.ITEM_DIV) ITEM_DIV_NM,
					S.EQP_NM,
					T.SALES_CD,
					SM.ORDRS_CLNT_CD  	VEND_CD,
					X.CLNT_NM 			VEND_NM,
					SM.CLNT_PJT			CLNT_PJT_CD,
					SM.CLNT_PJT,
					T.PCHS_CLNT_CD,
					A.CLNT_NM PCHS_CLNT_NM,
					TO_CHAR(T.COST_DT, 'YYYY-MM-DD') AS COST_DT,
					T.PCHS_COST_DIV10,
					FN_CM05M01_CD_TO_NM(T.PCHS_COST_DIV10) PCHS_COST_DIV10_NM,
					T.PCHS_COST_DIV20,
					FN_CM05M01_CD_TO_NM(T.PCHS_COST_DIV20) PCHS_COST_DIV20_NM,
					T.CURR_CD,
					FN_CM05M01_CD_TO_NM(T.CURR_CD) CURR_NM,
					T.EXRATE,
					T.COST_AMT,
					T.MATR_CD,
					M.MATR_NM,
					T.COST_RMK,
					T.ETC_FIELD1,
					T.ETC_FIELD2,
					T.ETC_FIELD3,
					T.CREAT_ID,
					B.NAME CREAT_NM,
					T.CREAT_PGM,
					TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM,
					T.UDT_ID,
					C.NAME UDT_NM,
					T.UDT_PGM,
					TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
		FROM TB_SM10M01 T
			             LEFT OUTER JOIN TB_BM02M01 A ON T.PCHS_CLNT_CD = A.CLNT_CD --거래처마스터
			             LEFT OUTER JOIN TB_CM06M01 B ON T.CREAT_ID = B.ID
			             LEFT OUTER JOIN TB_CM06M01 C ON T.UDT_ID = C.ID		--사용자마스터
			             LEFT OUTER JOIN TB_BM05M01 M ON T.MATR_CD = M.MATR_CD  --자재마스터
			                                         AND T.CO_CD   = M.CO_CD
			             LEFT OUTER JOIN TB_CR02D02 S ON T.SALES_CD = S.SALES_CD  --수주상세(Sales Code)
			                                         AND T.CO_CD    = S.CO_CD 
			             LEFT OUTER JOIN TB_CR02M01 SM ON S.CO_CD    = SM.CO_CD  --수주상세(Sales Code)
			            							  AND S.ORDRS_NO = SM.ORDRS_NO
			             LEFT OUTER JOIN TB_BM02M01 X ON SM.ORDRS_CLNT_CD = X.CLNT_CD --거래처마스터
			             LEFT OUTER JOIN TB_BM01M01 P ON S.PRDT_CD = P.PRDT_CD  --제품마스터
       WHERE T.FILE_TRGT_KEY = #{fileTrgtKey}
  </select>




  <select id="selectConfirmCount" parameterType="Map" resultType="int">
    SELECT COUNT(FILE_TRGT_KEY) CNT
      FROM TB_SM10M01
     WHERE FILE_TRGT_KEY = #{fileTrgtKey}
  </select>
  
<update id="updatePchsCost" parameterType="Map">
    UPDATE TB_SM10M01
		SET
			SALES_CD               	= #{salesCd},
			PCHS_CLNT_CD           	= #{pchsClntCd},
			COST_DT                	= #{costDt},
			PCHS_COST_DIV10        	= #{pchsCostDiv10},
			PCHS_COST_DIV20        	= #{pchsCostDiv20},
			CURR_CD                	= #{currCd},
			EXRATE                 	= #{exrate},
			COST_AMT               	= #{costAmt},
			MATR_CD                	= #{matrCd},
			COST_RMK               	= #{costRmk},
			ETC_FIELD1             	= #{etcField1, jdbcType=VARCHAR},
			ETC_FIELD2             	= #{etcField2, jdbcType=VARCHAR},
			ETC_FIELD3             	= #{etcField3, jdbcType=VARCHAR},
			UDT_ID                 	= #{userId},
			UDT_PGM                	= #{pgmId},
			UDT_DTTM               	= SYSDATE
    WHERE FILE_TRGT_KEY             = #{fileTrgtKey}
<!--     		CO_CD                  	= #{coCd} -->
<!-- 		AND	COST_NO                	= #{costNo}, -->

  </update>
  
  <select id="selectPchsCostSeqNext" parameterType="Map" resultType="int">
		SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_SM10M01_SQ01.NEXTVAL,3,0) FROM DUAL
  </select>
  
<insert id="insertPchsCost" parameterType="Map">
    <selectKey keyProperty="costNo" resultType="String" order="BEFORE">
      SELECT 'COST' || TO_CHAR(SYSDATE, 'YY')||LPAD(TB_SM10M01_SQ02.NEXTVAL,4,0) FROM DUAL
    </selectKey>
    INSERT INTO TB_SM10M01
      (
		FILE_TRGT_KEY,  
		CO_CD,          
		COST_NO,        
		SALES_CD,       
		PCHS_CLNT_CD,   
		COST_DT,        
		PCHS_COST_DIV10,
		PCHS_COST_DIV20,
		CURR_CD,        
		EXRATE,         
		COST_AMT,       
		MATR_CD,        
		COST_RMK,       
		ETC_FIELD1,     
		ETC_FIELD2,     
		ETC_FIELD3,     
		CREAT_ID,       
		CREAT_PGM,      
		CREAT_DTTM     
      )
    VALUES
    (
		#{fileTrgtKey},
		#{coCd},
		#{costNo},
		#{salesCd},
		#{pchsClntCd},
		#{costDt},
		#{pchsCostDiv10},
		#{pchsCostDiv20},
		#{currCd},
		#{exrate},
		#{costAmt},
		#{matrCd},
		#{costRmk},
		#{etcField1, jdbcType=VARCHAR},
		#{etcField2, jdbcType=VARCHAR},
		#{etcField3, jdbcType=VARCHAR},
		#{userId},
		#{pgmId},
		SYSDATE
    )
  </insert>
  
  <delete id="deletePchsCost" parameterType="Map">
    DELETE TB_SM10M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
  </delete>
  
</mapper>