<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm11.mapper.SM11Mapper">

	<select id="selectContractCount" parameterType="Map" resultType="int">
		SELECT
            count(*)
		FROM TB_SM11M01 M
				LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
         WHERE 1=1
            <if test="coCd !=null and !coCd.equals('')">
   	           AND M.CO_CD = #{coCd}
            </if>
		    <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
			   AND M.CTRT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
		    </if>
            <if test="clntCd !=null and !clntCd.equals('')">
   	           AND M.CLNT_CD = #{clntCd}
            </if>
            <if test="clntNm !=null and !clntNm.equals('')">
   	           AND B.CLNT_NM LIKE '%'||#{clntNm}||'%'
            </if>
            <if test="ordrsNo !=null and !ordrsNo.equals('')">
   	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
            </if>
            <if test="salesCd !=null and !salesCd.equals('')">
   	           AND M.SALES_CD LIKE '%'||#{salesCd}||'%'
            </if>
         ORDER BY M.CO_CD, M.CTRT_NO DESC, B.CLNT_NM			  			  

	</select>

	<select id="selectContractList" parameterType="Map" resultType="CamelMap">
	/* selectContractList */
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(SELECT 	  M.FILE_TRGT_KEY
						, M.CO_CD
						, FN_CM05M01_CD_TO_NM(M.CO_CD) AS CO_CD_NM
						, M.CTRT_NO
						, M.CLNT_CD  				AS VEND_CD	--공급사
						, B.CLNT_NM  				AS VEND_NM	--공급사명
						, C.ORDRS_CLNT_CD 			AS CLNT_CD	--수주고객사
						, D.CLNT_NM								--수주고객사명
						, M.ORDRS_CO_CD							--수주회사코드
						, M.ORDRS_NO							--수주번호
						, C.CLNT_PJT							--고객사프로젝트
						, FN_CM05M01_CD_TO_NM(C.CLNT_PJT) AS CLNT_PJT_NM
						, M.CTRT_NM								--외주계약명
						, TO_CHAR(M.CTRT_DT, 'YYYY-MM-DD') AS CTRT_DT
						, M.CTRT_AMT
						, M.CTRT_ITEMS		--외주계약 품목
						, M.CTRT_PMNT_MTD_CD
						, FN_CM05M01_CD_TO_NM(M.CTRT_PMNT_MTD_CD) AS CTRT_PMNT_MTD_CD_NM
						, M.CTRT_CLMN_DIV_CD
						, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_DIV_CD) AS CTRT_CLMN_DIV_CD_NM
						, M.CTRT_CLMN_DAY
						, M.CTRT_CLMN_VAT
						, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_VAT) AS CTRT_CLMN_VAT_NM
						, TO_CHAR(M.CTRT_ORDRS_DT, 'YYYY-MM-DD') AS CTRT_ORDRS_DT
						, TO_CHAR(M.CTRT_PFMC_DT, 'YYYY-MM-DD') AS CTRT_PFMC_DT
						, TO_CHAR(M.CTRT_BF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_BF_PFMC_DT
						, TO_CHAR(M.CTRT_AF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_AF_PFMC_DT
						, M.CURR_CD
						, FN_CM05M01_CD_TO_NM(M.CURR_CD) AS CURR_CD_NM
						, M.EXRATE
						, (SELECT FN_CM06M01_ID_TO_NM(M.MNG_ID) FROM DUAL) MNG_ID_NM
						, M.CTRT_RMK
						, M.ETC_FIELD1
						, M.ETC_FIELD2
						, M.ETC_FIELD3
						, M.CREAT_ID
						, (SELECT FN_CM06M01_ID_TO_NM(M.CREAT_ID) FROM DUAL) CREAT_ID_NM
						, M.CREAT_PGM
						, TO_CHAR(M.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
						, M.UDT_ID
						, (SELECT FN_CM06M01_ID_TO_NM(M.UDT_ID) FROM DUAL) UDT_ID_NM
						, M.UDT_PGM
						, TO_CHAR(M.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
				FROM TB_SM11M01 M
						LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
						LEFT OUTER JOIN TB_CR02M01 C ON C.CO_CD = M.ORDRS_CO_CD
						                            AND C.ORDRS_NO = M.ORDRS_NO
						LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND M.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND M.CTRT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND M.CLNT_CD = #{clntCd}
              </if>
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND B.CLNT_NM LIKE '%'||#{clntNm}||'%'
              </if>
              <if test="ordrsNo !=null and !ordrsNo.equals('')">
     	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
              </if>
              <if test="salesCd !=null and !salesCd.equals('')">
     	           AND M.SALES_CD LIKE '%'||#{salesCd}||'%'
              </if>
		         ORDER BY M.CO_CD, M.CTRT_NO DESC, B.CLNT_NM
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>


  <resultMap id="resultInfoMap" type="CamelMap">
      <collection select="selectClmnPlan" property="plans" column="{coCd=CO_CD, ctrtNo=CTRT_NO}" ofType="CamelMap"/>
      <collection select="selectTurnKeySalesCodeList" property="details" column="{coCd=CO_CD, ordrsNo=ORDRS_NO, ctrtNo=CTRT_NO}" ofType="CamelMap"/>
  </resultMap>
  <select id="selectContractInfo" parameterType="map" resultMap="resultInfoMap">
          SELECT M.FILE_TRGT_KEY
				, M.CO_CD
				, FN_CM05M01_CD_TO_NM(M.CO_CD) AS CO_CD_NM
				, M.CTRT_NO
				, M.CLNT_CD  				AS VEND_CD	--공급사
				, B.CLNT_NM  				AS VEND_NM	--공급사명
				, C.ORDRS_CLNT_CD 			AS CLNT_CD	--수주고객사
				, D.CLNT_NM								--수주고객사명
				, M.ORDRS_CO_CD							--수주회사코드
				, M.ORDRS_NO							--수주번호
				, C.CLNT_PJT							--고객사프로젝트
				, FN_CM05M01_CD_TO_NM(C.CLNT_PJT) AS CLNT_PJT_NM
				, M.CTRT_NM								--외주계약명
				, TO_CHAR(M.CTRT_DT, 'YYYY-MM-DD') AS CTRT_DT
				, M.CTRT_AMT
				, M.CTRT_ITEMS
				, M.CTRT_PMNT_MTD_CD
				, FN_CM05M01_CD_TO_NM(M.CTRT_PMNT_MTD_CD) AS CTRT_PMNT_MTD_CD_NM
				, M.CTRT_CLMN_DIV_CD
				, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_DIV_CD) AS CTRT_CLMN_DIV_CD_NM
				, M.CTRT_CLMN_DAY
				, M.CTRT_CLMN_VAT
				, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_VAT) AS CTRT_CLMN_VAT_NM
				, TO_CHAR(M.CTRT_ORDRS_DT, 'YYYY-MM-DD') AS CTRT_ORDRS_DT
				, TO_CHAR(M.CTRT_PFMC_DT, 'YYYY-MM-DD') AS CTRT_PFMC_DT
				, TO_CHAR(M.CTRT_BF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_BF_PFMC_DT
				, TO_CHAR(M.CTRT_AF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_AF_PFMC_DT
				, M.CURR_CD
				, FN_CM05M01_CD_TO_NM(M.CURR_CD) AS CURR_CD_NM
				, M.EXRATE
				, M.MNG_ID
				, (SELECT FN_CM06M01_ID_TO_NM(M.MNG_ID) FROM DUAL) MNG_ID_NM
				, M.CTRT_RMK
				, M.ETC_FIELD1
				, M.ETC_FIELD2
				, M.ETC_FIELD3
				, (SELECT FN_CM06M01_ID_TO_NM(M.CREAT_ID) FROM DUAL) CREAT_ID_NM
				, M.CREAT_PGM
				, TO_CHAR(M.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
				, M.UDT_ID
				, (SELECT FN_CM06M01_ID_TO_NM(M.UDT_ID) FROM DUAL) UDT_ID_NM
				, M.UDT_PGM
				, TO_CHAR(M.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
		FROM TB_SM11M01 M
				LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
				LEFT OUTER JOIN TB_CR02M01 C ON C.CO_CD = M.ORDRS_CO_CD
				                            AND C.ORDRS_NO = M.ORDRS_NO
				LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
       WHERE M.CTRT_NO = #{ctrtNo}
  </select>
  

  <select id="selectClmnPlan" parameterType="map" resultType="CamelMap">
	SELECT TO_CHAR(T.CLMN_DT, 'YYYY-MM-DD')      							AS CLMN_DT
	     , TO_CHAR(T.BILL_PBLS_DT, 'YYYY-MM-DD') 							AS BILL_PBLS_DT
		 , 0 				AS 매입확정합계
		 , 0				AS 세금계산서합계
		 , 0				AS 지급합계
		 , T.*
       FROM  TB_SM11D01 T
	  WHERE  1 = 1
		AND  CTRT_NO = #{ctrtNo}
  </select>
	

  <select id="selectTurnKeySalesCodeList" parameterType="Map" resultType="camelMap">
  /* selectTurnKeySalesCodeList */
            SELECT 
                 X.CO_CD, -- 회사코드
                 FN_CM05M01_CD_TO_NM(X.CO_CD) 			AS CO_CD_NM,
                 X.ORDRS_NO, -- 수주번호
                 X.SALES_CD, -- SALES CODE
                 NVL2(D.SALES_CD, 'Y', 'N') 			AS CHK_SAVE_CD, 
                 Y.ORGN_SALES_CD, -- 원천 SALES CODE
                 Y.ORDRS_CLNT_CD, -- 고객사
                 A.CLNT_NM  							AS ORDRS_CLNT_NM,
                 Y.CLNT_PJT, -- 고객사 PJT
                 FN_CM05M01_CD_TO_NM(Y.CLNT_PJT) 		AS CLNT_PJT_NM, -- 고객사 PJT명
                 X.ORDRS_DTL_DIV20, -- 신작구분
                 FN_CM05M01_CD_TO_NM(X.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                 X.PRDT_CD, -- 제품구분
                 P.PRDT_NM  PRDT_CD_NM,
                 X.ITEM_DIV, -- 아이템구분
                 FN_CM05M01_CD_TO_NM(X.ITEM_DIV) ITEM_DIV_NM,
                 X.EQP_NM -- 설비명
            FROM TB_CR02D02 X
                  INNER JOIN TB_CR02M01 Y  ON X.CO_CD = Y.CO_CD
                                          AND X.ORDRS_NO = Y.ORDRS_NO
                  LEFT OUTER JOIN TB_BM01M01 P ON X.PRDT_CD = P.PRDT_CD  --제품마스터
                  LEFT OUTER JOIN TB_BM02M01 A ON Y.ORDRS_CLNT_CD = A.CLNT_CD --거래처마스터
                  LEFT OUTER JOIN TB_SM11D02 D ON X.CO_CD = D.ORDRS_CO_CD 
                  								AND X.ORDRS_NO = D.ORDRS_NO 
                  								AND X.SALES_CD = D.SALES_CD
                  								AND D.CTRT_NO  = #{ctrtNo}
          WHERE X.CO_CD = #{coCd}
            AND X.ORDRS_NO = #{ordrsNo}                
            AND X.SALES_CD IS NOT NULL
          ORDER BY X.ORDRS_NO, X.SALES_CD
  </select>
	
  <select id="selectContractSeqNext" parameterType="Map" resultType="int">
	 SELECT NVL(max(FILE_TRGT_KEY),0) + 1
	  FROM  TB_SM11M01
  </select>
  
  
  <insert id="insertContract" parameterType="Map">
    <selectKey keyProperty="ctrtNo" resultType="String" order="BEFORE">
      SELECT 'CTRT' || TO_CHAR(SYSDATE, 'YY')||LPAD(TB_SM11M01_SQ01.NEXTVAL,4,0) FROM DUAL
    </selectKey>
    INSERT INTO TB_SM11M01
      (
		  FILE_TRGT_KEY
		, CO_CD
		, CTRT_NO
		, CLNT_CD
		, ORDRS_CO_CD
		, ORDRS_NO
		, CTRT_NM
		, CTRT_DT
		, CTRT_AMT
		, CTRT_ITEMS
		, CTRT_PMNT_MTD_CD
		, CTRT_CLMN_DIV_CD
		, CTRT_CLMN_DAY
		, CTRT_CLMN_VAT
		, CTRT_ORDRS_DT
		, CTRT_PFMC_DT
		, CTRT_BF_PFMC_DT
		, CTRT_AF_PFMC_DT
		, CURR_CD
		, EXRATE
		, MNG_ID
		, CTRT_RMK
		, ETC_FIELD1
		, ETC_FIELD2
		, ETC_FIELD3
		, CREAT_ID
		, CREAT_PGM
		, CREAT_DTTM
      )
    VALUES
    (
		  #{fileTrgtKey}
		, #{coCd}
		, #{ctrtNo}
		, #{vendCd}
		, #{ordrsCoCd, jdbcType=VARCHAR}
		, #{ordrsNo, jdbcType=VARCHAR}
		, #{ctrtNm, jdbcType=VARCHAR}
		, #{ctrtDt}
		, #{ctrtAmt}
		, #{ctrtItems}
		, #{ctrtPmntMtdCd}
		, #{ctrtClmnDivCd}
		, #{ctrtClmnDay}
		, #{ctrtClmnVat}
		, #{ctrtOrdrsDt}
		, #{ctrtPfmcDt}
		, #{ctrtBfPfmcDt}
		, #{ctrtAfPfmcDt}
		, #{currCd}
		, #{exrate}
		, #{mngId, jdbcType=VARCHAR}
		, #{ctrtRmk, jdbcType=VARCHAR}
		, #{etcField1, jdbcType=VARCHAR}
		, #{etcField2, jdbcType=VARCHAR}
		, #{etcField3, jdbcType=VARCHAR}
		, #{userId}
		, #{pgmId}
		, SYSDATE
    )
  </insert>

  <update id="updateContract" parameterType="Map">
    UPDATE TB_SM11M01
		SET
			  CLNT_CD                = #{vendCd, jdbcType=VARCHAR}
			, ORDRS_CO_CD            = #{ordrsCoCd, jdbcType=VARCHAR}
			, ORDRS_NO               = #{ordrsNo, jdbcType=VARCHAR}
			, CTRT_NM                = #{ctrtNm, jdbcType=VARCHAR}
			, CTRT_DT                = #{ctrtDt}
			, CTRT_AMT               = #{ctrtAmt}
			, CTRT_ITEMS             = #{ctrtItems, jdbcType=VARCHAR}
			, CTRT_PMNT_MTD_CD       = #{ctrtPmntMtdCd}
			, CTRT_CLMN_DIV_CD       = #{ctrtClmnDivCd}
			, CTRT_CLMN_DAY          = #{ctrtClmnDay}
			, CTRT_CLMN_VAT          = #{ctrtClmnVat}
			, CTRT_ORDRS_DT          = #{ctrtOrdrsDt, jdbcType=VARCHAR}
			, CTRT_PFMC_DT           = #{ctrtPfmcDt, jdbcType=VARCHAR}
			, CTRT_BF_PFMC_DT        = #{ctrtBfPfmcDt, jdbcType=VARCHAR}
			, CTRT_AF_PFMC_DT        = #{ctrtAfPfmcDt, jdbcType=VARCHAR}
			, CURR_CD                = #{currCd}
			, EXRATE                 = #{exrate}
			, MNG_ID                 = #{mngId, jdbcType=VARCHAR}
			, CTRT_RMK               = #{ctrtRmk, jdbcType=VARCHAR}
			, ETC_FIELD1             = #{etcField1, jdbcType=VARCHAR}
			, ETC_FIELD2             = #{etcField2, jdbcType=VARCHAR}
			, ETC_FIELD3             = #{etcField3, jdbcType=VARCHAR}
			, UDT_ID                 = #{userId}
			, UDT_PGM                = #{pgmId}
			, UDT_DTTM               = SYSDATE
    WHERE FILE_TRGT_KEY         = #{ctrtNo}
  </update>
  
  <delete id="deleteContract" parameterType="Map">
    DELETE TB_SM11M01 WHERE FILE_TRGT_KEY = #{ctrtNo}
  </delete>
  
  
  <insert id="insertTurnKeyDetail" parameterType="Map">
    INSERT INTO TB_SM11D02
      (
		CTRT_NO,
		CTRT_NO_SEQ,
		ORDRS_CO_CD,
		ORDRS_NO,
		SALES_CD,
		CTRT_RMK,
		CREAT_ID,       
		CREAT_PGM,      
		CREAT_DTTM
      )
    VALUES
    (
		#{ctrtNo},
		(SELECT NVL(max(CTRT_NO_SEQ),0)+1 FROM TB_SM11D02 WHERE CTRT_NO = #{ctrtNo}),
		#{ordrsCoCd},
		#{ordrsNo},
		#{salesCd},
		#{ctrtRmk,  jdbcType=VARCHAR},
		#{userId},
		#{pgmId},
		SYSDATE
    )
  </insert>
  			
  <delete id="deleteTurnKeyDetail" parameterType="Map">
    DELETE TB_SM11D02
     WHERE CTRT_NO = #{ctrtNo}
  </delete>
  
    
    <insert id="insertTurnKeyClmnPlan" parameterType="map">
        INSERT INTO TB_SM11D01
            (
             CTRT_NO, 
             CTRT_NO_SEQ, 
             CLMN_PLAN_DIV, 
             CLMN_DIV_SEQ, 
             CLMN_RATE, 
             CLMN_AMT,
             BILL_PBLS_DT, 
             CLMN_DT, 
             PMNT_DT_AFTER_BILL,
             CLMN_PLAN_RMK, 
             CLMN_MGMT_STATUS,
             CREAT_ID,
             CREAT_PGM,
             CREAT_DTTM
             )
        VALUES
            (
             #{ctrtNo}, 
			 (SELECT NVL(max(CTRT_NO_SEQ),0)+1 FROM TB_SM11D01 WHERE CTRT_NO = #{ctrtNo}),
             #{clmnPlanDiv}, 
             #{clmnDivSeq}, 
             #{clmnRate},
             #{clmnAmt}, 
             #{billPblsDt, jdbcType=VARCHAR}, 
             #{clmnDt, jdbcType=VARCHAR},
             #{pmntDtAfterBill, jdbcType=VARCHAR}, 
             #{clmnPlanRmk, jdbcType=VARCHAR}, 
             #{clmnMgmtStatus, jdbcType=VARCHAR},
             #{userId},
			 #{pgmId},
			 SYSDATE
             )
    </insert>
    
    
    <update id="updateTurnKeyClmnPlan" parameterType="map">
        UPDATE TB_SM11D01
        SET CLMN_PLAN_DIV      = #{clmnPlanDiv}, -- 수금구분
            CLMN_DIV_SEQ       = #{clmnDivSeq},  -- 수금계획순번
            CLMN_RATE          = #{clmnRate},    -- 수금비율
            CLMN_AMT           = #{clmnAmt},     -- 수금금액
            BILL_PBLS_DT       = #{billPblsDt, jdbcType=VARCHAR},  -- 계산서발행일자
            CLMN_DT            = #{clmnDt, jdbcType=VARCHAR},      -- 수금일자
            PMNT_DT_AFTER_BILL = #{pmntDtAfterBill, jdbcType=VARCHAR}, -- 계산서 발행 후 지급시기
            CLMN_PLAN_RMK      = #{clmnPlanRmk, jdbcType=VARCHAR},      -- 비고
            CLMN_MGMT_STATUS   = #{clmnMgmtStatus, jdbcType=VARCHAR}, -- 수금관리상황
            UDT_ID   		   = #{userId},
            UDT_PGM			   = #{pgmId},
            UDT_DTTM		   = SYSDATE
        WHERE CTRT_NO = #{ctrtNo}
          AND CTRT_NO_SEQ = #{ctrtNoSeq}
    </update>
    
    <delete id="deleteTurnKeyClmnPlan">
        DELETE
        FROM TB_SM11D01
        WHERE 1 = 1
          AND CTRT_NO = #{ctrtNo}
    </delete>

    <delete id="deleteTurnKeyClmnPlanEx">
        DELETE
        FROM TB_SM11D01
        WHERE 1 = 1
          AND CTRT_NO = #{ctrtNo}
          AND CTRT_NO_SEQ = #{ctrtNoSeq}
    </delete>
        
</mapper>