<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sm.sm11.mapper.SM11Mapper">

	<select id="selectContractCount" parameterType="Map" resultType="int">
	 	WITH CT AS (
		 		SELECT M.*
		 				, B.CLNT_NM
		 		  FROM TB_SM11M01 M
						LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
						LEFT OUTER JOIN (
										SELECT MM.CTRT_NO, MM.ORDRS_CO_CD, MM.SALES_CD
										  FROM TB_SM11D02 MM
										 WHERE MM.CTRT_NO_SEQ = (SELECT min(CTRT_NO_SEQ) FROM TB_SM11D02 D WHERE D.CTRT_NO = MM.CTRT_NO)
										 GROUP BY MM.CTRT_NO, MM.ORDRS_CO_CD, MM.SALES_CD
										) AS MD ON MD.CTRT_NO = M.CTRT_NO
						LEFT OUTER JOIN TB_CR02D02 CR ON CR.SALES_CD = MD.SALES_CD
						LEFT OUTER JOIN TB_CR02M01 CM ON CM.CO_CD    = CR.CO_CD
						                             AND CM.ORDRS_NO = CR.ORDRS_NO
						LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = CM.ORDRS_CLNT_CD
						LEFT OUTER JOIN TB_CM06M01 U ON U.ID = M.MNG_ID
						LEFT OUTER JOIN TB_CM04M01 CD ON CD.DEPT_ID = SUBSTRING(U.DEPT_ID,0,5)
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND M.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND M.CTRT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD')
			  </if>
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND M.CLNT_CD = #{clntCd}
              </if>
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND B.CLNT_NM LIKE '%'||#{clntNm}||'%'
              </if>
              <if test="ordrsNo !=null and !ordrsNo.equals('')">
     	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
              </if>
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND D.CLNT_NM LIKE '%'||#{vendNm}||'%'
              </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND  CM.ORDRS_CLNT_CD = #{vendCd}
              </if>
              <if test="mngId !=null and !mngId.equals('')">
     	           AND  M.MNG_ID = #{mngId}
              </if>
              <if test="mngIdNm !=null and !mngIdNm.equals('')">
     	           AND U.NAME LIKE '%'||#{mngIdNm}||'%'
              </if>
	          <if test="deptNm !=null and !deptNm.equals('')">
		           AND CD.DEPT_NM LIKE '%'||#{deptNm}||'%'
	          </if>
	 			)
	 	, PAY AS (
			 	SELECT R.CTRT_NO
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',COST_AMT))  		AS PAY_AMT11	--매입금액
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',COST_DT)), 'MM-DD')   		AS PAY_DT11		--매입일자
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',PAY_DIV_DT))   	AS PAY_TX_DT11 	--세금계산서발행
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',COST_AMT))  		AS PAY_AMT12
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',COST_DT)), 'MM-DD')   		AS PAY_DT12
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',PAY_DIV_DT))   	AS PAY_TX_DT12
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',COST_AMT))  		AS PAY_AMT13
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',COST_DT)), 'MM-DD')   		AS PAY_DT13
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',PAY_DIV_DT))   	AS PAY_TX_DT13
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',COST_AMT))  		AS PAY_AMT14
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',COST_DT)), 'MM-DD')   		AS PAY_DT14
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',PAY_DIV_DT))   	AS PAY_TX_DT14
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(R.COST_AMT)												AS PAY_AMT19
				FROM TB_SM10M01 R
				WHERE 1 = 1
				  AND EXISTS (SELECT 1 FROM CT WHERE  R.CTRT_NO = CT.CTRT_NO)
				GROUP BY R.CTRT_NO
	 		)
		SELECT
            count(*)
		FROM  CT M
				LEFT OUTER JOIN PAY  ON PAY.CTRT_NO = M.CTRT_NO				--지급실적
         WHERE 1=1
         <if test="cmpletYn !=null and !cmpletYn.equals('')">
   	       AND ((M.CTRT_AMT - NVL(PAY_AMT19, 0) = 0 AND #{cmpletYn} = 'Y')
   	        OR (M.CTRT_AMT - NVL(PAY_AMT19, 0) != 0 AND #{cmpletYn} = 'N'))
	     </if>

	</select>

	<select id="selectContractList" parameterType="Map" resultType="CamelMap">
	/* selectContractList */
	 WITH CT AS (
		 		SELECT 
						  M.CLNT_CD  				AS VEND_CD	--공급사
						, B.CLNT_NM  				AS VEND_NM	--공급사명
						, CM.ORDRS_CLNT_CD 			AS CUST_CD	--수주고객사
						, D.CLNT_NM					AS CUST_NM  --수주고객사명
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM01%' THEN 'Y' ELSE 'N' END AS FLAG1
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM02%' THEN 'Y' ELSE 'N' END AS FLAG2
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM03%' THEN 'Y' ELSE 'N' END AS FLAG3
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM04%' THEN 'Y' ELSE 'N' END AS FLAG4
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM05%' THEN 'Y' ELSE 'N' END AS FLAG5
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM06%' THEN 'Y' ELSE 'N' END AS FLAG6
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM07%' THEN 'Y' ELSE 'N' END AS FLAG7
		 				, CASE WHEN M.CTRT_ITEMS LIKE '%CTRITEM99%' THEN 'Y' ELSE 'N' END AS FLAG9
		 				, B.CLNT_NM
		 				, NVL(CR.EQP_NM, CM.CTRT_NM) AS EQP_NM			--수주상세 설비명
		 				, CR.ORDRS_QTY		--수주상세 대수
						, CM.CLNT_PJT							--고객사프로젝트
						, M.*
						, SUBSTRING(U.DEPT_ID,0,5) 	 	 AS DEPT_ID
						, CD.DEPT_NM					 AS DEPT_ID_NM
						, U.NAME 						 AS MNG_ID_NM
						, (SELECT LISTAGG(SALES_CD, ',') WITHIN GROUP (ORDER BY SALES_CD) AS TRG_SALES_CD
							 FROM TB_SM11D02
							 WHERE CTRT_NO = M.CTRT_NO
							) AS TRG_SALES_CD
		 		  FROM TB_SM11M01 M
						LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
						LEFT OUTER JOIN (
										SELECT MM.CTRT_NO, MM.ORDRS_CO_CD, MM.SALES_CD
										  FROM TB_SM11D02 MM
										 WHERE MM.CTRT_NO_SEQ = (SELECT min(CTRT_NO_SEQ) FROM TB_SM11D02 D WHERE D.CTRT_NO = MM.CTRT_NO)
										 GROUP BY MM.CTRT_NO, MM.ORDRS_CO_CD, MM.SALES_CD
										) AS MD ON MD.CTRT_NO = M.CTRT_NO
						LEFT OUTER JOIN TB_CR02D02 CR ON CR.SALES_CD = MD.SALES_CD
						LEFT OUTER JOIN TB_CR02M01 CM ON CM.CO_CD    = M.ORDRS_CO_CD
						                             AND CM.ORDRS_NO = M.ORDRS_NO
						LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = CM.ORDRS_CLNT_CD
						LEFT OUTER JOIN TB_CM06M01 U ON U.ID = M.MNG_ID
						LEFT OUTER JOIN TB_CM04M01 CD ON CD.DEPT_ID = SUBSTRING(U.DEPT_ID,0,5)
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND M.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND M.CTRT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD')
			  </if>
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND M.CLNT_CD = #{clntCd}
              </if>
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND B.CLNT_NM LIKE '%'||#{clntNm}||'%'
              </if>
              <if test="ordrsNo !=null and !ordrsNo.equals('')">
     	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
              </if>
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND D.CLNT_NM LIKE '%'||#{vendNm}||'%'
              </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND  CM.ORDRS_CLNT_CD = #{vendCd}
              </if>
              <if test="mngId !=null and !mngId.equals('')">
     	           AND  M.MNG_ID = #{mngId}
              </if>
              <if test="mngIdNm !=null and !mngIdNm.equals('')">
     	           AND U.NAME LIKE '%'||#{mngIdNm}||'%'
              </if>
	          <if test="deptNm !=null and !deptNm.equals('')">
		           AND CD.DEPT_NM LIKE '%'||#{deptNm}||'%'
	          </if>
	 			)
	 	, PLAN AS (
					SELECT   
					         CTRT_NO
						   , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2010',CLMN_RATE)) AS PLAN_YUL1
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2010',CLMN_AMT))  AS PLAN_AMT1
					       , MAX(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2010',CLMN_DT))   AS PLAN_DT1
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2020',CLMN_RATE)) AS PLAN_YUL2
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2020',CLMN_AMT))  AS PLAN_AMT2
					       , MAX(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2020',CLMN_DT))   AS PLAN_DT2
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2030',CLMN_RATE)) AS PLAN_YUL3
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2030',CLMN_AMT))  AS PLAN_AMT3
					       , MAX(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2030',CLMN_DT))   AS PLAN_DT3
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2040',CLMN_RATE)) AS PLAN_YUL4
					       , SUM(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2040',CLMN_AMT))  AS PLAN_AMT4
					       , MAX(decode(CLMN_PLAN_DIV,'PCHSCOSTDIV2040',CLMN_DT))   AS PLAN_DT4
					       , SUM(CLMN_AMT) 											AS PLAN_AMT9
					FROM TB_SM11D01 P
					WHERE 1 = 1
					  AND EXISTS (SELECT 1 FROM CT WHERE  P.CTRT_NO = CT.CTRT_NO)
					GROUP BY P.CTRT_NO
	 			)
	 	, PAY AS (
			 	SELECT R.CTRT_NO
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',COST_AMT))  		AS PAY_AMT11	--매입금액
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',COST_DT)), 'MM-DD')   		AS PAY_DT11		--매입일자
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',PAY_DIV_DT))   	AS PAY_TX_DT11 	--세금계산서발행
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2010',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',COST_AMT))  		AS PAY_AMT12
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',COST_DT)), 'MM-DD')   		AS PAY_DT12
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',PAY_DIV_DT))   	AS PAY_TX_DT12
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2020',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',COST_AMT))  		AS PAY_AMT13
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',COST_DT)), 'MM-DD')   		AS PAY_DT13
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',PAY_DIV_DT))   	AS PAY_TX_DT13
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2030',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',COST_AMT))  		AS PAY_AMT14
						, TO_CHAR(MAX(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',COST_DT)), 'MM-DD')   		AS PAY_DT14
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',PAY_DIV_DT))   	AS PAY_TX_DT14
						, MIN(decode(PCHS_COST_DIV20,'PCHSCOSTDIV2040',PCHS_NO))   		AS PAY_CF_NO11 	--매입확정번호
						, SUM(R.COST_AMT)												AS PAY_AMT19
				FROM TB_SM10M01 R
				WHERE 1 = 1
				  AND EXISTS (SELECT 1 FROM CT WHERE  R.CTRT_NO = CT.CTRT_NO)
				GROUP BY R.CTRT_NO
	 		)
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(SELECT 	  M.FILE_TRGT_KEY
						, M.CO_CD
						, FN_CM05M01_CD_TO_NM(M.CO_CD) 	AS CO_CD_NM
						, M.DEPT_ID 	 	 			AS DEPT_ID
						, M.DEPT_ID_NM					AS DEPT_ID_NM
						, M.MNG_ID_NM 					AS MNG_ID_NM
						, M.CTRT_NO
						, M.VEND_CD	--공급사
						, M.VEND_NM	--공급사명
						, M.CUST_CD AS CLNT_CD	--수주고객사
						, M.CUST_NM AS CLNT_NM					--수주고객사명
						, M.ORDRS_CO_CD							--수주회사코드
						, M.ORDRS_NO							--수주번호
						, M.CLNT_PJT							--고객사프로젝트
						, FN_CM05M01_CD_TO_NM(M.CLNT_PJT) AS CLNT_PJT_NM
						, M.CTRT_NM								--외주계약명
						, TO_CHAR(M.CTRT_DT, 'YYYY-MM-DD') AS CTRT_DT
						, M.CTRT_AMT
						, M.CTRT_ITEMS		--외주계약 품목
						, M.CTRT_PMNT_MTD_CD
						, FN_CM05M01_CD_TO_NM(M.CTRT_PMNT_MTD_CD) AS CTRT_PMNT_MTD_CD_NM
						, M.CTRT_CLMN_DIV_CD
						, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_DIV_CD) AS CTRT_CLMN_DIV_CD_NM
						, M.CTRT_CLMN_DAY
						, M.CTRT_CLMN_VAT
						, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_VAT) AS CTRT_CLMN_VAT_NM
						, TO_CHAR(M.CTRT_ORDRS_DT, 'YYYY-MM-DD') AS CTRT_ORDRS_DT
						, TO_CHAR(M.CTRT_PFMC_DT, 'YYYY-MM-DD') AS CTRT_PFMC_DT
						, TO_CHAR(M.CTRT_BF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_BF_PFMC_DT
						, TO_CHAR(M.CTRT_AF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_AF_PFMC_DT
						, M.CURR_CD
						, FN_CM05M01_CD_TO_NM(M.CURR_CD) AS CURR_CD_NM
						, M.EXRATE
						, M.CTRT_RMK
						, M.ETC_FIELD1
						, M.ETC_FIELD2
						, M.ETC_FIELD3
						, M.CREAT_ID
						, (SELECT FN_CM06M01_ID_TO_NM(M.CREAT_ID) FROM DUAL) CREAT_ID_NM
						, M.CREAT_PGM
						, TO_CHAR(M.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
						, M.UDT_ID
						, (SELECT FN_CM06M01_ID_TO_NM(M.UDT_ID) FROM DUAL) UDT_ID_NM
						, M.UDT_PGM
						, TO_CHAR(M.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
						, TO_CHAR(M.DUDT_INTEND_DT, 'YYYY-MM-DD') 		AS DUDT_INTEND_DT	--납기일자
						, M.CTRT_AMT - NVL(PAY_AMT19, 0) 			AS REM_AMT	--미지급금액
						, M.FLAG1
						, M.FLAG2
						, M.FLAG3
						, M.FLAG4
						, M.FLAG5
						, M.FLAG6
						, M.FLAG9
		 				, M.EQP_NM			--수주상세 설비명
		 				, M.ORDRS_QTY		--수주상세 대수
				        , M.VEND_MNG_NM
				        , M.VEND_TEL_NO
				        , M.VEND_FAX_NO
				        , M.VEND_HP_NO
				        , M.VEND_MNG_MAIL
						, PLAN.*
						, PAY.*
						, M.TRG_SALES_CD
						, M.REQ_NO
				        , M.CTRT_TOT_AMT
				        , M.CTRT_NEGO_AMT
				        , M.CTRT_ORDRS_QTY
				FROM CT M
						LEFT OUTER JOIN PLAN ON PLAN.CTRT_NO = M.CTRT_NO			--지급계획
						LEFT OUTER JOIN PAY  ON PAY.CTRT_NO = M.CTRT_NO				--지급실적
		         WHERE 1=1
              	 <if test="cmpletYn !=null and !cmpletYn.equals('')">
     	          AND ((M.CTRT_AMT - NVL(PAY_AMT19, 0) = 0 AND #{cmpletYn} = 'Y')
     	           OR (M.CTRT_AMT - NVL(PAY_AMT19, 0) != 0 AND #{cmpletYn} = 'N'))
		         </if>
		         ORDER BY M.CO_CD, M.CTRT_DT DESC, M.CTRT_NO DESC, M.DEPT_ID_NM, M.CLNT_NM
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>


  <resultMap id="resultInfoMap" type="CamelMap">
      <collection select="selectClmnPlan" property="plans" column="{coCd=CO_CD, ctrtNo=CTRT_NO}" ofType="CamelMap"/>
      <collection select="selectTurnKeySalesCodeList" property="details" column="{coCd=CO_CD, ordrsNo=ORDRS_NO, ctrtNo=CTRT_NO}" ofType="CamelMap"/>
  </resultMap>
  <select id="selectContractInfo" parameterType="map" resultMap="resultInfoMap">
          SELECT M.FILE_TRGT_KEY
				, M.CO_CD
				, FN_CM05M01_CD_TO_NM(M.CO_CD) AS CO_CD_NM
				, M.CTRT_NO
				, M.CLNT_CD  				AS VEND_CD	--공급사
				, B.CLNT_NM  				AS VEND_NM	--공급사명
				, C.ORDRS_CLNT_CD 			AS CLNT_CD	--수주고객사
				, D.CLNT_NM								--수주고객사명
				, M.ORDRS_CO_CD							--수주회사코드
				, M.ORDRS_NO							--수주번호
				, C.CLNT_PJT							--고객사프로젝트
				, FN_CM05M01_CD_TO_NM(C.CLNT_PJT) AS CLNT_PJT_NM
				, M.CTRT_NM								--외주계약명
				, TO_CHAR(M.CTRT_DT, 'YYYY-MM-DD') AS CTRT_DT
				, M.CTRT_AMT
				, M.CTRT_ITEMS
				, M.CTRT_PMNT_MTD_CD
				, FN_CM05M01_CD_TO_NM(M.CTRT_PMNT_MTD_CD) AS CTRT_PMNT_MTD_CD_NM
				, M.CTRT_CLMN_DIV_CD
				, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_DIV_CD) AS CTRT_CLMN_DIV_CD_NM
				, M.CTRT_CLMN_DAY
				, M.CTRT_CLMN_VAT
				, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_VAT) AS CTRT_CLMN_VAT_NM
				, TO_CHAR(M.CTRT_ORDRS_DT, 'YYYY-MM-DD') AS CTRT_ORDRS_DT
				, TO_CHAR(M.CTRT_PFMC_DT, 'YYYY-MM-DD') AS CTRT_PFMC_DT
				, TO_CHAR(M.CTRT_BF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_BF_PFMC_DT
				, TO_CHAR(M.CTRT_AF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_AF_PFMC_DT
				, M.CURR_CD
				, FN_CM05M01_CD_TO_NM(M.CURR_CD) AS CURR_CD_NM
				, M.EXRATE
				, M.MNG_ID
				, (SELECT FN_CM06M01_ID_TO_NM(M.MNG_ID) FROM DUAL) MNG_ID_NM
				, M.CTRT_RMK
				, M.ETC_FIELD1
				, M.ETC_FIELD2
				, M.ETC_FIELD3
				, (SELECT FN_CM06M01_ID_TO_NM(M.CREAT_ID) FROM DUAL) CREAT_ID_NM
				, M.CREAT_PGM
				, TO_CHAR(M.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
				, M.UDT_ID
				, (SELECT FN_CM06M01_ID_TO_NM(M.UDT_ID) FROM DUAL) UDT_ID_NM
				, M.UDT_PGM
				, TO_CHAR(M.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
				, TO_CHAR(M.DUDT_INTEND_DT, 'YYYY-MM-DD') 		AS DUDT_INTEND_DT	--납기일자
		        , M.VEND_MNG_NM
		        , M.VEND_TEL_NO
		        , M.VEND_FAX_NO
		        , M.VEND_HP_NO
		        , M.VEND_MNG_MAIL
		        , M.REQ_NO
		        , M.CTRT_TOT_AMT
		        , M.CTRT_NEGO_AMT
		        , M.CTRT_ORDRS_QTY
		FROM TB_SM11M01 M
				LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
				LEFT OUTER JOIN TB_CR02M01 C ON C.CO_CD = M.ORDRS_CO_CD
				                            AND C.ORDRS_NO = M.ORDRS_NO
				LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
       WHERE M.CTRT_NO = #{ctrtNo}
  </select>
  

  <select id="selectClmnPlan" parameterType="map" resultType="CamelMap">
	SELECT    TO_CHAR(P.CLMN_DT, 'YYYY-MM-DD')      							AS CLMN_DT
		    , TO_CHAR(P.BILL_PBLS_DT, 'YYYY-MM-DD') 						AS BILL_PBLS_DT
			, R.COST_NO
			, TO_CHAR(R.COST_DT, 'YYYY-MM-DD') AS COST_DT
			, FN_CM05M01_CD_TO_NM(R.PCHS_COST_DIV20) 	AS PCHS_COST_DIV20_NM
			, R.COST_AMT  								AS 매입등록금액	
			, TO_CHAR(R.PAY_DIV_DT, 'YYYY-MM-DD')   	AS PAY_DIV_DT
			, R.PCHS_NO
			, RD.PCHS_AMT   							AS 매입확정금액		--확정금액
			, decode(RD.CMPLET_YN,'Y',RD.PCHS_AMT,0 )	AS 지급금액		--지급금액
			, decode(RD.CMPLET_YN,'Y',(P.CLMN_AMT-RD.PCHS_AMT), P.CLMN_AMT ) AS 미지급잔액		--미지급금
			, DECODE(R.COST_NO,'','N','Y')				AS CREATE_YN	--매입생성완료
			, DECODE(RD.PCHS_NO,'','N','Y')				AS CONF_YN		--매입확정완료
			, NVL(RD.BILL_YN,'N')						AS BILL_YN		--계산서처리완료
			, P.*
	   FROM TB_SM11D01 P
			LEFT OUTER JOIN TB_SM11M01 M ON P.CTRT_NO  = M.CTRT_NO  
			LEFT OUTER JOIN TB_SM10M01 R ON R.CTRT_NO = P.CTRT_NO
			                            AND R.CTRT_NO_SEQ = P.CTRT_NO_SEQ
			LEFT OUTER JOIN TB_SM12D01 RD ON RD.ORDRG_NO = R.COST_NO
	  WHERE  1 = 1
		AND  P.CTRT_NO = #{ctrtNo}
	  ORDER BY P.CTRT_NO, P.CLMN_PLAN_DIV, P.CTRT_NO_SEQ
  </select>
	

  <select id="selectTurnKeySalesCodeList" parameterType="Map" resultType="camelMap">
  /* selectTurnKeySalesCodeList */
            SELECT 
                 X.CO_CD, -- 회사코드
                 FN_CM05M01_CD_TO_NM(X.CO_CD) 			AS CO_CD_NM,
                 X.ORDRS_NO, -- 수주번호
                 X.SALES_CD, -- SALES CODE
                 CASE WHEN NVL(D.ORDRS_AMT, 0) != 0 THEN  'Y' ELSE 'N' END 			AS CHK_SAVE_CD, 
                 Y.ORGN_SALES_CD, -- 원천 SALES CODE
                 Y.ORDRS_CLNT_CD, -- 고객사
                 A.CLNT_NM  							AS ORDRS_CLNT_NM,
                 Y.CLNT_PJT, -- 고객사 PJT
                 FN_CM05M01_CD_TO_NM(Y.CLNT_PJT) 		AS CLNT_PJT_NM, -- 고객사 PJT명
                 X.ORDRS_DTL_DIV20, -- 신작구분
                 FN_CM05M01_CD_TO_NM(X.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                 X.PRDT_CD, -- 제품구분
                 P.PRDT_NM  PRDT_CD_NM,
                 X.ITEM_DIV, -- 아이템구분
                 FN_CM05M01_CD_TO_NM(X.ITEM_DIV) ITEM_DIV_NM,
                 X.EQP_NM,	 -- 설비명
                 X.ORDRS_QTY AS SALES_ORDRS_QTY, 
                 D.CTRT_RMK, 
                 D.ORDRS_AMT,
                 D.ORDRS_QTY, 
                 X.ORDRS_SEQ  -- SALES SEQ
            FROM TB_CR02D02 X
                  INNER JOIN TB_CR02M01 Y  ON X.CO_CD = Y.CO_CD
                                          AND X.ORDRS_NO = Y.ORDRS_NO
                  LEFT OUTER JOIN TB_BM01M01 P ON X.PRDT_CD = P.PRDT_CD  --제품마스터
                  LEFT OUTER JOIN TB_BM02M01 A ON Y.ORDRS_CLNT_CD = A.CLNT_CD --거래처마스터
                  LEFT OUTER JOIN TB_SM11D02 D ON X.CO_CD = D.ORDRS_CO_CD 
                  								AND X.ORDRS_NO = D.ORDRS_NO 
                  								AND (X.SALES_CD = D.SALES_CD OR (X.SALES_CD IS NULL AND D.SALES_CD IS NULL))
                  								AND X.ORDRS_SEQ = D.ORDRS_SEQ
                  								AND D.CTRT_NO  = #{ctrtNo}
          WHERE X.CO_CD = #{coCd}
            AND X.ORDRS_NO = #{ordrsNo}                
--            AND X.SALES_CD IS NOT NULL
          ORDER BY X.ORDRS_NO, X.SALES_CD
  </select>
	
  <select id="selectContractSeqNext" parameterType="Map" resultType="int">
	 SELECT NVL(max(TO_NUMBER(FILE_TRGT_KEY)),0) + 1
	  FROM  TB_SM11M01
  </select>
  
  
  <insert id="insertContract" parameterType="Map">
    <selectKey keyProperty="ctrtNo" resultType="String" order="BEFORE">
      SELECT 'CTRT' || TO_CHAR(SYSDATE, 'YY')||LPAD(TB_SM11M01_SQ01.NEXTVAL,4,0) FROM DUAL
    </selectKey>
    INSERT INTO TB_SM11M01
      (
		  FILE_TRGT_KEY
		, CO_CD
		, CTRT_NO
		, CLNT_CD
		, ORDRS_CO_CD
		, ORDRS_NO
		, CTRT_NM
		, CTRT_DT
		, CTRT_AMT
		, CTRT_ITEMS
		, CTRT_PMNT_MTD_CD
		, CTRT_CLMN_DIV_CD
		, CTRT_CLMN_DAY
		, CTRT_CLMN_VAT
		, CTRT_ORDRS_DT
		, CTRT_PFMC_DT
		, CTRT_BF_PFMC_DT
		, CTRT_AF_PFMC_DT
		, CURR_CD
		, EXRATE
		, MNG_ID
		, CTRT_RMK
		, ETC_FIELD1
		, ETC_FIELD2
		, ETC_FIELD3
		, CREAT_ID
		, CREAT_PGM
		, CREAT_DTTM
		, DUDT_INTEND_DT
        , VEND_MNG_NM
        , VEND_TEL_NO
        , VEND_FAX_NO
        , VEND_HP_NO
        , VEND_MNG_MAIL
        , REQ_NO
        , CTRT_TOT_AMT
        , CTRT_NEGO_AMT
        , CTRT_ORDRS_QTY
      )
    VALUES
    (
		  #{fileTrgtKey}
		, #{coCd}
		, #{ctrtNo}
		, #{vendCd}
		, #{ordrsCoCd, jdbcType=VARCHAR}
		, #{ordrsNo, jdbcType=VARCHAR}
		, #{ctrtNm, jdbcType=VARCHAR}
		, #{ctrtDt}
		, #{ctrtAmt}
		, #{ctrtItems}
		, #{ctrtPmntMtdCd}
		, #{ctrtClmnDivCd}
		, #{ctrtClmnDay}
		, #{ctrtClmnVat}
		, #{ctrtOrdrsDt}
		, #{ctrtPfmcDt}
		, #{ctrtBfPfmcDt}
		, #{ctrtAfPfmcDt}
		, #{currCd}
		, #{exrate}
		, #{mngId, jdbcType=VARCHAR}
		, #{ctrtRmk, jdbcType=VARCHAR}
		, #{etcField1, jdbcType=VARCHAR}
		, #{etcField2, jdbcType=VARCHAR}
		, #{etcField3, jdbcType=VARCHAR}
		, #{userId}
		, #{pgmId}
		, SYSDATE
		, #{dudtIntendDt, jdbcType=VARCHAR}
        , #{vendMngNm, jdbcType=VARCHAR} -- 담당자
        , #{vendTelNo, jdbcType=VARCHAR} -- 전화
        , #{vendFaxNo, jdbcType=VARCHAR} -- 팩스
        , #{vendHpNo, jdbcType=VARCHAR} -- 핸드폰
        , #{vendMngMail, jdbcType=VARCHAR} -- 이메일
        , #{reqNo, jdbcType=VARCHAR} -- 발주요청번호
        , #{ctrtTotAmt, jdbcType=VARCHAR} -- 외주총금액
        , #{ctrtNegoAmt, jdbcType=VARCHAR} -- 총nego금액
        , #{ctrtOrdrsQty, jdbcType=VARCHAR} -- 총대수
    )
  </insert>

  <update id="updateContract" parameterType="Map">
    UPDATE TB_SM11M01
		SET
			  CLNT_CD                = #{vendCd, jdbcType=VARCHAR}
			, ORDRS_CO_CD            = #{ordrsCoCd, jdbcType=VARCHAR}
			, ORDRS_NO               = #{ordrsNo, jdbcType=VARCHAR}
			, CTRT_NM                = #{ctrtNm, jdbcType=VARCHAR}
			, CTRT_DT                = #{ctrtDt}
			, CTRT_AMT               = #{ctrtAmt}
			, CTRT_ITEMS             = #{ctrtItems, jdbcType=VARCHAR}
			, CTRT_PMNT_MTD_CD       = #{ctrtPmntMtdCd}
			, CTRT_CLMN_DIV_CD       = #{ctrtClmnDivCd}
			, CTRT_CLMN_DAY          = #{ctrtClmnDay}
			, CTRT_CLMN_VAT          = #{ctrtClmnVat}
			, CTRT_ORDRS_DT          = #{ctrtOrdrsDt, jdbcType=VARCHAR}
			, CTRT_PFMC_DT           = #{ctrtPfmcDt, jdbcType=VARCHAR}
			, CTRT_BF_PFMC_DT        = #{ctrtBfPfmcDt, jdbcType=VARCHAR}
			, CTRT_AF_PFMC_DT        = #{ctrtAfPfmcDt, jdbcType=VARCHAR}
			, CURR_CD                = #{currCd}
			, EXRATE                 = #{exrate}
			, MNG_ID                 = #{mngId, jdbcType=VARCHAR}
			, CTRT_RMK               = #{ctrtRmk, jdbcType=VARCHAR}
			, ETC_FIELD1             = #{etcField1, jdbcType=VARCHAR}
			, ETC_FIELD2             = #{etcField2, jdbcType=VARCHAR}
			, ETC_FIELD3             = #{etcField3, jdbcType=VARCHAR}
			, UDT_ID                 = #{userId}
			, UDT_PGM                = #{pgmId}
			, UDT_DTTM               = SYSDATE
			, DUDT_INTEND_DT         = #{dudtIntendDt, jdbcType=VARCHAR}
            , VEND_MNG_NM			 = #{vendMngNm, jdbcType=VARCHAR} -- 담당자
            , VEND_TEL_NO			 = #{vendTelNo, jdbcType=VARCHAR} -- 전화
            , VEND_FAX_NO			 = #{vendFaxNo, jdbcType=VARCHAR} -- 팩스
            , VEND_HP_NO			 = #{vendHpNo, jdbcType=VARCHAR} -- 핸드폰
            , VEND_MNG_MAIL			 = #{vendMngMail, jdbcType=VARCHAR} -- 이메일
            , REQ_NO				 = #{reqNo, jdbcType=VARCHAR} -- 발주요청번호
            , CTRT_TOT_AMT			 = #{ctrtTotAmt, jdbcType=VARCHAR} -- 외주총금액
            , CTRT_NEGO_AMT			 = #{ctrtNegoAmt, jdbcType=VARCHAR} -- 총nego금액
            , CTRT_ORDRS_QTY			 = #{ctrtOrdrsQty, jdbcType=VARCHAR} -- 총nego금액
    WHERE CTRT_NO         = #{ctrtNo}
  </update>
  
  <delete id="deleteContract" parameterType="Map">
    DELETE TB_SM11M01 WHERE CTRT_NO = #{ctrtNo}
  </delete>
  
  
  <insert id="insertTurnKeyDetail" parameterType="Map">
    INSERT INTO TB_SM11D02
      (
		CTRT_NO,
		CTRT_NO_SEQ,
		ORDRS_CO_CD,
		ORDRS_NO,
		SALES_CD,
		CTRT_RMK,
		CREAT_ID,       
		CREAT_PGM,      
		CREAT_DTTM,
		ORDRS_QTY,
		ORDRS_AMT,
		ORDRS_SEQ
      )
    VALUES
    (
		#{ctrtNo},
		(SELECT NVL(max(CTRT_NO_SEQ),0)+1 FROM TB_SM11D02 WHERE CTRT_NO = #{ctrtNo}),
		#{ordrsCoCd},
		#{ordrsNo},
		#{salesCd,  jdbcType=VARCHAR},
		#{ctrtRmk,  jdbcType=VARCHAR},
		#{userId},
		#{pgmId},
		SYSDATE,
		#{ordrsQty,  jdbcType=NUMERIC},
		#{ordrsAmt,  jdbcType=NUMERIC},
		#{ordrsSeq}
    )
  </insert>
  			
  <delete id="deleteTurnKeyDetail" parameterType="Map">
    DELETE TB_SM11D02
     WHERE CTRT_NO = #{ctrtNo}
  </delete>
  
    
    <insert id="insertTurnKeyClmnPlan" parameterType="map">
        INSERT INTO TB_SM11D01
            (
             CTRT_NO, 
             CTRT_NO_SEQ, 
             CLMN_PLAN_DIV, 
             CLMN_DIV_SEQ, 
             CLMN_RATE, 
             CLMN_AMT,
             BILL_PBLS_DT, 
             CLMN_DT, 
             PMNT_DT_AFTER_BILL,
             CLMN_PLAN_RMK, 
             CLMN_MGMT_STATUS,
             CREAT_ID,
             CREAT_PGM,
             CREAT_DTTM,
             CTRT_PMNT_MTD_CD, 
             CTRT_CLMN_DAY
             )
        VALUES
            (
             #{ctrtNo}, 
			 (SELECT NVL(max(CTRT_NO_SEQ),0)+1 FROM TB_SM11D01 WHERE CTRT_NO = #{ctrtNo}),
             #{clmnPlanDiv}, 
             #{clmnDivSeq}, 
             #{clmnRate},
             #{clmnAmt}, 
             #{billPblsDt, jdbcType=VARCHAR}, 
             #{clmnDt, jdbcType=VARCHAR},
             #{pmntDtAfterBill, jdbcType=VARCHAR}, 
             #{clmnPlanRmk, jdbcType=VARCHAR}, 
             #{clmnMgmtStatus, jdbcType=VARCHAR},
             #{userId},
			 #{pgmId},
			 SYSDATE,
             #{ctrtPmntMtdCd},
             #{ctrtClmnDay}
             )
    </insert>
    
    
    <update id="updateTurnKeyClmnPlan" parameterType="map">
        UPDATE TB_SM11D01
        SET CLMN_PLAN_DIV      = #{clmnPlanDiv}, -- 수금구분
            CLMN_DIV_SEQ       = #{clmnDivSeq},  -- 수금계획순번
            CLMN_RATE          = #{clmnRate},    -- 수금비율
            CLMN_AMT           = #{clmnAmt},     -- 수금금액
            BILL_PBLS_DT       = #{billPblsDt, jdbcType=VARCHAR},  -- 계산서발행일자
            CLMN_DT            = #{clmnDt, jdbcType=VARCHAR},      -- 수금일자
            PMNT_DT_AFTER_BILL = #{pmntDtAfterBill, jdbcType=VARCHAR}, -- 계산서 발행 후 지급시기
            CLMN_PLAN_RMK      = #{clmnPlanRmk, jdbcType=VARCHAR},      -- 비고
            CLMN_MGMT_STATUS   = #{clmnMgmtStatus, jdbcType=VARCHAR}, -- 수금관리상황
            UDT_ID   		   = #{userId},
            UDT_PGM			   = #{pgmId},
            UDT_DTTM		   = SYSDATE,
            CTRT_PMNT_MTD_CD   = #{ctrtPmntMtdCd},
            CTRT_CLMN_DAY	   = #{ctrtClmnDay}
        WHERE CTRT_NO = #{ctrtNo}
          AND CTRT_NO_SEQ = #{ctrtNoSeq}
    </update>
    
    <delete id="deleteTurnKeyClmnPlan">
        DELETE
        FROM TB_SM11D01
        WHERE 1 = 1
          AND CTRT_NO = #{ctrtNo}
    </delete>

    <delete id="deleteTurnKeyClmnPlanEx">
        DELETE
        FROM TB_SM11D01
        WHERE 1 = 1
          AND CTRT_NO = #{ctrtNo}
          AND CTRT_NO_SEQ = #{ctrtNoSeq}
    </delete>
        

	<select id="selectContractLPayCount" parameterType="Map" resultType="int">
		SELECT
            count(*)
		FROM TB_SM11D01 P
				LEFT OUTER JOIN TB_SM11M01 M ON P.CTRT_NO  = M.CTRT_NO  
				LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
				LEFT OUTER JOIN TB_CR02M01 C ON C.CO_CD = M.ORDRS_CO_CD
				                            AND C.ORDRS_NO = M.ORDRS_NO
				LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
				LEFT OUTER JOIN TB_SM10M01 R ON R.CTRT_NO = P.CTRT_NO
				                            AND R.CTRT_NO_SEQ = P.CTRT_NO_SEQ
				LEFT OUTER JOIN TB_SM12D01 RD ON RD.ORDRG_NO = R.COST_NO
				LEFT OUTER JOIN TB_CM06M01 CM ON CM.ID = M.MNG_ID
				LEFT OUTER JOIN TB_CM04M01 CD ON CD.DEPT_ID = SUBSTRING(CM.DEPT_ID,0,5)
         WHERE 1=1
        <if test="coCd !=null and !coCd.equals('')">
           AND M.CO_CD = #{coCd}
        </if>
		<if test="closeYm != null and !closeYm.equals('')" >
			AND P.CLMN_DT BETWEEN ADD_MONTHS(TO_DATE(#{closeYm}||'26', 'YYYYMMDD'), -1)  AND  TO_DATE(#{closeYm}||'25', 'YYYYMMDD')
		</if>
         <if test="vendCd !=null and !vendCd.equals('')">
	           AND M.CLNT_CD = #{vendCd}
         </if>
         <if test="vendNm !=null and !vendNm.equals('')">
	           AND B.CLNT_NM LIKE '%'||#{vendNm}||'%'
         </if>
         <if test="clntCd !=null and !clntCd.equals('')">
	           AND C.ORDRS_CLNT_CD = #{clntCd}
         </if>
         <if test="clntNm !=null and !clntNm.equals('')">
	           AND D.CLNT_NM LIKE '%'||#{clntNm}||'%'
         </if>
         <if test="ordrsNo !=null and !ordrsNo.equals('')">
	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
         </if>
         <if test="salesCd !=null and !salesCd.equals('')">
	           AND M.SALES_CD LIKE '%'||#{salesCd}||'%'
         </if>
         <if test="pchsClmnDay !=null and !pchsClmnDay.equals('')">
	           AND M.CTRT_CLMN_DAY = #{pchsClmnDay}
         </if>
         <if test="completYn !=null and !completYn.equals('')">
	           AND ((NVL(RD.CMPLET_YN,'N') = 'Y'  AND 'Y' =  #{completYn})
	           OR  (NVL(RD.CMPLET_YN,'N') != 'Y' AND 'N' = #{completYn}))
         </if>
         <if test="deptNm !=null and !deptNm.equals('')">
	           AND CD.DEPT_NM LIKE '%'||#{deptNm}||'%'
         </if>

	</select>
	
	<select id="selectContractLPayList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
					SELECT 	  M.FILE_TRGT_KEY
							, M.CO_CD
							, FN_CM05M01_CD_TO_NM(M.CO_CD) AS CO_CD_NM
							, SUBSTRING(CM.DEPT_ID,0,5) 	 AS DEPT_ID
							, CD.DEPT_NM					 AS DEPT_ID_NM
							, CM.NAME 						 AS MNG_ID_NM
							, M.CTRT_NO
							, P.CTRT_NO_SEQ
							, M.CLNT_CD  				AS VEND_CD	--공급사
							, B.CLNT_NM  				AS VEND_NM	--공급사명
							, C.ORDRS_CLNT_CD 			AS CLNT_CD	--수주고객사
							, D.CLNT_NM								--수주고객사명
							, M.ORDRS_CO_CD							--수주회사코드
							, M.ORDRS_NO							--수주번호
							, C.CLNT_PJT							--고객사프로젝트
							, FN_CM05M01_CD_TO_NM(C.CLNT_PJT) AS CLNT_PJT_NM
							, M.CTRT_NM								--외주계약명
							, TO_CHAR(M.CTRT_DT, 'YYYY-MM-DD') AS CTRT_DT
							, M.CTRT_AMT
							, M.CTRT_ITEMS		--외주계약 품목
							, M.CTRT_PMNT_MTD_CD
							, FN_CM05M01_CD_TO_NM(M.CTRT_PMNT_MTD_CD) AS CTRT_PMNT_MTD_CD_NM
							, M.CTRT_CLMN_DIV_CD
							, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_DIV_CD) AS CTRT_CLMN_DIV_CD_NM
							, M.CTRT_CLMN_DAY 						  AS M_CTRT_CLMN_DAY	--마스터에 있는 결제일
							, P.CTRT_CLMN_DAY												--지급정보에 있는 결제일
							, M.CTRT_CLMN_VAT
							, FN_CM05M01_CD_TO_NM(M.CTRT_CLMN_VAT) AS CTRT_CLMN_VAT_NM
							, TO_CHAR(M.CTRT_ORDRS_DT, 'YYYY-MM-DD') AS CTRT_ORDRS_DT
							, TO_CHAR(M.CTRT_PFMC_DT, 'YYYY-MM-DD') AS CTRT_PFMC_DT
							, TO_CHAR(M.CTRT_BF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_BF_PFMC_DT
							, TO_CHAR(M.CTRT_AF_PFMC_DT, 'YYYY-MM-DD') AS CTRT_AF_PFMC_DT
							, M.CURR_CD
							, FN_CM05M01_CD_TO_NM(M.CURR_CD) AS CURR_CD_NM
							, M.EXRATE
							, M.CTRT_RMK
							, M.ETC_FIELD1
							, M.ETC_FIELD2
							, M.ETC_FIELD3
							, M.CREAT_ID
							, (SELECT FN_CM06M01_ID_TO_NM(M.CREAT_ID) FROM DUAL) CREAT_ID_NM
							, M.CREAT_PGM
							, TO_CHAR(M.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
							, M.UDT_ID
							, (SELECT FN_CM06M01_ID_TO_NM(M.UDT_ID) FROM DUAL) UDT_ID_NM
							, M.UDT_PGM
							, TO_CHAR(M.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
							, P.CLMN_PLAN_DIV
							, FN_CM05M01_CD_TO_NM(P.CLMN_PLAN_DIV) AS CLMN_PLAN_DIV_NM
							, P.CLMN_DIV_SEQ
							, P.CLMN_RATE
							, P.CLMN_AMT
							, TO_CHAR(P.CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT
							, P.CLMN_PLAN_RMK
							, P.CLMN_MGMT_STATUS
							, R.COST_NO
							, TO_CHAR(R.COST_DT, 'YYYY-MM-DD') AS COST_DT
							, FN_CM05M01_CD_TO_NM(R.PCHS_COST_DIV20) 	AS PCHS_COST_DIV20_NM
							, R.COST_AMT
							, TO_CHAR(R.PAY_DIV_DT, 'YYYY-MM-DD')   	AS PAY_DIV_DT
							, R.PCHS_NO
							, decode(RD.PCHS_NO,'',R.COST_AMT,0 )      	AS UNCONF_AMT	--미확정금액
							, RD.PCHS_AMT   							AS CONF_AMT		--확정금액
							, decode(RD.CMPLET_YN,'Y',RD.PCHS_AMT,0 )	AS BILL_AMT		--지급금액
							, decode(RD.CMPLET_YN,'Y',(P.CLMN_AMT-RD.PCHS_AMT), P.CLMN_AMT ) AS REM_AMT		--미지급금
							, DECODE(R.COST_NO,'','N','Y')				AS CREATE_YN	--매입생성완료
							, DECODE(RD.PCHS_NO,'','N','Y')				AS CONF_YN		--매입확정완료
							, NVL(RD.BILL_YN,'N')						AS BILL_YN		--계산서처리완료
							, M.FILE_TRGT_KEY
							, TO_CHAR(M.DUDT_INTEND_DT, 'YYYY-MM-DD')   AS DUDT_INTEND_DT	--납기일자
							, CR.EQP_NM
							, CR.ORDRS_QTY
							, M.REQ_NO
							, M.CTRT_ORDRS_QTY
					FROM TB_SM11D01 P
							LEFT OUTER JOIN TB_SM11M01 M ON P.CTRT_NO  = M.CTRT_NO  
							LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
							LEFT OUTER JOIN TB_CR02M01 C ON C.CO_CD = M.ORDRS_CO_CD
							                            AND C.ORDRS_NO = M.ORDRS_NO
							LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
							LEFT OUTER JOIN TB_SM10M01 R ON R.CTRT_NO = P.CTRT_NO
							                            AND R.CTRT_NO_SEQ = P.CTRT_NO_SEQ
							LEFT OUTER JOIN TB_SM12D01 RD ON RD.ORDRG_NO = R.COST_NO
							LEFT OUTER JOIN (
											SELECT MM.CTRT_NO, MM.ORDRS_CO_CD, MM.SALES_CD
											  FROM TB_SM11D02 MM
											 WHERE MM.CTRT_NO_SEQ = (SELECT min(CTRT_NO_SEQ) FROM TB_SM11D02 D WHERE D.CTRT_NO = MM.CTRT_NO)
											 GROUP BY MM.CTRT_NO, MM.ORDRS_CO_CD, MM.SALES_CD
											) AS MD ON MD.CTRT_NO = M.CTRT_NO
							LEFT OUTER JOIN TB_CR02D02 CR ON CR.SALES_CD = MD.SALES_CD
							LEFT OUTER JOIN TB_CM06M01 CM ON CM.ID = M.MNG_ID
							LEFT OUTER JOIN TB_CM04M01 CD ON CD.DEPT_ID = SUBSTRING(CM.DEPT_ID,0,5)
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND M.CO_CD = #{coCd}
              </if>
			   <if test="closeYm != null and !closeYm.equals('')" >
				   AND P.CLMN_DT BETWEEN ADD_MONTHS(TO_DATE(#{closeYm}||'26', 'YYYYMMDD'), -0)  AND   ADD_MONTHS(TO_DATE(#{closeYm}||'25', 'YYYYMMDD'), +1)
			  </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND M.CLNT_CD = #{vendCd}
              </if>
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND B.CLNT_NM LIKE '%'||#{vendNm}||'%'
              </if>
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND C.ORDRS_CLNT_CD = #{clntCd}
              </if>
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND D.CLNT_NM LIKE '%'||#{clntNm}||'%'
              </if>
              <if test="ordrsNo !=null and !ordrsNo.equals('')">
     	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
              </if>
              <if test="salesCd !=null and !salesCd.equals('')">
     	           AND M.SALES_CD LIKE '%'||#{salesCd}||'%'
              </if>
              <if test="pchsClmnDay !=null and !pchsClmnDay.equals('')">
     	           AND P.CTRT_CLMN_DAY = #{pchsClmnDay} --지급정보에 있는 결제일
              </if>
              <if test="completYn !=null and !completYn.equals('')">
     	           AND ((NVL(RD.CMPLET_YN,'N') = 'Y'  AND 'Y' =  #{completYn})
     	           OR  (NVL(RD.CMPLET_YN,'N') != 'Y' AND 'N' = #{completYn}))
              </if>
              <if test="deptNm !=null and !deptNm.equals('')">
     	           AND CD.DEPT_NM LIKE '%'||#{deptNm}||'%'
              </if>
		         ORDER BY SUBSTRING(CM.DEPT_ID,0,5), B.CLNT_NM, M.CTRT_DT DESC, P.CTRT_NO DESC, P.CLMN_PLAN_DIV,  P.CTRT_NO_SEQ
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>

	
	<select id="selectContractBilCostNoCreation" parameterType="Map" resultType="String">
		SELECT 'COST' || TO_CHAR(SYSDATE, 'YY')||LPAD(TB_SM10M01_SQ02.NEXTVAL,4,0)
		  FROM  DUAL
	</select>
  
	<!-- 외주관리 기타비용 자동생성 마스터  -->
	<insert id="createContractBillMaster" parameterType="Map">
	
		<selectKey keyProperty="fileTrgtKey"  resultType="String" order="BEFORE">
			SELECT TB_SM10M01_SQ01.NEXTVAL
			FROM   DUAL
        </selectKey>
        
	    INSERT INTO TB_SM10M01
	    (
			  FILE_TRGT_KEY
			, CO_CD
			, COST_NO
			, SALES_CD
			, PCHS_CLNT_CD
			, COST_DT
			, PCHS_COST_DIV10
			, PCHS_COST_DIV20
			, CURR_CD
			, EXRATE
			, COST_AMT
			, MATR_CD
			, COST_RMK
			, ETC_FIELD1
			, ETC_FIELD2
			, ETC_FIELD3
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM
			, REQ_NO
			, ORDRS_NO
			, PAY_DIV
			, PAY_DIV_DT
			, PCHS_NO
			, PCHS_SEQ
			, ORDRS_CO_CD
			, MAIL_YN
			, MAIL_DTTM
			, MAIL_SEND_ID
			, PCHS_PMNT_MTD_CD
			, PCHS_CLMN_DIV_CD
			, PCHS_CLMN_DAY
			, CTRT_NO
			, CTRT_NO_SEQ  
	      )
			SELECT 
			    #{fileTrgtKey}  --FILE_TRGT_KEY
			  , M.CO_CD
			  , #{costNo}
			  , (SELECT min(SALES_CD) FROM TB_SM11D02 WHERE CTRT_NO = D.CTRT_NO  AND ORDRS_AMT IS NOT NULL)
			  , M.CLNT_CD
			  , #{costDt} --COST_DT
			  , 'PCHSCOSTDIV1030' --PCHS_COST_DIV10
			  , D.CLMN_PLAN_DIV --PCHS_COST_DIV20
			  , M.CURR_CD
			  , M.EXRATE
			  , D.CLMN_AMT
			  , ''				--MATR_CD
			  , '외주관리에서 자동생성'
			  , ''
			  , ''
			  , ''
			  , #{userId}
			  , #{pgmId}
			  , SYSDATE
			  , M.REQ_NO		--REQ_NO
			  , M.ORDRS_NO
			  , 'PAYDIV02'	--청구
			  , ''			--영수일자
			  , ''			--PCHS_NO
			  , ''			--PCHS_SEQ
			  , M.ORDRS_CO_CD
			  , ''			--MAIL_YN
			  , ''			--MAIL_DTTM
			  , ''			--MAIL_SEND_ID
			  , D.CTRT_PMNT_MTD_CD  --PCHS_PMNT_MTD_CD
			  , M.CTRT_CLMN_DIV_CD  --PCHS_CLMN_DIV_CD
			  , D.CTRT_CLMN_DAY 	--PCHS_CLMN_DAY
			  , D.CTRT_NO
			  , D.CTRT_NO_SEQ 
			FROM TB_SM11D01 D
					LEFT OUTER JOIN TB_SM11M01 M  ON D.CTRT_NO  = M.CTRT_NO 
			WHERE D.CTRT_NO = #{ctrtNo}
			  AND D.CTRT_NO_SEQ = #{ctrtNoSeq}
	</insert>
	 
	 
	<!-- 외주관리 기타비용 자동생성 상세(salesCode  -->
	<insert id="createContractBillDetail" parameterType="Map">
	  INSERT INTO TB_SM10D01
	  	(
			COST_NO,
			CO_CD,
			ORDRS_NO,
			SALES_CD,
			CHK_SAVE_CD,
			CREAT_ID,       
			CREAT_PGM,      
			CREAT_DTTM,
			ORDRS_QTY,
			ORDRS_AMT,
			ORDRS_SEQ,
			ORDRS_RMK
		  )
			SELECT 
				  #{costNo}
				, ORDRS_CO_CD 
				, ORDRS_NO
				, SALES_CD
				, 'PCHSCOSTDIV1030'
				, #{userId}
				, #{pgmId}
				, SYSDATE
				, ORDRS_QTY
				, ORDRS_AMT
				, ORDRS_SEQ
				, CTRT_RMK
			FROM TB_SM11D02
			WHERE CTRT_NO = #{ctrtNo}
  </insert>
  			
    <delete id="deleteContractBillMaster">
        DELETE
        FROM TB_SM10M01
        WHERE 1 = 1
          AND COST_NO = #{costNo}
    </delete>
    
    <delete id="deleteContractBillDetail">
        DELETE
        FROM TB_SM10D01
        WHERE 1 = 1
          AND COST_NO = #{costNo}
    </delete>
    
    <delete id="deleteContractBillReport">
        DELETE
        FROM TB_SM10D02
        WHERE 1 = 1
          AND COST_NO = #{costNo}
    </delete>
    
	
	<select id="selectClntCrtrListCount" parameterType="Map" resultType="int">
		SELECT 	  COUNT(*)
		FROM (
				SELECT M.CO_CD, M.ORDRS_NO, M.MNG_ID
				  FROM TB_SM11M01 M
						LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
			  			LEFT OUTER JOIN TB_CR02M01 AS C  ON C.CO_CD    = M.ORDRS_CO_CD
			  											AND C.ORDRS_NO = M.ORDRS_NO
						LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
						LEFT OUTER JOIN TB_CM06M01 U ON U.ID = M.MNG_ID
				 WHERE 1 = 1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND M.CO_CD = #{coCd}
              </if>
			  <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND M.CTRT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD')
			  </if>
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND M.CLNT_CD = #{clntCd}
              </if>
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND B.CLNT_NM LIKE '%'||#{clntNm}||'%'
              </if>
              <if test="ordrsNo !=null and !ordrsNo.equals('')">
     	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
              </if>
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND D.CLNT_NM LIKE '%'||#{vendNm}||'%'
              </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND C.ORDRS_CLNT_CD = #{vendCd}
              </if>
              <if test="mngId !=null and !mngId.equals('')">
     	           AND M.MNG_ID = #{mngId}
              </if>
              <if test="mngIdNm !=null and !mngIdNm.equals('')">
     	           AND U.NAME LIKE '%'||#{mngIdNm}||'%'
              </if>
				 GROUP BY M.CO_CD, M.ORDRS_NO, M.MNG_ID	
			)
	</select>
	
	<select id="selectClntCrtrList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
				SELECT 	  M.CO_CD, M.ORDRS_NO, M.MNG_ID
						, (SELECT FN_CM06M01_ID_TO_NM(M.MNG_ID) FROM DUAL) MNG_ID_NM
						, FN_CM05M01_CD_TO_NM(M.CO_CD) 			AS CO_CD_NM
						, MAX(M.CTRT_NM) 						AS CTRT_NM
						, TO_CHAR(MAX(M.CTRT_DT), 'YYYY-MM-DD') AS CTRT_DT
						, SUM(M.CTRT_AMT) 						AS CTRT_AMT
						, SUM(M.CTRT_ORDRS_QTY) 				AS CTRT_ORDRS_QTY
						, MAX(M.CTRT_RMK) 						AS CTRT_RMK
						, COUNT(M.ORDRS_NO) 					AS CTRT_CNT
						, max(C.CLNT_PJT)  						AS CLNT_PJT
						, FN_CM05M01_CD_TO_NM(max(C.CLNT_PJT)) 	AS CLNT_PJT_NM
						, MAX(C.ORDRS_CLNT_CD) 					AS CUST_ID
						, MAX(D.CLNT_NM) 						AS CUST_ID_NM
				  FROM TB_SM11M01 M
						LEFT OUTER JOIN TB_BM02M01 B ON M.CLNT_CD = B.CLNT_CD
			  			LEFT OUTER JOIN TB_CR02M01 AS C  ON C.CO_CD    = M.ORDRS_CO_CD
			  											AND C.ORDRS_NO = M.ORDRS_NO
						LEFT OUTER JOIN TB_BM02M01 D ON D.CLNT_CD = C.ORDRS_CLNT_CD
						LEFT OUTER JOIN TB_CM06M01 U ON U.ID = M.MNG_ID
				 WHERE 1 = 1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND M.CO_CD = #{coCd}
              </if>
			  <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND M.CTRT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD')
			  </if>
              <if test="clntCd !=null and !clntCd.equals('')">
     	           AND M.CLNT_CD = #{clntCd}
              </if>
              <if test="clntNm !=null and !clntNm.equals('')">
     	           AND B.CLNT_NM LIKE '%'||#{clntNm}||'%'
              </if>
              <if test="ordrsNo !=null and !ordrsNo.equals('')">
     	           AND M.ORDRS_NO LIKE '%'||#{ordrsNo}||'%'
              </if>
              <if test="vendNm !=null and !vendNm.equals('')">
     	           AND D.CLNT_NM LIKE '%'||#{vendNm}||'%'
              </if>
              <if test="vendCd !=null and !vendCd.equals('')">
     	           AND C.ORDRS_CLNT_CD = #{vendCd}
              </if>
              <if test="mngId !=null and !mngId.equals('')">
     	           AND M.MNG_ID = #{mngId}
              </if>
              <if test="mngIdNm !=null and !mngIdNm.equals('')">
     	           AND U.NAME LIKE '%'||#{mngIdNm}||'%'
              </if>
				 GROUP BY M.CO_CD, M.ORDRS_NO, M.ORDRS_CO_CD, M.MNG_ID
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>
</mapper>