<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.dw.dw02.mapper.DW02Mapper">
		
	<select id="searchAuditsCount" resultType="int">
		SELECT 
	 		COUNT(T.AUDIT_ID) 
		  FROM TB_DRAWING_AUDIT T
		    		LEFT OUTER JOIN TB_CM06M01 AS C ON T.USER_ID = C.ID
	    WHERE CREATED_AT BETWEEN #{from} AND #{to}
		      <if test="userId 		!= null and userId 	 != ''">AND USER_ID 		= #{userId}</if>
		      <if test="userIdNm 	!= null and userIdNm != ''">AND C.NAME 	LIKE '%'||#{userIdNm}||'%'</if>
		      <if test="salesCd 	!= null and salesCd  != ''">AND SALES_CD LIKE '%'||#{salesCd}||'%'</if>
		      <if test="docNo 		!= null and docNo 	 != ''">AND DOC_NO 	LIKE '%'||#{docNo}||'%'</if>
		      <if test="fileName 	!= null and fileName  != ''">AND T.FILE_NAME 	LIKE '%'||#{fileName}||'%'</if>
	</select>
	
	
	<select id="searchAuditsList" resultType="CamelMap">
	SELECT
		*
	FROM
	(
		SELECT
			ROWNUM AS RNUM, A.*
		FROM
		(
		    SELECT T.AUDIT_ID,  	T.DOC_ID,  		T.VER_ID,  		T.ACTION_TYPE,  	T.SALES_CD,  		T.DOC_NO,  
		           T.DOC_NO,		T.FILE_NAME,  	T.EXT,  		T.FILE_SIZE,  		T.CHECKSUM_SHA256,  T.CLIENT_IP,  
		           T.USER_ID,  		T.USER_NAME,  	T.APP_NAME,  	T.SOURCE_EVT_ID,  	T.SOURCE_EVT_TYPE,  T.CREATED_AT,
		           T.PART_NO,  		T.UNIT_NO,  	T.REV_NO,  		T.OLD_PATH,  		T.NEW_PATH,  		T.RECORD_ID,
		           T.SERVER_NAME,
		           C.NAME				AS USER_ID_NM 
		    FROM TB_DRAWING_AUDIT AS T
		    		LEFT OUTER JOIN TB_CM06M01 AS C ON T.USER_ID = C.ID
		    WHERE CREATED_AT BETWEEN #{from} AND #{to}
		      <if test="userId 		!= null and userId 	 != ''">AND USER_ID 		= #{userId}</if>
		      <if test="userIdNm 	!= null and userIdNm != ''">AND C.NAME 	LIKE '%'||#{userIdNm}||'%'</if>
		      <if test="salesCd 	!= null and salesCd  != ''">AND SALES_CD LIKE '%'||#{salesCd}||'%'</if>
		      <if test="docNo 		!= null and docNo 	 != ''">AND DOC_NO 	LIKE '%'||#{docNo}||'%'</if>
		      <if test="fileName 	!= null and fileName  != ''">AND T.FILE_NAME 	LIKE '%'||#{fileName}||'%'</if>
		    ORDER BY CREATED_AT DESC
		) A			
	)
	WHERE
			RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	

  <select id="searchAudits" parameterType="map" resultType="map">
    SELECT T.AUDIT_ID,  	T.DOC_ID,  		T.VER_ID,  		T.ACTION_TYPE,  	T.SALES_CD,  		T.DOC_NO,  
		           T.DOC_NO,		T.FILE_NAME,  	T.EXT,  		T.FILE_SIZE,  		T.CHECKSUM_SHA256,  T.CLIENT_IP,  
		           T.USER_ID,  		T.USER_NAME,  	T.APP_NAME,  	T.SOURCE_EVT_ID,  	T.SOURCE_EVT_TYPE,  T.CREATED_AT,
		           T.PART_NO,  		T.UNIT_NO,  	T.REV_NO,  		T.OLD_PATH,  		T.NEW_PATH,  		T.RECORD_ID
	 FROM TB_DRAWING_AUDIT AS T
    WHERE CREATED_AT BETWEEN #{from} AND #{to}
      <if test="userId != null and userId != ''">AND USER_ID = #{userId}</if>
      <if test="salesCd != null and salesCd != ''">AND SALES_CD LIKE '%'||#{salesCd}||'%'</if>
      <if test="docNo != null and docNo != ''">AND DOC_NO LIKE '%'||#{docNo}||'%'</if>
	  <if test="fileName 	!= null and fileName  != ''">AND T.FILE_NAME 	LIKE '%'||#{fileName}||'%'</if>
    ORDER BY CREATED_AT DESC
  </select>
  
  
</mapper>