<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.qm.qm07.mapper.QM07Mapper">

	<select id="selectQualityReqSCDSTSListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) 
		  FROM (
				SELECT T.CO_CD, T.ORDRG_ID
				FROM TB_QM01M01 T
				 LEFT OUTER JOIN TB_CM06M01 N2 ON N2.ID = T.ORDRG_ID
				 WHERE 1=1  
					<if test="coCd !=null and !coCd.equals('')">
					  AND T.CO_CD = #{coCd}
					 </if>
					 <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
			          AND T.ORDRG_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYY-MM-DD') AND TO_DATE( #{reqDtTo},'YYYY-MM-DD')
			         </if>
			         <if test="ordrgId !=null and !ordrgId.equals('')">
			          AND (T.ORDRG_ID = #{ordrgId} OR T.REG_ID = #{ordrgId})
			         </if>
			         <if test="ordrgNm !=null and !ordrgNm.equals('')">
			          AND N2.NAME = #{ordrgNm}
			         </if>
			         <if test="salesCd !=null and !salesCd.equals('')">
			          AND T.SALES_CD  LIKE '%${salesCd}%'
			         </if>
		           AND T.PART_CD = 'COBTP01'
				GROUP BY T.CO_CD, T.ORDRG_ID
		)
	</select>
	
	<select id="selectQualityReqSCDSTSList" parameterType="Map" resultType="CamelMap">	
	   SELECT ROWNUM AS RNUM, A.*
	   FROM(
				SELECT
						 T.CO_CD, T.ORDRG_ID, count(T.REQ_NO) AS ERR_CNT
		   	   			, MAX(N2.NAME) 		AS ORDRG_ID_NM
		   	   			, SUM(DECODE(NVL(T.SCD_STS,'SCDSTS01'), 'SCDSTS01',1,0))	AS NORMAL_CNT
		   	   			, SUM(DECODE(NVL(T.SCD_STS,'SCDSTS01'), 'SCDSTS01',0,1))	AS AFT_ERR_CNT
		   	   			, SUM(COUNT(*)) OVER (ORDER BY T.CO_CD ) AS REQ_TOT
		   	   			, SUM(SUM(DECODE(NVL(T.SCD_STS,'SCDSTS01'), 'SCDSTS01',1,0))) OVER (ORDER BY T.CO_CD ) AS NORMAL_TOT
		   	   			, SUM(SUM(DECODE(NVL(T.SCD_STS,'SCDSTS01'), 'SCDSTS01',0,1))) OVER (ORDER BY T.CO_CD ) AS AFT_ERR_TOT
				FROM TB_QM01M01 T
				 LEFT OUTER JOIN TB_CM06M01 N2 ON N2.ID = T.ORDRG_ID
				 WHERE 1=1  
					<if test="coCd !=null and !coCd.equals('')">
					  AND T.CO_CD = #{coCd}
					 </if>
					 <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
			          AND T.ORDRG_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYY-MM-DD') AND TO_DATE( #{reqDtTo},'YYYY-MM-DD')
			         </if>
			         <if test="ordrgId !=null and !ordrgId.equals('')">
			          AND (T.ORDRG_ID = #{ordrgId} OR T.REG_ID = #{ordrgId})
			         </if>
			         <if test="ordrgNm !=null and !ordrgNm.equals('')">
			          AND N2.NAME = #{ordrgNm}
			         </if>
			         <if test="salesCd !=null and !salesCd.equals('')">
			          AND T.SALES_CD  LIKE '%' || #{salesCd} || '%'
			         </if>
			         <if test="partCd !=null and !partCd.equals('')">
		        	  AND T.PART_CD = #{partCd}
			         </if>
				GROUP BY T.CO_CD, T.ORDRG_ID
				ORDER BY count(T.REQ_NO) DESC, MAX(N2.NAME) 
		) A
<!-- 	  WHERE  ROWNUM BETWEEN #{firstIndex} AND #{lastIndex} -->
	   
	</select>
    
</mapper>