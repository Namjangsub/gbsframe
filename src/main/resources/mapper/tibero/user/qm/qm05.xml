<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.qm.qm05.mapper.QM05Mapper">

	<!-- 그리드 조회 -->
	<select id="selectMainGridList" parameterType="Map" resultType="camelMap">
	 /* 발주요청 월별 통계내역 */
	WITH SJD AS
	     (
	      SELECT X.CO_CD                                             AS CO_CD         --회사코드
	            , Y.ORDRS_CLNT_CD                                     AS ORDRS_CLNT_CD --고객코드
	            , A.CLNT_NM                                           AS ORDRS_CLNT_NM --고객명
	            , X.SALES_CD                                          AS SALES_CD      --SALES CODE
	            , (SELECT FN_CM05M01_CD_TO_NM(Y.CLNT_PJT) FROM DUAL) AS PJT_NM        --고객사프로젝트 
	            , X.SALES_CD                                          AS DRAW_NO       --대표도번 
	            , X.EQP_NM                                            AS EQP_NM        --설비명
	        FROM TB_CR02D02 X     --수주상세
	           , TB_CR02M01 Y     --수주마스터
	           , TB_BM02M01 A     --거래처마스터
	       WHERE X.CO_CD         = #{coCd} 
	         AND Y.ORDRS_CLNT_CD = A.CLNT_CD
	         AND X.CO_CD         = Y.CO_CD 
	         AND X.ORDRS_NO      = Y.ORDRS_NO	
	     )
	   , REQ AS
	     (
	      SELECT Q.CO_CD
	            , Q.SALES_CD
	            , Q.REQ_NO
	            , Q.ORDRG_DT                                          AS ORDRG_DT    --발행일
	            , TO_CHAR(Q.ORDRG_DT,'YYYYMM')                        AS ORDRG_MON   --집계월
	            , DECODE(Q.REQ_CD, '1', 1, 0)                         AS REQ_DIV_BAL --요청구분 발주
	            , DECODE(Q.REQ_CD, '2', 1, 0)                         AS REQ_DIV_CHL --요청구분 출장
	            , DECODE(Q.INWK_CD, NULL, 0, 1)                       AS INWK_DIV    --사내작업구분
	            , DECODE(Q.BUST_CD, '1', '생산', '2', '전기')         AS BUST_DIV    --출장자 구분
	            , DECODE(Q.INWK_CD, '1', '생산', '2', '전기')         AS INWK_DIV_NM --사내작업구분명
	            , (SELECT FN_CM06M01_ID_TO_NM(Q.REG_ID) FROM DUAL)   AS CREAT_NAME  --작성자(접수자)
	            , (SELECT FN_CM06M01_ID_TO_NM(Q.ORDRG_ID) FROM DUAL) AS ORDRDG_NAME --요청자(발행자)
	            , (SELECT FN_CM05M01_CD_TO_NM(SUBSTR(U.DEPT_ID, 1, 5)) FROM DUAL) AS REQ_DEPT --요청자 소속팀 
	            , ''                                                  AS DIV_LAGE    --대분류
	            , ''                                                  AS DIV_MID     --소분류
	            , DECODE(Q.PART_CD, 'COBTP01', 1, 0)                  AS PART_CD1    --분류 : 출도
	            , DECODE(Q.PART_CD, 'COBTP02', 1, 0)                  AS PART_CD2    --분류 : 추가
	            , DECODE(Q.PART_CD, 'COBTP03', 1, 0)                  AS PART_CD3    --분류 : 장애
	            , DECODE(Q.PART_CD, 'COBTP04', 1, 0)                  AS PART_CD4    --분류 : A/S유상
	            , DECODE(Q.PART_CD, 'COBTP05', 1, 0)                  AS PART_CD5    --분류 : A/S무상
	            , DECODE(Q.PART_CD, 'COBTP06', 1, 0)                  AS PART_CD6    --분류 : SPARE유상
	            , DECODE(Q.PART_CD, 'COBTP07', 1, 0)                  AS PART_CD7    --분류 : SPARE무상
	            , DECODE(Q.PART_CD, 'COBTP08', 1, 0)                  AS PART_CD8    --분류 : 고객E/O
	            , DECODE(Q.PART_CD, 'COBTP09', 1, 0)                  AS PART_CD9    --분류 : 설치시운전
	            , DECODE(Q.PART_CD, 'COBTP99', 1, 0)                  AS PART_CD99   --분류 : 기타
	            , ''                                                  AS REC_1       --접수내용 : 진행
	            , ''                                                  AS REC_2       --접수내용 : 대기
	            , ''                                                  AS REC_3       --접수내용 : 보류
	            , ''                                                  AS REC_4       --접수내용 : 폐기 
	            , ''                                                  AS REMARK      --비고(서술)
	        FROM TB_QM01M01 AS Q
	              INNER JOIN TB_CM06M01 AS U ON Q.CO_CD = U.CO_CD
	                                        AND Q.ORDRG_ID = U.ID
	       WHERE 1=1
	          AND Q.CO_CD   = #{coCd} 
	          AND Q.REQ_DT <![CDATA[>=]]> TO_DATE(#{strDate}, 'YYYYMMDD')
	          AND Q.REQ_DT <![CDATA[<=]]> TO_DATE(#{endDate}, 'YYYYMMDD')
	        <if test="userId != null and !userId.equals('')">
		 	  AND Q.ORDRG_ID = #{userId}  
			</if>
	     )
		SELECT TO_CHAR(R.ORDRG_DT, 'YYYY-MM-DD') AS ORDRG_DT      --발행일
		     , R.ORDRG_MON     --집계월
		     , R.REQ_DIV_BAL   --요청구분 발주
		     , R.REQ_DIV_CHL   --요청구분 출장
		     , R.INWK_DIV      --사내작업구분
		     , R.INWK_DIV_NM   --사내작업구분명
		     , R.BUST_DIV      --출장자 구분
		     , R.CREAT_NAME    --작성자(접수자)
		     , R.ORDRDG_NAME   --요청자(발행자)
		     , R.REQ_DEPT      --요청자 소속팀 
		     , R.DIV_LAGE      --대분류 X
		     , R.DIV_MID       --소분류 X
		     , S.ORDRS_CLNT_NM --고객명
		     , S.PJT_NM        --고객사프로젝트	
		     , S.DRAW_NO       --대표도번 	
		     , S.EQP_NM        --설비명	
		     , R.PART_CD1      --분류 : 출도
		     , R.PART_CD2      --분류 : 추가
		     , R.PART_CD3      --분류 : 장애
		     , R.PART_CD4      --분류 : A/S유상
		     , R.PART_CD5      --분류 : A/S무상
		     , R.PART_CD6      --분류 : SPARE유상
		     , R.PART_CD7      --분류 : SPARE무상
		     , R.PART_CD8      --분류 : 고객E/O
		     , R.PART_CD9      --분류 : 설치시운전
		     , R.PART_CD99     --분류 : 기타
		     , R.REC_1         --접수내용 : 진행 X
		     , R.REC_2         --접수내용 : 대기 X
		     , R.REC_3         --접수내용 : 보류 X
		     , R.REC_4         --접수내용 : 폐기 X
		     , R.REMARK        
		  FROM SJD AS S
		     , REQ AS R
		 WHERE 1=1
		   AND R.CO_CD    = S.CO_CD
		   AND R.SALES_CD = S.SALES_CD
		 ORDER BY R.ORDRG_DT
	</select>
</mapper>