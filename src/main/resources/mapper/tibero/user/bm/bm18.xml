<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.bm.bm18.mapper.BM18Mapper">

	<!-- 알림톡템플릿 조회 리스트  조회조건 -->
	<sql id="selectReceptionMessageListCondition">			
		<!-- 템플릿 구분 -->         
		<if test="tmplatDiv != null and !tmplatDiv.equals('')">
			AND TMPLAT_DIV = #{tmplatDiv}
		</if>
		<!-- 거래처 -->       
		<if test="clntNm != null and !clntNm.equals('')">
			AND CLNT_NM LIKE '%' || #{clntNm} || '%'
		</if>
		<!-- 수신인 -->       
		<if test="nameTo != null and !nameTo.equals('')">
			AND NAME_TO LIKE '%' || #{nameTo} || '%'
		</if>
		<!-- 수신번호 -->       
		<if test="mobile != null and !mobile.equals('')">
			AND MOBILE LIKE '%' || #{mobile} || '%'
		</if>
	</sql>	
		
	<!-- 알림톡템플릿 조회 리스트  카운트 -->
	<select id="selectReceptionMessageListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) 
			FROM 
			(
				SELECT A.MESSAGE_ID       --수신번호
				FROM TB_BM18M01 A
				LEFT JOIN TB_BM02M01 AS C ON A.CLNT_CD = C.CLNT_CD --거래처정보
				LEFT OUTER JOIN TB_BM02D01 AS B ON A.CLNT_CD = B.CLNT_CD --거래처 사업부
				WHERE 1=1
				<include refid="selectReceptionMessageListCondition"></include>
			)
		WHERE 1=1
		
	</select>
	        
	<!-- 알림톡템플릿 조회 리스트  -->
	<select id="selectReceptionMessageList" parameterType="Map" resultType="camelMap">   
		SELECT *
			FROM
			(
			SELECT X.*
					, ROWNUM AS RN
					FROM
						(
						SELECT A.MESSAGE_ID       --수신번호
							, A.RCV_ID             --사용자아이디
							, A.RCV_NM             --사용자이름
							, A.CLNT_CD         --거래처
							, C.CLNT_NM         --거래처명
							, B.MNG_NM           --담당자명
							, B.MNG_TEL_NO        --담당자 전화번호
							, A.TMPLAT_DIV        --발송구분
							, (SELECT FN_CM05M01_CD_TO_NM(A.TMPLAT_DIV) FROM DUAL) AS TMPLAT_DIV_NM  --발송구분명
							, A.SENDG_STATUS        --발송상태
							, (SELECT FN_CM05M01_CD_TO_NM(A.SENDG_STATUS) FROM DUAL) AS SENDG_STATUS_NM  --발송상태
							,
							CASE 
								WHEN(A.SENDG_STATUS='OK') THEN '성공'
								ELSE A.SENDG_STATUS
							END AS SENDG_STATUS_CHK   -- 정상코드면 '성공' 아니면 에러코드 표시
							, A.TITLE			  --메시지제목
							, A.MESSAGE		  --알림톡메시지
							, A.MOBILE		  --연락처
							, A.NAME_TO		  --받는사람
							, NVL(TO_CHAR(A.SEND_DT, 'YYYY-MM-DD HH24:MI:SS'), TO_CHAR(A.SEND_DT, 'YYYY-MM-DD HH24:MI:SS')) AS SEND_DT		  --보낸일자
							, A.CREAT_ID		  --생성자
							, A.CREAT_PGM		  --생성프로그램ID
							, NVL(TO_CHAR(A.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS'), TO_CHAR(A.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS CREAT_DTTM		  --생성일시
							, A.UDT_ID		  --최종변경자
							, A.UDT_PGM		  --최종수정프로그램ID
							, TO_CHAR(A.UDT_DTTM, 'YYYY-MM-DD') UDT_DTTM	  --최종변경일시
						FROM TB_BM18M01 A
						LEFT JOIN TB_BM02M01 AS C ON A.CLNT_CD = C.CLNT_CD --거래처정보
						LEFT OUTER JOIN TB_BM02D01 AS B ON A.CLNT_CD = B.CLNT_CD --거래처 사업부
						WHERE 1=1						
						<include refid="selectReceptionMessageListCondition"></include>
						ORDER BY CREAT_DTTM DESC
						) X		
			)							
			WHERE 1=1
				AND RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
    <select id="selectKakaoSeqNext" parameterType="Map" resultType="string">
        SELECT 'KKO'||TO_CHAR(SYSDATE, 'YY') || LPAD(TB_SM18M01_SQ01.NEXTVAL, 6, 0)
        FROM DUAL
    </select>		
	
	<!--  수신번호 채번 messageId, TEMPLATE 내용 GET -->
	<select id="selectMaxMessageId" parameterType="Map" resultType="camelMap">
		SELECT MAX(MAX_MESSAGE_ID) AS MAX_MESSAGE_ID			
			, MAX(MSSAGE_DESC) AS MESSAGE_DESC
			, MAX(A.CLNT_CD) AS CLNT_CD
		<if test="tmplatDiv != null and !tmplatDiv.equals('')">
			/* 발주서일 경우 거래처 D 사업부순번 1번의 전화번호를 GET */		
			<if test='tmplatDiv == "TMPLATDIV01"'>
			, MAX(B.MNG_NM) AS MNG_NM
			, MAX(B.MNG_MOBLPHON_NO) AS MNG_MOBLPHON_NO
			</if>
		</if>				
			FROM
			(
				SELECT #{kakaoSeq} AS MAX_MESSAGE_ID 
						/* NVL(MAX_MESSAGE_ID, 'KAKAO'||TO_CHAR(SYSDATE, 'YY')||'000001') AS MAX_MESSAGE_ID */
						, '' AS MSSAGE_DESC		
						, #{clntCd} AS CLNT_CD						
					FROM
					(
					SELECT DISTINCT DECODE( INSTR(MESSAGE_ID, 'KAKAO'||TO_CHAR(SYSDATE, 'YY')), 0, 'KAKAO'||TO_CHAR(SYSDATE, 'YY')||'000001'
									, 'KAKAO' || MAX( TO_CHAR(SYSDATE, 'YY')|| LPAD( SUBSTRING(MESSAGE_ID, -6)+1, 6, '0') ) OVER()
								  ) AS MAX_MESSAGE_ID
						FROM TB_BM18M01
					UNION ALL
					SELECT NULL AS MAX_MESSAGE_ID
						FROM DUAL		
					)		
					WHERE MAX_MESSAGE_ID IS NOT NULL OR ROWNUM = 1	
				UNION ALL 
				SELECT '' AS MAX_MESSAGE_ID
						, MSSAGE_DESC AS MSSAGE_DESC
						, '' AS CLNT_CD
					FROM TB_BM17M01
				WHERE 1=1
				<if test="tmplatDiv != null and !tmplatDiv.equals('')">
					AND TMPLAT_DIV = #{tmplatDiv}
				</if>					
				<if test="fileTrgtKey != null and !fileTrgtKey.equals('')">
					AND FILE_TRGT_KEY = #{fileTrgtKey}
				</if>									
			) A
		<if test="tmplatDiv != null and !tmplatDiv.equals('')">
			/* 발주서일 경우 거래처 D 사업부순번 1번의 전화번호를 GET */		
			<if test='tmplatDiv == "TMPLATDIV01"'>
				LEFT OUTER JOIN
				(
				SELECT MNG_NM
						, MNG_MOBLPHON_NO
						, CLNT_CD
					FROM TB_BM02D01	
				WHERE 1=1 
				AND CLNT_CD = #{clntCd}				
				) B ON(A.CLNT_CD=B.CLNT_CD)		
			</if>
		</if>								
	</select>
		
	<!--  todo 수신번호 채번 messageId, TEMPLATE 내용 GET -->
	<select id="selectMaxMessageIdTodo" parameterType="Map" resultType="camelMap">
	/* selectMaxMessageIdTodo */
		SELECT A.TODO_ID
			, A.NAME
			, A.TODO_TITL	
			, A.TEL_NO
			, A.TODO_NO
			, A.SANCTN_SN	
			/* , OLD 'KAKAO'||TO_NUMBER( SUBSTR(MAX_MESSAGE_ID, -8)+A.SANCTN_SN)||A.DIV_NUM AS MAX_MESSAGE_ID */
			, 'KKO'||A.DIV_GB||TO_NUMBER( SUBSTR(MAX_MESSAGE_ID, -8)+A.SANCTN_SN) AS MAX_MESSAGE_ID
			, B.MSSAGE_DESC	AS MESSAGE_DESC		
			, TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI') AS SEND_DT
			FROM
			(
			SELECT 	B.TODO_ID
					, /* A.TEL_NO */ '010-7501-8741' AS TEL_NO		/*수신인전화번호 */
					, B.TODO_NO
					, B.SANCTN_SN 
					, B.TODO_TITL
					, A.NAME
					, DECODE(B.TODO_DIV1_CODE_ID, 'TODODIV10', 'S', 'TODODIV20', 'A') AS DIV_GB
					FROM TB_CM06M01 A
					<if test='isFinalApproval == null'>
					LEFT OUTER JOIN TB_WB20M03 B ON(A.ID=B.TODO_ID)
					</if>
					<choose> 
						<when test="isFinalApproval == null or isFinalApproval.equals('')">
						 	/* 일반결재 전체항목일 경우 */
							LEFT OUTER JOIN TB_WB20M03 B ON(A.ID=B.TODO_ID)
						</when>
						<when test='isFinalApproval == "Y"'>
							/* 결재완료일 경우 결재 상신자(1번)에게 보냄 */
							LEFT OUTER JOIN TB_WB20M03 B ON(A.ID=B.CREAT_ID)																			
						</when> 
					</choose> 					
				WHERE 1=1
			<if test="coCd != null and !coCd.equals('')">
				AND B.TODO_CO_CD = #{coCd}
			</if>
			<if test="todoDiv1CodeId != null and !todoDiv1CodeId.equals('')">
				AND B.TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
			</if>
			<if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
				AND B.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}			
			</if>			
			<if test="todoNo != null and !todoNo.equals('')">
				AND B.TODO_NO = #{todoNo}
			</if>	
			<if test="sanctnSn != null and !sanctnSn.equals('')">
				AND B.SANCTN_SN = #{sanctnSn}
			</if>											
			) A
			LEFT OUTER JOIN 
			(
				SELECT MAX(MAX_MESSAGE_ID) AS MAX_MESSAGE_ID
					, MAX(MSSAGE_DESC) AS MSSAGE_DESC
					, #{todoNo} AS TODO_NO			/* 이곳에 관리번호 */
					FROM
					(
						SELECT #{kakaoSeq} AS MAX_MESSAGE_ID 
								/* NVL(MAX_MESSAGE_ID, 'KAKAO'||TO_CHAR(SYSDATE, 'YY')||'000001') AS MAX_MESSAGE_ID */
								, '' AS MSSAGE_DESC		
							FROM
							(
								SELECT DISTINCT DECODE( INSTR(MESSAGE_ID, 'KAKAOA'||TO_CHAR(SYSDATE, 'YY')), 0, 'KAKAOA'||TO_CHAR(SYSDATE, 'YY')||'000001'
									, 'KAKAOA' || MAX( TO_CHAR(SYSDATE, 'YY')|| LPAD( SUBSTRING(MESSAGE_ID, -6)+1, 6, '0') ) OVER()
										  ) AS MAX_MESSAGE_ID
								FROM TB_BM18M01
							UNION ALL
							SELECT NULL AS MAX_MESSAGE_ID
								FROM DUAL		
							)		
							WHERE MAX_MESSAGE_ID IS NOT NULL OR ROWNUM = 1	
						UNION ALL 
						SELECT '' AS MAX_MESSAGE_ID
								, MSSAGE_DESC AS MSSAGE_DESC
							FROM TB_BM17M01
						WHERE 1=1
						<if test="tmplatDiv != null and !tmplatDiv.equals('')">
							AND TMPLAT_DIV = #{tmplatDiv}
						</if>
					)					
			) B ON(A.TODO_NO=B.TODO_NO)
	</select>	

	<!-- 알림톡 로그 등록 -->
	<insert id="insertKakaoMessage" parameterType="Map">	    
	    INSERT INTO TB_BM18M01
	      (
	          MESSAGE_ID
			, RCV_ID
			, RCV_NM
			, CLNT_CD
			, TMPLAT_DIV
			, SENDG_STATUS
			, TITLE
			, MESSAGE
			, MOBILE
			, NAME_TO
			, SEND_DT
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM 
	      )
	    VALUES
	    (
	          #{mssageId}
	    	, #{rcvId,  jdbcType=VARCHAR}	  		
	    	, #{rcvNm,  jdbcType=VARCHAR}	  
			, #{clntCd}
			, #{tmplatDiv}
			, #{sendgStatus}
			, #{title}
			, #{mssage}
			, #{mobile}
			, #{nameTo}				/* 수신회사명 */
			, SYSDATE
			, #{creatId}
			, #{creatPgm}
			, SYSDATE
	    )
	</insert>

</mapper>