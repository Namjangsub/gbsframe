<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.bm.bm10.mapper.BM10Mapper">

	<select id="selectBmPrdtMstrCount" parameterType="Map" resultType="int">
		SELECT 
			COUNT(*)
		FROM TB_BM10M01 BM10
	</select>
	
	<!-- 품번 카운터 -->
	<select id="selectBmProdCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		FROM TB_BM10M01
		<where>
			<if test="coCd != null and !coCd.equals('')">
            	CO_CD = '${coCd}' 
           </if>
           <!--	searchValue가 null이 아니고 빈 문자열이 아니며, searchType이 ''가 아닐 때, 
                 ${searchType}과 일치하는 열에서 ${searchValue}를 포함한 값을 검색  -->
			<if	test="searchValue != null and !searchValue.equals('') and !searchType.equals('')">
				AND ${searchType} LIKE '%${searchValue}%'
			</if>
			<!-- searchValue가 null과 빈 문자열이 아니며, searchType이 ''일 때, 
			     'PROD_CD' 열이 ${searchValue}와 일치하는 값을 검색  -->
			<if
				test="searchValue != null and !searchValue.equals('') and searchType.equals('')">
				AND PROD_CD = #{searchValue}
			</if>
			<if test="prodCd != null and !prodCd.equals('')">
				AND PROD_CD = #{prodCd} -- 품번 
			</if>		
			<if test="prodNm != null and !prodNm.equals('')">
				AND PROD_NM LIKE '%${prodNm}%' -- 품명
			</if>
		</where>
	</select>
	
	
	<!-- 	제품 -->
	<select id="selectBmPrdtMstrList" parameterType="Map" resultType="camelMap">
		
		SELECT * FROM ( 
			SELECT ROWNUM AS RN			   
			 , A.FILE_TRGT_KEY
		     , A.CO_CD
		     , R.CODE_NM AS CO_CD_NM
		     
		     , A.PROD_CD
		     , A.PROD_NM
		     , A.CLNT_PJT
		     , A.GOODS_DIV
		     , R1.CODE_NM AS GOODS_DIV_NM
		     
		     , A.PRDT_CD
		     , P.PRDT_NM
		     , A.ITEM_DIV
		     , R2.CODE_NM AS ITEM_DIV_NM
		     
		     , A.PROD_DTL_DIV20
		     , R3.CODE_NM AS PROD_DTL_DIV20_NM
		     
		     , A.PROD_DTL_DIV30
		     , R4.CODE_NM AS PROD_DTL_DIV30_NM
		     
		     , A.DSGN_DIF_CODE_ID
		     , R5.CODE_NM AS DSGN_DIF_CODE_NM
		     
		     , A.PRDCTN_DIF_CODE_ID
		     , R6.CODE_NM AS PRDCTN_DIF_CODE_NM
		     
		     , A.PROD_WT
		     , A.PROD_UNIT
		     , R7.CODE_NM AS PROD_UNIT_NM
		     
		     , A.PROD_SIZE
		     , REGEXP_REPLACE(TO_CHAR(A.PROD_UPR, 'FM999,999,999'), '(\d{3})', '\1') AS PROD_UPR
		     , A.PROD_UPR_DT
		     , A.PROD_RMK
		     , A.USE_YN
		     , A.CREAT_ID
		     , A.CREAT_PGM
		     , TO_CHAR(A.CREAT_DTTM,'YYYY-MM-DD HH:MM:SS') AS CREAT_DTTM
		     , A.UDT_ID
		     , A.UDT_PGM
		     , TO_CHAR(A.UDT_DTTM,'YYYY-MM-DD HH:MM:SS') AS UDT_DTTM
		FROM   TB_BM10M01 AS A
		       LEFT JOIN TB_BM01M01 AS P  ON P.PRDT_CD  = A.PRDT_CD
	           LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD
	           LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = A.GOODS_DIV
	           LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.ITEM_DIV
	           LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = A.PROD_DTL_DIV20
	           LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = A.PROD_DTL_DIV30
	           LEFT JOIN TB_CM05M01 AS R5 ON R5.CODE_ID = A.DSGN_DIF_CODE_ID
	           LEFT JOIN TB_CM05M01 AS R6 ON R6.CODE_ID = A.PRDCTN_DIF_CODE_ID
	           LEFT JOIN TB_CM05M01 AS R7 ON R7.CODE_ID = A.PROD_UNIT ) Z
		WHERE  
				
                Z.CO_CD LIKE '${coCd}' 
				
			   	<if test="goodsDiv != null and !goodsDiv.equals('')">
                AND Z.GOODS_DIV = '${goodsDiv}'                
             	</if>
             	<if test="prdtCdNm != null and !prdtCdNm.equals('')">
                AND Z.PRDT_NM LIKE '%'||'${prdtCdNm}'||'%'               
             	</if>
             	<if test="itemDiv != null and !itemDiv.equals('')">
                AND Z.ITEM_DIV = '${itemDiv}'                
             	</if>
             	<if test="prodCd != null and !prodCd.equals('')">
                AND Z.PROD_CD LIKE '%'||'${prodCd}'||'%'             
             	</if>
             	<if test="prodNm != null and !prodNm.equals('')">
                AND Z.PROD_NM LIKE '%'||'${prodNm}'||'%'             
             	</if>            	
				
             	AND  RN BETWEEN ${firstIndex} AND ${lastIndex}
	
	<!-- 	<if test="coCd != null and !coCd.equals('')">
            AND X.CO_CD = ${coCd}'                
       	</if>
       	<if test="goodsDiv != null and !goodsDiv.equals('')">
       		AND X.GOODS_DIV = ${goodsDiv}'
       	</if> -->
	</select>
	
	<!-- 	품번 -->
	<select id="selectBmProdSearchList" parameterType="Map" resultType="camelMap">
	SELECT * FROM ( 
		SELECT ROWNUM AS RN			   
			 , A.FILE_TRGT_KEY
		     , A.CO_CD
		     , R.CODE_NM AS CO_CD_NM
		     
		     , A.PROD_CD
		     , A.PROD_NM
		     , A.CLNT_PJT
		     , A.GOODS_DIV
		     , R1.CODE_NM AS GOODS_DIV_NM
		     
		     , A.PRDT_CD
		     , P.PRDT_NM
		     , A.ITEM_DIV
		     , R2.CODE_NM AS ITEM_DIV_NM
		     
		     , A.PROD_DTL_DIV20
		     , R3.CODE_NM AS PROD_DTL_DIV20_NM
		     
		     , A.PROD_DTL_DIV30
		     , R4.CODE_NM AS PROD_DTL_DIV30_NM
		     
		     , A.CREAT_ID
		     , TO_CHAR(A.CREAT_DTTM,'YYYY-MM-DD HH:MM:SS') AS CREAT_DTTM
		     , A.UDT_ID
		     , TO_CHAR(A.UDT_DTTM,'YYYY-MM-DD HH:MM:SS') AS UDT_DTTM
		FROM   TB_BM10M01 AS A
		       LEFT JOIN TB_BM01M01 AS P  ON P.PRDT_CD  = A.PRDT_CD
	           LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD
	           LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = A.GOODS_DIV
	           LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.ITEM_DIV
	           LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = A.PROD_DTL_DIV20
	           LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = A.PROD_DTL_DIV30
	           LEFT JOIN TB_CM05M01 AS R5 ON R5.CODE_ID = A.DSGN_DIF_CODE_ID
	           LEFT JOIN TB_CM05M01 AS R6 ON R6.CODE_ID = A.PRDCTN_DIF_CODE_ID
	           LEFT JOIN TB_CM05M01 AS R7 ON R7.CODE_ID = A.PROD_UNIT ) Z

		WHERE  
              	RN BETWEEN ${firstIndex} AND ${lastIndex}              	
              	<if	test="searchValue != null and !searchValue.equals('') and !searchType.equals('')">
				AND ${searchType} LIKE '%${searchValue}%'
				</if>
				<if test="searchValue != null and !searchValue.equals('') and searchType.equals('')">
					AND PROD_CD = #{searchValue}
				</if>
             	<if test="prodCd != null and !prodCd.equals('')">
                AND Z.PROD_CD LIKE '%'||'${prodCd}'||'%'                    
             	</if>
             	<if test="prodNm != null and !prodNm.equals('')">
                AND Z.PROD_NM LIKE '%'||'${prodNm}'||'%'         
             	</if>
             
	</select>
	

	<update id="updateBmPrdtMstr" parameterType="Map">
			UPDATE TB_BM10M01
			SET					
				USE_YN = #{useYn},				
				DSGN_DIF_CODE_ID = #{dsgnDifCodeId},				
				PRDCTN_DIF_CODE_ID = #{prdctnDifCodeId},				
				PROD_WT = #{prodWt},				
				PROD_SIZE = #{prodSize},					
				PROD_RMK = #{prodRmk},
				UDT_ID = #{creatId},
				UDT_PGM = #{creatPgm},
				UDT_DTTM = SYSDATE				
			WHERE
<!-- 				CO_CD = #{coCd} -->
			FILE_TRGT_KEY = #{fileTrgtKey}
	</update>
	
		<!-- update되는 부분 if 처리 하기 -->
<!-- 	<update id="updateBmPrdtMstr" parameterType="Map"> -->
<!-- 		UPDATE TB_BM10M01 -->
<!-- 			SET -->
<!-- 				<if test='coCd != null and coCd != ""'> -->
<!-- 				CO_CD = #{coCd}, -->
<!-- 				</if> -->
<!-- 				<if test='useYn != null and useYn != ""'> -->
<!-- 				USE_YN = #{useYn}, -->
<!-- 				</if> -->
<!-- 				<if test='dsgnDifCodeId != null and dsgnDifCodeId != ""'> -->
<!-- 				DSGN_DIF_CODE_ID = #{dsgnDifCodeId},. -->
<!-- 				</if> -->
<!-- 				<if test='prdctnDifCodeId != null and prdctnDifCodeId != ""'> -->
<!-- 				PRDCTN_DIF_CODE_ID = #{prdctnDifCodeId},	 -->
<!-- 				</if>			 -->
<!-- 				<if test='prodWt != null and prodWt != ""'> -->
<!-- 				PROD_WT = #{prodWt}, -->
<!-- 				</if> -->
<!-- 				<if test='prodSize != null and prodSize != ""'> -->
<!-- 				PROD_SIZE = #{prodSize}	 -->
<!-- 				</if> -->
<!-- 				<if test='prodRmk != null and prodRmk != ""'> -->
<!-- 				PROD_RMK = #{prodRmk}	 -->
<!-- 				</if> -->
				
<!-- 		WHERE  -->
<!-- 				CO_CD = #{coCd}            -->
<!-- 	</update> -->

		
		    <!-- List 부분 if 처리 하기 -->
	<insert id="insertBmPrdtMstr" parameterType="Map">
		
		<selectKey keyProperty="fileTrgtKey" resultType="String" order="BEFORE">
       		SELECT NVL(MAX(FILE_TRGT_KEY),0) + 1 FROM TB_BM10M01
		</selectKey>	
	 
		INSERT INTO TB_BM10M01 
		(
			FILE_TRGT_KEY,	-- 시퀀스 안씀
			CO_CD, -- 회사
			PROD_CD, --품번
			GOODS_DIV, --품목구분
			PROD_NM, --품명
			<if test="prdtCdNm != null and prdtCdNm !=''"> 
			PRDT_CD, --제품구분
			</if>
			ITEM_DIV, --아이템구분
			PROD_DTL_DIV20, --작업구분
			PROD_DTL_DIV30,-- 자체구분
			CLNT_PJT, --고객사PJT
			USE_YN,--사용여부
			DSGN_DIF_CODE_ID,--설계난이도
			PRDCTN_DIF_CODE_ID, --생산난이도
			PROD_WT, --중량
			PROD_SIZE,--크기
			PROD_UPR,--단가			
			PROD_UPR_DT,--단가기준일
			PROD_RMK--비고(특이사항)
		)
		VALUES
		(
			#{fileTrgtKey},
			#{coCd},
			#{prodCd},
			#{goodsDiv},
			#{prodNm},
			#{prdtCdNm},
			#{itemDiv},
			#{prodDtlDiv20},
			#{prodDtlDiv30},
			#{clntPjt},
			#{useYn},
			#{dsgnDifCodeId},
			#{prdctnDifCodeId},
			#{prodWt},
			#{prodSize},
			#{prodUpr},
			#{prodUprDt},
			#{prodRmk}
		)
	</insert>
</mapper>