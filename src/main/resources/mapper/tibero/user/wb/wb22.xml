<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb22.mapper.WB22Mapper">
<select id="selectWbsLeftSalesCodeList" parameterType="Map" resultType="camelMap"> 
         SELECT * FROM (
                  SELECT ROWNUM AS RN, S.* FROM (           
                        SELECT DISTINCT  
                               '' PID,
                               #{coCd} ID,
                               #{coCd} CO_CD, -- 회사코드
                               FN_CM05M01_CD_TO_NM(#{coCd}) AS CO_CD_NM,
                               '전체' ORDRS_NO,
                               '전사 현황' AS SALES_CD,
                               '' ORGN_SALES_CD,
                               '' ORDRS_CLNT_CD, -- 고객사
                               '전체' AS ORDRS_CLNT_NM,
                               '' CLNT_PJT,
                               '' ORDRS_DTL_DIV20, -- 신작구분
                               '' AS ORDRS_DTL_DIV20_NM,
                               '', -- 설비명
                               0 PLAN_CNT,
                               'E' WBS_PLAN_OS_YN,
                               'E' PLAN_LOCK_YN,
                               'E' PLAN_CLOSE_YN,
                               0 RSULT_CNT,
                               'E' RSULT_LOCK_YN,
                               'E' RSULT_CLOSE_YN,
                               '' DATA_GBN
                          FROM DUAL
        
                      UNION ALL  --회사명을 Top LEVEL 생성
                        SELECT DISTINCT  
                               X.CO_CD PID,
                               TO_CHAR(Y.ORDRS_CLNT_CD) ID,
                               X.CO_CD, -- 회사코드
                               FN_CM05M01_CD_TO_NM(X.CO_CD) AS CO_CD_NM,
                               A.CLNT_NM,
                               A.CLNT_NM  AS SALES_CD,
                               '' ORGN_SALES_CD,
                               Y.ORDRS_CLNT_CD , -- 고객사
                               A.CLNT_NM  AS ORDRS_CLNT_NM,
                               '' CLNT_PJT,
                               '' ORDRS_DTL_DIV20, -- 신작구분
                               '' AS ORDRS_DTL_DIV20_NM,
                               '', -- 설비명
                               0 PLAN_CNT,
                               'E' WBS_PLAN_OS_YN,
                               'E' PLAN_LOCK_YN,
                               'E' PLAN_CLOSE_YN,
                               0 RSULT_CNT,
                               'E' RSULT_LOCK_YN,
                               'E' RSULT_CLOSE_YN,
                               ''
                          FROM TB_CR02D02 X
                                INNER JOIN TB_CR02M01 Y  ON X.CO_CD = Y.CO_CD
                                                        AND X.ORDRS_NO = Y.ORDRS_NO
                                LEFT OUTER JOIN TB_BM02M01 A ON Y.ORDRS_CLNT_CD = A.CLNT_CD --거래처마스터
                        WHERE X.CO_CD = #{coCd}
                       <if test="salesCd != null and !salesCd.equals('')">
                          AND X.SALES_CD LIKE '%${salesCd}%'             
                       </if>
                         
                       UNION ALL --오더번호로 1 LEVEL 생성
                        SELECT DISTINCT  
                               TO_CHAR(Y.ORDRS_CLNT_CD) PID,
                               X.ORDRS_NO ID,
                               X.CO_CD, -- 회사코드
                               FN_CM05M01_CD_TO_NM(X.CO_CD) AS CO_CD_NM,
                               X.ORDRS_NO AS ORDRS_NO,
                               X.ORDRS_NO AS SALES_CD,
                               '',
                               Y.ORDRS_CLNT_CD, -- 고객사
                               A.CLNT_NM  AS ORDRS_CLNT_NM,
                               '',
                               '',
                               '',
                               '', -- 설비명
                               0 PLAN_CNT,
                               'E' WBS_PLAN_OS_YN,
                               'E' PLAN_LOCK_YN,
                               'E' PLAN_CLOSE_YN,
                               0 RSULT_CNT,
                               'E' RSULT_LOCK_YN,
                               'E' RSULT_CLOSE_YN,
                               ''
                          FROM TB_CR02D02 X
                                INNER JOIN TB_CR02M01 Y  ON X.CO_CD = Y.CO_CD
                                                        AND X.ORDRS_NO = Y.ORDRS_NO
                                LEFT OUTER JOIN TB_BM02M01 A ON Y.ORDRS_CLNT_CD = A.CLNT_CD --거래처마스터
                         WHERE X.CO_CD = #{coCd}
                       <if test="salesCd != null and !salesCd.equals('')">
                          AND X.SALES_CD = '%${salesCd}%'              
                       </if>
        
                       UNION ALL
                        SELECT   --Sales 코드 추출
                               X.ORDRS_NO PID,
                               X.SALES_CD ID,
                               X.CO_CD, -- 회사코드
                               FN_CM05M01_CD_TO_NM(X.CO_CD) AS CO_CD_NM,
                               X.ORDRS_NO, -- 수주번호
                               X.SALES_CD, -- SALES CODE
                               max(Y.ORGN_SALES_CD), -- 원천 SALES CODE
                               max(Y.ORDRS_CLNT_CD), -- 고객사
                               max(A.CLNT_NM)  AS ORDRS_CLNT_NM,
                               max(Y.CLNT_PJT), -- 고객사 PJT
                               max(X.ORDRS_DTL_DIV20), -- 신작구분
                               FN_CM05M01_CD_TO_NM(max(X.ORDRS_DTL_DIV20)) AS ORDRS_DTL_DIV20_NM,
                               max(X.EQP_NM), -- 설비명
                               COUNT(W.FILE_TRGT_KEY) PLAN_CNT,
                               NVL(max(W.WBS_PLAN_OS_YN),'N') WBS_PLAN_OS_YN,
                               NVL(max(W.LOCK_YN),'N') PLAN_LOCK_YN,
                               NVL(max(W.CLOSE_YN),'N') PLAN_CLOSE_YN,
                               COUNT(Z.FILE_TRGT_KEY) RSULT_CNT,
                               NVL(max(Z.LOCK_YN),'N') RSULT_LOCK_YN,
                               NVL(max(Z.CLOSE_YN),'N') RSULT_CLOSE_YN,
                               'D' DATA_GBN  --원시데이타
                          FROM TB_CR02D02 X
                                INNER JOIN TB_CR02M01 Y  ON X.CO_CD    = Y.CO_CD
                                                        AND X.ORDRS_NO = Y.ORDRS_NO
                                                        AND X.CO_CD = #{coCd}
                                                       <if test="salesCd != null and !salesCd.equals('')">
                                                        AND X.SALES_CD LIKE '%${salesCd}%'              
                                                       </if>
                                CROSS JOIN (
                                                        SELECT 
                                                                 CASE WHEN CODE_KIND = 'ROOT' THEN '' ELSE CODE_KIND END CODE_KIND,
                                                                 CODE_ID,
                                                                 CODE_RPRC,
                                                                 CODE_NM,
                                                                 CASE WHEN LEVEL = '1' THEN CODE_NM ELSE '' END LVL1,
                                                                 CASE WHEN LEVEL = '2' THEN CODE_NM ELSE '' END LVL2,
                                                                 CASE WHEN LEVEL = '3' THEN CODE_NM ELSE '' END LVL3,
                                                                 LPAD('', 3*(LEVEL-1)) || LEVEL LVL,
                                                                 REGEXP_REPLACE(SYS_CONNECT_BY_PATH(CODE_ID, ' -> '), '^\s+\-\>\s+', '') as PATH,
                                                                 CONNECT_BY_ISLEAF AS IS_LEAF,
                                                                 CASE WHEN CONNECT_BY_ISLEAF = 0 THEN 'unit' ELSE 'leaf' END TYPE
                                                         FROM TB_CM05M01
                                                         START WITH CODE_ID = 'WBSDIV'
                                                         CONNECT BY PRIOR CODE_ID  =  CODE_KIND 
                                        ) CD  
                                LEFT OUTER JOIN TB_WB01M01 W  ON X.CO_CD    = W.CO_CD
                                                             AND X.SALES_CD = w.SALES_CD  
                                                             AND CD.CODE_ID = W.WBS_PLAN_CODE_ID
                                LEFT OUTER JOIN TB_WB02M01 Z  ON X.CO_CD    = Z.CO_CD
                                                             AND X.SALES_CD = Z.SALES_CD  
                                                             AND CD.CODE_ID = Z.WBS_PLAN_CODE_ID
                                LEFT OUTER JOIN TB_BM02M01 A ON Y.ORDRS_CLNT_CD = A.CLNT_CD                       
                        GROUP BY X.ORDRS_NO, X.SALES_CD, X.CO_CD,Y.ORGN_SALES_CD,Y.ORDRS_CLNT_CD, Y.CLNT_PJT 
                                          
                    )S
                    WHERE CO_CD = #{coCd}
                    AND SALES_CD LIKE '%${salesCd}%' ) X  
                

           </select>    
	       
	       <select id="selectSjInfo" parameterType="Map"  resultType="camelMap">
            SELECT  X.CO_CD,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS CO_CD_NM,
                    X.SJ_NO,
                    X.SJ_NM,
                    X.VER_NO,
                    X.SALES_CD,
                    X.MKER_DIV,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.MKER_DIV) AS MKER_DIV_NM,
                    X.MKER_CD,
                    (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD = X.MKER_CD) AS MKER_NM,
                    X.SMRIZE_ID,
                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.SMRIZE_ID) AS SMRIZE_NM,
                    TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD') AS BEGIN_DT,
                    TO_CHAR(X.DE_DT, 'YYYY-MM-DD') AS DE_DT,
                    TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD') AS ACPTNC_DT,
                    X.REQRE_DAYCNT,
                    X.DSGN_DIF_CODE_ID,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.DSGN_DIF_CODE_ID) AS DSGN_DIF_CODE_NM,
                    X.DSGN_PLAN_HOUR,
                    X.PRDCTN_DIF_CODE_ID,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.PRDCTN_DIF_CODE_ID) AS PRDCTN_DIF_CODE_NM,
                    X.PRDCTN_PLAN_HOUR,
                    X.SJ_RMK,
                    X.CLOSE_YN,
                    X.CREAT_ID,
                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CREAT_ID) AS CREAT_NM,
                    X.CREAT_PGM,
                    TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM,
                    X.UDT_ID,
                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.UDT_ID) AS UDT_NM,
                    X.UDT_PGM,
                    TO_CHAR(UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM,
                    CR.CLNT_CD,
                    CR.CLNT_NM,
                    CR.PRDT_CD,
                    CR.PRDT_NM,
                    CR.CLNT_PJT,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.CLNT_PJT) AS CLNT_PJT_NM
                    FROM TB_WB21M01 X
                    LEFT OUTER JOIN (
                        SELECT  
                           CR.CO_CD, 
                           CR.ORDRS_NO,
                           CR.SALES_CD, 
                           Y.ORDRS_CLNT_CD AS CLNT_CD, 
                           (SELECT P.CLNT_NM FROM TB_BM02M01 P WHERE P.CLNT_CD = Y.ORDRS_CLNT_CD) AS CLNT_NM,
                           Y.CLNT_PJT, 
                           CR.ORDRS_DTL_DIV20, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                           CR.PRDT_CD, 
                           (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = CR.PRDT_CD) AS PRDT_NM,
                           CR.ITEM_DIV, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ITEM_DIV) AS ITEM_DIV_NM,
                           CR.EQP_NM
                        FROM TB_CR02D02 CR INNER JOIN TB_CR02M01 Y  ON CR.CO_CD = Y.CO_CD
                                                                 AND CR.ORDRS_NO = Y.ORDRS_NO) CR
                ON CR.CO_CD = X.CO_CD
                AND CR.SALES_CD = X.SALES_CD          
                WHERE X.CO_CD = #{coCd} 
                AND X.SALES_CD = #{salesCd}
                AND X.VER_NO = (SELECT MAX(VER_NO) FROM TB_WB21M01 WHERE CO_CD = #{coCd} AND SALES_CD = #{salesCd})
        </select>
               
        <select id="selectMaxWbsPlanNo" parameterType="Map"  resultType="int">
              SELECT  #{year} || trim(to_char(nvl(SUBSTR(MAX(WBS_PLAN_NO), 5, 4),0) + 1, '0000')) AS WBS_PLAN_NO FROM TB_WB22M01 
              WHERE CO_CD = #{coCd}   
        </select>
                
        <select id="selectMaxWbsCode" parameterType="Map"  resultType="int">
             SELECT to_char(NVL(MAX(SUBSTR(WBS_PLAN_CODE_ID, 10, 2)),0) + 1,'00') FROM TB_WB22M01 
             WHERE LENGTH(WBS_PLAN_CODE_ID) >9
             AND CO_CD = #{coCd} 
             AND SALES_CD = #{salesCd}
             AND WBS_PLAN_CODE_KIND = #{wbsPlanCodeKind}  
        </select>
                
        <select id="selectWbsSeqNext" parameterType="Map" resultType="int">
             SELECT TB_WB22M01_SQ01.NEXTVAL FROM DUAL
        </select>
       
        <select id="selectWBS1Level" parameterType="Map"  resultType="camelMap">
		       SELECT ROWNUM AS RN,
		              X.CODE_ID AS WBS_PLAN_CODE_ID, 
		              X.CODE_NM AS WBS_PLAN_CODE_NM, 
		              X.SORT_NO, 
		              Y.FILE_TRGT_KEY,
                      #{coCd} AS CO_CD,
                      Y.WBS_PLAN_NO,
                      Y.VER_NO,
                      #{salesCd} AS SALES_CD,                                
                      NVL(Y.WBS_PLAN_MNG_ID, '') AS WBS_PLAN_MNG_ID,
                      NVL((SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = Y.WBS_PLAN_MNG_ID), '') AS WBS_PLAN_MNG_NM,
                      <!-- NVL(Y.WBS_PLANS_DT, #{beginDt,  jdbcType=VARCHAR}) AS WBS_PLANS_DT,
                      NVL(Y.WBS_PLANE_DT, #{acptncDt,  jdbcType=VARCHAR}) AS WBS_PLANE_DT, -->
                      NVL(Y.WBS_PLANS_DT, '') AS WBS_PLANS_DT,
                      NVL(Y.WBS_PLANE_DT, '') AS WBS_PLANE_DT,
                      Y.DAYCNT,
                      NVL(Y.WBS_PLAN_STS_CODE_ID, 'WBSPLANSTS10') AS WBS_PLAN_STS_CODE_ID,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = NVL(Y.WBS_PLAN_STS_CODE_ID, 'WBSPLANSTS10')) AS WBS_PLAN_STS_CODE_ID_NM,
                      Y.LOCK_YN,
                      Y.CLOSE_YN,
                      Y.CREAT_ID,
                      Y.CREAT_PGM,
                      Y.CREAT_DTTM,
                      Y.UDT_ID,
                      Y.UDT_PGM,
                      Y.UDT_DTTM 
		              FROM (
		                  SELECT CODE_ID, 
		                         CODE_NM, 
		                         SORT_NO 
		                         FROM TB_CM05M01 
		                  WHERE CODE_KIND = 'WBSCODE'  
		                  AND USE_YN = 'Y'
		                  ORDER BY SORT_NO ASC ) X
		             LEFT OUTER JOIN 
		                 (SELECT 
					            FILE_TRGT_KEY,
					            WBS_PLAN_CODE_ID,
					            WBS_PLAN_NO,
					            VER_NO,
					            WBS_PLAN_MNG_ID,
					            TO_CHAR(WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT,
					            TO_CHAR(WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT,
					            DAYCNT,
					            WBS_PLAN_STS_CODE_ID,
					            LOCK_YN,
					            CLOSE_YN,
					            CREAT_ID,
					            CREAT_PGM,
					            CREAT_DTTM,
					            UDT_ID,
					            UDT_PGM,
					            UDT_DTTM
					            FROM TB_WB22M01 
		                  WHERE CO_CD = #{coCd}
		                  AND SALES_CD = #{salesCd}) Y
		            ON X.CODE_ID = Y.WBS_PLAN_CODE_ID
           </select>

         <select id="selectWBS2Level" parameterType="Map"  resultType="camelMap"> 
              SELECT ROWNUM AS RN,   
                     X.FILE_TRGT_KEY,
                     X.CO_CD,
                     X.WBS_PLAN_NO,
                     X.WBS_PLAN_CODE_KIND,
                     (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_CODE_KIND) AS WBS_PLAN_CODE_KIND_NM,
                     X.WBS_PLAN_CODE_ID,
                     X.WBS_PLAN_CODE_NM,
                     X.SALES_CD,
                     X.SEQ,
                     X.VER_NO,
                     X.WBS_PLAN_MNG_ID,
                     (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.WBS_PLAN_MNG_ID) AS WBS_PLAN_MNG_NM,
                     TO_CHAR(X.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT,
                     TO_CHAR(X.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT,
                     X.DAYCNT,
                     X.WBS_PLAN_STS_CODE_ID,
                     (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_STS_CODE_ID) AS WBS_PLAN_STS_CODE_ID_NM,
                     X.CLOSE_YN,
                     X.CREAT_ID,
                     X.CREAT_PGM,
                     X.CREAT_DTTM,
                     X.UDT_ID,
                     X.UDT_PGM,
                     X.UDT_DTTM,
                     Y.FILE_TRGT_KEY AS RSLTS_FILE_TRGT_KEY,
                     Y.WBS_RSLTS_NO,
                     Y.WBS_RSLTS_ID,
                     (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = Y.WBS_RSLTS_ID) AS WBS_RSLTS_NM,
                     Y.WBS_RSLTS_RATE,
                     Y.WBS_PLAN_MH AS WBS_RSLTS_PLAN_MH, 
                     Y.WBS_RSLTS_MH,
                     Y.WBS_RSLTS_CNTS,
                     TO_CHAR(Y.WBS_RSLTSS_DT, 'YYYY-MM-DD') AS WBS_RSLTSS_DT,
                     TO_CHAR(Y.WBS_RSLTSE_DT, 'YYYY-MM-DD') AS WBS_RSLTSE_DT,
                     Y.DAYCNT AS RSLTS_DAYCNT,
                     NVL(Y.CLOSE_YN,'N') AS RSLTS_CLOSE_YN
                FROM TB_WB22M01 X
                LEFT OUTER JOIN TB_WB23M01 Y
                ON X.CO_CD = Y.CO_CD
                AND X.SALES_CD = Y.SALES_CD
                AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND
                AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID           
                AND X.WBS_PLAN_NO = Y.WBS_RSLTS_NO                
                WHERE X.CO_CD = #{coCd}
                AND X.SALES_CD = #{salesCd}
                AND X.WBS_PLAN_CODE_KIND = #{wbsPlanCodeKind}               
           </select>
   
   
           <insert id="wbsLevel1Insert" parameterType="Map">
                INSERT INTO TB_WB22M01
                (
				    FILE_TRGT_KEY,
				    CO_CD,
				    WBS_PLAN_NO,
				    WBS_PLAN_CODE_KIND,
				    WBS_PLAN_CODE_ID,
				    SALES_CD,
				    VER_NO,
				    SEQ,
				    WBS_PLAN_MNG_ID,
				    WBS_PLANS_DT,
				    WBS_PLANE_DT,
				    DAYCNT,
				    WBS_PLAN_STS_CODE_ID,
				    CREAT_ID,
				    CREAT_PGM,
				    CREAT_DTTM
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{coCd},
                    #{wbsPlanNo},
                    'WBSCODE',
                    #{wbsPlanCodeId},
                    #{salesCd},
                    #{verNo},
                    #{sortNo},
                    #{wbsPlanMngId},
                    #{wbsPlansDt},
                    #{wbsPlaneDt},
                    #{daycnt},
                    #{wbsPlanStsCodeId},
                    #{creatId},
                    #{creatPgm},
                    SYSDATE
                )
         </insert>
         
          <update id="wbsLevel1Update" parameterType="Map">
                UPDATE TB_WB22M01
                SET WBS_PLAN_CODE_ID = #{wbsPlanCodeId},
                    WBS_PLAN_MNG_ID = #{wbsPlanMngId},
                    WBS_PLANS_DT = #{wbsPlansDt},
                    WBS_PLANE_DT = #{wbsPlaneDt},
                    DAYCNT = #{daycnt},
                    WBS_PLAN_STS_CODE_ID = #{wbsPlanStsCodeId},
                    UDT_ID = #{creatId},
                    UDT_PGM = #{creatPgm},
                    UDT_DTTM = SYSDATE
               WHERE FILE_TRGT_KEY = #{fileTrgtKey}      
         </update>
         
        
           <select id="wbsPlanListChk" parameterType="Map" resultType="camelMap">
               SELECT *  FROM TB_WB22M01
                   WHERE CO_CD  = #{coCd}
                         AND SALES_CD  = #{salesCd}
                         AND WBS_PLAN_CODE_KIND  = #{wbsPlanCodeKind}                        
           </select>  
        
           <delete id="deleteWbsPlanlist" parameterType="Map">
               DELETE FROM TB_WB22M01
                   WHERE CO_CD = #{coCd}
                   AND SALES_CD = #{salesCd}
                   AND WBS_PLAN_CODE_KIND = #{wbsPlanCodeKind}
           </delete>
        
           <insert id="wbsLevel2Insert" parameterType="Map">
                INSERT INTO TB_WB22M01
                (
                    FILE_TRGT_KEY,
                    CO_CD,
                    WBS_PLAN_NO,
                    WBS_PLAN_CODE_KIND,
                    WBS_PLAN_CODE_ID,
                    WBS_PLAN_CODE_NM,
                    SALES_CD,
                    VER_NO,
                    SEQ,
                    WBS_PLAN_MNG_ID,
                    WBS_PLANS_DT,
                    WBS_PLANE_DT,
                    DAYCNT,
                    WBS_PLAN_STS_CODE_ID,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{coCd},
                    #{wbsPlanNo},
                    #{wbsPlanCodeKind},
                    #{wbsPlanCodeId},
                    #{wbsPlanCodeNm},
                    #{salesCd},
                    #{verNo},
                    #{seq},
                    #{wbsPlanMngId},
                    #{wbsPlansDt},
                    #{wbsPlaneDt},
                    #{daycnt},
                    #{wbsPlanStsCodeId},
                    #{creatId},
                    #{creatPgm},
                    SYSDATE
                )
         </insert>
         
          <update id="wbsLevel2Update" parameterType="Map">
                UPDATE TB_WB22M01
                    SET SEQ = #{seq},
                        WBS_PLAN_CODE_NM = #{wbsPlanCodeNm},
                        WBS_PLAN_MNG_ID = #{wbsPlanMngId},
                        WBS_PLANS_DT = #{wbsPlansDt},
                        WBS_PLANE_DT = #{wbsPlaneDt},
                        DAYCNT = #{daycnt},
                        WBS_PLAN_STS_CODE_ID = #{wbsPlanStsCodeId},
                        UDT_ID = #{creatId},
                        UDT_PGM = #{creatPgm},
                        UDT_DTTM = SYSDATE 
                    WHERE FILE_TRGT_KEY = #{fileTrgtKey}                
         </update>
         
         
         <delete id="wbsLevel2Delete" parameterType="Map">
               DELETE FROM TB_WB22M01
                   WHERE FILE_TRGT_KEY = #{fileTrgtKey}
         </delete>
         
         <select id="selectVerNoNext" parameterType="Map" resultType="camelMap">
             SELECT NVL(MAX(VER_NO), 0) + 1 AS VER_NO FROM TB_WB22M01
               WHERE CO_CD = #{coCd}
               AND SALES_CD = #{salesCd}
         </select>
           
         <update id="wbsVerUpUpdate" parameterType="Map">
                UPDATE TB_WB22M01
                    SET VER_NO = #{newVerNo},
                        CLOSE_YN = 'N'
                WHERE CO_CD = #{coCd}
                AND SALES_CD = #{salesCd}
                AND VER_NO = #{verNo}
                      
         </update>  
         
         <insert id="wbsVerUpInsert" parameterType="Map">
                INSERT INTO TB_WB22M01_HIST
                (
                    FILE_TRGT_KEY,
                    CO_CD,
                    WBS_PLAN_NO,
                    WBS_PLAN_CODE_KIND,
                    WBS_PLAN_CODE_ID,
                    SALES_CD,
                    VER_NO,
                    SEQ,
                    WBS_PLAN_MNG_ID,
                    WBS_PLANS_DT,
                    WBS_PLANE_DT,
                    DAYCNT,
                    WBS_PLAN_STS_CODE_ID,
                    CLOSE_YN,
                    CLOSE_ID,
                    CLOSE_DTTM
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{coCd},
                    #{wbsPlanNo},
                    'WBSCODE',
                    #{wbsPlanCodeId},
                    #{salesCd},
                    #{verNo},
                    #{seq},
                    #{wbsPlanMngId},
                    #{wbsPlansDt},
                    #{wbsPlaneDt},
                    #{daycnt},
                    #{wbsPlanStsCodeId},
                    #{closeYn},
                    #{creatId},
                    SYSDATE
                )
         </insert>
         
         <update id="wbsLevel1confirm" parameterType="Map">
                 UPDATE TB_WB22M01
                  SET   WBS_PLAN_MNG_ID = #{wbsPlanMngId},
	                    WBS_PLANS_DT = #{wbsPlansDt},
	                    WBS_PLANE_DT = #{wbsPlaneDt},
	                    DAYCNT = #{daycnt},
	                    WBS_PLAN_STS_CODE_ID = #{wbsPlanStsCodeId},
	                    CLOSE_YN = #{flag},
	                    UDT_ID = #{creatId},
	                    UDT_PGM = #{creatPgm},
	                    UDT_DTTM = SYSDATE
                 WHERE FILE_TRGT_KEY = #{fileTrgtKey}             
         </update>
         
         <update id="wbsLevel2confirm" parameterType="Map">
                UPDATE TB_WB22M01
                    SET WBS_PLAN_CODE_NM = #{wbsPlanCodeNm},
                        WBS_PLAN_MNG_ID = #{wbsPlanMngId},
                        WBS_PLANS_DT = #{wbsPlansDt},
                        WBS_PLANE_DT = #{wbsPlaneDt},
                        DAYCNT = #{daycnt},
                        WBS_PLAN_STS_CODE_ID = #{wbsPlanStsCodeId},
                        CLOSE_YN = #{flag},
                        UDT_ID = #{creatId},
                        UDT_PGM = #{creatPgm},
                        UDT_DTTM = SYSDATE 
                    WHERE FILE_TRGT_KEY = #{fileTrgtKey}                       
         </update>
         
         <select id="selectRsltsSharngList" parameterType="Map" resultType="camelMap">
               SELECT ROWNUM AS RN,
                      X.SALES_CD, 
                      X.TODO_CODE_ID AS WBS_RSLTS_PLAN_CODE_ID,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_CODE_ID) AS WBS_RSLTS_PLAN_CODE_NM,
                      X.TODO_NO AS WBS_RSLTS_PLAN_NO,
                      X.TODO_CO_CD AS WBS_RSLTS_CO_CD,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_CO_CD) AS WBS_RSLTS_CO_CD_NM,                      
                      Y.ID AS WBS_SHARNG_USER_ID, 
                      Y.EMP_NO,
                      Y.NAME,
                      Y.TEL_NO,
                      Y.EMAIL,
                      TO_CHAR(X.TODO_CF_DT,'YYYY-MM-DD') AS TODO_CF_DT,
                      X.TODO_CF_OPN
                      FROM TB_WB20M03 X
                      INNER JOIN TB_CM06M01 Y
                      ON X.TODO_CO_CD = Y.CO_CD
                      AND X.TODO_ID = Y.ID
                      WHERE X.TODO_CO_CD = '${coCd}'
                      AND X.TODO_CODE_ID = '${codeId}' 
                      AND X.SALES_CD = '${salesCd}'
                      AND X.TODO_DIV2_CODE_ID = 'TODODIV1020'
                      ORDER BY ROWNUM ASC
          </select>
          
          
          <select id="selectRsltsApprovalList" parameterType="Map" resultType="camelMap">
               SELECT ROWNUM AS RN,
                      X.SALES_CD, 
                      X.TODO_CODE_ID AS WBS_RSLTS_PLAN_CODE_ID,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_CODE_ID) AS WBS_RSLTS_PLAN_CODE_NM,
                      X.TODO_NO AS WBS_RSLTS_PLAN_NO, 
                      X.TODO_CO_CD AS WBS_RSLTS_CO_CD,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_CO_CD) AS WBS_RSLTS_CO_CD_NM,                   
                      Y.ID AS WBS_SHARNG_USER_ID, 
                      Y.EMP_NO,
                      Y.NAME,
                      Y.TEL_NO,
                      Y.EMAIL,
                      TO_CHAR(X.TODO_CF_DT,'YYYY-MM-DD') AS TODO_CF_DT,
                      X.TODO_CF_OPN
                      FROM TB_WB20M03 X
                      INNER JOIN TB_CM06M01 Y
                      ON X.TODO_CO_CD = Y.CO_CD
                      AND X.TODO_ID = Y.ID
                      WHERE X.TODO_CO_CD = '${coCd}'
                      AND X.TODO_CODE_ID = '${codeId}' 
                      AND X.SALES_CD = '${salesCd}'
                      AND X.TODO_DIV2_CODE_ID = 'TODODIV2010'
                      ORDER BY ROWNUM ASC
          </select>
          
          <select id="selectWbsRstlsSeqNext" parameterType="Map" resultType="int">
             SELECT TB_WB23M01_SQ01.NEXTVAL FROM DUAL
          </select>
          
          <insert id="wbsRsltsInsert" parameterType="Map">
                INSERT INTO TB_WB23M01
                (
                        FILE_TRGT_KEY,
                        CO_CD,
                        WBS_RSLTS_NO,
                        WBS_PLAN_CODE_KIND,
                        WBS_PLAN_CODE_ID,
                        SALES_CD,
                        WBS_RSLTS_ID,
                        WBS_RSLTS_RATE,
                        WBS_RSLTS_MH,
                        WBS_RSLTS_CNTS,
                        WBS_RSLTSS_DT,
                        WBS_RSLTSE_DT,
                        DAYCNT,
                        LOCK_YN,
                        CLOSE_YN,
                        CREAT_ID,
                        CREAT_PGM,
                        CREAT_DTTM                 
                ) 
                VALUES
                (       
                        #{rsltsFileTrgtKey},
                        #{coCd},
                        #{wbsRsltsNo},
                        #{wbsPlanCodeKind2_P},
                        #{wbsPlanCodeId2_P},
                        #{salesCd2_P},
                        #{wbsRsltsId},
                        #{wbsRsltsRate},
                        #{wbsRsltsMh},
                        #{wbsRsltsCnts},
                        #{wbsRsltssDt},
                        #{wbsRsltseDt},
                        #{rsltsDaycnt},
                        'N',
                        'N',
                        #{userId},
                        #{pgmId},
                        SYSDATE  
                )
                
         </insert>   
         
         <update id="wbsRsltsUpdate" parameterType="Map">
                UPDATE TB_WB23M01
                    SET WBS_RSLTS_RATE = #{wbsRsltsRate},
                        WBS_RSLTS_MH = #{wbsRsltsMh},
                        WBS_RSLTS_CNTS = #{wbsRsltsCnts},
                        WBS_RSLTSS_DT = #{wbsRsltssDt},
                        WBS_RSLTSE_DT = #{wbsRsltseDt},
                        DAYCNT = #{rsltsDaycnt},
                        UDT_ID = #{userId},
                        UDT_PGM = #{pgmId},
                        UDT_DTTM = SYSDATE     
                    WHERE FILE_TRGT_KEY =  #{rsltsFileTrgtKey}   
         </update>   
         
         <update id="wbsRsltsconfirm" parameterType="Map">
                UPDATE TB_WB23M01
                    SET CLOSE_YN = #{flag},
                        UDT_ID = #{userId},
                        UDT_PGM = #{pgmId},
                        UDT_DTTM = SYSDATE     
                    WHERE FILE_TRGT_KEY =  #{rsltsFileTrgtKey}   
         </update>   



         <select id="selectWbsSjListCount" parameterType="Map" resultType="int">
            WITH SJD AS --수주상세 
                 ( 
                  SELECT M.CO_CD                                              AS CO_CD        --회사코드
                        , (SELECT FN_CM05M01_CD_TO_NM(M.CO_CD) FROM DUAL)     AS CO_NM        --회사명 
                        , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
                        , X.SALES_CD                                           AS SALES_CD     --SALES Code
                        , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
                        , C.CLNT_NM                                            AS CLNT_NM      --고객명
                        , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
                        , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
                        , X.PRDT_CD
                        , (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = X.PRDT_CD) AS PRDT_NM
                     FROM TB_CR02M01  M --수주마스터
                          INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
                          INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
                    WHERE 1=1
                      AND M.CO_CD = #{coCd}
                 )
               , PLAN AS --WBS 계획정보 
                 (
                  SELECT CO_CD                   AS CO_CD        --회사코드
                        , SALES_CD                AS SALES_CD     --SALSES_CD
                        , CLOSE_YN                AS CLOSE_YN     --마감여부 
                        , COUNT(WBS_PLAN_CODE_ID) AS PLAN_CODE_CNT--계획LVL1 수
                     FROM TB_WB22M01--WBS계획
                    WHERE CO_CD = #{coCd}
                      AND WBS_PLAN_CODE_KIND = 'WBSCODE'
                    GROUP BY CO_CD 
                            , SALES_CD
                            , CLOSE_YN
                 )
               , SUBJ AS --과제정보
                 (
                  SELECT X.FILE_TRGT_KEY
                       , X.CO_CD                                                       AS CO_CD              --회사코드
                       , X.SALES_CD                                                    AS SALES_CD           --SALES Code
                       , X.SJ_NO                                                       AS SJ_NO              --과제번호
                       , X.SJ_NM                                                       AS SJ_NM              --과제명
                       , X.VER_NO                                                      AS VER_NO             --버젼
                       , X.MKER_DIV                                                    AS MKER_DIV           --제작처구분
                       , (SELECT FN_CM05M01_CD_TO_NM(X.MKER_DIV) FROM DUAL)           AS MKER_DIV_NM        --제작처구분명 
                       , X.MKER_CD                                                     AS MKER_CD            --제작처코드
                       , BM.CLNT_NM                                                    AS MKER_NM            --제작처명
                       , X.SMRIZE_ID                                                   AS SMRIZE_ID          --총괄PM ID
                       , (SELECT FN_CM06M01_ID_TO_NM(X.SMRIZE_ID) FROM DUAL)          AS SMRIZE_NM          --총괄PM명
                       , TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD')                             AS BEGIN_DT           --시작일
                       , TO_CHAR(X.DE_DT, 'YYYY-MM-DD')                                AS DE_DT              --출고일
                       , TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD')                            AS ACPTNC_DT          --완료검수일
                       , TO_CHAR(X.REQRE_DAYCNT)                                       AS REQRE_DAYCNT       --소요일수
                       , X.CLOSE_YN                                                    AS CLOSE_YN           --확정유무
                       , X.DSGN_DIF_CODE_ID                                            AS DSGN_DIF_CODE_ID   --설계난이도
                       , (SELECT FN_CM05M01_CD_TO_NM(X.DSGN_DIF_CODE_ID) FROM DUAL)   AS DSGN_DIF_CODE_NM   --설계난이도
                       , X.DSGN_PLAN_HOUR                                              AS DSGN_PLAN_HOUR     --설계계획공수
                       , X.PRDCTN_DIF_CODE_ID                                          AS PRDCTN_DIF_CODE_ID --생산난이도
                       , (SELECT FN_CM05M01_CD_TO_NM(X.PRDCTN_DIF_CODE_ID) FROM DUAL) AS PRDCTN_DIF_CODE_NM --생산난이도
                       , X.PRDCTN_PLAN_HOUR                                            AS PRDCTN_PLAN_HOUR   --생산계획공수
                       , X.SJ_RMK                                                      AS SJ_RMK             --비고
                       , PL.PLAN_CODE_CNT                                              AS PLAN_CODE_CNT      --WBS 계획LVL1 TN
                       , PL.CLOSE_YN                                                   AS PLAN_CLOSE_YN      --WBS 계획 마감여부 
                    FROM TB_WB21M01 X
                         LEFT OUTER JOIN TB_BM02M01 AS BM ON X.MKER_CD = BM.CLNT_CD --거래처정보
                         LEFT OUTER JOIN PLAN       AS PL ON X.CO_CD = PL.CO_CD AND X.SALES_CD = PL.SALES_CD
                    WHERE X.CO_CD = #{coCd}
                       AND X.BEGIN_DT BETWEEN #{beginDt} AND #{deDt}
                       <if test="salesCd != null and !salesCd.equals('')">
                         AND X.SALES_CD LIKE '%${salesCd}%'            
                       </if>
                       <if test="sjNm != null and !sjNm.equals('')">
                         AND X.SJ_NM LIKE '%${sjNm}%' 
                       </if>
                       AND X.CLOSE_YN = 'Y'
                 ) 
               SELECT COUNT(*) FROM (      
                     SELECT ROWNUM AS RN, T.* FROM (  
                            SELECT T.*                        
                              FROM (
                                    SELECT TO_CHAR(CR.CLNT_CD)||CR.ORDRS_NO  AS UPPER_CD     
                                         , X.SJ_NO                            AS LOWER_CD    
                                         , X.CO_CD                            AS CO_CD       
                                         , CR.ORDRS_NO                        AS ORDRS_NO   
                                         , CR.ORDRS_NO||'-'||TRIM(TO_CHAR(ROW_NUMBER() OVER(PARTITION BY CR.ORDRS_NO ORDER BY CR.ORDRS_NO, X.FILE_TRGT_KEY),'0000')) AS TITLE
                                         , CR.CLNT_CD                         AS CLNT_CD     
                                         , CR.CLNT_NM                         AS CLNT_NM     
                                         , CR.CLNT_PJT                        AS CLNT_PJT     
                                         , CR.CLNT_PJT_NM                     AS CLNT_PJT_NM 
                                         , CR.PRDT_CD                         AS PRDT_CD     
                                         , CR.PRDT_NM                         AS PRDT_NM 
                                         , X.SJ_NO                            AS SJ_NO              
                                         , X.SJ_NM                            AS SJ_NM               
                                         , X.VER_NO                           AS VER_NO                
                                         , X.CLOSE_YN                         AS SJ_CLOSE_YN          
                                         , X.SALES_CD                         AS SALES_CD           
                                         , X.PLAN_CODE_CNT                    AS PLAN_CODE_CNT     
                                         , X.PLAN_CLOSE_YN                    AS PLAN_CLOSE_YN      
                                         , X.MKER_DIV                         AS MKER_DIV          
                                         , X.MKER_DIV_NM                      AS MKER_DIV_NM       
                                         , X.MKER_CD                          AS MKER_CD           
                                         , X.MKER_NM                          AS MKER_NM              
                                         , X.SMRIZE_ID                        AS SMRIZE_ID         
                                         , X.SMRIZE_NM                        AS SMRIZE_NM           
                                         , X.BEGIN_DT                         AS BEGIN_DT              
                                         , X.DE_DT                            AS DE_DT                 
                                         , X.ACPTNC_DT                        AS ACPTNC_DT          
                                         , X.REQRE_DAYCNT                     AS REQRE_DAYCNT      
                                         , X.DSGN_DIF_CODE_ID                 AS DSGN_DIF_CODE_ID  
                                         , X.DSGN_DIF_CODE_NM                 AS DSGN_DIF_CODE_NM  
                                         , X.DSGN_PLAN_HOUR                   AS DSGN_PLAN_HOUR    
                                         , X.PRDCTN_DIF_CODE_ID               AS PRDCTN_DIF_CODE_ID
                                         , X.PRDCTN_DIF_CODE_NM               AS PRDCTN_DIF_CODE_NM
                                         , X.PRDCTN_PLAN_HOUR                 AS PRDCTN_PLAN_HOUR 
                                         , X.SJ_RMK                           AS SJ_RMK            
                                         , X.FILE_TRGT_KEY                    AS FILE_TRGT_KEY     
                                      FROM SUBJ X
                                           INNER JOIN SJD AS CR ON X.CO_CD = CR.CO_CD AND X.SALES_CD = CR.SALES_CD 
                                     WHERE 1=1
                                   ) T
                              WHERE 1=1
                              <if test="salesCd != null and !salesCd.equals('')">
                                 AND T.SALES_CD LIKE '%${salesCd}%'            
                                 </if>
                                 <if test="sjNm != null and !sjNm.equals('')">
                                 AND T.SJ_NM LIKE '%${sjNm}%'              
                                 </if>
                                 <if test="closeYn != null and !closeYn.equals('')">
                                 AND NVL(T.PLAN_CLOSE_YN, 'N') = #{closeYn}           
                                 </if>
                              ORDER BY CLNT_NM, ORDRS_NO
                              ) T ) T
          </select>
          
         <select id="selectWbsSjList" parameterType="Map" resultType="camelMap">
			WITH SJD AS --수주상세 
			     ( 
			      SELECT M.CO_CD                                              AS CO_CD        --회사코드
			            , (SELECT FN_CM05M01_CD_TO_NM(M.CO_CD) FROM DUAL)     AS CO_NM        --회사명 
			            , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
			            , X.SALES_CD                                           AS SALES_CD     --SALES Code
			            , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
			            , C.CLNT_NM                                            AS CLNT_NM      --고객명
			            , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
			            , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
			            , X.PRDT_CD
			            , (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = X.PRDT_CD) AS PRDT_NM
			         FROM TB_CR02M01  M --수주마스터
			              INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
			              INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
			        WHERE 1=1
			          AND M.CO_CD = #{coCd}
			     )
			   , PLAN AS --WBS 계획정보 
			     (
			      SELECT CO_CD                   AS CO_CD        --회사코드
			            , SALES_CD                AS SALES_CD     --SALSES_CD
			            , CLOSE_YN                AS CLOSE_YN     --마감여부 
			            , COUNT(WBS_PLAN_CODE_ID) AS PLAN_CODE_CNT--계획LVL1 수
			         FROM TB_WB22M01--WBS계획
			        WHERE CO_CD = #{coCd}
			          AND WBS_PLAN_CODE_KIND = 'WBSCODE'
			        GROUP BY CO_CD 
			                , SALES_CD
			                , CLOSE_YN
			     )
			   , SUBJ AS --과제정보
			     (
			      SELECT X.FILE_TRGT_KEY
			           , X.CO_CD                                                       AS CO_CD              --회사코드
			           , X.SALES_CD                                                    AS SALES_CD           --SALES Code
			           , X.SJ_NO                                                       AS SJ_NO              --과제번호
			           , X.SJ_NM                                                       AS SJ_NM              --과제명
			           , X.VER_NO                                                      AS VER_NO             --버젼
			           , X.MKER_DIV                                                    AS MKER_DIV           --제작처구분
			           , (SELECT FN_CM05M01_CD_TO_NM(X.MKER_DIV) FROM DUAL)           AS MKER_DIV_NM        --제작처구분명 
			           , X.MKER_CD                                                     AS MKER_CD            --제작처코드
			           , BM.CLNT_NM                                                    AS MKER_NM            --제작처명
			           , X.SMRIZE_ID                                                   AS SMRIZE_ID          --총괄PM ID
			           , (SELECT FN_CM06M01_ID_TO_NM(X.SMRIZE_ID) FROM DUAL)          AS SMRIZE_NM          --총괄PM명
			           , TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD')                             AS BEGIN_DT           --시작일
			           , TO_CHAR(X.DE_DT, 'YYYY-MM-DD')                                AS DE_DT              --출고일
			           , TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD')                            AS ACPTNC_DT          --완료검수일
			           , TO_CHAR(X.REQRE_DAYCNT)                                       AS REQRE_DAYCNT       --소요일수
			           , X.CLOSE_YN                                                    AS CLOSE_YN           --확정유무
			           , X.DSGN_DIF_CODE_ID                                            AS DSGN_DIF_CODE_ID   --설계난이도
			           , (SELECT FN_CM05M01_CD_TO_NM(X.DSGN_DIF_CODE_ID) FROM DUAL)   AS DSGN_DIF_CODE_NM   --설계난이도
			           , X.DSGN_PLAN_HOUR                                              AS DSGN_PLAN_HOUR     --설계계획공수
			           , X.PRDCTN_DIF_CODE_ID                                          AS PRDCTN_DIF_CODE_ID --생산난이도
			           , (SELECT FN_CM05M01_CD_TO_NM(X.PRDCTN_DIF_CODE_ID) FROM DUAL) AS PRDCTN_DIF_CODE_NM --생산난이도
			           , X.PRDCTN_PLAN_HOUR                                            AS PRDCTN_PLAN_HOUR   --생산계획공수
			           , X.SJ_RMK                                                      AS SJ_RMK             --비고
			           , PL.PLAN_CODE_CNT                                              AS PLAN_CODE_CNT      --WBS 계획LVL1 TN
			           , PL.CLOSE_YN                                                   AS PLAN_CLOSE_YN      --WBS 계획 마감여부 
			        FROM TB_WB21M01 X
			             LEFT OUTER JOIN TB_BM02M01 AS BM ON X.MKER_CD = BM.CLNT_CD --거래처정보
			             LEFT OUTER JOIN PLAN       AS PL ON X.CO_CD = PL.CO_CD AND X.SALES_CD = PL.SALES_CD
			        WHERE X.CO_CD = #{coCd}
			           AND X.BEGIN_DT BETWEEN #{beginDt} AND #{deDt}
			           <if test="salesCd != null and !salesCd.equals('')">
			             AND X.SALES_CD LIKE '%${salesCd}%'            
			           </if>
			           <if test="sjNm != null and !sjNm.equals('')">
			             AND X.SJ_NM LIKE '%${sjNm}%' 
			           </if>
			           AND X.CLOSE_YN = 'Y'
			     ) 
               SELECT * FROM (      
	                 SELECT ROWNUM AS RN, T.* FROM (  
		                    SELECT T.*                        
		                      FROM (
		                            SELECT TO_CHAR(CR.CLNT_CD)||CR.ORDRS_NO  AS UPPER_CD     
		                                 , X.SJ_NO                            AS LOWER_CD    
		                                 , X.CO_CD                            AS CO_CD       
		                                 , CR.ORDRS_NO                        AS ORDRS_NO   
		                                 , CR.ORDRS_NO||'-'||TRIM(TO_CHAR(ROW_NUMBER() OVER(PARTITION BY CR.ORDRS_NO ORDER BY CR.ORDRS_NO, X.FILE_TRGT_KEY),'0000')) AS TITLE
		                                 , CR.CLNT_CD                         AS CLNT_CD     
		                                 , CR.CLNT_NM                         AS CLNT_NM     
		                                 , CR.CLNT_PJT                        AS CLNT_PJT     
		                                 , CR.CLNT_PJT_NM                     AS CLNT_PJT_NM 
		                                 , CR.PRDT_CD                         AS PRDT_CD     
		                                 , CR.PRDT_NM                         AS PRDT_NM 
		                                 , X.SJ_NO                            AS SJ_NO              
		                                 , X.SJ_NM                            AS SJ_NM               
		                                 , X.VER_NO                           AS VER_NO                
		                                 , X.CLOSE_YN                         AS SJ_CLOSE_YN          
		                                 , X.SALES_CD                         AS SALES_CD           
		                                 , X.PLAN_CODE_CNT                    AS PLAN_CODE_CNT     
		                                 , X.PLAN_CLOSE_YN                    AS PLAN_CLOSE_YN      
		                                 , X.MKER_DIV                         AS MKER_DIV          
		                                 , X.MKER_DIV_NM                      AS MKER_DIV_NM       
		                                 , X.MKER_CD                          AS MKER_CD           
		                                 , X.MKER_NM                          AS MKER_NM              
		                                 , X.SMRIZE_ID                        AS SMRIZE_ID         
		                                 , X.SMRIZE_NM                        AS SMRIZE_NM           
		                                 , X.BEGIN_DT                         AS BEGIN_DT              
		                                 , X.DE_DT                            AS DE_DT                 
		                                 , X.ACPTNC_DT                        AS ACPTNC_DT          
		                                 , X.REQRE_DAYCNT                     AS REQRE_DAYCNT      
		                                 , X.DSGN_DIF_CODE_ID                 AS DSGN_DIF_CODE_ID  
		                                 , X.DSGN_DIF_CODE_NM                 AS DSGN_DIF_CODE_NM  
		                                 , X.DSGN_PLAN_HOUR                   AS DSGN_PLAN_HOUR    
		                                 , X.PRDCTN_DIF_CODE_ID               AS PRDCTN_DIF_CODE_ID
		                                 , X.PRDCTN_DIF_CODE_NM               AS PRDCTN_DIF_CODE_NM
		                                 , X.PRDCTN_PLAN_HOUR                 AS PRDCTN_PLAN_HOUR 
		                                 , X.SJ_RMK                           AS SJ_RMK            
		                                 , X.FILE_TRGT_KEY                    AS FILE_TRGT_KEY     
		                              FROM SUBJ X
		                                   INNER JOIN SJD AS CR ON X.CO_CD = CR.CO_CD AND X.SALES_CD = CR.SALES_CD 
		                             WHERE 1=1
		                           ) T
		                      WHERE 1=1
		                      <if test="salesCd != null and !salesCd.equals('')">
			                     AND T.SALES_CD LIKE '%${salesCd}%'            
			                     </if>
			                     <if test="sjNm != null and !sjNm.equals('')">
			                     AND T.SJ_NM LIKE '%${sjNm}%'              
			                     </if>
			                     <if test="closeYn != null and !closeYn.equals('')">
			                     AND NVL(T.PLAN_CLOSE_YN, 'N') = #{closeYn}           
			                     </if>
		                      ORDER BY CLNT_NM, ORDRS_NO
		                      ) T ) T

                  WHERE RN BETWEEN #{firstIndex} AND #{lastIndex}
          </select>
          
          <select id="selectTodoRsltsView" parameterType="Map" resultType="camelMap">          
				SELECT   X.FILE_TRGT_KEY AS RSLTS_FILE_TRGT_KEY,
				            X.CO_CD,
				            X.WBS_RSLTS_NO,
				            X.WBS_PLAN_CODE_KIND,
				            X.WBS_PLAN_CODE_ID,
				            X.SALES_CD,
				            X.WBS_RSLTS_ID,
				            (SELECT FN_CM06M01_ID_TO_NM(X.WBS_RSLTS_ID) FROM DUAL) AS WBS_RSLTS_NM, 
				            X.WBS_RSLTS_RATE,
				            X.WBS_PLAN_MH,
				            X.WBS_RSLTS_MH ,
				            X.WBS_RSLTS_CNTS,
				            TO_CHAR(X.WBS_RSLTSS_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT,
				            TO_CHAR(X.WBS_RSLTSE_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT,
				            X.DAYCNT AS RSLTS_DAYCNT,
				            
				            Y.FILE_TRGT_KEY AS FILE_TRGT_KEY2,
				            Y.WBS_PLAN_CODE_NM AS WBS_PLAN_CODE_NM2,
				            TO_CHAR(Y.WBS_PLANS_DT,'YYYY-MM-DD') AS WBS_PLANS_DT2,
				            TO_CHAR(Y.WBS_PLANE_DT,'YYYY-MM-DD') AS WBS_PLANE_DT2,
				            Y.WBS_PLAN_MNG_ID AS WBS_PLAN_MNG_ID2,
				            (SELECT FN_CM06M01_ID_TO_NM(Y.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_PLAN_MNG_NM2,  
				            Y.DAYCNT AS DAYCNT2,
				            
				            Z.FILE_TRGT_KEY AS FILE_TRGT_KEY1,
				            (SELECT FN_CM05M01_CD_TO_NM(Z.WBS_PLAN_CODE_ID) FROM DUAL) AS WBS_PLAN_CODE_NM1,
				            TO_CHAR(Z.WBS_PLANS_DT,'YYYY-MM-DD') AS WBS_PLANS_DT1,
                            TO_CHAR(Z.WBS_PLANE_DT,'YYYY-MM-DD') AS WBS_PLANE_DT1,
                            Z.WBS_PLAN_MNG_ID AS WBS_PLAN_MNG_ID1,
                            (SELECT FN_CM06M01_ID_TO_NM(Z.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_PLAN_MNG_NM1,  
                            Z.DAYCNT AS DAYCNT1
				            
				            FROM TB_WB23M01 X
				            INNER JOIN  TB_WB22M01 Y
				            ON X.CO_CD = Y.CO_CD
				            AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND
				            AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
				            AND X.SALES_CD = Y.SALES_CD
				            LEFT OUTER JOIN (
				                SELECT Y.FILE_TRGT_KEY, Y.CO_CD, Y.WBS_PLAN_CODE_KIND, Y.WBS_PLAN_CODE_ID,
				                          Y.WBS_PLAN_CODE_NM, Y.WBS_PLANS_DT, Y.WBS_PLANE_DT,
				                          Y.SALES_CD, Y.VER_NO, Y.WBS_PLAN_MNG_ID, Y.DAYCNT                   
				                          FROM (
				                                SELECT CO_CD, WBS_PLAN_CODE_KIND, WBS_PLAN_CODE_ID, 
				                                          SALES_CD, MAX(VER_NO) AS VER_NO FROM TB_WB22M01
				                                          WHERE WBS_PLAN_CODE_NM IS NULL
				                                          GROUP BY CO_CD, WBS_PLAN_CODE_KIND, WBS_PLAN_CODE_ID, SALES_CD ) X
				                                INNER JOIN  TB_WB22M01 Y    
				                                ON X.CO_CD = Y.CO_CD
				                                AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND
				                                AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
				                                AND X.SALES_CD = Y.SALES_CD
				                                AND X.VER_NO = Y.VER_NO ) Z
				            ON Y.CO_CD = Z.CO_CD
				            AND Y.WBS_PLAN_CODE_KIND = Z.WBS_PLAN_CODE_ID
				            AND Y.SALES_CD = Z.SALES_CD         
				            WHERE X.FILE_TRGT_KEY = #{fileTrgtKey}
          </select>
          
         
</mapper>
