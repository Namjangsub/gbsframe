<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb21.mapper.WB21Mapper">
    <select id="selectMaxSjNo" parameterType="Map"  resultType="camelMap">
        /* selectMaxSjNo */
        SELECT #{year} || trim(to_char(nvl(SUBSTR(MAX(SJ_NO), 6, 4),0) + 1, '0000')) AS SJ_NO
        FROM   TB_WB21M01
        WHERE  CO_CD = #{coCd}
          AND  SJ_NO like #{year} || '%'
    </select>
    
    <select id="selectSalesCodeCheck" parameterType="Map"  resultType="camelMap">
        /* selectSalesCodeCheck */
        SELECT COUNT(*) AS RTN_CNT
        FROM   TB_WB21M01
        WHERE  SALES_CD = #{salesCd}
    </select>
    
    <select id="selectCodeList" parameterType="Map"  resultType="camelMap">
        SELECT CODE_ID AS CD, CODE_NM AS NM
        FROM   TB_CM05M01
        WHERE  CODE_KIND = #{codeKind}
        AND    USE_YN = 'Y'
        ORDER BY SORT_NO ASC
    </select>
    
    <select id="selectSjListCount" parameterType="Map"  resultType="int">
        /* selectSjListCount */
        SELECT COUNT(*)
        FROM   (
                SELECT ROWNUM AS RN
                     , X.*
                FROM   (
                        WITH SJD AS --수주상세 
		                     ( 
		                      SELECT M.CO_CD                                              AS CO_CD        --회사코드
		                            , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
		                            , X.SALES_CD                                           AS SALES_CD     --SALES Code
		                            , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
		                            , C.CLNT_NM                                            AS CLNT_NM      --고객명
		                            , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
		                            , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
		                            , X.PRDT_CD                                            AS PRDT_CD      --제품코드
		                            , (SELECT FN_CM05M01_CD_TO_NM(X.PRDT_CD) FROM DUAL)   AS PRDT_NM      --제품명
		                            , X.ITEM_DIV                                           AS ITEM_DIV     --아이템구분
		                            , (SELECT FN_CM05M01_CD_TO_NM(X.ITEM_DIV) FROM DUAL)  AS ITEM_DIV_NM  --아이템구분명
		                            , X.EQP_NM                                             AS EQP_NM       --설비명
		                            , M.ORDRS_DT
		                         FROM TB_CR02M01  M --수주마스터
		                              INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
		                              INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
		                        WHERE 1=1
		                          AND M.CO_CD = #{coCd}
								 <if test="salesCd == null or salesCd.equals('')">
		                          AND M.ORDRS_DT BETWEEN #{beginDt} AND #{deDt}     
	                             </if>
								 <if test="salesCd != null and !salesCd.equals('')">
	                             AND X.SALES_CD LIKE '%'||#{salesCd}||'%'  --salesCd로 검색시 날자와 상관없이 표시되게
	                             </if>
		                          AND X.SALES_CD IS NOT NULL --비용제외
		                          AND EXISTS (SELECT 'X'    --과제등록된 SALES_CD 만 
		                                        FROM TB_WB21M01 P 
		                                       WHERE P.CO_CD    = #{coCd}
		                                         AND P.CO_CD    = X.CO_CD
		                                         AND P.SALES_CD = X.SALES_CD
		                                     )
			                       <if test="clntPjt != null and !clntPjt.equals('')">
		                           AND M.CLNT_PJT = #{clntPjt}            
		                           </if>
		                           <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
		                           AND C.CLNT_NM LIKE '%' || #{ordrsClntNm} || '%'            
		                           </if>
		                     )
		                   , SUBJ AS --과제정보
		                     (
		                      SELECT X.FILE_TRGT_KEY
		                           , X.CO_CD                                                       AS CO_CD              --회사코드
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.CO_CD) FROM DUAL)              AS CO_NM              --회사명 
		                           , X.SJ_NO                                                       AS SJ_NO              --과제번호
		                           , X.SJ_NM                                                       AS SJ_NM              --과제명
		                           , TO_NUMBER(X.VER_NO)                                           AS VER_NO             --버젼
		                           , MAX(TO_NUMBER(X.VER_NO)) OVER(PARTITION BY X.CO_CD, X.SJ_NO)  AS MAX_VER_NO        --최근버젼
		                           , X.SALES_CD                                                    AS SALES_CD           --SALES Code
		                           , X.MKER_DIV                                                    AS MKER_DIV           --제작처구분
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.MKER_DIV) FROM DUAL)           AS MKER_DIV_NM        --제작처구분명 
		                           , X.MKER_CD                                                     AS MKER_CD            --제작처코드
		                           , BM.CLNT_NM                                                    AS MKER_NM            --고객명
		                           , X.SMRIZE_ID                                                   AS SMRIZE_ID          --총괄PM ID
		                           , (SELECT FN_CM06M01_ID_TO_NM(X.SMRIZE_ID) FROM DUAL)          AS SMRIZE_NM          --총괄PM명
		                           , TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD')                             AS BEGIN_DT           --시작일
		                           , TO_CHAR(X.DE_DT, 'YYYY-MM-DD')                                AS DE_DT              --출고일
		                           , TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD')                            AS ACPTNC_DT          --완료검수일
		                           , X.REQRE_DAYCNT                                                AS REQRE_DAYCNT       --소요일수
		                           , X.DSGN_DIF_CODE_ID                                            AS DSGN_DIF_CODE_ID   --설계난이도
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.DSGN_DIF_CODE_ID) FROM DUAL)   AS DSGN_DIF_CODE_NM   --설계난이도
		                           , X.DSGN_PLAN_HOUR                                              AS DSGN_PLAN_HOUR     --설계계획공수
		                           , X.PRDCTN_DIF_CODE_ID                                          AS PRDCTN_DIF_CODE_ID --생산난이도
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.PRDCTN_DIF_CODE_ID) FROM DUAL) AS PRDCTN_DIF_CODE_NM --생산난이도
		                           , X.PRDCTN_PLAN_HOUR                                            AS PRDCTN_PLAN_HOUR   --생산계획공수
		                           , X.SJ_RMK                                                      AS SJ_RMK             --비고
		                           , X.CLOSE_YN                                                    AS CLOSE_YN           --확정유무
		                           , X.CREAT_ID                                                    AS CREAT_ID           --작성자ID
		                           , X.CREAT_PGM                                                   AS CREAT_PGM          --
		                           , TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS')                AS CREAT_DTTM         --
		                           , X.UDT_ID                                                      AS UDT_ID             --
		                           , X.UDT_PGM                                                     AS UDT_PGM            --
		                           , TO_CHAR(X.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')                  AS UDT_DTT            --
		                        FROM TB_WB21M01 X
		                             LEFT OUTER JOIN TB_BM02M01 AS BM ON X.MKER_CD = BM.CLNT_CD --거래처정보
		                       WHERE X.CO_CD = #{coCd}
                                <if test="sjNm != null and !sjNm.equals('')">
                                 AND X.SJ_NM LIKE '%${sjNm}%'                
                                </if>  
                                <if test="closeYn != null and !closeYn.equals('')">
                                 AND CLOSE_YN LIKE '%${closeYn}%'                
                                </if>
		                          AND EXISTS (SELECT 'X'    --과제등록된 SALES_CD 만 
		                                        FROM SJD P 
		                                       WHERE P.CO_CD    = X.CO_CD
		                                         AND P.SALES_CD = X.SALES_CD
		                                     )
		                     )
		                SELECT X.FILE_TRGT_KEY
		                     , X.CO_CD              --회사코드
		                     , X.CO_NM              --회사명 
		                     , X.SJ_NO              --과제번호     : 1
		                     , X.SJ_NM              --과제명       : 2
		                     , X.VER_NO             --버젼         : 3
		                     , X.MAX_VER_NO         --최근버젼
		                     , X.SALES_CD           --SALES Code   : 5
		                     , X.MKER_DIV           --제작처구분
		                     , X.MKER_DIV_NM        --제작처구분명 : 9
		                     , X.MKER_CD            --제작처코드
		                     , X.MKER_NM            --제작처명     : 10
		                     , X.SMRIZE_ID          --총괄PM ID
		                     , X.SMRIZE_NM          --총괄PM명     : 8
		                     , X.BEGIN_DT           --시작일       : 11
		                     , X.DE_DT              --출고일       : 12
		                     , X.ACPTNC_DT          --완료검수일   : 13
		                     , X.REQRE_DAYCNT       --소요일수     : 14
		                     , X.DSGN_DIF_CODE_ID   --설계난이도
		                     , X.DSGN_DIF_CODE_NM   --설계난이도   : 15
		                     , X.DSGN_PLAN_HOUR     --설계계획공수 : 16
		                     , X.PRDCTN_DIF_CODE_ID --생산난이도  
		                     , X.PRDCTN_DIF_CODE_NM --생산난이도   : 17
		                     , X.PRDCTN_PLAN_HOUR   --생산계획공수 : 18
		                     , X.SJ_RMK             --비고
		                     , X.CLOSE_YN           --확정유무     : 4
		                     , CR.CLNT_CD           --고객코드
		                     , CR.CLNT_NM           --고객명       : 7
		                     , CR.PRDT_CD           --제품코드
		                     , CR.PRDT_NM           --제품명
		                     , CR.CLNT_PJT          --고객사프로젝트 
		                     , CR.CLNT_PJT_NM       --고객사프로젝트명
		                     , CR.ORDRS_NO          --수주번호     : 6
		                     , X.CREAT_ID           --작성자ID
		                     , X.CREAT_PGM          --작성프로그램
		                     , X.CREAT_DTTM         --작성일시
		                     , X.UDT_ID             --수정자 ID
		                     , X.UDT_PGM            --수정 프로그램
		                     , X.UDT_DTT            --수정일시
		                  FROM SUBJ X
		                       LEFT OUTER JOIN SJD AS CR ON X.CO_CD = CR.CO_CD AND X.SALES_CD = CR.SALES_CD 
		                 WHERE 1=1
                           <if test="lastYn != null and !lastYn.equals('')">
		                   AND X.VER_NO = X.MAX_VER_NO       
                           </if>
		                 ORDER BY CR.CLNT_NM, X.SALES_CD, X.VER_NO DESC
                       ) X
                WHERE  1 = 1
               ) X
        WHERE  1 = 1
    </select>
    
    <select id="selectSjList" parameterType="Map"  resultType="camelMap">
       /* selectSjList */
		SELECT * 
		  FROM (
		        SELECT ROWNUM AS RN, X.* 
		          FROM (
		                WITH SJD AS --수주상세 
		                     ( 
		                      SELECT M.CO_CD                                              AS CO_CD        --회사코드
		                            , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
		                            , X.SALES_CD                                           AS SALES_CD     --SALES Code
		                            , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
		                            , C.CLNT_NM                                            AS CLNT_NM      --고객명
		                            , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
		                            , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
		                            , X.PRDT_CD                                            AS PRDT_CD      --제품코드
		                            , (SELECT FN_CM05M01_CD_TO_NM(X.PRDT_CD) FROM DUAL)   AS PRDT_NM      --제품명
		                            , X.ITEM_DIV                                           AS ITEM_DIV     --아이템구분
		                            , (SELECT FN_CM05M01_CD_TO_NM(X.ITEM_DIV) FROM DUAL)  AS ITEM_DIV_NM  --아이템구분명
		                            , X.EQP_NM                                             AS EQP_NM       --설비명
		                            , M.ORDRS_DT
		                         FROM TB_CR02M01  M --수주마스터
		                              INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
		                              INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
		                        WHERE 1=1
		                          AND M.CO_CD = #{coCd}
								 <if test="salesCd == null or salesCd.equals('')">
		                          AND M.ORDRS_DT BETWEEN #{beginDt} AND #{deDt}     
	                             </if>
								 <if test="salesCd != null and !salesCd.equals('')">
	                             AND X.SALES_CD LIKE '%'||#{salesCd}||'%'  --salesCd로 검색시 날자와 상관없이 표시되게
	                             </if>
		                          AND X.SALES_CD IS NOT NULL --비용제외
		                          AND EXISTS (SELECT 'X'    --과제등록된 SALES_CD 만 
		                                        FROM TB_WB21M01 P 
		                                       WHERE P.CO_CD    = #{coCd}
		                                         AND P.CO_CD    = X.CO_CD
		                                         AND P.SALES_CD = X.SALES_CD
		                                     )
			                       <if test="clntPjt != null and !clntPjt.equals('')">
		                           AND M.CLNT_PJT = #{clntPjt}            
		                           </if>
		                           <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
		                           AND C.CLNT_NM LIKE '%' || #{ordrsClntNm} || '%'            
		                           </if>
		                     )
		                   , SUBJ AS --과제정보
		                     (
		                      SELECT X.FILE_TRGT_KEY
		                           , X.CO_CD                                                       AS CO_CD              --회사코드
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.CO_CD) FROM DUAL)              AS CO_NM              --회사명 
		                           , X.SJ_NO                                                       AS SJ_NO              --과제번호
		                           , X.SJ_NM                                                       AS SJ_NM              --과제명
		                           , TO_NUMBER(X.VER_NO)                                           AS VER_NO             --버젼
		                           , MAX(TO_NUMBER(X.VER_NO)) OVER(PARTITION BY X.CO_CD, X.SJ_NO)  AS MAX_VER_NO        --최근버젼
		                           , X.SALES_CD                                                    AS SALES_CD           --SALES Code
		                           , X.MKER_DIV                                                    AS MKER_DIV           --제작처구분
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.MKER_DIV) FROM DUAL)           AS MKER_DIV_NM        --제작처구분명 
		                           , X.MKER_CD                                                     AS MKER_CD            --제작처코드
		                           , BM.CLNT_NM                                                    AS MKER_NM            --고객명
		                           , X.SMRIZE_ID                                                   AS SMRIZE_ID          --총괄PM ID
		                           , (SELECT FN_CM06M01_ID_TO_NM(X.SMRIZE_ID) FROM DUAL)          AS SMRIZE_NM          --총괄PM명
		                           , TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD')                             AS BEGIN_DT           --시작일
		                           , TO_CHAR(X.DE_DT, 'YYYY-MM-DD')                                AS DE_DT              --출고일
		                           , TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD')                            AS ACPTNC_DT          --완료검수일
		                           , X.REQRE_DAYCNT                                                AS REQRE_DAYCNT       --소요일수
		                           , X.DSGN_DIF_CODE_ID                                            AS DSGN_DIF_CODE_ID   --설계난이도
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.DSGN_DIF_CODE_ID) FROM DUAL)   AS DSGN_DIF_CODE_NM   --설계난이도
		                           , X.DSGN_PLAN_HOUR                                              AS DSGN_PLAN_HOUR     --설계계획공수
		                           , X.PRDCTN_DIF_CODE_ID                                          AS PRDCTN_DIF_CODE_ID --생산난이도
		                           , (SELECT FN_CM05M01_CD_TO_NM(X.PRDCTN_DIF_CODE_ID) FROM DUAL) AS PRDCTN_DIF_CODE_NM --생산난이도
		                           , X.PRDCTN_PLAN_HOUR                                            AS PRDCTN_PLAN_HOUR   --생산계획공수
		                           , X.SJ_RMK                                                      AS SJ_RMK             --비고
		                           , X.CLOSE_YN                                                    AS CLOSE_YN           --확정유무
		                           , X.CREAT_ID                                                    AS CREAT_ID           --작성자ID
		                           , X.CREAT_PGM                                                   AS CREAT_PGM          --
		                           , TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS')                AS CREAT_DTTM         --
		                           , X.UDT_ID                                                      AS UDT_ID             --
		                           , X.UDT_PGM                                                     AS UDT_PGM            --
		                           , TO_CHAR(X.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')                  AS UDT_DTT            --
		                        FROM TB_WB21M01 X
		                             LEFT OUTER JOIN TB_BM02M01 AS BM ON X.MKER_CD = BM.CLNT_CD --거래처정보
		                       WHERE X.CO_CD = #{coCd}
                                <if test="sjNm != null and !sjNm.equals('')">
                                 AND X.SJ_NM LIKE '%${sjNm}%'                
                                </if>  
                                <if test="closeYn != null and !closeYn.equals('')">
                                 AND CLOSE_YN LIKE '%${closeYn}%'                
                                </if>
		                          AND EXISTS (SELECT 'X'    --과제등록된 SALES_CD 만 
		                                        FROM SJD P 
		                                       WHERE P.CO_CD    = X.CO_CD
		                                         AND P.SALES_CD = X.SALES_CD
		                                     )
		                     )
		                SELECT X.FILE_TRGT_KEY
		                     , X.CO_CD              --회사코드
		                     , X.CO_NM              --회사명 
		                     , X.SJ_NO              --과제번호     : 1
		                     , X.SJ_NM              --과제명       : 2
		                     , X.VER_NO             --버젼         : 3
		                     , X.MAX_VER_NO         --최근버젼
		                     , X.SALES_CD           --SALES Code   : 5
		                     , X.MKER_DIV           --제작처구분
		                     , X.MKER_DIV_NM        --제작처구분명 : 9
		                     , X.MKER_CD            --제작처코드
		                     , X.MKER_NM            --제작처명     : 10
		                     , X.SMRIZE_ID          --총괄PM ID
		                     , X.SMRIZE_NM          --총괄PM명     : 8
		                     , X.BEGIN_DT           --시작일       : 11
		                     , X.DE_DT              --출고일       : 12
		                     , X.ACPTNC_DT          --완료검수일   : 13
		                     , X.REQRE_DAYCNT       --소요일수     : 14
		                     , X.DSGN_DIF_CODE_ID   --설계난이도
		                     , X.DSGN_DIF_CODE_NM   --설계난이도   : 15
		                     , X.DSGN_PLAN_HOUR     --설계계획공수 : 16
		                     , X.PRDCTN_DIF_CODE_ID --생산난이도  
		                     , X.PRDCTN_DIF_CODE_NM --생산난이도   : 17
		                     , X.PRDCTN_PLAN_HOUR   --생산계획공수 : 18
		                     , X.SJ_RMK             --비고
		                     , X.CLOSE_YN           --확정유무     : 4
		                     , CR.CLNT_CD           --고객코드
		                     , CR.CLNT_NM           --고객명       : 7
		                     , CR.PRDT_CD           --제품코드
		                     , CR.PRDT_NM           --제품명
		                     , CR.CLNT_PJT          --고객사프로젝트 
		                     , CR.CLNT_PJT_NM       --고객사프로젝트명
		                     , CR.ORDRS_NO          --수주번호     : 6
		                     , X.CREAT_ID           --작성자ID
		                     , X.CREAT_PGM          --작성프로그램
		                     , X.CREAT_DTTM         --작성일시
		                     , X.UDT_ID             --수정자 ID
		                     , X.UDT_PGM            --수정 프로그램
		                     , X.UDT_DTT            --수정일시
		                  FROM SUBJ X
		                       LEFT OUTER JOIN SJD AS CR ON X.CO_CD = CR.CO_CD AND X.SALES_CD = CR.SALES_CD 
		                 WHERE 1=1
                           <if test="lastYn != null and !lastYn.equals('')">
		                   AND X.VER_NO = X.MAX_VER_NO       
                           </if>
		                 ORDER BY CR.CLNT_NM, X.SALES_CD, X.VER_NO DESC
		               ) X 
		       ) X      
		 WHERE RN BETWEEN ${firstIndex} AND ${lastIndex}
      </select>
    
    <select id="ModalsjnoconfirmListCount" parameterType="Map"  resultType="int">
        WITH MST AS --미확정 과제정보
		(
		 SELECT M.*
                  , ROWNUM AS RN
		 FROM   (
		         SELECT CO_CD       AS CO_CD
		              , SJ_NO       AS SJ_NO
		              , MAX(VER_NO) AS VER_NO
		         FROM   (
		                 SELECT U.NAME AS SMRIZE_NM
		                      , A.*
		                 FROM   TB_WB21M01 AS A
		                        LEFT OUTER JOIN TB_CM06M01 AS U ON U.ID = A.SMRIZE_ID
		                 WHERE  1 = 1
		                 AND    A.CO_CD = #{coCd}
		                )
		         WHERE  1 = 1
                     <if test="searchValue != null and !searchValue.equals('') and searchType.equals('SMRIZE_NM')">
                     AND    ${searchType} LIKE '%'||#{searchValue}||'%'
                     </if>
		         GROUP BY CO_CD, SJ_NO
		        ) AS A
		        INNER JOIN TB_WB21M01 AS M  ON M.CO_CD  = A.CO_CD
		                                   AND M.SJ_NO  = A.SJ_NO
		                                   AND M.VER_NO = A.VER_NO
		 WHERE  1 = 1
		 AND    M.CLOSE_YN = 'N'
		)
		, SUJU AS --수주 및 SALESCD정보
		(
		 SELECT DISTINCT SM.FILE_TRGT_KEY
		      , SM.CO_CD
		      , SM.ORDRS_NO
		      , SM.ORDRS_CLNT_CD AS CLNT_CD
		      , C.CLNT_NM
		      , SM.CLNT_PJT
		      , R1.CODE_NM AS CLNT_PJT_NM
		      , SD.ORDRS_DTL_DIV10 AS INPUT_GBN
		      , R2.CODE_NM         AS INPUT_GBN_NM
		      , SD.PRDT_CD
		      , P.PRDT_NM
		      , SD.ITEM_DIV
		      , R3.CODE_NM AS ITEM_DIV_NM
		      , SD.ORDRS_DTL_DIV20 AS NEW_GBN
		      , R4.CODE_NM         AS NEW_GBN_NM
		      , SD.ORDRS_DTL_DIV30 AS IN_PROD_GBN
		      , R5.CODE_NM         AS IN_PROD_GBN_NM
		      , SD.MCTYPE
		      , R6.CODE_NM AS MCTYPE_NM
		      , SD.SALES_CD
		      , SD.EQP_NM
		      , TO_CHAR(SD.DUDT_INTEND_DT, 'YYYY-MM-DD') AS DUDT_INTEND_DT
		 FROM   TB_CR02M01 AS SM
		        LEFT OUTER JOIN TB_CR02D02 AS SD  ON SD.CO_CD    = SM.CO_CD
		                                         AND SD.ORDRS_NO = SM.ORDRS_NO
		        LEFT OUTER JOIN TB_BM02M01 AS C   ON C.CLNT_CD = SM.ORDRS_CLNT_CD
		        LEFT OUTER JOIN TB_BM01M01 AS P   ON SD.PRDT_CD = P.PRDT_CD
		        LEFT OUTER JOIN TB_CM05M01 AS R1  ON R1.CODE_ID = SM.CLNT_PJT
		        LEFT OUTER JOIN TB_CM05M01 AS R2  ON R2.CODE_ID = SD.ORDRS_DTL_DIV10
		        LEFT OUTER JOIN TB_CM05M01 AS R3  ON R3.CODE_ID = SD.ITEM_DIV
		        LEFT OUTER JOIN TB_CM05M01 AS R4  ON R4.CODE_ID = SD.ORDRS_DTL_DIV20
		        LEFT OUTER JOIN TB_CM05M01 AS R5  ON R5.CODE_ID = SD.ORDRS_DTL_DIV30
		        LEFT OUTER JOIN TB_CM05M01 AS R6  ON R6.CODE_ID = SD.MCTYPE
		 WHERE  1 = 1
		)
		SELECT COUNT(*)
		FROM   MST
		WHERE  1 = 1
    </select>
    
    <select id="ModalsjnoconfirmList" parameterType="Map"  resultType="camelMap">
        WITH MST AS --미확정 과제정보
		(
		 SELECT M.*
                  , ROWNUM AS RN
		 FROM   (
		         SELECT CO_CD       AS CO_CD
		              , SJ_NO       AS SJ_NO
		              , MAX(VER_NO) AS VER_NO
		         FROM   (
		                 SELECT U.NAME AS SMRIZE_NM
		                      , A.*
		                 FROM   TB_WB21M01 AS A
		                        LEFT OUTER JOIN TB_CM06M01 AS U ON U.ID = A.SMRIZE_ID
		                 WHERE  1 = 1
		                 AND    A.CO_CD = #{coCd}
		                )
		         WHERE  1 = 1
                     <if test="searchValue != null and !searchValue.equals('') and !searchType.equals('')">
                     AND    ${searchType} LIKE '%'||#{searchValue}||'%'
                     </if>
		         GROUP BY CO_CD, SJ_NO
		        ) AS A
		        INNER JOIN TB_WB21M01 AS M  ON M.CO_CD  = A.CO_CD
		                                   AND M.SJ_NO  = A.SJ_NO
		                                   AND M.VER_NO = A.VER_NO
		 WHERE  1 = 1
		 AND    M.CLOSE_YN = 'N'
		)
		, SUJU AS --수주 및 SALESCD정보
		(
		 SELECT DISTINCT SM.FILE_TRGT_KEY
		      , SM.CO_CD
		      , SM.ORDRS_NO
		      , SM.ORDRS_CLNT_CD AS CLNT_CD
		      , C.CLNT_NM
		      , SM.CLNT_PJT
		      , R1.CODE_NM AS CLNT_PJT_NM
		      , SD.ORDRS_DTL_DIV10 AS INPUT_GBN
		      , R2.CODE_NM         AS INPUT_GBN_NM
		      , SD.PRDT_CD
		      , P.PRDT_NM
		      , SD.ITEM_DIV
		      , R3.CODE_NM AS ITEM_DIV_NM
		      , SD.ORDRS_DTL_DIV20 AS NEW_GBN
		      , R4.CODE_NM         AS NEW_GBN_NM
		      , SD.ORDRS_DTL_DIV30 AS IN_PROD_GBN
		      , R5.CODE_NM         AS IN_PROD_GBN_NM
		      , SD.MCTYPE
		      , R6.CODE_NM AS MCTYPE_NM
		      , SD.SALES_CD
		      , SD.EQP_NM
		      , TO_CHAR(SD.DUDT_INTEND_DT, 'YYYY-MM-DD') AS DUDT_INTEND_DT
              , SM.ORDRS_DIV
		 FROM   TB_CR02M01 AS SM
		        LEFT OUTER JOIN TB_CR02D02 AS SD  ON SD.CO_CD    = SM.CO_CD
		                                         AND SD.ORDRS_NO = SM.ORDRS_NO
		        LEFT OUTER JOIN TB_BM02M01 AS C   ON C.CLNT_CD = SM.ORDRS_CLNT_CD
		        LEFT OUTER JOIN TB_BM01M01 AS P   ON SD.PRDT_CD = P.PRDT_CD
		        LEFT OUTER JOIN TB_CM05M01 AS R1  ON R1.CODE_ID = SM.CLNT_PJT
		        LEFT OUTER JOIN TB_CM05M01 AS R2  ON R2.CODE_ID = SD.ORDRS_DTL_DIV10
		        LEFT OUTER JOIN TB_CM05M01 AS R3  ON R3.CODE_ID = SD.ITEM_DIV
		        LEFT OUTER JOIN TB_CM05M01 AS R4  ON R4.CODE_ID = SD.ORDRS_DTL_DIV20
		        LEFT OUTER JOIN TB_CM05M01 AS R5  ON R5.CODE_ID = SD.ORDRS_DTL_DIV30
		        LEFT OUTER JOIN TB_CM05M01 AS R6  ON R6.CODE_ID = SD.MCTYPE
		 WHERE  1 = 1
		)
		SELECT A.FILE_TRGT_KEY
		     , A.CO_CD
		     , A.SJ_NO
		     , S.CLNT_CD
		     , S.CLNT_NM
		     , S.CLNT_PJT
		     , S.CLNT_PJT_NM
		     , S.NEW_GBN_NM
		     , S.IN_PROD_GBN_NM
		     , S.MCTYPE_NM
		     , S.SALES_CD
		     , A.SJ_NM
		     , S.DUDT_INTEND_DT
		     , A.VER_NO
		     , A.CLOSE_YN
		     , A.MKER_DIV
		     , R1.CODE_NM AS MKER_DIV_NM
		     , A.MKER_CD
		     , C.CLNT_NM AS MKER_CD_NM
		     , A.SMRIZE_ID
		     , U.NAME AS SMRIZE_NM
		     , TO_CHAR(A.BEGIN_DT , 'YYYY-MM-DD') AS BEGIN_DT
		     , TO_CHAR(A.DE_DT    , 'YYYY-MM-DD') AS DE_DT
		     , TO_CHAR(A.ACPTNC_DT, 'YYYY-MM-DD') AS ACPTNC_DT
		     , A.REQRE_DAYCNT
		     , A.DSGN_DIF_CODE_ID
		     , R2.CODE_NM AS DSGN_DIF_NM
		     , A.DSGN_PLAN_HOUR
		     , A.PRDCTN_DIF_CODE_ID
		     , R3.CODE_NM AS PRDCTN_DIF_NM
		     , A.PRDCTN_PLAN_HOUR
		     , A.SJ_RMK
		FROM   MST AS A
		       LEFT OUTER JOIN SUJU AS S  ON S.SALES_CD = A.SALES_CD
		       LEFT OUTER JOIN TB_CM06M01 AS U  ON U.ID = A.SMRIZE_ID
		       LEFT OUTER JOIN TB_BM02M01 AS C  ON C.CLNT_CD = A.MKER_CD
		       LEFT OUTER JOIN TB_CM05M01 AS R1  ON R1.CODE_ID = A.MKER_DIV
		       LEFT OUTER JOIN TB_CM05M01 AS R2  ON R2.CODE_ID = A.DSGN_DIF_CODE_ID
		       LEFT OUTER JOIN TB_CM05M01 AS R3  ON R3.CODE_ID = A.PRDCTN_DIF_CODE_ID
		WHERE  1 = 1
            AND    A.RN BETWEEN ${firstIndex} AND ${lastIndex}
    </select>

    <!-- 과제일괄확정 -->
    <update id="confirm_wb21" parameterType="map">
		UPDATE TB_WB21M01
		SET    CLOSE_YN = 'Y'
               , UDT_ID   = #{userId}
               , UDT_PGM  = #{pgmId,  jdbcType=VARCHAR}
               , UDT_DTTM = SYSDATE
		WHERE  FILE_TRGT_KEY = #{fileTrgtKey}
    </update>

    <select id="ModalsjnocopyListCount" parameterType="Map"  resultType="int">
        SELECT COUNT(*)
        FROM   (
                SELECT A.*
                     , ROWNUM AS RN
                FROM   (
                        SELECT DISTINCT X.CO_CD
                             , R1.CODE_NM AS CO_CD_NM
                             , X.ORDRS_NO
                             , X.SALES_CD
                             , Y.ORGN_SALES_CD
                             , Y.ORDRS_CLNT_CD
                             , A.CLNT_NM AS ORDRS_CLNT_NM
                             , Y.CLNT_PJT
                             , R2.CODE_NM AS CLNT_PJT_NM
                             , UPPER(R2.CODE_NM) AS CLNT_PJT_NM_UPPER
                             , X.ORDRS_DTL_DIV20
                             , R3.CODE_NM AS ORDRS_DTL_DIV20_NM
                             , X.PRDT_CD
                             , P.PRDT_NM AS PRDT_CD_NM
                             , X.ITEM_DIV
                             , R4.CODE_NM AS ITEM_DIV_NM
                             , X.EQP_NM
                             , Y.CTRT_NM
                        FROM   TB_CR02D02 AS X
                               INNER JOIN TB_CR02M01 AS Y  ON X.CO_CD    = Y.CO_CD
                                                          AND X.ORDRS_NO = Y.ORDRS_NO
                               LEFT OUTER JOIN TB_BM01M01 AS P ON X.PRDT_CD = P.PRDT_CD  --제품마스터
                               LEFT OUTER JOIN TB_BM02M01 AS A ON Y.ORDRS_CLNT_CD = A.CLNT_CD  --거래처마스터
                               LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = X.CO_CD  --회사
                               LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = Y.CLNT_PJT  --고객사PJT
                               LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = X.ORDRS_DTL_DIV20  --신작구분
                               LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = X.ITEM_DIV  --아이템구분
                        WHERE  1 = 1
                        AND    X.CO_CD = #{coCd}
                        AND    X.SALES_CD IS NOT NULL
                        <if test="searchValue != null and !searchValue.equals('') and !searchType.equals('CLNT_PJT_NM')">
                        AND    UPPER(${searchType}) LIKE '%'||UPPER(#{searchValue})||'%'
                        </if>
                       ) AS A
                WHERE  1 = 1
                AND    A.SALES_CD NOT IN ( SELECT DISTINCT SALES_CD FROM TB_WB21M01 )
                <if test="searchType != null and searchType.equals('CLNT_PJT_NM')">
                AND    A.CLNT_PJT_NM_UPPER LIKE '%' || UPPER(#{searchValue}) || '%'
                </if>
               )
        WHERE  1 = 1
    </select>
    
    <select id="ModalsjnocopyList" parameterType="Map"  resultType="camelMap">
        SELECT B.*
        FROM   (
                SELECT A.*
                     , ROWNUM AS RN
                FROM   (
                        SELECT DISTINCT X.CO_CD
                             , R1.CODE_NM AS CO_CD_NM
                             , X.ORDRS_NO
                             , X.SALES_CD
                             , Y.ORGN_SALES_CD
                             , Y.ORDRS_CLNT_CD
                             , A.CLNT_NM AS ORDRS_CLNT_NM
                             , Y.CLNT_PJT
                             , R2.CODE_NM AS CLNT_PJT_NM
                             , UPPER(R2.CODE_NM) AS CLNT_PJT_NM_UPPER
                             , X.ORDRS_DTL_DIV20
                             , R3.CODE_NM AS ORDRS_DTL_DIV20_NM
                             , X.PRDT_CD
                             , P.PRDT_NM AS PRDT_CD_NM
                             , X.ITEM_DIV
                             , R4.CODE_NM AS ITEM_DIV_NM
                             , X.EQP_NM
                             , Y.CTRT_NM
                             , Y.ORDRS_DIV
                        FROM   TB_CR02D02 AS X
                               INNER JOIN TB_CR02M01 AS Y  ON X.CO_CD    = Y.CO_CD
                                                          AND X.ORDRS_NO = Y.ORDRS_NO
                               LEFT OUTER JOIN TB_BM01M01 AS P ON X.PRDT_CD = P.PRDT_CD  --제품마스터
                               LEFT OUTER JOIN TB_BM02M01 AS A ON Y.ORDRS_CLNT_CD = A.CLNT_CD  --거래처마스터
                               LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = X.CO_CD  --회사
                               LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = Y.CLNT_PJT  --고객사PJT
                               LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = X.ORDRS_DTL_DIV20  --신작구분
                               LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = X.ITEM_DIV  --아이템구분
                        WHERE  1 = 1
                        AND    X.CO_CD = #{coCd}
                        AND    X.SALES_CD IS NOT NULL
                        <if test="searchValue != null and !searchValue.equals('') and !searchType.equals('CLNT_PJT_NM')">
                        AND    UPPER(${searchType}) LIKE '%'||UPPER(#{searchValue})||'%'
                        </if>
                        ORDER BY Y.ORDRS_DIV, X.ORDRS_NO DESC
                       ) AS A
                WHERE  1 = 1
                AND    A.SALES_CD NOT IN ( SELECT DISTINCT SALES_CD FROM TB_WB21M01 )
                <if test="searchType != null and searchType.equals('CLNT_PJT_NM')">
                AND    A.CLNT_PJT_NM_UPPER LIKE '%' || UPPER(#{searchValue}) || '%'
                </if>
               ) AS B
        WHERE  1 = 1
        AND    B.RN BETWEEN ${firstIndex} AND ${lastIndex}
    </select>

    <!-- 과제복사 -->
    <update id="copy_wb21" parameterType="map">
        INSERT INTO TB_WB21M01
             ( FILE_TRGT_KEY     , CO_CD           , SJ_NO       , SJ_NM           , VER_NO
             , SALES_CD          , MKER_DIV        , MKER_CD     , SMRIZE_ID       , BEGIN_DT
             , DE_DT             , ACPTNC_DT       , REQRE_DAYCNT, DSGN_DIF_CODE_ID, DSGN_PLAN_HOUR
             , PRDCTN_DIF_CODE_ID, PRDCTN_PLAN_HOUR, SJ_RMK      , CLOSE_YN        , CREAT_ID
             , CREAT_PGM         , CREAT_DTTM      , EXPECT_MH 	 , PLAN_EXCEPT)
        SELECT TB_WB21M01_SQ01.NEXTVAL AS FILE_TRGT_KEY
             , CO_CD
             , FN_WB21M01_NEW_SJ_NO(CO_CD, BEGIN_DT, #{seq})
             , FN_CR02D02_EQP_NM(#{salesCd})
             , '1'
             , #{salesCd}
             , MKER_DIV
             , MKER_CD
             , SMRIZE_ID
             , BEGIN_DT
             , DE_DT
             , ACPTNC_DT
             , REQRE_DAYCNT
             , DSGN_DIF_CODE_ID
             , DSGN_PLAN_HOUR
             , PRDCTN_DIF_CODE_ID
             , PRDCTN_PLAN_HOUR
             , SJ_RMK
             , 'N'
             , #{userId}
             , #{pgmId,  jdbcType=VARCHAR}
             , SYSDATE
             , EXPECT_MH
             , PLAN_EXCEPT
        FROM   TB_WB21M01 AS A
        WHERE  1 = 1
        AND    FILE_TRGT_KEY = #{fileTrgtKey}
    </update>

       <select id="selectSjSeqNext" parameterType="Map" resultType="int">
             SELECT TB_WB21M01_SQ01.NEXTVAL FROM DUAL
       </select>
               
       <insert id="insertSjDtlList" parameterType="Map">
                <selectKey keyProperty="fileTrgtKey" resultType="Int" order="BEFORE">
                    SELECT NVL(MAX(TO_NUMBER(FILE_TRGT_KEY)), 0) + 1 FROM TB_WB21D01
                </selectKey>
                INSERT INTO TB_WB21D01
                (
                    FILE_TRGT_KEY,
                    CO_CD,
                    SJ_NO,
                    VER_NO,
                    DUTY_SE,
                    CHRG_SE,
                    CHARGER_ID,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{coCd},
                    #{sjNo},
                    #{verNo},
                    #{dutySe},
                    #{chrgSe},
                    #{chargerId},                    
                    #{creatId},
                    #{creatPgmId},
                    SYSDATE
                )
         </insert>
         
         
         <insert id="sjInsert" parameterType="Map">
                INSERT INTO TB_WB21M01
                (
                    FILE_TRGT_KEY,
                    CO_CD,
                    SJ_NO,
                    SJ_NM,
                    VER_NO,
                    SALES_CD,
                    MKER_DIV,
                    MKER_CD,
                    SMRIZE_ID,
                    BEGIN_DT,
                    DE_DT,
                    ACPTNC_DT,
                    REQRE_DAYCNT,
                    DSGN_DIF_CODE_ID,
                    DSGN_PLAN_HOUR,
                    PRDCTN_DIF_CODE_ID,
                    PRDCTN_PLAN_HOUR,
                    SJ_RMK,
                    CLOSE_YN,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM,
                    EXPECT_MH, 
                    PLAN_EXCEPT
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{coCd},
                    #{sjNo},
                    #{sjNm},
                    #{verNo},
                    #{salesCd},
                    #{mkerDiv},
                    #{mkerCd},
                    #{smrizeId},
                    #{beginDt},
                    #{deDt},
                    #{acptncDt},
                    #{reqreDaycnt},
                    #{dsgnDifCodeId},
                    #{dsgnPlanHour},
                    #{prdctnDifCodeId},
                    #{prdctnPlanHour},
                    #{sjRmk},
                    'N',
                    #{userId},
                    #{pgmId},
                    SYSDATE,
                    #{expectMh, jdbcType=VARCHAR},
                    #{planExcept}
                )
         </insert>
         
         <update id="sjUpdate" parameterType="Map">
                UPDATE TB_WB21M01
                 SET    
                        SJ_NM = #{sjNm},
                        MKER_DIV = #{mkerDiv},
                        MKER_CD = #{mkerCd},
                        SMRIZE_ID = #{smrizeId},
                        BEGIN_DT = #{beginDt},
                        DE_DT = #{deDt},
                        ACPTNC_DT = #{acptncDt},
                        REQRE_DAYCNT = #{reqreDaycnt},
                        DSGN_DIF_CODE_ID = #{dsgnDifCodeId},
                        DSGN_PLAN_HOUR = #{dsgnPlanHour},
                        PRDCTN_DIF_CODE_ID = #{prdctnDifCodeId},
                        PRDCTN_PLAN_HOUR = #{prdctnPlanHour},
                        SJ_RMK =#{sjRmk}, 
                        UDT_ID = #{userId},
                        UDT_PGM = #{pgmId},
                        UDT_DTTM = SYSDATE,
	                    EXPECT_MH = #{expectMh, jdbcType=VARCHAR},
	                    PLAN_EXCEPT = #{planExcept}
                 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
         </update>
         
         <select id="deleteSjListChk" parameterType="Map" resultType="camelMap">
               SELECT *  FROM TB_WB21D01
                   WHERE CO_CD  = #{coCd}
                         AND SJ_NO  = #{sjNo}
                         AND VER_NO  = #{verNo}                         
        </select>   
        
        <delete id="deleteSjList" parameterType="Map">
               DELETE  FROM TB_WB21D01
                   WHERE CO_CD  = #{coCd}
                         AND SJ_NO  = #{sjNo}
                         AND VER_NO  = #{verNo}       
        </delete> 


        <select id="selectSjDtlList" parameterType="Map" resultType="camelMap">
               SELECT X.DUTY_SE,
                      X.CHRG_SE,
                      X.CHARGER_ID, 
                      (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CHARGER_ID)  AS CHARGER_NM  
                   FROM TB_WB21D01 X
                   WHERE X.CO_CD  = #{coCd}
                   AND X.SJ_NO = #{sjNo}
                   AND X.VER_NO = #{verNo}                      
        </select>   
        
        <select id="selectSjInfo" parameterType="Map"  resultType="camelMap">
        /* selectSjInfo */
            SELECT  X.FILE_TRGT_KEY,
                    X.CO_CD,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS CO_CD_NM,
                    X.SJ_NO,
                    X.SJ_NM,
                    X.VER_NO,
                    (SELECT MAX(TO_NUMBER(SW21.VER_NO)) FROM TB_WB21M01 SW21 WHERE SW21.SALES_CD = X.SALES_CD) AS MAX_VER_NO,
                    X.SALES_CD,
                    X.MKER_DIV,
                    X.MKER_CD,
                    (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD = X.MKER_CD) AS MKER_NM,
                    X.SMRIZE_ID,
                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.SMRIZE_ID) AS SMRIZE_NM,
                    TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD') AS BEGIN_DT,
                    TO_CHAR(X.DE_DT, 'YYYY-MM-DD') AS DE_DT,
                    TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD') AS ACPTNC_DT,
                    X.REQRE_DAYCNT,
                    X.DSGN_DIF_CODE_ID,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.DSGN_DIF_CODE_ID) AS DSGN_DIF_CODE_NM,
                    X.DSGN_PLAN_HOUR,
                    X.PRDCTN_DIF_CODE_ID,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.PRDCTN_DIF_CODE_ID) AS PRDCTN_DIF_CODE_NM,
                    X.PRDCTN_PLAN_HOUR,
                    X.SJ_RMK,
                    X.CLOSE_YN,
                    X.CREAT_ID,
                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CREAT_ID) AS CREAT_NM,
                    X.CREAT_PGM,
                    TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM,
                    X.UDT_ID,
                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.UDT_ID) AS UDT_NM,
                    X.UDT_PGM,
                    TO_CHAR(UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM,
                    CR.CLNT_CD,
                    CR.CLNT_NM,
                    CR.PRDT_CD,
                    CR.PRDT_NM,
                    CR.CLNT_PJT,
                    EXPECT_MH,
                    PLAN_EXCEPT,
                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.CLNT_PJT) AS CLNT_PJT_NM
                    FROM TB_WB21M01 X
                    LEFT OUTER JOIN (
                        SELECT  
                           CR.CO_CD, 
                           CR.ORDRS_NO,
                           CR.SALES_CD, 
                           Y.ORDRS_CLNT_CD AS CLNT_CD, 
                           (SELECT P.CLNT_NM FROM TB_BM02M01 P WHERE P.CLNT_CD = Y.ORDRS_CLNT_CD) AS CLNT_NM,
                           Y.CLNT_PJT, 
                           CR.ORDRS_DTL_DIV20, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                           CR.PRDT_CD, 
                           (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = CR.PRDT_CD) AS PRDT_NM,
                           CR.ITEM_DIV, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ITEM_DIV) AS ITEM_DIV_NM,
                           CR.EQP_NM
                        FROM TB_CR02D02 CR INNER JOIN TB_CR02M01 Y  ON CR.CO_CD = Y.CO_CD
                                                                 AND CR.ORDRS_NO = Y.ORDRS_NO) CR
                ON CR.CO_CD = X.CO_CD
                AND CR.SALES_CD = X.SALES_CD          
                WHERE FILE_TRGT_KEY = #{fileTrgtKey} 
       </select>
       
      <insert id="sjConfirmY" parameterType="Map">
               INSERT INTO TB_WB21M01_HIST
                (
                    FILE_TRGT_KEY,
                    CO_CD,
                    SJ_NO,
                    SJ_NM,
                    VER_NO,
                    SALES_CD,
                    MKER_DIV,
                    MKER_CD,
                    SMRIZE_ID,
                    BEGIN_DT,
                    DE_DT,
                    ACPTNC_DT,
                    REQRE_DAYCNT,
                    DSGN_DIF_CODE_ID,
                    DSGN_PLAN_HOUR,
                    PRDCTN_DIF_CODE_ID,
                    PRDCTN_PLAN_HOUR,
                    SJ_RMK,
                    CLOSE_YN,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM,
                    EXPECT_MH,
                    PLAN_EXCEPT
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{coCd},
                    #{sjNo},
                    #{sjNm},
                    #{verNo},
                    #{salesCd},
                    #{mkerDiv},
                    #{mkerCd},
                    #{smrizeId},
                    #{beginDt},
                    #{deDt},
                    #{acptncDt},
                    #{reqreDaycnt},
                    #{dsgnDifCodeId},
                    #{dsgnPlanHour},
                    #{prdctnDifCodeId},
                    #{prdctnPlanHour},
                    #{sjRmk},
                    'Y',
                    #{userId},
                    #{pgmId},
                    SYSDATE,
                    #{expectMh},
                    #{planExcept}
                )

         </insert>
      <update id="sjCloseY" parameterType="Map">
                UPDATE TB_WB21M01
                 SET  CLOSE_YN = 'Y',
                      UDT_ID = #{userId},
                      UDT_PGM = #{pgmId},
                      UDT_DTTM = SYSDATE
                 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
         </update>   
         
         <delete id="sjConfirmN" parameterType="Map">
                DELETE FROM TB_WB21M01_HIST                
                  WHERE FILE_TRGT_KEY = #{fileTrgtKey} 
         </delete>
         
         <update id="sjCloseN" parameterType="Map">
                UPDATE TB_WB21M01
                 SET  CLOSE_YN = 'N',
                      UDT_ID = #{userId},
                      UDT_PGM = #{pgmId},
                      UDT_DTTM = SYSDATE
                 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
         </update>
         
         <select id="selectSjVerNoNext" parameterType="Map" resultType="camelMap">
             SELECT NVL(MAX(TO_NUMBER(VER_NO)), 0) + 1 AS VER_NO
                  , (SELECT COUNT(*) FROM TB_WB22M01 WHERE SALES_CD = #{salesCd}) AS AFT_CNT
               FROM TB_WB21M01
               WHERE CO_CD = #{coCd}
               AND SJ_NO = #{sjNo}
         </select>
       
       <select id="selectWbChk" parameterType="Map" resultType="camelMap">
               SELECT MAX(TO_NUMBER(VER_NO)) AS VER_NO
                    , MAX(CLOSE_YN) AS CLOSE_YN
                 FROM (
		               SELECT SJ_NO
		                    , VER_NO
		                    , CLOSE_YN 
		                 FROM TB_WB21M01 
		                WHERE CO_CD  = #{coCd}
		                  AND SJ_NO  = #{sjNo}
                	) B                        
        </select>   
        
        <delete id="deleteSjNo" parameterType="Map">
               DELETE FROM TB_WB21M01
                WHERE CO_CD  = #{coCd}
                  AND SJ_NO  = #{sjNo}
                         
        </delete> 
                    
</mapper>
