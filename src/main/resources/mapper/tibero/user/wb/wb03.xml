<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb03.mapper.WB03Mapper">

	<select id="selectWbsPlanTreeIssueList" parameterType="Map" resultType="CamelMap">
            SELECT  
                    T.*,
                    FN_CM05M01_CD_TO_NM(T.CO_CD) AS CO_CD_NM,
                    CASE WHEN W01.FILE_TRGT_KEY  IS NULL  THEN 'N' ELSE 'Y' END WBS_PLAN_CHK_YN,
                    TO_CHAR(W01.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT, -- 계획시작일자
                    TO_CHAR(W01.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT, -- 계획종료일자
                    W01.WBS_PLAN_ID,
                    TO_CHAR(W01.WBS_PLAN_DT, 'YYYY-MM-DD') AS  WBS_PLAN_DT,
                    FN_CM06M01_ID_TO_NM(W01.WBS_PLAN_ID) WBS_PLAN_NM,
                    W01.FILE_TRGT_KEY AS WBS_PLAN_FILE_TRGT_KEY,
                    W01.WBS_PLAN_NO,
                    W01.WBS_PLAN_CNTS,
                    W01.WBS_PLAN_RMK,
                    W01.WBS_PLAN_STS_CODE_ID,
                    W01.WBS_PLAN_OS_YN,
                    W01.LOCK_YN,
                    W01.CLOSE_YN,
                    DSGN_DIF_CODE_ID,
                    DSGN_PLAN_HOUR,
                    PRDCTN_DIF_CODE_ID,
                    PRDCTN_PLAN_HOUR,    
                    WBS_PLAN_MNG_ID,
                    FN_CM06M01_ID_TO_NM(W01.WBS_PLAN_MNG_ID) WBS_PLAN_MNG_NM,
                    ISSUE.ISS_NO,
                    TO_CHAR(ISSUE.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
                    TO_CHAR(ISSUE.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
                    ISSUE.ACT_AMT,
                    ISSUE.ACT_CNTS,
                    ISSUE.ACT_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.ACT_ID) ACT_NM,
                    ISSUE.ACT_MH,
                    ISSUE.ACT_YN,
                    ISSUE.CAUSE_CNTS,
                    ISSUE.CF_CNTS,
                    
                    ISSUE.CF_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.CF_DIV) AS CF_DIV_NM,
                    ISSUE.CF_DTL_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.CF_DTL_DIV) AS CF_DTL_DIV_NM,
                    ISSUE.CF_GRD,
                    FN_CM05M01_CD_TO_NM(ISSUE.CF_GRD) AS CF_GRD_NM,
                    
                    ISSUE.CF_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.CF_ID) CF_NM,
                    ISSUE.CF_YN,
                    ISSUE.ISS_CNTS,
                    
                    ISSUE.ISS_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_DIV) AS ISS_DIV_NM,
                    ISSUE.ISS_DTL_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_DTL_DIV) AS ISS_DTL_DIV_NM,
                    ISSUE.ISS_GRD,                    
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_GRD) AS ISS_GRD_NM,
                    ISSUE.ISS_STS,
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_STS) AS ISS_STS_NM,
                    
                    TO_CHAR(ISSUE.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM,
                    ISSUE.CREAT_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.CREAT_ID) CREAT_NM,
                    TO_CHAR(ISSUE.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM,
                    ISSUE.UDT_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.UDT_ID) UDT_NM,
                    ISSUE.FILE_TRGT_KEY
               FROM         
                    (SELECT  
                           CR.CO_CD, 
                           CR.ORDRS_NO,
                           CR.SALES_CD, 
                           Y.ORDRS_CLNT_CD, 
                           (SELECT P.CLNT_NM FROM TB_BM02M01 P WHERE P.CLNT_CD = Y.ORDRS_CLNT_CD) AS ORDRS_CLNT_NM,
                           Y.CLNT_PJT, 
                           CR.ORDRS_DTL_DIV20, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                           CR.PRDT_CD, 
                           (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = CR.PRDT_CD) AS PRDT_CD_NM,
                           CR.ITEM_DIV, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ITEM_DIV) AS ITEM_DIV_NM,
                           CR.EQP_NM ,
                           CD.*
                      FROM TB_CR02D02 CR INNER JOIN TB_CR02M01 Y  ON CR.CO_CD = Y.CO_CD
                                                                 AND CR.ORDRS_NO = Y.ORDRS_NO
                           , (
                                                SELECT 
                                                         CASE WHEN CODE_KIND = 'ROOT' THEN '' ELSE CODE_KIND END CODE_KIND,
                                                         CODE_ID,
                                                         CODE_RPRC,
                                                         CODE_NM,
                                                         CASE WHEN LEVEL = '1' THEN CODE_NM ELSE '' END LVL1,
                                                         CASE WHEN LEVEL = '2' THEN CODE_NM ELSE '' END LVL2,
                                                         CASE WHEN LEVEL = '3' THEN CODE_NM ELSE '' END LVL3,
                                                         LPAD('', 3*(LEVEL-1)) || LEVEL LVL,
                                                         REGEXP_REPLACE(SYS_CONNECT_BY_PATH(CODE_ID, ' -> '), '^\s+\-\>\s+', '') as PATH,
                                                         CONNECT_BY_ISLEAF AS IS_LEAF,
                                                         CASE WHEN CONNECT_BY_ISLEAF = 0 THEN 'unit' ELSE 'leaf' END TYPE
                                                 FROM TB_CM05M01
                                                 START WITH CODE_ID = 'WBSDIV'
                                                 CONNECT BY PRIOR CODE_ID  =  CODE_KIND 
                                )  CD 
                      WHERE CR.CO_CD = #{coCd} 
                         AND CR.SALES_CD = #{salesCd} 
                      ORDER BY  CR.SALES_CD, PATH                 
                     ) AS T LEFT OUTER JOIN TB_WB01M01 W01 ON T.CO_CD    = W01.CO_CD
                                                          AND T.SALES_CD = W01.SALES_CD
                                                          AND T.CODE_ID  = W01.WBS_PLAN_CODE_ID
                            LEFT OUTER JOIN TB_WB03M01 ISSUE 
                               ON W01.CO_CD = ISSUE.CO_CD
                               AND W01.WBS_PLAN_CODE_KIND = ISSUE.WBS_PLAN_CODE_KIND
                               AND W01.WBS_PLAN_CODE_ID = ISSUE.WBS_PLAN_CODE_ID
                               AND W01.FILE_TRGT_KEY = ISSUE.WBS_PLAN_FILE_TRGT_KEY
                               AND W01.WBS_PLAN_NO = ISSUE.WBS_PLAN_NO
                               AND W01.SALES_CD = ISSUE.SALES_CD
                                                           
        </select>        
        
        <select id="selectWbsPlanTreeIssueExcelList" parameterType="Map" resultType="CamelMap">
            SELECT  
                    T.*,
                    FN_CM05M01_CD_TO_NM(T.CO_CD) AS CO_CD_NM,
                    CASE WHEN W01.FILE_TRGT_KEY  IS NULL  THEN 'N' ELSE 'Y' END WBS_PLAN_CHK_YN,
                    TO_CHAR(W01.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT, -- 계획시작일자
                    TO_CHAR(W01.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT, -- 계획종료일자
                    W01.WBS_PLAN_ID,
                    TO_CHAR(W01.WBS_PLAN_DT, 'YYYY-MM-DD') AS  WBS_PLAN_DT,
                    FN_CM06M01_ID_TO_NM(W01.WBS_PLAN_ID) WBS_PLAN_NM,
                    W01.FILE_TRGT_KEY AS WBS_PLAN_FILE_TRGT_KEY,
                    W01.WBS_PLAN_NO,
                    W01.WBS_PLAN_CNTS,
                    W01.WBS_PLAN_RMK,
                    W01.WBS_PLAN_STS_CODE_ID,
                    W01.WBS_PLAN_OS_YN,
                    W01.LOCK_YN,
                    W01.CLOSE_YN,
                    DSGN_DIF_CODE_ID,
                    DSGN_PLAN_HOUR,
                    PRDCTN_DIF_CODE_ID,
                    PRDCTN_PLAN_HOUR,    
                    WBS_PLAN_MNG_ID,
                    FN_CM06M01_ID_TO_NM(W01.WBS_PLAN_MNG_ID) WBS_PLAN_MNG_NM,
                    ISSUE.ISS_NO,
                    TO_CHAR(ISSUE.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
                    TO_CHAR(ISSUE.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
                    ISSUE.ACT_AMT,
                    ISSUE.ACT_CNTS,
                    ISSUE.ACT_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.ACT_ID) ACT_NM,
                    ISSUE.ACT_MH,
                    ISSUE.ACT_YN,
                    ISSUE.CAUSE_CNTS,
                    ISSUE.CF_CNTS,
                    
                    ISSUE.CF_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.CF_DIV) AS CF_DIV_NM,
                    ISSUE.CF_DTL_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.CF_DTL_DIV) AS CF_DTL_DIV_NM,
                    ISSUE.CF_GRD,
                    FN_CM05M01_CD_TO_NM(ISSUE.CF_GRD) AS CF_GRD_NM,
                    
                    ISSUE.CF_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.CF_ID) CF_NM,
                    ISSUE.CF_YN,
                    ISSUE.ISS_CNTS,
                    
                    ISSUE.ISS_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_DIV) AS ISS_DIV_NM,
                    ISSUE.ISS_DTL_DIV,
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_DTL_DIV) AS ISS_DTL_DIV_NM,
                    ISSUE.ISS_GRD,                    
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_GRD) AS ISS_GRD_NM,
                    ISSUE.ISS_STS,
                    FN_CM05M01_CD_TO_NM(ISSUE.ISS_STS) AS ISS_STS_NM,
                    
                    TO_CHAR(ISSUE.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM,
                    ISSUE.CREAT_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.CREAT_ID) CREAT_NM,
                    TO_CHAR(ISSUE.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM,
                    ISSUE.UDT_ID,
                    FN_CM06M01_ID_TO_NM(ISSUE.UDT_ID) UDT_NM,
                    ISSUE.FILE_TRGT_KEY
               FROM         
                    (SELECT  
                           CR.CO_CD, 
                           CR.ORDRS_NO,
                           CR.SALES_CD, 
                           Y.ORDRS_CLNT_CD, 
                           (SELECT P.CLNT_NM FROM TB_BM02M01 P WHERE P.CLNT_CD = Y.ORDRS_CLNT_CD) AS ORDRS_CLNT_NM,
                           Y.CLNT_PJT, 
                           CR.ORDRS_DTL_DIV20, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                           CR.PRDT_CD, 
                           (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = CR.PRDT_CD) AS PRDT_CD_NM,
                           CR.ITEM_DIV, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ITEM_DIV) AS ITEM_DIV_NM,
                           CR.EQP_NM ,
                           CD.*
                      FROM TB_CR02D02 CR INNER JOIN TB_CR02M01 Y  ON CR.CO_CD = Y.CO_CD
                                                                 AND CR.ORDRS_NO = Y.ORDRS_NO
                           , (
                                                SELECT 
                                                         CASE WHEN CODE_KIND = 'ROOT' THEN '' ELSE CODE_KIND END CODE_KIND,
                                                         CODE_ID,
                                                         CODE_RPRC,
                                                         CODE_NM,
                                                         CASE WHEN LEVEL = '1' THEN CODE_NM ELSE '' END LVL1,
                                                         CASE WHEN LEVEL = '2' THEN CODE_NM ELSE '' END LVL2,
                                                         CASE WHEN LEVEL = '3' THEN CODE_NM ELSE '' END LVL3,
                                                         LPAD('', 3*(LEVEL-1)) || LEVEL LVL,
                                                         REGEXP_REPLACE(SYS_CONNECT_BY_PATH(CODE_ID, ' -> '), '^\s+\-\>\s+', '') as PATH,
                                                         CONNECT_BY_ISLEAF AS IS_LEAF,
                                                         CASE WHEN CONNECT_BY_ISLEAF = 0 THEN 'unit' ELSE 'leaf' END TYPE
                                                 FROM TB_CM05M01
                                                 START WITH CODE_ID = 'WBSDIV'
                                                 CONNECT BY PRIOR CODE_ID  =  CODE_KIND 
                                )  CD 
                      WHERE CR.CO_CD = #{coCd} 
                         AND CR.SALES_CD = #{salesCd} 
                      ORDER BY  CR.SALES_CD, PATH                 
                     ) AS T LEFT OUTER JOIN TB_WB01M01 W01 ON T.CO_CD    = W01.CO_CD
                                                          AND T.SALES_CD = W01.SALES_CD
                                                          AND T.CODE_ID  = W01.WBS_PLAN_CODE_ID
                            LEFT OUTER JOIN TB_WB03M01 ISSUE 
                               ON W01.CO_CD = ISSUE.CO_CD
                               AND W01.WBS_PLAN_CODE_KIND = ISSUE.WBS_PLAN_CODE_KIND
                               AND W01.WBS_PLAN_CODE_ID = ISSUE.WBS_PLAN_CODE_ID
                               AND W01.FILE_TRGT_KEY = ISSUE.WBS_PLAN_FILE_TRGT_KEY
                               AND W01.WBS_PLAN_NO = ISSUE.WBS_PLAN_NO
                               AND W01.SALES_CD = ISSUE.SALES_CD
                                                           
        </select>        
        
	    <select id="selectMaxWbsIssueNo" parameterType="Map"  resultType="camelMap">
              SELECT  #{year} || trim(to_char(nvl(SUBSTR(MAX(ISS_NO), 4, 4),0) + 1, '0000')) AS ISS_NO FROM TB_WB03M01 
              WHERE CO_CD = #{coCd}   
        </select>
        
        <select id="selectWbsPlanIssueSeqNext" parameterType="Map" resultType="int">
             SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_WB03M01_SQ01.NEXTVAL,3,0) FROM DUAL
        </select>
        
        <insert id="insertWbsPlanIssue" parameterType="Map">
                INSERT INTO TB_WB03M01
                (
                        FILE_TRGT_KEY,
					    CO_CD,
					    ISS_NO,
					    WBS_PLAN_FILE_TRGT_KEY,
					    WBS_PLAN_NO,
					    WBS_PLAN_CODE_KIND,
					    WBS_PLAN_CODE_ID,
					    SALES_CD,
					    ACT_YN,
					    ISS_DIV,
					    ISS_DTL_DIV,
					    ISS_GRD,
					    ISS_CNTS,
					    ACT_ID,
					    ACTS_DT,
					    ACTE_DT,
					    ACT_MH,
					    ACT_AMT,
					    CF_YN,
					    CF_ID,
					    CAUSE_CNTS,
					    ACT_CNTS,
					    CF_DIV,
					    CF_DTL_DIV,
					    CF_GRD,
					    CF_CNTS,
					    ISS_STS,
					    CREAT_ID,
					    CREAT_PGM,
					    CREAT_DTTM				    
                ) 
                VALUES
                (
                        #{fileTrgtKey},
                        #{coCd},
                        #{issNo},
                        #{wbsPlanFileTrgtKey},
                        #{wbsPlanNo},
                        #{wbsPlanCodeKind},
                        #{wbsPlanCodeId},
                        #{salesCd},
                        #{actYn},
                        #{issDiv},
                        #{issDivDtl},
                        #{issGrd},
                        #{issCnts},
                        #{actId},
                        #{actsDt},
                        #{acteDt},
                        #{actMh},
                        #{actAmt},
                        #{cfYn},
                        #{cfId},
                        #{causeCnts},
                        #{actCnts},
                        #{cfDiv},
                        #{cfDivDtl},
                        #{cfGrd},
                        #{cfCnts},
                        #{issSts},
                        #{userId},
                        #{pgmId},
                        SYSDATE           
                ) 
        </insert>   
        
        <update id="updateWbsPlanIssue" parameterType="Map">
                UPDATE TB_WB03M01
                 SET ACT_YN = #{actYn},
                     ISS_DIV = #{issDiv},
                     ISS_DTL_DIV = #{issDivDtl},
                     ISS_GRD = #{issGrd},
                     ISS_CNTS = #{issCnts},
                     ACT_ID = #{actId},
                     ACTS_DT = #{actsDt},
                     ACTE_DT = #{acteDt},
                     ACT_MH = #{actMh},
                     ACT_AMT = #{actAmt},
                     CF_YN =  #{cfYn},
                     CF_ID = #{cfId},
                     CAUSE_CNTS = #{causeCnts},
                     ACT_CNTS = #{actCnts},
                     CF_DIV = #{cfDiv},
                     CF_DTL_DIV = #{cfDivDtl},
                     CF_GRD = #{cfGrd},
                     CF_CNTS = #{cfCnts},
                     ISS_STS = #{issSts},
                     UDT_ID = #{userId},
                     UDT_PGM =  #{pgmId},
                     UDT_DTTM = SYSDATE
                     WHERE FILE_TRGT_KEY = #{fileTrgtKey} 
     
        </update>   
         
        <delete id="deleteWbsPlanIssue" parameterType="Map">
               DELETE FROM TB_WB03M01
                   WHERE FILE_TRGT_KEY = #{fileTrgtKey}
        </delete> 
   
        <select id="deleteIssueSharngListChk" parameterType="Map" resultType="camelMap">
               SELECT *  FROM TB_WB20M03
                   WHERE TODO_CO_CD  = #{coCd}
                         AND SALES_CD  = #{salesCd}
                         AND TODO_NO  = #{issueNo}
                         AND TODO_CODE_KIND  = #{wbsPlanCodeKind}
                         AND TODO_CODE_ID  = #{wbsPlanCodeId}
                         AND TODO_DIV1_CODE_ID  = #{S_todoDiv1CodeId}
                         AND TODO_DIV2_CODE_ID  = #{S_todoDiv2CodeId}
        </select>    
        
        <delete id="deleteIssueSharngList" parameterType="Map">
               DELETE FROM TB_WB20M03
                   WHERE TODO_CO_CD  = #{coCd}
                         AND SALES_CD  = #{salesCd}
                         AND TODO_NO  = #{issueNo}
                         AND TODO_CODE_KIND  = #{wbsPlanCodeKind}
                         AND TODO_CODE_ID  = #{wbsPlanCodeId}
                         AND TODO_DIV1_CODE_ID  = #{S_todoDiv1CodeId}
                         AND TODO_DIV2_CODE_ID  = #{S_todoDiv2CodeId}
        </delete>
        
        <insert id="insertIssueSharngList" parameterType="Map">
                <selectKey keyProperty="toDoKey" resultType="Int" order="BEFORE">
                    SELECT NVL(MAX(TODO_KEY), 0) + 1 FROM TB_WB20M03
                </selectKey>
                INSERT INTO TB_WB20M03
                (
                    TODO_KEY,
                    SANCTN_SN,
                    CO_CD,
                    TODO_DIV1_CODE_ID,
                    TODO_DIV2_CODE_ID,
                    TODO_ID,
                    SALES_CD,
                    PG_PATH,
                    TODO_FILE_TRGT_KEY,
                    TODO_CO_CD,
                    TODO_NO,
                    TODO_CODE_KIND,
                    TODO_CODE_ID,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM,
                    PG_PARAM
                ) 
                VALUES
                (
                    #{toDoKey},
                    #{sanctnSn},
                    #{coCd},
                    #{todoDiv1CodeId},
                    #{todoDiv2CodeId},
                    #{wbsSharngUserId},
                    #{salesCd},
                    #{pgPath},
                    #{fileTrgtKey},
                    #{issueCoCd},
                    #{issueNo},
                    #{wbsPlanCodeKind},
                    #{wbsPlanCodeId},
                    #{creatId},
                    #{creatPgm},
                    SYSDATE,
                    #{pgParam}
                )
         </insert>
         <select id="selectIssueSharngList" parameterType="Map" resultType="camelMap">
               SELECT ROWNUM AS RN,
                      X.SALES_CD, 
                      X.TODO_CODE_ID AS ISSUE_CODE_ID,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_CODE_ID) AS ISSUE_CODE_NM,
                      X.TODO_NO AS ISSUE_NO,
                      X.TODO_CO_CD AS ISSUE_CO_CD,
                      TO_CHAR(X.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT,
                      X.TODO_CF_OPN,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_CO_CD) AS ISSUE_CO_NM,                      
                      Y.ID AS WBS_SHARNG_USER_ID, 
                      Y.EMP_NO,
                      Y.NAME,
                      Y.TEL_NO,
                      Y.EMAIL
                      FROM TB_WB20M03 X
                      INNER JOIN TB_CM06M01 Y
                      ON X.TODO_CO_CD = Y.CO_CD
                      AND X.TODO_ID = Y.ID
                      WHERE X.TODO_CO_CD = #{coCd}
                      AND X.TODO_CODE_ID = #{codeId} 
                      AND X.SALES_CD = #{salesCd}
                      AND X.TODO_DIV2_CODE_ID = 'TODODIV1030'
                      ORDER BY ROWNUM ASC
          </select>
        
</mapper>
