<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb03.mapper.WB03Mapper">

	<select id="selectWbsPlanTreeIssueList" parameterType="Map" resultType="CamelMap">
            SELECT  
                    T.*,
                    FN_CM05M01_CD_TO_NM(T.CO_CD) AS CO_CD_NM,
                    CASE WHEN W01.FILE_TRGT_KEY  IS NULL  THEN 'N' ELSE 'Y' END WBS_PLAN_CHK_YN,
                    TO_CHAR(W01.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT, -- 계획시작일자
                    TO_CHAR(W01.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT, -- 계획종료일자
                    W01.WBS_PLAN_ID,
                    TO_CHAR(W01.WBS_PLAN_DT, 'YYYY-MM-DD') AS  WBS_PLAN_DT,
                    FN_CM06M01_ID_TO_NM(W01.WBS_PLAN_ID) WBS_PLAN_NM,
                    W01.FILE_TRGT_KEY,
                    W01.WBS_PLAN_NO,
                    W01.WBS_PLAN_CNTS,
                    W01.WBS_PLAN_RMK,
                    W01.WBS_PLAN_STS_CODE_ID,
                    W01.WBS_PLAN_OS_YN,
                    W01.LOCK_YN,
                    W01.CLOSE_YN,
                    DSGN_DIF_CODE_ID,
                    DSGN_PLAN_HOUR,
                    PRDCTN_DIF_CODE_ID,
                    PRDCTN_PLAN_HOUR,    
                    WBS_PLAN_MNG_ID,
                    FN_CM06M01_ID_TO_NM(W01.WBS_PLAN_MNG_ID) WBS_PLAN_MNG_NM,
                    ISSUE.ISS_NO,
                    ISSUE.ACTS_DT,
                    ISSUE.ACTE_DT,
                    ISSUE.ACT_AMT,
                    ISSUE.ACT_CNTS,
                    ISSUE.ACT_ID,
                    ISSUE.ACT_MH,
                    ISSUE.ACT_YN,
                    ISSUE.CAUSE_CNTS,
                    ISSUE.CF_CNTS,
                    ISSUE.CF_DIV,
                    ISSUE.CF_DTL_DIV,
                    ISSUE.CF_GRD,
                    ISSUE.CF_ID,
                    ISSUE.CF_YN,
                    ISSUE.ISS_CNTS,
                    ISSUE.ISS_DIV,
                    ISSUE.ISS_DTL_DIV,
                    ISSUE.ISS_GRD,
                    ISSUE.ISS_STS,
                    ISSUE.CREAT_DTTM,
                    ISSUE.CREAT_ID,
                    ISSUE.UDT_DTTM,
                    ISSUE.UDT_ID,
                    ISSUE.FILE_TRGT_KEY AS ISSUE_FILE_TRGT_KEY
               FROM         
                    (SELECT  
                           CR.CO_CD, 
                           CR.ORDRS_NO,
                           CR.SALES_CD, 
                           Y.ORDRS_CLNT_CD, 
                           (SELECT P.CLNT_NM FROM TB_BM02M01 P WHERE P.CLNT_CD = Y.ORDRS_CLNT_CD) AS ORDRS_CLNT_NM,
                           Y.CLNT_PJT, 
                           CR.ORDRS_DTL_DIV20, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ORDRS_DTL_DIV20) AS ORDRS_DTL_DIV20_NM,
                           CR.PRDT_CD, 
                           (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = CR.PRDT_CD) AS PRDT_CD_NM,
                           CR.ITEM_DIV, 
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = CR.ITEM_DIV) AS ITEM_DIV_NM,
                           CR.EQP_NM ,
                           CD.*
                      FROM TB_CR02D02 CR INNER JOIN TB_CR02M01 Y  ON CR.CO_CD = Y.CO_CD
                                                                 AND CR.ORDRS_NO = Y.ORDRS_NO
                           , (
                                                SELECT 
                                                         CASE WHEN CODE_KIND = 'ROOT' THEN '' ELSE CODE_KIND END CODE_KIND,
                                                         CODE_ID,
                                                         CODE_RPRC,
                                                         CODE_NM,
                                                         CASE WHEN LEVEL = '1' THEN CODE_NM ELSE '' END LVL1,
                                                         CASE WHEN LEVEL = '2' THEN CODE_NM ELSE '' END LVL2,
                                                         CASE WHEN LEVEL = '3' THEN CODE_NM ELSE '' END LVL3,
                                                         LPAD('', 3*(LEVEL-1)) || LEVEL LVL,
                                                         REGEXP_REPLACE(SYS_CONNECT_BY_PATH(CODE_ID, ' -> '), '^\s+\-\>\s+', '') as PATH,
                                                         CONNECT_BY_ISLEAF AS IS_LEAF,
                                                         CASE WHEN CONNECT_BY_ISLEAF = 0 THEN 'unit' ELSE 'leaf' END TYPE
                                                 FROM TB_CM05M01
                                                 START WITH CODE_ID = 'WBSDIV'
                                                 CONNECT BY PRIOR CODE_ID  =  CODE_KIND 
                                )  CD 
                      WHERE CR.CO_CD = #{coCd} 
                         AND CR.SALES_CD = #{salesCd} 
                      ORDER BY  CR.SALES_CD, PATH                 
                     ) AS T LEFT OUTER JOIN TB_WB01M01 W01 ON T.CO_CD    = W01.CO_CD
                                                          AND T.SALES_CD = W01.SALES_CD
                                                          AND T.CODE_ID  = W01.WBS_PLAN_CODE_ID
                            LEFT OUTER JOIN TB_WB03M01 ISSUE 
                               ON W01.CO_CD = ISSUE.CO_CD
                               AND W01.WBS_PLAN_CODE_KIND = ISSUE.WBS_PLAN_CODE_KIND
                               AND W01.WBS_PLAN_CODE_ID = ISSUE.WBS_PLAN_CODE_ID
                               AND W01.FILE_TRGT_KEY = ISSUE.WBS_PLAN_FILE_TRGT_KEY
                               AND W01.WBS_PLAN_NO = ISSUE.WBS_PLAN_NO
                               AND W01.SALES_CD = ISSUE.SALES_CD
                                                           
        </select>        
        
	    <select id="selectMaxWbsIssueNo" parameterType="Map"  resultType="camelMap">
              SELECT  #{year} || trim(to_char(nvl(SUBSTR(MAX(ISS_NO), 4, 4),0) + 1, '0000')) AS ISS_NO FROM TB_WB03M01 
              WHERE CO_CD = #{coCd}   
        </select>
   
</mapper>
