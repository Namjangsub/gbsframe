<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb02.mapper.WB02Mapper">

<!-- WBS 일정계획 등록 메인 화면 조회 리스트  -->
          <select id="selectWbsRsltsPlanListCount" parameterType="Map" resultType="int">   
            SELECT * FROM (
                    SELECT ROWNUM AS RN, Z.*, 
                                   S.ORDRS_NO, -- 수주번호
                                   S.ORGN_SALES_CD, -- 원천 SALES CODE
                                   S.ORDRS_CLNT_CD, -- 고객사
                                   (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD =S.ORDRS_CLNT_CD) AS ORDRS_CLNT_NM,
                                   S.CLNT_PJT, -- 고객사 PJT
                                   S.ORDRS_DTL_DIV30, -- 신작구분
                                   (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.ORDRS_DTL_DIV30) AS ORDRS_DTL_DIV30_NM,
                                   S.PRDT_CD, -- 제품구분
                                   (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.PRDT_CD) AS PRDT_CD_NM,
                                   S.ITEM_DIV, -- 아이템구분
                                   (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.ITEM_DIV) AS ITEM_DIV_NM,
                                   S.EQP_NM -- 설비명
                                   FROM (
                                    SELECT 
                                       X.FILE_TRGT_KEY,
                                       X.CO_CD, -- 회사코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS CO_CD_NM,
                                       X.SALES_CD,-- SALES_CODE
                                       X.WBS_PLAN_NO, -- WBS계획번호
                                       Y.LVL1, -- WBS 레벨 1
                                       Y.LVL2, -- WBS 레벨 2
                                       Y.LVL3, -- WBS 레벨 3
                                       Y.CODE_KIND, -- 계획항목분류
                                       Y.CODE_ID, -- 계획항목코드
                                       X.WBS_PLAN_CNTS, -- 주요내용
                                       TO_CHAR(X.WBS_PLAN_DT, 'YYYY-MM-DD') AS WBS_PLAN_DT, -- 작성일
                                       X.WBS_PLAN_ID, -- 작성자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.WBS_PLAN_ID) AS WBS_PLAN_NM,
                                       X.WBS_PLAN_MNG_ID, -- 담당자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.WBS_PLAN_MNG_ID) AS WBS_PLAN_MNG_NM,
                                       TO_CHAR(X.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT, -- 시작일자
                                       TO_CHAR(X.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT, -- 종료일자
                                       X.WBS_PLAN_RMK, -- 비고
                                       X.WBS_PLAN_STS_CODE_ID, -- 계획상태코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_STS_CODE_ID) AS WBS_PLAN_STS_NM,
                                       X.DSGN_DIF_CODE_ID, -- 설계난이도코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.DSGN_DIF_CODE_ID) AS DSGN_DIF_CODE_NM,
                                       X.DSGN_PLAN_HOUR, -- 설계계획공수
                                       X.PRDCTN_DIF_CODE_ID, -- 생산난이도코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.PRDCTN_DIF_CODE_ID) AS PRDCTN_DIF_CODE_NM,
                                       X.PRDCTN_PLAN_HOUR, -- 생산계획공수
                                       X.WBS_PLAN_OS_YN, -- 계획외주코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_OS_YN) AS WBS_PLAN_OS_NM,
                                       X.CREAT_ID, -- 생성자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CREAT_ID) AS CREAT_NM,
                                       X.CREAT_PGM, -- 셍성프로그램ID
                                       TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM, -- 생성일시
                                       X.UDT_ID, -- 최종변경자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.UDT_ID) AS UDT_NM,
                                       X.UDT_PGM, -- 최종수정프로그램ID
                                       TO_CHAR(UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM,  -- 최종변경일시
                                       X.LOCK_YN,
                                       X.CLOSE_YN                                       
                                          FROM TB_WB01M01 X
                                           INNER JOIN (
                                                        SELECT 
                                                        CODE_KIND,
                                                        CODE_ID,
                                                        CODE_RPRC,
                                                        CODE_NM,
                                                        CASE WHEN LEVEL = '1' THEN CODE_NM ELSE '' END LVL1,
                                                        CASE WHEN LEVEL = '2' THEN CODE_NM ELSE '' END LVL2,
                                                        CASE WHEN LEVEL = '3' THEN CODE_NM ELSE '' END LVL3,
                                                        LPAD(' ', 3*LEVEL-1) || SYS_CONNECT_BY_PATH(CODE_NM, '>') PATH
                                                    FROM TB_CM05M01
                                                    START WITH CODE_KIND = 'WBSDIV'
                                                    CONNECT BY PRIOR CODE_ID  =  CODE_KIND ) Y
                                            ON X.WBS_PLAN_CODE_KIND = Y.CODE_KIND
                                            AND X.WBS_PLAN_CODE_ID = Y.CODE_ID     
                                     ORDER BY X.SALES_CD, X.WBS_PLAN_CODE_ID ASC) Z 
                         INNER JOIN (
                           SELECT  X.CO_CD, -- 회사코드
                                   X.ORDRS_NO, -- 수주번호
                                   X.SALES_CD, -- SALES CODE
                                   Y.ORGN_SALES_CD, -- 원천 SALES CODE
                                   Y.ORDRS_CLNT_CD, -- 고객사
                                   Y.CLNT_PJT, -- 고객사 PJT
                                   X.ORDRS_DTL_DIV30, -- 신작구분
                                   X.PRDT_CD, -- 제품구분
                                   X.ITEM_DIV, -- 아이템구분
                                   X.EQP_NM -- 설비명
                                   FROM TB_CR02D02 X
                            INNER JOIN TB_CR02M01 Y
                            ON X.CO_CD = Y.CO_CD
                            AND X.ORDRS_NO = Y.ORDRS_NO ) S
                          ON Z.CO_CD = S.CO_CD
                          AND Z.SALES_CD = S.SALES_CD 
                )                
             WHERE CO_CD = '${coCd}'
              AND WBS_PLAN_DT BETWEEN '${wbsPlansDt}' AND '${wbsPlaneDt}'           
             <if test="salesCd != null and !salesCd.equals('')">
                AND SALES_CD LIKE '%${salesCd}%' <!--  salescode 검색    -->  
             </if>
             <if test="clntCd != null and !clntCd.equals('')">
                 AND ORDRS_CLNT_CD LIKE '%${clntCd}%' <!--  고객사 검색    -->               
             </if>
             <if test="prdtDiv != null and !prdtDiv.equals('')">
                AND PRDT_CD LIKE '%${prdtDiv}%' <!--  제품구분 검색    -->               
             </if>
             <if test="prdtItem != null and !prdtItem.equals('')">
                AND ITEM_DIV LIKE '%${prdtItem}%'  <!--  아이템구분 검색    -->              
             </if> 
             <if test="wbsClntPjt != null and !wbsClntPjt.equals('')">
                AND CLNT_PJT LIKE '%${wbsClntPjt}%'  <!--  고객사 PJT 검색    -->              
             </if> 
             <if test="eqp_nm != null and !eqp_nm.equals('')">
                AND EQP_NM LIKE '%${eqp_nm}%'   <!--  설비명 검색    -->             
             </if>
             <if test="wbsPlanNo != null and !wbsPlanNo.equals('')">
                AND WBS_PLAN_NO LIKE '%${wbsPlanNo}%'   <!--  관리번호 검색    -->             
             </if>
             
             <if test="salesMngId != null and !salesMngId.equals('')">
                AND CODE_ID IN 
                   (SELECT WBS_PLAN_CODE_ID FROM TB_WB01P01 X
                       WHERE X.CO_CD = '${coCd}' 
                           <if test="salesCd != null and !salesCd.equals('')">
                             AND X.SALES_CD = '${salesCd}' 
                            </if> 
                             AND X.ID = '${salesMngId}')           
             </if>
          </select>
          
          
<!-- WBS 일정계획 등록 메인 화면 조회 리스트  -->
          <select id="selectWbsRsltsPlanList" parameterType="Map" resultType="camelMap">   
            SELECT * FROM (
                    SELECT ROWNUM AS RN, Z.*, 
                                   S.ORDRS_NO, -- 수주번호
                                   S.ORGN_SALES_CD, -- 원천 SALES CODE
                                   S.ORDRS_CLNT_CD, -- 고객사
                                   (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD =S.ORDRS_CLNT_CD) AS ORDRS_CLNT_NM,
                                   S.CLNT_PJT, -- 고객사 PJT
                                   S.ORDRS_DTL_DIV30, -- 신작구분
                                   (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.ORDRS_DTL_DIV30) AS ORDRS_DTL_DIV30_NM,
                                   S.PRDT_CD, -- 제품구분
                                   (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.PRDT_CD) AS PRDT_CD_NM,
                                   S.ITEM_DIV, -- 아이템구분
                                   (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.ITEM_DIV) AS ITEM_DIV_NM,
                                   S.EQP_NM -- 설비명
                                   FROM (
                                    SELECT 
                                       X.FILE_TRGT_KEY,
                                       X.CO_CD, -- 회사코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS CO_CD_NM,
                                       X.SALES_CD,-- SALES_CODE
                                       X.WBS_PLAN_NO, -- WBS계획번호
                                       Y.LVL1, -- WBS 레벨 1
                                       Y.LVL2, -- WBS 레벨 2
                                       Y.LVL3, -- WBS 레벨 3
                                       Y.CODE_KIND, -- 계획항목분류
                                       Y.CODE_ID, -- 계획항목코드
                                       X.WBS_PLAN_CNTS, -- 주요내용
                                       TO_CHAR(X.WBS_PLAN_DT, 'YYYY-MM-DD') AS WBS_PLAN_DT, -- 작성일
                                       X.WBS_PLAN_ID, -- 작성자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.WBS_PLAN_ID) AS WBS_PLAN_NM,
                                       X.WBS_PLAN_MNG_ID, -- 담당자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.WBS_PLAN_MNG_ID) AS WBS_PLAN_MNG_NM,
                                       TO_CHAR(X.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT, -- 시작일자
                                       TO_CHAR(X.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT, -- 종료일자
                                       X.WBS_PLAN_RMK, -- 비고
                                       X.WBS_PLAN_STS_CODE_ID, -- 계획상태코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_STS_CODE_ID) AS WBS_PLAN_STS_NM,
                                       X.DSGN_DIF_CODE_ID, -- 설계난이도코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.DSGN_DIF_CODE_ID) AS DSGN_DIF_CODE_NM,
                                       X.DSGN_PLAN_HOUR, -- 설계계획공수
                                       X.PRDCTN_DIF_CODE_ID, -- 생산난이도코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.PRDCTN_DIF_CODE_ID) AS PRDCTN_DIF_CODE_NM,
                                       X.PRDCTN_PLAN_HOUR, -- 생산계획공수
                                       X.WBS_PLAN_OS_YN, -- 계획외주코드
                                       (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_OS_YN) AS WBS_PLAN_OS_NM,
                                       X.CREAT_ID, -- 생성자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CREAT_ID) AS CREAT_NM,
                                       X.CREAT_PGM, -- 셍성프로그램ID
                                       TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM, -- 생성일시
                                       X.UDT_ID, -- 최종변경자
                                       (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.UDT_ID) AS UDT_NM,
                                       X.UDT_PGM, -- 최종수정프로그램ID
                                       TO_CHAR(UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM,  -- 최종변경일시
                                       X.LOCK_YN,
                                       X.CLOSE_YN                                       
                                          FROM TB_WB01M01 X
                                           INNER JOIN (
                                                        SELECT 
                                                        CODE_KIND,
                                                        CODE_ID,
                                                        CODE_RPRC,
                                                        CODE_NM,
                                                        CASE WHEN LEVEL = '1' THEN CODE_NM ELSE '' END LVL1,
                                                        CASE WHEN LEVEL = '2' THEN CODE_NM ELSE '' END LVL2,
                                                        CASE WHEN LEVEL = '3' THEN CODE_NM ELSE '' END LVL3,
                                                        LPAD(' ', 3*LEVEL-1) || SYS_CONNECT_BY_PATH(CODE_NM, '>') PATH
                                                    FROM TB_CM05M01
                                                    START WITH CODE_KIND = 'WBSDIV'
                                                    CONNECT BY PRIOR CODE_ID  =  CODE_KIND ) Y
                                            ON X.WBS_PLAN_CODE_KIND = Y.CODE_KIND
                                            AND X.WBS_PLAN_CODE_ID = Y.CODE_ID     
                                     ORDER BY X.SALES_CD, X.WBS_PLAN_CODE_ID ASC) Z 
                         INNER JOIN (
                           SELECT  X.CO_CD, -- 회사코드
                                   X.ORDRS_NO, -- 수주번호
                                   X.SALES_CD, -- SALES CODE
                                   Y.ORGN_SALES_CD, -- 원천 SALES CODE
                                   Y.ORDRS_CLNT_CD, -- 고객사
                                   Y.CLNT_PJT, -- 고객사 PJT
                                   X.ORDRS_DTL_DIV30, -- 신작구분
                                   X.PRDT_CD, -- 제품구분
                                   X.ITEM_DIV, -- 아이템구분
                                   X.EQP_NM -- 설비명
                                   FROM TB_CR02D02 X
                            INNER JOIN TB_CR02M01 Y
                            ON X.CO_CD = Y.CO_CD
                            AND X.ORDRS_NO = Y.ORDRS_NO ) S
                          ON Z.CO_CD = S.CO_CD
                          AND Z.SALES_CD = S.SALES_CD 
                )                
             WHERE CO_CD = '${coCd}'
              AND WBS_PLAN_DT BETWEEN '${wbsPlansDt}' AND '${wbsPlaneDt}'           
             <if test="salesCd != null and !salesCd.equals('')">
                AND SALES_CD LIKE '%${salesCd}%' <!--  salescode 검색    -->  
             </if>
             <if test="clntCd != null and !clntCd.equals('')">
                 AND ORDRS_CLNT_CD LIKE '%${clntCd}%' <!--  고객사 검색    -->               
             </if>
             <if test="prdtDiv != null and !prdtDiv.equals('')">
                AND PRDT_CD LIKE '%${prdtDiv}%' <!--  제품구분 검색    -->               
             </if>
             <if test="prdtItem != null and !prdtItem.equals('')">
                AND ITEM_DIV LIKE '%${prdtItem}%'  <!--  아이템구분 검색    -->              
             </if> 
             <if test="wbsClntPjt != null and !wbsClntPjt.equals('')">
                AND CLNT_PJT LIKE '%${wbsClntPjt}%'  <!--  고객사 PJT 검색    -->              
             </if> 
             <if test="eqp_nm != null and !eqp_nm.equals('')">
                AND EQP_NM LIKE '%${eqp_nm}%'   <!--  설비명 검색    -->             
             </if>
             <if test="wbsPlanNo != null and !wbsPlanNo.equals('')">
                AND WBS_PLAN_NO LIKE '%${wbsPlanNo}%'   <!--  관리번호 검색    -->             
             </if>
             
             <if test="salesMngId != null and !salesMngId.equals('')">
                AND CODE_ID IN 
                   (SELECT WBS_PLAN_CODE_ID FROM TB_WB01P01 X
                       WHERE X.CO_CD = '${coCd}' 
                           <if test="salesCd != null and !salesCd.equals('')">
                             AND X.SALES_CD = '${salesCd}' 
                            </if> 
                             AND X.ID = '${salesMngId}')           
             </if>
          </select>
        
 </mapper>