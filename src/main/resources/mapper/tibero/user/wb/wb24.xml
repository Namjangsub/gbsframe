<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb24.mapper.WB24Mapper">

     <select id="selectWbsIssueListCount" parameterType="Map" resultType="int">

          </select>


     <select id="selectWbsIssueList" parameterType="Map" resultType="camelMap">
			WITH TRG AS 
				(
						SELECT DISTINCT SALES_CD 
				           FROM TB_WB22M01 --WBS계획 정보
				          WHERE CO_CD    = 'GUN'
				            AND WBS_PLAN_CODE_KIND = 'WBSCODE' --LEVEL2
					    <choose>
					        <when test="salesCd != null and !salesCd.equals('')"> 
					         AND SALES_CD like '%'||#{salesCd}||'%'
					        </when>
					        <otherwise>
					         AND WBS_PLANS_DT BETWEEN #{wbsRsltssDt} AND #{wbsRsltseDt}  
					        </otherwise>
					    </choose>
				)
				, PLN AS --계획정보 TREE 
			     ( 
			      SELECT A.*
			           , LEVEL AS LVL
			           , REGEXP_REPLACE(SYS_CONNECT_BY_PATH(A.LOWER_CD, ' -> '), '^\s+\-\>\s+', '') AS PATH --출고경로 
			        FROM (
			            
			              SELECT DISTINCT 
			                    'top'    AS UPPER_CD
			                    , SALES_CD AS LOWER_CD
			                    , CO_CD
			                    , SALES_CD
			                    , VER_NO
			                    , ''       AS WBS_PLAN_CODE_KIND
			                    , ''       AS WBS_PLAN_CODE_ID             
			                    , ''       AS WBS_PLAN_CODE_NM
			                    , ''       AS WBS_PLANS_DT
			                    , ''       AS WBS_PLANE_DT
			                    , ''       AS WBS_MNG_NM
			                    , ''       AS P_PLAN_NO
			                    , ''       AS P_RSLTS_NO
			                    , ''       AS P_PLAN_TRGT_KEY
			                    , ''       AS P_RSLTS_TRGT_KEY
			                FROM TB_WB22M01 --WBS계획 정보
			               WHERE 1  = 1 
			                 AND CO_CD    = #{coCd}
			                 AND WBS_PLAN_CODE_KIND = 'WBSCODE'
			                 AND EXISTS (SELECT 1 FROM TRG  WHERE TRG.SALES_CD = TB_WB22M01.SALES_CD) --WBS계획 정보
			              UNION ALL
			              SELECT SALES_CD                    AS UPPER_CD
			                    , SALES_CD||WBS_PLAN_CODE_ID  AS LOWER_CD
			                    , CO_CD
			                    , SALES_CD
			                    , VER_NO
			                    , WBS_PLAN_CODE_KIND
			                    , WBS_PLAN_CODE_ID
			                    , (SELECT FN_CM05M01_CD_TO_NM(WBS_PLAN_CODE_ID) FROM DUAL) AS WBS_PLAN_CODE_NM
			                    , WBS_PLANS_DT   
			                    , WBS_PLANE_DT   
			                    , (SELECT FN_CM06M01_ID_TO_NM(WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_MNG_NM
			                    , ''                                  AS P_PLAN_NO
			                    , ''                                  AS P_RSLTS_NO
			                    , ''                                  AS P_PLAN_TRGT_KEY
			                    , ''                                  AS P_RSLTS_TRGT_KEY
			                 FROM TB_WB22M01 --WBS계획 정보
			                WHERE CO_CD    = #{coCd}
			                  AND WBS_PLAN_CODE_KIND = 'WBSCODE' --LEVEL1
			                  AND (SALES_CD, WBS_PLAN_CODE_ID) IN ( SELECT DISTINCT SALES_CD, WBS_PLAN_CODE_KIND --LEVEL2 없는 LEVEL1 제외 
			                                                          FROM TB_WB22M01 --WBS계획 정보
			                                                         WHERE CO_CD    = #{coCd}
			                                                           AND WBS_PLAN_CODE_KIND != 'WBSCODE' --LEVEL2
			                  										   AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = TB_WB22M01.SALES_CD)
			                  									  )
			              UNION ALL           
			              SELECT PLN.SALES_CD||PLN.WBS_PLAN_CODE_KIND AS UPPER_CD
			                    , PLN.WBS_PLAN_CODE_ID                 AS LOWER_CD
			                    , PLN.CO_CD
			                    , PLN.SALES_CD
			                    , PLN.VER_NO
			                    , PLN.WBS_PLAN_CODE_KIND
			                    , PLN.WBS_PLAN_CODE_ID
			                    , PLN.WBS_PLAN_CODE_NM
			                    , PLN.WBS_PLANS_DT   
			                    , PLN.WBS_PLANE_DT   
			                    , ''                                  AS WBS_MNG_NM
			                    , PLN.WBS_PLAN_NO                     AS P_PLAN_NO
			                    , RSL.WBS_RSLTS_NO                    AS P_RSLTS_NO
			                    , PLN.FILE_TRGT_KEY                   AS P_PLAN_TRGT_KEY
			                    , RSL.FILE_TRGT_KEY                   AS P_RSLTS_TRGT_KEY
			                 FROM TB_WB22M01 AS PLN--WBS계획 정보
			                      LEFT OUTER JOIN TB_WB23M01 AS RSL ON PLN.CO_CD = RSL.CO_CD AND PLN.SALES_CD = RSL.SALES_CD AND PLN.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND AND PLN.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID 
			                WHERE PLN.CO_CD    = #{coCd}
			                  AND PLN.WBS_PLAN_CODE_KIND != 'WBSCODE' --LEVEL2
			                  AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = PLN.SALES_CD)
			             ) A
			       WHERE 1=1
			       START WITH UPPER_CD = 'top' 
			       CONNECT BY PRIOR LOWER_CD = UPPER_CD
			       ORDER BY PATH
			     ) 
			   , SJD AS --수주상세 
			     ( 
			      SELECT M.CO_CD                                              AS CO_CD        --회사코드
			            , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
			            , X.SALES_CD                                           AS SALES_CD     --SALES Code
			            , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
			            , C.CLNT_NM                                            AS CLNT_NM      --고객명
			            , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
			            , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
			         FROM TB_CR02M01  M --수주마스터
			              INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
			              INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
			        WHERE 1=1
			          AND M.CO_CD    = #{coCd}
			          AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = X.SALES_CD)
			     )
			   , SUBJ AS --과제정보
			     (
			      SELECT X.CO_CD      AS CO_CD    --회사코드
			            , X.SALES_CD   AS SALES_CD --SALES Code
			            , X.SJ_NO      AS SJ_NO    --과제번호
			            , X.SJ_NM      AS SJ_NM    --과제명
			            , X.VER_NO     AS VER_NO   --버젼
			        FROM TB_WB21M01 X
			       WHERE X.CO_CD    = #{coCd}
			         AND X.CLOSE_YN = 'Y'
			         AND X.VER_NO  = (SELECT MAX(VER_NO) 
			         					FROM TB_WB21M01 Z
			         				   WHERE CO_CD = #{coCd} 
			         				     AND SALES_CD like X.SALES_CD
			                         )
			         AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = X.SALES_CD) 
			     ) 
			   , ISU AS --이슈정보
			     (
	              SELECT '계획'  AS GUBUN 
	                    , ISU.CO_CD                                   --회사코드
	                    , ISU.SALES_CD                                --SALES Code 
	                    , ISU.WBS_PLAN_CODE_KIND                      --WBS계획 LVL1
	                    , ISU.WBS_PLAN_CODE_ID                        --WBS계획 LVL2
	                    , ISU.WBS_PLAN_NO                             --WBS계획 번호
	                    , ISU.WBS_RSLTS_NO                            --WBS실적 번호
	                    , ISU.ISS_NO                                  --이슈번호
	                    , ISU.ISS_SJ                                  --이슈제목
	                    , ISU.ISS_DIV                                 --이슈유형
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
	                    , ISU.ISS_CNTS                                --이슈내용
	                    , ISU.ISS_STS                                 --이슈상태
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
	                    , ISU.ACT_ID                                  --조치담당자
	                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT--조치 시작일
	                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT--조치 종료일
	                    , ACT.ACT_MH                                  --조치 투입공수
	                    , ACT.ACT_AMT                                 --조치 투입비용  
	                    , ACT.ACT_CNTS                                --조치내용
	                    , ISU.FILE_TRGT_KEY                           --이슈 FILE_TRGT_KEY
	                    , ISU.CREAT_PGM 						AS  FILE_TRGT_TYP   --생성프로그램
	                    , ''  WBS_RSLTSS_DT                           --실적시작일
	                    , ''  WBS_RSLTSE_DT                           --실적종료일
	                    , ACT.REQ_NO                                  --발주요청번호
	                FROM TB_WB24M02 AS ISU --계획이슈 정보
	                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --계획이슈 조치내용
	               WHERE ISU.WBS_PLAN_NO IS NOT NULL --계획이슈 
	                 AND ISU.CO_CD    = #{coCd}
	         		 AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = ISU.SALES_CD) 
	              UNION ALL
	              SELECT '실적'  AS GUBUN 
	                    , ISU.CO_CD                                               --회사코드
	                    , ISU.SALES_CD                                            --SALES Code 
	                    , ISU.WBS_PLAN_CODE_KIND                                  --WBS계획 LVL1
	                    , ISU.WBS_PLAN_CODE_ID                                    --WBS계획 LVL2
	                    , ISU.WBS_PLAN_NO                                         --WBS계획 번호
	                    , ISU.WBS_RSLTS_NO                                        --WBS실적 번호
	                    , ISU.ISS_NO                                              --이슈번호
	                    , ISU.ISS_SJ                                              --이슈제목
	                    , ISU.ISS_DIV                                             --이슈유형
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
	                    , ISU.ISS_CNTS                                            --이슈내용
	                    , ISU.ISS_STS                                             --이슈상태
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
	                    , ISU.ACT_ID                                              --조치담당자
	                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD')  AS ACTS_DT           --조치 시작일
	                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD')  AS ACTE_DT           --조치 종료일
	                    , ACT.ACT_MH                                              --조치 투입공수
	                    , ACT.ACT_AMT                                             --조치 투입비용  
	                    , ACT.ACT_CNTS                                            --조치내용
	                    , ISU.FILE_TRGT_KEY                                       --이슈 FILE_TRGT_KEY
	                    , ISU.CREAT_PGM 						AS  FILE_TRGT_TYP   --생성프로그램
	                    , TO_CHAR(RSL.WBS_RSLTSS_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT--실적시작일
	                    , TO_CHAR(RSL.WBS_RSLTSE_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT--실적종료일
	                    , ACT.REQ_NO                                  --발주요청번호
	                FROM TB_WB24M02  AS ISU --WBS이슈 정보
	                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --실적이슈 조치내용
	                      LEFT OUTER JOIN TB_WB23M01 AS RSL ON ISU.CO_CD = RSL.CO_CD AND ISU.SALES_CD = RSL.SALES_CD AND ISU.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND AND ISU.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID AND ISU.WBS_RSLTS_NO = RSL.WBS_RSLTS_NO
	               WHERE ISU.WBS_RSLTS_NO IS NOT NULL  --실적이슈 
	                 AND ISU.CO_CD    = #{coCd}
	         		 AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = ISU.SALES_CD) 
			     )
			SELECT P.CO_CD              --회사코드
                  , S.CLNT_CD            --고객명
                  , S.CLNT_NM            --고객명

                  , S.CLNT_PJT           --고객사프로젝트
                  , S.CLNT_PJT_NM        --고객사프로젝트명
                  , j.SJ_NM              --과제명
                  , S.ORDRS_NO           --수주번호
                  , P.SALES_CD           --Sales Code
                  , P.VER_NO             --계획버젼
                  , P.WBS_PLAN_CODE_KIND --계획 LEVEL1
                  , P.WBS_PLAN_CODE_ID   --계획 LEVLE2
                  , CASE WHEN P.LVL = 1 THEN P.SALES_CD 
                         --WHEN P.LVL = 2 THEN P.WBS_PLAN_CODE_NM
                         --WHEN P.LVL = 3 THEN P.WBS_PLAN_CODE_NM
                         --WHEN P.LVL = 4 THEN P.WBS_PLAN_CODE_NM 
                         ELSE                P.WBS_PLAN_CODE_NM END WBS_PLAN_CODE_NM    
                  , P.WBS_MNG_NM         --담당자명
 
                  , TO_CHAR(P.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT
                  , TO_CHAR(P.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT

                  , CASE WHEN P.P_PLAN_NO IS NULL THEN 'N' ELSE 'Y' END AS PLAN_YN
                  , CASE WHEN P.P_RSLTS_NO IS NULL THEN 'N' ELSE 'Y' END AS RSLTS_YN

                  , I.GUBUN              --계획실적구분
                  , I.ISS_STS_NM          --이슈상태명
                  , I.ISS_SJ              --이슈제목
                  , I.ISS_DIV_NM          --이슈유형명
                  , I.ISS_CNTS            --이슈내용


                  , (SELECT FN_CM06M01_ID_TO_NM(I.ACT_ID) FROM DUAL) AS ACT_NM
                  , I.ACTS_DT             --조취시작일
                  , I.ACTE_DT             --조취종료일
                  , I.REQ_NO              --발주요청번호
                  , I.ACT_MH              --조취공수
                  , I.ACT_AMT             --조취비용
                  , I.ACT_CNTS            --조취내용

                  
                  , I.WBS_RSLTSS_DT       --실적시작일
                  , I.WBS_RSLTSE_DT       --실적종료일
                  , I.ISS_DIV             --이슈유형
                  , I.ACT_ID              --조취자ID
                  , I.ISS_STS             --이슈상태
                  , I.ISS_NO              --이슈제목
                  , I.WBS_PLAN_NO         --WBS계획 번호
                  , I.WBS_RSLTS_NO        --WBS실적 번호
                  , P.P_PLAN_NO
                  , P.P_RSLTS_NO                 
                  , P.UPPER_CD   AS PID          --상위코드 
                  , P.LOWER_CD   AS ID         --하위코드
                  , P.LVL              --코드LEVLE
                  , I.FILE_TRGT_KEY    AS ISS_FILE_TRGT_KEY    --이슈FILE_TRGT_KEY
                  , I.FILE_TRGT_TYP    AS ISS_FILE_TRGT_TYP    --이슈FILE_TRGT_TYP
                  , P.PATH                --코드PATH
			  FROM PLN AS P
			       INNER      JOIN SJD  AS S ON P.CO_CD = S.CO_CD AND P.SALES_CD = S.SALES_CD--수주상세   
			       INNER      JOIN SUBJ AS J ON P.CO_CD = J.CO_CD AND P.SALES_CD = J.SALES_CD--과제정보 
			       LEFT OUTER JOIN ISU  AS I ON P.CO_CD = I.CO_CD AND P.SALES_CD = I.SALES_CD AND P.WBS_PLAN_CODE_KIND = I.WBS_PLAN_CODE_KIND AND P.WBS_PLAN_CODE_ID = I.WBS_PLAN_CODE_ID--이슈정보 
			 WHERE 1=1 
			 <if test="issSts != null and !issSts.equals('')">
                    AND I.ISS_STS = #{issSts}            
             </if>
            <if test="clntPjt != null and !clntPjt.equals('')">
                    AND S.CLNT_PJT = #{clntPjt}            
            </if>
            <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
                    AND S.CLNT_NM LIKE '%' || #{ordrsClntNm} || '%'            
            </if>
			 ORDER BY S.CLNT_CD, S.ORDRS_NO, P.SALES_CD, P.PATH, I.GUBUN		        

     </select>
		  
		  
		  
	

     <select id="selectWbsIssueListDashboard" parameterType="Map" resultType="camelMap">
			WITH ISU AS --이슈정보
			     (
			      SELECT *
			        FROM (
			              SELECT  2  AS SORT_SEQ 
			                    , '계획'  AS GUBUN 
			                    , ISU.CO_CD                                   --회사코드
			                    , ISU.SALES_CD                                --SALES Code 
			                    , ISU.WBS_PLAN_CODE_KIND                      --WBS계획 LVL1
			                    , ISU.WBS_PLAN_CODE_ID                        --WBS계획 LVL2
			                    , ISU.WBS_PLAN_NO                             --WBS계획 번호
			                    , ISU.WBS_RSLTS_NO                            --WBS실적 번호
			                    , ISU.ISS_NO                                  --이슈번호
			                    , ISU.ISS_SJ                                  --이슈제목
			                    , ISU.ISS_DIV                                 --이슈유형
			                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
			                    , ISU.ISS_CNTS                                --이슈내용
			                    , ISU.ISS_STS                                 --이슈상태
			                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
			                    , ISU.ACT_ID                                  --조치담당자
			                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT--조치 시작일
			                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT--조치 종료일
			                    , ACT.ACT_MH                                  --조치 투입공수
			                    , ACT.ACT_AMT                                 --조치 투입비용  
			                    , ACT.ACT_CNTS                                --조치내용
			                    , ISU.FILE_TRGT_KEY                           --이슈 FILE_TRGT_KEY
			                    , ''  WBS_RSLTSS_DT                           --실적시작일
			                    , ''  WBS_RSLTSE_DT                           --실적종료일
			                    , ACT.REQ_NO                                  --발주요청번호
			                    , NVL2(ISU.UDT_DTTM, ISU.UDT_DTTM, ISU.CREAT_DTTM) AS CREAT_DTTM       --등록/수정일자 
			                    , NVL2(ISU.UDT_ID, ISU.UDT_ID, ISU.CREAT_ID) AS CREAT_ID       --등록/수정담당자
			                FROM TB_WB24M02 AS ISU --계획이슈 정보
			                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --계획이슈 조치내용
			               WHERE ISU.WBS_PLAN_NO IS NOT NULL --계획이슈 
			                 AND ISU.CO_CD    = #{coCd}

			              UNION ALL
			              SELECT 2  AS SORT_SEQ 
			                    , '실적'  AS GUBUN 
			                    , ISU.CO_CD                                               --회사코드
			                    , ISU.SALES_CD                                            --SALES Code 
			                    , ISU.WBS_PLAN_CODE_KIND                                  --WBS계획 LVL1
			                    , ISU.WBS_PLAN_CODE_ID                                    --WBS계획 LVL2
			                    , ISU.WBS_PLAN_NO                                         --WBS계획 번호
			                    , ISU.WBS_RSLTS_NO                                        --WBS실적 번호
			                    , ISU.ISS_NO                                              --이슈번호
			                    , ISU.ISS_SJ                                              --이슈제목
			                    , ISU.ISS_DIV                                             --이슈유형
			                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
			                    , ISU.ISS_CNTS                                            --이슈내용
			                    , ISU.ISS_STS                                             --이슈상태
			                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
			                    , ISU.ACT_ID                                              --조치담당자
			                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD')  AS ACTS_DT           --조치 시작일
			                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD')  AS ACTE_DT           --조치 종료일
			                    , ACT.ACT_MH                                              --조치 투입공수
			                    , ACT.ACT_AMT                                             --조치 투입비용  
			                    , ACT.ACT_CNTS                                            --조치내용
			                    , ISU.FILE_TRGT_KEY                                       --이슈 FILE_TRGT_KEY
			                    , TO_CHAR(RSL.WBS_RSLTSS_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT--실적시작일
			                    , TO_CHAR(RSL.WBS_RSLTSE_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT--실적종료일
			                    , ACT.REQ_NO                                  --발주요청번호
			                    , NVL2(ISU.UDT_DTTM, ISU.UDT_DTTM, ISU.CREAT_DTTM) AS CREAT_DTTM       --등록/수정일자 
			                    , NVL2(ISU.UDT_ID, ISU.UDT_ID, ISU.CREAT_ID) AS CREAT_ID       --등록/수정담당자
			                FROM TB_WB24M02  AS ISU --WBS이슈 정보
			                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --실적이슈 조치내용
			                      LEFT OUTER JOIN TB_WB23M01 AS RSL ON ISU.CO_CD = RSL.CO_CD AND ISU.SALES_CD = RSL.SALES_CD AND ISU.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND AND ISU.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID AND ISU.WBS_RSLTS_NO = RSL.WBS_RSLTS_NO
			               WHERE ISU.WBS_RSLTS_NO IS NOT NULL  --실적이슈 
			                 AND ISU.CO_CD    = #{coCd}
			                 
						--작업일보에서 등록된 이슈 내용 확인 (최근 1개월이내 자료)
			              UNION ALL
							SELECT  1  AS SORT_SEQ 
				                 , '일보'  AS GUBUN 
					             , T.CO_CD
					             , T.SALES_CD                                            	--SALES Code 
					             , T.WORK_RPT_M
					             , T.WORK_RPT_S	
					             , T.WORK_RPT_NO                                            --WBS계획 번호
					             , T.WORK_RPT_NO                                            --WBS실적 번호
				                 , T.WORK_RPT_NO                                   			--이슈번호
				                 , T.ISSUE_TITLE                                   			--이슈제목
				                 , '' AS ISS_DIV                                     		--이슈유형
				                 , '작업일보' AS ISS_DIV_NM
					             , T.WORK_RPT_RMK                                           --이슈내용
				                 , 'ISSSTS01'                                             	--이슈상태
				                 , '일보' AS ISS_STS_NM
					             , T.WORK_RPT_ID     ACT_ID                                 --조치담당자
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD')   AS ACTS_DT         --조치 시작일
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD')   AS ACTE_DT         --조치 종료일
				                 , T.WORK_RPT_HOUR                                          --조치 투입공수
				                 , ''                                             --조치 투입비용  
				                 , ''                                           			--조치내용
				                 , T.FILE_TRGT_KEY                                       	--이슈 FILE_TRGT_KEY
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT		--실적시작일
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT		--실적종료일
				                 , ''  AS REQ_NO                          					--발주요청번호
				                 , NVL2(T.UDT_DTTM, T.UDT_DTTM, T.CREAT_DTTM) AS CREAT_DTTM --등록/수정일자 
				                 , NVL2(T.UDT_ID, T.UDT_ID, T.CREAT_ID) AS CREAT_ID       	--등록/수정담당자	
					        FROM   TB_PM01M01 AS T
					        WHERE  T.ISSUE_YN = 'Y'
					        AND    T.WORK_RPT_DT <![CDATA[>=]]> ADD_MONTHS(SYSDATE, -1) --TRUNC(SYSDATE, 'MM')
					        
						--프로젝트에 등록된 이슈 내용 확인 (최근 1개월이내 자료)
			              UNION ALL
							SELECT  0  AS SORT_SEQ 
				                 , '프로젝트'  AS GUBUN 
					             , T.CO_CD
					             , T.YYYYMM || ' ' || T.DATA_SEARCH  AS SALES_CD      	--SALES Code 
					             , '프로젝트관리' 												--작업단계
					             , BD.PRJCT_SEQ	
					             , BD.PRJCT_SEQ                                            --WBS계획 번호
					             , BD.PRJCT_SEQ                                            --WBS실적 번호
				                 , BD.ISS_NO                                   				--이슈번호
				                 , NVL2(T.WINBD_RMK,T.WINBD_RMK,T.PRJCT_NM)         		--이슈제목
				                 , '' AS ISS_DIV                                     		--이슈유형
				                 , '프로젝트' AS ISS_DIV_NM
					             , BD.ISS_CNTS                                           	--이슈내용
				                 , BD.ISS_STS
								 , FN_CM05M01_CD_TO_NM(BD.ISS_STS) AS ISS_STS_NM
					             ,  NVL2(BD.UDT_ID, BD.UDT_ID, BD.CREAT_ID) AS ACT_ID                                 --조치담당자
				                 , TO_CHAR(BD.ISS_DT,'YYYY-MM-DD')   AS ACTS_DT         --조치 시작일
				                 , TO_CHAR(BD.ISS_DT,'YYYY-MM-DD')   AS ACTE_DT         --조치 종료일
				                 , ''                                          			--조치 투입공수
				                 , ''                                             		--조치 투입비용  
				                 , ''                                           			--조치내용
				                 , BD.PRJCT_SEQ                                       	    --이슈 FILE_TRGT_KEY
				                 , TO_CHAR(BD.CREAT_DTTM,'YYYY-MM-DD') AS WBS_RSLTSS_DT		--실적시작일
				                 , TO_CHAR(BD.CREAT_DTTM,'YYYY-MM-DD') AS WBS_RSLTSE_DT		--실적종료일
				                 , ''  AS REQ_NO                          					--발주요청번호
				                 , NVL2(BD.UDT_DTTM, BD.UDT_DTTM, BD.CREAT_DTTM) AS CREAT_DTTM --등록/수정일자 
				                 , NVL2(BD.UDT_ID, BD.UDT_ID, BD.CREAT_ID) AS CREAT_ID       	--등록/수정담당자	
						  FROM TB_BM06D03 BD
							             LEFT OUTER JOIN TB_BM06M01 T ON T.PRJCT_SEQ = BD.PRJCT_SEQ
				         WHERE 1=1
						   AND T.CO_CD = #{coCd}
						   AND BD.ISS_DT <![CDATA[>=]]> ADD_MONTHS(SYSDATE, -1)
			             ) 
			     WHERE 1=1
			     )
			SELECT ISU.*
				,(SELECT FN_CM06M01_ID_TO_NM(ISU.CREAT_ID) FROM DUAL) AS CREAT_ID_NM
				,(SELECT FN_CM06M01_ID_TO_NM(NVL2(ISU.ACT_ID,ISU.ACT_ID,ISU.CREAT_ID)) FROM DUAL) AS ACT_ID_NM
				,(SELECT FN_CM05M01_CD_TO_NM(ISU.WBS_PLAN_CODE_KIND) FROM DUAL) AS CODE_ID_NM
			  FROM ISU
			  WHERE 1 = 1
			    AND ISS_STS != 'ISSSTS03'  --상태코드 완료가 아닌것
			  ORDER BY CO_CD, SORT_SEQ, CREAT_DTTM, SALES_CD, WBS_PLAN_CODE_ID, ISS_NO
     </select>
		  
		  
		  <select id="selectMaxWbsIssueNo" parameterType="Map"  resultType="camelMap">
              SELECT  #{year} || trim(to_char(nvl(SUBSTR(MAX(ISS_NO), 6, 4),0) + 1, '0000')) AS ISS_NO FROM TB_WB24M02 
              WHERE CO_CD = #{coCd}   
          </select>
        
          <select id="selectWbsIssueSeqNext" parameterType="Map" resultType="int">
             SELECT TB_WB24M02_SQ01.NEXTVAL FROM DUAL
          </select>
        
          <insert id="wbsIssueInsert" parameterType="Map">
                INSERT INTO TB_WB24M02
                (
                    FILE_TRGT_KEY,
				    CO_CD,
				    WBS_PLAN_CODE_KIND,
				    WBS_PLAN_CODE_ID,
				    ISS_NO,
				    ISS_SJ,
				    ISS_DIV,
				    ISS_CNTS,
				    ISS_STS,
				    ACT_ID,
				    WBS_PLAN_NO,
				    WBS_RSLTS_NO,
				    SALES_CD,
				    CREAT_ID,
				    CREAT_PGM,
				    CREAT_DTTM
                ) 
                VALUES
                (
                    #{issFileTrgtKey},
                    #{coCd},
                    #{wbsPlanCodeKind},
                    #{wbsPlanCodeId},
                    #{issNo},
                    #{issSj},
                    #{issDiv},
                    #{issCnts},
                    #{issSts},
                    #{actId},
                    #{wbsPlanNo},
                    #{wbsRsltsNo},
                    #{salesCd},
                    #{userId},
                    #{pgmId},
                    SYSDATE
                )
            </insert>
            
            <insert id="wbsActInsert" parameterType="Map">
                <selectKey keyProperty="fileTrgtKey" resultType="Int" order="BEFORE">
                    SELECT NVL(MAX(TO_NUMBER(NVL(FILE_TRGT_KEY,'0'))),0) + 1 FROM TB_WB24M03
                </selectKey>
                INSERT INTO TB_WB24M03
                (
                    FILE_TRGT_KEY,
                    ISS_NO,
                    ACTS_DT,
                    ACTE_DT,
                    ACT_MH,
                    ACT_AMT,
                    ACT_CNTS,
                    REQ_NO,
                    ACT_AMT_STS,
                    ACT_DNG,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{issNo},
                    #{actsDt},
                    #{acteDt},
                    #{actMh},
                    #{actAmt, jdbcType=VARCHAR},
                    #{actCnts},
                    #{reqNo, jdbcType=VARCHAR},
                    #{actAmtSts},
                    #{actDng},
                    #{userId},
                    #{pgmId},
                    SYSDATE
                )
            </insert>
            
            
            <select id="actChk" parameterType="Map" resultType="camelMap">
               SELECT *  FROM TB_WB24M03
                   WHERE ISS_NO  = #{issNo}
            </select>   
  
  
            
            <update id="wbsIssueUpdate" parameterType="Map">
                UPDATE TB_WB24M02
	                    SET ISS_SJ 		= #{issSj},
	                        ISS_DIV 	= #{issDiv},
		                    ISS_CNTS 	= #{issCnts},
		                    ISS_STS 	= #{issSts},
		                    ACT_ID 		= #{actId},
		                    UDT_ID 		= #{userId},
	                        UDT_PGM 	= #{pgmId},
	                        UDT_DTTM 	= SYSDATE     
                    WHERE FILE_TRGT_KEY =  #{issFileTrgtKey}   
            </update>   
         
         
           <update id="wbsActUpdate" parameterType="Map">
                UPDATE TB_WB24M03
                        SET ACTS_DT 	= #{actsDt},
                            ACTE_DT 	= #{acteDt},
                            ACT_MH 		= #{actMh},
                            ACT_AMT 	= #{actAmt, jdbcType=VARCHAR},
                            ACT_CNTS 	= #{actCnts},
                            REQ_NO 		= #{reqNo, jdbcType=VARCHAR},
                            ACT_AMT_STS = #{actAmtSts},
                            ACT_DNG 	= #{actDng},
                            UDT_ID 		= #{userId},
                            UDT_PGM 	= #{pgmId},
                            UDT_DTTM 	= SYSDATE     
                    WHERE ISS_NO =  #{issNo}   
            </update>    
            
            <select id="selectTodoRsltsView" parameterType="Map" resultType="camelMap">          
                SELECT  X.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
			            X.CO_CD,
			            X.WBS_PLAN_CODE_KIND,
			            X.WBS_PLAN_CODE_ID,
			            P1.WBS_PLAN_CODE_NM,
			            X.ISS_SJ,
			            X.ISS_NO,
                        (SELECT FN_CM06M01_ID_TO_NM(X.CREAT_ID) FROM DUAL) AS CREAT_ID_NM,
			            X.ISS_DIV,
			            (SELECT FN_CM05M01_CD_TO_NM(X.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
			            X.ISS_CNTS,
			            X.ISS_STS,
			            (SELECT FN_CM05M01_CD_TO_NM(X.ISS_STS) FROM DUAL) AS ISS_STS_NM,
			            X.ACT_ID,
			            (SELECT FN_CM06M01_ID_TO_NM(X.ACT_ID) FROM DUAL) AS ACT_NM,
			            TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
			            TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
			            A.ACT_MH,
			            A.ACT_AMT,
			            A.ACT_CNTS,
			            A.REQ_NO,
			            X.SALES_CD,
			            Y.WBS_RSLTS_NO,
			            Y.WBS_RSLTS_ID,
			            (SELECT FN_CM06M01_ID_TO_NM(Y.WBS_RSLTS_ID) FROM DUAL) AS WBS_RSLTS_NM,
			            TO_CHAR(Y.WBS_RSLTSS_DT, 'YYYY-MM-DD') AS WBS_RSLTSS_DT,
			            TO_CHAR(Y.WBS_RSLTSE_DT, 'YYYY-MM-DD') AS WBS_RSLTSE_DT,

			            (SELECT FN_CM06M01_ID_TO_NM(P.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_PLAN_MNG_NM,
                        TO_CHAR(P.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT,
                        TO_CHAR(P.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT,
                        M.SJ_NO, 
                        M.SJ_NM, 
                        M.VER_NO, 
                        M.SALES_CD  AS W21_SALES_CD,
                        CM.ORDRS_CLNT_CD, 
                        B.CLNT_NM,	--고객사명
                        (SELECT FN_CM05M01_CD_TO_NM(CM.CLNT_PJT) FROM DUAL) AS CLNT_PJT_NM				--고객사프로젝트
            FROM TB_WB24M02 X
            LEFT OUTER JOIN TB_WB23M01 Y
								            ON X.CO_CD = Y.CO_CD
								            AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND 
								            AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
								            AND X.SALES_CD = Y.SALES_CD
								            AND X.WBS_RSLTS_NO = Y.WBS_RSLTS_NO
            LEFT OUTER JOIN TB_WB22M01 P
					                        ON X.CO_CD = P.CO_CD
					                        AND X.WBS_PLAN_CODE_KIND = P.WBS_PLAN_CODE_KIND 
					                        AND X.WBS_PLAN_CODE_ID = P.WBS_PLAN_CODE_ID
					                        AND X.SALES_CD = P.SALES_CD
					                        AND X.WBS_PLAN_NO = P.WBS_PLAN_NO
            LEFT OUTER JOIN TB_WB22M01 P1
					                        ON X.CO_CD = P1.CO_CD
					                        AND X.WBS_PLAN_CODE_KIND = P1.WBS_PLAN_CODE_KIND 
					                        AND X.WBS_PLAN_CODE_ID = P1.WBS_PLAN_CODE_ID
					                        AND X.SALES_CD = P1.SALES_CD
            LEFT OUTER JOIN TB_WB24M03 A
            								ON X.ISS_NO = A.ISS_NO 
            LEFT OUTER JOIN TB_WB21M01 M
					                        ON X.CO_CD = M.CO_CD
					                        AND X.SALES_CD = M.SALES_CD
					                        AND M.VER_NO IN (SELECT MAX(TO_NUMBER(VER_NO)) FROM TB_WB21M01 CC WHERE CC.SALES_CD = X.SALES_CD)
            LEFT OUTER JOIN TB_CR02D02 C
            								ON C.SALES_CD = X.SALES_CD 
            LEFT OUTER JOIN TB_CR02M01 CM
					                        ON C.CO_CD = CM.CO_CD
					                        AND C.ORDRS_NO = CM.ORDRS_NO
            LEFT OUTER JOIN TB_BM02M01 B
            								ON B.CLNT_CD = CM.ORDRS_CLNT_CD 
			WHERE X.FILE_TRGT_KEY = #{fileTrgtKey}
          </select>
          
          <select id="selectRsltsMemberList" parameterType="Map" resultType="camelMap">
               
                SELECT X.CO_CD,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS WBS_PLANCO_CD_NM,                      
                      X.ID AS USR_NM,
                      X.EMP_NO,
                      X.NAME,
                      X.TEL_NO,
                      D.LEVEL_NM AS JIK ,
                      TO_CHAR(SYSDATE, 'YYYY-MM-DD') AS REQ_DATE                     
                      FROM TB_CM06M01 X  
                      INNER JOIN TB_CM04M01 C ON(X.DEPT_ID=C.DEPT_ID) 
                      INNER JOIN TB_CM07M01 D ON(X.LEVEL_CD=D.LEVEL_CD) 
                      WHERE 1 = 1
                      AND X.ID = '${userId}' 
          </select>
          
          <select id="selectMemberTelNo" parameterType="Map" resultType="camelMap">
                SELECT TEL_NO                    
                      FROM TB_CM06M01  
                      WHERE ID = #{userId} 
          </select>

    <select id="select_wb2401p01_Info" parameterType="Map" resultType="camelMap">
        SELECT A.WBS_PLAN_NO
             , A.WBS_RSLTS_NO
             , A.WBS_PLAN_CODE_ID
             , TO_CHAR(NVL(P.WBS_PLANS_DT,R.WBS_RSLTSS_DT),'YYYY-MM-DD') AS WBS_PLANS_DT
             , TO_CHAR(NVL(P.WBS_PLANE_DT,R.WBS_RSLTSE_DT),'YYYY-MM-DD') AS WBS_PLANE_DT
             , TO_CHAR(NVL(R.WBS_RSLTSS_DT,P.WBS_PLANS_DT),'YYYY-MM-DD') AS WBS_RSLTSS_DT 
             , TO_CHAR(NVL(R.WBS_RSLTSE_DT,P.WBS_PLANE_DT),'YYYY-MM-DD') AS WBS_RSLTSE_DT
             , A.ISS_DIV
             , R3.CODE_NM AS ISS_DIV_NM
             , A.ISS_STS
             , R4.CODE_NM AS ISS_STS_NM
             , A.ISS_SJ
             , A.ISS_CNTS
             , NVL2(A.ACT_ID,A.ACT_ID,A.CREAT_ID) AS ACT_ID
             , (SELECT FN_CM06M01_ID_TO_NM(NVL2(A.ACT_ID,A.ACT_ID,A.CREAT_ID)) FROM DUAL) AS ACT_NM
             --, U.NAME AS ACT_NM
             , TO_CHAR(S.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT
             , TO_CHAR(S.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT
             , NVL(S.ACT_MH, 0)  AS ACT_MH
             , NVL(S.ACT_AMT, 0) AS ACT_AMT
             , S.REQ_NO
             , S.ACT_CNTS
             , R1.CODE_NM AS WBS_PLAN_CODE_KIND_NM
             , NVL(R2.CODE_NM, R1.CODE_NM) AS WBS_PLAN_CODE_NM
             , A.ISS_NO
             , A.FILE_TRGT_KEY
             , A.FILE_TRGT_KEY  AS ISS_FILE_TRGT_KEY
             , A.SALES_CD
             , A.CO_CD
             , A.WBS_PLAN_CODE_KIND
             , A.WBS_PLAN_CODE_ID
             , A.SALES_CD
             , A.CO_CD
             , A.CREAT_ID
             , A.CREAT_PGM
             , A.CREAT_DTTM
             , A.UDT_ID
             , A.UDT_PGM
             , A.UDT_DTTM
             , (
                SELECT COUNT(*)
                FROM   TB_WB20M03
                WHERE  1 = 1
                AND    TODO_FILE_TRGT_KEY = #{fileTrgtKey}
                AND    TODO_DIV2_CODE_ID = 'TODODIV2060'
                AND    TODO_CF_DT IS NOT NULL
               ) AS APP_CNT
             , (
                SELECT COUNT(*)
                FROM   TB_WB20M03
                WHERE  1 = 1
                AND    TODO_FILE_TRGT_KEY = #{fileTrgtKey}
                AND    TODO_DIV2_CODE_ID = 'TODODIV2090'
                AND    TODO_CF_DT IS NOT NULL
               ) AS ACT_APP_CNT
        FROM   TB_WB24M02 AS A
               LEFT OUTER JOIN TB_WB22M01 AS P  ON P.CO_CD       = A.CO_CD
                                               AND P.WBS_PLAN_NO = A.WBS_PLAN_NO
                                               AND P.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_WB23M01 AS R  ON R.CO_CD       = A.CO_CD
                                               AND R.WBS_RSLTS_NO = A.WBS_RSLTS_NO
                                               AND R.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_WB24M03 AS S  ON S.ISS_NO = A.ISS_NO
               LEFT OUTER JOIN TB_CM06M01 AS U  ON U.ID = A.ACT_ID
               LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = A.WBS_PLAN_CODE_KIND
               LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = A.ISS_DIV
               LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = A.ISS_STS   
        WHERE  1 = 1
        AND    A.FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

	<delete id="wbsIssueDelete" parameterType="Map">
               DELETE FROM TB_WB24M02
                   WHERE ISS_NO  = #{issNo}
	</delete>
	

	<delete id="wbsIssueResultDelete" parameterType="Map">
               DELETE FROM TB_WB24M03
                   WHERE ISS_NO  = #{issNo}
	</delete>
	
</mapper>
