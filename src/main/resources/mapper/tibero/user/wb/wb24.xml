<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb24.mapper.WB24Mapper">

     <select id="selectWbsIssueListCount" parameterType="Map" resultType="int">
			WITH TRG AS
				(
						SELECT DISTINCT W.SALES_CD
			            			  , M.ORDRS_NO  AS ORDRS_NO     --수주번호
					                  , M.ORDRS_CLNT_CD  AS CLNT_CD            --고객명
					                  , C.CLNT_NM AS CLNT_NM            --고객명
					                  , M.CLNT_PJT AS CLNT_PJT           --고객사프로젝트
					                  , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL) AS CLNT_PJT_NM        --고객사프로젝트명
				           FROM TB_WB22M01 W --WBS계획 정보
			              		INNER JOIN TB_CR02D02      AS X ON X.CO_CD = W.CO_CD AND X.SALES_CD = W.SALES_CD--수주상세
			        			INNER JOIN TB_CR02M01      AS M ON M.ORDRS_NO = X.ORDRS_NO --수주마스터
			              		LEFT OUTER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
				          WHERE W.CO_CD    = 'GUN'
				            AND W.WBS_PLAN_CODE_KIND = 'WBSCODE' --LEVEL2
					    <choose>
					        <when test="salesCd != null and !salesCd.equals('')">
					         AND W.SALES_CD like '%'||#{salesCd}||'%'
					        </when>
					        <otherwise>
					         AND W.WBS_PLANS_DT BETWEEN #{wbsRsltssDt} AND #{wbsRsltseDt}
					        </otherwise>
					    </choose>
				)
				, PLN AS --계획정보 TREE
			     (
			      SELECT A.*
			           , LEVEL AS LVL
			           , REGEXP_REPLACE(SYS_CONNECT_BY_PATH(A.LOWER_CD, ' -> '), '^\s+\-\>\s+', '') AS PATH --출고경로
			        FROM (
			              SELECT DISTINCT
			                    'top'    AS UPPER_CD
			                    , W.SALES_CD AS LOWER_CD
			                    , W.CO_CD
			                    , W.SALES_CD
			                    , W.VER_NO
			                    , ''       AS WBS_PLAN_CODE_KIND
			                    , ''       AS WBS_PLAN_CODE_ID
			                    , ''       AS WBS_PLAN_CODE_NM
			                    , ''       AS WBS_PLANS_DT
			                    , ''       AS WBS_PLANE_DT
			                    , ''       AS WBS_MNG_NM
			                    , ''       AS P_PLAN_NO
			                    , ''       AS P_RSLTS_NO
			                    , ''       AS P_PLAN_TRGT_KEY
			                    , ''       AS P_RSLTS_TRGT_KEY
			                    , TRG.ORDRS_NO     --수주번호
			                    , TRG.CLNT_CD            --고객명
			                    , TRG.CLNT_NM            --고객명
			                    , TRG.CLNT_PJT           --고객사프로젝트
			                    , TRG.CLNT_PJT_NM        --
			                FROM TB_WB22M01 W --WBS계획 정보
			                		INNER JOIN TRG  ON TRG.SALES_CD = W.SALES_CD
			               WHERE 1  = 1
			                 AND W.CO_CD    = 'GUN'
			                 AND W.WBS_PLAN_CODE_KIND = 'WBSCODE'
			              UNION ALL
			              SELECT W.SALES_CD                    AS UPPER_CD
			                    , W.SALES_CD||W.WBS_PLAN_CODE_ID  AS LOWER_CD
			                    , W.CO_CD
			                    , W.SALES_CD
			                    , W.VER_NO
			                    , W.WBS_PLAN_CODE_KIND
			                    , W.WBS_PLAN_CODE_ID
			                    , (SELECT FN_CM05M01_CD_TO_NM(W.WBS_PLAN_CODE_ID) FROM DUAL) AS WBS_PLAN_CODE_NM
			                    , W.WBS_PLANS_DT
			                    , W.WBS_PLANE_DT
			                    , (SELECT FN_CM06M01_ID_TO_NM(W.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_MNG_NM
			                    , ''                                  AS P_PLAN_NO
			                    , ''                                  AS P_RSLTS_NO
			                    , ''                                  AS P_PLAN_TRGT_KEY
			                    , ''                                  AS P_RSLTS_TRGT_KEY
			                    , TRG.ORDRS_NO     --수주번호
			                    , TRG.CLNT_CD            --고객명
			                    , TRG.CLNT_NM            --고객명
			                    , TRG.CLNT_PJT           --고객사프로젝트
			                    , TRG.CLNT_PJT_NM        --
			                 FROM TB_WB22M01 W --WBS계획 정보
			                		INNER JOIN TRG  ON TRG.SALES_CD = W.SALES_CD
			                WHERE W.CO_CD    = 'GUN'
			                  AND W.WBS_PLAN_CODE_KIND = 'WBSCODE' --LEVEL1
			                  AND (W.SALES_CD, W.WBS_PLAN_CODE_ID) IN ( SELECT DISTINCT SALES_CD, WBS_PLAN_CODE_KIND --LEVEL2 없는 LEVEL1 제외
			                                                          FROM TB_WB22M01 --WBS계획 정보
			                                                         WHERE CO_CD    = #{coCd}
			                                                           AND WBS_PLAN_CODE_KIND != 'WBSCODE' --LEVEL2
			                  										   AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = TB_WB22M01.SALES_CD)
			                  									  )
			              UNION ALL
			              SELECT PLN.SALES_CD||PLN.WBS_PLAN_CODE_KIND AS UPPER_CD
			                    , PLN.WBS_PLAN_CODE_ID                 AS LOWER_CD
			                    , PLN.CO_CD
			                    , PLN.SALES_CD
			                    , PLN.VER_NO
			                    , PLN.WBS_PLAN_CODE_KIND
			                    , PLN.WBS_PLAN_CODE_ID
			                    , PLN.WBS_PLAN_CODE_NM
			                    , PLN.WBS_PLANS_DT
			                    , PLN.WBS_PLANE_DT
			                    , ''                                  AS WBS_MNG_NM
			                    , PLN.WBS_PLAN_NO                     AS P_PLAN_NO
			                    , RSL.WBS_RSLTS_NO                    AS P_RSLTS_NO
			                    , PLN.FILE_TRGT_KEY                   AS P_PLAN_TRGT_KEY
			                    , RSL.FILE_TRGT_KEY                   AS P_RSLTS_TRGT_KEY
			                    , TRG.ORDRS_NO     --수주번호
			                    , TRG.CLNT_CD            --고객명
			                    , TRG.CLNT_NM            --고객명
			                    , TRG.CLNT_PJT           --고객사프로젝트
			                    , TRG.CLNT_PJT_NM        --
			                 FROM TB_WB22M01 AS PLN--WBS계획 정보
			                		INNER JOIN TRG  ON TRG.SALES_CD = PLN.SALES_CD
			                        LEFT OUTER JOIN TB_WB23M01 AS RSL ON PLN.CO_CD = RSL.CO_CD
			                        								 AND PLN.SALES_CD = RSL.SALES_CD
			                        								 AND PLN.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND
			                        								 AND PLN.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID
			                WHERE PLN.CO_CD    = #{coCd}
			                  AND PLN.WBS_PLAN_CODE_KIND != 'WBSCODE' --LEVEL2
			             ) A
			       WHERE 1=1
			       START WITH UPPER_CD = 'top'
			       CONNECT BY PRIOR LOWER_CD = UPPER_CD
			       ORDER BY PATH
			     )
			   , SUBJ AS --과제정보
			     (
			      SELECT X.CO_CD      AS CO_CD    --회사코드
			            , X.SALES_CD   AS SALES_CD --SALES Code
			            , X.SJ_NO      AS SJ_NO    --과제번호
			            , X.SJ_NM      AS SJ_NM    --과제명
			            , X.VER_NO     AS VER_NO   --버젼
			        FROM TB_WB21M01 X
			       WHERE X.CO_CD    = #{coCd}
			         AND X.CLOSE_YN = 'Y'
			         AND X.VER_NO  = (SELECT MAX(VER_NO)
			         					FROM TB_WB21M01 Z
			         				   WHERE CO_CD = #{coCd}
			         				     AND SALES_CD like X.SALES_CD
			                         )
			         AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = X.SALES_CD)
			     )
			   , ISU AS --이슈정보
			     (
	              SELECT '계획'  AS GUBUN
	                    , ISU.CO_CD                                   --회사코드
	                    , ISU.SALES_CD                                --SALES Code
	                    , ISU.WBS_PLAN_CODE_KIND                      --WBS계획 LVL1
	                    , ISU.WBS_PLAN_CODE_ID                        --WBS계획 LVL2
	                    , ISU.WBS_PLAN_NO                             --WBS계획 번호
	                    , ISU.WBS_RSLTS_NO                            --WBS실적 번호
	                    , ISU.ISS_NO                                  --이슈번호
	                    , ISU.ISS_SJ                                  --이슈제목
	                    , ISU.ISS_DIV                                 --이슈유형
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
	                    , ISU.ISS_CNTS                                --이슈내용
	                    , ISU.ISS_STS                                 --이슈상태
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
	                    , ISU.ACT_ID                                  --조치담당자
	                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT--조치 시작일
	                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT--조치 종료일
	                    , ACT.ACT_MH                                  --조치 투입공수
	                    , ACT.ACT_AMT                                 --조치 투입비용
	                    , ACT.ACT_CNTS                                --조치내용
	                    , ISU.FILE_TRGT_KEY                           --이슈 FILE_TRGT_KEY
	                    , ISU.CREAT_PGM 						AS  FILE_TRGT_TYP   --생성프로그램
	                    , ''  WBS_RSLTSS_DT                           --실적시작일
	                    , ''  WBS_RSLTSE_DT                           --실적종료일
	                    , ISU.REQ_NO                                  --발주요청번호
	                    , ISU.SUB_CD                                  --등록사유
	                    , ISU.CREAT_ID                                --등록ID
	                FROM TB_WB24M02 AS ISU --계획이슈 정보
	                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --계획이슈 조치내용
	               WHERE ISU.WBS_PLAN_NO IS NOT NULL --계획이슈
	                 AND ISU.CO_CD    = #{coCd}
	         		 AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = ISU.SALES_CD)
	              UNION ALL
	              SELECT '실적'  AS GUBUN
	                    , ISU.CO_CD                                               --회사코드
	                    , ISU.SALES_CD                                            --SALES Code
	                    , ISU.WBS_PLAN_CODE_KIND                                  --WBS계획 LVL1
	                    , ISU.WBS_PLAN_CODE_ID                                    --WBS계획 LVL2
	                    , ISU.WBS_PLAN_NO                                         --WBS계획 번호
	                    , ISU.WBS_RSLTS_NO                                        --WBS실적 번호
	                    , ISU.ISS_NO                                              --이슈번호
	                    , ISU.ISS_SJ                                              --이슈제목
	                    , ISU.ISS_DIV                                             --이슈유형
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
	                    , ISU.ISS_CNTS                                            --이슈내용
	                    , ISU.ISS_STS                                             --이슈상태
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
	                    , ISU.ACT_ID                                              --조치담당자
	                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD')  AS ACTS_DT           --조치 시작일
	                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD')  AS ACTE_DT           --조치 종료일
	                    , ACT.ACT_MH                                              --조치 투입공수
	                    , ACT.ACT_AMT                                             --조치 투입비용
	                    , ACT.ACT_CNTS                                            --조치내용
	                    , ISU.FILE_TRGT_KEY                                       --이슈 FILE_TRGT_KEY
	                    , ISU.CREAT_PGM 						AS  FILE_TRGT_TYP   --생성프로그램
	                    , TO_CHAR(RSL.WBS_RSLTSS_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT--실적시작일
	                    , TO_CHAR(RSL.WBS_RSLTSE_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT--실적종료일
	                    , ISU.REQ_NO                                  --발주요청번호
	                    , ISU.SUB_CD                                  --등록사유
	                    , ISU.CREAT_ID                                --등록ID
	                FROM TB_WB24M02  AS ISU --WBS이슈 정보
	                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --실적이슈 조치내용
	                      LEFT OUTER JOIN TB_WB23M01 AS RSL ON ISU.CO_CD = RSL.CO_CD AND ISU.SALES_CD = RSL.SALES_CD AND ISU.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND AND ISU.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID AND ISU.WBS_RSLTS_NO = RSL.WBS_RSLTS_NO
	               WHERE ISU.WBS_RSLTS_NO IS NOT NULL  --실적이슈
	                 AND ISU.CO_CD    = #{coCd}
	         		 AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = ISU.SALES_CD)
			     )
			SELECT  count(*)
			  FROM PLN AS P
			 WHERE 1=1
            <if test="clntPjt != null and !clntPjt.equals('')">
                    AND P.CLNT_PJT = #{clntPjt}
            </if>
            <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
                    AND P.CLNT_NM LIKE '%' || #{ordrsClntNm} || '%'
            </if>
     </select>


     <select id="selectWbsIssueList" parameterType="Map" resultType="camelMap">
			WITH TRG AS
				(
						SELECT DISTINCT W.SALES_CD
			            			  , M.ORDRS_NO  AS ORDRS_NO     --수주번호
					                  , M.ORDRS_CLNT_CD  AS CLNT_CD            --고객명
					                  , C.CLNT_NM AS CLNT_NM            --고객명
					                  , M.CLNT_PJT AS CLNT_PJT           --고객사프로젝트
					                  , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL) AS CLNT_PJT_NM        --고객사프로젝트명
				           FROM TB_WB22M01 W --WBS계획 정보
			              		INNER JOIN TB_CR02D02      AS X ON X.CO_CD = W.CO_CD AND X.SALES_CD = W.SALES_CD--수주상세
			        			INNER JOIN TB_CR02M01      AS M ON M.ORDRS_NO = X.ORDRS_NO --수주마스터
			              		LEFT OUTER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
				          WHERE W.CO_CD    = 'GUN'
				            AND W.WBS_PLAN_CODE_KIND = 'WBSCODE' --LEVEL2
					    <choose>
					        <when test="salesCd != null and !salesCd.equals('')">
					         AND W.SALES_CD like '%'||#{salesCd}||'%'
					        </when>
					        <otherwise>
					         AND W.WBS_PLANS_DT BETWEEN #{wbsRsltssDt} AND #{wbsRsltseDt}
					        </otherwise>
					    </choose>
			            <if test="clntPjt != null and !clntPjt.equals('')">
			                 AND M.CLNT_PJT = #{clntPjt}
			            </if>
			            <if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
			                AND C.CLNT_NM LIKE '%' || #{ordrsClntNm} || '%'
			            </if>
				)
			   , ISU AS --이슈정보
			     (
	              SELECT '계획'  AS GUBUN
	                    , ISU.CO_CD                                   --회사코드
	                    , ISU.SALES_CD                                --SALES Code
	                    , ISU.WBS_PLAN_CODE_KIND                      --WBS계획 LVL1
	                    , ISU.WBS_PLAN_CODE_ID                        --WBS계획 LVL2
	                    , ISU.WBS_PLAN_NO                             --WBS계획 번호
	                    , ISU.WBS_RSLTS_NO                            --WBS실적 번호
	                    , ISU.ISS_NO                                  --이슈번호
	                    , ISU.ISS_SJ                                  --이슈제목
	                    , ISU.ISS_DIV                                 --이슈유형
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
	                    , ISU.ISS_CNTS                                --이슈내용
	                    , ISU.ISS_STS                                 --이슈상태
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
	                    , ISU.ACT_ID                                  --조치담당자
	                    , ACT.ACTS_DT           					  --조치 시작일
	                    , ACT.ACTE_DT           					  --조치 종료일
	                    , ACT.ACT_MH                                  --조치 투입공수
	                    , ACT.ACT_AMT                                 --조치 투입비용
	                    , ACT.ACT_CNTS                                --조치내용
	                    , ISU.FILE_TRGT_KEY                           --이슈 FILE_TRGT_KEY
	                    , ISU.CREAT_PGM 						AS  FILE_TRGT_TYP   --생성프로그램
	                    , ''  WBS_RSLTSS_DT                           --실적시작일
	                    , ''  WBS_RSLTSE_DT                           --실적종료일
	                    , ISU.REQ_NO                                  --발주요청번호
	                    , ISU.SUB_CD                                  --등록사유
	                    , ISU.CREAT_ID                                --등록ID
						, ISU.MC_PART_CD							  --기계분류
						, ISU.IMPORTANT_CD							  --영향도
						, ISU.IMPACT_CD							  	  --중요도
	                FROM TB_WB24M02 AS ISU --계획이슈 정보
	                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --계획이슈 조치내용
	               WHERE ISU.WBS_PLAN_NO IS NOT NULL --계획이슈
	                 AND ISU.CO_CD    = #{coCd}
					 <if test="issSts != null and !issSts.equals('')">
                     AND ISU.ISS_STS = #{issSts}
					 </if>
	         		 AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = ISU.SALES_CD)
	              UNION ALL
	              SELECT '실적'  AS GUBUN
	                    , ISU.CO_CD                                               --회사코드
	                    , ISU.SALES_CD                                            --SALES Code
	                    , ISU.WBS_PLAN_CODE_KIND                                  --WBS계획 LVL1
	                    , ISU.WBS_PLAN_CODE_ID                                    --WBS계획 LVL2
	                    , ISU.WBS_PLAN_NO                                         --WBS계획 번호
	                    , ISU.WBS_RSLTS_NO                                        --WBS실적 번호
	                    , ISU.ISS_NO                                              --이슈번호
	                    , ISU.ISS_SJ                                              --이슈제목
	                    , ISU.ISS_DIV                                             --이슈유형
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
	                    , ISU.ISS_CNTS                                            --이슈내용
	                    , ISU.ISS_STS                                             --이슈상태
	                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_STS) FROM DUAL) AS ISS_STS_NM
	                    , ISU.ACT_ID                                              --조치담당자
	                    , ACT.ACTS_DT           								  --조치 시작일
	                    , ACT.ACTE_DT           								  --조치 종료일
	                    , ACT.ACT_MH                                              --조치 투입공수
	                    , ACT.ACT_AMT                                             --조치 투입비용
	                    , ACT.ACT_CNTS                                            --조치내용
	                    , ISU.FILE_TRGT_KEY                                       --이슈 FILE_TRGT_KEY
	                    , ISU.CREAT_PGM 						AS  FILE_TRGT_TYP   --생성프로그램
	                    , TO_CHAR(RSL.WBS_RSLTSS_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT--실적시작일
	                    , TO_CHAR(RSL.WBS_RSLTSE_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT--실적종료일
	                    , ISU.REQ_NO                                  --발주요청번호
	                    , ISU.SUB_CD                                  --등록사유
	                    , ISU.CREAT_ID                                --등록ID
						, ISU.MC_PART_CD							  --기계분류
						, ISU.IMPORTANT_CD							  --영향도
						, ISU.IMPACT_CD							  	  --중요도
	                FROM TB_WB24M02  AS ISU --WBS이슈 정보
	                      LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --실적이슈 조치내용
	                      LEFT OUTER JOIN TB_WB23M01 AS RSL ON ISU.CO_CD = RSL.CO_CD AND ISU.SALES_CD = RSL.SALES_CD AND ISU.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND AND ISU.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID AND ISU.WBS_RSLTS_NO = RSL.WBS_RSLTS_NO
	               WHERE ISU.WBS_RSLTS_NO IS NOT NULL  --실적이슈
	                 AND ISU.CO_CD    = #{coCd}
					 <if test="issSts != null and !issSts.equals('')">
                     AND ISU.ISS_STS = #{issSts}
					 </if>
	         		 AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = ISU.SALES_CD)
			     )
				, PLN AS --계획정보 TREE
			     (
			SELECT * FROM (
				SELECT B.*
			           , ROWNUM AS RN
				FROM (
			      SELECT A.*
			           , LEVEL AS LVL
			           , REGEXP_REPLACE(SYS_CONNECT_BY_PATH(A.LOWER_CD, ' -> '), '^\s+\-\>\s+', '') AS PATH --출고경로
			        FROM (
			              SELECT DISTINCT
			                    'top'    AS UPPER_CD
			                    , W.SALES_CD AS LOWER_CD
			                    , W.CO_CD
			                    , W.SALES_CD
			                    , W.VER_NO
			                    , ''       AS WBS_PLAN_CODE_KIND
			                    , ''       AS WBS_PLAN_CODE_ID
			                    , ''       AS WBS_PLAN_CODE_NM
			                    , ''       AS WBS_PLANS_DT
			                    , ''       AS WBS_PLANE_DT
			                    , ''       AS WBS_MNG_NM
			                    , ''       AS P_PLAN_NO
			                    , ''       AS P_RSLTS_NO
			                    , ''       AS P_PLAN_TRGT_KEY
			                    , ''       AS P_RSLTS_TRGT_KEY
			                    , TRG.ORDRS_NO     --수주번호
			                    , TRG.CLNT_CD            --고객명
			                    , TRG.CLNT_NM            --고객명
			                    , TRG.CLNT_PJT           --고객사프로젝트
			                    , TRG.CLNT_PJT_NM        --
			                FROM TB_WB22M01 W --WBS계획 정보
			                		INNER JOIN TRG  ON TRG.SALES_CD = W.SALES_CD
			               WHERE 1  = 1
			                 AND W.CO_CD    = 'GUN'
			                 AND W.WBS_PLAN_CODE_KIND = 'WBSCODE'
			              UNION ALL
			              SELECT W.SALES_CD                    AS UPPER_CD
			                    , W.SALES_CD||W.WBS_PLAN_CODE_ID  AS LOWER_CD
			                    , W.CO_CD
			                    , W.SALES_CD
			                    , W.VER_NO
			                    , W.WBS_PLAN_CODE_KIND
			                    , W.WBS_PLAN_CODE_ID
			                    , (SELECT FN_CM05M01_CD_TO_NM(W.WBS_PLAN_CODE_ID) FROM DUAL) AS WBS_PLAN_CODE_NM
			                    , W.WBS_PLANS_DT
			                    , W.WBS_PLANE_DT
			                    , (SELECT FN_CM06M01_ID_TO_NM(W.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_MNG_NM
			                    , ''                                  AS P_PLAN_NO
			                    , ''                                  AS P_RSLTS_NO
			                    , ''                                  AS P_PLAN_TRGT_KEY
			                    , ''                                  AS P_RSLTS_TRGT_KEY
			                    , TRG.ORDRS_NO     --수주번호
			                    , TRG.CLNT_CD            --고객명
			                    , TRG.CLNT_NM            --고객명
			                    , TRG.CLNT_PJT           --고객사프로젝트
			                    , TRG.CLNT_PJT_NM        --
			                 FROM TB_WB22M01 W --WBS계획 정보
			                		INNER JOIN TRG  ON TRG.SALES_CD = W.SALES_CD
			                WHERE W.CO_CD    = 'GUN'
			                  AND W.WBS_PLAN_CODE_KIND = 'WBSCODE' --LEVEL1
			                  AND (W.SALES_CD, W.WBS_PLAN_CODE_ID) IN ( SELECT DISTINCT SALES_CD, WBS_PLAN_CODE_KIND --LEVEL2 없는 LEVEL1 제외
			                                                          FROM TB_WB22M01 --WBS계획 정보
			                                                         WHERE CO_CD    = #{coCd}
			                                                           AND WBS_PLAN_CODE_KIND != 'WBSCODE' --LEVEL2
			                  										   AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = TB_WB22M01.SALES_CD)
			                  									  )
			              UNION ALL
			              SELECT PLN.SALES_CD||PLN.WBS_PLAN_CODE_KIND AS UPPER_CD
			                    , PLN.WBS_PLAN_CODE_ID                 AS LOWER_CD
			                    , PLN.CO_CD
			                    , PLN.SALES_CD
			                    , PLN.VER_NO
			                    , PLN.WBS_PLAN_CODE_KIND
			                    , PLN.WBS_PLAN_CODE_ID
			                    , PLN.WBS_PLAN_CODE_NM
			                    , PLN.WBS_PLANS_DT
			                    , PLN.WBS_PLANE_DT
			                    , ''                                  AS WBS_MNG_NM
			                    , PLN.WBS_PLAN_NO                     AS P_PLAN_NO
			                    , RSL.WBS_RSLTS_NO                    AS P_RSLTS_NO
			                    , PLN.FILE_TRGT_KEY                   AS P_PLAN_TRGT_KEY
			                    , RSL.FILE_TRGT_KEY                   AS P_RSLTS_TRGT_KEY
			                    , TRG.ORDRS_NO     --수주번호
			                    , TRG.CLNT_CD            --고객명
			                    , TRG.CLNT_NM            --고객명
			                    , TRG.CLNT_PJT           --고객사프로젝트
			                    , TRG.CLNT_PJT_NM        --
			                 FROM TB_WB22M01 AS PLN--WBS계획 정보
			                		INNER JOIN TRG  ON TRG.SALES_CD = PLN.SALES_CD
			                        LEFT OUTER JOIN TB_WB23M01 AS RSL ON PLN.CO_CD = RSL.CO_CD
			                        								 AND PLN.SALES_CD = RSL.SALES_CD
			                        								 AND PLN.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND
			                        								 AND PLN.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID
			                WHERE PLN.CO_CD    = #{coCd}
			                  AND PLN.WBS_PLAN_CODE_KIND != 'WBSCODE' --LEVEL2
			             ) A
			       WHERE 1=1
			       START WITH UPPER_CD = 'top'
			       CONNECT BY PRIOR LOWER_CD = UPPER_CD
			       ORDER BY PATH
			       ) B
			    ) T
				WHERE    RN BETWEEN ${firstIndex} AND ${lastIndex}
			    )
			   , SUBJ AS --과제정보
			     (
			      SELECT X.CO_CD      AS CO_CD    --회사코드
			            , X.SALES_CD   AS SALES_CD --SALES Code
			            , X.SJ_NO      AS SJ_NO    --과제번호
			            , X.SJ_NM      AS SJ_NM    --과제명
			            , X.VER_NO     AS VER_NO   --버젼
			        FROM TB_WB21M01 X
			       WHERE X.CO_CD    = #{coCd}
			         AND X.CLOSE_YN = 'Y'
			         AND X.VER_NO  = (SELECT MAX(VER_NO)
			         					FROM TB_WB21M01 Z
			         				   WHERE CO_CD = #{coCd}
			         				     AND SALES_CD like X.SALES_CD
			                         )
			         AND EXISTS (SELECT 1 FROM TRG WHERE TRG.SALES_CD = X.SALES_CD)
			     )
			   , REQ AS --발주요청정보
			     (
			       SELECT 	  ME.REQ_NO
			       			, sum(ME.PCHS_AMT) AS REQ_AMT
					FROM TB_SM12D01 ME
					WHERE 1 = 1
	         		 AND EXISTS (SELECT 1 FROM ISU WHERE ISU.REQ_NO = ME.REQ_NO)
					GROUP BY ME.REQ_NO
				 )
			SELECT P.CO_CD              --회사코드
                  , P.CLNT_CD            --고객명
                  , P.CLNT_NM            --고객명

                  , P.CLNT_PJT           --고객사프로젝트
                  , P.CLNT_PJT_NM        --고객사프로젝트명
                  , j.SJ_NM              --과제명
                  , P.ORDRS_NO           --수주번호
                  , P.SALES_CD           --Sales Code
                  , P.VER_NO             --계획버젼
                  , P.WBS_PLAN_CODE_KIND --계획 LEVEL1
                  , P.WBS_PLAN_CODE_ID   --계획 LEVLE2
                  , CASE WHEN P.LVL = 1 THEN P.SALES_CD
                         --WHEN P.LVL = 2 THEN P.WBS_PLAN_CODE_NM
                         --WHEN P.LVL = 3 THEN P.WBS_PLAN_CODE_NM
                         --WHEN P.LVL = 4 THEN P.WBS_PLAN_CODE_NM
                         ELSE                P.WBS_PLAN_CODE_NM END WBS_PLAN_CODE_NM
                  , P.WBS_MNG_NM         --담당자명

                  , TO_CHAR(P.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT
                  , TO_CHAR(P.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT

                  , CASE WHEN P.P_PLAN_NO IS NULL THEN 'N' ELSE 'Y' END AS PLAN_YN
                  , CASE WHEN P.P_RSLTS_NO IS NULL THEN 'N' ELSE 'Y' END AS RSLTS_YN

                  , I.GUBUN              --계획실적구분
                  , I.ISS_STS_NM          --이슈상태명
                  , I.ISS_SJ              --이슈제목
                  , I.ISS_DIV_NM          --이슈유형명
                  , I.ISS_CNTS            --이슈내용

                  , decode(I.REQ_NO, '', I.ACT_ID, QM.ORDRG_ID)       					AS ACT_ID    --조치담당자
				  , decode(I.REQ_NO, '', B2.NAME, B4.NAME) 			 					AS ACT_ID_NM
	              , decode(I.REQ_NO, '', B3.DEPT_NM,B5.DEPT_NM) 						AS ACT_DEPT_NM		  --조치부서
	              , SUBSTRING(decode(I.REQ_NO, '', B2.DEPT_ID,B4.DEPT_ID),0,5) 		AS ACT_DEPT_ID		  --조치부서
--                  , I.ACTS_DT             --조취시작일
--                  , I.ACTE_DT             --조취종료일
		          , TO_CHAR(decode(I.REQ_NO, '', I.ACTS_DT, QM.ORDRG_DT),'YYYY-MM-DD')  AS ACTS_DT           --조치 시작일
		          , TO_CHAR(decode(I.REQ_NO, '', I.ACTE_DT, QP.RSLT_DT),'YYYY-MM-DD')  	AS ACTE_DT           --조치 종료일
                  , I.REQ_NO              --발주요청번호
--                  , I.ACT_MH              --조취공수
		          , decode(I.REQ_NO, '', I.ACT_MH, QP.ACT_MH)          					AS ACT_MH   --조치 투입공수
		          , decode(I.REQ_NO, '', I.ACT_AMT, REQ.REQ_AMT)      					AS ACT_AMT    --조취비용
--                  , I.ACT_CNTS            --조취내용
		          , decode(I.REQ_NO, '', I.ACT_CNTS, QP.MEAS_RST)      					AS ACT_CNTS    --조치내용



                  , I.WBS_RSLTSS_DT       --실적시작일
                  , I.WBS_RSLTSE_DT       --실적종료일
                  , I.ISS_DIV             --이슈유형
                  , I.ACT_ID              --조취자ID
                  , I.ISS_STS             --이슈상태
                  , I.ISS_NO              --이슈제목
                  , I.WBS_PLAN_NO         --WBS계획 번호
                  , I.WBS_RSLTS_NO        --WBS실적 번호
                  , P.P_PLAN_NO
                  , P.P_RSLTS_NO
                  , P.UPPER_CD   AS PID          --상위코드
                  , P.LOWER_CD   AS ID         --하위코드
                  , P.LVL              --코드LEVLE
                  , I.FILE_TRGT_KEY    AS ISS_FILE_TRGT_KEY    --이슈FILE_TRGT_KEY
                  , I.FILE_TRGT_TYP    AS ISS_FILE_TRGT_TYP    --이슈FILE_TRGT_TYP
                  , P.PATH                --코드PATH
	              , I.SUB_CD              --등록사유
	              , I.CREAT_ID            --등록ID
				  , I.MC_PART_CD							  --기계분류
				  , I.IMPORTANT_CD							  --영향도
				  , I.IMPACT_CD							  	  --중요도
			  FROM PLN AS P
			       INNER      JOIN SUBJ AS J ON P.CO_CD = J.CO_CD AND P.SALES_CD = J.SALES_CD--과제정보
			       LEFT OUTER JOIN ISU  AS I ON P.CO_CD = I.CO_CD AND P.SALES_CD = I.SALES_CD AND P.WBS_PLAN_CODE_KIND = I.WBS_PLAN_CODE_KIND AND P.WBS_PLAN_CODE_ID = I.WBS_PLAN_CODE_ID--이슈정보
          		   LEFT OUTER JOIN TB_QM01M01 AS QM ON QM.REQ_NO = I.REQ_NO	--발주요청
				   LEFT OUTER JOIN TB_QM01P01 AS QP ON QP.REQ_NO = I.REQ_NO	--발주요청결과
           		   LEFT OUTER JOIN TB_CM06M01 AS B2 ON I.ACT_ID = B2.ID
	               LEFT OUTER JOIN TB_CM04M01 AS B3 ON B3.DEPT_ID = SUBSTRING(B2.DEPT_ID,0,5)
           		   LEFT OUTER JOIN TB_CM06M01 AS B4 ON QM.ORDRG_ID = B4.ID
				   LEFT OUTER JOIN TB_CM04M01 AS B5 ON B5.DEPT_ID = SUBSTRING(B4.DEPT_ID,0,5)
				   LEFT OUTER JOIN REQ ON REQ.REQ_NO = I.REQ_NO
			 WHERE 1=1
			 ORDER BY P.CLNT_CD, P.ORDRS_NO, P.SALES_CD, P.PATH, I.GUBUN
     </select>

	



     <select id="selectWbsIssueListDashboard" parameterType="Map" resultType="camelMap">
			WITH ISU AS --이슈정보
			     (
			      SELECT *
			        FROM (
			              SELECT  2  AS SORT_SEQ
			                    , '계획'  AS GUBUN
			                    , ISU.CO_CD                                   --회사코드
			                    , ISU.SALES_CD                                --SALES Code
			                    , ISU.WBS_PLAN_CODE_KIND                      --WBS계획 LVL1
			                    , ISU.WBS_PLAN_CODE_ID                        --WBS계획 LVL2
			                    , ISU.WBS_PLAN_NO                             --WBS계획 번호
			                    , ISU.WBS_RSLTS_NO                            --WBS실적 번호
			                    , ISU.ISS_NO                                  --이슈번호
			                    , ISU.ISS_SJ                                  --이슈제목
			                    , ISU.ISS_DIV                                 --이슈유형
			                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
			                    , ISU.ISS_CNTS                                --이슈내용
			                    , decode(ISU.REQ_NO, '', ISU.ISS_STS, QM.REQ_ST)      AS ISS_STS	--이슈상태
			                    , (SELECT FN_CM05M01_CD_TO_NM( decode(ISU.REQ_NO, '', ISU.ISS_STS, QM.REQ_ST)) FROM DUAL) AS ISS_STS_NM
			                    , decode(ISU.REQ_NO, '', ISU.ACT_ID, QM.ORDRG_ID) AS ACT_ID --조치담당자
			                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT--조치 시작일
			                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT--조치 종료일
			                    , ACT.ACT_MH                                  --조치 투입공수
			                    , ACT.ACT_AMT                                 --조치 투입비용
			                    , ACT.ACT_CNTS                                --조치내용
			                    , ISU.FILE_TRGT_KEY                           --이슈 FILE_TRGT_KEY
			                    , ''  WBS_RSLTSS_DT                           --실적시작일
			                    , ''  WBS_RSLTSE_DT                           --실적종료일
			                    , ISU.REQ_NO                                  --발주요청번호
			                    , ISU.CREAT_DTTM AS CREAT_DTTM       --등록/수정일자
			                    , ISU.CREAT_ID   AS CREAT_ID       --등록/수정담당자
								, ISU.MC_PART_CD							  --기계분류
								, ISU.IMPORTANT_CD							  --영향도
								, ISU.IMPACT_CD							  	  --중요도
			                FROM TB_WB24M02 AS ISU --계획이슈 정보
									LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --계획이슈 조치내용
			              			LEFT OUTER JOIN TB_QM01M01 AS QM ON QM.REQ_NO = ISU.REQ_NO
									LEFT OUTER JOIN TB_QM01P01 AS QP ON QP.REQ_NO = ISU.REQ_NO
				           			LEFT OUTER JOIN TB_CM06M01 AS B4 ON QM.ORDRG_ID = B4.ID
			               WHERE ISU.WBS_PLAN_NO IS NOT NULL --계획이슈
			                 AND ISU.CO_CD    = #{coCd}

			              UNION ALL
			              SELECT 2  AS SORT_SEQ
			                    , '실적'  AS GUBUN
			                    , ISU.CO_CD                                               --회사코드
			                    , ISU.SALES_CD                                            --SALES Code
			                    , ISU.WBS_PLAN_CODE_KIND                                  --WBS계획 LVL1
			                    , ISU.WBS_PLAN_CODE_ID                                    --WBS계획 LVL2
			                    , ISU.WBS_PLAN_NO                                         --WBS계획 번호
			                    , ISU.WBS_RSLTS_NO                                        --WBS실적 번호
			                    , ISU.ISS_NO                                              --이슈번호
			                    , ISU.ISS_SJ                                              --이슈제목
			                    , ISU.ISS_DIV                                             --이슈유형
			                    , (SELECT FN_CM05M01_CD_TO_NM(ISU.ISS_DIV) FROM DUAL) AS ISS_DIV_NM
			                    , ISU.ISS_CNTS                                            --이슈내용
			                    , decode(ISU.REQ_NO, '', ISU.ISS_STS, QM.REQ_ST)      AS ISS_STS	--이슈상태
			                    , (SELECT FN_CM05M01_CD_TO_NM( decode(ISU.REQ_NO, '', ISU.ISS_STS, QM.REQ_ST)) FROM DUAL) AS ISS_STS_NM
			                    , decode(ISU.REQ_NO, '', ISU.ACT_ID, QM.ORDRG_ID) AS ACT_ID --조치담당자
			                    , TO_CHAR(ACT.ACTS_DT,'YYYY-MM-DD')  AS ACTS_DT           --조치 시작일
			                    , TO_CHAR(ACT.ACTE_DT,'YYYY-MM-DD')  AS ACTE_DT           --조치 종료일
			                    , ACT.ACT_MH                                              --조치 투입공수
			                    , ACT.ACT_AMT                                             --조치 투입비용
			                    , ACT.ACT_CNTS                                            --조치내용
			                    , ISU.FILE_TRGT_KEY                                       --이슈 FILE_TRGT_KEY
			                    , TO_CHAR(RSL.WBS_RSLTSS_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT--실적시작일
			                    , TO_CHAR(RSL.WBS_RSLTSE_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT--실적종료일
			                    , ISU.REQ_NO                                  --발주요청번호
			                    , ISU.CREAT_DTTM AS CREAT_DTTM       --등록/수정일자
			                    , ISU.CREAT_ID   AS CREAT_ID       --등록/수정담당자
								, ISU.MC_PART_CD							  --기계분류
								, ISU.IMPORTANT_CD							  --영향도
								, ISU.IMPACT_CD							  	  --중요도
			                FROM TB_WB24M02  AS ISU --WBS이슈 정보
			              			LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --실적이슈 조치내용
			          				LEFT OUTER JOIN TB_WB23M01 AS RSL ON ISU.CO_CD = RSL.CO_CD AND ISU.SALES_CD = RSL.SALES_CD AND ISU.WBS_PLAN_CODE_KIND = RSL.WBS_PLAN_CODE_KIND AND ISU.WBS_PLAN_CODE_ID = RSL.WBS_PLAN_CODE_ID AND ISU.WBS_RSLTS_NO = RSL.WBS_RSLTS_NO
			              			LEFT OUTER JOIN TB_QM01M01 AS QM ON QM.REQ_NO = ISU.REQ_NO
									LEFT OUTER JOIN TB_QM01P01 AS QP ON QP.REQ_NO = ISU.REQ_NO
				           			LEFT OUTER JOIN TB_CM06M01 AS B4 ON QM.ORDRG_ID = B4.ID
			               WHERE ISU.WBS_RSLTS_NO IS NOT NULL  --실적이슈
			                 AND ISU.CO_CD    = #{coCd}

						--작업일보에서 등록된 이슈 내용 확인 (최근 1개월이내 자료)
			              UNION ALL
							SELECT  1  AS SORT_SEQ
				                 , '일보'  AS GUBUN
					             , T.CO_CD
					             , T.SALES_CD                                            	--SALES Code
					             , T.WORK_RPT_M
					             , T.WORK_RPT_S
					             , T.WORK_RPT_NO                                            --WBS계획 번호
					             , T.WORK_RPT_NO                                            --WBS실적 번호
				                 , T.WORK_RPT_NO                                   			--이슈번호
				                 , T.ISSUE_TITLE                                   			--이슈제목
				                 , '' AS ISS_DIV                                     		--이슈유형
				                 , '작업일보' AS ISS_DIV_NM
					             , T.WORK_RPT_RMK                                           --이슈내용
				                 , 'ISSSTS01'                                             	--이슈상태
				                 , '일보' AS ISS_STS_NM
					             , T.WORK_RPT_ID     ACT_ID                                 --조치담당자
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD')   AS ACTS_DT         --조치 시작일
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD')   AS ACTE_DT         --조치 종료일
				                 , T.WORK_RPT_HOUR                                          --조치 투입공수
				                 , ''                                             --조치 투입비용
				                 , ''                                           			--조치내용
				                 , T.FILE_TRGT_KEY                                       	--이슈 FILE_TRGT_KEY
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WBS_RSLTSS_DT		--실적시작일
				                 , TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WBS_RSLTSE_DT		--실적종료일
				                 , ''  AS REQ_NO                          					--발주요청번호
				                 , NVL2(T.UDT_DTTM, T.UDT_DTTM, T.CREAT_DTTM) AS CREAT_DTTM --등록/수정일자
				                 , NVL2(T.UDT_ID, T.UDT_ID, T.CREAT_ID) AS CREAT_ID       	--등록/수정담당자
								 , '' AS MC_PART_CD							  --기계분류
								 , '' AS IMPORTANT_CD							  --영향도
								 , '' AS IMPACT_CD							  	  --중요도
					        FROM   TB_PM01M01 AS T
					        WHERE  T.ISSUE_YN = 'Y'
					        AND    T.WORK_RPT_DT <![CDATA[>=]]> ADD_MONTHS(SYSDATE, -1) --TRUNC(SYSDATE, 'MM')

						--프로젝트에 등록된 이슈 내용 확인 (최근 1개월이내 자료)
			              UNION ALL
							SELECT  0  AS SORT_SEQ
				                 , '프로젝트'  AS GUBUN
					             , T.CO_CD
					             , T.YYYYMM || ' ' || T.DATA_SEARCH  AS SALES_CD      	--SALES Code
					             , '프로젝트관리' 												--작업단계
					             , BD.PRJCT_SEQ
					             , BD.PRJCT_SEQ                                            --WBS계획 번호
					             , BD.PRJCT_SEQ                                            --WBS실적 번호
				                 , BD.ISS_NO                                   				--이슈번호
				                 , NVL2(T.WINBD_RMK,T.WINBD_RMK,T.PRJCT_NM)         		--이슈제목
				                 , '' AS ISS_DIV                                     		--이슈유형
				                 , '프로젝트' AS ISS_DIV_NM
					             , BD.ISS_CNTS                                           	--이슈내용
				                 , BD.ISS_STS
								 , FN_CM05M01_CD_TO_NM(BD.ISS_STS) AS ISS_STS_NM
					             ,  NVL2(BD.UDT_ID, BD.UDT_ID, BD.CREAT_ID) AS ACT_ID                                 --조치담당자
				                 , TO_CHAR(BD.ISS_DT,'YYYY-MM-DD')   AS ACTS_DT         --조치 시작일
				                 , TO_CHAR(BD.ISS_DT,'YYYY-MM-DD')   AS ACTE_DT         --조치 종료일
				                 , ''                                          			--조치 투입공수
				                 , ''                                             		--조치 투입비용
				                 , ''                                           			--조치내용
				                 , BD.PRJCT_SEQ                                       	    --이슈 FILE_TRGT_KEY
				                 , TO_CHAR(BD.CREAT_DTTM,'YYYY-MM-DD') AS WBS_RSLTSS_DT		--실적시작일
				                 , TO_CHAR(BD.CREAT_DTTM,'YYYY-MM-DD') AS WBS_RSLTSE_DT		--실적종료일
				                 , ''  AS REQ_NO                          					--발주요청번호
				                 , NVL2(BD.UDT_DTTM, BD.UDT_DTTM, BD.CREAT_DTTM) AS CREAT_DTTM --등록/수정일자
				                 , NVL2(BD.UDT_ID, BD.UDT_ID, BD.CREAT_ID) AS CREAT_ID       	--등록/수정담당자
								 , '' AS MC_PART_CD							  --기계분류
								 , '' AS IMPORTANT_CD							  --영향도
								 , '' AS IMPACT_CD							  	  --중요도
						  FROM TB_BM06D03 BD
							             LEFT OUTER JOIN TB_BM06M01 T ON T.PRJCT_SEQ = BD.PRJCT_SEQ
				         WHERE 1=1
						   AND T.CO_CD = #{coCd}
						   AND BD.ISS_DT <![CDATA[>=]]> ADD_MONTHS(SYSDATE, -1)
			             )
			     WHERE 1=1
			     )
			SELECT ISU.*
				,(SELECT FN_CM06M01_ID_TO_NM(ISU.CREAT_ID) FROM DUAL) AS CREAT_ID_NM
				,(SELECT FN_CM06M01_ID_TO_NM(NVL2(ISU.ACT_ID,ISU.ACT_ID,ISU.CREAT_ID)) FROM DUAL) AS ACT_ID_NM
				,(SELECT FN_CM05M01_CD_TO_NM(ISU.WBS_PLAN_CODE_KIND) FROM DUAL) AS CODE_ID_NM
			  FROM ISU
			  WHERE 1 = 1
			    AND ISS_STS NOT IN ('ISSSTS03', 'REQST03')   --상태코드 완료가 아닌것
			  ORDER BY CO_CD, SORT_SEQ, CREAT_DTTM, SALES_CD, WBS_PLAN_CODE_ID, ISS_NO
     </select>


		  <select id="selectMaxWbsIssueNo" parameterType="Map"  resultType="camelMap">
              SELECT  'ISS' || (SELECT to_char(sysdate,'yy') FROM dual) ||
                      trim(to_char(nvl(SUBSTR(MAX(ISS_NO), 6, 4),0) + 1, '0000')) AS ISS_NO
                FROM TB_WB24M02
          </select>

          <select id="selectWbsIssueSeqNext" parameterType="Map" resultType="int">
             SELECT TB_WB24M02_SQ01.NEXTVAL FROM DUAL
          </select>

          <insert id="wbsIssueInsert" parameterType="Map">
                INSERT INTO TB_WB24M02
                (
                    FILE_TRGT_KEY,
				    CO_CD,
				    WBS_PLAN_CODE_KIND,
				    WBS_PLAN_CODE_ID,
				    ISS_NO,
				    ISS_SJ,
				    ISS_DIV,
				    ISS_CNTS,
				    ISS_STS,
				    ACT_ID,
				    WBS_PLAN_NO,
				    WBS_RSLTS_NO,
				    SALES_CD,
				    CREAT_ID,
				    CREAT_PGM,
				    CREAT_DTTM,
				    MID_CD,
				    SUB_CD,
				    VEND_CD,		--문제발생공급업체
				    MC_PART_CD,
				    IMPORTANT_CD,
				    IMPACT_CD,
				    ETC_INPUT
                )
                VALUES
                (
                    #{issFileTrgtKey},
                    #{coCd},
                    #{wbsPlanCodeKind},
                    #{wbsPlanCodeId},
                    #{issNo},
                    #{issSj},
                    #{issDiv},
                    #{issCnts},
                    #{issSts},
                    #{actId},
                    #{wbsPlanNo},
                    #{wbsRsltsNo},
                    #{salesCd},
                    #{userId},
                    #{pgmId},
                    SYSDATE,
					#{midCd},
					#{CODECOBGB},
                    #{vendCd},		--문제발생공급업체
				    #{mcPartCd},
				    #{importantCd},
				    #{impactCd},
				    #{etcInput}
                )
            </insert>

            <insert id="wbsActInsert" parameterType="Map">
                <selectKey keyProperty="fileTrgtKey" resultType="Int" order="BEFORE">
                    SELECT NVL(MAX(TO_NUMBER(NVL(FILE_TRGT_KEY,'0'))),0) + 1 FROM TB_WB24M03
                </selectKey>
                INSERT INTO TB_WB24M03
                (
                    FILE_TRGT_KEY,
                    ISS_NO,
                    ACTS_DT,
                    ACTE_DT,
                    ACT_MH,
                    ACT_AMT,
                    ACT_CNTS,
                    REQ_NO,
                    ACT_AMT_STS,
                    ACT_DNG,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM,
                    MEAS_RST,
				    MC_PART_CD,
				    IMPORTANT_CD,
				    IMPACT_CD,
				    ACT_COMP_DGN_FILE_NM
                )
                VALUES
                (
                    #{fileTrgtKey},
                    #{issNo},
                    #{actsDt},
                    #{acteDt},
                    #{actMh},
                    #{actAmt, jdbcType=VARCHAR},
                    #{actCnts},
                    #{reqNo, jdbcType=VARCHAR},
                    #{actAmtSts, jdbcType=VARCHAR},
                    #{actDng, jdbcType=VARCHAR},
                    #{userId},
                    #{pgmId},
                    SYSDATE,
                    #{measRst, jdbcType=VARCHAR},
				    #{mcPartCd},
				    #{importantCd},
				    #{impactCd},
				    #{actCompDgnFileNm, jdbcType=VARCHAR}
                )
            </insert>


            <select id="actChk" parameterType="Map" resultType="camelMap">
	            SELECT *
				  FROM TB_WB20M03
				 WHERE 1=1
				   AND SALES_CD = #{salesCd}
				   AND TODO_NO = #{issNo}
				   AND SANCTN_STTUS  =  'Y'
            </select>



            <select id="issueResultChk" parameterType="Map" resultType="camelMap">
	            SELECT *
				  FROM TB_WB24M03
				 WHERE 1=1
				   AND ISS_NO = #{issNo}
            </select>


            <update id="wbsIssueUpdate" parameterType="Map">
                UPDATE TB_WB24M02
	                    SET ISS_SJ 		= #{issSj},
	                        ISS_DIV 	= #{issDiv},
		                    ISS_CNTS 	= #{issCnts},
		                    ISS_STS 	= #{issSts},
		                    ACT_ID 		= #{actId},
		                    UDT_ID 		= #{userId},
	                        UDT_PGM 	= #{pgmId},
	                        UDT_DTTM 	= SYSDATE,
						    MID_CD		= #{midCd},
						    SUB_CD		= #{CODECOBGB},
						    VEND_CD	    = #{vendCd},		--문제발생공급업체
						    MC_PART_CD	= #{mcPartCd},
						    IMPORTANT_CD= #{importantCd},
						    IMPACT_CD	= #{impactCd},
						    ETC_INPUT   = #{etcInput}
                    WHERE FILE_TRGT_KEY =  #{issFileTrgtKey}
            </update>


           <update id="wbsActUpdate" parameterType="Map">
                UPDATE TB_WB24M03
                        SET ACTS_DT 	= #{actsDt},
                            ACTE_DT 	= #{acteDt},
                            ACT_MH 		= #{actMh},
                            ACT_AMT 	= #{actAmt, jdbcType=VARCHAR},
                            ACT_CNTS 	= #{actCnts},
                            REQ_NO 		= #{reqNo, jdbcType=VARCHAR},
                            ACT_AMT_STS = #{actAmtSts, jdbcType=VARCHAR},
                            ACT_DNG 	= #{actDng, jdbcType=VARCHAR},
                            UDT_ID 		= #{userId},
                            UDT_PGM 	= #{pgmId},
                            UDT_DTTM 	= SYSDATE,
						    MEAS_RST	= #{measRst, jdbcType=VARCHAR},
						    MC_PART_CD	= #{mcPartCd},
						    IMPORTANT_CD= #{importantCd},
						    IMPACT_CD	= #{impactCd},
						    ACT_COMP_DGN_FILE_NM = #{actCompDgnFileNm, jdbcType=VARCHAR}
                    WHERE ISS_NO =  #{issNo}
            </update>

            <select id="selectTodoRsltsView" parameterType="Map" resultType="camelMap">
                SELECT  X.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
			            X.CO_CD,
			            (SELECT FN_CM05M01_CD_TO_NM(X.CO_CD) FROM DUAL) AS CO_NM,
			            X.WBS_PLAN_CODE_KIND,
			            X.WBS_PLAN_CODE_ID,
			            P1.WBS_PLAN_CODE_NM,
			            X.ISS_SJ,
			            X.ISS_NO,
                        (SELECT FN_CM06M01_ID_TO_NM(X.CREAT_ID) FROM DUAL) AS CREAT_ID_NM,
			            X.ISS_DIV,
			            (SELECT FN_CM05M01_CD_TO_NM(X.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
			            X.ISS_CNTS,
			            X.ISS_STS,
			            (SELECT FN_CM05M01_CD_TO_NM(X.ISS_STS) FROM DUAL) AS ISS_STS_NM,
			            X.ACT_ID,
			            (SELECT FN_CM06M01_ID_TO_NM(X.ACT_ID) FROM DUAL) AS ACT_NM,
			            TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
			            TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
			            A.ACT_MH,
			            A.ACT_AMT,
			            A.ACT_CNTS,
		                X.REQ_NO,
			            X.SALES_CD,
			            Y.WBS_RSLTS_NO,
			            Y.WBS_RSLTS_ID,
			            (SELECT FN_CM06M01_ID_TO_NM(Y.WBS_RSLTS_ID) FROM DUAL) AS WBS_RSLTS_NM,
			            TO_CHAR(Y.WBS_RSLTSS_DT, 'YYYY-MM-DD') AS WBS_RSLTSS_DT,
			            TO_CHAR(Y.WBS_RSLTSE_DT, 'YYYY-MM-DD') AS WBS_RSLTSE_DT,

			            (SELECT FN_CM06M01_ID_TO_NM(P.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_PLAN_MNG_NM,
                        TO_CHAR(P.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT,
                        TO_CHAR(P.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT,
                        M.SJ_NO,
                        M.SJ_NM,
                        M.VER_NO,
                        M.SALES_CD  AS W21_SALES_CD,
                        CM.ORDRS_CLNT_CD,
                        B.CLNT_NM,	--고객사명
                        (SELECT FN_CM05M01_CD_TO_NM(CM.CLNT_PJT) FROM DUAL) AS CLNT_PJT_NM				--고객사프로젝트
		             , A.ACT_AMT_STS
		             , (SELECT FN_CM05M01_CD_TO_NM(A.ACT_AMT_STS) FROM DUAL) AS ACT_AMT_STS_NM
		             , A.ACT_DNG			--담당자위험도평가
		             , (SELECT FN_CM05M01_CD_TO_NM(A.ACT_DNG) FROM DUAL) AS ACT_DNG_NM
		             , A.ACT_DNG_EVAL		--팀장위험도평가
		             , (SELECT FN_CM05M01_CD_TO_NM(A.ACT_DNG_EVAL) FROM DUAL) AS ACT_DNG_EVAL_NM
					 , A.VEND_CD 		AS VEND_CD
					 , B2.CLNT_NM 		AS VEND_CD_NM
            FROM TB_WB24M02 X
				            LEFT OUTER JOIN TB_WB23M01 Y    ON X.CO_CD = Y.CO_CD
												            AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND
												            AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
												            AND X.SALES_CD = Y.SALES_CD
												            AND X.WBS_RSLTS_NO = Y.WBS_RSLTS_NO
				            LEFT OUTER JOIN TB_WB22M01 P    ON X.CO_CD = P.CO_CD
									                        AND X.WBS_PLAN_CODE_KIND = P.WBS_PLAN_CODE_KIND
									                        AND X.WBS_PLAN_CODE_ID = P.WBS_PLAN_CODE_ID
									                        AND X.SALES_CD = P.SALES_CD
									                        AND X.WBS_PLAN_NO = P.WBS_PLAN_NO
				            LEFT OUTER JOIN TB_WB22M01 P1   ON X.CO_CD = P1.CO_CD
									                        AND X.WBS_PLAN_CODE_KIND = P1.WBS_PLAN_CODE_KIND
									                        AND X.WBS_PLAN_CODE_ID = P1.WBS_PLAN_CODE_ID
									                        AND X.SALES_CD = P1.SALES_CD
				            LEFT OUTER JOIN TB_WB24M03 A    ON X.ISS_NO = A.ISS_NO
				            LEFT OUTER JOIN TB_WB21M01 M    ON X.CO_CD = M.CO_CD
									                        AND X.SALES_CD = M.SALES_CD
									                        AND M.VER_NO IN (SELECT MAX(TO_NUMBER(VER_NO)) FROM TB_WB21M01 CC WHERE CC.SALES_CD = X.SALES_CD)
				            LEFT OUTER JOIN TB_CR02D02 C    ON C.SALES_CD = X.SALES_CD
				            LEFT OUTER JOIN TB_CR02M01 CM   ON C.CO_CD = CM.CO_CD
									                        AND C.ORDRS_NO = CM.ORDRS_NO
				            LEFT OUTER JOIN TB_BM02M01 B    ON B.CLNT_CD = CM.ORDRS_CLNT_CD
				            LEFT OUTER JOIN TB_BM02M01 B2   ON B2.CLNT_CD = A.VEND_CD
			WHERE X.FILE_TRGT_KEY = #{fileTrgtKey}
          </select>

          <select id="selectRsltsMemberList" parameterType="Map" resultType="camelMap">

                SELECT X.CO_CD,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS WBS_PLANCO_CD_NM,
                      X.ID AS USR_NM,
                      X.EMP_NO,
                      X.NAME,
                      X.TEL_NO,
                      X.OFF_TEL_NO,
                      D.LEVEL_NM AS JIK,
                      C.DEPT_NM,
                      X.EMAIL,
                      TO_CHAR(SYSDATE, 'YYYY-MM-DD') AS REQ_DATE
                      FROM TB_CM06M01 X
	                      LEFT OUTER JOIN TB_CM04M01 C ON(X.DEPT_ID=C.DEPT_ID)
	                      LEFT OUTER JOIN TB_CM07M01 D ON(X.LEVEL_CD=D.LEVEL_CD)
                      WHERE 1 = 1
                      AND X.ID = #{userId}
          </select>

          <select id="selectMemberTelNo" parameterType="Map" resultType="camelMap">
                SELECT TEL_NO
                      FROM TB_CM06M01
                      WHERE ID = #{userId}
          </select>

    <select id="select_wb2401p01_Info" parameterType="Map" resultType="camelMap">
        SELECT A.WBS_PLAN_NO
             , A.WBS_RSLTS_NO
             , A.WBS_PLAN_CODE_KIND
             , A.WBS_PLAN_CODE_ID
             , TO_CHAR(NVL(P.WBS_PLANS_DT,R.WBS_RSLTSS_DT),'YYYY-MM-DD') AS WBS_PLANS_DT
             , TO_CHAR(NVL(P.WBS_PLANE_DT,R.WBS_RSLTSE_DT),'YYYY-MM-DD') AS WBS_PLANE_DT
             , TO_CHAR(NVL(R.WBS_RSLTSS_DT,P.WBS_PLANS_DT),'YYYY-MM-DD') AS WBS_RSLTSS_DT
             , TO_CHAR(NVL(R.WBS_RSLTSE_DT,P.WBS_PLANE_DT),'YYYY-MM-DD') AS WBS_RSLTSE_DT
             , A.ISS_DIV
             , R3.CODE_NM AS ISS_DIV_NM
             , A.ISS_STS
             , R4.CODE_NM AS ISS_STS_NM
             , A.ISS_SJ
             , A.ISS_CNTS
             , A.ACT_ID			AS ACT_ID
             , U.NAME 			AS ACT_NM
             , U.DEPT_ID		AS ACT_DEPT_ID
             , TO_CHAR(S.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT
             , TO_CHAR(S.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT
             , NVL(S.ACT_MH, 0)  AS ACT_MH
             , NVL(S.ACT_AMT, 0) AS ACT_AMT
			 , A.REQ_NO
             , S.ACT_CNTS
             , R1.CODE_NM AS WBS_PLAN_CODE_KIND_NM
             , NVL(R2.CODE_NM, R1.CODE_NM) AS WBS_PLAN_CODE_NM
             , A.ISS_NO
             , A.FILE_TRGT_KEY
             , A.FILE_TRGT_KEY  AS ISS_FILE_TRGT_KEY
             , A.SALES_CD
             , A.CO_CD
             , A.CREAT_ID
             , U2.NAME  			AS CREAT_ID_NM
             , U2.DEPT_ID			AS CREAT_DEPT_ID
             , A.CREAT_PGM
             , A.CREAT_DTTM
             , TO_CHAR(A.CREAT_DTTM,'YYYY-MM-DD') AS CREAT_DT
             , A.UDT_ID
             , A.UDT_PGM
             , A.UDT_DTTM
             , WB.APP_CNT
             , WB.ACT_APP_CNT
             , S.ACT_AMT_STS
             , S.ACT_DNG			--담당자위험도평가
		     , S.ACT_DNG_EVAL		--팀장위험도평가
		     , S.MEAS_RST			--원인
			 , A.MID_CD AS MID_CD
			 , (SELECT FN_CM05M01_CD_TO_NM(A.MID_CD) FROM DUAL) AS MID_NM
			 , A.SUB_CD AS SUB_CD
			 , (SELECT FN_CM05M01_CD_TO_NM(A.SUB_CD) FROM DUAL) AS SUB_CD_NM
			 , A.VEND_CD 		AS VEND_CD
			 , B2.CLNT_NM 		AS VEND_CD_NM
			 , Q.FILE_TRGT_KEY  AS REQ_FILE_TRGT_KEY	--발주요청서 유니크키값
			 , Q.REQ_ST			AS REQ_ST				--발주요청서 진행상태코드 : REQST01, REQST02, REQST03
			 , QP.RSLT_NO 		AS RSLT_NO
			 , decode(NVL(QP.RSLT_NO,''), '', 'N', 'Y')   AS RSLT_YN --결과등록여부
			 , Q.MID_CD 				AS REQ_MID_CD
			 , Q.SUB_CD 				AS REQ_SUB_CD
			 , NVL(QP.SUB_CD, '') 		AS RESLT_SUB_CD		--결과사유
			 , CR.ORDRS_NO	--수주번호
			 , CR.EQP_NM	--설비명
			 , CM.CLNT_PJT	--프로젝트코드
			 , (SELECT FN_CM05M01_CD_TO_NM(CR.ORDRS_DTL_DIV20) FROM DUAL) AS NEW_CD_NM
			 , B3.CLNT_NM 				AS CLNT_NM
			 , A.MC_PART_CD
			 , A.IMPORTANT_CD
			 , A.IMPACT_CD
	         , (SELECT FN_CM05M01_CD_TO_NM(A.MC_PART_CD) FROM DUAL) AS MC_PART_CD_NM
	         , (SELECT FN_CM05M01_CD_TO_NM(A.IMPORTANT_CD) FROM DUAL) AS IMPORTANT_CD_NM
	         , (SELECT FN_CM05M01_CD_TO_NM(A.IMPACT_CD) FROM DUAL) AS IMPACT_CD_NM
			 , TO_CHAR(CR.DUDT_INTEND_DT,'YYYY-MM-DD') AS CUST_REQ_DT	--납기예정일 ->고객요구일
			 , S.ACT_COMP_DGN_FILE_NM
			 , A.ETC_INPUT 		--문제등록사유가 기타인경우 상세내용 입력됨
        FROM   TB_WB24M02 AS A
               LEFT OUTER JOIN TB_WB22M01 AS P  ON P.CO_CD       = A.CO_CD
                                               AND P.WBS_PLAN_NO = A.WBS_PLAN_NO
                                               AND P.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_WB23M01 AS R  ON R.CO_CD       = A.CO_CD
                                               AND R.WBS_RSLTS_NO = A.WBS_RSLTS_NO
                                               AND R.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_WB24M03 AS S  ON S.ISS_NO = A.ISS_NO
               LEFT OUTER JOIN TB_CM06M01 AS U  ON U.ID = A.ACT_ID
               LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = A.WBS_PLAN_CODE_KIND
               LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = A.ISS_DIV
               LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = A.ISS_STS
               LEFT OUTER JOIN TB_CM06M01 AS U2  ON U2.ID = A.CREAT_ID
               LEFT OUTER JOIN TB_BM02M01 AS B2  ON B2.CLNT_CD = A.VEND_CD
               LEFT OUTER JOIN TB_QM01M01 AS Q  ON Q.REQ_NO = A.REQ_NO
		 	   LEFT OUTER JOIN TB_QM01P01 AS QP  ON QP.REQ_NO = Q.REQ_NO
		 	   LEFT OUTER JOIN TB_CR02D02 AS CR  ON CR.SALES_CD = A.SALES_CD
		 	   LEFT OUTER JOIN TB_CR02M01 AS CM  ON CM.CO_CD =  A.CO_CD  
		 	                                    AND CM.ORDRS_NO = CR.ORDRS_NO
               LEFT OUTER JOIN TB_BM02M01 AS B3 ON B3.CLNT_CD = CM.ORDRS_CLNT_CD
               LEFT OUTER JOIN
				               (
					                SELECT sum(CASE WHEN TODO_DIV2_CODE_ID = 'TODODIV2060' THEN 1 ELSE 0 END) AS  APP_CNT
					                	,  sum(CASE WHEN TODO_DIV2_CODE_ID = 'TODODIV2090' THEN 1 ELSE 0 END) AS  ACT_APP_CNT
					                	, MAX(TODO_NO) AS TODO_NO
					                FROM   TB_WB20M03
					                WHERE  1 = 1
					                AND    TODO_NO= (SELECT A.ISS_NO FROM TB_WB24M02 AS A WHERE  A.FILE_TRGT_KEY = #{fileTrgtKey})
					                AND    TODO_CF_DT IS NOT NULL
				               ) AS WB ON A.ISS_NO  =  WB.TODO_NO
        WHERE  1 = 1
        AND    A.FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

	<delete id="wbsIssueDelete" parameterType="Map">
               DELETE FROM TB_WB24M02
                   WHERE ISS_NO  = #{issNo}
	</delete>


	<delete id="wbsIssueResultDelete" parameterType="Map">
               DELETE FROM TB_WB24M03
                   WHERE ISS_NO  = #{issNo}
	</delete>

    <select id="selectTeamManagerInfo" parameterType="Map" resultType="camelMap">
		SELECT *
		FROM (
			SELECT  ROWNUM AS RRN,
			  		 ID, NAME, TEL_NO, DEPT_ID, LEVEL_CD, EMAIL, OFF_TEL_NO,
					(SELECT LEVEL_NM FROM TB_CM07M01 WHERE LEVEL_CD = U.LEVEL_CD) AS LEVEL_NM,
					(SELECT DEPT_NM FROM TB_CM04M01 WHERE DEPT_ID = U.DEPT_ID) DEPT_NM
			  FROM TB_CM06M01  U
			 WHERE U.DEPT_ID LIKE (SELECT substr(DEPT_ID, 0, 5) FROM TB_CM06M01 WHERE id = #{userId} ) || '%'
			   AND U.TEAM_MANAGER = 'TEAM01'
			 )
		WHERE RRN  = 1
    </select>


    <select id="selectDept2TeamManagerInfo" parameterType="Map" resultType="camelMap">
		SELECT *
		FROM (
			SELECT  ROWNUM AS RRN,
			  		 ID, NAME, TEL_NO, DEPT_ID, LEVEL_CD, EMAIL, OFF_TEL_NO,
					(SELECT LEVEL_NM FROM TB_CM07M01 WHERE LEVEL_CD = U.LEVEL_CD) AS LEVEL_NM,
					(SELECT DEPT_NM FROM TB_CM04M01 WHERE DEPT_ID = U.DEPT_ID) DEPT_NM
			  FROM TB_CM06M01  U
			 WHERE U.DEPT_ID LIKE substr(#{deptId},0,5)
			   AND U.TEAM_MANAGER = 'TEAM01'
			 )
		WHERE RRN  = 1
    </select>

    <select id="selectTeamManagerSpecialInfo" parameterType="Map" resultType="camelMap">
		SELECT *
		FROM (
			SELECT  ROWNUM AS RRN,
			  		 ID, NAME, TEL_NO, DEPT_ID, LEVEL_CD, EMAIL, OFF_TEL_NO,
					(SELECT LEVEL_NM FROM TB_CM07M01 WHERE LEVEL_CD = U.LEVEL_CD) AS LEVEL_NM,
					(SELECT DEPT_NM FROM TB_CM04M01 WHERE DEPT_ID = U.DEPT_ID) DEPT_NM
			  FROM TB_CM06M01  U
			 WHERE id = #{userId}
			 )
		WHERE RRN  = 1
    </select>

	<update id="updateWbsIssueResultEvaluate" parameterType="Map">
		UPDATE TB_WB24M03
           SET ACT_DNG_EVAL 	= #{actDngEval, jdbcType=VARCHAR}
		 WHERE  ISS_NO =  #{issNo}
	</update>

	<update id="updateWbsIssueStChk" parameterType="Map">
		UPDATE TB_WB24M02
		   SET ISS_STS = 'ISSSTS02'
		 WHERE ISS_NO = #{issNo}
		   AND ISS_STS = 'ISSSTS01'
	</update>



    <select id="select_wb2401p01_planInfo" parameterType="Map" resultType="camelMap">
		SELECT
			  	  WBS_PLAN_CODE_KIND
				, FN_CM05M01_CD_TO_NM(T.WBS_PLAN_CODE_KIND) AS WBS_PLAN_CODE_KIND_NM
				, WBS_PLAN_CODE_ID
				, WBS_PLAN_CODE_NM
				, VER_NO
				, SALES_CD
				, SEQ
				, WBS_PLAN_MNG_ID
				, FN_CM06M01_ID_TO_NM(T.WBS_PLAN_MNG_ID) 	AS WBS_PLAN_MNG_ID_NM
             	, TO_CHAR(T.WBS_PLANS_DT,'YYYY-MM-DD') 		AS WBS_PLANS_DT
             	, TO_CHAR(T.WBS_PLANE_DT,'YYYY-MM-DD') 		AS WBS_PLANE_DT
				, DAYCNT
				, WBS_PLAN_STS_CODE_ID
				, FN_CM05M01_CD_TO_NM(T.WBS_PLAN_STS_CODE_ID) AS WBS_PLAN_STS_CODE_ID_NM
				, LOCK_YN
				, CLOSE_YN
				, CREAT_ID
				, FN_CM06M01_ID_TO_NM(T.CREAT_ID) AS CREAT_ID_NM
            	, T.EXPECT_MH
				, U.TEL_NO
		FROM TB_WB22M01	T,  (SELECT TEL_NO
		                      FROM TB_CM06M01
		                      WHERE ID = #{userId}) U
		WHERE T.WBS_PLAN_NO = #{wbsPlanNo}
    </select>


    <select id="select_wb2401p01_rsltInfo" parameterType="Map" resultType="camelMap">
		SELECT
				  T.WBS_PLAN_CODE_KIND
				, FN_CM05M01_CD_TO_NM(T.WBS_PLAN_CODE_KIND) AS WBS_PLAN_CODE_KIND_NM
				, T.WBS_PLAN_CODE_ID
				, T.SALES_CD
				, T.WBS_RSLTS_ID
				, FN_CM06M01_ID_TO_NM(T.WBS_RSLTS_ID) AS WBS_RSLTS_ID_NM
				, T.WBS_RSLTS_RATE
				, T.WBS_PLAN_MH
				, T.WBS_RSLTS_MH
				, T.WBS_RSLTS_CNTS
             	, TO_CHAR(T.WBS_RSLTSS_DT,'YYYY-MM-DD') 		AS WBS_RSLTSS_DT
             	, TO_CHAR(T.WBS_RSLTSE_DT,'YYYY-MM-DD') 		AS WBS_RSLTSE_DT
				, T.DAYCNT
				, T.LOCK_YN
				, T.CLOSE_YN
				, T.CREAT_ID
				, FN_CM06M01_ID_TO_NM(T.CREAT_ID) AS CREAT_ID_NM
				, P.WBS_PLAN_CODE_NM
             	, TO_CHAR(P.WBS_PLANS_DT,'YYYY-MM-DD') 		AS WBS_PLANS_DT
             	, TO_CHAR(P.WBS_PLANE_DT,'YYYY-MM-DD') 		AS WBS_PLANE_DT
             	, P.EXPECT_MH
				, U.TEL_NO
		FROM TB_WB23M01	T
						LEFT OUTER JOIN TB_WB22M01 P ON WBS_PLAN_NO = #{wbsRsltsNo}
				,  (SELECT TEL_NO
		                      FROM TB_CM06M01
		                      WHERE ID = 'js.nam') U
		WHERE T.WBS_RSLTS_NO = #{wbsRsltsNo}
    </select>

	<!-- 	공급사별 문제현황 목록 조회  -->
    <select id="selectVendProblemList" parameterType="Map" resultType="camelMap">
	    SELECT FILE_TRGT_KEY
			 , ISS_NO
			 , ISS_SJ
			 , ISS_DIV
			 , (SELECT FN_CM05M01_CD_TO_NM(ISS_DIV) FROM DUAL) AS SUB_CD_NM
			 , ISS_CNTS
			 , ISS_STS
			 , (SELECT FN_CM05M01_CD_TO_NM(ISS_STS) FROM DUAL) AS ISS_STS_NM
			 , SUB_CD
			 , SUB_CD
			 , (SELECT FN_CM05M01_CD_TO_NM(SUB_CD) FROM DUAL) AS SUB_CD_NM
			 , SALES_CD
	 		 , TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
			 , VEND_CD					/* 구매처cd */
			 , (
		 		  SELECT D.CLNT_NM
					FROM TB_BM02M01 D
				   WHERE D.CLNT_CD = VEND_CD
			   )  AS VEND_NM		/* 구매처명 */
		  FROM TB_WB24M02
		 WHERE 1 = 1
		   AND VEND_CD = #{vendCd}
	   <choose>
	       <when test="selectType == 'OEM'">
	        AND SUB_CD BETWEEN 'COBGB4300' AND 'COBGB4799'
	       </when>
	       <when test="selectType == 'CODE'">
	        AND SUB_CD like #{selectType} || '%'
	       </when>
	       <otherwise>
	       </otherwise>
	   </choose>
		 ORDER BY CREAT_DTTM DESC, SALES_CD DESC
    </select>

	<!-- 발생공급업체 Update -->
	<update id="updateVendCd" parameterType="Map">
		UPDATE TB_WB24M02
				SET VEND_CD	    = #{vendCd}		--문제발생공급업체
			WHERE ISS_NO =  #{issNo}
	</update>

	<!-- 문제정보를 가지고 발주요청서 등록 -->
	<select id="selectIssueInfo" parameterType="Map" resultType="camelMap">
        SELECT A.WBS_PLAN_NO
             , A.WBS_RSLTS_NO
             , A.WBS_PLAN_CODE_KIND
             , A.WBS_PLAN_CODE_ID
             , TO_CHAR(NVL(P.WBS_PLANS_DT,R.WBS_RSLTSS_DT),'YYYY-MM-DD') AS WBS_PLANS_DT
             , TO_CHAR(NVL(P.WBS_PLANE_DT,R.WBS_RSLTSE_DT),'YYYY-MM-DD') AS WBS_PLANE_DT
             , TO_CHAR(NVL(R.WBS_RSLTSS_DT,P.WBS_PLANS_DT),'YYYY-MM-DD') AS WBS_RSLTSS_DT
             , TO_CHAR(NVL(R.WBS_RSLTSE_DT,P.WBS_PLANE_DT),'YYYY-MM-DD') AS WBS_RSLTSE_DT
             , A.ISS_DIV
             , R3.CODE_NM AS ISS_DIV_NM
             , A.ISS_STS
             , R4.CODE_NM AS ISS_STS_NM
             , A.ISS_SJ
             , A.ISS_CNTS
             , A.ACT_ID			AS ACT_ID
             , U.NAME 			AS ACT_NM
             , U.DEPT_ID		AS ACT_DEPT_ID
             , TO_CHAR(S.ACTS_DT,'YYYY-MM-DD') AS ACTS_DT
             , TO_CHAR(S.ACTE_DT,'YYYY-MM-DD') AS ACTE_DT
             , NVL(S.ACT_MH, 0)  AS ACT_MH
             , NVL(S.ACT_AMT, 0) AS ACT_AMT
			 , A.REQ_NO
             , S.ACT_CNTS
             , R1.CODE_NM AS WBS_PLAN_CODE_KIND_NM
             , NVL(R2.CODE_NM, R1.CODE_NM) AS WBS_PLAN_CODE_NM
             , A.ISS_NO
             , A.FILE_TRGT_KEY
             , A.FILE_TRGT_KEY  AS ISS_FILE_TRGT_KEY
             , A.SALES_CD
             , A.CO_CD
             , A.CREAT_ID
             , U2.NAME  			AS CREAT_ID_NM
             , U2.DEPT_ID			AS CREAT_DEPT_ID
             , A.CREAT_PGM
             , A.CREAT_DTTM
             , TO_CHAR(A.CREAT_DTTM,'YYYY-MM-DD') AS CREAT_DT
             , A.UDT_ID
             , A.UDT_PGM
             , A.UDT_DTTM
             , WB.APP_CNT
             , WB.ACT_APP_CNT
             , S.ACT_AMT_STS
             , S.ACT_DNG			--담당자위험도평가
		     , S.ACT_DNG_EVAL		--팀장위험도평가
		     , S.MEAS_RST			--원인
			 , A.MID_CD AS MID_CD
			 , (SELECT FN_CM05M01_CD_TO_NM(A.MID_CD) FROM DUAL) AS MID_NM
			 , A.SUB_CD AS SUB_CD
			 , (SELECT FN_CM05M01_CD_TO_NM(A.SUB_CD) FROM DUAL) AS SUB_CD_NM
			 , A.VEND_CD 		AS VEND_CD
			 , B2.CLNT_NM 		AS VEND_CD_NM
			 , Q.FILE_TRGT_KEY  AS REQ_FILE_TRGT_KEY	--발주요청서 유니크키값
			 , Q.REQ_ST			AS REQ_ST				--발주요청서 진행상태코드 : REQST01, REQST02, REQST03
			 , QP.RSLT_NO 		AS RSLT_NO
			 , decode(NVL(QP.RSLT_NO,''), '', 'N', 'Y')   AS RSLT_YN --결과등록여부
			 , Q.MID_CD 				AS REQ_MID_CD
			 , Q.SUB_CD 				AS REQ_SUB_CD
			 , NVL(QP.SUB_CD, '') 		AS RESLT_SUB_CD		--결과사유
			 , CR.ORDRS_NO	--수주번호
			 , CR.EQP_NM	--설비명
			 , CM.CLNT_PJT	--프로젝트코드
			 , (SELECT FN_CM05M01_CD_TO_NM(CR.ORDRS_DTL_DIV20) FROM DUAL) AS NEW_CD_NM
			 , B3.CLNT_NM 				AS CLNT_NM
			 , A.MC_PART_CD
			 , A.IMPORTANT_CD
			 , A.IMPACT_CD
	         , (SELECT FN_CM05M01_CD_TO_NM(A.MC_PART_CD) FROM DUAL) AS MC_PART_CD_NM
	         , (SELECT FN_CM05M01_CD_TO_NM(A.IMPORTANT_CD) FROM DUAL) AS IMPORTANT_CD_NM
	         , (SELECT FN_CM05M01_CD_TO_NM(A.IMPACT_CD) FROM DUAL) AS IMPACT_CD_NM
			 , TO_CHAR(NVL(W1.DE_DT, CR.DUDT_INTEND_DT), 'YYYY-MM-DD') AS CUST_REQ_DT
        FROM   TB_WB24M02 AS A
               LEFT OUTER JOIN TB_WB22M01 AS P  ON P.CO_CD       = A.CO_CD
                                               AND P.WBS_PLAN_NO = A.WBS_PLAN_NO
                                               AND P.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_WB23M01 AS R  ON R.CO_CD       = A.CO_CD
                                               AND R.WBS_RSLTS_NO = A.WBS_RSLTS_NO
                                               AND R.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_WB24M03 AS S  ON S.ISS_NO = A.ISS_NO
               LEFT OUTER JOIN TB_CM06M01 AS U  ON U.ID = A.ACT_ID
               LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = A.WBS_PLAN_CODE_KIND
               LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.WBS_PLAN_CODE_ID
               LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = A.ISS_DIV
               LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = A.ISS_STS
               LEFT OUTER JOIN TB_CM06M01 AS U2  ON U2.ID = A.CREAT_ID
               LEFT OUTER JOIN TB_BM02M01 AS B2  ON B2.CLNT_CD = A.VEND_CD
               LEFT OUTER JOIN TB_QM01M01 AS Q  ON Q.REQ_NO = A.REQ_NO
		 	   LEFT OUTER JOIN TB_QM01P01 AS QP  ON QP.REQ_NO = Q.REQ_NO
		 	   LEFT OUTER JOIN TB_CR02D02 AS CR  ON CR.SALES_CD = A.SALES_CD
		 	   LEFT OUTER JOIN TB_CR02M01 AS CM  ON CM.CO_CD =  A.CO_CD  
		 	                                    AND CM.ORDRS_NO = CR.ORDRS_NO
               LEFT OUTER JOIN TB_BM02M01 AS B3 ON B3.CLNT_CD = CM.ORDRS_CLNT_CD
               LEFT OUTER JOIN
				               (
					                SELECT sum(CASE WHEN TODO_DIV2_CODE_ID = 'TODODIV2060' THEN 1 ELSE 0 END) AS  APP_CNT
					                	,  sum(CASE WHEN TODO_DIV2_CODE_ID = 'TODODIV2090' THEN 1 ELSE 0 END) AS  ACT_APP_CNT
					                	, MAX(TODO_NO) AS TODO_NO
					                FROM   TB_WB20M03
					                WHERE  1 = 1
					                AND    TODO_NO= (SELECT A.ISS_NO FROM TB_WB24M02 AS A WHERE  A.FILE_TRGT_KEY = #{fileTrgtKey})
					                AND    TODO_CF_DT IS NOT NULL
				               ) AS WB ON A.ISS_NO  =  WB.TODO_NO
			   LEFT OUTER JOIN (
									SELECT W1.*, ROW_NUMBER() OVER (PARTITION BY SALES_CD ORDER BY VER_NO DESC) AS rn
									FROM TB_WB21M01 W1
								) W1 ON W1.CO_CD = CR.CO_CD AND W1.SALES_CD = CR.SALES_CD AND W1.rn = 1  --마지막 버전의 과제정보 가져오기
        WHERE  1 = 1
        AND    A.FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

</mapper>
