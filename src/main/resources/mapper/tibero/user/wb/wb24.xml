<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb24.mapper.WB24Mapper">

     <select id="selectWbsIssueListCount" parameterType="Map" resultType="int">
           WITH SJD AS --수주상세 
                 ( 
                  SELECT M.CO_CD                                              AS CO_CD        --회사코드
                        , (SELECT FN_CM05M01_CD_TO_NM(M.CO_CD) FROM DUAL)     AS CO_NM        --회사명 
                        , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
                        , X.SALES_CD                                           AS SALES_CD     --SALES Code
                        , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
                        , C.CLNT_NM                                            AS CLNT_NM      --고객명
                        , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
                        , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
                        , X.PRDT_CD
                        , (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = X.PRDT_CD) AS PRDT_NM
                     FROM TB_CR02M01  M --수주마스터
                          INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
                          INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
                    WHERE 1=1
                      AND M.CO_CD = #{coCd}
                 )
               , PLAN AS --WBS 계획정보 
                 (
                  SELECT CO_CD                   AS CO_CD        --회사코드
                        , SALES_CD                AS SALES_CD     --SALSES_CD
                        , CLOSE_YN                AS CLOSE_YN     --마감여부 
                        , COUNT(WBS_PLAN_CODE_ID) AS PLAN_CODE_CNT--계획LVL1 수
                     FROM TB_WB22M01--WBS계획
                    WHERE CO_CD = #{coCd}
                      AND WBS_PLAN_CODE_KIND = 'WBSCODE'
                    GROUP BY CO_CD 
                            , SALES_CD
                            , CLOSE_YN
                 )
               , SUBJ AS --과제정보
                 (
                  SELECT X.FILE_TRGT_KEY
                       , X.CO_CD                                                       AS CO_CD              --회사코드
                       , X.SALES_CD                                                    AS SALES_CD           --SALES Code
                       , X.SJ_NO                                                       AS SJ_NO              --과제번호
                       , X.SJ_NM                                                       AS SJ_NM              --과제명
                       , X.VER_NO                                                      AS VER_NO             --버젼
                       , X.MKER_DIV                                                    AS MKER_DIV           --제작처구분
                       , (SELECT FN_CM05M01_CD_TO_NM(X.MKER_DIV) FROM DUAL)           AS MKER_DIV_NM        --제작처구분명 
                       , X.MKER_CD                                                     AS MKER_CD            --제작처코드
                       , BM.CLNT_NM                                                    AS MKER_NM            --제작처명
                       , X.SMRIZE_ID                                                   AS SMRIZE_ID          --총괄PM ID
                       , (SELECT FN_CM06M01_ID_TO_NM(X.SMRIZE_ID) FROM DUAL)          AS SMRIZE_NM          --총괄PM명
                       , TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD')                             AS BEGIN_DT           --시작일
                       , TO_CHAR(X.DE_DT, 'YYYY-MM-DD')                                AS DE_DT              --출고일
                       , TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD')                            AS ACPTNC_DT          --완료검수일
                       , TO_CHAR(X.REQRE_DAYCNT)                                       AS REQRE_DAYCNT       --소요일수
                       , X.CLOSE_YN                                                    AS CLOSE_YN           --확정유무
                       , X.DSGN_DIF_CODE_ID                                            AS DSGN_DIF_CODE_ID   --설계난이도
                       , (SELECT FN_CM05M01_CD_TO_NM(X.DSGN_DIF_CODE_ID) FROM DUAL)   AS DSGN_DIF_CODE_NM   --설계난이도
                       , X.DSGN_PLAN_HOUR                                              AS DSGN_PLAN_HOUR     --설계계획공수
                       , X.PRDCTN_DIF_CODE_ID                                          AS PRDCTN_DIF_CODE_ID --생산난이도
                       , (SELECT FN_CM05M01_CD_TO_NM(X.PRDCTN_DIF_CODE_ID) FROM DUAL) AS PRDCTN_DIF_CODE_NM --생산난이도
                       , X.PRDCTN_PLAN_HOUR                                            AS PRDCTN_PLAN_HOUR   --생산계획공수
                       , X.SJ_RMK                                                      AS SJ_RMK             --비고
                       , PL.PLAN_CODE_CNT                                              AS PLAN_CODE_CNT      --WBS 계획LVL1 TN
                       , PL.CLOSE_YN                                                   AS PLAN_CLOSE_YN      --WBS 계획 마감여부 
                    FROM TB_WB21M01 X
                         LEFT OUTER JOIN TB_BM02M01 AS BM ON X.MKER_CD = BM.CLNT_CD --거래처정보
                         LEFT OUTER JOIN PLAN       AS PL ON X.CO_CD = PL.CO_CD AND X.SALES_CD = PL.SALES_CD
                    WHERE X.CO_CD = #{coCd}
                       AND X.SALES_CD LIKE '%${salesCd}%'            
                       AND X.CLOSE_YN = 'Y'
                 ) 
                 SELECT COUNT(*) FROM (
                       SELECT ROWNUM AS RN, T.*, W.* FROM (      
                             SELECT T.* FROM (  
                                    SELECT T.*                        
                                      FROM (
                                            SELECT TO_CHAR(CR.CLNT_CD)||CR.ORDRS_NO  AS UPPER_CD     
                                                 , X.SJ_NO                            AS LOWER_CD    
                                                 , X.CO_CD                            AS CO_CD       
                                                 , CR.ORDRS_NO                        AS ORDRS_NO   
                                                 , CR.ORDRS_NO||'-'||TRIM(TO_CHAR(ROW_NUMBER() OVER(PARTITION BY CR.ORDRS_NO ORDER BY CR.ORDRS_NO, X.FILE_TRGT_KEY),'0000')) AS TITLE
                                                 , CR.CLNT_CD                         AS CLNT_CD     
                                                 , CR.CLNT_NM                         AS CLNT_NM     
                                                 , CR.CLNT_PJT                        AS CLNT_PJT     
                                                 , CR.CLNT_PJT_NM                     AS CLNT_PJT_NM 
                                                 , CR.PRDT_CD                         AS PRDT_CD     
                                                 , CR.PRDT_NM                         AS PRDT_NM 
                                                 , X.SJ_NO                            AS SJ_NO              
                                                 , X.SJ_NM                            AS SJ_NM               
                                                 , X.VER_NO                           AS VER_NO                
                                                 , X.CLOSE_YN                         AS SJ_CLOSE_YN          
                                                 , X.SALES_CD                         AS SALES_CD           
                                                 , X.PLAN_CODE_CNT                    AS PLAN_CODE_CNT     
                                                 , X.PLAN_CLOSE_YN                    AS PLAN_CLOSE_YN      
                                                 , X.MKER_DIV                         AS MKER_DIV          
                                                 , X.MKER_DIV_NM                      AS MKER_DIV_NM       
                                                 , X.MKER_CD                          AS MKER_CD           
                                                 , X.MKER_NM                          AS MKER_NM              
                                                 , X.SMRIZE_ID                        AS SMRIZE_ID         
                                                 , X.SMRIZE_NM                        AS SMRIZE_NM           
                                                 , X.BEGIN_DT                         AS BEGIN_DT              
                                                 , X.DE_DT                            AS DE_DT                 
                                                 , X.ACPTNC_DT                        AS ACPTNC_DT          
                                                 , X.REQRE_DAYCNT                     AS REQRE_DAYCNT      
                                                 , X.DSGN_DIF_CODE_ID                 AS DSGN_DIF_CODE_ID  
                                                 , X.DSGN_DIF_CODE_NM                 AS DSGN_DIF_CODE_NM  
                                                 , X.DSGN_PLAN_HOUR                   AS DSGN_PLAN_HOUR    
                                                 , X.PRDCTN_DIF_CODE_ID               AS PRDCTN_DIF_CODE_ID
                                                 , X.PRDCTN_DIF_CODE_NM               AS PRDCTN_DIF_CODE_NM
                                                 , X.PRDCTN_PLAN_HOUR                 AS PRDCTN_PLAN_HOUR 
                                                 , X.SJ_RMK                           AS SJ_RMK            
                                                 , X.FILE_TRGT_KEY                    AS FILE_TRGT_KEY     
                                              FROM SUBJ X
                                                   INNER JOIN SJD AS CR ON X.CO_CD = CR.CO_CD AND X.SALES_CD = CR.SALES_CD 
                                             WHERE 1=1
                                           ) T
                                      WHERE 1=1                              
                                      ORDER BY CLNT_NM, ORDRS_NO
                                      ) T ) T
                                      LEFT OUTER JOIN 
                                       (SELECT  CASE WHEN WBS_PLAN_NO IS NULL THEN '실적' ELSE '계획' END AS GBN_NM,                                        
                                             RSLTS_FILE_TRGT_KEY,
                                             FILE_TRGT_KEY,
                                             CO_CD,
                                             SALES_CD,
                                             WBS_PLAN_NO,
                                             WBS_RSLTS_NO,
                                             WBS_PLAN_CODE_KIND,
                                             WBS_PLAN_CODE_ID,
                                             WBS_PLAN_CODE_NM,
                                             WBS_DATES_DT,
                                             WBS_DATEE_DT,
                                             WBS_MNG_NM,
                                             RSLTS_CLOSE_YN,
                                             ISS_FILE_TRGT_KEY,
                                             ISS_NO,
                                             ISS_SJ,
                                             ISS_DIV,
                                             ISS_DIV_NM,
                                             ISS_STS,
                                             ISS_STS_NM ,
                                             ISS_CNTS,
                                             ACT_ID,
                                             ACT_NM,
                                             ACTS_DT,
                                             ACTE_DT,
                                             ACT_MH,
                                             ACT_AMT,
                                             ACT_CNTS
                                             FROM (      
                                                      SELECT X.FILE_TRGT_KEY AS RSLTS_FILE_TRGT_KEY,
                                                                '' AS FILE_TRGT_KEY,
                                                                X.CO_CD,
                                                                X.SALES_CD,
                                                                '' AS WBS_PLAN_NO,
                                                                X.WBS_RSLTS_NO,
                                                                X.WBS_PLAN_CODE_KIND,
                                                                X.WBS_PLAN_CODE_ID,
                                                                Y.WBS_PLAN_CODE_NM,
                                                                TO_CHAR(X.WBS_RSLTSS_DT, 'YYYY-MM-DD') AS WBS_DATES_DT,
                                                                TO_CHAR(X.WBS_RSLTSE_DT, 'YYYY-MM-DD') AS WBS_DATEE_DT,
                                                                (SELECT FN_CM06M01_ID_TO_NM(X.WBS_RSLTS_ID) FROM DUAL) AS WBS_MNG_NM,
                                                                X.CLOSE_YN AS RSLTS_CLOSE_YN,
                                                                A.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
                                                                A.ISS_NO,
                                                                A.ISS_SJ,
                                                                A.ISS_DIV,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
                                                                A.ISS_STS,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_STS) FROM DUAL) AS ISS_STS_NM,
                                                                A.ISS_CNTS,
                                                                A.ACT_ID,
                                                                (SELECT FN_CM06M01_ID_TO_NM(A.ACT_ID) FROM DUAL) AS ACT_NM,
                                                                TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
                                                                TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
                                                                A.ACT_MH,
                                                                A.ACT_AMT,
                                                                A.ACT_CNTS
                                                                FROM TB_WB23M01 X   
                                                                INNER JOIN TB_WB22M01 Y
                                                                ON X.CO_CD = Y.CO_CD
                                                                AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND
                                                                AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
                                                                AND X.SALES_CD = Y.SALES_CD                                               
                                                                LEFT OUTER JOIN 
                                                                (SELECT A1.FILE_TRGT_KEY,
                                                                        A1.CO_CD,
                                                                        A1.WBS_PLAN_CODE_KIND,
                                                                        A1.WBS_PLAN_CODE_ID,
                                                                        A1.ISS_NO,
                                                                        A1.ISS_SJ,
                                                                        A1.ISS_DIV,
                                                                        A1.ISS_CNTS,
                                                                        A1.ISS_STS,
                                                                        A1.ACT_ID,
                                                                        A1.WBS_PLAN_NO,
                                                                        A1.WBS_RSLTS_NO,
                                                                        A1.SALES_CD,
                                                                        A2.ACTS_DT,
                                                                        A2.ACTE_DT,
                                                                        A2.ACT_MH,
                                                                        A2.ACT_AMT,
                                                                        A2.ACT_CNTS 
                                                                        FROM TB_WB24M02 A1
                                                                        INNER JOIN TB_WB24M03 A2
                                                                        ON A1.ISS_NO = A2.ISS_NO ) A
                                                                ON X.CO_CD = A.CO_CD
                                                                AND X.WBS_PLAN_CODE_KIND = A.WBS_PLAN_CODE_KIND
                                                                AND X.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
                                                                AND X.SALES_CD = A.SALES_CD
                                                                AND X.WBS_RSLTS_NO = A.WBS_RSLTS_NO    
                                                     UNION ALL
                                                     SELECT  '' AS RSLTS_FILE_TRGT_KEY,
                                                                X.FILE_TRGT_KEY,
                                                                X.CO_CD,
                                                                X.SALES_CD,
                                                                X.WBS_PLAN_NO,
                                                                '' AS WBS_RSLTS_NO,
                                                                X.WBS_PLAN_CODE_KIND,
                                                                X.WBS_PLAN_CODE_ID,
                                                                X.WBS_PLAN_CODE_NM,
                                                                TO_CHAR(X.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_DATES_DT,
                                                                TO_CHAR(X.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_DATEE_DT,
                                                                (SELECT FN_CM06M01_ID_TO_NM(X.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_MNG_NM,                                                                
                                                                'N' AS RSLTS_CLOSE_YN,
                                                                A.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
                                                                A.ISS_NO,
                                                                A.ISS_SJ,
                                                                A.ISS_DIV,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
                                                                A.ISS_STS,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_STS) FROM DUAL) AS ISS_STS_NM,
                                                                A.ISS_CNTS,
                                                                A.ACT_ID,
                                                                (SELECT FN_CM06M01_ID_TO_NM(A.ACT_ID) FROM DUAL) AS ACT_NM,
                                                                TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
                                                                TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
                                                                A.ACT_MH,
                                                                A.ACT_AMT,
                                                                A.ACT_CNTS
                                                                FROM TB_WB22M01 X                                                      
                                                                LEFT OUTER JOIN 
                                                                (SELECT A1.FILE_TRGT_KEY,
                                                                        A1.CO_CD,
																	    A1.WBS_PLAN_CODE_KIND,
																	    A1.WBS_PLAN_CODE_ID,
																	    A1.ISS_NO,
																	    A1.ISS_SJ,
																	    A1.ISS_DIV,
																	    A1.ISS_CNTS,
																	    A1.ISS_STS,
																	    A1.ACT_ID,
																	    A1.WBS_PLAN_NO,
																	    A1.WBS_RSLTS_NO,
																	    A1.SALES_CD,
																	    A2.ACTS_DT,
																	    A2.ACTE_DT,
																	    A2.ACT_MH,
																	    A2.ACT_AMT,
																	    A2.ACT_CNTS	
																	    FROM TB_WB24M02 A1
																	    INNER JOIN TB_WB24M03 A2
																	    ON A1.ISS_NO = A2.ISS_NO ) A
															    ON X.CO_CD = A.CO_CD
                                                                AND X.WBS_PLAN_CODE_KIND = A.WBS_PLAN_CODE_KIND
                                                                AND X.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
                                                                AND X.SALES_CD = A.SALES_CD
                                                                AND X.WBS_PLAN_NO = A.WBS_PLAN_NO
                                                                WHERE X.WBS_PLAN_CODE_NM IS NOT NULL ) X
                                                           ORDER BY SALES_CD, WBS_PLAN_CODE_ID,CASE WHEN WBS_PLAN_NO IS NULL THEN '실적' ELSE '계획' END  ASC
                                                         ) W
                                         ON T.CO_CD = W.CO_CD
                                         AND T.SALES_CD = W.SALES_CD
                                         WHERE T.CO_CD = #{coCd}      
                                         --AND W.RSLTS_CLOSE_YN = 'Y'                                  
                                         <if test="salesCd != null and !salesCd.equals('')">
                                         AND T.SALES_CD LIKE '%${salesCd}%'            
                                         </if>
                                         <if test="issSts != null and !issSts.equals('')">
                                         AND W.ISS_STS = #{issSts}            
                                         </if>
                                         <if test="clntPjt != null and !clntPjt.equals('')">
                                         AND T.CLNT_PJT = #{clntPjt}            
                                         </if>
                                         AND W.WBS_DATES_DT BETWEEN #{wbsRsltssDt} AND #{wbsRsltseDt}
                                   ) W  
                                 
          </select>


     <select id="selectWbsIssueList" parameterType="Map" resultType="camelMap">
            WITH SJD AS --수주상세 
                 ( 
                  SELECT M.CO_CD                                              AS CO_CD        --회사코드
                        , (SELECT FN_CM05M01_CD_TO_NM(M.CO_CD) FROM DUAL)     AS CO_NM        --회사명 
                        , M.ORDRS_NO                                           AS ORDRS_NO     --수주번호
                        , X.SALES_CD                                           AS SALES_CD     --SALES Code
                        , M.ORDRS_CLNT_CD                                      AS CLNT_CD      --고객코드
                        , C.CLNT_NM                                            AS CLNT_NM      --고객명
                        , M.CLNT_PJT                                           AS CLNT_PJT     --고객사프로젝트 
                        , (SELECT FN_CM05M01_CD_TO_NM(M.CLNT_PJT) FROM DUAL)  AS CLNT_PJT_NM  --고객사프로젝트명
                        , X.PRDT_CD
                        , (SELECT T.PRDT_NM FROM TB_BM01M01 T WHERE T.PRDT_CD = X.PRDT_CD) AS PRDT_NM
                     FROM TB_CR02M01  M --수주마스터
                          INNER JOIN TB_CR02D02 AS X ON X.CO_CD = M.CO_CD AND X.ORDRS_NO = M.ORDRS_NO--수주상세   
                          INNER JOIN TB_BM02M01 AS C ON M.ORDRS_CLNT_CD = C.CLNT_CD --거래처정보
                    WHERE 1=1
                      AND M.CO_CD = #{coCd}
                 )
               , PLAN AS --WBS 계획정보 
                 (
                  SELECT CO_CD                   AS CO_CD        --회사코드
                        , SALES_CD                AS SALES_CD     --SALSES_CD
                        , CLOSE_YN                AS CLOSE_YN     --마감여부 
                        , COUNT(WBS_PLAN_CODE_ID) AS PLAN_CODE_CNT--계획LVL1 수
                     FROM TB_WB22M01--WBS계획
                    WHERE CO_CD = #{coCd}
                      AND WBS_PLAN_CODE_KIND = 'WBSCODE'
                    GROUP BY CO_CD 
                            , SALES_CD
                            , CLOSE_YN
                 )
               , SUBJ AS --과제정보
                 (
                  SELECT X.FILE_TRGT_KEY
                       , X.CO_CD                                                       AS CO_CD              --회사코드
                       , X.SALES_CD                                                    AS SALES_CD           --SALES Code
                       , X.SJ_NO                                                       AS SJ_NO              --과제번호
                       , X.SJ_NM                                                       AS SJ_NM              --과제명
                       , X.VER_NO                                                      AS VER_NO             --버젼
                       , X.MKER_DIV                                                    AS MKER_DIV           --제작처구분
                       , (SELECT FN_CM05M01_CD_TO_NM(X.MKER_DIV) FROM DUAL)           AS MKER_DIV_NM        --제작처구분명 
                       , X.MKER_CD                                                     AS MKER_CD            --제작처코드
                       , BM.CLNT_NM                                                    AS MKER_NM            --제작처명
                       , X.SMRIZE_ID                                                   AS SMRIZE_ID          --총괄PM ID
                       , (SELECT FN_CM06M01_ID_TO_NM(X.SMRIZE_ID) FROM DUAL)          AS SMRIZE_NM          --총괄PM명
                       , TO_CHAR(X.BEGIN_DT, 'YYYY-MM-DD')                             AS BEGIN_DT           --시작일
                       , TO_CHAR(X.DE_DT, 'YYYY-MM-DD')                                AS DE_DT              --출고일
                       , TO_CHAR(X.ACPTNC_DT, 'YYYY-MM-DD')                            AS ACPTNC_DT          --완료검수일
                       , TO_CHAR(X.REQRE_DAYCNT)                                       AS REQRE_DAYCNT       --소요일수
                       , X.CLOSE_YN                                                    AS CLOSE_YN           --확정유무
                       , X.DSGN_DIF_CODE_ID                                            AS DSGN_DIF_CODE_ID   --설계난이도
                       , (SELECT FN_CM05M01_CD_TO_NM(X.DSGN_DIF_CODE_ID) FROM DUAL)   AS DSGN_DIF_CODE_NM   --설계난이도
                       , X.DSGN_PLAN_HOUR                                              AS DSGN_PLAN_HOUR     --설계계획공수
                       , X.PRDCTN_DIF_CODE_ID                                          AS PRDCTN_DIF_CODE_ID --생산난이도
                       , (SELECT FN_CM05M01_CD_TO_NM(X.PRDCTN_DIF_CODE_ID) FROM DUAL) AS PRDCTN_DIF_CODE_NM --생산난이도
                       , X.PRDCTN_PLAN_HOUR                                            AS PRDCTN_PLAN_HOUR   --생산계획공수
                       , X.SJ_RMK                                                      AS SJ_RMK             --비고
                       , PL.PLAN_CODE_CNT                                              AS PLAN_CODE_CNT      --WBS 계획LVL1 TN
                       , PL.CLOSE_YN                                                   AS PLAN_CLOSE_YN      --WBS 계획 마감여부 
                    FROM TB_WB21M01 X
                         LEFT OUTER JOIN TB_BM02M01 AS BM ON X.MKER_CD = BM.CLNT_CD --거래처정보
                         LEFT OUTER JOIN PLAN       AS PL ON X.CO_CD = PL.CO_CD AND X.SALES_CD = PL.SALES_CD
                    WHERE X.CO_CD = #{coCd}
                       AND X.SALES_CD LIKE '%${salesCd}%'            
                       AND X.CLOSE_YN = 'Y'
                 ) 
                 SELECT * FROM (
		               SELECT ROWNUM AS RN, T.*, W.* FROM (      
		                     SELECT T.* FROM (  
		                            SELECT T.*                        
		                              FROM (
		                                    SELECT TO_CHAR(CR.CLNT_CD)||CR.ORDRS_NO  AS UPPER_CD     
		                                         , X.SJ_NO                            AS LOWER_CD    
		                                         , X.CO_CD                            AS CO_CD       
		                                         , CR.ORDRS_NO                        AS ORDRS_NO   
		                                         , CR.ORDRS_NO||'-'||TRIM(TO_CHAR(ROW_NUMBER() OVER(PARTITION BY CR.ORDRS_NO ORDER BY CR.ORDRS_NO, X.FILE_TRGT_KEY),'0000')) AS TITLE
		                                         , CR.CLNT_CD                         AS CLNT_CD     
		                                         , CR.CLNT_NM                         AS CLNT_NM     
		                                         , CR.CLNT_PJT                        AS CLNT_PJT     
		                                         , CR.CLNT_PJT_NM                     AS CLNT_PJT_NM 
		                                         , CR.PRDT_CD                         AS PRDT_CD     
		                                         , CR.PRDT_NM                         AS PRDT_NM 
		                                         , X.SJ_NO                            AS SJ_NO              
		                                         , X.SJ_NM                            AS SJ_NM               
		                                         , X.VER_NO                           AS VER_NO                
		                                         , X.CLOSE_YN                         AS SJ_CLOSE_YN          
		                                         , X.SALES_CD                         AS SALES_CD           
		                                         , X.PLAN_CODE_CNT                    AS PLAN_CODE_CNT     
		                                         , X.PLAN_CLOSE_YN                    AS PLAN_CLOSE_YN      
		                                         , X.MKER_DIV                         AS MKER_DIV          
		                                         , X.MKER_DIV_NM                      AS MKER_DIV_NM       
		                                         , X.MKER_CD                          AS MKER_CD           
		                                         , X.MKER_NM                          AS MKER_NM              
		                                         , X.SMRIZE_ID                        AS SMRIZE_ID         
		                                         , X.SMRIZE_NM                        AS SMRIZE_NM           
		                                         , X.BEGIN_DT                         AS BEGIN_DT              
		                                         , X.DE_DT                            AS DE_DT                 
		                                         , X.ACPTNC_DT                        AS ACPTNC_DT          
		                                         , X.REQRE_DAYCNT                     AS REQRE_DAYCNT      
		                                         , X.DSGN_DIF_CODE_ID                 AS DSGN_DIF_CODE_ID  
		                                         , X.DSGN_DIF_CODE_NM                 AS DSGN_DIF_CODE_NM  
		                                         , X.DSGN_PLAN_HOUR                   AS DSGN_PLAN_HOUR    
		                                         , X.PRDCTN_DIF_CODE_ID               AS PRDCTN_DIF_CODE_ID
		                                         , X.PRDCTN_DIF_CODE_NM               AS PRDCTN_DIF_CODE_NM
		                                         , X.PRDCTN_PLAN_HOUR                 AS PRDCTN_PLAN_HOUR 
		                                         , X.SJ_RMK                           AS SJ_RMK            
		                                         , X.FILE_TRGT_KEY                    AS FILE_TRGT_KEY     
		                                      FROM SUBJ X
		                                           INNER JOIN SJD AS CR ON X.CO_CD = CR.CO_CD AND X.SALES_CD = CR.SALES_CD 
		                                     WHERE 1=1
		                                   ) T
		                              WHERE 1=1                              
		                              ORDER BY CLNT_NM, ORDRS_NO
		                              ) T ) T
		                              LEFT OUTER JOIN 
		                               (SELECT  CASE WHEN WBS_PLAN_NO IS NULL THEN '실적' ELSE '계획' END AS GBN_NM,                                        
		                                     RSLTS_FILE_TRGT_KEY,
		                                     FILE_TRGT_KEY,
		                                     CO_CD,
		                                     SALES_CD,
		                                     WBS_PLAN_NO,
		                                     WBS_RSLTS_NO,
		                                     WBS_PLAN_CODE_KIND,
		                                     WBS_PLAN_CODE_ID,
		                                     WBS_PLAN_CODE_NM,
		                                     WBS_DATES_DT,
		                                     WBS_DATEE_DT,
		                                     WBS_MNG_NM,
		                                     RSLTS_CLOSE_YN,
		                                     ISS_FILE_TRGT_KEY,
		                                     ISS_NO,
		                                     ISS_SJ,
		                                     ISS_DIV,
		                                     ISS_DIV_NM,
		                                     ISS_STS,
		                                     ISS_STS_NM ,
		                                     ISS_CNTS,
		                                     ACT_ID,
		                                     ACT_NM,
		                                     ACTS_DT,
		                                     ACTE_DT,
		                                     ACT_MH,
		                                     ACT_AMT,
		                                     ACT_CNTS
		                                     FROM (      
		                                               SELECT X.FILE_TRGT_KEY AS RSLTS_FILE_TRGT_KEY,
                                                                '' AS FILE_TRGT_KEY,
                                                                X.CO_CD,
                                                                X.SALES_CD,
                                                                '' AS WBS_PLAN_NO,
                                                                X.WBS_RSLTS_NO,
                                                                X.WBS_PLAN_CODE_KIND,
                                                                X.WBS_PLAN_CODE_ID,
                                                                Y.WBS_PLAN_CODE_NM,
                                                                TO_CHAR(X.WBS_RSLTSS_DT, 'YYYY-MM-DD') AS WBS_DATES_DT,
                                                                TO_CHAR(X.WBS_RSLTSE_DT, 'YYYY-MM-DD') AS WBS_DATEE_DT,
                                                                (SELECT FN_CM06M01_ID_TO_NM(X.WBS_RSLTS_ID) FROM DUAL) AS WBS_MNG_NM,
                                                                X.CLOSE_YN AS RSLTS_CLOSE_YN,
                                                                A.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
                                                                A.ISS_NO,
                                                                A.ISS_SJ,
                                                                A.ISS_DIV,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
                                                                A.ISS_STS,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_STS) FROM DUAL) AS ISS_STS_NM,
                                                                A.ISS_CNTS,
                                                                A.ACT_ID,
                                                                (SELECT FN_CM06M01_ID_TO_NM(A.ACT_ID) FROM DUAL) AS ACT_NM,
                                                                TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
                                                                TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
                                                                A.ACT_MH,
                                                                A.ACT_AMT,
                                                                A.ACT_CNTS
                                                                FROM TB_WB23M01 X   
                                                                INNER JOIN TB_WB22M01 Y
                                                                ON X.CO_CD = Y.CO_CD
                                                                AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND
                                                                AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
                                                                AND X.SALES_CD = Y.SALES_CD                                               
                                                                LEFT OUTER JOIN 
                                                                (SELECT A1.FILE_TRGT_KEY,
                                                                        A1.CO_CD,
                                                                        A1.WBS_PLAN_CODE_KIND,
                                                                        A1.WBS_PLAN_CODE_ID,
                                                                        A1.ISS_NO,
                                                                        A1.ISS_SJ,
                                                                        A1.ISS_DIV,
                                                                        A1.ISS_CNTS,
                                                                        A1.ISS_STS,
                                                                        A1.ACT_ID,
                                                                        A1.WBS_PLAN_NO,
                                                                        A1.WBS_RSLTS_NO,
                                                                        A1.SALES_CD,
                                                                        A2.ACTS_DT,
                                                                        A2.ACTE_DT,
                                                                        A2.ACT_MH,
                                                                        A2.ACT_AMT,
                                                                        A2.ACT_CNTS 
                                                                        FROM TB_WB24M02 A1
                                                                        INNER JOIN TB_WB24M03 A2
                                                                        ON A1.ISS_NO = A2.ISS_NO ) A
                                                                ON X.CO_CD = A.CO_CD
                                                                AND X.WBS_PLAN_CODE_KIND = A.WBS_PLAN_CODE_KIND
                                                                AND X.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
                                                                AND X.SALES_CD = A.SALES_CD
                                                                AND X.WBS_RSLTS_NO = A.WBS_RSLTS_NO    
                                                     UNION ALL
                                                     SELECT  '' AS RSLTS_FILE_TRGT_KEY,
                                                                X.FILE_TRGT_KEY,
                                                                X.CO_CD,
                                                                X.SALES_CD,
                                                                X.WBS_PLAN_NO,
                                                                '' AS WBS_RSLTS_NO,
                                                                X.WBS_PLAN_CODE_KIND,
                                                                X.WBS_PLAN_CODE_ID,
                                                                X.WBS_PLAN_CODE_NM,
                                                                TO_CHAR(X.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_DATES_DT,
                                                                TO_CHAR(X.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_DATEE_DT,
                                                                (SELECT FN_CM06M01_ID_TO_NM(X.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_MNG_NM,                                                                
                                                                'N' AS RSLTS_CLOSE_YN,
                                                                A.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
                                                                A.ISS_NO,
                                                                A.ISS_SJ,
                                                                A.ISS_DIV,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
                                                                A.ISS_STS,
                                                                (SELECT FN_CM05M01_CD_TO_NM(A.ISS_STS) FROM DUAL) AS ISS_STS_NM,
                                                                A.ISS_CNTS,
                                                                A.ACT_ID,
                                                                (SELECT FN_CM06M01_ID_TO_NM(A.ACT_ID) FROM DUAL) AS ACT_NM,
                                                                TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
                                                                TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
                                                                A.ACT_MH,
                                                                A.ACT_AMT,
                                                                A.ACT_CNTS
                                                                FROM TB_WB22M01 X                                                      
                                                                LEFT OUTER JOIN 
                                                                (SELECT A1.FILE_TRGT_KEY,
                                                                        A1.CO_CD,
                                                                        A1.WBS_PLAN_CODE_KIND,
                                                                        A1.WBS_PLAN_CODE_ID,
                                                                        A1.ISS_NO,
                                                                        A1.ISS_SJ,
                                                                        A1.ISS_DIV,
                                                                        A1.ISS_CNTS,
                                                                        A1.ISS_STS,
                                                                        A1.ACT_ID,
                                                                        A1.WBS_PLAN_NO,
                                                                        A1.WBS_RSLTS_NO,
                                                                        A1.SALES_CD,
                                                                        A2.ACTS_DT,
                                                                        A2.ACTE_DT,
                                                                        A2.ACT_MH,
                                                                        A2.ACT_AMT,
                                                                        A2.ACT_CNTS 
                                                                        FROM TB_WB24M02 A1
                                                                        INNER JOIN TB_WB24M03 A2
                                                                        ON A1.ISS_NO = A2.ISS_NO ) A
                                                                ON X.CO_CD = A.CO_CD
                                                                AND X.WBS_PLAN_CODE_KIND = A.WBS_PLAN_CODE_KIND
                                                                AND X.WBS_PLAN_CODE_ID = A.WBS_PLAN_CODE_ID
                                                                AND X.SALES_CD = A.SALES_CD
                                                                AND X.WBS_PLAN_NO = A.WBS_PLAN_NO
                                                                WHERE X.WBS_PLAN_CODE_NM IS NOT NULL  ) X
		                                                   ORDER BY SALES_CD, WBS_PLAN_CODE_ID,CASE WHEN WBS_PLAN_NO IS NULL THEN '실적' ELSE '계획' END  ASC
                                                         ) W
		                                 ON T.CO_CD = W.CO_CD
		                                 AND T.SALES_CD = W.SALES_CD
		                                 WHERE T.CO_CD = #{coCd}      
		                                 --AND W.RSLTS_CLOSE_YN = 'Y'                                  
		                                 <if test="salesCd != null and !salesCd.equals('')">
		                                 AND T.SALES_CD LIKE '%${salesCd}%'            
		                                 </if>
		                                 <if test="issSts != null and !issSts.equals('')">
                                         AND W.ISS_STS = #{issSts}            
                                         </if>
                                         <if test="clntPjt != null and !clntPjt.equals('')">
                                         AND T.CLNT_PJT = #{clntPjt}            
                                         </if>
		                                 AND W.WBS_DATES_DT BETWEEN #{wbsRsltssDt} AND #{wbsRsltseDt}
		                           ) W
		                           WHERE RN BETWEEN #{firstIndex} AND #{lastIndex}       
                                 
                                          
		  </select>
		  
		  <select id="selectMaxWbsIssueNo" parameterType="Map"  resultType="camelMap">
              SELECT  #{year} || trim(to_char(nvl(SUBSTR(MAX(ISS_NO), 6, 4),0) + 1, '0000')) AS ISS_NO FROM TB_WB24M02 
              WHERE CO_CD = #{coCd}   
          </select>
        
          <select id="selectWbsIssueSeqNext" parameterType="Map" resultType="int">
             SELECT TB_WB24M02_SQ01.NEXTVAL FROM DUAL
          </select>
        
          <insert id="wbsIssueInsert" parameterType="Map">
                INSERT INTO TB_WB24M02
                (
                    FILE_TRGT_KEY,
				    CO_CD,
				    WBS_PLAN_CODE_KIND,
				    WBS_PLAN_CODE_ID,
				    ISS_NO,
				    ISS_SJ,
				    ISS_DIV,
				    ISS_CNTS,
				    ISS_STS,
				    ACT_ID,
				    WBS_PLAN_NO,
				    WBS_RSLTS_NO,
				    SALES_CD,
				    CREAT_ID,
				    CREAT_PGM,
				    CREAT_DTTM
                ) 
                VALUES
                (
                    #{issFileTrgtKey},
                    #{coCd},
                    #{wbsPlanCodeKind},
                    #{wbsPlanCodeId},
                    #{issNo},
                    #{issSj},
                    #{issDiv},
                    #{issCnts},
                    #{issSts},
                    #{actId},
                    #{wbsPlanNo},
                    #{wbsRsltsNo},
                    #{salesCd},
                    #{userId},
                    #{pgmId},
                    SYSDATE
                )
            </insert>
            
            <insert id="wbsActInsert" parameterType="Map">
                <selectKey keyProperty="fileTrgtKey" resultType="Int" order="BEFORE">
                    SELECT NVL(MAX(TO_NUMBER(NVL(FILE_TRGT_KEY,'0'))),0) + 1 FROM TB_WB24M03
                </selectKey>
                INSERT INTO TB_WB24M03
                (
                    FILE_TRGT_KEY,
                    ISS_NO,
                    ACTS_DT,
                    ACTE_DT,
                    ACT_MH,
                    ACT_AMT,
                    ACT_CNTS,
                    CREAT_ID,
                    CREAT_PGM,
                    CREAT_DTTM
                ) 
                VALUES
                (
                    #{fileTrgtKey},
                    #{issNo},
                    #{actsDt},
                    #{acteDt},
                    #{actMh},
                    #{actAmt},
                    #{actCnts},
                    #{userId},
                    #{pgmId},
                    SYSDATE
                )
            </insert>
            
            <update id="wbsIssueUpdate" parameterType="Map">
                UPDATE TB_WB24M02
	                    SET ISS_SJ = #{issSj},
	                        ISS_DIV = #{issDiv},
		                    ISS_CNTS = #{issCnts},
		                    ISS_STS = #{issSts},
		                    ACT_ID = #{actId},
		                    UDT_ID = #{userId},
	                        UDT_PGM = #{pgmId},
	                        UDT_DTTM = SYSDATE     
                    WHERE FILE_TRGT_KEY =  #{issFileTrgtKey}   
            </update>   
         
         
           <update id="wbsActUpdate" parameterType="Map">
                UPDATE TB_WB24M03
                        SET ACTS_DT = #{actsDt},
                            ACTE_DT = #{acteDt},
                            ACT_MH = #{actMh},
                            ACT_AMT = #{actAmt},
                            ACT_CNTS = #{actCnts},
                            UDT_ID = #{userId},
                            UDT_PGM = #{pgmId},
                            UDT_DTTM = SYSDATE     
                    WHERE ISS_NO =  #{issNo}   
            </update>    
            
            <select id="selectTodoRsltsView" parameterType="Map" resultType="camelMap">          
                SELECT  X.FILE_TRGT_KEY AS ISS_FILE_TRGT_KEY,
			            X.CO_CD,
			            X.WBS_PLAN_CODE_KIND,
			            X.WBS_PLAN_CODE_ID,
			            P1.WBS_PLAN_CODE_NM,
			            X.ISS_SJ,
			            X.ISS_NO,
			            X.ISS_DIV,
			            (SELECT FN_CM05M01_CD_TO_NM(X.ISS_DIV) FROM DUAL) AS ISS_DIV_NM,
			            X.ISS_CNTS,
			            X.ISS_STS,
			            (SELECT FN_CM05M01_CD_TO_NM(X.ISS_STS) FROM DUAL) AS ISS_STS_NM,
			            X.ACT_ID,
			            (SELECT FN_CM06M01_ID_TO_NM(X.ACT_ID) FROM DUAL) AS ACT_NM,
			            TO_CHAR(A.ACTS_DT, 'YYYY-MM-DD') AS ACTS_DT,
			            TO_CHAR(A.ACTE_DT, 'YYYY-MM-DD') AS ACTE_DT,
			            A.ACT_MH,
			            A.ACT_AMT,
			            A.ACT_CNTS,
			            X.SALES_CD,
			            Y.WBS_RSLTS_NO,
			            Y.WBS_RSLTS_ID,
			            (SELECT FN_CM06M01_ID_TO_NM(Y.WBS_RSLTS_ID) FROM DUAL) AS WBS_RSLTS_NM,
			            TO_CHAR(Y.WBS_RSLTSS_DT, 'YYYY-MM-DD') AS WBS_RSLTSS_DT,
			            TO_CHAR(Y.WBS_RSLTSE_DT, 'YYYY-MM-DD') AS WBS_RSLTSE_DT,
			            
			            (SELECT FN_CM06M01_ID_TO_NM(P.WBS_PLAN_MNG_ID) FROM DUAL) AS WBS_PLAN_MNG_NM,
                        TO_CHAR(P.WBS_PLANS_DT, 'YYYY-MM-DD') AS WBS_PLANS_DT,
                        TO_CHAR(P.WBS_PLANE_DT, 'YYYY-MM-DD') AS WBS_PLANE_DT
                        
                        
			            FROM TB_WB24M02 X
			            
			            LEFT OUTER JOIN TB_WB23M01 Y
			            ON X.CO_CD = Y.CO_CD
			            AND X.WBS_PLAN_CODE_KIND = Y.WBS_PLAN_CODE_KIND 
			            AND X.WBS_PLAN_CODE_ID = Y.WBS_PLAN_CODE_ID
			            AND X.SALES_CD = Y.SALES_CD
			            AND X.WBS_RSLTS_NO = Y.WBS_RSLTS_NO
			            
			            LEFT OUTER JOIN TB_WB22M01 P
                        ON X.CO_CD = P.CO_CD
                        AND X.WBS_PLAN_CODE_KIND = P.WBS_PLAN_CODE_KIND 
                        AND X.WBS_PLAN_CODE_ID = P.WBS_PLAN_CODE_ID
                        AND X.SALES_CD = P.SALES_CD
                        AND X.WBS_PLAN_NO = P.WBS_PLAN_NO
                        
                        LEFT OUTER JOIN TB_WB22M01 P1
                        ON X.CO_CD = P1.CO_CD
                        AND X.WBS_PLAN_CODE_KIND = P1.WBS_PLAN_CODE_KIND 
                        AND X.WBS_PLAN_CODE_ID = P1.WBS_PLAN_CODE_ID
                        AND X.SALES_CD = P1.SALES_CD
                        
                        
                        
			            LEFT OUTER JOIN TB_WB24M03 A
			            ON X.ISS_NO = A.ISS_NO 
			            WHERE X.FILE_TRGT_KEY = #{fileTrgtKey}
          </select>
          
          
         
</mapper>
