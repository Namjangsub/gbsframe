<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb20.mapper.WB20Mapper">

          <!-- ToDo List  메인 화면 조회 카운터  -->
          <select id="selectToDoCount" parameterType="Map" resultType="int">
                SELECT COUNT(*) FROM (
                    SELECT ROWNUM AS RN, Z.* FROM (
                               SELECT 
                                    TODO_KEY,
                                    X.CO_CD,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS CO_CD_NM,
                                    TODO_DIV1_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM,
                                    TODO_DIV2_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_DIV2_CODE_ID) AS TODO_DIV2_CODE_NM,
                                    TODO_ID,
                                    (SELECT Y.WBS_PLAN_CNTS FROM TB_WB01M01 Y WHERE Y.CO_CD = X.CO_CD 
                                              AND Y.WBS_PLAN_CODE_KIND = X.WBS_PLAN_CODE_KIND
                                              AND Y.WBS_PLAN_CODE_ID = X.WBS_PLAN_CODE_ID
                                              AND Y.WBS_PLAN_NO = X.WBS_PLAN_NO
                                              AND Y.SALES_CD = Y.SALES_CD) AS WBS_PLAN_CNTS, -- TO-DO LIST 주요내용
                                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.TODO_ID) AS TODO_NM,
                                    NULL AS TODO_CHK,
                                    TO_CHAR(X.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT,
                                    TODO_CF_OPN,
                                    X.SALES_CD,
                                    X.PG_PATH,
                                    X.WBS_PLANCO_CD,
                                    X.WBS_PLAN_NO,
                                    X.WBS_PLAN_CODE_KIND,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_CODE_KIND) AS WBS_PLAN_CODE_KIND_NM,
                                    X.WBS_PLAN_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_CODE_ID) AS WBS_PLAN_CODE_NM,
                                    WBS_RSLTS_CO_CD,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS WBS_RSLTS_CO_CD_NM,
                                    WBS_RSLTS_PLAN_NO,
                                    WBS_RSLTS_PLAN_CODE_KIND,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_RSLTS_PLAN_CODE_KIND) AS WBS_RSLTS_PLAN_CODE_KIND_NM,
                                    WBS_RSLTS_PLAN_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_RSLTS_PLAN_CODE_ID) AS WBS_RSLTS_PLAN_CODE_ID_NM,
                                    X.CREAT_ID,
                                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CREAT_ID) AS CREAT_NM,
                                    X.CREAT_PGM,
                                    TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM,
                                    TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD') AS COMP_CREAT_DTTM,
                                    X.UDT_ID,
                                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.UDT_ID) AS UDT_NM,
                                    X.UDT_PGM,
                                    TO_CHAR(X.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM
                                    FROM TB_WB20M01 X                                            
                                 ORDER BY TODO_KEY ASC ) Z )                                 
                                 WHERE CO_CD = '${coCd}'
                                 AND COMP_CREAT_DTTM BETWEEN '${wbsPlansDt}' AND '${wbsPlaneDt}' 
                                 <if test="salesCd != null and !salesCd.equals('')">
                                    AND SALES_CD LIKE '%${salesCd}%' <!--  salescode 검색    -->  
                                 </if>
                                 <if test="clntCd != null and !clntCd.equals('')">
                                     AND ORDRS_CLNT_CD LIKE '%${clntCd}%' <!--  고객사 검색    -->               
                                 </if>
                                 <if test="prdtDiv != null and !prdtDiv.equals('')">
                                    AND PRDT_CD LIKE '%${prdtDiv}%' <!--  제품구분 검색    -->               
                                 </if>
                                 <if test="prdtItem != null and !prdtItem.equals('')">
                                    AND ITEM_DIV LIKE '%${prdtItem}%'  <!--  아이템구분 검색    -->              
                                 </if> 
                                 <if test="wbsClntPjt != null and !wbsClntPjt.equals('')">
                                    AND CLNT_PJT LIKE '%${wbsClntPjt}%'  <!--  고객사 PJT 검색    -->              
                                 </if> 
                                 <if test="eqp_nm != null and !eqp_nm.equals('')">
                                    AND EQP_NM LIKE '%${eqp_nm}%'   <!--  설비명 검색    -->             
                                 </if>
                                 <if test="salesMngId != null and !salesMngId.equals('')">
                                    AND CODE_ID IN 
                                       (SELECT WBS_PLAN_CODE_ID FROM TB_WB01P01 X
                                           WHERE X.CO_CD = '${coCd}' 
                                               <if test="salesCd != null and !salesCd.equals('')">
                                                 AND X.SALES_CD = '${salesCd}' 
                                                </if> 
                                                 AND X.ID = '${salesMngId}') 
                                </if> 
          </select>
          
          <!-- ToDo List 메인 화면 조회 리스트  -->
          <select id="selectToDoList" parameterType="Map" resultType="camelMap">  
          SELECT * FROM (
                    SELECT ROWNUM AS RN, Z.* FROM (
                               SELECT 
                                    TODO_KEY,
                                    X.CO_CD,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS CO_CD_NM,
                                    TODO_DIV1_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM,
                                    TODO_DIV2_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.TODO_DIV2_CODE_ID) AS TODO_DIV2_CODE_NM,
                                    TODO_ID,
                                    (SELECT Y.WBS_PLAN_CNTS FROM TB_WB01M01 Y WHERE Y.CO_CD = X.CO_CD 
                                              AND Y.WBS_PLAN_CODE_KIND = X.WBS_PLAN_CODE_KIND
                                              AND Y.WBS_PLAN_CODE_ID = X.WBS_PLAN_CODE_ID
                                              AND Y.WBS_PLAN_NO = X.WBS_PLAN_NO
                                              AND Y.SALES_CD = Y.SALES_CD) AS WBS_PLAN_CNTS, -- TO-DO LIST 주요내용
                                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.TODO_ID) AS TODO_NM,
                                    NULL AS TODO_CHK,
                                    TO_CHAR(X.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT,
                                    TODO_CF_OPN,
                                    X.SALES_CD,
                                    X.PG_PATH,
                                    X.WBS_PLANCO_CD,
                                    X.WBS_PLAN_NO,
                                    X.WBS_PLAN_CODE_KIND,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_CODE_KIND) AS WBS_PLAN_CODE_KIND_NM,
                                    X.WBS_PLAN_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_PLAN_CODE_ID) AS WBS_PLAN_CODE_NM,
                                    WBS_RSLTS_CO_CD,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.CO_CD) AS WBS_RSLTS_CO_CD_NM,
                                    WBS_RSLTS_PLAN_NO,
                                    WBS_RSLTS_PLAN_CODE_KIND,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_RSLTS_PLAN_CODE_KIND) AS WBS_RSLTS_PLAN_CODE_KIND_NM,
                                    WBS_RSLTS_PLAN_CODE_ID,
                                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = X.WBS_RSLTS_PLAN_CODE_ID) AS WBS_RSLTS_PLAN_CODE_ID_NM,
                                    X.CREAT_ID,
                                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.CREAT_ID) AS CREAT_NM,
                                    X.CREAT_PGM,
                                    TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM,
                                    TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD') AS COMP_CREAT_DTTM,
                                    X.UDT_ID,
                                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = X.UDT_ID) AS UDT_NM,
                                    X.UDT_PGM,
                                    TO_CHAR(X.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM
                                    FROM TB_WB20M01 X                                            
                                 ORDER BY TODO_KEY ASC ) Z )                                 
                                 WHERE CO_CD = '${coCd}'
					             AND COMP_CREAT_DTTM BETWEEN '${wbsPlansDt}' AND '${wbsPlaneDt}' 
					             <if test="salesCd != null and !salesCd.equals('')">
					                AND SALES_CD LIKE '%${salesCd}%' <!--  salescode 검색    -->  
					             </if>
					             <if test="clntCd != null and !clntCd.equals('')">
					                 AND ORDRS_CLNT_CD LIKE '%${clntCd}%' <!--  고객사 검색    -->               
					             </if>
					             <if test="prdtDiv != null and !prdtDiv.equals('')">
					                AND PRDT_CD LIKE '%${prdtDiv}%' <!--  제품구분 검색    -->               
					             </if>
					             <if test="prdtItem != null and !prdtItem.equals('')">
					                AND ITEM_DIV LIKE '%${prdtItem}%'  <!--  아이템구분 검색    -->              
					             </if> 
					             <if test="wbsClntPjt != null and !wbsClntPjt.equals('')">
					                AND CLNT_PJT LIKE '%${wbsClntPjt}%'  <!--  고객사 PJT 검색    -->              
					             </if> 
					             <if test="eqp_nm != null and !eqp_nm.equals('')">
					                AND EQP_NM LIKE '%${eqp_nm}%'   <!--  설비명 검색    -->             
					             </if>
					             <if test="salesMngId != null and !salesMngId.equals('')">
					                AND CODE_ID IN 
					                   (SELECT WBS_PLAN_CODE_ID FROM TB_WB01P01 X
					                       WHERE X.CO_CD = '${coCd}' 
					                           <if test="salesCd != null and !salesCd.equals('')">
					                             AND X.SALES_CD = '${salesCd}' 
					                            </if> 
					                             AND X.ID = '${salesMngId}') 
					            </if> 
					            AND  RN BETWEEN ${firstIndex} AND ${lastIndex}
		   </select>


           <update id="toDoCfDtUpdate" parameterType="Map">
                UPDATE TB_WB20M01
                   SET TODO_CF_DT = #{todoCfDt},
                       UDT_ID = #{creatId},
                       UDT_PGM = #{creatPgm},
                       UDT_DTTM = SYSDATE
                 WHERE 
                       TODO_KEY = #{todoKey}
         </update>   

 </mapper>