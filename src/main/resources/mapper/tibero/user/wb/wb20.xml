<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb20.mapper.WB20Mapper">

	<!-- TO-DO  조회조건 -->
	<sql id="selectToDoListCondition">
		<!-- 회사코드 -->         
		<if test="coCd != null and !coCd.equals('')">
			AND T.CO_CD = #{coCd}   
		</if>
		<if test="todoFromDt != null and !todoFromDt.equals('')" >
			<if test="todoToDt != null and !todoToDt.equals('')">                
			AND T.CREAT_DTTM BETWEEN TO_DATE(#{todoFromDt}, 'YYYYMMDD') AND TO_DATE(#{todoToDt}, 'YYYYMMDD')+1 
			</if> 
		</if>
		<if test="salesCd != null and !salesCd.equals('')">
		 	AND T.SALES_CD LIKE '%'||#{salesCd}||'%'  
		</if>				             
		<if test="!salesMngId != null and !salesMngId.equals('')"> 
		 	AND T.TODO_ID = #{salesMngId}				--공유대상자	                  
		</if> 
		 <if test="todoDiv != null and !todoDiv.equals('')">
		 	AND T.TODO_DIV1_CODE_ID = #{todoDiv}                 --구분                 
		 </if>	
		 <if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
		 	AND T.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}                 --요청                 
		 </if>
		 <if test="todoDivDetail != null and !todoDivDetail.equals('')">
		 	AND X.CODE_NM = #{todoDivDetail}                 --요청                 
		 </if>
		<!-- todo 결재 관리자가 아닐경우 본인것만 표시 -->
		<if test="todoDiv != null and !todoDiv.equals('')">
			<if test='isAdmin lt 0'>
				<!-- 본인id인것만 -->
				<if test="todoId != null and !todoId.equals('')">
					AND T.TODO_ID = #{todoId}
				</if>
			</if>
		</if>
		<if test="boardParam != null and !boardParam.equals('')">
			AND T.TODO_CF_DT IS NULL  --확인일자 없는것 
			AND T.SANCTN_STTUS = 'N'                
		</if>				
		<!-- 결재완료여부 -->
		 <if test="sanctnSttus != null and !sanctnSttus.equals('')">
		 	AND ( T.SANCTN_STTUS = #{sanctnSttus} /* OR T.TODO_CF_OPN IS NOT NULL */ )                
		 </if>			
	</sql>	
																					
	<!-- ToDo List  메인 화면 조회 카운터  -->
	<select id="selectToDoCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) 
			FROM TB_WB20M03 T
					LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
		WHERE 1=1
		<include refid="selectToDoListCondition"></include>			
	</select>
          
	<!-- ToDo List 메인 화면 조회 리스트  -->
	<select id="selectToDoList" parameterType="Map" resultType="camelMap">  
		SELECT Z.*
		FROM
		(
			SELECT X.*
					, ROWNUM AS RN
			FROM
				(
					SELECT T.CO_CD 
					    , T.TODO_KEY  --TO DO KEY
						, T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
						, T.TODO_DIV2_CODE_ID						
						, FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재) 명
						, X.CODE_NM  			AS TODO_DIV2_CODE_NM 	 --발생프로그램 명
						, T.SALES_CD --Sales Code
						, T.TODO_NO  --관리번호
						, T.SANCTN_SN  --결제순번
						,T.TODO_ID 
						,
						(
							SELECT A.NAME
								FROM TB_CM06M01 AS A
							WHERE A.ID = T.TODO_ID
						) AS TODO_NM --대상자명
						, T.SANCTN_STTUS
						, T.PG_PATH
						, T.TODO_FILE_TRGT_KEY
						, T.TODO_NO
						, CASE WHEN (T.TODO_DIV2_CODE_ID = 'TODODIV2100' OR T.TODO_DIV2_CODE_ID = 'TODODIV1100') THEN (T.TODO_NO ||' ' || T.ETC_FIELD2 || '차')
						       ELSE T.TODO_NO
						       END AS SHW_TODO_NO
						, T.PG_PARAM
						, TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
						, T.TODO_CF_OPN  --확인의견
						, T.CREAT_ID  --생성자
						,
						(
							SELECT A.NAME
								FROM TB_CM06M01 AS A
							WHERE A.ID = T.CREAT_ID
						) AS CREAT_NM	/*생성자명 */						
						, TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
						, T.UDT_ID  --최종변경자
						,
						(
							SELECT A.NAME
								FROM TB_CM06M01 AS A
							WHERE A.ID = T.UDT_ID
						) AS UDT_NM	/*변경자명 */						
						, TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
						, T.TODO_TITL AS TODO_TITL
						, T.CREAT_PGM
						, T.ETC_FIELD2
					FROM TB_WB20M03 T
							LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
					WHERE 1 = 1
						<include refid="selectToDoListCondition"></include>
						/* ORDER BY T.SALES_CD DESC, T.TODO_NO DESC, T.SANCTN_SN DESC */
<!-- 				<if test="boardParam != null and !boardParam.equals('')"> -->	<!-- 현우 확인 요망 20231005 -->
				ORDER BY TODO_DIV1_CODE_NM,  TODO_DIV2_CODE_NM, SALES_CD DESC, TODO_NM             
<!-- 				</if>				 -->							
				) AS X
				WHERE 1=1
			) AS Z
		WHERE  1 = 1
		  AND  Z.RN BETWEEN ${firstIndex} AND ${lastIndex}	
	</select>

		<!-- 공유 확인처리 -->
           <update id="toDoCfDtUpdate" parameterType="Map">
                UPDATE TB_WB20M03
                   SET SANCTN_STTUS = 'Y',
                   	   TODO_CF_DT = SYSDATE,  
                       UDT_ID = #{creatId},
                       UDT_PGM = #{creatPgm},
                       UDT_DTTM = SYSDATE
                 WHERE 
                       TODO_KEY = #{todoKey}
           </update>   
                                
           <select id="selectTodoDivList" parameterType="Map" resultType="camelMap">
				SELECT DISTINCT 
						FN_CM05M01_CD_TO_NM(A.TODO_DIV2_CODE_ID) AS TODO_PGM_NM
				  FROM TB_WB20M03 A
           </select>   
           
           <select id="selectApprovalYnList" parameterType="Map" resultType="camelMap">
	           SELECT Y.ID, 
	                  Y.NAME, 
	                  Y.DEPT_ID, 
	                  D.DEPT_NM, 
	                  Y.LEVEL_CD, 
	                  L.LEVEL_NM,
	                  NVL(TO_CHAR(X.TODO_CF_DT, 'YYYY-MM-DD'), '') AS TODO_CF_DT		/* 승인일자 */ 
	                  FROM (
						        SELECT TODO_KEY, CO_CD, TODO_ID, TODO_CF_DT FROM TB_WB20M03
						        WHERE TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
						        AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
						        AND CO_CD = #{coCd}
						        AND SALES_CD = #{salesCd}
						        AND TODO_FILE_TRGT_KEY = #{fileTrgtKey} 
						        ORDER BY TODO_KEY ASC						        
				        ) X
				       INNER JOIN TB_CM06M01 Y 
				       ON X.CO_CD = Y.CO_CD
				       AND X.TODO_ID = Y.ID 
				       LEFT OUTER JOIN TB_CM04M01 D
				       ON Y.DEPT_ID = D.DEPT_ID 
				       LEFT OUTER JOIN TB_CM07M01 L
				       ON Y.LEVEL_CD = L.LEVEL_CD
			         
			</select>          
        
        
           <select id="selectApprovalMaxTodoKeyChk" parameterType="Map" resultType="camelMap">
               SELECT MAX(TODO_KEY) AS TODO_KEY 
                 FROM (
                       SELECT X.TODO_KEY, X.TODO_CF_DT, 
                             (SELECT MIN(Y.TODO_KEY) 
                                FROM TB_WB20M03 Y
                               WHERE Y.TODO_CO_CD = #{todoCoCd}
                                 AND Y.SALES_CD = #{salesCd}
                                 AND Y.TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
                                 AND Y.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
                              ) AS CHK
                         FROM TB_WB20M03 X 
                        WHERE X.TODO_CO_CD = #{todoCoCd}
                          AND X.SALES_CD = #{salesCd}
                          AND X.TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
                          AND X.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
                        ) S
                WHERE TODO_KEY BETWEEN CHK AND TO_NUMBER(#{todoKey, jdbcType=VARCHAR})-1
               --AND  NVL(TO_CHAR(TODO_CF_DT,'YYYY-MM-DD'),'') = ''                       
                  AND  TODO_CF_DT IS NULL                       
           </select>  
           
            <update id="updateRsltsQmApproval" parameterType="Map">
                UPDATE TB_WB20M03
                   SET TODO_CF_DT = SYSDATE,
                       TODO_CF_OPN = #{todoCfOpn},
                       UDT_ID = #{creatId},
                       UDT_PGM = #{creatPgm},
                       UDT_DTTM = SYSDATE
                 WHERE 
                       TODO_KEY = #{todoKey}
           </update>
           
           <update id="updateQmQeqst" parameterType="Map">
                UPDATE TB_WB20M03
                   SET TODO_CF_DT = SYSDATE,
                       TODO_CF_OPN = #{todoCfOpn},
                       UDT_ID = #{creatId},
                       UDT_PGM = #{creatPgm},
                       UDT_DTTM = SYSDATE
                 WHERE 
                       TODO_KEY = #{todoKey}
           </update>
                      
    <update id="updateQmMobileApproval" parameterType="Map">
         UPDATE TB_WB20M03
            SET TODO_CF_DT = SYSDATE,
                TODO_CF_OPN = #{todoCfOpn},
                UDT_ID = #{todoId},
                UDT_PGM = #{creatPgm},
                UDT_DTTM = SYSDATE
          WHERE 
                TODO_FILE_TRGT_KEY = #{todoFileTrgtKey}
                AND TODO_CO_CD = #{todoCoCd}
                AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
                AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
                AND SALES_CD = #{salesCd}
                AND SANCTN_SN = #{sanctnSn}
    </update>   
    
    <select id="selectGetDeptList" parameterType="Map" resultType="camelMap">
        SELECT CODE_ID, CODE_NM FROM TB_CM05M01 WHERE CODE_ID LIKE 'COBGB%'        
    </select> 
                  
                  
	<!-- 결재목록 및 결재상태 결재버튼 등 불러오기 -->
	<select id="selectGetApprovalList" parameterType="Map" resultType="camelMap">
		SELECT TODO_KEY
			, SANCTN_SN
			, CO_CD
			, TODO_DIV1_CODE_ID
			, TODO_DIV2_CODE_ID
			, TODO_ID			/* 대상자 ID */
			,
			(
				SELECT NAME
					FROM TB_CM06M01 B
				WHERE A.TODO_ID = B.ID
			) AS TODO_NM		/* 작성자 이름 */
			, NVL(TO_CHAR(TODO_CF_DT, 'YYYY-MM-DD'), ' ') AS TODO_CF_DT		/* 승인일자 */
			, TODO_CF_OPN
			, SANCTN_STTUS
			, DECODE(SANCTN_STTUS, 'Y', '승인', 'N', '미승인', ' ') AS SANCTN_STTUS_NM
			, 
			(
				SELECT SANCTN_STTUS
					FROM
					(
					SELECT SANCTN_STTUS 
						, ROWNUM RN
						FROM TB_WB20M03 B
					WHERE 1=1
						AND A.SANCTN_SN <![CDATA[ > ]]> B.SANCTN_SN
						AND A.CO_CD = B.CO_CD             
						AND A.TODO_DIV1_CODE_ID = B.TODO_DIV1_CODE_ID                                  
						AND A.TODO_DIV2_CODE_ID = B.TODO_DIV2_CODE_ID                                 
<!-- 						AND A.SALES_CD = B.SALES_CD -->
						AND A.TODO_NO = B.TODO_NO
					ORDER BY B.SANCTN_SN DESC
					)
					WHERE RN=1
			) AS PRE_STTUS 			/* 하위 완료여부 */		
			, 
			(
				SELECT SANCTN_STTUS
					FROM
					(
					SELECT SANCTN_STTUS 
						, ROWNUM RN
						FROM TB_WB20M03 B
					WHERE 1=1
						  AND A.SANCTN_SN <![CDATA[ < ]]> B.SANCTN_SN
						  AND A.CO_CD = B.CO_CD                                   
						AND A.TODO_DIV1_CODE_ID = B.TODO_DIV1_CODE_ID                                  
						AND A.TODO_DIV2_CODE_ID = B.TODO_DIV2_CODE_ID                                  
<!-- 						AND A.SALES_CD = B.SALES_CD -->
						AND A.TODO_NO = B.TODO_NO
					ORDER BY B.SANCTN_SN DESC			
					)
					WHERE RN=1
			) AS NEXT_STTUS 			/* 상위 완료여부 */					
			, SALES_CD
			, PG_PATH
			, SUBSTR(PG_PATH, INSTR(PG_PATH, '/', -1)+1) AS DOC_NM		/* 문서명 pgmId */
			, TODO_FILE_TRGT_KEY
			, TODO_CO_CD
			, TODO_NO
			, TODO_CODE_KIND
			, TODO_CODE_ID
			, NVL(NVL(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD')), ' ') AS CREAT_DTTM
			, PG_PARAM
			FROM TB_WB20M03 A
		WHERE 1=1		
			<if test="todoKey != null and !todoKey.equals('')">			
				AND TODO_KEY = #{todoKey}                                  
			</if>
			<if test="sanctnSn != null and !sanctnSn.equals('')">			
				AND SANCTN_SN = #{sanctnSn}                                  
			</if>   
			<if test="coCd != null and !coCd.equals('')">
				AND CO_CD = #{coCd}                                  
			</if>   								
			<if test="todoDiv1CodeId != null and !todoDiv1CodeId.equals('')">
				AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}                                  
			</if>
			<if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}                                  
			</if>
			<!-- TO_DO ~ 시작컬럼은 대상업무에서 넘어온 데이터 -->
			<if test="salesCd != null and !salesCd.equals('')">
				AND SALES_CD = #{salesCd}                                  
			</if> 			
			<if test="pgPath != null and !pgPath.equals('')">
				<!-- / 로 SLIT 하여 마지막부분이 문서명 -->
				AND PG_PATH = #{pgPath}                                  
			</if>   					
			<if test="todoFileTrgtKey != null and !todoFileTrgtKey.equals('')">
				AND TODO_FILE_TRGT_KEY = #{todoFileTrgtKey}                                  
			</if>
			<if test="todoCoCd != null and !todoCoCd.equals('')">
				AND TODO_CO_CD = #{todoCoCd}                                  
			</if>   			   
			<if test="todoNo != null and !todoNo.equals('')">
				AND TODO_NO = #{todoNo}                                  
			</if>
			<if test="histNo != null and !histNo.equals('')">
				AND ETC_FIELD2 = #{histNo}                                  
			</if>       
				AND CREAT_DTTM IN (	SELECT MAX(CREAT_DTTM)
									  FROM TB_WB20M03	
									 WHERE 1 = 1	
									<if test="todoKey != null and !todoKey.equals('')">			
										AND TODO_KEY = #{todoKey}                                  
									</if>
									<if test="todoCoCd != null and !todoCoCd.equals('')">
										AND TODO_CO_CD = #{todoCoCd}                                  
									</if>   							
									<if test="todoDiv1CodeId != null and !todoDiv1CodeId.equals('')">
										AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}                                  
									</if>
									<if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
										AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}                                  
									</if>
									<!-- TO_DO ~ 시작컬럼은 대상업무에서 넘어온 데이터 -->
									<if test="salesCd != null and !salesCd.equals('')">
										AND SALES_CD = #{salesCd}                                  
									</if> 	
									<if test="todoFileTrgtKey != null and !todoFileTrgtKey.equals('')">
										AND TODO_FILE_TRGT_KEY = #{todoFileTrgtKey}                                  
									</if>		   
									<if test="todoNo != null and !todoNo.equals('')">
										AND TODO_NO = #{todoNo}                                  
									</if>
									<if test="histNo != null and !histNo.equals('')">
										AND ETC_FIELD2 = #{histNo}                                  
									</if>                     
								  ) 
		ORDER BY SANCTN_SN DESC																	        			                      
	</select>             
           
	<!-- 결재 승인 -->
	<update id="updateApprovalLine" parameterType="Map">
		UPDATE TB_WB20M03
			SET
		TODO_CF_DT = SYSDATE
		, SANCTN_STTUS = 'Y'
		, TODO_CF_OPN = #{todoCfOpn}
		, UDT_ID = #{userId}		
		, UDT_PGM = #{pgmId}		
		, UDT_DTTM = SYSDATE
		WHERE TODO_KEY = #{todoKey}
			AND SANCTN_SN = #{sanctnSn}
			AND CO_CD = #{coCd}
			AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
	</update>
	
		           
	<!-- 결재 취소 -->
	<update id="updateApprovalCancle" parameterType="Map">
		UPDATE TB_WB20M03
			SET
				  TODO_CF_DT = ''
				, SANCTN_STTUS = 'N'
				, TODO_CF_OPN = ''
				, UDT_ID = #{userId}		
				, UDT_PGM = #{pgmId}		
				, UDT_DTTM = SYSDATE
		WHERE TODO_NO = #{todoNo}  --해당업무 마스터 번호
			AND SANCTN_SN = #{sanctnSn}  --결재순번
		    AND TODO_ID   = #{userId}	  --결재대상자ID
			AND CO_CD = #{coCd}		
			AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}	--공유결재구분
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}	--구분프로그램
	</update> 
	
	<!-- 결재목록 불러오기 -->
	<select id="selectSignResUserlst" parameterType="Map" resultType="camelMap">	
		SELECT *
		  FROM(
		SELECT
			ROWNUM AS RNUM, A.*
		FROM
		(
			SELECT   A.CO_CD AS WBS_PLANCO_CD,
					 A.CO_CD,
					 FN_CM05M01_CD_TO_NM(A.CO_CD) WBS_PLANCO_CD_NM,
			         A.ID AS USR_NM,
			         A.EMP_NO AS EMP_NO,
					 A.NAME AS NAME,
					 A.TEL_NO AS TEL_NO,
					 A.EMAIL AS EMAIL,
					 B.DEPT_NM AS DT_NM,
					 D.LEVEL_NM AS JIK,
					 C.TODO_DIV1_CODE_ID  AS TODO_DIV1_CODE_ID,
					 DECODE(C.TODO_DIV1_CODE_ID, 'TODODIV10', '공유', 'TODODIV20', '결재', '') AS GB
					 , C.SANCTN_STTUS
					 , DECODE(C.SANCTN_STTUS, 'Y', '승인', 'N', '미승인', ' ') AS SANCTN_STTUS_NM
					 , NVL(TO_CHAR(C.CREAT_DTTM, 'YYYY-MM-DD'), '') AS CREAT_DTTM		/* 요청일자 */
					 , NVL(TO_CHAR(C.TODO_CF_DT, 'YYYY-MM-DD'), '') AS TODO_CF_DT		/* 승인일자 */
					 , C.TODO_CF_OPN		/* 확인의견 */
					 , C.TODO_KEY
					 , C.SANCTN_SN
					 , C.TODO_ID
					 , C.TODO_DIV1_CODE_ID
					 , C.TODO_DIV2_CODE_ID
					 , C.SALES_CD	 
					 , 'U' AS FLAG							 
			FROM
				TB_CM06M01 A
				LEFT OUTER JOIN TB_CM07M01 D ON A.LEVEL_CD = D.LEVEL_CD 
				INNER JOIN TB_CM04M01 B on A.DEPT_ID = B.DEPT_ID
				INNER JOIN TB_WB20M03 C ON A.ID = C.TODO_ID
				  AND C.TODO_FILE_TRGT_KEY = #{fileTrgtKey}
				  AND C.TODO_NO = #{reqNo}
				<if test="etcField2 != null and !etcField2.equals('')">
				  AND C.ETC_FIELD2 = #{etcField2}   
				</if>
			ORDER BY C.TODO_DIV1_CODE_ID DESC, SANCTN_SN ASC, CREAT_DTTM ASC
			) AS a
		 ) A
 	</select>
 	
 	<!-- 사용자 등록된 기본 결재라인 불러오기  -->
	<select id="selectSignResUserlstInit" parameterType="Map" resultType="camelMap">	
		SELECT *
		  FROM(
		SELECT
			ROWNUM AS RNUM, ROWNUM AS SANCTN_SN, A.*
			FROM
			(
				SELECT T.*
					FROM
						(
							SELECT   A.CO_CD AS WBS_PLANCO_CD,
									 A.CO_CD,
									 FN_CM05M01_CD_TO_NM(A.CO_CD) WBS_PLANCO_CD_NM,
							         A.ID AS USR_NM,
							         A.EMP_NO AS EMP_NO,
									 A.NAME AS NAME,
									 A.TEL_NO AS TEL_NO,
									 A.EMAIL AS EMAIL,
									 B.DEPT_NM AS DT_NM,
									 D.LEVEL_NM AS JIK,
									 'TODODIV20'  AS TODO_DIV1_CODE_ID,					 
									 '결재' AS GB
									 , C.APP_SEQ AS SANCTN_SN					 
									 , '' AS SANCTN_STTUS
									 , C.APP_ID AS TODO_ID
									 , '미승인' AS SANCTN_STTUS_NM	 
									 , 'I' AS FLAG	
									 , RANK() OVER(ORDER BY C.APP_NO DESC) AS RNK
							FROM
								TB_CM06M01 A 				
								INNER JOIN TB_BM13M01 C ON(A.ID = C.APP_ID)  								
								LEFT OUTER JOIN TB_CM07M01 D ON A.LEVEL_CD = D.LEVEL_CD				
								INNER JOIN TB_CM04M01 B ON(A.DEPT_ID = B.DEPT_ID)				
							WHERE 1=1 
								AND C.ID = #{userId}
								AND C.APP_DIV = #{appDiv}  	/* 발주서 */
							ORDER BY C.APP_SEQ ASC
						) T
						WHERE 1=1
						AND T.RNK = 1
			) AS A
		 ) 
 	</select> 	
	
	<!-- 결재 등록시 사용자 검색후 부서등 SELECT  -->
	<select id="selectShareUserInfo" parameterType="Map" resultType="camelMap">
	    SELECT  A.CO_CD AS CO_CD,
	    		C.CODE_NM AS CO_NM,
				A.ID AS ID,
				A.ID AS TODO_ID,
		        A.EMP_NO AS EMP_NO,
				A.NAME AS USR_NM,
				A.TEL_NO AS TEL_NO,
				A.EMAIL AS EMAIL,
				B.DEPT_NM AS DT_NM
				, (SELECT T.LEVEL_NM FROM TB_CM07M01 T WHERE T.LEVEL_CD=A.LEVEL_CD) AS LEVEL_NM 
			FROM
				TB_CM06M01 A 
				INNER JOIN TB_CM04M01 B on A.DEPT_ID = B.DEPT_ID
				INNER JOIN TB_CM05M01 C ON A.CO_CD = C.CODE_ID 
				AND	A.USE_YN = 'Y'
			    AND A.CO_CD = '${coCd}'
			    AND A.ID =  '${userId}' 
	</select>	
	
	<select id="selectmaxTodoKey" parameterType="Map" resultType="String">
		SELECT NVL(MAX(TODO_KEY)+1, 1) FROM TB_WB20M03 
			WHERE 1=1 
			AND CO_CD = #{coCd}
			AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}	
	</select>
		                 
	<!-- todo insert -->
	<insert id="insertTodoMaster" parameterType="Map">				
		MERGE INTO TB_WB20M03 
			USING DUAL
			ON (
				TODO_KEY = #{todoKey}
				AND SANCTN_SN = #{sanctnSn} 
				AND CO_CD = #{coCd}
				AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId} 
				)		
		WHEN MATCHED THEN
			UPDATE SET	
				TODO_ID = #{todoId,								jdbcType=VARCHAR}
				, SALES_CD = #{salesCd,							jdbcType=VARCHAR}
				, PG_PATH = #{pgPath,							jdbcType=VARCHAR}
				, TODO_FILE_TRGT_KEY = #{todoFileTrgtKey,		jdbcType=VARCHAR}
				, TODO_CO_CD = #{todoCoCd}
				, TODO_NO = #{todoNo}
				, TODO_CODE_KIND = #{todoCodeKind,				jdbcType=VARCHAR} 
				, TODO_CODE_ID = #{todoCodeId,					jdbcType=VARCHAR}
				, UDT_ID = #{userId}
				, UDT_PGM = #{pgmId}
				/* , UDT_DTTM = SYSDATE */
				, PG_PARAM = #{pgParam,							jdbcType=VARCHAR}     
				, TODO_TITL = #{todoTitl,						jdbcType=VARCHAR}     
		WHEN NOT MATCHED THEN						
		INSERT 
		(		
			TODO_KEY
			, SANCTN_SN
			, CO_CD
			, TODO_DIV1_CODE_ID
			, TODO_DIV2_CODE_ID
			, TODO_ID
			, TODO_CF_DT
			, TODO_CF_OPN
			, SANCTN_STTUS
			, SALES_CD
			, PG_PATH
			, TODO_FILE_TRGT_KEY
			, TODO_CO_CD
			, TODO_NO
			, TODO_CODE_KIND
			, TODO_CODE_ID
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM
			, PG_PARAM
			, TODO_TITL             
		) 
		VALUES
		(       
			#{todoKey}
			, #{sanctnSn}
			, #{coCd}
			, #{todoDiv1CodeId}
			, #{todoDiv2CodeId}
			, #{todoId,					jdbcType=VARCHAR}
			, #{todoCfDt,				jdbcType=VARCHAR}
			, #{todoCfOpn,				jdbcType=VARCHAR}
			, #{sanctnSttus}
			, #{salesCd,				jdbcType=VARCHAR}
			, #{pgPath,					jdbcType=VARCHAR}
			, #{todoFileTrgtKey,		jdbcType=VARCHAR}
			, #{todoCoCd}
			, #{todoNo}
			, #{todoCodeKind,			jdbcType=VARCHAR}
			, #{todoCodeId,				jdbcType=VARCHAR}
			, #{userId}
			, #{pgmId}
			, SYSDATE
			, #{pgParam,				jdbcType=VARCHAR}
			, #{todoTitl,				jdbcType=VARCHAR}
		)            
	</insert>  
	<!-- todo insert -->
	
	<!-- 결재 todo  삭제 -->         
	<delete id="deleteTodoMaster" parameterType="Map">
        DELETE FROM TB_WB20M03
		WHERE  1 = 1
        AND    TODO_KEY = #{todoKey}
        AND    SANCTN_SN = #{sanctnSn}
        <if test="coCd != null and !coCd.equals('')">
        AND    CO_CD = #{coCd}
        </if>
        AND    TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
        AND    TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
	</delete>			                 
	            
	<!-- 결재 todo all 삭제 -->         
	<delete id="deleteAllTodoMaster" parameterType="Map">
		DELETE 
			FROM TB_WB20M03
		WHERE 1=1 
			AND CO_CD = #{coCd}
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
			AND SALES_CD = #{salesCd}
			AND TODO_NO = #{todoNo} 
	</delete>		   
	
	<!-- TODO 결재완료여부  -->
	<select id="selectApprovalYn" parameterType="Map" resultType="String">
		SELECT CASE 
				WHEN( SUM(STATUS_NO) =  MAX(MAX_SN) )
					THEN 'Y'
				ELSE 'N'
			   END AS APPROVAL_YN
			FROM
			(
			SELECT DECODE(SANCTN_STTUS, 'Y', 1, 0) AS STATUS_NO
					, MAX(SANCTN_SN) OVER() MAX_SN
			FROM TB_WB20M03 
				WHERE 1=1 
				AND CO_CD = #{coCd}
				AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
				AND SALES_CD = #{salesCd}
				AND TODO_NO = #{todoNo}			
			)
	</select>
	
	<!-- 결재 todo 삭제시 순번  -->	
	<update id="updateTodoMasterSanctnSn" parameterType="Map">   
		UPDATE TB_WB20M03 A
			SET SANCTN_SN = (
							SELECT RN 
				              FROM 
				              ( 
				              	SELECT RID, ROWNUM RN
				                  FROM 
				                  ( 
			                  		SELECT ROWID RID
			                          FROM TB_WB20M03
			                         WHERE TODO_NO = #{todoNo}
			                         ORDER BY SANCTN_SN
		                          )
			                  )
				            WHERE RID = A.ROWID
			            	)
		WHERE A.TODO_NO = #{todoNo}
	</update>   
	
	
	<!-- TODO 모바일 뷰어 조회  -->
    <select id="selectMobileTodoSelect" parameterType="Map" resultType="camelMap">
           SELECT T.CO_CD
                , T.TODO_KEY  
                , T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
                , FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재)명                
                , T.TODO_DIV2_CODE_ID                       
                , (SELECT X.CODE_NM FROM TB_CM05M01 X WHERE X.CODE_ID = T.TODO_DIV2_CODE_ID) AS TODO_DIV2_CODE_NM --발생프로그램 명
                , T.SALES_CD --Sales Code
                , T.TODO_NO  --관리번호
                ,T.TODO_ID 
                ,
                (
                    SELECT A.NAME
                        FROM TB_CM06M01 AS A
                    WHERE A.ID = T.TODO_ID
                ) AS TODO_NM --대상자명
                , TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
                , T.TODO_CF_OPN   --확인의견
                , T.CREAT_ID  --생성자
                ,
                (
                    SELECT A.NAME
                        FROM TB_CM06M01 AS A
                    WHERE A.ID = T.CREAT_ID
                ) AS CREAT_NM   /*생성자명 */                       
                , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
                , T.UDT_ID  --최종변경자
                ,
                (
                    SELECT A.NAME
                        FROM TB_CM06M01 AS A
                    WHERE A.ID = T.UDT_ID
                ) AS UDT_NM /*변경자명 */                       
                , TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
                , T.TODO_TITL AS TODO_TITL
                FROM TB_WB20M03 T
                WHERE TODO_KEY = #{todoKey}
    </select>
    
	<!-- 최종결재 완료여부 -->
	<select id="selectTodoFinalYn" parameterType="Map" resultType="camelMap">
		SELECT    A.TODO_NO
				, MIN(NVL(A.SANCTN_STTUS, 'N')) TODO_YN
			FROM TB_WB20M03 A
		WHERE 1=1 
				AND CO_CD = #{coCd}
				AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
				AND TODO_NO = #{todoNo}		     
				GROUP BY A.TODO_NO	
	</select>	        
 </mapper>