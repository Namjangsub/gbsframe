<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.wb.wb20.mapper.WB20Mapper">

	<!-- TO-DO  조회조건 -->
	<sql id="selectToDoListCondition">
		<!-- 회사코드 -->
		<if test="coCd != null and !coCd.equals('')">
			AND T.CO_CD = #{coCd}
		</if>
		<if test="todoFromDt != null and !todoFromDt.equals('')" >
			<if test="todoToDt != null and !todoToDt.equals('')">
			AND T.CREAT_DTTM BETWEEN TO_DATE(#{todoFromDt}, 'YYYYMMDD') AND TO_DATE(#{todoToDt}, 'YYYYMMDD')+1
			</if>
		</if>
		<if test="todoNo != null and !todoNo.equals('')">
		 	AND T.TODO_NO LIKE '%'||#{todoNo}||'%'
		</if>
		<if test="salesCd != null and !salesCd.equals('')">
		 	AND T.SALES_CD LIKE '%'||#{salesCd}||'%'
		</if>
		<if test="!salesMngId != null and !salesMngId.equals('')">
		 	AND T.TODO_ID = #{salesMngId}				--공유대상자
		</if>
		<if test="salesMngNm != null and !salesMngNm.equals('')">
		 	AND B.NAME like '%' || #{salesMngNm} || '%'				--공유대상자
		</if>
		 <if test="todoDiv != null and !todoDiv.equals('')">
		 	AND T.TODO_DIV1_CODE_ID = #{todoDiv}                 --구분
		 </if>
		 <if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
		 	AND T.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}                 --요청
		 </if>
		 <if test="todoDivDetail != null and !todoDivDetail.equals('')">
		 	AND X.CODE_NM = #{todoDivDetail}                 --요청
		 </if>
		<!-- todo 결재 관리자가 아닐경우 본인것만 표시 -->
		<if test="todoDiv != null and !todoDiv.equals('')">
			<if test='isAdmin lt 0'>
				<!-- 본인id인것만 -->
				<if test="todoId != null and !todoId.equals('')">
					AND T.TODO_ID = #{todoId}
				</if>
			</if>
		</if>
		<if test="boardParam != null and !boardParam.equals('')">
			AND T.TODO_CF_DT IS NULL  --확인일자 없는것
			AND T.SANCTN_STTUS = 'N'
		</if>
		<!-- 결재완료여부 -->
		 <if test="sanctnSttus != null and !sanctnSttus.equals('')">
		 	AND ( T.SANCTN_STTUS = #{sanctnSttus} /* OR T.TODO_CF_OPN IS NOT NULL */ )
		 </if>
	</sql>

	<!-- ToDo List  메인 화면 조회 카운터  -->
	<select id="selectToDoCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		FROM TB_WB20M03 T
				LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
				LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
		WHERE 1 = 1
		<include refid="selectToDoListCondition"></include>
	</select>
	
	
	<select id="selectToDoCountNewSql" parameterType="Map" resultType="int">
	SELECT 
		(SELECT COUNT(*)
		 FROM TB_WB20M03 T
				LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
				LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
		WHERE 1 = 1
		<include refid="selectToDoListCondition"></include>
		) + 
		(SELECT COUNT(*)															AS VIEW_SORT
            FROM TB_WB24M02  AS ISU --WBS이슈 정보
          			LEFT OUTER JOIN TB_QM01M01 AS QM ON QM.REQ_NO = ISU.REQ_NO
           WHERE 1=1
            AND ( (NVL(QM.REQ_ST,'REQST01') != 'REQST03' AND ISU.ISS_STS != 'ISSSTS03')
                    OR (NVL(ISU.ISS_STS,'ISSSTS01') != 'ISSSTS03' AND ISU.REQ_NO IS NULL)  
                )
			AND (ISU.ACT_ID = #{salesMngId} OR QM.ORDRG_ID = #{salesMngId} )
		)
	FROM DUAL;
	</select>

	<!-- ToDo List 메인 화면 조회 리스트  -->
	<select id="selectToDoList" parameterType="Map" resultType="camelMap">
		SELECT Z.*
		FROM
		(
			SELECT X.*
					, ROWNUM AS RN
			FROM
				(
					SELECT T.CO_CD
					    , T.TODO_KEY  --TO DO KEY
						, T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
						, T.TODO_DIV2_CODE_ID
						, FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재) 명
						, X.CODE_NM  			AS TODO_DIV2_CODE_NM 	 --발생프로그램 명
						, T.SALES_CD --Sales Code
						, T.TODO_NO  --관리번호
						, T.SANCTN_SN  --결제순번
						,T.TODO_ID
						, B.NAME       AS TODO_NM --대상자명
						/* 결재요청자와 결재자가 같은 팀이면 팀장구분을 리턴하고 그외는 공백으로 처리함(이슈 결재처리시 위험도평가에서 사용함 */
--						, DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),B.TEAM_MANAGER,'') AS TEAM_MANAGER		/* 팀장구분 */
						, DECODE(T.TODO_DIV2_CODE_ID, 'TODODIV2090',DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),'평가',''),'') AS TEAM_MANAGER		/* 팀장구분 */
						, T.SANCTN_STTUS
						, T.PG_PATH
						, T.TODO_FILE_TRGT_KEY
						, T.TODO_NO
						, CASE WHEN (T.TODO_DIV2_CODE_ID = 'TODODIV2100' OR T.TODO_DIV2_CODE_ID = 'TODODIV1100') THEN (T.TODO_NO ||' ' || T.ETC_FIELD2 || '차')
						       ELSE T.TODO_NO
						       END AS SHW_TODO_NO
						, T.PG_PARAM
						, TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
						, T.TODO_CF_OPN  --확인의견
						, T.CREAT_ID  --생성자
						, C.NAME      AS CREAT_NM	/*생성자명 */
						, TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
						, T.UDT_ID  --최종변경자
						,
						(
							SELECT A.NAME
								FROM TB_CM06M01 AS A
							WHERE A.ID = T.UDT_ID
						) AS UDT_NM	/*변경자명 */
						, TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
						, T.TODO_TITL AS TODO_TITL
						, T.CREAT_PGM
						, T.ETC_FIELD2
					FROM TB_WB20M03 T
							LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
							LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
							LEFT OUTER JOIN TB_CM06M01 C  ON T.CREAT_ID = C.ID
					WHERE 1 = 1
						<include refid="selectToDoListCondition"></include>
						/* ORDER BY T.SALES_CD DESC, T.TODO_NO DESC, T.SANCTN_SN DESC */
					ORDER BY TODO_DIV1_CODE_NM, TODO_DIV2_CODE_NM, T.CREAT_DTTM DESC, SALES_CD DESC, TODO_NM
				) AS X
				WHERE 1=1
			) AS Z
		WHERE  1 = 1
		  AND  Z.RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>

	<!-- ToDo List 메인 화면 조회 리스트  -->
	<select id="selectToDoListNewSql" parameterType="Map" resultType="camelMap">
		SELECT Z.*
		FROM
		(
			SELECT X.*
					, ROWNUM AS RN
			FROM
				(
					SELECT T.CO_CD
					    , TO_CHAR(T.TODO_KEY) AS  TODO_KEY --TO DO KEY
						, T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
						, T.TODO_DIV2_CODE_ID
						, FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재) 명
						, X.CODE_NM  			AS TODO_DIV2_CODE_NM 	 --발생프로그램 명
						, T.SALES_CD --Sales Code
						, T.TODO_NO  --관리번호
						, T.SANCTN_SN  --결제순번
						,T.TODO_ID
						, B.NAME       AS TODO_NM --대상자명
						/* 결재요청자와 결재자가 같은 팀이면 팀장구분을 리턴하고 그외는 공백으로 처리함(이슈 결재처리시 위험도평가에서 사용함 */
--						, DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),B.TEAM_MANAGER,'') AS TEAM_MANAGER		/* 팀장구분 */
						, DECODE(T.TODO_DIV2_CODE_ID, 'TODODIV2090',DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),'평가',''),'') AS TEAM_MANAGER		/* 팀장구분 */
						, T.SANCTN_STTUS
						, T.PG_PATH
						, T.TODO_FILE_TRGT_KEY
						, T.TODO_NO
						, CASE WHEN (T.TODO_DIV2_CODE_ID = 'TODODIV2100' OR T.TODO_DIV2_CODE_ID = 'TODODIV1100') THEN (T.TODO_NO ||' ' || T.ETC_FIELD2 || '차')
						       ELSE T.TODO_NO
						       END AS SHW_TODO_NO
						, T.PG_PARAM
						, TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
						, T.TODO_CF_OPN  --확인의견
						, T.CREAT_ID  --생성자
						, C.NAME      AS CREAT_NM	/*생성자명 */
						, TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
						, T.UDT_ID  --최종변경자
						,
						(
							SELECT A.NAME
								FROM TB_CM06M01 AS A
							WHERE A.ID = T.UDT_ID
						) AS UDT_NM	/*변경자명 */
						, TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
						, T.TODO_TITL AS TODO_TITL
						, T.CREAT_PGM
						, T.ETC_FIELD2
						, '' AS ORDRS_NO
						, '' AS WORK_RPT_RMK
						, '' AS ISS_STS
						, '' AS REQ_ST
						, '' AS DUDT_INTEND_DT
						, '' AS VIEW_SORT
					FROM TB_WB20M03 T
							LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
							LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
							LEFT OUTER JOIN TB_CM06M01 C  ON T.CREAT_ID = C.ID
					WHERE 1 = 1
						<include refid="selectToDoListCondition"></include>
				 UNION ALL 
					 SELECT
	                      ISU.CO_CD                             AS CO_CD			--회사코드
	                    , ISU.FILE_TRGT_KEY                     AS FILE_TRGT_KEY	--이슈 FILE_TRGT_KEY
	                    , 'TODODIV99'                    		AS TODO_DIV1_CODE_ID
	                    , 'TODODIV9999'                    		AS TODO_DIV2_CODE_ID
	              	    , '문제'  								AS TODO_DIV1_CODE_NM
	              	    , '문제미완료현황'  						AS TODO_DIV2_CODE_NM
	                    , ISU.SALES_CD                          AS SALES_CD     	--SALES Code
	                    , ISU.ISS_NO                          	AS TODO_NO
	                    , 1                          			AS SANCTN_SN
	                    , decode(ISU.REQ_NO, '', ISU.ACT_ID, QM.ORDRG_ID)       					AS TODO_ID    --조치담당자
						, decode(ISU.REQ_NO, '', B2.NAME, B4.NAME) 			 						AS TODO_NM
						, ''									AS TEAM_MANAGER
						, 'N'									AS SANCTN_STTUS
						, 'PG_PATH'								AS PG_PATH
						, QM.FILE_TRGT_KEY 						AS TODO_FILE_TRGT_KEY
	                    , ISU.REQ_NO         		 			AS TODO_NO      
						, ISU.ISS_NO 							AS SHW_TODO_NO --이슈번호
						, ''									AS PG_PARAM
						, ''									AS TODO_CF_DT
						, ''									AS TODO_CF_OPN
						, ISU.CREAT_ID							AS CREAT_ID
						, B.NAME								AS CREAT_NM
						, TO_CHAR(ISU.CREAT_DTTM,'YYYY-MM-DD')	AS CREAT_DTTM
						, ''									AS UDT_ID
						, ''									AS UDT_NM
						, ''									AS UDT_DTTM
						, ISU.ISS_SJ							AS TODO_TITL	--이슈제목
						, ''									AS CREAT_PGM
						, ''									AS ETC_FIELD2
	                    , Y.ORDRS_NO							AS ORDRS_NO
	                    , ISU.ISS_CNTS							AS WORK_RPT_RMK     --이슈내용
	                    , decode(ISU.REQ_NO, '', ISU.ISS_STS, QM.REQ_ST)      AS ISS_STS	--이슈상태
				        , QM.REQ_ST																	AS REQ_ST
				        , TO_CHAR(CR.DUDT_INTEND_DT,'YYYY-MM-DD') 									AS DUDT_INTEND_DT	--수주 납기예정일 ->고객요구일
				        , CASE WHEN QM.REQ_ST = 'REQST03' THEN 3 
				               WHEN ISU.ISS_STS = 'ISSSTS03' THEN 3
				               WHEN QM.REQ_ST IS NOT NULL THEN 2
				               WHEN ISU.ISS_STS = 'ISSSTS02' THEN 2
				               ELSE 1 END 															AS VIEW_SORT
	                FROM TB_WB24M02  AS ISU --WBS이슈 정보
		            		LEFT OUTER JOIN TB_CR02D02 AS CR  ON ISU.CO_CD= CR.CO_CD
		                                                	AND ISU.SALES_CD = CR.SALES_CD
		            		LEFT OUTER JOIN TB_CR02M01 AS Y  ON ISU.CO_CD= Y.CO_CD
	                                                      	AND CR.ORDRS_NO = Y.ORDRS_NO
		           			LEFT OUTER JOIN TB_CM06M01 AS B  ON ISU.CREAT_ID = B.ID
		           			LEFT OUTER JOIN TB_CM06M01 AS B2 ON ISU.ACT_ID = B2.ID
	            			LEFT OUTER JOIN TB_WB24M03 AS ACT ON ISU.ISS_NO = ACT.ISS_NO --실적이슈 조치내용
	              			LEFT OUTER JOIN TB_QM01M01 AS QM ON QM.REQ_NO = ISU.REQ_NO
		           			LEFT OUTER JOIN TB_CM06M01 AS B4 ON QM.ORDRG_ID = B4.ID
	               WHERE 1=1
	                AND ( (NVL(QM.REQ_ST,'REQST01') != 'REQST03' AND ISU.ISS_STS != 'ISSSTS03')
	                        OR (NVL(ISU.ISS_STS,'ISSSTS01') != 'ISSSTS03' AND ISU.REQ_NO IS NULL)  
	                    )
					AND (ISU.ACT_ID = #{salesMngId} OR QM.ORDRG_ID = #{salesMngId} )
					ORDER BY TODO_DIV1_CODE_NM, TODO_DIV2_CODE_NM, CREAT_DTTM DESC, SALES_CD DESC, TODO_NM
				) AS X
				WHERE 1=1
			) AS Z
		WHERE  1 = 1
		  AND  Z.RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>

		<!-- 공유 확인처리 -->
		<!-- TODO_KEY는 TB_WB20M03테이블의 유니크 Key임 , 다른 키확인 필요 없음-->
           <update id="toDoCfDtUpdate" parameterType="Map">
                UPDATE TB_WB20M03
                   SET SANCTN_STTUS = 'Y',
                   	   TODO_CF_DT = SYSDATE,
                       UDT_ID = #{creatId},
                       UDT_PGM = #{creatPgm},
                       UDT_DTTM = SYSDATE
                 WHERE
                       TODO_KEY = #{todoKey}
<!--                    AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId} -->
<!-- 				   AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId} -->
<!-- 		           AND SALES_CD = #{salesCd} -->
<!-- 		           AND TODO_FILE_TRGT_KEY = #{fileTrgtKey} -->
           </update>

           <select id="selectTodoDivList" parameterType="Map" resultType="camelMap">
				SELECT DISTINCT
						FN_CM05M01_CD_TO_NM(A.TODO_DIV2_CODE_ID) AS TODO_PGM_NM
				  FROM TB_WB20M03 A
				 GROUP BY A.TODO_DIV2_CODE_ID
           </select>

           <select id="selectApprovalYnList" parameterType="Map" resultType="camelMap">
	           SELECT Y.ID,
	                  Y.NAME,
	                  Y.DEPT_ID,
	                  D.DEPT_NM,
	                  Y.LEVEL_CD,
	                  L.LEVEL_NM,
	                  NVL(TO_CHAR(X.TODO_CF_DT, 'YYYY-MM-DD'), '') AS TODO_CF_DT		/* 승인일자 */
	                  FROM (
						        SELECT TODO_KEY, CO_CD, TODO_ID, TODO_CF_DT
						         FROM TB_WB20M03
						        WHERE TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
						          AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
						          AND SALES_CD = #{salesCd}
						          AND TODO_FILE_TRGT_KEY = #{fileTrgtKey}
						        ORDER BY TODO_KEY ASC
				        ) X
				       INNER JOIN TB_CM06M01 Y
				       ON X.CO_CD = Y.CO_CD
				       AND X.TODO_ID = Y.ID
				       LEFT OUTER JOIN TB_CM04M01 D
				       ON Y.DEPT_ID = D.DEPT_ID
				       LEFT OUTER JOIN TB_CM07M01 L
				       ON Y.LEVEL_CD = L.LEVEL_CD

			</select>


           <select id="selectApprovalMaxTodoKeyChk" parameterType="Map" resultType="camelMap">
               SELECT MAX(TODO_KEY) AS TODO_KEY
                 FROM (
                       SELECT X.TODO_KEY, X.TODO_CF_DT,
                             (SELECT MIN(Y.TODO_KEY)
                                FROM TB_WB20M03 Y
                               WHERE Y.TODO_CO_CD = #{todoCoCd}
                                 AND Y.SALES_CD = #{salesCd}
                                 AND Y.TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
                                 AND Y.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
                              ) AS CHK
                         FROM TB_WB20M03 X
                        WHERE X.TODO_CO_CD = #{todoCoCd}
                          AND X.SALES_CD = #{salesCd}
                          AND X.TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
                          AND X.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
                        ) S
                WHERE TODO_KEY BETWEEN CHK AND TO_NUMBER(#{todoKey, jdbcType=VARCHAR})-1
               --AND  NVL(TO_CHAR(TODO_CF_DT,'YYYY-MM-DD'),'') = ''
                  AND  TODO_CF_DT IS NULL
           </select>

    <update id="updateQmMobileApproval" parameterType="Map">
         UPDATE TB_WB20M03
            SET TODO_CF_DT = SYSDATE,
                TODO_CF_OPN = #{todoCfOpn},
                UDT_ID = #{todoId},
                UDT_PGM = #{creatPgm},
                UDT_DTTM = SYSDATE
          WHERE
                TODO_FILE_TRGT_KEY = #{todoFileTrgtKey}
                AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
                AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
                AND SALES_CD = #{salesCd}
                AND SANCTN_SN = #{sanctnSn}
    </update>

    <select id="selectGetDeptList" parameterType="Map" resultType="camelMap">
        SELECT CODE_ID, CODE_NM FROM TB_CM05M01 WHERE CODE_ID LIKE 'COBGB%'
    </select>


	<!-- 결재목록 및 결재상태 결재버튼 등 불러오기 -->
	<select id="selectGetApprovalList" parameterType="Map" resultType="camelMap">
		SELECT A.TODO_KEY
			, A.SANCTN_SN
			, A.CO_CD
			, A.TODO_DIV1_CODE_ID
			, A.TODO_DIV2_CODE_ID
			, A.TODO_ID			/* 대상자 ID */
			, B.NAME AS TODO_NM		/* 작성자 이름 */
			/* 결재요청자와 결재자가 같은 팀이면 팀장구분을 리턴하고 그외는 공백으로 처리함(이슈 결재처리시 위험도평가에서 사용함 */
			, DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),B.TEAM_MANAGER,'') AS TEAM_MANAGER		/* 팀장구분 */
			, NVL(TO_CHAR(A.TODO_CF_DT, 'YYYY-MM-DD'), ' ') AS TODO_CF_DT		/* 승인일자 */
			, A.TODO_CF_OPN
			, A.SANCTN_STTUS
			, DECODE(A.SANCTN_STTUS, 'Y', '승인', 'N', '미승인', ' ') AS SANCTN_STTUS_NM
			, B.TEAM_MANAGER AS DEPT_TEAM_MANAGER
			,
			(
				SELECT SANCTN_STTUS
					FROM
					(
					SELECT SANCTN_STTUS
						, ROWNUM RN
						FROM TB_WB20M03 B
					WHERE 1=1
						AND A.SANCTN_SN <![CDATA[ > ]]> B.SANCTN_SN
						AND A.CO_CD = B.CO_CD
						AND A.TODO_DIV1_CODE_ID = B.TODO_DIV1_CODE_ID
						AND A.TODO_DIV2_CODE_ID = B.TODO_DIV2_CODE_ID
<!-- 						AND A.SALES_CD = B.SALES_CD -->
						AND A.TODO_NO = B.TODO_NO
					ORDER BY B.SANCTN_SN DESC
					)
					WHERE RN=1
			) AS PRE_STTUS 			/* 하위 완료여부 */
			,
			(
				SELECT SANCTN_STTUS
					FROM
					(
					SELECT SANCTN_STTUS
						, ROWNUM RN
						FROM TB_WB20M03 B
					WHERE 1=1
						  AND A.SANCTN_SN <![CDATA[ < ]]> B.SANCTN_SN
						  AND A.CO_CD = B.CO_CD
						AND A.TODO_DIV1_CODE_ID = B.TODO_DIV1_CODE_ID
						AND A.TODO_DIV2_CODE_ID = B.TODO_DIV2_CODE_ID
<!-- 						AND A.SALES_CD = B.SALES_CD -->
						AND A.TODO_NO = B.TODO_NO
					ORDER BY B.SANCTN_SN DESC
					)
					WHERE RN=1
			) AS NEXT_STTUS 			/* 상위 완료여부 */
			, A.SALES_CD
			, A.PG_PATH
			, SUBSTR(A.PG_PATH, INSTR(A.PG_PATH, '/', -1)+1) AS DOC_NM		/* 문서명 pgmId */
			, A.TODO_FILE_TRGT_KEY
			, A.TODO_CO_CD
			, A.TODO_NO
			, A.TODO_CODE_KIND
			, A.TODO_CODE_ID
			, NVL(NVL(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), TO_CHAR(A.CREAT_DTTM, 'YYYY-MM-DD')), ' ') AS CREAT_DTTM
			, A.PG_PARAM
			, SUBSTR(B.DEPT_ID, 1, 5) AS DEPT_ID

			, DECODE(
				  SUBSTR(B.DEPT_ID, 1, 5)
				, 'GUN30', NVL(D.SALE_TEAM_MD, E.SALE_TEAM_MD)
				, 'GUN40', NVL(D.DSGN_TEAM_MD, E.DSGN_TEAM_MD)
				, 'GUN60', NVL(D.PROD_TEAM_MD, E.PROD_TEAM_MD)
				, 'TRN50', NVL(D.MATR_TEAM_MD, E.MATR_TEAM_MD)
				, ''
			) AS ACT_MH
			FROM TB_WB20M03 A
					LEFT OUTER JOIN TB_CM06M01 B  ON A.TODO_ID = B.ID
					LEFT OUTER JOIN TB_CM06M01 C  ON A.CREAT_ID = C.ID
					LEFT OUTER JOIN TB_QM01P01 D  ON A.TODO_NO = D.REQ_NO
												  AND B.TEAM_MANAGER = 'TEAM01'
					LEFT OUTER JOIN TB_WB24M03 E  ON A.TODO_NO = E.ISS_NO
												  AND B.TEAM_MANAGER = 'TEAM01'
		WHERE 1=1
			<if test="todoKey != null and !todoKey.equals('')">
				AND A.TODO_KEY = #{todoKey}
			</if>
			<if test="sanctnSn != null and !sanctnSn.equals('')">
				AND A.SANCTN_SN = #{sanctnSn}
			</if>
			<if test="coCd != null and !coCd.equals('')">
				AND A.CO_CD = #{coCd}
			</if>
			<if test="todoDiv1CodeId != null and !todoDiv1CodeId.equals('')">
				AND A.TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
			</if>
			<if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
				AND A.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
			</if>
			<!-- TO_DO ~ 시작컬럼은 대상업무에서 넘어온 데이터 -->
			<if test="salesCd != null and !salesCd.equals('')">
				AND A.SALES_CD = #{salesCd}
			</if>
			<if test="pgPath != null and !pgPath.equals('')">
				<!-- / 로 SLIT 하여 마지막부분이 문서명 -->
				AND A.PG_PATH = #{pgPath}
			</if>
			<if test="todoFileTrgtKey != null and !todoFileTrgtKey.equals('')">
				AND A.TODO_FILE_TRGT_KEY = #{todoFileTrgtKey}
			</if>
			<if test="todoCoCd != null and !todoCoCd.equals('')">
				AND A.TODO_CO_CD = #{todoCoCd}
			</if>
			<if test="todoNo != null and !todoNo.equals('')">
				AND A.TODO_NO = #{todoNo}
			</if>
			<if test="histNo != null and !histNo.equals('')">
				AND A.ETC_FIELD2 = #{histNo}
			</if>
				AND A.CREAT_DTTM IN (	SELECT MAX(CREAT_DTTM)
									  FROM TB_WB20M03
									 WHERE 1 = 1
									<if test="todoKey != null and !todoKey.equals('')">
										AND TODO_KEY = #{todoKey}
									</if>
									<if test="todoCoCd != null and !todoCoCd.equals('')">
										AND TODO_CO_CD = #{todoCoCd}
									</if>
									<if test="todoDiv1CodeId != null and !todoDiv1CodeId.equals('')">
										AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
									</if>
									<if test="todoDiv2CodeId != null and !todoDiv2CodeId.equals('')">
										AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
									</if>
									<!-- TO_DO ~ 시작컬럼은 대상업무에서 넘어온 데이터 -->
									<if test="salesCd != null and !salesCd.equals('')">
										AND SALES_CD = #{salesCd}
									</if>
									<if test="todoFileTrgtKey != null and !todoFileTrgtKey.equals('')">
										AND TODO_FILE_TRGT_KEY = #{todoFileTrgtKey}
									</if>
									<if test="todoNo != null and !todoNo.equals('')">
										AND TODO_NO = #{todoNo}
									</if>
									<if test="histNo != null and !histNo.equals('')">
										AND ETC_FIELD2 = #{histNo}
									</if>
								  )
		ORDER BY A.SANCTN_SN DESC
	</select>

	<!-- 결재 승인 -->
	<update id="updateApprovalLine" parameterType="Map">
		UPDATE TB_WB20M03
			SET
		TODO_CF_DT = SYSDATE
		, SANCTN_STTUS = 'Y'
		, TODO_CF_OPN = #{todoCfOpn}
		, UDT_ID = #{userId}
		, UDT_PGM = #{pgmId}
		, UDT_DTTM = SYSDATE
		WHERE TODO_KEY = #{todoKey}
			AND SANCTN_SN = #{sanctnSn}
			AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
	</update>


	<!-- 결재 취소 -->
	<update id="updateApprovalCancle" parameterType="Map">
		UPDATE TB_WB20M03
			SET
				  TODO_CF_DT = ''
				, SANCTN_STTUS = 'N'
				, TODO_CF_OPN = ''
				, UDT_ID = #{userId}
				, UDT_PGM = #{pgmId}
				, UDT_DTTM = SYSDATE
		WHERE TODO_NO = #{todoNo}  --해당업무 마스터 번호
			AND SANCTN_SN = #{sanctnSn}  --결재순번
		    AND TODO_ID   = #{userId}	  --결재대상자ID
			AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}	--공유결재구분
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}	--구분프로그램
	</update>

	<!-- 결재목록 불러오기 -->
	<select id="selectSignResUserlst" parameterType="Map" resultType="camelMap">
		SELECT *
		  FROM(
		SELECT
			ROWNUM AS RNUM, A.*
		FROM
		(
			SELECT   A.CO_CD AS WBS_PLANCO_CD,
					 A.CO_CD,
					 FN_CM05M01_CD_TO_NM(A.CO_CD) WBS_PLANCO_CD_NM,
			         A.ID AS USR_NM,
			         A.EMP_NO AS EMP_NO,
					 A.NAME AS NAME,
					 A.TEL_NO AS TEL_NO,
					 A.EMAIL AS EMAIL,
					 B.DEPT_NM AS DT_NM,
					 D.LEVEL_NM AS JIK,
					 C.TODO_DIV1_CODE_ID  AS TODO_DIV1_CODE_ID,
					 DECODE(C.TODO_DIV1_CODE_ID, 'TODODIV10', '공유', 'TODODIV20', '결재', '') AS GB
					 , C.SANCTN_STTUS
					 , DECODE(C.SANCTN_STTUS, 'Y', '승인', 'N', '미승인', ' ') AS SANCTN_STTUS_NM
					 , NVL(TO_CHAR(C.CREAT_DTTM, 'YYYY-MM-DD'), '') AS CREAT_DTTM		/* 요청일자 */
					 , NVL(TO_CHAR(C.TODO_CF_DT, 'YYYY-MM-DD'), '') AS TODO_CF_DT		/* 승인일자 */
					 , C.TODO_CF_OPN		/* 확인의견 */
					 , C.TODO_KEY
					 , C.SANCTN_SN
					 , C.TODO_ID
					 , C.TODO_DIV1_CODE_ID
					 , C.TODO_DIV2_CODE_ID
					 , C.SALES_CD
					 , 'U' AS FLAG
			FROM
				TB_CM06M01 A
				LEFT OUTER JOIN TB_CM07M01 D ON A.LEVEL_CD = D.LEVEL_CD
				INNER JOIN TB_CM04M01 B on A.DEPT_ID = B.DEPT_ID
				INNER JOIN TB_WB20M03 C ON A.ID = C.TODO_ID
				  AND C.TODO_FILE_TRGT_KEY = #{fileTrgtKey}
				  AND C.TODO_NO = #{reqNo}
				<if test="etcField2 != null and !etcField2.equals('')">
				  AND C.ETC_FIELD2 = #{etcField2}
				</if>
			ORDER BY C.TODO_DIV1_CODE_ID DESC, SANCTN_SN ASC, CREAT_DTTM ASC
			) AS a
		 ) A
 	</select>

 	<!-- 사용자 등록된 기본 결재라인 불러오기  -->
	<select id="selectSignResUserlstInit" parameterType="Map" resultType="camelMap">
		SELECT *
		  FROM(
		SELECT
			ROWNUM AS RNUM, ROWNUM AS SANCTN_SN, A.*
			FROM
			(
				SELECT T.*
					FROM
						(
							SELECT   A.CO_CD AS WBS_PLANCO_CD,
									 A.CO_CD,
									 FN_CM05M01_CD_TO_NM(A.CO_CD) WBS_PLANCO_CD_NM,
							         A.ID AS USR_NM,
							         A.EMP_NO AS EMP_NO,
									 A.NAME AS NAME,
									 A.TEL_NO AS TEL_NO,
									 A.EMAIL AS EMAIL,
									 B.DEPT_NM AS DT_NM,
									 D.LEVEL_NM AS JIK,
									 'TODODIV20'  AS TODO_DIV1_CODE_ID,
									 '결재' AS GB
									 , C.APP_SEQ AS SANCTN_SN
									 , '' AS SANCTN_STTUS
									 , C.APP_ID AS TODO_ID
									 , '미승인' AS SANCTN_STTUS_NM
									 , 'I' AS FLAG
									 , RANK() OVER(ORDER BY C.APP_NO DESC) AS RNK
							FROM
								TB_CM06M01 A
								INNER JOIN TB_BM13M01 C ON(A.ID = C.APP_ID)
								LEFT OUTER JOIN TB_CM07M01 D ON A.LEVEL_CD = D.LEVEL_CD
								INNER JOIN TB_CM04M01 B ON(A.DEPT_ID = B.DEPT_ID)
							WHERE 1=1
								AND C.ID = #{userId}
								AND C.APP_DIV = #{appDiv}  	/* 발주서 */
							ORDER BY C.APP_SEQ ASC
						) T
						WHERE 1=1
						AND T.RNK = 1
			) AS A
		 )
 	</select>

	<!-- 결재 등록시 사용자 검색후 부서등 SELECT  -->
	<select id="selectShareUserInfo" parameterType="Map" resultType="camelMap">
	    SELECT  A.CO_CD AS CO_CD,
	    		C.CODE_NM AS CO_NM,
				A.ID AS ID,
				A.ID AS TODO_ID,
		        A.EMP_NO AS EMP_NO,
				A.NAME AS USR_NM,
				A.TEL_NO AS TEL_NO,
				A.EMAIL AS EMAIL,
				B.DEPT_NM AS DT_NM
				, (SELECT T.LEVEL_NM FROM TB_CM07M01 T WHERE T.LEVEL_CD=A.LEVEL_CD) AS LEVEL_NM
			FROM
				TB_CM06M01 A
				INNER JOIN TB_CM04M01 B on A.DEPT_ID = B.DEPT_ID
				INNER JOIN TB_CM05M01 C ON A.CO_CD = C.CODE_ID
				AND	A.USE_YN = 'Y'
			    AND A.ID =  #{userId}
	</select>

	<select id="selectmaxTodoKey" parameterType="Map" resultType="String">
		SELECT NVL(MAX(TODO_KEY)+1, 1) FROM TB_WB20M03
	</select>

	<select id="selectSystemCreateDttm" parameterType="Map" resultType="String">
		SELECT TO_CHAR(sysdate, 'YYYY-MM-DD HH24:MI:SS') FROM DUAL
	</select>

	<!-- todo insert -->
	<insert id="insertTodoMaster" parameterType="Map">
		MERGE INTO TB_WB20M03
			USING DUAL
			ON (
				TODO_KEY = #{todoKey}
				AND SANCTN_SN = #{sanctnSn}
				AND CO_CD = #{coCd}
				AND TODO_DIV1_CODE_ID = #{todoDiv1CodeId}
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
				)
		WHEN MATCHED THEN
			UPDATE SET
				TODO_ID = #{todoId,								jdbcType=VARCHAR}
				, SALES_CD = #{salesCd,							jdbcType=VARCHAR}
				, PG_PATH = #{pgPath,							jdbcType=VARCHAR}
				, TODO_FILE_TRGT_KEY = #{todoFileTrgtKey,		jdbcType=VARCHAR}
				, TODO_CO_CD = #{todoCoCd}
				, TODO_NO = #{todoNo}
				, TODO_CODE_KIND = #{todoCodeKind,				jdbcType=VARCHAR}
				, TODO_CODE_ID = #{todoCodeId,					jdbcType=VARCHAR}
				, UDT_ID = #{userId}
				, UDT_PGM = #{pgmId}
				/* , UDT_DTTM = SYSDATE */
				, PG_PARAM = #{pgParam,							jdbcType=VARCHAR}
				, TODO_TITL = #{todoTitl,						jdbcType=VARCHAR}
				, ETC_FIELD3 = ''
		WHEN NOT MATCHED THEN
		INSERT
		(
			TODO_KEY
			, SANCTN_SN
			, CO_CD
			, TODO_DIV1_CODE_ID
			, TODO_DIV2_CODE_ID
			, TODO_ID
			, TODO_CF_DT
			, TODO_CF_OPN
			, SANCTN_STTUS
			, SALES_CD
			, PG_PATH
			, TODO_FILE_TRGT_KEY
			, TODO_CO_CD
			, TODO_NO
			, TODO_CODE_KIND
			, TODO_CODE_ID
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM
			, PG_PARAM
			, TODO_TITL
		)
		VALUES
		(
			#{todoKey}
			, #{sanctnSn}
			, #{coCd}
			, #{todoDiv1CodeId}
			, #{todoDiv2CodeId}
			, #{todoId,					jdbcType=VARCHAR}
    <choose>
        <when test="userId == todoId and (todoDiv2CodeId !='TODODIV2150' and todoDiv2CodeId1 !='TODODIV2160')  ">
			, SYSDATE
			, ''
			, 'Y'
        </when>
        <otherwise>
			, #{todoCfDt,				jdbcType=VARCHAR}
			, #{todoCfOpn,				jdbcType=VARCHAR}
			, #{sanctnSttus,			jdbcType=VARCHAR}
        </otherwise>
    </choose>
			, #{salesCd,				jdbcType=VARCHAR}
			, #{pgPath,					jdbcType=VARCHAR}
			, #{todoFileTrgtKey,		jdbcType=VARCHAR}
			, #{todoCoCd}
			, #{todoNo}
			, #{todoCodeKind,			jdbcType=VARCHAR}
			, #{todoCodeId,				jdbcType=VARCHAR}
			, #{userId}
			, #{pgmId}
			, #{createDttm}
			, #{pgParam,				jdbcType=VARCHAR}
			, #{todoTitl,				jdbcType=VARCHAR}
		)
	</insert>
	<!-- todo insert -->

	<!-- 결재 todo  삭제 -->
	<delete id="deleteTodoMaster" parameterType="Map">
        DELETE FROM TB_WB20M03
		WHERE  1 = 1
        AND    TODO_KEY = #{todoKey}
        AND    SANCTN_SN = #{sanctnSn}
        AND    TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
	</delete>

	<!-- 결재 todo all 삭제 -->
	<delete id="deleteAllTodoMaster" parameterType="Map">
		DELETE
			FROM TB_WB20M03
		WHERE 1=1
			AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
			AND SALES_CD = #{salesCd}
			AND TODO_NO = #{todoNo}
	</delete>

	<!-- TODO 결재완료여부  -->
	<select id="selectApprovalYn" parameterType="Map" resultType="String">
		SELECT CASE
				WHEN( SUM(STATUS_NO) =  MAX(MAX_SN) )
					THEN 'Y'
				ELSE 'N'
			   END AS APPROVAL_YN
			FROM
			(
			SELECT DECODE(SANCTN_STTUS, 'Y', 1, 0) AS STATUS_NO
					, MAX(SANCTN_SN) OVER() MAX_SN
			FROM TB_WB20M03
				WHERE 1=1
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
				AND SALES_CD = #{salesCd}
				AND TODO_NO = #{todoNo}
			)
	</select>

	<!-- 결재 todo 삭제시 순번  -->
	<update id="updateTodoMasterSanctnSn" parameterType="Map">
		UPDATE TB_WB20M03 A
			SET SANCTN_SN = (
							SELECT RN
				              FROM
				              (
				              	SELECT RID, ROWNUM RN
				                  FROM
				                  (
			                  		SELECT ROWID RID
			                          FROM TB_WB20M03
			                         WHERE TODO_NO = #{todoNo}
			                           AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
			                         ORDER BY SANCTN_SN
		                          )
			                  )
				            WHERE RID = A.ROWID
			            	)
		WHERE A.TODO_NO = #{todoNo}
		  AND A.TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
	</update>


	<!-- TODO 모바일 뷰어 조회  -->
    <select id="selectMobileTodoSelect" parameterType="Map" resultType="camelMap">
           SELECT T.CO_CD
                , T.TODO_KEY
                , T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
                , FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재)명
                , T.TODO_DIV2_CODE_ID
                , (SELECT X.CODE_NM FROM TB_CM05M01 X WHERE X.CODE_ID = T.TODO_DIV2_CODE_ID) AS TODO_DIV2_CODE_NM --발생프로그램 명
                , T.SALES_CD --Sales Code
                , T.TODO_NO  --관리번호
                ,T.TODO_ID
                ,
                (
                    SELECT A.NAME
                        FROM TB_CM06M01 AS A
                    WHERE A.ID = T.TODO_ID
                ) AS TODO_NM --대상자명
                , TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD HH24:MI:SS') AS TODO_CF_DT  --확인일자
                , T.TODO_CF_OPN   --확인의견
                , T.CREAT_ID  --생성자
                ,
                (
                    SELECT A.NAME
                        FROM TB_CM06M01 AS A
                    WHERE A.ID = T.CREAT_ID
                ) AS CREAT_NM   /*생성자명 */
                , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM  --생성일시
                , T.UDT_ID  --최종변경자
                ,
                (
                    SELECT A.NAME
                        FROM TB_CM06M01 AS A
                    WHERE A.ID = T.UDT_ID
                ) AS UDT_NM /*변경자명 */
                , TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM  --최종변경일자
                , T.TODO_TITL AS TODO_TITL
                FROM TB_WB20M03 T
                WHERE TODO_KEY = #{todoKey}
    </select>

	<!-- 최종결재 완료여부 -->
	<select id="selectTodoFinalYn" parameterType="Map" resultType="camelMap">
		SELECT    A.TODO_NO
				, MIN(NVL(A.SANCTN_STTUS, 'N')) TODO_YN
			FROM TB_WB20M03 A
		WHERE 1=1
				AND TODO_DIV2_CODE_ID = #{todoDiv2CodeId}
				AND TODO_NO = #{todoNo}
				GROUP BY A.TODO_NO
	</select>


	<!-- ToDo List  메인 화면 조회 카운터  -->
	<select id="M08selectToDoCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		 FROM (SELECT 	T.*
						, NVL((
							  SELECT COUNT(*) CNT
							  FROM TB_WB20M03 S
							  WHERE S.TODO_DIV1_CODE_ID = T.TODO_DIV1_CODE_ID
							    AND S.TODO_DIV2_CODE_ID = T.TODO_DIV2_CODE_ID
							    AND S.SALES_CD = T.SALES_CD
							    AND S.TODO_NO = T.TODO_NO
							    AND S.SANCTN_STTUS = 'N'
							    AND S.TODO_ID != T.TODO_ID
							    AND S.SANCTN_SN <![CDATA[ < ]]> T.SANCTN_SN
		 				), 0) AS BEFORE_NOT_CONFIRM  --이전미결자료 존재여부
				FROM TB_WB20M03 T
						LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
				) T
		WHERE 1=1
		<if test="beforeNotConfirm != null and !beforeNotConfirm.equals('')">
		  AND BEFORE_NOT_CONFIRM = 0 --이전 미결자료 존재 여부 (전무님만 해당되게 변경 처리함 2025.03.06)
		</if>
		<include refid="selectToDoListCondition"></include>
	</select>

	<!-- ToDo List 메인 화면 조회 리스트  -->
	<select id="M08selectToDoList" parameterType="Map" resultType="camelMap">
		SELECT Z.*
		FROM
		(
			SELECT X.*
					, ROWNUM AS RN
			FROM
				(
					SELECT T.CO_CD
					    , T.TODO_KEY  --TO DO KEY
						, T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
						, T.TODO_DIV2_CODE_ID
						, FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재) 명
						, X.CODE_NM  			AS TODO_DIV2_CODE_NM 	 --발생프로그램 명
						, T.SALES_CD --Sales Code
						, T.TODO_NO  --관리번호
						, T.SANCTN_SN  --결제순번
						, T.TODO_ID
						, B.NAME       AS TODO_NM --대상자명
						/* 결재요청자와 결재자가 같은 팀이면 팀장구분을 리턴하고 그외는 공백으로 처리함(이슈 결재처리시 위험도평가에서 사용함
						 * 계획이슈 조치결과,  실적이슈 조치결과는 팀장이 위험도 평가를 해야함 */
--						, DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),B.TEAM_MANAGER,'') AS TEAM_MANAGER		/* 팀장구분 */
						, DECODE(T.TODO_DIV2_CODE_ID, 'TODODIV2090',DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),'평가',''),'') AS TEAM_MANAGER		/* 팀장구분 */
						, T.SANCTN_STTUS
						, T.PG_PATH
						, T.TODO_FILE_TRGT_KEY
						, T.TODO_NO
						, CASE WHEN (T.TODO_DIV2_CODE_ID = 'TODODIV2100' OR T.TODO_DIV2_CODE_ID = 'TODODIV1100') THEN (T.TODO_NO ||' ' || T.ETC_FIELD2 || '차')
						       ELSE T.TODO_NO
						       END AS SHW_TODO_NO
						, T.PG_PARAM
						, TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
						, T.TODO_CF_OPN  --확인의견
						, T.CREAT_ID  --생성자
						, C.NAME      AS CREAT_NM	/*생성자명 */
						, TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
						, T.UDT_ID  --최종변경자
						,
						(
							SELECT A.NAME
								FROM TB_CM06M01 AS A
							WHERE A.ID = T.UDT_ID
						) AS UDT_NM	/*변경자명 */
						, TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
						, T.TODO_TITL AS TODO_TITL
						, T.CREAT_PGM
						, T.ETC_FIELD2
						, NVL((
							  SELECT COUNT(*) CNT
							  FROM TB_WB20M03 S
							  WHERE S.TODO_DIV1_CODE_ID = T.TODO_DIV1_CODE_ID
							    AND S.TODO_DIV2_CODE_ID = T.TODO_DIV2_CODE_ID
							    AND S.SALES_CD = T.SALES_CD
							    AND S.TODO_NO = T.TODO_NO
							    AND S.SANCTN_STTUS = 'N'
							    AND S.TODO_ID != T.TODO_ID
							    AND S.SANCTN_SN <![CDATA[ < ]]> T.SANCTN_SN
		 				), 0) AS BEFORE_NOT_CONFIRM  --이전미결자료 존재여부
					FROM TB_WB20M03 T
							LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
							LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
							LEFT OUTER JOIN TB_CM06M01 C  ON T.CREAT_ID = C.ID
					WHERE 1 = 1
						<include refid="selectToDoListCondition"></include>
						/* ORDER BY T.SALES_CD DESC, T.TODO_NO DESC, T.SANCTN_SN DESC */
					ORDER BY TODO_DIV1_CODE_NM,  TODO_DIV2_CODE_NM, SALES_CD DESC, TODO_NM
				) AS X
				WHERE 1=1
				<if test="beforeNotConfirm != null and !beforeNotConfirm.equals('')">
				  AND BEFORE_NOT_CONFIRM = 0 --이전 미결자료 존재 여부 (전무님만 해당되게 변경 처리함 2025.03.06)
				</if>
			) AS Z
		WHERE  1 = 1
		  AND  Z.RN BETWEEN ${firstIndex} AND ${lastIndex}
	</select>

	<!-- 특정화면에서 사용자 승인/결재 자료 있는지 확인하여 list로 전달하기  -->
	<!-- 각 화면에서 결재자정보에 User 가 있으면 결재, 승인버튼 활성화 하기 위함 -->
	<select id="selectCurrentUserApprovalDataList" parameterType="Map" resultType="camelMap">
			SELECT T.CO_CD
			    , T.TODO_KEY  --TO DO KEY
				, T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
				, T.TODO_DIV2_CODE_ID
				, FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재) 명
				, X.CODE_NM  			AS TODO_DIV2_CODE_NM 	 --발생프로그램 명
				, T.SALES_CD --Sales Code
				, T.TODO_NO  --관리번호
				, T.SANCTN_SN  --결제순번
				, T.TODO_ID
				, B.NAME       AS TODO_NM --대상자명
				/* 결재요청자와 결재자가 같은 팀이면 팀장구분을 리턴하고 그외는 공백으로 처리함(이슈 결재처리시 위험도평가에서 사용함
				 * 계획이슈 조치결과,  실적이슈 조치결과는 팀장이 위험도 평가를 해야함 */
--				, DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),B.TEAM_MANAGER,'') AS TEAM_MANAGER		/* 팀장구분 */
				, DECODE(T.TODO_DIV2_CODE_ID, 'TODODIV2090',DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),'평가',''),'') AS TEAM_MANAGER		/* 팀장구분 */
				, T.SANCTN_STTUS
				, T.PG_PATH
				, T.TODO_FILE_TRGT_KEY
				, T.TODO_NO
				, CASE WHEN (T.TODO_DIV2_CODE_ID = 'TODODIV2100' OR T.TODO_DIV2_CODE_ID = 'TODODIV1100') THEN (T.TODO_NO ||' ' || T.ETC_FIELD2 || '차')
				       ELSE T.TODO_NO
				       END AS SHW_TODO_NO
				, T.PG_PARAM
				, TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
				, T.TODO_CF_OPN  --확인의견
				, T.CREAT_ID  --생성자
				, C.NAME      AS CREAT_NM	/*생성자명 */
				, TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
				, T.UDT_ID  --최종변경자
				,
				(
					SELECT A.NAME
						FROM TB_CM06M01 AS A
					WHERE A.ID = T.UDT_ID
				) AS UDT_NM	/*변경자명 */
				, TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
				, T.TODO_TITL AS TODO_TITL
				, T.CREAT_PGM
				, T.ETC_FIELD2
				, NVL((
					  SELECT COUNT(*) CNT
					  FROM TB_WB20M03 S
					  WHERE S.TODO_DIV1_CODE_ID = T.TODO_DIV1_CODE_ID
					    AND S.TODO_DIV2_CODE_ID = T.TODO_DIV2_CODE_ID
					    AND S.SALES_CD = T.SALES_CD
					    AND S.TODO_NO = T.TODO_NO
					    AND S.SANCTN_STTUS = 'N'
					    AND S.TODO_ID != T.TODO_ID
					    AND S.SANCTN_SN <![CDATA[ < ]]> T.SANCTN_SN
		 		), 0) AS BEFORE_NOT_CONFIRM  --이전미결자료 존재여부
			FROM TB_WB20M03 T
					LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
					LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
					LEFT OUTER JOIN TB_CM06M01 C  ON T.CREAT_ID = C.ID
			WHERE 1 = 1
			  AND T.SANCTN_STTUS 		= 'N'
			  AND T.TODO_NO 			= #{todoNo}
			  AND T.TODO_FILE_TRGT_KEY 	= #{todoFileTrgtKey}
			  AND T.TODO_ID 			= #{userId}
			<if test="salesCd != null and !salesCd.equals('')">
        	  AND T.SALES_CD 			= #{salesCd}
			</if>
			<if test="etcField2 != null and !etcField2.equals('')">
			  AND T.ETC_FIELD2 			= #{etcField2}
			</if>
			ORDER BY T.TODO_DIV1_CODE_ID DESC, T.CREAT_DTTM ASC
	</select>

	
	<!-- 특정화면에서 사용자 승인/결재 자료 있는지 확인하여 list로 전달하기  -->
	<!-- 각 화면에서 결재자정보에 User 가 있으면 결재, 승인버튼 활성화 하기 위함 -->
	<select id="selectCurrentUserApprovalDataListFromTodoKey" parameterType="Map" resultType="camelMap">
			SELECT T.CO_CD
				, T.TODO_KEY  --TO DO KEY
				, T.TODO_DIV1_CODE_ID --TO DO 구분(공유-결재)
				, T.TODO_DIV2_CODE_ID
				, FN_CM05M01_CD_TO_NM(T.TODO_DIV1_CODE_ID) AS TODO_DIV1_CODE_NM --TO DO 구분(공유-결재) 명
				, X.CODE_NM  			AS TODO_DIV2_CODE_NM 	 --발생프로그램 명
				, T.SALES_CD --Sales Code
				, T.TODO_NO  --관리번호
				, T.SANCTN_SN  --결제순번
				, T.TODO_ID
				, B.NAME       AS TODO_NM --대상자명
				/* 결재요청자와 결재자가 같은 팀이면 팀장구분을 리턴하고 그외는 공백으로 처리함(이슈 결재처리시 위험도평가에서 사용함
				 * 계획이슈 조치결과,  실적이슈 조치결과는 팀장이 위험도 평가를 해야함 */
--				, DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),B.TEAM_MANAGER,'') AS TEAM_MANAGER		/* 팀장구분 */
				, DECODE(T.TODO_DIV2_CODE_ID, 'TODODIV2090',DECODE(substr(C.DEPT_ID,0,5), substr(B.DEPT_ID,0,5),'평가',''),'') AS TEAM_MANAGER		/* 팀장구분 */
				, T.SANCTN_STTUS
				, T.PG_PATH
				, T.TODO_FILE_TRGT_KEY
				, T.TODO_NO
				, CASE WHEN (T.TODO_DIV2_CODE_ID = 'TODODIV2100' OR T.TODO_DIV2_CODE_ID = 'TODODIV1100') THEN (T.TODO_NO ||' ' || T.ETC_FIELD2 || '차')
					ELSE T.TODO_NO
					END AS SHW_TODO_NO
				, T.PG_PARAM
				, TO_CHAR(T.TODO_CF_DT, 'YYYY-MM-DD') AS TODO_CF_DT  --확인일자
				, T.TODO_CF_OPN  --확인의견
				, T.CREAT_ID  --생성자
				, C.NAME      AS CREAT_NM	/*생성자명 */
				, TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM  --생성일시
				, T.UDT_ID  --최종변경자
				,
				(
					SELECT A.NAME
						FROM TB_CM06M01 AS A
					WHERE A.ID = T.UDT_ID
				) AS UDT_NM	/*변경자명 */
				, TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM  --최종변경일자
				, T.TODO_TITL AS TODO_TITL
				, T.CREAT_PGM
				, T.ETC_FIELD2
				, NVL((
					SELECT COUNT(*) CNT
					FROM TB_WB20M03 S
					WHERE S.TODO_DIV1_CODE_ID = T.TODO_DIV1_CODE_ID
						AND S.TODO_DIV2_CODE_ID = T.TODO_DIV2_CODE_ID
						AND S.SALES_CD = T.SALES_CD
						AND S.TODO_NO = T.TODO_NO
						AND S.SANCTN_STTUS = 'N'
						AND S.TODO_ID != T.TODO_ID
						AND S.SANCTN_SN <![CDATA[ < ]]> T.SANCTN_SN
				), 0) AS BEFORE_NOT_CONFIRM  --이전미결자료 존재여부
			FROM TB_WB20M03 T
					LEFT OUTER JOIN TB_CM05M01 X ON  X.CODE_ID = T.TODO_DIV2_CODE_ID
					LEFT OUTER JOIN TB_CM06M01 B  ON T.TODO_ID = B.ID
					LEFT OUTER JOIN TB_CM06M01 C  ON T.CREAT_ID = C.ID
			WHERE 1 = 1
			AND T.SANCTN_STTUS 		= 'N'
			AND T.TODO_KEY 			= #{todoKey}
			AND T.TODO_ID 			= #{userId}
	</select>
 </mapper>