<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr05.mapper.CR05Mapper">
	<select id="selectClmnListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		FROM(	
			SELECT ROWNUM AS RNUM
				, OM.FILE_TRGT_KEY 					-- 파일대상KEY
				, OM.CO_CD 							-- 회사
				, R.CODE_NM	AS CO_NM				-- 회사명 
				, TO_CHAR(OM.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT 	--수주일자
				, OM.ORDRS_CLNT_CD	AS ORDRS_CLNT_CD				-- 고객사 코드
				, C.CLNT_NM	AS ORDRS_CLNT_NM		-- 고객사명
				, OM.ORDRS_NO						-- 수주번호
				, OM.CLNT_PJT						-- 고객사 PJT
				, OM.CTRT_NM						-- 계약명
				, OM.ORDRS_DIV						-- 수주구분
				, OM.ORDRS_AMT 	AS ORDRS_AMT		-- 수주금액
				, CONF.CONF_AMT         AS CONF_AMT -- 기매출확정금액
				, OCP.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT  -- 매출미확정금액
				, SELL_T.SELL_BILL_AMT 					-- 기계산서발행금액
				, 0 		AS	UNSELL_BILL_AMT 		-- 계산서 미발행금액
				, OCP.CLMN_PLAN_DIV						-- 수금구분
				, R3.CODE_NM AS CLMN_PLAN_DIV_NM		-- 수금구분명
				<!-- 수금리스트 -->
				, CLMN_T.CLMN_NO						-- 수금번호
				, TO_CHAR(CLMN_T.CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT	 -- 수금일자
				, SELL_T.CLMN_PLAN_SEQ					-- 수금계획순번
				, OM.CURR_CD	AS ORDRS_CURR_CD		-- 통화코드
				, R2.CODE_NM  	AS ORDRS_CURR_NM		-- 통화코드명
				, SELL_T.SELL_BILL_NO					-- 계산서 번호
				, CLMN_T.CLMN_DTL_AMT					-- 수금금액
				, OCP.CLMN_AMT     						-- 기수금금액    
														<!-- 미수금금액 -->
				, CLMN_T.BKAC_CD 						-- 계좌번호
				, R4.CODE_NM AS BKAC_NM					-- 계좌번호명
				, CLMN_T.PMNTMTD_CD						-- 수금유형코드
				, P.CODE_NM AS	PMNTMTD_NM				-- 수금유형명
				, CLMN_T.EXRATE							-- 환율	
				, CLMN_T.CLMN_RMK						-- 비고
				, U1.NAME AS CREAT_ID_NM
				, TO_CHAR(CLMN_T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM --생성일시
				, U2.NAME AS UDT_ID_NM
				, TO_CHAR(CLMN_T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM --최종변경일시
			FROM TB_CR02M01 OM	-- 수주마스터
			<!--  1. 수주마스터 LEFT JOIN 수금수금계획 -->
			LEFT OUTER JOIN (
			SELECT CO_CD
					, ORDRS_NO
					, CLMN_PLAN_SEQ
					, CLMN_PLAN_DIV
					, NVL(SUM(CLMN_AMT), 0) AS CLMN_AMT     --수금금액      
			FROM TB_CR02D01			-- 수금수금계획
			GROUP BY CO_CD, ORDRS_NO, CLMN_PLAN_SEQ	, CLMN_PLAN_DIV
			) AS OCP ON OCP.CO_CD = OM.CO_CD 	
							AND OCP.ORDRS_NO = OM.ORDRS_NO 
			<!--  2. 수주수금계획 LEFT JOIN 매출계산서상세 --> 	
			LEFT OUTER JOIN (
			SELECT 
				SBD.CO_CD, 
				SBD.ORDRS_NO,
				SB.SELL_BILL_NO, 
			<!-- 	SBD.SELL_DCSN_NO, -->
				SBD.CLMN_PLAN_SEQ,
				NVL(SUM(SBD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT
			FROM TB_CR04D01 SBD 
			<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세 -->	
				LEFT OUTER JOIN 
				TB_CR04M01 SB ON SB.CO_CD = SBD.CO_CD  
				AND SB.SELL_BILL_NO = SBD.SELL_BILL_NO
				GROUP BY SBD.CO_CD, SBD.ORDRS_NO, SB.SELL_BILL_NO, SBD.CLMN_PLAN_SEQ	
			) AS SELL_T	ON SELL_T.CO_CD = OCP.CO_CD -- 계산서
				AND SELL_T.ORDRS_NO = OCP.ORDRS_NO
				AND SELL_T.CLMN_PLAN_SEQ = OCP.CLMN_PLAN_SEQ						
			<!--  3. 매출계산서상세 LEFT JOIN 수금내역 -->	
			LEFT OUTER JOIN ( 
			SELECT CN.CLMN_NO		-- 수금번호	
				, CN.CO_CD      	-- 회사	
				, CND.ORDRS_NO	-- 수주번호	
				, CN.CLMN_DT      -- 수금일자	
				, CN.BKAC_CD      -- 계좌번호 	
				, CN.EXRATE       -- 환율		
				, CN.PMNTMTD_CD   -- 수금유형
				, NVL(SUM(CND.CLMN_DTL_AMT), 0) AS CLMN_AMT2	-- 수금금액	
				, CN.CLMN_RMK     -- 비고 		
				, CND.CLMN_DTL_AMT					-- 수금금액
				, CND.CLMN_PLAN_SEQ					-- 수금계획순번
				, CN.CREAT_ID			
				, CN.UDT_ID	
				, CN.CREAT_DTTM						-- 생성일시
				, CN.UDT_DTTM							-- 최종변경일시
			FROM TB_CR05M01 	AS	CN				-- 수금
			LEFT JOIN TB_CR05D01 	AS		CND		-- 수금상세
				ON CND. CO_CD = CN.CO_CD 
				AND CND.CLMN_NO = CN.CLMN_NO 
			GROUP BY  CN.CLMN_NO, CN.CO_CD, CND.ORDRS_NO, CN.CLMN_DT, CN.BKAC_CD, CN.EXRATE, CN.PMNTMTD_CD,
			CN.CLMN_RMK, CND.CLMN_DTL_AMT, CND.CLMN_PLAN_SEQ, CN.CREAT_ID, CN.UDT_ID, CN.CREAT_DTTM, CN.UDT_DTTM			
			) AS CLMN_T ON CLMN_T.CO_CD  = SELL_T.CO_CD
				AND CLMN_T.ORDRS_NO = SELL_T.ORDRS_NO
				AND CLMN_T.CLMN_PLAN_SEQ = SELL_T.CLMN_PLAN_SEQ
			<!-- 4. 매출확정 LEFT JOIN 매출확정상세 -->
			LEFT JOIN (
		     	SELECT SELL_D.CO_CD                                  		-- 회사코드
		           , SELL_DD.ORDRS_NO                           		    -- 수주번호
		           , SELL_DD.CLMN_PLAN_SEQ            			         	-- 수금계획순번
		           , NVL(SUM(SELL_DD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     -- 확정금액
		      	FROM TB_CR03M01 SELL_D
		             LEFT OUTER JOIN TB_CR03D01 SELL_DD ON SELL_DD.CO_CD = SELL_D.CO_CD
						AND SELL_DD.SELL_DCSN_NO = SELL_D.SELL_DCSN_NO
		      GROUP BY SELL_D.CO_CD, SELL_DD.ORDRS_NO, SELL_DD.CLMN_PLAN_SEQ
		     ) AS CONF  ON CONF.CO_CD   = OCP.CO_CD
		               AND CONF.ORDRS_NO   = OCP.ORDRS_NO
		               AND CONF.CLMN_PLAN_SEQ = OCP.CLMN_PLAN_SEQ
			LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = OM.ORDRS_CLNT_CD		-- 거래처 마스터 					
			LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = OM.CO_CD   		-- 회사
			LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = OM.ORDRS_DIV   	-- 수주구분
			LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = OM.CURR_CD   	    -- 통화단위
			LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = OCP.CLMN_PLAN_DIV	-- 수금구분
			LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN_T.BKAC_CD		-- 계좌번호
			LEFT OUTER JOIN TB_CM05M01 AS P ON P.CODE_ID =  CLMN_T.PMNTMTD_CD	-- 수금유형
			LEFT OUTER JOIN TB_CM06M01 AS U1 ON U1.ID = CLMN_T.CREAT_ID 		-- 생성자
			LEFT OUTER JOIN TB_CM06M01 AS U2 ON U2.ID = CLMN_T.UDT_ID	 		-- 최종변경자
			WHERE  1 = 1
				<if test="coCd != null and !coCd.equals('')">
				AND	OM.CO_CD = '${coCd}' --회사
			</if>
			<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
				AND NVL(TO_CHAR(OM.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			</if>
			<if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
				AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명
			</if>
			<if test="ordrsNo != null and !ordrsNo.equals('')">
				AND NVL(OM.ORDRS_NO , '.') LIKE '%${ordrsNo}%' --수주번호
			</if>
			<if test="clntPjt != null and !clntPjt.equals('')">
				AND NVL(OM.CLNT_PJT , '.') LIKE '%${clntPjt}%' --고객사PJT
			</if>
			<if test="ctrtNm != null and !ctrtNm.equals('')">
				AND NVL(OM.CTRT_NM  , '.') LIKE '%${ctrtNm}%' --계약명
			</if>
			<if test="ordrsDiv != null and !ordrsDiv.equals('')">
				AND NVL(OM.ORDRS_DIV, '.') LIKE '%${ordrsDiv}%' --수주구분
			</if>
			) AS T
			WHERE  1 = 1
	</select>
	
	<select id="selectClmnList" parameterType="Map" resultType="camelMap">
		<!-- 
			 TB_CR02M01		AS		OM(ORDRS_M)			수주마스터       
			 TB_CR02D01		AS		OCP(ORDRS_CP) 		수금수금계획  
			 _______________________________________________________
			 TB_CR04M01 	AS		SB(SELL_B)			매출계산서   
			 TB_CR04D01 	AS		SBD(SELL_BD)		매출계산서상세 
			 _______________________________________________________ SELL_T
			 TB_CR05M01 	AS		CN(CLMN)			수금  
			 TB_CR05D01 	AS		CD(CLMN_D)			수금상세   
			 _______________________________________________________ CLMN_T 
			 TB_CR03M01 	AS		SD(SELL_D)			매출확정    
			 TB_CR03D01 	AS		SDD(SELL_DD)		매출확정상세 
		-->
		SELECT T.*
		FROM   (
			SELECT T.*
				, ROWNUM AS RNUM
			FROM(	
			SELECT
				DISTINCT OM.FILE_TRGT_KEY 	AS ORDRS_FILE_TRGT_KEY		-- 파일대상KEY
				, OM.CO_CD 							-- 회사
				, R.CODE_NM	AS CO_NM				-- 회사명 
				, TO_CHAR(OM.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT 	-- 수주일자
				, OM.ORDRS_CLNT_CD	AS ORDRS_CLNT_CD				-- 고객사 코드
				, C.CLNT_NM	AS ORDRS_CLNT_NM		-- 고객사명
				, OM.ORDRS_NO						-- 수주번호
				, OM.CLNT_PJT						-- 고객사 PJT
				, OM.CTRT_NM						-- 계약명
				, OM.ORDRS_DIV						-- 수주구분
				, OM.ORDRS_AMT 	AS ORDRS_AMT		-- 수주금액
				, CONF.CONF_AMT AS CONF_AMT 		-- 기매출확정금액
				, OCP.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT  -- 매출미확정금액
				, SELL_T.SELL_BILL_AMT 					-- 기계산서발행금액
				, 0 		AS	UNSELL_BILL_AMT 		-- 계산서 미발행금액
				, OCP.CLMN_PLAN_DIV						-- 수금구분
				, R3.CODE_NM AS CLMN_PLAN_DIV_NM		-- 수금구분명
				<!-- 수금리스트 -->
				, NVL(CLMN_T.FILE_TRGT_KEY, 0) AS FILE_TRGT_KEY
				, CLMN_T.CLMN_NO						-- 수금번호
				, TO_CHAR(CLMN_T.CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT	 -- 수금일자
				, SELL_T.CLMN_PLAN_SEQ					-- 수금계획순번
				, OM.CURR_CD		AS ORDRS_CURR_CD	-- 통화코드
				, R2.CODE_NM  		AS ORDRS_CURR_NM	-- 통화코드명
				, SELL_T.SELL_BILL_NO					-- 계산서 번호
				, CLMN_T.CLMN_DTL_AMT					-- 수금금액
				, OCP.CLMN_AMT     						-- 기수금금액    
				, 0 		AS	UNCLMN_AMT				-- 미수금금액
				, CLMN_T.BKAC_CD 						-- 계좌번호코드
				, (SELECT  CODE_NM||' 계좌 : '||CODE_DESC AS CODE_NM
     				 FROM   TB_CM05M01 A
     				 WHERE  A.CODE_KIND = 'BKAC'  AND CODE_ID =  CLMN_T.BKAC_CD)  AS BKAC_NM -- 계좌번호
				<!-- , R4.CODE_NM AS BKAC_NM	 -->				
				, CLMN_T.PMNTMTD_CD						-- 수금유형코드
				, P.CODE_NM AS	PMNTMTD_NM				-- 수금유형명
				, CLMN_T.EXRATE							-- 환율	
				, CLMN_T.CLMN_RMK						-- 비고
				, U1.NAME AS CREAT_ID_NM
				, TO_CHAR(CLMN_T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM --생성일시
				, U2.NAME AS UDT_ID_NM
				, TO_CHAR(CLMN_T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM --최종변경일시
			FROM TB_CR02M01 OM	-- 수주마스터
			<!--  1. 수주마스터 LEFT JOIN 수금수금계획 -->
			LEFT OUTER JOIN (
			SELECT CO_CD
					, ORDRS_NO
					, CLMN_PLAN_SEQ
					, CLMN_PLAN_DIV
					, NVL(SUM(CLMN_AMT), 0) AS CLMN_AMT     --수금금액      
			FROM TB_CR02D01			-- 수금수금계획
			GROUP BY CO_CD, ORDRS_NO, CLMN_PLAN_SEQ	, CLMN_PLAN_DIV
			) AS OCP ON OCP.CO_CD = OM.CO_CD 	
					AND OCP.ORDRS_NO = OM.ORDRS_NO 
			<!--  2. 수주수금계획 LEFT JOIN 매출계산서상세 --> 	
			LEFT OUTER JOIN (
			SELECT 
				SBD.CO_CD, 
				SBD.ORDRS_NO,
				SB.SELL_BILL_NO, 
			<!-- 	SBD.SELL_DCSN_NO, -->
				SBD.CLMN_PLAN_SEQ,
				NVL(SUM(SBD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT
			FROM TB_CR04D01 SBD 
			<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세 -->	
				LEFT OUTER JOIN 
				TB_CR04M01 SB ON SB.CO_CD = SBD.CO_CD  
				AND SB.SELL_BILL_NO = SBD.SELL_BILL_NO
				GROUP BY SBD.CO_CD, SBD.ORDRS_NO, SB.SELL_BILL_NO, SBD.CLMN_PLAN_SEQ	
			) AS SELL_T	ON SELL_T.CO_CD = OCP.CO_CD -- 계산서
				AND SELL_T.ORDRS_NO = OCP.ORDRS_NO
				AND SELL_T.CLMN_PLAN_SEQ = OCP.CLMN_PLAN_SEQ						
			<!--  3. 매출계산서상세 LEFT JOIN 수금내역 -->	
			LEFT OUTER JOIN ( 
			SELECT DISTINCT CN.FILE_TRGT_KEY -- 수금의 파일대상키
				, CN.CLMN_NO		-- 수금번호	
				, CN.CO_CD      	-- 회사	
				, CND.ORDRS_NO		-- 수주번호	
				, CN.CLMN_DT      	-- 수금일자	
				, CN.BKAC_CD      	-- 계좌번호 	
				, CN.EXRATE       	-- 환율		
				, CN.PMNTMTD_CD   	-- 수금유형
				, NVL(SUM(CND.CLMN_DTL_AMT), 0) AS CLMN_AMT2	-- 수금금액	
				, CN.CLMN_RMK     	-- 비고 		
				, CND.CLMN_DTL_AMT					-- 수금금액
				, CND.CLMN_PLAN_SEQ					-- 수금계획순번
				, CN.CREAT_ID			
				, CN.UDT_ID	
				, CN.CREAT_DTTM						-- 생성일시
				, CN.UDT_DTTM						-- 최종변경일시
			FROM TB_CR05M01 	AS	CN				-- 수금
			LEFT JOIN TB_CR05D01 	AS		CND		-- 수금상세
				ON CND. CO_CD = CN.CO_CD 
				AND CND.CLMN_NO = CN.CLMN_NO 
			GROUP BY CN.FILE_TRGT_KEY, CN.CLMN_NO, CN.CO_CD, CND.ORDRS_NO, CN.CLMN_DT, CN.BKAC_CD, CN.EXRATE, CN.PMNTMTD_CD,
			CN.CLMN_RMK, CND.CLMN_DTL_AMT, CND.CLMN_PLAN_SEQ, CN.CREAT_ID, CN.UDT_ID, CN.CREAT_DTTM, CN.UDT_DTTM			
			) AS CLMN_T ON CLMN_T.CO_CD  = SELL_T.CO_CD
				AND CLMN_T.ORDRS_NO = SELL_T.ORDRS_NO
				AND CLMN_T.CLMN_PLAN_SEQ = SELL_T.CLMN_PLAN_SEQ
			<!-- 4. 매출확정 LEFT JOIN 매출확정상세 -->
			LEFT OUTER JOIN (
		     	SELECT SD.CO_CD                                  		-- 회사코드
		           , SDD.ORDRS_NO                           		    -- 수주번호
		           , SDD.CLMN_PLAN_SEQ            			         	-- 수금계획순번
		           , NVL(SUM(SDD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     -- 확정금액
		      	FROM TB_CR03M01 SD
		             LEFT OUTER JOIN TB_CR03D01 SDD ON SDD.CO_CD = SD.CO_CD
						AND SDD.SELL_DCSN_NO = SD.SELL_DCSN_NO
		      GROUP BY SD.CO_CD, SDD.ORDRS_NO, SDD.CLMN_PLAN_SEQ
		     ) AS CONF  ON CONF.CO_CD   = OCP.CO_CD
		               AND CONF.ORDRS_NO   = OCP.ORDRS_NO
		               AND CONF.CLMN_PLAN_SEQ = OCP.CLMN_PLAN_SEQ
			LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = OM.ORDRS_CLNT_CD			-- 거래처 마스터 					
			LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = OM.CO_CD   			-- 회사
			LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = OM.ORDRS_DIV   		-- 수주구분
			LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = OM.CURR_CD   	    	-- 통화단위
			LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = OCP.CLMN_PLAN_DIV		-- 수금구분
			LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN_T.BKAC_CD			-- 계좌번호
			LEFT OUTER JOIN TB_CM05M01 AS P ON P.CODE_ID =  CLMN_T.PMNTMTD_CD		-- 수금유형
			LEFT OUTER JOIN TB_CM06M01 AS U1 ON U1.ID = CLMN_T.CREAT_ID 			-- 생성자
			LEFT OUTER JOIN TB_CM06M01 AS U2 ON U2.ID = CLMN_T.UDT_ID	 			-- 최종변경자
			WHERE  1 = 1
			<if test="coCd != null and !coCd.equals('')">
				AND	OM.CO_CD = '${coCd}' --회사
			</if>
			<if test="strtDt != null and !strtDt.equals('') and endDt != null and !endDt.equals('')" >
				AND OM.ORDRS_DT BETWEEN TO_DATE( #{strtDt},'YYYYMMDD') AND TO_DATE( #{endDt},'YYYYMMDD')
			</if>
			<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
				AND NVL(TO_CHAR(OM.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			</if>
			<if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
				AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명
			</if>
			<if test="ordrsNo != null and !ordrsNo.equals('')">
				AND NVL(OM.ORDRS_NO , '.') LIKE '%${ordrsNo}%' --수주번호
			</if>
			<if test="clntPjt != null and !clntPjt.equals('')">
				AND NVL(OM.CLNT_PJT , '.') LIKE '%${clntPjt}%' --고객사PJT
			</if>
			<if test="ctrtNm != null and !ctrtNm.equals('')">
				AND NVL(OM.CTRT_NM  , '.') LIKE '%${ctrtNm}%' --계약명
			</if>
			<if test="ordrsDiv != null and !ordrsDiv.equals('')">
				AND NVL(OM.ORDRS_DIV, '.') LIKE '%${ordrsDiv}%' --수주구분
			</if>
				) AS T
				WHERE  1 = 1
			) AS T
			WHERE  1 = 1
	           AND RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<select id="select_cr05_Info" parameterType="Map" resultType="camelMap">
		SELECT DISTINCT A.FILE_TRGT_KEY				-- 파일대상KEY
			, SELL_T.SELL_BILL_NO 	AS SELL_BILL_NO -- 매출계산서번호
			, A.CO_CD 						 		-- 회사코드
			, R.CODE_NM 	AS CO_NM          		-- 회사명
			, B.ORDRS_NO							-- 수주번호
			, B. CLMN_AMT							-- 수금금액
			, A.CLMN_NO								-- 수금번호
			, A.ORDRS_CLNT_CD						-- 고객사
			, S.CLNT_NM AS ORDRS_CLNT_NM	 		-- 고객사명
			, TO_CHAR(CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT	 -- 수금일자
			, B.CLMN_PLAN_SEQ						-- 수금계획순번
			, A.CURR_CD								--통화단위
			, R2.CODE_NM  		AS ORDRS_CURR_NM	-- 통화코드명
			, NVL(A.EXRATE, 1) AS EXRATE			--환율
			, A.PMNTMTD_CD							-- 수금유형코드
			, P.CODE_NM AS	PMNTMTD_NM				-- 수금유형명
			, A.BKAC_CD								-- 계좌번호코드
			, (SELECT  CODE_NM||' 계좌 : '||CODE_DESC AS CODE_NM
					FROM   TB_CM05M01 A
   				 	WHERE  A.CODE_KIND = 'BKAC'  AND CODE_ID =  A.BKAC_CD)  AS BKAC_NM -- 계좌번호
			, A.CLMN_RMK							-- 비고
			, A.ETC_FIELD1
			, A.ETC_FIELD2
			, A.ETC_FIELD3
			, A.CREAT_ID
			, U1.NAME AS CREAT_ID_NM
			, A.CREAT_PGM
			, TO_CHAR(A.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM
			, A.UDT_ID 
			, U2.NAME AS UDT_ID_NM
			, A.UDT_PGM
			, TO_CHAR(A.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
		     , 'U' AS DATA_CHK
		FROM TB_CR05M01 AS A
			LEFT OUTER JOIN (
					SELECT 
						CO_CD 			-- 회사코드
						, ORDRS_NO		-- 수주번호	
						, CLMN_NO		-- 수금번호
						, NVL(SUM(CLMN_DTL_AMT), 0) AS CLMN_AMT	-- 수금금액	
						, CLMN_PLAN_SEQ					-- 수금계획순번
					FROM TB_CR05D01						-- 수금상세
					GROUP BY CO_CD, ORDRS_NO, CLMN_NO, CLMN_PLAN_SEQ	
					) AS B ON B.CO_CD =  A.CO_CD 
								AND B.CLMN_NO =  A.CLMN_NO
			<!-- 매출계산서 -->
			LEFT OUTER JOIN (
			SELECT 
				SBD.CO_CD, 
				SBD.ORDRS_NO,
				SB.SELL_BILL_NO, 
				SBD.CLMN_PLAN_SEQ,
				NVL(SUM(SBD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT
			FROM TB_CR04D01 SBD 
				LEFT OUTER JOIN 
				TB_CR04M01 SB ON SB.CO_CD = SBD.CO_CD  
				AND SB.SELL_BILL_NO = SBD.SELL_BILL_NO
				GROUP BY SBD.CO_CD, SBD.ORDRS_NO, SB.SELL_BILL_NO, SBD.CLMN_PLAN_SEQ	
			) AS SELL_T	ON SELL_T.CO_CD = A.CO_CD
				AND SELL_T.ORDRS_NO = B.ORDRS_NO
				AND SELL_T.CLMN_PLAN_SEQ = B.CLMN_PLAN_SEQ						
			LEFT OUTER JOIN TB_BM02M01 AS S ON S.CLNT_CD = A.ORDRS_CLNT_CD
			LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = A.CO_CD			--회사
		  	LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.CURR_CD			--통화단위
		  	LEFT OUTER JOIN TB_CM05M01 AS P ON P.CODE_ID =  A.PMNTMTD_CD		-- 수금유형
            LEFT OUTER JOIN TB_CM06M01 AS U1 ON U1.ID = A.CREAT_ID
            LEFT OUTER JOIN TB_CM06M01 AS U2 ON U2.ID = A.UDT_ID								
		WHERE  1 = 1
		AND A.FILE_TRGT_KEY =  #{fileTrgtKey}
		AND SELL_BILL_NO = #{sellBillNo}
			
	</select>
	
	<select id="select_cr05_Info_Dtl" parameterType="Map" resultType="camelMap">
			SELECT * FROM(
			SELECT -- DISTINCT 
				ORDRS.FILE_TRGT_KEY AS FILE_TRGT_KEY --파일대상KEY
				, ROWNUM	AS 	RNUM
			    , ORDRS.CO_CD             AS CO_CD             --회사코드
			    , R.CODE_NM               AS CO_CD_NM          --회사명
			    , ORDRS.ORDRS_NO          AS ORDRS_NO          --수주번호
			    , TO_CHAR(ORDRS.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT --수주일자
			    , ORDRS.ORDRS_CLNT_CD     AS ORDRS_CLNT_CD     --고객사
			    , C.CLNT_NM               AS ORDRS_CLNT_NM     --고객사명
			    , ORDRS.CLNT_PJT          AS CLNT_PJT          --고객사PJT
			    , ORDRS.CTRT_NM           AS CTRT_NM           --계약명
			    , ORDRS.CURR_CD           AS ORDRS_CURR_CD     --통화단위
			    , R2.CODE_NM              AS ORDRS_CURR_NM     --통화단위명
			    , NVL(ORDRS.EXRATE, 1)    AS ORDRS_EXRATE      --환율
			    <!-- 수주수금계획 -->
			    , CLMN.CLMN_PLAN_SEQ      AS CLMN_PLAN_SEQ     --수금계획순번
			    , CLMN.CLMN_PLAN_DIV      AS CLMN_PLAN_DIV     --수금구분
			    , R3.CODE_NM              AS CLMN_PLAN_DIV_NM  --수금구분명
			    , CLMN.CLMN_DIV_SEQ       AS CLMN_DIV_SEQ      --수금구분차수
			    , CLMN.CLMN_RATE          AS CLMN_RATE         --수금비율
			    , CLMN.CURR_CD            AS CLMN_CURR_CD      --통화단위
			    , R4.CODE_NM              AS CLMN_CURR_NM      --통화단위명
			    , NVL(CLMN.EXRATE, 1)     AS CLMN_EXRATE       --환율
			    , CLMN.CLMN_AMT           AS CLMN_AMT          --수금금액
			    , TO_CHAR(CLMN.BILL_PBLS_DT, 'YYYY-MM-DD') AS CLMN_BILL_PBLS_DT --계산서발행일자
			    , TO_CHAR(CLMN.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT           --수금일자
			    , CONF.CONF_AMT                 AS BEF_CONF_AMT --기 확정금액
			    , CLMN.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT   --미 확정금액
			    , 'N'                           AS CHK          --체크여부
			    , 0                             AS CONF_AMT     --확정금액
			    , SELL_T.SELL_BILL_AMT 					-- 기계산서발행금액
				, SELL_T.CLMN_PLAN_SEQ					-- 수금계획순번
				, SELL_T.SELL_BILL_NO					-- 계산서 번호
				, CLMN_T.CLMN_NO		AS CLMN_NO		-- 수금번호
				, CLMN_T.CLMN_AMT2		-- 수금의 수금금액
				, 0 	AS UNCLMN_AMT2	-- 수금의 미수금액
			FROM   TB_CR02M01 AS ORDRS
		       <!-- 수주수금계획 -->
		       JOIN TB_CR02D01 AS CLMN  ON CLMN.CO_CD    = ORDRS.CO_CD
				                       AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
		       <!-- 매출확정 -->
		       LEFT JOIN (
			              SELECT CM.CO_CD                                          --회사코드
			                   , CD.ORDRS_NO                                       --수주번호
			                   , CD.CLMN_PLAN_SEQ                                  --수금계획순번
			                   , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
			                   , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
			              FROM   TB_CR03M01 AS CM
			                     JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
									                  AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			              GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			             ) AS CONF  ON CONF.CO_CD         = CLMN.CO_CD
					               AND CONF.ORDRS_NO      = CLMN.ORDRS_NO
					               AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
				<!-- 매출계산서  -->   
				LEFT OUTER JOIN (
				SELECT 
					SELL_BD.CO_CD, 
					SELL_BD.ORDRS_NO,
					SELL_B.SELL_BILL_NO, 
				<!-- SELL_BD.SELL_DCSN_NO, -->
					SELL_BD.CLMN_PLAN_SEQ,
					NVL(SUM(SELL_BD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT	-- 매출계산서금액
				FROM TB_CR04D01 SELL_BD 
				<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세  -->	
					LEFT OUTER JOIN 
					TB_CR04M01 SELL_B ON SELL_B.CO_CD = SELL_BD.CO_CD  
					AND SELL_B.SELL_BILL_NO = SELL_BD.SELL_BILL_NO
					GROUP BY SELL_BD.CO_CD, SELL_BD.ORDRS_NO, SELL_B.SELL_BILL_NO, SELL_BD.CLMN_PLAN_SEQ	
				) AS SELL_T	ON SELL_T.CO_CD = CONF.CO_CD -- 계산서
					AND SELL_T.ORDRS_NO = CONF.ORDRS_NO
					AND SELL_T.CLMN_PLAN_SEQ = CONF.CLMN_PLAN_SEQ	 
				LEFT OUTER JOIN ( 
				SELECT CLMN_M.CLMN_NO		-- 수금번호	
					, CLMN_M.CO_CD      	-- 회사	
					, CLMN_D.ORDRS_NO	-- 수주번호	
					, CLMN_M.CLMN_DT      -- 수금일자	
					, CLMN_M.BKAC_CD      -- 계좌번호 	
					, CLMN_M.EXRATE       -- 환율		
					, CLMN_M.PMNTMTD_CD   -- 수금유형
					, NVL(SUM(CLMN_D.CLMN_DTL_AMT), 0) AS CLMN_AMT2	-- 수금금액	
					, CLMN_M.CLMN_RMK     -- 비고 		
					, CLMN_D.CLMN_DTL_AMT					-- 수금금액
					, CLMN_D.CLMN_PLAN_SEQ					-- 수금계획순번
					, CLMN_M.CREAT_ID			
					, CLMN_M.UDT_ID	
					, CLMN_M.CREAT_DTTM						-- 생성일시
					, CLMN_M.UDT_DTTM						-- 최종변경일시
				FROM TB_CR05M01 	AS	CLMN_M				-- 수금
				LEFT JOIN TB_CR05D01 	AS		CLMN_D		-- 수금상세
					ON CLMN_D. CO_CD = CLMN_M.CO_CD 
					AND CLMN_D.CLMN_NO = CLMN_M.CLMN_NO 
				GROUP BY  CLMN_M.CLMN_NO, CLMN_M.CO_CD, CLMN_D.ORDRS_NO, CLMN_M.CLMN_DT, CLMN_M.BKAC_CD, CLMN_M.EXRATE, CLMN_M.PMNTMTD_CD,
	    		CLMN_M.CLMN_RMK, CLMN_D.CLMN_DTL_AMT, CLMN_D.CLMN_PLAN_SEQ, CLMN_M.CREAT_ID, CLMN_M.UDT_ID, CLMN_M.CREAT_DTTM, CLMN_M.UDT_DTTM			
				) AS CLMN_T ON CLMN_T.CO_CD  = SELL_T.CO_CD
					AND CLMN_T.ORDRS_NO = SELL_T.ORDRS_NO
					AND CLMN_T.CLMN_PLAN_SEQ = SELL_T.CLMN_PLAN_SEQ
			LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD    --고객사
	       	LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD			--회사
	       	LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV	    --수주구분
	       	LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD		--통화단위
	       	LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV	--수금구분
	       	LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD			--통화단위
		WHERE 1 = 1 
		<if test="coCd != null and !coCd.equals('')">
			AND ORDRS.CO_CD LIKE '%${coCd}%' --회사
		</if>
		<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
			AND NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
		</if>
		<if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
			AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명
		</if>
		ORDER BY ORDRS.CO_CD, ORDRS.ORDRS_NO, CLMN.CLMN_PLAN_SEQ
		) T
   		WHERE  1 = 1
		AND    T.CO_CD   = #{coCd}
		AND    T.CLMN_NO = #{clmnNo}
	</select>
	
	<select id="select_insert_target_modal" parameterType="Map" resultType="camelMap">
		SELECT A.*
		FROM   (
				SELECT A.*
					, ROWNUM AS RN
				FROM	(
						SELECT DISTINCT A.FILE_TRGT_KEY
						     , A.CO_CD
							 , R.CODE_NM AS CO_NM
							 , A.ORDRS_CLNT_CD
							 , S.CLNT_NM AS ORDRS_CLNT_NM
							 , A.CLNT_PJT
							 , A.ORDRS_NO
							 , TO_CHAR(A.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT
							 , A.ORDRS_DIV
							 , R1.CODE_NM          AS ORDRS_DIV_NM
							 , A.CTRT_NM
							 , A.CURR_CD
							 , R2.CODE_NM          AS CURR_NM
							 , NVL(A.EXRATE, 1)    AS EXRATE
							 , NVL(A.ORDRS_AMT, 0) AS ORDRS_AMT
							 , P.CLMN_PLAN_SEQ
							 , P.CLMN_PLAN_DIV
							 , R3.CODE_NM          AS CLMN_PLAN_DIV_NM
							 , P.CLMN_DIV_SEQ
							 , TO_CHAR(NVL(P.CLMN_DIV_SEQ, 1)) || ' 차'  AS CLMN_DIV_SEQ_NM
							 , NVL(P.CLMN_RATE, 0) AS CLMN_RATE
							 , TO_CHAR(NVL(P.CLMN_RATE, 0)) || ' %'  AS CLMN_RATE_NM
							 , NVL(P.CLMN_AMT, 0)  AS CLMN_AMT
							 , TO_CHAR(P.BILL_PBLS_DT, 'YYYY-MM-DD') AS BILL_PBLS_DT
							 , TO_CHAR(P.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT
							 , NVL(C.SELL_DCSN_DTL_AMT, 0) AS BEF_CONF_AMT
							 , NVL(P.CLMN_AMT, 0) - NVL(C.SELL_DCSN_DTL_AMT, 0) AS MI_CONF_AMT
							 , NVL(C.SELL_DCSN_DTL_AMT, 0) AS SELL_DCSN_DTL_AMT
							 , ''  AS SELL_DCSN_NO
							 , 'N' AS CHK      --체크여부
							 , 0   AS CONF_AMT  --확정금액
							 , 'I' AS DATA_CHK
						FROM   TB_CR02M01 AS A --수주
						       --수금계획
							   JOIN TB_CR02D01 AS P  ON P.CO_CD    = A.CO_CD
							                                   AND P.ORDRS_NO = A.ORDRS_NO
							   --매출확정
							   LEFT OUTER JOIN (
								                SELECT DISTINCT CM.CO_CD
												     , CD.ORDRS_NO
													 , CD.CLMN_PLAN_SEQ
													 , SUM(NVL(CD.SELL_DCSN_DTL_AMT, 0)) AS SELL_DCSN_DTL_AMT
												FROM   TB_CR03M01 AS CM --매출확정
												       --매출확정상세
													   LEFT OUTER JOIN TB_CR03D01 AS CD  ON CD.CO_CD        = CM.CO_CD
													                                    AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
												GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
											   ) AS C  ON C.CO_CD         = P.CO_CD
											          AND C.ORDRS_NO      = P.ORDRS_NO
													  AND C.CLMN_PLAN_SEQ = P.CLMN_PLAN_SEQ
							   --회사
							   LEFT OUTER JOIN TB_CM05M01 AS R ON R.CODE_ID = A.CO_CD
							   --수주구분
							   LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = A.ORDRS_DIV
							   --통화단위
							   LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = A.CURR_CD
							   --수금계획구분
							   LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = P.CLMN_PLAN_DIV
							   --고객사
							   LEFT OUTER JOIN TB_BM02M01 AS S ON S.CLNT_CD = A.ORDRS_CLNT_CD
						WHERE  1 = 1
						ORDER BY A.CO_CD, A.ORDRS_CLNT_CD, A.ORDRS_NO
						) AS A
				WHERE  1 = 1
				AND    A.MI_CONF_AMT > 0
		       ) AS A
		WHERE  1 = 1
		AND    A.CO_CD = #{coCd}
		AND    A.ORDRS_CLNT_CD = #{ordrsClntCd}
		AND    A.CURR_CD       = #{currCd}
	</select>
		
	<!-- 수금번호 -->
	<select id="select_cr05_clmnNo" parameterType="Map" resultType="String">
		SELECT 'CLMN' || TO_CHAR(SYSDATE, 'YY') ||  LPAD((SELECT (TO_CHAR(MAX(TO_NUMBER(FILE_TRGT_KEY)))) + 1 FROM TB_CR05M01),4,0) FROM DUAL;
	</select>
	
	<select id="select_cr05_SeqNext" parameterType="Map" resultType="int">
		SELECT MAX(TO_NUMBER(FILE_TRGT_KEY)) + 1
		FROM TB_CR05M01
	</select>
	
</mapper>