<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr05.mapper.CR05Mapper">
	<select id="selectClmnListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM TB_CR05M01
	</select>
	
	<select id="selectClmnList" parameterType="Map" resultType="camelMap">
	 		SELECT * FROM(
			SELECT -- DISTINCT 
				 'GUN_CLMN230001' AS PID
				, 'GUN_CLMN230001_1' AS ID
				, CLMN_REG.FILE_TRGT_KEY
				, CASE WHEN CLMN_REG.CLMN_PLAN_SEQ IS NULL OR CLMN_REG.CLMN_PLAN_SEQ = '' THEN CLMN_REG.FILE_TRGT_KEY
						ELSE CLMN_REG.FILE_TRGT_KEY||'-'||CLMN_REG.CLMN_PLAN_SEQ
					  END AS TREE_ID
				, CLMN_REG.CLMN_PLAN_SEQ
				, CLMN_REG.CLMN_NO
				, TO_CHAR(CLMN_REG.CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT	-- 수금일자
				, CLMN_REG.PMNTMTD_CD
				, CLMN_REG.BKAC_CD	
				, ORDRS.FILE_TRGT_KEY AS FILE_TRGT_KEY --파일대상KEY
				, ROWNUM	AS 	RNUM
			    , ORDRS.CO_CD             AS CO_CD             		--회사코드
			    , R.CODE_NM               AS CO_CD_NM          		--회사명
			    , ORDRS.ORDRS_NO          AS ORDRS_NO          		--수주번호
			    , TO_CHAR(ORDRS.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT --수주일자
			    , ORDRS.ORDRS_CLNT_CD     AS ORDRS_CLNT_CD     --고객사
			    , C.CLNT_NM               AS ORDRS_CLNT_NM     --고객사명
			    , ORDRS.CLNT_PJT          AS CLNT_PJT          --고객사PJT
			    , ORDRS.CTRT_NM           AS CTRT_NM           --계약명
			    , ORDRS.CURR_CD           AS ORDRS_CURR_CD     --통화단위
			    , R2.CODE_NM              AS ORDRS_CURR_NM     --통화단위명
			    , NVL(ORDRS.EXRATE, 1)    AS ORDRS_EXRATE      --환율
			   	<!--  수주수금계획 -->
			    , CLMN.CLMN_PLAN_SEQ      AS CLMN_PLAN_SEQ     --수금계획순번
			    , CLMN.CLMN_PLAN_DIV      AS CLMN_PLAN_DIV     --수금구분
			    , R3.CODE_NM              AS CLMN_PLAN_DIV_NM  --수금구분명
			    , CLMN.CLMN_DIV_SEQ       AS CLMN_DIV_SEQ      --수금구분차수
			    , CLMN.CLMN_RATE          AS CLMN_RATE         --수금비율
			    , CLMN.CURR_CD            AS CLMN_CURR_CD      --통화단위
			    , R4.CODE_NM              AS CLMN_CURR_NM      --통화단위명
			    , NVL(CLMN.EXRATE, 1)     AS CLMN_EXRATE       --환율
			    , CLMN.CLMN_AMT           AS CLMN_AMT          --수금금액
			    , TO_CHAR(CLMN.BILL_PBLS_DT, 'YYYY-MM-DD') AS CLMN_BILL_PBLS_DT --계산서발행일자
			    , TO_CHAR(CLMN.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT           --수금일자
			    , CONF.CONF_AMT                 AS BEF_CONF_AMT --기 확정금액
			    , CLMN.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT   --미 확정금액
			    , 'N'                           AS CHK          --체크여부
			    , 0                             AS CONF_AMT     --확정금액
		     
		FROM   TB_CR02M01 AS ORDRS
		       <!--  수주수금계획 -->
		       JOIN TB_CR02D01 AS CLMN  ON CLMN.CO_CD    = ORDRS.CO_CD
				                       AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
		       <!--  매출확정 --> 
		       LEFT JOIN (
			              SELECT CM.CO_CD                                          --회사코드
			                   , CD.ORDRS_NO                                       --수주번호
			                   , CD.CLMN_PLAN_SEQ                                  --수금계획순번
			                   , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
			                   , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
			              FROM   TB_CR03M01 AS CM
			                     JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
									                  AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			              GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			             ) AS CONF  ON CONF.CO_CD         = CLMN.CO_CD
					               AND CONF.ORDRS_NO      = CLMN.ORDRS_NO
					               AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
		    	<!-- 수금 TB_CR05M01 JOIN 수금상세 TB_CR05D01 230707 추가 -->
					   JOIN (
								SELECT   CR05M.CO_CD	
										, CR05D.CLMN_PLAN_SEQ     --수금계획순번
										, CR05M.FILE_TRGT_KEY -- 파일대상키
										, CR05D.ORDRS_NO -- 수주번호
										, CR05M.CLMN_NO	  -- 수금번호
										, CR05M.CLMN_DT	  -- 수금일자
										, CR05M.PMNTMTD_CD -- 수금유형
										, CR05M.BKAC_CD -- 계좌번호
								FROM TB_CR05M01 AS CR05M
								JOIN TB_CR05D01 AS CR05D ON	CR05D.CO_CD = CR05M.CO_CD
										AND CR05D.CLMN_NO	= CR05M.CLMN_NO
					 ) AS CLMN_REG ON CLMN_REG.CO_CD = ORDRS.CO_CD
						AND CLMN_REG.ORDRS_NO = ORDRS.ORDRS_NO            
		       LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD     --고객사
		       LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD	--회사
		       LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV	--수주구분
		       LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD		--통화단위
		       LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV	--수금구분
		       LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD	--통화단위
			WHERE 1 = 1
			<if test="coCd != null and !coCd.equals('')">
				AND	ORDRS.CO_CD = '${coCd}' --회사
			</if>
			<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
				AND NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			</if>
			<if test="clntNm != null and !clntNm.equals('')">
				AND NVL(C.CLNT_NM, '.') LIKE '%${clntNm}%' --고객사명
			</if>
			<if test="ordrsNo != null and !ordrsNo.equals('')">
				AND NVL(ORDRS.ORDRS_NO , '.') LIKE '%${ordrsNo}%' --수주번호
			</if>
			<if test="clntPjt != null and !clntPjt.equals('')">
				AND NVL(ORDRS.CLNT_PJT , '.') LIKE '%${clntPjt}%' --고객사PJT
			</if>
			<if test="ctrtNm != null and !ctrtNm.equals('')">
				AND NVL(ORDRS.CTRT_NM  , '.') LIKE '%${ctrtNm}%' --계약명
			</if>
			<if test="ordrsDiv != null and !ordrsDiv.equals('')">
				AND NVL(ORDRS.ORDRS_DIV, '.') LIKE '%${ordrsDiv}%' --수주구분
			</if>
				) T
               	WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<select id="selectClmnInfoCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM TB_CR05D01
	</select>
	
	<select id="selectClmnInfo" parameterType="Map" resultType="camelMap">
		SELECT *
			FROM TB_CR05D01
	</select>
	
	<!-- 수금번호 -->
	<select id="select_cr05_clmnNo" parameterType="Map" resultType="String">
		SELECT 'CLMN' || TO_CHAR(SYSDATE, 'YY') ||  LPAD((SELECT (TO_CHAR(MAX(TO_NUMBER(FILE_TRGT_KEY)))) + 1 FROM TB_CR05M01),4,0) FROM DUAL;
	</select>
	
	<select id="select_cr05_SeqNext" parameterType="Map" resultType="int">
		SELECT MAX(TO_NUMBER(FILE_TRGT_KEY)) + 1
		FROM TB_CR05M01
	</select>
	
</mapper>