<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr05.mapper.CR05Mapper">
	<select id="selectClmnListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM TB_CR05M01
	</select>
	
	<select id="selectClmnList" parameterType="Map" resultType="camelMap">
	 	SELECT * FROM (
			SELECT ROWNUM AS RNUM
			, ORDRS.FILE_TRGT_KEY AS FILE_TRGT_KEY 	--파일대상KEY
			, ORDRS.CO_CD             AS CO_CD             --회사코드
		    , R.CODE_NM               AS CO_CD_NM          --회사명
		    , ORDRS.ORDRS_NO          AS ORDRS_NO          --수주번호
		    , TO_CHAR(ORDRS.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT --수주일자
		    , ORDRS.ORDRS_CLNT_CD     AS ORDRS_CLNT_CD     --고객사
		    , C.CLNT_NM               AS ORDRS_CLNT_NM     --고객사명
		    , ORDRS.CLNT_PJT          AS CLNT_PJT          --고객사PJT
		    , ORDRS.CTRT_NM           AS CTRT_NM           --계약명
		    , ORDRS.CURR_CD           AS ORDRS_CURR_CD     --통화단위
		    , R2.CODE_NM              AS ORDRS_CURR_NM     --통화단위명
		    , ORDRS.EXRATE            AS ORDRS_EXRATE      --환율
		    , CLMN.CLMN_AMT           AS CLMN_AMT          --수주수금계획금액
		    , CONF.CONF_AMT           AS CONF_AMT          --매출확정금액
		    , CLMN.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT  --매출미확정금액
		    , ORDRS.ORDRS_DIV         AS ORDRS_DIV         --수주구분
		    , R1.CODE_NM              AS ORDRS_DIV_NM      --수주구분명
		    , ORDRS.EST_NO            AS EST_NO            --견적서번호
		    , ORDRS.EST_DEG           AS EST_DEG           --견적차수
		    , ORDRS.ORDRS_AMT         AS ORDRS_AMT         --수주금액
		    , ORDRS.FWD_EXCH_JOIN_DT  AS FWD_EXCH_JOIN_DT  --선물환가입일
		    , ORDRS.FWD_EXCH_CHK_LIST AS FWD_EXCH_CHK_LIST --선물환 Check List
		    , ORDRS.ORDRGER           AS ORDRGER           --발주자
		    , ORDRS.MNG_ID            AS MNG_ID            --담당자
		    , ORDRS.CTRT_DOC          AS CTRT_DOC          --계약문서
		    , ORDRS.PMNT_MTD          AS PMNT_MTD          --결제방법
		    , ORDRS.ORDRS_RMK         AS ORDRS_RMK         --수주비고
		    , ORDRS.ORGN_SALES_CD     AS ORGN_SALES_CD     --원천Sales Code
		FROM  TB_CR02M01 AS ORDRS
			<!-- 수주수금계획 -->
			LEFT OUTER JOIN (
	             SELECT CO_CD                                 --회사
	                  , ORDRS_NO                              --수주번호
	                  , MAX(CURR_CD)          AS CLMN_CURR_CD --통화단위
	                  , NVL(MAX(EXRATE)  , 1) AS CLMN_EXRATE  --환율
	                  , NVL(SUM(CLMN_AMT), 0) AS CLMN_AMT     --수금금액                  
	             FROM   TB_CR02D01
	             GROUP BY CO_CD, ORDRS_NO
	            ) AS CLMN ON CLMN.CO_CD    = ORDRS.CO_CD
			              AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
			<!-- 매출확정 -->
		       JOIN (
		             SELECT CM.CO_CD                                          --회사코드
		                  , CD.ORDRS_NO                                       --수주번호
		                  , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
		                  , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
		             FROM   TB_CR03M01 AS CM
		                    JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
								AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
		             WHERE  1 = 1
		             AND CM.CO_CD = #{coCd}
		             AND TO_CHAR(CM.SELL_DCSN_DT, 'YYYYMMDD') BETWEEN #{strtDt} AND #{endDt} -- 확정일자
		             GROUP BY CM.CO_CD, CD.ORDRS_NO
		             ) AS CONF  ON CONF.CO_CD = ORDRS.CO_CD
						AND CONF.ORDRS_NO = ORDRS.ORDRS_NO
		       LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD --고객사
		       LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD   	--회사
		       LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV   --수주구분
		       LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD   	--통화단위
			WHERE 1 = 1
			<if test="coCd != null and !coCd.equals('')">
				AND	ORDRS.CO_CD = '${coCd}' --회사
			</if>
			<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
				AND NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			</if>
			<if test="clntNm != null and !clntNm.equals('')">
				AND NVL(C.CLNT_NM, '.') LIKE '%${clntNm}%' --고객사명
			</if>
			<if test="ordrsNo != null and !ordrsNo.equals('')">
				AND NVL(ORDRS.ORDRS_NO , '.') LIKE '%${ordrsNo}%' --수주번호
			</if>
			<if test="clntPjt != null and !clntPjt.equals('')">
				AND NVL(ORDRS.CLNT_PJT , '.') LIKE '%${clntPjt}%' --고객사PJT
			</if>
			<if test="ctrtNm != null and !ctrtNm.equals('')">
				AND NVL(ORDRS.CTRT_NM  , '.') LIKE '%${ctrtNm}%' --계약명
			</if>
			<if test="ordrsDiv != null and !ordrsDiv.equals('')">
				AND NVL(ORDRS.ORDRS_DIV, '.') LIKE '%${ordrsDiv}%' --수주구분
			</if>
				) T
               	WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<!-- 수금번호 -->
	<select id="select_cr05_clmnNo" parameterType="Map" resultType="String">
		SELECT 'CLMN' || TO_CHAR(SYSDATE, 'YY') ||  LPAD((SELECT (TO_CHAR(MAX(TO_NUMBER(FILE_TRGT_KEY)))) + 1 FROM TB_CR05M01),4,0) FROM DUAL;
	</select>
	
	<select id="select_cr05_SeqNext" parameterType="Map" resultType="int">
		SELECT MAX(TO_NUMBER(FILE_TRGT_KEY)) + 1
		FROM TB_CR05M01
	</select>
	
</mapper>