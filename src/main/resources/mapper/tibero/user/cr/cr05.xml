<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr05.mapper.CR05Mapper">
	<select id="selectClmnListCount" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		FROM(	
			SELECT ROWNUM AS RNUM
					, ORDRS_M.FILE_TRGT_KEY 			-- 파일대상KEY
					, ORDRS_M.CO_CD 					-- 회사
					, R.CODE_NM	AS CO_NM				-- 회사명 
					, TO_CHAR(ORDRS_M.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT 	--수주일자
					, ORDRS_M.ORDRS_CLNT_CD	AS ORDRS_CLNT_CD				-- 고객사 코드
					, C.CLNT_NM	AS ORDRS_CLNT_NM		-- 고객사명
					, ORDRS_M.ORDRS_NO					-- 수주번호
					, ORDRS_M.CLNT_PJT					-- 고객사 PJT
					, ORDRS_M.CTRT_NM					-- 계약명
					, ORDRS_M.ORDRS_DIV					-- 수주구분
					, ORDRS_M.ORDRS_AMT 	AS ORDRS_AMT-- 수주금액
					, CONF.CONF_AMT         AS CONF_AMT -- 기매출확정금액
					, ORDRS_CP.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT  -- 매출미확정금액
					, SELL_T.SELL_BILL_AMT					-- 기계산서발행금액
															<!-- 계산서 미발행금액 -->
					, ORDRS_CP.CLMN_PLAN_DIV				-- 수금구분
					, R3.CODE_NM AS CLMN_PLAN_DIV_NM		-- 수금구분명
					<!-- 수금리스트 -->
					, CLMN_T.CLMN_NO						-- 수금번호
					, TO_CHAR(CLMN_T.CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT	 -- 수금일자
					, SELL_T.CLMN_PLAN_SEQ					-- 수금계획순번
					, ORDRS_M.CURR_CD	AS ORDRS_CURR_CD	-- 통화코드
					, R2.CODE_NM  		AS ORDRS_CURR_NM	-- 통화코드명
					, SELL_T.SELL_BILL_NO					-- 계산서 번호
					, CLMN_T.CLMN_DTL_AMT					-- 수금금액
					, ORDRS_CP.CLMN_AMT     				-- 기수금금액    
															<!-- 미수금금액  -->
					, CLMN_T.BKAC_CD 						-- 계좌번호
					, R4.CODE_NM AS BKAC_NM					-- 계좌번호명
					, CLMN_T.PMNTMTD_CD						-- 수금유형
					, CLMN_T.EXRATE							-- 환율	
					, CLMN_T.CLMN_RMK						-- 비고
					, U1.NAME AS CREAT_ID_NM
					, TO_CHAR(CLMN_T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM --생성일시
					, U2.NAME AS UDT_ID_NM
					, TO_CHAR(CLMN_T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM --최종변경일시
				
			FROM TB_CR02M01 ORDRS_M	-- 수주마스터
			<!--  1. 수주마스터 LEFT JOIN 수금수금계획 -->
			LEFT OUTER JOIN (
			SELECT CO_CD
					, ORDRS_NO
					, CLMN_PLAN_SEQ
					, CLMN_PLAN_DIV
					, NVL(SUM(CLMN_AMT), 0) AS CLMN_AMT     --수금금액      
			FROM TB_CR02D01			-- 수금수금계획
			GROUP BY CO_CD, ORDRS_NO, CLMN_PLAN_SEQ	, CLMN_PLAN_DIV
			) AS ORDRS_CP ON ORDRS_CP.CO_CD = ORDRS_M.CO_CD 	
							AND ORDRS_CP.ORDRS_NO = ORDRS_M.ORDRS_NO 
			<!--  2. 수주수금계획 LEFT JOIN 매출계산서상세 --> 	
			LEFT OUTER JOIN (
			SELECT 
				SELL_BD.CO_CD, 
				SELL_BD.ORDRS_NO,
				SELL_B.SELL_BILL_NO, 
			<!-- 	SELL_BD.SELL_DCSN_NO, -->
				SELL_BD.CLMN_PLAN_SEQ,
				NVL(SUM(SELL_BD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT
			FROM TB_CR04D01 SELL_BD 
			<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세 -->	
				LEFT OUTER JOIN 
				TB_CR04M01 SELL_B ON SELL_B.CO_CD = SELL_BD.CO_CD  
				AND SELL_B.SELL_BILL_NO = SELL_BD.SELL_BILL_NO
				GROUP BY SELL_BD.CO_CD, SELL_BD.ORDRS_NO, SELL_B.SELL_BILL_NO, SELL_BD.CLMN_PLAN_SEQ	
			) AS SELL_T	ON SELL_T.CO_CD = ORDRS_CP.CO_CD -- 계산서
				AND SELL_T.ORDRS_NO = ORDRS_CP.ORDRS_NO
				AND SELL_T.CLMN_PLAN_SEQ = ORDRS_CP.CLMN_PLAN_SEQ						
			<!--  3. 매출계산서상세 LEFT JOIN 수금내역 -->	
			LEFT OUTER JOIN ( 
			SELECT CLMN.CLMN_NO		-- 수금번호	
				, CLMN.CO_CD      	-- 회사	
				, CLMN_D.ORDRS_NO	-- 수주번호	
				, CLMN.CLMN_DT      -- 수금일자	
				, CLMN.BKAC_CD      -- 계좌번호 	
				, CLMN.EXRATE       -- 환율		
				, CLMN.PMNTMTD_CD   -- 수금유형
				, NVL(SUM(CLMN_D.CLMN_DTL_AMT), 0) AS CLMN_AMT2	-- 수금금액	
				, CLMN.CLMN_RMK     -- 비고 		
				, CLMN_D.CLMN_DTL_AMT					-- 수금금액
				, CLMN_D.CLMN_PLAN_SEQ					-- 수금계획순번
				, CLMN.CREAT_ID			
				, CLMN.UDT_ID	
				, CLMN.CREAT_DTTM						-- 생성일시
				, CLMN.UDT_DTTM							-- 최종변경일시
			FROM TB_CR05M01 	AS	CLMN				-- 수금
			LEFT JOIN TB_CR05D01 	AS		CLMN_D		-- 수금상세
				ON CLMN_D. CO_CD = CLMN.CO_CD 
				AND CLMN_D.CLMN_NO = CLMN.CLMN_NO 
			GROUP BY  CLMN.CLMN_NO, CLMN.CO_CD, CLMN_D.ORDRS_NO, CLMN.CLMN_DT, CLMN.BKAC_CD, CLMN.EXRATE, CLMN.PMNTMTD_CD,
    		CLMN.CLMN_RMK, CLMN_D.CLMN_DTL_AMT, CLMN_D.CLMN_PLAN_SEQ, CLMN.CREAT_ID, CLMN.UDT_ID, CLMN.CREAT_DTTM, CLMN.UDT_DTTM			
			) AS CLMN_T ON CLMN_T.CO_CD  = SELL_T.CO_CD
				AND CLMN_T.ORDRS_NO = SELL_T.ORDRS_NO
				AND CLMN_T.CLMN_PLAN_SEQ = SELL_T.CLMN_PLAN_SEQ
			<!-- 4. 매출확정 INNER JOIN 매출확정상세 -->
			LEFT JOIN (
		     	SELECT SELL_D.CO_CD                                  		-- 회사코드
		           , SELL_DD.ORDRS_NO                           		    -- 수주번호
		           , SELL_DD.CLMN_PLAN_SEQ            			         	-- 수금계획순번
		 	        -- 통화단위
		           , NVL(SUM(SELL_DD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     -- 확정금액
		      FROM   TB_CR03M01 SELL_D
		             LEFT OUTER JOIN TB_CR03D01 SELL_DD ON SELL_DD.CO_CD = SELL_D.CO_CD
						AND SELL_DD.SELL_DCSN_NO = SELL_D.SELL_DCSN_NO
		      GROUP BY SELL_D.CO_CD, SELL_DD.ORDRS_NO, SELL_DD.CLMN_PLAN_SEQ
		     ) AS CONF  ON CONF.CO_CD   = ORDRS_CP.CO_CD
		               AND CONF.ORDRS_NO   = ORDRS_CP.ORDRS_NO
		               AND CONF.CLMN_PLAN_SEQ = ORDRS_CP.CLMN_PLAN_SEQ
			LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS_M.ORDRS_CLNT_CD	-- 거래처 마스터 					
			LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS_M.CO_CD   		--회사
			LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS_M.ORDRS_DIV   	--수주구분
			LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS_M.CURR_CD   	    --통화단위
			LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = ORDRS_CP.CLMN_PLAN_DIV	-- 수금구분
			LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN_T.BKAC_CD			-- 계좌번호
			LEFT OUTER JOIN TB_CM06M01 AS U1 ON U1.ID = CLMN_T.CREAT_ID 			--생성자
			LEFT OUTER JOIN TB_CM06M01 AS U2 ON U2.ID = CLMN_T.UDT_ID	 			--최종변경자	
			WHERE  1 = 1
			<if test="coCd != null and !coCd.equals('')">
				AND	ORDRS_M.CO_CD = '${coCd}' --회사
			</if>
			<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
				AND NVL(TO_CHAR(ORDRS_M.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			</if>
			<if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
				AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명
			</if>
			<if test="ordrsNo != null and !ordrsNo.equals('')">
				AND NVL(ORDRS_M.ORDRS_NO , '.') LIKE '%${ordrsNo}%' --수주번호
			</if>
			<if test="clntPjt != null and !clntPjt.equals('')">
				AND NVL(ORDRS_M.CLNT_PJT , '.') LIKE '%${clntPjt}%' --고객사PJT
			</if>
			<if test="ctrtNm != null and !ctrtNm.equals('')">
				AND NVL(ORDRS_M.CTRT_NM  , '.') LIKE '%${ctrtNm}%' --계약명
			</if>
			<if test="ordrsDiv != null and !ordrsDiv.equals('')">
				AND NVL(ORDRS_M.ORDRS_DIV, '.') LIKE '%${ordrsDiv}%' --수주구분
			</if>
			) AS T
			WHERE  1 = 1
	</select>
	
	<select id="selectClmnList" parameterType="Map" resultType="camelMap">
		<!-- 
			 TB_CR02M01		AS		ORDRS_M		수주마스터       
			 TB_CR02D01		AS		ORDRS_CP 	수금수금계획  
			 TB_CR04M01 	AS		SELL_B		매출계산서   
			 TB_CR04D01 	AS		SELL_BD		매출계산서상세 
			 TB_CR05M01 	AS		CLMN		수금  
			 TB_CR05D01 	AS		CLMN_D		수금상세    
			 TB_CR03M01 	AS		SELL_D		매출확정    
			 TB_CR03D01 	AS		SELL_DD		매출확정상세 
		-->
		SELECT *
			FROM(	
			SELECT ROWNUM AS RNUM
					, ORDRS_M.FILE_TRGT_KEY 			-- 파일대상KEY
					, ORDRS_M.CO_CD 					-- 회사
					, R.CODE_NM	AS CO_NM				-- 회사명 
					, TO_CHAR(ORDRS_M.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT 	--수주일자
					, ORDRS_M.ORDRS_CLNT_CD	AS ORDRS_CLNT_CD				-- 고객사 코드
					, C.CLNT_NM	AS ORDRS_CLNT_NM		-- 고객사명
					, ORDRS_M.ORDRS_NO					-- 수주번호
					, ORDRS_M.CLNT_PJT					-- 고객사 PJT
					, ORDRS_M.CTRT_NM					-- 계약명
					, ORDRS_M.ORDRS_DIV					-- 수주구분
					, ORDRS_M.ORDRS_AMT 	AS ORDRS_AMT-- 수주금액
					, CONF.CONF_AMT         AS CONF_AMT -- 기매출확정금액
					, ORDRS_CP.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT  -- 매출미확정금액
					, SELL_T.SELL_BILL_AMT 				-- 기계산서발행금액
														<!-- 계산서 미발행금액 -->
					, ORDRS_CP.CLMN_PLAN_DIV				-- 수금구분
					, R3.CODE_NM AS CLMN_PLAN_DIV_NM		-- 수금구분명
					<!-- 수금리스트 -->
					, CLMN_T.CLMN_NO						-- 수금번호
					, TO_CHAR(CLMN_T.CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT	 -- 수금일자
					, SELL_T.CLMN_PLAN_SEQ					-- 수금계획순번
					, ORDRS_M.CURR_CD	AS ORDRS_CURR_CD	-- 통화코드
					, R2.CODE_NM  		AS ORDRS_CURR_NM	-- 통화코드명
					, SELL_T.SELL_BILL_NO					-- 계산서 번호
					, CLMN_T.CLMN_DTL_AMT					-- 수금금액
					, ORDRS_CP.CLMN_AMT     				-- 기수금금액    
															<!-- 미수금금액 --> 
					, CLMN_T.BKAC_CD 						-- 계좌번호
					, R4.CODE_NM AS BKAC_NM					-- 계좌번호명
					, CLMN_T.PMNTMTD_CD						-- 수금유형
					, CLMN_T.EXRATE							-- 환율	
					, CLMN_T.CLMN_RMK						-- 비고
					, U1.NAME AS CREAT_ID_NM
					, TO_CHAR(CLMN_T.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM --생성일시
					, U2.NAME AS UDT_ID_NM
					, TO_CHAR(CLMN_T.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM --최종변경일시
				
			FROM TB_CR02M01 ORDRS_M	-- 수주마스터
			<!--  1. 수주마스터 LEFT JOIN 수금수금계획 -->
			LEFT OUTER JOIN (
			SELECT CO_CD
					, ORDRS_NO
					, CLMN_PLAN_SEQ
					, CLMN_PLAN_DIV
					, NVL(SUM(CLMN_AMT), 0) AS CLMN_AMT     --수금금액      
			FROM TB_CR02D01			-- 수금수금계획
			GROUP BY CO_CD, ORDRS_NO, CLMN_PLAN_SEQ	, CLMN_PLAN_DIV
			) AS ORDRS_CP ON ORDRS_CP.CO_CD = ORDRS_M.CO_CD 	
							AND ORDRS_CP.ORDRS_NO = ORDRS_M.ORDRS_NO 
			<!--  2. 수주수금계획 LEFT JOIN 매출계산서상세 --> 	
			LEFT OUTER JOIN (
			SELECT 
				SELL_BD.CO_CD, 
				SELL_BD.ORDRS_NO,
				SELL_B.SELL_BILL_NO, 
			<!-- 	SELL_BD.SELL_DCSN_NO, -->
				SELL_BD.CLMN_PLAN_SEQ,
				NVL(SUM(SELL_BD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT
			FROM TB_CR04D01 SELL_BD 
			<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세 -->	
				LEFT OUTER JOIN 
				TB_CR04M01 SELL_B ON SELL_B.CO_CD = SELL_BD.CO_CD  
				AND SELL_B.SELL_BILL_NO = SELL_BD.SELL_BILL_NO
				GROUP BY SELL_BD.CO_CD, SELL_BD.ORDRS_NO, SELL_B.SELL_BILL_NO, SELL_BD.CLMN_PLAN_SEQ	
			) AS SELL_T	ON SELL_T.CO_CD = ORDRS_CP.CO_CD -- 계산서
				AND SELL_T.ORDRS_NO = ORDRS_CP.ORDRS_NO
				AND SELL_T.CLMN_PLAN_SEQ = ORDRS_CP.CLMN_PLAN_SEQ						
			<!--  3. 매출계산서상세 LEFT JOIN 수금내역 -->	
			LEFT OUTER JOIN ( 
			SELECT CLMN.CLMN_NO		-- 수금번호	
				, CLMN.CO_CD      	-- 회사	
				, CLMN_D.ORDRS_NO	-- 수주번호	
				, CLMN.CLMN_DT      -- 수금일자	
				, CLMN.BKAC_CD      -- 계좌번호 	
				, CLMN.EXRATE       -- 환율		
				, CLMN.PMNTMTD_CD   -- 수금유형
				, NVL(SUM(CLMN_D.CLMN_DTL_AMT), 0) AS CLMN_AMT2	-- 수금금액	
				, CLMN.CLMN_RMK     -- 비고 		
				, CLMN_D.CLMN_DTL_AMT					-- 수금금액
				, CLMN_D.CLMN_PLAN_SEQ					-- 수금계획순번
				, CLMN.CREAT_ID			
				, CLMN.UDT_ID	
				, CLMN.CREAT_DTTM						-- 생성일시
				, CLMN.UDT_DTTM							-- 최종변경일시
			FROM TB_CR05M01 	AS	CLMN				-- 수금
			LEFT JOIN TB_CR05D01 	AS		CLMN_D		-- 수금상세
				ON CLMN_D. CO_CD = CLMN.CO_CD 
				AND CLMN_D.CLMN_NO = CLMN.CLMN_NO 
			GROUP BY  CLMN.CLMN_NO, CLMN.CO_CD, CLMN_D.ORDRS_NO, CLMN.CLMN_DT, CLMN.BKAC_CD, CLMN.EXRATE, CLMN.PMNTMTD_CD,
    		CLMN.CLMN_RMK, CLMN_D.CLMN_DTL_AMT, CLMN_D.CLMN_PLAN_SEQ, CLMN.CREAT_ID, CLMN.UDT_ID, CLMN.CREAT_DTTM, CLMN.UDT_DTTM			
			) AS CLMN_T ON CLMN_T.CO_CD  = SELL_T.CO_CD
				AND CLMN_T.ORDRS_NO = SELL_T.ORDRS_NO
				AND CLMN_T.CLMN_PLAN_SEQ = SELL_T.CLMN_PLAN_SEQ
			<!-- 4. 매출확정 LEFT JOIN 매출확정상세 -->
			LEFT JOIN (
		     	SELECT SELL_D.CO_CD                                  		-- 회사코드
		           , SELL_DD.ORDRS_NO                           		    -- 수주번호
		           , SELL_DD.CLMN_PLAN_SEQ            			         	-- 수금계획순번
		 	        -- 통화단위
		           , NVL(SUM(SELL_DD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     -- 확정금액
		      	FROM TB_CR03M01 SELL_D
		             LEFT OUTER JOIN TB_CR03D01 SELL_DD ON SELL_DD.CO_CD = SELL_D.CO_CD
						AND SELL_DD.SELL_DCSN_NO = SELL_D.SELL_DCSN_NO
		      GROUP BY SELL_D.CO_CD, SELL_DD.ORDRS_NO, SELL_DD.CLMN_PLAN_SEQ
		     ) AS CONF  ON CONF.CO_CD   = ORDRS_CP.CO_CD
		               AND CONF.ORDRS_NO   = ORDRS_CP.ORDRS_NO
		               AND CONF.CLMN_PLAN_SEQ = ORDRS_CP.CLMN_PLAN_SEQ
			LEFT OUTER JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS_M.ORDRS_CLNT_CD	-- 거래처 마스터 					
			LEFT OUTER JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS_M.CO_CD   		-- 회사
			LEFT OUTER JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS_M.ORDRS_DIV   	-- 수주구분
			LEFT OUTER JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS_M.CURR_CD   	    -- 통화단위
			LEFT OUTER JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = ORDRS_CP.CLMN_PLAN_DIV	-- 수금구분
			LEFT OUTER JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN_T.BKAC_CD			-- 계좌번호
			LEFT OUTER JOIN TB_CM06M01 AS U1 ON U1.ID = CLMN_T.CREAT_ID 			-- 생성자
			LEFT OUTER JOIN TB_CM06M01 AS U2 ON U2.ID = CLMN_T.UDT_ID	 			-- 최종변경자	
			WHERE  1 = 1
			<if test="coCd != null and !coCd.equals('')">
				AND	ORDRS_M.CO_CD = '${coCd}' --회사
			</if>
			<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
				AND NVL(TO_CHAR(ORDRS_M.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
			</if>
			<if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
				AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명
			</if>
			<if test="ordrsNo != null and !ordrsNo.equals('')">
				AND NVL(ORDRS_M.ORDRS_NO , '.') LIKE '%${ordrsNo}%' --수주번호
			</if>
			<if test="clntPjt != null and !clntPjt.equals('')">
				AND NVL(ORDRS_M.CLNT_PJT , '.') LIKE '%${clntPjt}%' --고객사PJT
			</if>
			<if test="ctrtNm != null and !ctrtNm.equals('')">
				AND NVL(ORDRS_M.CTRT_NM  , '.') LIKE '%${ctrtNm}%' --계약명
			</if>
			<if test="ordrsDiv != null and !ordrsDiv.equals('')">
				AND NVL(ORDRS_M.ORDRS_DIV, '.') LIKE '%${ordrsDiv}%' --수주구분
			</if>
			) AS T
			WHERE  1 = 1
            AND RNUM BETWEEN #{firstIndex} AND #{lastIndex}
			
	</select>
	
	<select id="selectClmnInfoCount" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)	
		FROM TB_CR02M01 AS ORDRS
		<!-- 수주수금계획 -->
	   		JOIN TB_CR02D01 
	   			AS CLMN ON CLMN.CO_CD = ORDRS.CO_CD
                AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
	    	<!-- 매출확정 -->
		  	LEFT JOIN (
		              SELECT CM.CO_CD                                          --회사코드
		                   , CD.ORDRS_NO                                       --수주번호
		                   , CD.CLMN_PLAN_SEQ                                  --수금계획순번
		                   , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
		                   , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
		              FROM   TB_CR03M01 AS CM
		                     JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
								                  AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
		              GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
		             ) AS CONF ON CONF.CO_CD = CLMN.CO_CD
				               AND CONF.ORDRS_NO = CLMN.ORDRS_NO
				               AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
			LEFT OUTER JOIN (
				SELECT 
					SELL_BD.CO_CD, 
					SELL_BD.ORDRS_NO,
					SELL_B.SELL_BILL_NO, 
				<!-- SELL_BD.SELL_DCSN_NO, -->
					SELL_BD.CLMN_PLAN_SEQ,
					NVL(SUM(SELL_BD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT
				FROM TB_CR04D01 SELL_BD 
				<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세  -->	
					LEFT OUTER JOIN 
					TB_CR04M01 SELL_B ON SELL_B.CO_CD = SELL_BD.CO_CD  
					AND SELL_B.SELL_BILL_NO = SELL_BD.SELL_BILL_NO
					GROUP BY SELL_BD.CO_CD, SELL_BD.ORDRS_NO, SELL_B.SELL_BILL_NO, SELL_BD.CLMN_PLAN_SEQ	
				) AS SELL_T	ON SELL_T.CO_CD = CONF.CO_CD -- 계산서
					AND SELL_T.ORDRS_NO = CONF.ORDRS_NO
					AND SELL_T.CLMN_PLAN_SEQ = CONF.CLMN_PLAN_SEQ		               
			LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD     --고객사
	       	LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD	--회사
	      	LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV	--수주구분
	       	LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD		--통화단위
	       	LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV	--수금구분
	      	LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD	--통화단위
		WHERE 1 = 1 
		<if test="coCd != null and !coCd.equals('')">
			AND	ORDRS.CO_CD LIKE '%${coCd}%' --회사
		</if>
		<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
			AND	NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
		</if>
		<if test="clntNm != null and !clntNm.equals('')">
			AND NVL(C.CLNT_NM, '.') LIKE '%${clntNm}%' --고객사명
		</if>
			ORDER BY ORDRS.CO_CD, ORDRS.ORDRS_NO, CLMN.CLMN_PLAN_SEQ
	</select>
	
	<select id="selectClmnInfo" parameterType="Map" resultType="camelMap">
		SELECT * FROM(
			SELECT -- DISTINCT 
				ORDRS.FILE_TRGT_KEY AS FILE_TRGT_KEY --파일대상KEY
				, ROWNUM	AS 	RNUM
			    , ORDRS.CO_CD             AS CO_CD             --회사코드
			    , R.CODE_NM               AS CO_CD_NM          --회사명
			    , ORDRS.ORDRS_NO          AS ORDRS_NO          --수주번호
			    , TO_CHAR(ORDRS.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT --수주일자
			    , ORDRS.ORDRS_CLNT_CD     AS ORDRS_CLNT_CD     --고객사
			    , C.CLNT_NM               AS ORDRS_CLNT_NM     --고객사명
			    , ORDRS.CLNT_PJT          AS CLNT_PJT          --고객사PJT
			    , ORDRS.CTRT_NM           AS CTRT_NM           --계약명
			    , ORDRS.CURR_CD           AS ORDRS_CURR_CD     --통화단위
			    , R2.CODE_NM              AS ORDRS_CURR_NM     --통화단위명
			    , NVL(ORDRS.EXRATE, 1)    AS ORDRS_EXRATE      --환율
			    <!-- 수주수금계획 -->
			    , CLMN.CLMN_PLAN_SEQ      AS CLMN_PLAN_SEQ     --수금계획순번
			    , CLMN.CLMN_PLAN_DIV      AS CLMN_PLAN_DIV     --수금구분
			    , R3.CODE_NM              AS CLMN_PLAN_DIV_NM  --수금구분명
			    , CLMN.CLMN_DIV_SEQ       AS CLMN_DIV_SEQ      --수금구분차수
			    , CLMN.CLMN_RATE          AS CLMN_RATE         --수금비율
			    , CLMN.CURR_CD            AS CLMN_CURR_CD      --통화단위
			    , R4.CODE_NM              AS CLMN_CURR_NM      --통화단위명
			    , NVL(CLMN.EXRATE, 1)     AS CLMN_EXRATE       --환율
			    , CLMN.CLMN_AMT           AS CLMN_AMT          --수금금액
			    , TO_CHAR(CLMN.BILL_PBLS_DT, 'YYYY-MM-DD') AS CLMN_BILL_PBLS_DT --계산서발행일자
			    , TO_CHAR(CLMN.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT           --수금일자
			    , CONF.CONF_AMT                 AS BEF_CONF_AMT --기 확정금액
			    , CLMN.CLMN_AMT - CONF.CONF_AMT AS UNCONF_AMT   --미 확정금액
			    , 'N'                           AS CHK          --체크여부
			    , 0                             AS CONF_AMT     --확정금액
			    , SELL_T.SELL_BILL_AMT 					-- 기계산서발행금액
				, SELL_T.CLMN_PLAN_SEQ					-- 수금계획순번
				, SELL_T.SELL_BILL_NO					-- 계산서 번호
				, CLMN_T.CLMN_AMT2		-- 수금의 수금금액
				 , 0 				AS UNCLMN_AMT2	-- 수금의 미수금액
		     <!-- 계산서 발행 후 지급시기 -->
		     <!-- , CLMN.PMNT_DT_AFTER_BILL AS CLMN_PMNT_DT_AFTER_BILL  -->
		     <!-- 비고 -->
		     <!-- , CLMN.CLMN_PLAN_RMK      AS CLMN_PLAN_RMK      -->
		     <!--  수금관리상황 -->
		     <!-- , CLMN.CLMN_MGMT_STATUS   AS CLMN_MGMT_STATUS -->  
			FROM   TB_CR02M01 AS ORDRS
		       <!-- 수주수금계획 -->
		       JOIN TB_CR02D01 AS CLMN  ON CLMN.CO_CD    = ORDRS.CO_CD
				                       AND CLMN.ORDRS_NO = ORDRS.ORDRS_NO
		       <!-- 매출확정 -->
		       LEFT JOIN (
			              SELECT CM.CO_CD                                          --회사코드
			                   , CD.ORDRS_NO                                       --수주번호
			                   , CD.CLMN_PLAN_SEQ                                  --수금계획순번
			                   , MAX(CD.CURR_CD)                   AS CONF_CURR_CD --통화단위
			                   , NVL(SUM(CD.SELL_DCSN_DTL_AMT), 0) AS CONF_AMT     --확정금액
			              FROM   TB_CR03M01 AS CM
			                     JOIN TB_CR03D01 AS CD ON CD.CO_CD        = CM.CO_CD
									                  AND CD.SELL_DCSN_NO = CM.SELL_DCSN_NO
			              GROUP BY CM.CO_CD, CD.ORDRS_NO, CD.CLMN_PLAN_SEQ
			             ) AS CONF  ON CONF.CO_CD         = CLMN.CO_CD
					               AND CONF.ORDRS_NO      = CLMN.ORDRS_NO
					               AND CONF.CLMN_PLAN_SEQ = CLMN.CLMN_PLAN_SEQ
				<!-- 매출계산서  -->   
				LEFT OUTER JOIN (
				SELECT 
					SELL_BD.CO_CD, 
					SELL_BD.ORDRS_NO,
					SELL_B.SELL_BILL_NO, 
				<!-- SELL_BD.SELL_DCSN_NO, -->
					SELL_BD.CLMN_PLAN_SEQ,
					NVL(SUM(SELL_BD.SELL_BILL_DTL_AMT), 0) AS SELL_BILL_AMT	-- 매출계산서금액
				FROM TB_CR04D01 SELL_BD 
				<!-- 추가 230718 매출계산서 LEFT JOIN 매출계산서상세  -->	
					LEFT OUTER JOIN 
					TB_CR04M01 SELL_B ON SELL_B.CO_CD = SELL_BD.CO_CD  
					AND SELL_B.SELL_BILL_NO = SELL_BD.SELL_BILL_NO
					GROUP BY SELL_BD.CO_CD, SELL_BD.ORDRS_NO, SELL_B.SELL_BILL_NO, SELL_BD.CLMN_PLAN_SEQ	
				) AS SELL_T	ON SELL_T.CO_CD = CONF.CO_CD -- 계산서
					AND SELL_T.ORDRS_NO = CONF.ORDRS_NO
					AND SELL_T.CLMN_PLAN_SEQ = CONF.CLMN_PLAN_SEQ	 
				LEFT OUTER JOIN ( 
				SELECT CLMN_M.CLMN_NO		-- 수금번호	
					, CLMN_M.CO_CD      	-- 회사	
					, CLMN_D.ORDRS_NO	-- 수주번호	
					, CLMN_M.CLMN_DT      -- 수금일자	
					, CLMN_M.BKAC_CD      -- 계좌번호 	
					, CLMN_M.EXRATE       -- 환율		
					, CLMN_M.PMNTMTD_CD   -- 수금유형
					, NVL(SUM(CLMN_D.CLMN_DTL_AMT), 0) AS CLMN_AMT2	-- 수금금액	
					, CLMN_M.CLMN_RMK     -- 비고 		
					, CLMN_D.CLMN_DTL_AMT					-- 수금금액
					, CLMN_D.CLMN_PLAN_SEQ					-- 수금계획순번
					, CLMN_M.CREAT_ID			
					, CLMN_M.UDT_ID	
					, CLMN_M.CREAT_DTTM						-- 생성일시
					, CLMN_M.UDT_DTTM							-- 최종변경일시
				FROM TB_CR05M01 	AS	CLMN_M				-- 수금
				LEFT JOIN TB_CR05D01 	AS		CLMN_D		-- 수금상세
					ON CLMN_D. CO_CD = CLMN_M.CO_CD 
					AND CLMN_D.CLMN_NO = CLMN_M.CLMN_NO 
				GROUP BY  CLMN_M.CLMN_NO, CLMN_M.CO_CD, CLMN_D.ORDRS_NO, CLMN_M.CLMN_DT, CLMN_M.BKAC_CD, CLMN_M.EXRATE, CLMN_M.PMNTMTD_CD,
	    		CLMN_M.CLMN_RMK, CLMN_D.CLMN_DTL_AMT, CLMN_D.CLMN_PLAN_SEQ, CLMN_M.CREAT_ID, CLMN_M.UDT_ID, CLMN_M.CREAT_DTTM, CLMN_M.UDT_DTTM			
				) AS CLMN_T ON CLMN_T.CO_CD  = SELL_T.CO_CD
					AND CLMN_T.ORDRS_NO = SELL_T.ORDRS_NO
					AND CLMN_T.CLMN_PLAN_SEQ = SELL_T.CLMN_PLAN_SEQ
			LEFT JOIN TB_BM02M01 AS C ON C.CLNT_CD = ORDRS.ORDRS_CLNT_CD    --고객사
	       	LEFT JOIN TB_CM05M01 AS R  ON R.CODE_ID  = ORDRS.CO_CD			--회사
	       	LEFT JOIN TB_CM05M01 AS R1 ON R1.CODE_ID = ORDRS.ORDRS_DIV	    --수주구분
	       	LEFT JOIN TB_CM05M01 AS R2 ON R2.CODE_ID = ORDRS.CURR_CD		--통화단위
	       	LEFT JOIN TB_CM05M01 AS R3 ON R3.CODE_ID = CLMN.CLMN_PLAN_DIV	--수금구분
	       	LEFT JOIN TB_CM05M01 AS R4 ON R4.CODE_ID = CLMN.CURR_CD			--통화단위
		WHERE 1 = 1 
		<if test="coCd != null and !coCd.equals('')">
			AND ORDRS.CO_CD LIKE '%${coCd}%' --회사
		</if>
		<if test="ordrsClntCd != null and !ordrsClntCd.equals('')"> 
			AND NVL(TO_CHAR(ORDRS.ORDRS_CLNT_CD), '.') LIKE '%${ordrsClntCd}%' --고객사
		</if>
		<if test="ordrsClntNm != null and !ordrsClntNm.equals('')">
			AND NVL(C.CLNT_NM, '.') LIKE '%${ordrsClntNm}%' --고객사명
		</if>
		ORDER BY ORDRS.CO_CD, ORDRS.ORDRS_NO, CLMN.CLMN_PLAN_SEQ
		) T
        WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<!-- 수금번호 -->
	<select id="select_cr05_clmnNo" parameterType="Map" resultType="String">
		SELECT 'CLMN' || TO_CHAR(SYSDATE, 'YY') ||  LPAD((SELECT (TO_CHAR(MAX(TO_NUMBER(FILE_TRGT_KEY)))) + 1 FROM TB_CR05M01),4,0) FROM DUAL;
	</select>
	
	<select id="select_cr05_SeqNext" parameterType="Map" resultType="int">
		SELECT MAX(TO_NUMBER(FILE_TRGT_KEY)) + 1
		FROM TB_CR05M01
	</select>
	
</mapper>