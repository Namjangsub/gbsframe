<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr02.mapper.CR02Mapper">
    <select id="selectOrdrsCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_CR02M01 A
        WHERE 1 = 1
    </select>
    <select id="selectOrdrsList" resultType="CamelMap">
        SELECT
            TO_CHAR(T.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT,
            TO_CHAR(T.FWD_EXCH_JOIN_DT, 'YYYY-MM-DD') AS FWD_EXCH_JOIN_DT,
            FN_CM05M01_CD_TO_NM(T.CURR_CD) AS CURR_NM,
            FN_CM05M01_CD_TO_NM(T.PMNT_MTD) AS PMNT_MTD_NM,
            ROWNUM AS RNUM,
            T.*
        FROM (
        SELECT * FROM TB_CR02M01 A
        LEFT JOIN TB_BM02M01 B ON A.ORDRS_CLNT_CD = B.CLNT_CD
        ) T
        WHERE 1=1

        <if test="strtDt != null and !strtDt.equals('')">
            AND T.ORDRS_DT BETWEEN #{strtDt} AND #{endDt}
        </if>
        <if test="coCd != null and !coCd.equals('')">
            AND T.CO_CD = #{coCd}
        </if>
        <if test="clntCd != null and !clntCd.equals('')">
            AND T.ORDRS_CLNT_CD = #{clntCd}
        </if>
        <if test="ctrtNm != null and !ctrtNm.equals('')">
            AND UPPER(T.CTRT_NM) LIKE '%' || UPPER(#{ctrtNm}) || '%'
        </if>
        <if test="ordrsDiv != null and !ordrsDiv.equals('')">
            AND UPPER(T.ORDRS_DIV) LIKE '%' || UPPER(#{ordrsDiv}) || '%'
        </if>
        <if test="searchType != null and searchType.equals('ORDRS_NO')">
            AND T.ORDRS_NO LIKE '%' || #{searchValue} || '%'
        </if>
        <if test="ordrsNo != null and !ordrsNo.equals('')">

            AND T.ORDRS_NO LIKE '%'|| #{ordrsNo} ||'%'

        </if>
        <if test="clntPjt != null and !clntPjt.equals('')">
            AND UPPER(T.CLNT_PJT) LIKE '%' || UPPER(#{clntPjt}) || '%'
        </if>
        <if test="clntNm != null and !clntNm.equals('')">
            AND UPPER(T.CLNT_NM) LIKE '%' || UPPER(#{clntNm}) || '%'
        </if>


    </select>
    <resultMap id="resultInfoMap" type="CamelMap">
        <collection select="selectPmntPlan" property="plans" column="{coCd=CO_CD, ordrsNo=ORDRS_NO}" ofType="CamelMap"/>
        <collection select="selectOrdrsDetails" property="details" column="{coCd=CO_CD, ordrsNo=ORDRS_NO}"
                    ofType="CamelMap"/>
    </resultMap>
    <select id="selectOrdrsInfo" parameterType="map" resultMap="resultInfoMap">
        SELECT TO_CHAR(T.ORDRS_DT, 'YYYY-MM-DD')         AS ORDRS_DT,
               TO_CHAR(T.FWD_EXCH_JOIN_DT, 'YYYY-MM-DD') AS FWD_EXCH_JOIN_DT,
               T.*
        FROM (SELECT *
              FROM TB_CR02M01
              WHERE CO_CD = #{coCd}
                AND ORDRS_NO = #{ordrsNo}) T
    </select>

    <select id="selectOrdrsDetails" parameterType="map" resultType="CamelMap">
        SELECT *
        FROM TB_CR02D02
        WHERE CO_CD = #{coCd}
          AND ORDRS_NO = #{ordrsNo}
    </select>

    <select id="selectPmntPlan" parameterType="map" resultType="CamelMap">
        SELECT TO_CHAR(T.CLMN_DT, 'YYYY-MM-DD')      AS CLMN_DT,
               TO_CHAR(T.BILL_PBLS_DT, 'YYYY-MM-DD') AS BILL_PBLS_DT,
               T.*
        FROM (SELECT *
              FROM TB_CR02D01
              WHERE CO_CD = #{coCd}
                AND ORDRS_NO = #{ordrsNo}) T
    </select>
    <select id="selectMaxOrdrsNo" resultType="java.lang.String">
        SELECT CONCAT(SUBSTR(TO_CHAR(CURRENT_DATE, 'YY'), 1, 2),
                      LPAD(NVL(MAX(SUBSTR(ordrs_no, 3, 3)), 0) + 1, 3, '0')) as maxOrdrsNo
        FROM TB_CR02M01
        WHERE CO_CD = #{coCd}
          AND SUBSTR(ordrs_no, 1, 2) = SUBSTR(TO_CHAR(CURRENT_DATE, 'YY'), 1, 2)
    </select>
    <insert id="insertOrdrs" parameterType="map">
        INSERT INTO TB_CR02M01
        <selectKey keyProperty="fileTrgtKey" resultType="String" order="BEFORE">
            SELECT
            TO_CHAR(NVL(MAX(TO_NUMBER(FILE_TRGT_KEY)), 0) + 1)
            FROM TB_CR02M01
        </selectKey>
                (
                    CO_CD,
                    ORDRS_NO,
                    EST_NO,
                    ORDRS_CLNT_CD,
                    ORDRS_DT,
                    ORDRS_DIV,
                    CLNT_PJT,
                    CTRT_NM,
                    CURR_CD,
                    ORDRS_AMT,
                    FWD_EXCH_JOIN_DT,
                    FWD_EXCH_CHK_LIST,
                    ORDRGER,
                    EXRATE,
                    MNG_ID,
                    CTRT_DOC,
                    PMNT_MTD,
                    ORDRS_RMK,
                    ORGN_SALES_CD,
                    FILE_TRGT_KEY
                )
        VALUES (
                    #{coCd},
                    #{ordrsNo},
                    #{estNo},
                    #{ordrsClntCd},
                    #{ordrsDt},
                    #{ordrsDiv},
                    #{clntPjt},
                    #{ctrtNm},
                    #{currCd},
                    #{ordrsAmt},
                    #{fwdExchJoinDt},
                    #{fwdExchChkList},
                    #{ordrger},
                    #{exrate},
                    #{mngId},
                    #{ctrtDoc},
                    #{pmntMtd},
                    #{ordrsRmk},
                    #{orgnSalesCd},
                    #{fileTrgtKey}
                )
    </insert>
    <update id="updateOrdrs" parameterType="map">
        UPDATE TB_CR02M01
        
        SET EST_NO            = #{estNo},
            ORDRS_CLNT_CD     = #{ordrsClntCd},
            ORDRS_DT          = #{ordrsDt},
            ORDRS_DIV         = #{ordrsDiv},
            CLNT_PJT          = #{clntPjt},
            CTRT_NM           = #{ctrtNm},
            CURR_CD           = #{currCd},
            ORDRS_AMT         = #{ordrsAmt},
            FWD_EXCH_JOIN_DT  = #{fwdExchJoinDt},
            FWD_EXCH_CHK_LIST = #{fwdExchChkList},
            ORDRGER           = #{ordrger},
            EXRATE            = #{exrate},
            MNG_ID            = #{mngId},
            CTRT_DOC          = #{ctrtDoc},
            PMNT_MTD          = #{pmntMtd},
            ORDRS_RMK         = #{ordrsRmk},
            ORGN_SALES_CD     = #{orgnSalesCd}
            WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </update>
    <insert id="insertClmnPlan" parameterType="map">
        INSERT INTO TB_CR02D01
            (
             CO_CD, ORDRS_NO, CLMN_PLAN_SEQ, CLMN_PLAN_DIV, CLMN_DIV_SEQ, CLMN_RATE, CLMN_AMT,
             BILL_PBLS_DT, CLMN_DT, PMNT_DT_AFTER_BILL, CURR_CD, CLMN_PLAN_RMK
             )
        VALUES
            (
             #{coCd}, #{ordrsNo}, #{clmnPlanSeq},
             #{clmnPlanDiv}, #{clmnDivSeq}, #{clmnRate},
             #{clmnAmt}, #{billPblsDt}, #{clmnDt},
             #{pmntDtAfterBill}, #{currCd}, #{clmnPlanRmk}
             )
    </insert>
    <update id="updateClmnPlan" parameterType="map">
        UPDATE TB_CR02D01
        SET CLMN_PLAN_DIV      = #{clmnPlanDiv},
            CLMN_DIV_SEQ       = #{clmnDivSeq},
            CLMN_RATE          = #{clmnRate},
            CLMN_AMT           = #{clmnAmt},
            BILL_PBLS_DT       = #{billPblsDt},
            CLMN_DT            = #{clmnDt},
            PMNT_DT_AFTER_BILL = #{pmntDtAfterBill},
            CURR_CD            = #{currCd},
            CLMN_PLAN_RMK      = #{clmnPlanRmk}
        WHERE CO_CD = #{coCd}
          AND ORDRS_NO = #{ordrsNo}
          AND CLMN_PLAN_SEQ = #{clmnPlanSeq}
    </update>
    <insert id="insertClmnPlanHis" parameterType="map">
        INSERT INTO TB_CR02D01HIST
        (
            CO_CD, ORDRS_NO, CLMN_PLAN_SEQ, CLMN_PLAN_DIV, CLMN_DIV_SEQ, CLMN_RATE, CLMN_AMT,
            BILL_PBLS_DT, CLMN_DT, PMNT_DT_AFTER_BILL, CURR_CD, CLMN_PLAN_RMK
         )
        VALUES (
                   #{coCd}, #{ordrsNo}, #{clmnPlanSeq},
                   #{clmnPlanDiv}, #{clmnDivSeq}, #{clmnRate},
                   #{clmnAmt}, #{billPblsDt}, #{clmnDt},
                   #{pmntDtAfterBill}, #{currCd}, #{clmnPlanRmk}
                )
    </insert>
    <insert id="insertOrdrsDetail" parameterType="map">
        <bind name="salesCd" value="ordrsNo + '-' + ordrsSeq + prdtCd + itemDiv" />
        INSERT INTO TB_CR02D02
        (
                -- 1. 회사 코드
                CO_CD,
                -- 2. 주문 번호
                ORDRS_NO,
                -- 3. 주문 시퀀스
                ORDRS_SEQ,
                -- 4. 주문 세부 정보 Div10
                -- 5. 제품 코드
                PRDT_CD,
                -- 6. 항목 분류
                ITEM_DIV,
                -- 7. 판매 코드
                SALES_CD,
                -- 8. 장비 이름
                EQP_NM,
                -- 9. 주문 가격 기계
                ORDRS_PRC_MACH,
                -- 10. 주문 가격 전기
                ORDRS_PRC_ELCTY,
                -- 11. 주문 가격
                ORDRS_PRC,
                -- 12. 주문 수량
                ORDRS_QTY,
                -- 13. 예상 원자재 가격
                EST_EPCT_MAT_PRC,
                -- 14. 목표 구매 가격 기계
                TRGT_PCHS_PCOST_MACH,
                -- 15. 목표 구매 가격 전기
                TRGT_PCHS_PCOST_ELCTY,
                -- 16. 목표 구매 가격 내부 처리
                TRGT_PCHS_PCOST_IN_HOUSE_PRCSN,
                -- 17. 노동비 제조비
                LABOR_COST_MFG_COST,
                -- 18. 주문 세부 정보 Div10
                ORDRS_DTL_DIV10,
                -- 19. 주문 세부 정보 Div20
                ORDRS_DTL_DIV20
            )
        VALUES (
                   -- 1. 회사 코드
                   #{coCd},
                   -- 2. 주문 번호
                   #{ordrsNo},
                   -- 3. 주문 시퀀스
                   #{ordrsSeq},
                   -- 4. 주문 세부 정보 Div10
                   -- 5. 제품 코드
                   #{prdtCd},
                   -- 6. 항목 분류
                   #{itemDiv},
                   -- 7. 판매 코드
                   #{salesCd},
                   -- 8. 장비 이름
                   #{eqpNm},
                   -- 9. 주문 가격 기계
                   #{ordrsPrcMach},
                   -- 10. 주문 가격 전기
                   #{ordrsPrcElcty},
                   -- 11. 주문 가격
                   #{ordrsPrc},
                   -- 12. 주문 수량
                   #{ordrsQty},
                   -- 13. 예상 원자재 가격
                   #{estEpctMatPrc},
                   -- 14. 목표 구매 가격 기계
                   #{trgtPchsPcostMach},
                   -- 15. 목표 구매 가격 전기
                   #{trgtPchsPcostElcty},
                   -- 16. 목표 구매 가격 내부 처리
                   #{trgtPchsPcostInHousePrcsn},
                   -- 17. 노동비 제조비
                   #{laborCostMfgCost},
                   -- 18. 주문 세부 정보 Div10
                   #{ordrsDtlDiv10},
                   -- 19. 주문 세부 정보 Div20
                   #{ordrsDtlDiv20}
               )
              <if test="CLMNPLANDIV == 'CLMNPLANDIV1'">
                    {CALL SP_BM10M01_I(
                    #{coCd},                 &#45;&#45; AR_CO_CD: 회사 코드
                    #{ordrsNo},              &#45;&#45; AR_ORDRS_NO: 주문 번호
                    #{salesCd},              &#45;&#45; AR_SALES_CD: 판매 코드
                    #{eqpNm},                &#45;&#45; AR_EQP_NM: 장비 이름
                    #{prdtCd},               &#45;&#45; AR_PRDT_CD: 제품 코드
                    #{itemDiv},              &#45;&#45; AR_ITEM_DIV: 항목 분류
                    #{ordrsDtlDiv20},        &#45;&#45; AR_ORDRS_DTL_DIV20: 주문 세부 정보 Div20
                    #{ordrsDtlDiv30},        &#45;&#45; AR_ORDRS_DTL_DIV30: 주문 세부 정보 Div30
                    '설계난이도코드값',        &#45;&#45; AR_DSGN_DIF_CODE_ID: 설계 난이도 코드
                    '생산난이도코드값',        &#45;&#45; AR_PRDCTN_DIF_CODE_ID: 생산 난이도 코드
                    '단위값',                &#45;&#45; AR_UNIT: 단위
                    #{ordrsPrc},             &#45;&#45; AR_ORDRS_PRC: 주문 가격
                    '생성자ID값',             &#45;&#45; AR_CREAT_ID: 생성자 ID
                    '생성프로그램ID값',        &#45;&#45; AR_CREAT_PGM: 생성 프로그램 ID
                    @AR_ERROR = @errorOutput &#45;&#45; AR_ERROR: 출력 파라미터. 에러 메시지를 반환
                    )}
                </if>
    </insert>
    <update id="updateOrdrsDetail" parameterType="map">
        UPDATE TB_CR02D02
        SET ORDRS_DTL_DIV10                = #{ordrsDtlDiv10},
            ORDRS_DTL_DIV20                = #{ordrsDtlDiv20},
            PRDT_CD                        = #{prdtCd},
            ITEM_DIV                       = #{itemDiv}

        WHERE CO_CD = 'GUN'
          AND ORDRS_NO = '23001'
          AND ORDRS_SEQ = 1
    </update>
    <delete id="deleteOrdrs">
        DELETE
        FROM TB_CR02M01
        WHERE 1 = 1
          AND CO_CD = #{coCd}
          AND ORDRS_NO = #{ordrsNo}
    </delete>
    <delete id="deleteOrdrsPlan">
        DELETE
        FROM TB_CR02D01
        WHERE 1 = 1
          AND CO_CD = #{coCd}
          AND ORDRS_NO = #{ordrsNo}
    </delete>
    <delete id="deleteOrdrsDetail">
        DELETE
        FROM TB_CR02D02
        WHERE 1 = 1
          AND CO_CD = #{coCd}
          AND ORDRS_NO = #{ordrsNo}
    </delete>
    <select id="selectOrdrsPlanHisCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_CR02D01HIST A
        WHERE 1 = 1
    </select>
    <select id="selectOrdrsPlanHis" parameterType="map" resultType="camelMap">
        SELECT CO_CD, ORDRS_NO, CLMN_PLAN_SEQ, CLMN_PLAN_DEG, CLMN_PLAN_DIV, CLMN_DIV_SEQ,
               CLMN_RATE, CLMN_AMT, BILL_PBLS_DT, TO_CHAR(CLMN_DT, 'YYYY-MM-DD') AS CLMN_DT, PMNT_DT_AFTER_BILL, CURR_CD,
               CLMN_PLAN_RMK, CREAT_DTTM, TO_CHAR(UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM
        FROM TB_CR02D01HIST
        WHERE CO_CD = #{coCd}
          AND ORDRS_NO = #{ordrsNo}


    </select>
</mapper>