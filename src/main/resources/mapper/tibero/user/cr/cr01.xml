<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr01.mapper.CR01Mapper">

    <select id="selectMaxEstNo" parameterType="map" resultType="string">
        SELECT 'EST' || TO_CHAR(SYSDATE, 'YY') || '-' ||
               LPAD(
                       NVL(
                               (SELECT TO_NUMBER(SUBSTR(MAX(EST_NO), 7)) + 1
                                FROM TB_CR01M01
                                WHERE SUBSTR(EST_NO, 4, 2) = TO_CHAR(SYSDATE, 'YY')
                                  AND CO_CD = #{coCd}),
                               1
                           ),
                       4,
                       '0'
                   ) AS max_est_no
        FROM DUAL
    </select>

    <select id="selectEstCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_CR01M01 A
        WHERE 1 = 1

    </select>

    <select id="selectEstList" resultType="CamelMap">
        SELECT *
        FROM (
        SELECT
        TO_CHAR(T.EST_DT, 'YYYY-MM-DD') AS EST_DT,
--         TO_CHAR(T.EST_STD_DT, 'YYYY-MM-DD') AS EST_STD_DT,
        ROWNUM AS RNUM,
        T.*
        FROM (
        SELECT A.*, B.CLNT_NM
        FROM TB_CR01M01 A
        LEFT JOIN TB_BM02M01 B ON A.EST_CLNT_CD = B.CLNT_CD
        <where>
            <if test="strtDt != null and !strtDt.equals('')">
                AND A.EST_DT BETWEEN #{strtDt} AND #{endDt}
            </if>
            <if test="coCd != null and !coCd.equals('')">
                AND A.CO_CD = #{coCd}
            </if>
            <if test="searchType != null and searchType.equals('EST_NO')">
                AND A.EST_NO LIKE '%' || #{searchValue} || '%'
            </if>
            <if test="searchType != null and searchType.equals('CLNT_NM')">
                AND B.CLNT_NM LIKE '%' || #{searchValue} || '%'
            </if>
            <if test="estNm != null and !estNm.equals('')">
                AND A.EST_NM LIKE '%' || #{estNm} || '%'
            </if>
            <if test="searchType == null or (!searchType.equals('EST_NO') and !searchType.equals('CLNT_NM'))">
                <if test="estNo != null and !estNo.equals('')">
                    AND A.EST_NO = #{estNo}
                </if>
            </if>
            <if test="estDeg != null and !estDeg.equals('')">
                AND A.EST_DEG = #{estDeg}
            </if>
            <if test="clntCd != null and !clntCd.equals('')">
                AND B.CLNT_CD = #{clntCd}
            </if>
        </where>
        ) T
        )
        WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}
    </select>

    <resultMap id="resultInfoMap" type="CamelMap">
        <collection select="selectEstDetail" property="list" column="{coCd=CO_CD,estNo=EST_NO,estDeg=EST_DEG}" ofType="CamelMap"/>
    </resultMap>

    <select id="selectEstInfo" resultMap="resultInfoMap">
        SELECT
            TO_CHAR(B.EST_DT, 'YYYY-MM-DD') AS EST_DT,
--             TO_CHAR(B.EST_STD_DT, 'YYYY-MM-DD') AS EST_STD_DT,
            B.*,
            B.MAX_EST_DEG
        FROM (
                 SELECT
                     A.*,
                     MAX(A.EST_DEG) OVER (PARTITION BY A.CO_CD, A.EST_NO) AS MAX_EST_DEG
                 FROM TB_CR01M01 A
             ) B
        WHERE
            B.CO_CD = #{coCd}
          AND B.EST_NO = #{estNo}
          AND B.EST_DEG = #{estDeg}
    </select>


    <select id="selectEstDetail" parameterType="map" resultType="CamelMap">
        SELECT *
        FROM TB_CR01D01
        WHERE
            1 = 1
            AND CO_CD = #{coCd}
            AND EST_NO = #{estNo}
            AND EST_DEG = #{estDeg}
    </select>
    <insert id="insertEst">
        INSERT INTO TB_CR01M01
            (CO_CD, EST_NO, EST_CLNT_CD, EST_DT,
            CSTM_MNG_NM, CSTM_MNG_HP, EST_NM, EST_AMT, EST_EXCEPT,
             EST_DLVR_CNDT, EST_PMNT_CNDT, EST_DUDT, EST_DEG, FILE_TRGT_KEY)
        VALUES
            (#{coCd}, #{estNo}, #{estClntCd}, #{estDt},
            #{cstmMngNm}, #{cstmMngHp}, #{estNm}, #{estAmt}, #{estExcept},
             #{estDlvrCndt}, #{estPmntCndt}, #{estDudt}, #{estDeg}, #{fileTrgtKey})
    </insert>

    <insert id="insertEstDetail" parameterType="map">
        INSERT INTO TB_CR01D01
            (CO_CD, EST_NO, EST_DTL_DIV, EST_SEQ,
            EST_COMM, EST_SPEC, EST_UNIT, EST_QTY,
            EST_UPR, EST_DEG)
        VALUES
            (#{coCd}, #{estNo}, #{estDtlDiv}, #{estSeq},
            #{estComm}, #{estSpec}, #{estUnit}, #{estQty},
            #{estUpr}, #{estDeg})
    </insert>

    <delete id="deleteEst">
        DELETE
        FROM TB_CR01M01
        WHERE 1 = 1
            AND CO_CD = #{coCd}
            AND EST_NO = #{estNo}
            AND EST_DEG = #{estDeg}
    </delete>

    <delete id="deleteEstDetail">
        DELETE
        FROM TB_CR01D01
        WHERE 1 = 1
            AND CO_CD = #{coCd}
            AND EST_NO = #{estNo}
            AND EST_DEG = #{estDeg}
            AND EST_SEQ = #{estSeq}
    </delete>


    <update id="updateEst" parameterType="map">
        UPDATE TB_CR01M01
        SET EST_CLNT_CD   = #{estClntCd},
            EST_DT        = #{estDt},
            CSTM_MNG_NM   = #{cstmMngNm},
            CSTM_MNG_HP   = #{cstmMngHp},
            EST_NM        = #{estNm},
            EST_AMT       = #{estAmt},

            EST_EXCEPT    = #{estExcept},
--             EST_STD_DT    = #{estStdDt},

            EST_DLVR_CNDT = #{estDlvrCndt},
            EST_PMNT_CNDT = #{estPmntCndt},
            EST_DUDT      = #{estDudt},
            FILE_TRGT_KEY = #{fileTrgtKey}
        WHERE CO_CD = #{coCd}
            AND EST_NO = #{estNo}
            AND EST_DEG = #{estDeg}

    </update>

    <update id="updateEstDetail" parameterType="map">
        UPDATE TB_CR01D01
        SET EST_DTL_DIV = #{estDtlDiv},
            EST_COMM    = #{estComm},
            EST_SPEC    = #{estSpec},
            EST_UNIT    = #{estUnit},
            EST_QTY     = #{estQty},
            EST_UPR     = #{estUpr}
        WHERE CO_CD = #{coCd}
            AND EST_NO = #{estNo}
            AND EST_SEQ = #{estSeq}
    </update>

</mapper>