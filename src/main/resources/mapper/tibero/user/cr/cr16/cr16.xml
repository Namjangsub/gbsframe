<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cr.cr16.mapper.CR16Mapper"> 
     <select id="selectSalesYearPlanListCount" parameterType="Map" resultType="int"> 
          SELECT COUNT(*)
             FROM  (
                 SELECT CO_CD,
                        (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.CO_CD) AS CO_CD_NM,
                        SALES_PLAN_CLNT_CD,
                        (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD = S.SALES_PLAN_CLNT_CD) AS SALES_PLAN_CLNT_NM,
                        SALES_PLAN_DIV,
                        (SELECT Y.CODE_NM FROM TB_CM05M01 Y WHERE Y.CODE_ID = S.SALES_PLAN_DIV) AS SALES_PLAN_DIV_NM,
                        SALES_PLAN_ID,
                        (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.SALES_PLAN_ID) AS SALES_PLAN_NM,
                        SALES_PLAN_YY,
                        SALES_PLAN_AMT01,
                        SALES_PLAN_AMT02,
                        SALES_PLAN_AMT03,
                        SALES_PLAN_AMT04,
                        SALES_PLAN_AMT05,
                        SALES_PLAN_AMT06,
                        SALES_PLAN_AMT07,
                        SALES_PLAN_AMT08,
                        SALES_PLAN_AMT09,
                        SALES_PLAN_AMT10,
                        SALES_PLAN_AMT11,
                        SALES_PLAN_AMT12,
                        SALES_PLAN_TOT_AMT,
                        CREAT_ID,
                        (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.CREAT_ID) AS CREAT_NM,
                        CREAT_DTTM,
                        UDT_ID,
                        (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.UDT_ID) AS UDT_NM,
                        UDT_DTTM
                        FROM (
                                SELECT 
                                     S.CO_CD,
                                     S.SALES_PLAN_CLNT_CD,
                                     S.SALES_PLAN_DIV,
                                     S.SALES_PLAN_ID,
                                     S.SALES_PLAN_YY,
                                     NVL(MAX(S.SALES_PLAN_AMT01),0) AS SALES_PLAN_AMT01,
                                     NVL(MAX(S.SALES_PLAN_AMT02),0) AS SALES_PLAN_AMT02,
                                     NVL(MAX(S.SALES_PLAN_AMT03),0) AS SALES_PLAN_AMT03,
                                     NVL(MAX(S.SALES_PLAN_AMT04),0) AS SALES_PLAN_AMT04,
                                     NVL(MAX(S.SALES_PLAN_AMT05),0) AS SALES_PLAN_AMT05,
                                     NVL(MAX(S.SALES_PLAN_AMT06),0) AS SALES_PLAN_AMT06,
                                     NVL(MAX(S.SALES_PLAN_AMT07),0) AS SALES_PLAN_AMT07,
                                     NVL(MAX(S.SALES_PLAN_AMT08),0) AS SALES_PLAN_AMT08,
                                     NVL(MAX(S.SALES_PLAN_AMT09),0) AS SALES_PLAN_AMT09,
                                     NVL(MAX(S.SALES_PLAN_AMT10),0) AS SALES_PLAN_AMT10,
                                     NVL(MAX(S.SALES_PLAN_AMT11),0) AS SALES_PLAN_AMT11,
                                     NVL(MAX(S.SALES_PLAN_AMT12),0) AS SALES_PLAN_AMT12,
                                     NVL(MAX(TOT_S.SALES_PLAN_TOT_AMT),0) AS SALES_PLAN_TOT_AMT,
                                     NVL(MAX(S.CREAT_ID),'') AS CREAT_ID,
                                     MAX(TO_CHAR(S.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS CREAT_DTTM,
                                     NVL(MAX(S.UDT_ID),'') AS UDT_ID,
                                     MAX(TO_CHAR(S.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS UDT_DTTM
                                     FROM (
                                             SELECT 
                                             CO_CD,
                                             SALES_PLAN_CLNT_CD,
                                             SALES_PLAN_DIV,
                                             SALES_PLAN_ID,
                                             SUBSTR(SALES_PLAN_YM,0,4) AS SALES_PLAN_YY,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '01' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT01,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '02' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT02,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '03' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT03,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '04' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT04,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '05' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT05,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '06' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT06,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '07' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT07,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '08' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT08,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '09' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT09,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '10' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT10,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '11' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT11,
                                             CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '12' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT12,                                 
                                             CREAT_ID,
                                             CREAT_DTTM,
                                             UDT_ID,
                                             UDT_DTTM
                                             FROM TB_CR10M01 ) S
                                             LEFT OUTER JOIN 
                                             ( SELECT CO_CD,
                                             SALES_PLAN_CLNT_CD,
                                             SALES_PLAN_DIV,
                                             SALES_PLAN_ID,
                                             SUBSTR(SALES_PLAN_YM,0,4) AS SALES_PLAN_YY,
                                             SUM(SALES_PLAN_AMT) AS SALES_PLAN_TOT_AMT 
                                             FROM TB_CR10M01
                                             GROUP BY CO_CD,
                                             SALES_PLAN_CLNT_CD,
                                             SALES_PLAN_DIV,
                                             SALES_PLAN_ID,
                                             SUBSTR(SALES_PLAN_YM,0,4)) TOT_S
                                             ON S.CO_CD = TOT_S.CO_CD
                                             AND S.SALES_PLAN_CLNT_CD  = TOT_S.SALES_PLAN_CLNT_CD
                                             AND S.SALES_PLAN_DIV  = TOT_S.SALES_PLAN_DIV
                                             AND S.SALES_PLAN_ID  = TOT_S.SALES_PLAN_ID
                                             AND S.SALES_PLAN_YY = TOT_S.SALES_PLAN_YY
                                             GROUP BY S.CO_CD, S.SALES_PLAN_CLNT_CD, S.SALES_PLAN_DIV, 
                                             S.SALES_PLAN_YY, S.SALES_PLAN_ID                                                    
                                             ) S ) S     
                   WHERE CO_CD = #{coCd}
                   AND SALES_PLAN_YY = #{salesPlanYy}
                   <if test="salesPlanClntCd != null and !salesPlanClntCd.equals('')">
                    AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}               
                   </if>  
                   <if test="salesPlanClntNm != null and !salesPlanClntNm.equals('')">
                    AND SALES_PLAN_CLNT_NM LIKE '%${salesPlanClntNm}%'               
                   </if>
                   <if test="salesPlanId != null and !salesPlanId.equals('')">
                    AND SALES_PLAN_ID = #{salesPlanId}               
                   </if>  
                   <if test="salesPlanNm != null and !salesPlanNm.equals('')">
                    AND SALES_PLAN_CLNT_NM LIKE '%${salesPlanNm}%'               
                   </if>
                   <if test="salesPlanDiv != null and !salesPlanDiv.equals('')">
                    AND SALES_PLAN_DIV = #{salesPlanDiv}               
                   </if>  
                   
         </select>
                 
         <select id="selectSalesYearPlanList" parameterType="Map" resultType="camelMap"> 
          SELECT *
             FROM (
			          SELECT ROWNUM AS RN, S.* 
			             FROM  (
				             SELECT CO_CD,
				                    (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.CO_CD) AS CO_CD_NM,
				                    SALES_PLAN_CLNT_CD,
				                    (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD = S.SALES_PLAN_CLNT_CD) AS SALES_PLAN_CLNT_NM,
				                    SALES_PLAN_DIV,
				                    (SELECT Y.CODE_NM FROM TB_CM05M01 Y WHERE Y.CODE_ID = S.SALES_PLAN_DIV) AS SALES_PLAN_DIV_NM,
				                    SALES_PLAN_ID,
				                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.SALES_PLAN_ID) AS SALES_PLAN_NM,
				                    SALES_PLAN_YY,
				                    SALES_PLAN_AMT01,
				                    SALES_PLAN_AMT02,
				                    SALES_PLAN_AMT03,
				                    SALES_PLAN_AMT04,
				                    SALES_PLAN_AMT05,
				                    SALES_PLAN_AMT06,
				                    SALES_PLAN_AMT07,
				                    SALES_PLAN_AMT08,
				                    SALES_PLAN_AMT09,
				                    SALES_PLAN_AMT10,
				                    SALES_PLAN_AMT11,
				                    SALES_PLAN_AMT12,
				                    SALES_PLAN_TOT_AMT,
				                    CREAT_ID,
				                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.CREAT_ID) AS CREAT_NM,
				                    CREAT_DTTM,
				                    UDT_ID,
				                    (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.UDT_ID) AS UDT_NM,
				                    UDT_DTTM
				                    FROM (
						                    SELECT 
						                         S.CO_CD,
						                         S.SALES_PLAN_CLNT_CD,
						                         S.SALES_PLAN_DIV,
						                         S.SALES_PLAN_ID,
						                         S.SALES_PLAN_YY,
						                         NVL(MAX(S.SALES_PLAN_AMT01),0) AS SALES_PLAN_AMT01,
						                         NVL(MAX(S.SALES_PLAN_AMT02),0) AS SALES_PLAN_AMT02,
						                         NVL(MAX(S.SALES_PLAN_AMT03),0) AS SALES_PLAN_AMT03,
						                         NVL(MAX(S.SALES_PLAN_AMT04),0) AS SALES_PLAN_AMT04,
						                         NVL(MAX(S.SALES_PLAN_AMT05),0) AS SALES_PLAN_AMT05,
						                         NVL(MAX(S.SALES_PLAN_AMT06),0) AS SALES_PLAN_AMT06,
						                         NVL(MAX(S.SALES_PLAN_AMT07),0) AS SALES_PLAN_AMT07,
						                         NVL(MAX(S.SALES_PLAN_AMT08),0) AS SALES_PLAN_AMT08,
						                         NVL(MAX(S.SALES_PLAN_AMT09),0) AS SALES_PLAN_AMT09,
						                         NVL(MAX(S.SALES_PLAN_AMT10),0) AS SALES_PLAN_AMT10,
						                         NVL(MAX(S.SALES_PLAN_AMT11),0) AS SALES_PLAN_AMT11,
						                         NVL(MAX(S.SALES_PLAN_AMT12),0) AS SALES_PLAN_AMT12,
						                         NVL(MAX(TOT_S.SALES_PLAN_TOT_AMT),0) AS SALES_PLAN_TOT_AMT,
						                         NVL(MAX(S.CREAT_ID),'') AS CREAT_ID,
						                         MAX(TO_CHAR(S.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS CREAT_DTTM,
						                         NVL(MAX(S.UDT_ID),'') AS UDT_ID,
						                         MAX(TO_CHAR(S.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS UDT_DTTM
						                         FROM (
						                                 SELECT 
						                                 CO_CD,
						                                 SALES_PLAN_CLNT_CD,
						                                 SALES_PLAN_DIV,
						                                 SALES_PLAN_ID,
						                                 SUBSTR(SALES_PLAN_YM,0,4) AS SALES_PLAN_YY,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '01' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT01,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '02' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT02,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '03' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT03,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '04' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT04,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '05' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT05,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '06' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT06,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '07' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT07,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '08' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT08,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '09' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT09,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '10' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT10,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '11' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT11,
						                                 CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '12' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT12,                                 
						                                 CREAT_ID,
						                                 CREAT_DTTM,
						                                 UDT_ID,
						                                 UDT_DTTM
						                                 FROM TB_CR10M01 ) S
						                                 LEFT OUTER JOIN 
						                                 ( SELECT CO_CD,
						                                 SALES_PLAN_CLNT_CD,
						                                 SALES_PLAN_DIV,
						                                 SALES_PLAN_ID,
						                                 SUBSTR(SALES_PLAN_YM,0,4) AS SALES_PLAN_YY,
						                                 SUM(SALES_PLAN_AMT) AS SALES_PLAN_TOT_AMT 
						                                 FROM TB_CR10M01
						                                 GROUP BY CO_CD,
						                                 SALES_PLAN_CLNT_CD,
						                                 SALES_PLAN_DIV,
						                                 SALES_PLAN_ID,
						                                 SUBSTR(SALES_PLAN_YM,0,4)) TOT_S
						                                 ON S.CO_CD = TOT_S.CO_CD
						                                 AND S.SALES_PLAN_CLNT_CD  = TOT_S.SALES_PLAN_CLNT_CD
						                                 AND S.SALES_PLAN_DIV  = TOT_S.SALES_PLAN_DIV
						                                 AND S.SALES_PLAN_ID  = TOT_S.SALES_PLAN_ID
						                                 AND S.SALES_PLAN_YY = TOT_S.SALES_PLAN_YY
						                                 GROUP BY S.CO_CD, S.SALES_PLAN_CLNT_CD, S.SALES_PLAN_DIV, 
						                                 S.SALES_PLAN_YY, S.SALES_PLAN_ID 
						                                 ) S ) S
						            WHERE CO_CD = #{coCd}
			                          AND SALES_PLAN_YY = #{salesPlanYy}
			                          <if test="salesPlanClntCd != null and !salesPlanClntCd.equals('')">
			                           AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}               
			                          </if>  
			                          <if test="salesPlanClntNm != null and !salesPlanClntNm.equals('')">
			                           AND SALES_PLAN_CLNT_NM LIKE '%${salesPlanClntNm}%'               
			                          </if>
			                          <if test="salesPlanId != null and !salesPlanId.equals('')">
			                           AND SALES_PLAN_ID = #{salesPlanId}               
			                          </if>  
			                          <if test="salesPlanNm != null and !salesPlanNm.equals('')">
			                           AND SALES_PLAN_CLNT_NM LIKE '%${salesPlanNm}%'               
			                          </if>
			                          <if test="salesPlanDiv != null and !salesPlanDiv.equals('')">
			                           AND SALES_PLAN_DIV = #{salesPlanDiv}               
			                          </if>                      
			                          ORDER BY SALES_PLAN_CLNT_CD, SALES_PLAN_YY, SALES_PLAN_ID ASC 
			                          ) S       
                        WHERE ROWNUM BETWEEN ${firstIndex} AND ${lastIndex}                             
         </select>
         
         <delete id="deleteSalesYearPlanM" parameterType="Map">
               DELETE FROM TB_CR10M01
                   WHERE CO_CD = #{coCd}
                   AND SUBSTR(SALES_PLAN_YM,0,4) = #{salesPlanYy}
                   AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd} 
                   AND SALES_PLAN_DIV = #{salesPlanDiv}
        </delete>
        
        <delete id="deleteSalesYearPlanD" parameterType="Map">
               DELETE FROM TB_CR10D01
                   WHERE CO_CD = #{coCd}
                   AND SUBSTR(SALES_PLAN_YM,0,4) = #{salesPlanYy}
                   AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd} 
                   AND SALES_PLAN_DIV = #{salesPlanDiv}
        </delete>
        
        <select id="selectSalesYearPlanMC" parameterType="Map" resultType="camelMap"> 
			SELECT S.CO_CD, 
			        S.FILE_TRGT_KEY, S.SALES_PLAN_CLNT_CD, S.SALES_PLAN_DIV, S.SALES_PLAN_ID, S.SALES_PLAN_YM, 
                      S.SALES_PLAN_AMT, NVL(P1.ORDRS_TOT_AMT,0) AS ORDRS_TOT_AMT,
                      0 AS PRE_SALES_PLAN_AMT, 
                      S.SALES_PLAN_AMT- NVL(P1.ORDRS_TOT_AMT,0) AS DIF_TOT_AMT,
                      S.SALES_PLAN_RMK, 'N' AS PLAN_CLOSE_YN,
                      NVL(P2.SALES_PLAN_AMT,0) AS PRE_SALES_PLAN_AMT
			FROM (
				               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
				               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'01' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
				               '' AS SALES_PLAN_RMK FROM DUAL				               
				               UNION ALL 
				               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
				               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'02' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
				               '' AS SALES_PLAN_RMK FROM DUAL				               
				               UNION ALL 
				               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
				               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'03' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
				               '' AS SALES_PLAN_RMK FROM DUAL                               
				               UNION ALL 
				               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
				               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'04' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
				               '' AS SALES_PLAN_RMK FROM DUAL                                
				               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'05' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'06' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'07' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'08' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'09' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'10' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'11' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                               UNION ALL 
                               SELECT '' AS FILE_TRGT_KEY, #{coCd} AS CO_CD, #{salesPlanClntCd} AS SALES_PLAN_CLNT_CD, #{salesPlanDiv} AS SALES_PLAN_DIV, 
                               #{salesPlanId} AS SALES_PLAN_ID, #{salesPlanYy, jdbcType=VARCHAR}||'12' AS SALES_PLAN_YM, 0 AS SALES_PLAN_AMT, 
                               '' AS SALES_PLAN_RMK FROM DUAL                                
                           ) S
				               
			               LEFT OUTER JOIN (
	                            SELECT CO_CD, ORDRS_CLNT_CD,  
	                            TO_CHAR(ORDRS_DT, 'YYYYMM') AS ORDRS_DT, 
	                            SUM(ORDRS_AMT) AS ORDRS_TOT_AMT   
	                            FROM TB_CR02M01
	                            WHERE ORDRS_DIV IN ('ORDRSDIV1','ORDRSDIV2')
	                            GROUP BY CO_CD, ORDRS_CLNT_CD, TO_CHAR(ORDRS_DT, 'YYYYMM')
                            ) P1 ON S.CO_CD = P1.CO_CD 
                                AND S.SALES_PLAN_CLNT_CD = P1.ORDRS_CLNT_CD
                                AND S.SALES_PLAN_YM = P1.ORDRS_DT
                           
                           LEFT OUTER JOIN TB_CR10M01_HIST P2
                                 ON S.CO_CD = P2.CO_CD
                                AND S.SALES_PLAN_CLNT_CD = P2.SALES_PLAN_CLNT_CD
                                AND S.SALES_PLAN_DIV = P2.SALES_PLAN_DIV
                                AND S.SALES_PLAN_ID = P2.SALES_PLAN_ID
                                AND TO_CHAR(TO_NUMBER(SUBSTR(S.SALES_PLAN_YM,0,4))-1)||SUBSTR(S.SALES_PLAN_YM,5,2) = P2.SALES_PLAN_CLOSE_MM    
                           
                           ORDER BY  S.SALES_PLAN_YM ASC
        </select>
        
        <select id="selectSalesYearPlanMU" parameterType="Map" resultType="camelMap"> 
               SELECT S.CO_CD, 
                      S.FILE_TRGT_KEY, S.SALES_PLAN_CLNT_CD, S.SALES_PLAN_DIV, S.SALES_PLAN_ID, S.SALES_PLAN_YM, 
                      S.SALES_PLAN_AMT, NVL(P1.ORDRS_TOT_AMT,0) AS ORDRS_TOT_AMT,
                      0 AS PRE_SALES_PLAN_AMT, 
                      S.SALES_PLAN_AMT- NVL(P1.ORDRS_TOT_AMT,0) AS DIF_TOT_AMT,
                      S.SALES_PLAN_RMK, S.PLAN_CLOSE_YN,
                      NVL(P2.SALES_PLAN_AMT,0) AS PRE_SALES_PLAN_AMT
                  FROM TB_CR10M01 S 
                  LEFT OUTER JOIN (
	                            SELECT CO_CD, ORDRS_CLNT_CD,  
	                            TO_CHAR(ORDRS_DT, 'YYYYMM') AS ORDRS_DT, 
	                            SUM(ORDRS_AMT) AS ORDRS_TOT_AMT   
	                            FROM TB_CR02M01
	                            WHERE ORDRS_DIV IN ('ORDRSDIV1','ORDRSDIV2')
	                            GROUP BY CO_CD, ORDRS_CLNT_CD, TO_CHAR(ORDRS_DT, 'YYYYMM')
                            ) P1 ON S.CO_CD = P1.CO_CD 
                                AND S.SALES_PLAN_CLNT_CD = P1.ORDRS_CLNT_CD
                                AND S.SALES_PLAN_YM = P1.ORDRS_DT
                           
	                       LEFT OUTER JOIN TB_CR10M01_HIST P2
	                        ON S.CO_CD = P2.CO_CD
	                        AND S.SALES_PLAN_CLNT_CD = P2.SALES_PLAN_CLNT_CD
	                        AND S.SALES_PLAN_DIV = P2.SALES_PLAN_DIV
	                        AND S.SALES_PLAN_ID = P2.SALES_PLAN_ID
	                        AND TO_CHAR(TO_NUMBER(SUBSTR(S.SALES_PLAN_YM,0,4))-1)||SUBSTR(S.SALES_PLAN_YM,5,2) = P2.SALES_PLAN_CLOSE_MM    
                           WHERE S.CO_CD = #{coCd}
                           AND S.SALES_PLAN_CLNT_CD = #{salesPlanClntCd}   
                           AND S.SALES_PLAN_DIV = #{salesPlanDiv}
                           AND S.SALES_PLAN_ID = #{salesPlanId}
                           AND SUBSTR(S.SALES_PLAN_YM,0,4) = #{salesPlanYy}
                           ORDER BY  S.SALES_PLAN_YM ASC
        </select>   
               
        <select id="selectSalesYearPlanD" parameterType="Map" resultType="camelMap"> 
               SELECT CO_CD,
                      (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.CO_CD) AS CO_CD_NM,
			          CLNT_CD, 
			          (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD = S.CLNT_CD) AS CLNT_NM,
			          EQP_NM, 
			          EQP_QTY,
			          TO_CHAR(DUDT_PLAN_DT, 'YYYY-MM-DD') AS DUDT_PLAN_DT, 
			          EPCT_AMT,
			          TO_CHAR(ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT,  
			          ORDRS_AMT,
			          TO_CHAR(ORDRS_PLAN_DT, 'YYYY-MM-DD') AS ORDRS_PLAN_DT , 
			          ORDRS_PLAN_AMT,
			          WINBD_CD, 
			          WINBD_RMK
			      FROM TB_BM06M01 S
                   WHERE CO_CD = #{coCd}
                   AND CLNT_CD = #{salesPlanClntCd}                    
                   AND TO_CHAR(ORDRS_PLAN_DT, 'YYYYMM') = #{salesPlanYm}
                   ORDER BY ORDRS_PLAN_DT ASC
        </select>
        
        <select id="selectSalesYearPlanSeqNext" parameterType="Map" resultType="int">
             SELECT TB_CR10M01_SQ01.NEXTVAL FROM DUAL
        </select>
        
        <insert id="salesPlanYearInsert" parameterType="Map">
                INSERT INTO TB_CR10M01
                (
                       FILE_TRGT_KEY,
                       CO_CD,
                       SALES_PLAN_YM,
                       SALES_PLAN_ID,
                       SALES_PLAN_CLNT_CD,
                       SALES_PLAN_DIV,
                       SALES_PLAN_AMT,
                       SALES_PLAN_RMK,
                       CREAT_ID,
                       CREAT_PGM,
                       CREAT_DTTM
                ) 
                VALUES
                (
                        #{fileTrgtKey},
                        #{coCd},
                        #{salesPlanYm},
                        #{salesPlanId},
                        #{salesPlanClntCd},
                        #{salesPlanDiv},
                        #{salesPlanAmt},
                        #{salesPlanRmk},
                        #{creatId},
                        #{creatPgm},
                        SYSDATE  
                ) 
        </insert>  
        
        <update id="salesPlanYearUpdate" parameterType="Map">
           UPDATE TB_CR10M01
               SET SALES_PLAN_AMT = #{salesPlanAmt},
                   SALES_PLAN_RMK = #{salesPlanRmk} 
             WHERE FILE_TRGT_KEY = #{fileTrgtKey}      
        </update>                  
        
        
        <select id="salesYearPlanCloseChk" parameterType="Map" resultType="camelMap"> 
                SELECT *
                  FROM TB_CR10M01_HIST 
                  WHERE CO_CD = #{coCd}
                    AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}   
                    AND SALES_PLAN_DIV = #{salesPlanDiv}
                    AND SALES_PLAN_ID = #{salesPlanId}
                    AND SALES_PLAN_YM = #{salesPlanYm}
                    AND SALES_PLAN_CLOSE_MM = #{salesPlanCloseMm}
        </select>
        
        
        <insert id="salesYearPlanCloseInsert" parameterType="Map">
                <selectKey keyProperty="toDoKey" resultType="Int" order="BEFORE">
                    SELECT NVL(MAX(FILE_TRGT_KEY),0) + 1 FROM TB_CR10M01_HIST
                </selectKey>
                INSERT INTO TB_CR10M01_HIST
                (
                       FILE_TRGT_KEY,
                       CO_CD,
                       SALES_PLAN_CLOSE_MM,
                       SALES_PLAN_YM,
                       SALES_PLAN_ID,
                       SALES_PLAN_CLNT_CD,
                       SALES_PLAN_DIV,
                       SALES_PLAN_AMT,
                       SALES_PLAN_RMK,
                       PLAN_CLOSE_YN,
                       CREAT_ID,
                       CREAT_PGM,
                       CREAT_DTTM
                ) 
                VALUES
                (
                        #{fileTrgtKey},
                        #{coCd},
                        #{salesPlanCloseMm},
                        #{salesPlanYm},
                        #{salesPlanId},
                        #{salesPlanClntCd},
                        #{salesPlanDiv},
                        #{salesPlanAmt},
                        #{salesPlanRmk},
                        'Y',
                        #{creatId},
                        #{creatPgm},
                        SYSDATE  
                ) 
        </insert>  
        
        <update id="salesYearPlanCloseUpdate" parameterType="Map">
           UPDATE TB_CR10M01_HIST
               SET SALES_PLAN_AMT = #{salesPlanAmt},
                   SALES_PLAN_RMK = #{salesPlanRmk} 
             WHERE CO_CD = #{coCd}
	               AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}   
	               AND SALES_PLAN_DIV = #{salesPlanDiv}
	               AND SALES_PLAN_ID = #{salesPlanId}
	               AND SALES_PLAN_YM = #{salesPlanYm}
	               AND SALES_PLAN_CLOSE_MM = #{salesPlanCloseMm}     
        </update>           
        
        <delete id="salesYearPlanCloseDelete" parameterType="Map">
               DELETE FROM TB_CR10M01_HIST
               WHERE CO_CD = #{coCd}
	               AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}   
	               AND SALES_PLAN_DIV = #{salesPlanDiv}
	               AND SALES_PLAN_ID = #{salesPlanId}
	               AND SALES_PLAN_YM = #{salesPlanYm}
	               AND SALES_PLAN_CLOSE_MM = #{salesPlanCloseMm}  
        </delete>
        
        <update id="salesYearPlanCloseChkUpdateY" parameterType="Map">
           UPDATE TB_CR10M01
               SET PLAN_CLOSE_YN = 'Y' 
             WHERE CO_CD = #{coCd}
                   AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}   
                   AND SALES_PLAN_DIV = #{salesPlanDiv}
                   AND SALES_PLAN_ID = #{salesPlanId}
                   AND SALES_PLAN_YM = #{salesPlanYm}   
        </update>    
        
        <update id="salesYearPlanCloseChkUpdateN" parameterType="Map">
           UPDATE TB_CR10M01
               SET PLAN_CLOSE_YN = 'N' 
             WHERE CO_CD = #{coCd}
                   AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}   
                   AND SALES_PLAN_DIV = #{salesPlanDiv}
                   AND SALES_PLAN_ID = #{salesPlanId}
                   AND SALES_PLAN_YM = #{salesPlanYm}   
        </update>  
               
        <select id="selectSalesYearPlanListHist" parameterType="Map" resultType="camelMap"> 
             SELECT ROWNUM AS RN, S.* 
                FROM  (
                    SELECT CO_CD,
                           (SELECT T.CODE_NM FROM TB_CM05M01 T WHERE T.CODE_ID = S.CO_CD) AS CO_CD_NM,
                           SALES_PLAN_CLNT_CD,
                           (SELECT T.CLNT_NM FROM TB_BM02M01 T WHERE T.CLNT_CD = S.SALES_PLAN_CLNT_CD) AS SALES_PLAN_CLNT_NM,
                           SALES_PLAN_DIV,
                           (SELECT Y.CODE_NM FROM TB_CM05M01 Y WHERE Y.CODE_ID = S.SALES_PLAN_DIV) AS SALES_PLAN_DIV_NM,
                           SALES_PLAN_ID,
                           (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.SALES_PLAN_ID) AS SALES_PLAN_NM,
                           SALES_PLAN_YY,
                           SALES_PLAN_AMT01,
                           SALES_PLAN_AMT02,
                           SALES_PLAN_AMT03,
                           SALES_PLAN_AMT04,
                           SALES_PLAN_AMT05,
                           SALES_PLAN_AMT06,
                           SALES_PLAN_AMT07,
                           SALES_PLAN_AMT08,
                           SALES_PLAN_AMT09,
                           SALES_PLAN_AMT10,
                           SALES_PLAN_AMT11,
                           SALES_PLAN_AMT12,
                           SALES_PLAN_TOT_AMT,
                           CREAT_ID,
                           (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.CREAT_ID) AS CREAT_NM,
                           CREAT_DTTM,
                           UDT_ID,
                           (SELECT T.NAME FROM TB_CM06M01 T WHERE T.ID = S.UDT_ID) AS UDT_NM,
                           UDT_DTTM
                           FROM (
                                   SELECT 
                                        S.CO_CD,
                                        S.SALES_PLAN_CLNT_CD,
                                        S.SALES_PLAN_DIV,
                                        S.SALES_PLAN_ID,
                                        S.SALES_PLAN_YY,
                                        NVL(MAX(S.SALES_PLAN_AMT01),0) AS SALES_PLAN_AMT01,
                                        NVL(MAX(S.SALES_PLAN_AMT02),0) AS SALES_PLAN_AMT02,
                                        NVL(MAX(S.SALES_PLAN_AMT03),0) AS SALES_PLAN_AMT03,
                                        NVL(MAX(S.SALES_PLAN_AMT04),0) AS SALES_PLAN_AMT04,
                                        NVL(MAX(S.SALES_PLAN_AMT05),0) AS SALES_PLAN_AMT05,
                                        NVL(MAX(S.SALES_PLAN_AMT06),0) AS SALES_PLAN_AMT06,
                                        NVL(MAX(S.SALES_PLAN_AMT07),0) AS SALES_PLAN_AMT07,
                                        NVL(MAX(S.SALES_PLAN_AMT08),0) AS SALES_PLAN_AMT08,
                                        NVL(MAX(S.SALES_PLAN_AMT09),0) AS SALES_PLAN_AMT09,
                                        NVL(MAX(S.SALES_PLAN_AMT10),0) AS SALES_PLAN_AMT10,
                                        NVL(MAX(S.SALES_PLAN_AMT11),0) AS SALES_PLAN_AMT11,
                                        NVL(MAX(S.SALES_PLAN_AMT12),0) AS SALES_PLAN_AMT12,
                                        NVL(MAX(TOT_S.SALES_PLAN_TOT_AMT),0) AS SALES_PLAN_TOT_AMT,
                                        NVL(MAX(S.CREAT_ID),'') AS CREAT_ID,
                                        MAX(TO_CHAR(S.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS CREAT_DTTM,
                                        NVL(MAX(S.UDT_ID),'') AS UDT_ID,
                                        MAX(TO_CHAR(S.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')) AS UDT_DTTM
                                        FROM (
                                                SELECT 
                                                CO_CD,
                                                SALES_PLAN_CLNT_CD,
                                                SALES_PLAN_DIV,
                                                SALES_PLAN_ID,
                                                SUBSTR(SALES_PLAN_YM,0,4) AS SALES_PLAN_YY,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '01' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT01,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '02' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT02,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '03' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT03,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '04' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT04,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '05' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT05,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '06' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT06,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '07' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT07,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '08' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT08,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '09' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT09,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '10' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT10,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '11' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT11,
                                                CASE WHEN SUBSTR(SALES_PLAN_YM,5,2) = '12' THEN SALES_PLAN_AMT END AS SALES_PLAN_AMT12,                                 
                                                CREAT_ID,
                                                CREAT_DTTM,
                                                UDT_ID,
                                                UDT_DTTM
                                                FROM TB_CR10M01 ) S
                                                LEFT OUTER JOIN 
                                                ( SELECT CO_CD,
                                                SALES_PLAN_CLNT_CD,
                                                SALES_PLAN_DIV,
                                                SALES_PLAN_ID,
                                                SUBSTR(SALES_PLAN_YM,0,4) AS SALES_PLAN_YY,
                                                SUM(SALES_PLAN_AMT) AS SALES_PLAN_TOT_AMT 
                                                FROM TB_CR10M01
                                                GROUP BY CO_CD,
                                                SALES_PLAN_CLNT_CD,
                                                SALES_PLAN_DIV,
                                                SALES_PLAN_ID,
                                                SUBSTR(SALES_PLAN_YM,0,4)) TOT_S
                                                ON S.CO_CD = TOT_S.CO_CD
                                                AND S.SALES_PLAN_CLNT_CD  = TOT_S.SALES_PLAN_CLNT_CD
                                                AND S.SALES_PLAN_DIV  = TOT_S.SALES_PLAN_DIV
                                                AND S.SALES_PLAN_ID  = TOT_S.SALES_PLAN_ID
                                                AND S.SALES_PLAN_YY = TOT_S.SALES_PLAN_YY
                                                GROUP BY S.CO_CD, S.SALES_PLAN_CLNT_CD, S.SALES_PLAN_DIV, 
                                                S.SALES_PLAN_YY, S.SALES_PLAN_ID 
                                                ) S ) S
                           WHERE CO_CD = #{coCd}
                             AND SALES_PLAN_YY = #{salesPlanYy}
			                   <if test="salesPlanClntCd != null and !salesPlanClntCd.equals('')">
			                    AND SALES_PLAN_CLNT_CD = #{salesPlanClntCd}               
			                   </if>  
			                   <if test="salesPlanClntNm != null and !salesPlanClntNm.equals('')">
			                    AND SALES_PLAN_CLNT_NM LIKE '%${salesPlanClntNm}%'               
			                   </if>
			                   <if test="salesPlanId != null and !salesPlanId.equals('')">
			                    AND SALES_PLAN_ID = #{salesPlanId}               
			                   </if>  
			                   <if test="salesPlanNm != null and !salesPlanNm.equals('')">
			                    AND SALES_PLAN_CLNT_NM LIKE '%${salesPlanNm}%'               
			                   </if>
			                   <if test="salesPlanDiv != null and !salesPlanDiv.equals('')">
			                    AND SALES_PLAN_DIV = #{salesPlanDiv}               
			                   </if>  
                             ORDER BY SALES_PLAN_YY ASC                                             
         </select>                
</mapper>


