<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.pm.pm01.mapper.PM01Mapper">

	<select id="selectDailyWorkCount" parameterType="Map" resultType="int">
		SELECT
            COUNT(*)
            FROM TB_PM01M01 T
				LEFT OUTER JOIN
				( SELECT CODE_ID AS WORK_RPT_L, CODE_NM AS WORK_RPT_L_NM
					FROM
						TB_CM05M01
					WHERE USE_YN = 'Y'
					  AND LEVEL = 2
					START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
					CONNECT BY PRIOR CODE_ID = CODE_KIND
				) TL
				ON T.WORK_RPT_L = TL.WORK_RPT_L
				LEFT OUTER JOIN
				( SELECT CODE_ID AS WORK_RPT_M, CODE_NM AS WORK_RPT_M_NM
					FROM
						TB_CM05M01
					WHERE USE_YN = 'Y'
					  AND LEVEL = 3
					START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
					CONNECT BY PRIOR CODE_ID = CODE_KIND
				) TM
				ON T.WORK_RPT_M = TM.WORK_RPT_M
				LEFT OUTER JOIN
				( SELECT CODE_ID AS WORK_RPT_S, CODE_NM AS WORK_RPT_S_NM
					FROM
						TB_CM05M01
					WHERE USE_YN = 'Y'
					  AND LEVEL = 4
					START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
					CONNECT BY PRIOR CODE_ID = CODE_KIND
      			) TS
      			ON T.WORK_RPT_S = TS.WORK_RPT_S
				LEFT OUTER JOIN
				(  SELECT  T1.CO_CD
					     , T2.SALES_CD
					     , T2.PRDT_CD
					     , T2.ITEM_DIV
					     , T1.CLNT_PJT
					     , T2.EQP_NM
					     , T3.CLNT_NM
					 FROM TB_CR02M01 AS T1
					 JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
					 LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
      			) TD
      			ON T.CO_CD = TD.CO_CD AND T.SALES_CD = TD.SALES_CD
		        WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
              <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.WORK_RPT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="workRptId !=null and !workRptId.equals('')">
     	           AND T.WORK_RPT_ID = #{workRptId}
              </if>			  			  
              <if test="salesCd != null and !salesCd.equals('')">
     	           AND T.SALES_CD = #{salesCd}
              </if>
              <if test="prdtCd != null and !prdtCd.equals('')">
     	           AND TD.PRDT_CD = #{prdtCd}
              </if>
              <if test="itemDiv != null and !itemDiv.equals('')">
     	           AND TD.ITEM_DIV = #{itemDiv}
              </if>
              <if test="workRptL != null and !workRptL.equals('')">
     	           AND T.WORK_RPT_L = #{workRptL}
              </if>
              <if test="workRptM != null and !workRptM.equals('')">
     	           AND T.WORK_RPT_M = #{workRptM}
              </if>
              <if test="workRptS !=null and !workRptS.equals('')">
     	           AND T.WORK_RPT_S = #{workRptS}
              </if>			  			  

	</select>

	<select id="selectDailyWorkList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
				SELECT 		  T.FILE_TRGT_KEY
							, T.CO_CD
							, FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
							, T.WORK_RPT_NO
							, T.WORK_RPT_ID
							, (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS WORK_RPT_ID_NM
							, TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WORK_RPT_DT
							, T.WORK_RPT_L
							, T.WORK_RPT_M
							, T.WORK_RPT_S
							, TL.WORK_RPT_L_NM
							, TM.WORK_RPT_M_NM
							, TS.WORK_RPT_S_NM
							, T.WORK_RPT_HOUR
							, T.SALES_CD
							, TD.PRDT_CD_NM
							, TD.ITEM_DIV_NM
							, T.WORK_RPT_RMK
							, T.ETC_FIELD1
							, T.ETC_FIELD2
							, T.ETC_FIELD3
							, T.CREAT_ID
							, (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS CREAT_NM
							, TO_CHAR(T.CREAT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS CREAT_DTTM
							, T.UDT_ID
							, (SELECT NAME FROM TB_CM06M01 WHERE ID = T.UDT_ID) AS UDT_NM
							, TO_CHAR(T.UDT_DTTM,'YYYY-MM-DD HH24:MM:SS') AS UDT_DTTM
				  FROM TB_PM01M01 T
								LEFT OUTER JOIN
								( SELECT CODE_ID AS WORK_RPT_L, CODE_NM AS WORK_RPT_L_NM
									FROM
										TB_CM05M01
									WHERE USE_YN = 'Y'
									  AND LEVEL = 2
									START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
									CONNECT BY PRIOR CODE_ID = CODE_KIND
								) TL
								ON T.WORK_RPT_L = TL.WORK_RPT_L
								LEFT OUTER JOIN
								( SELECT CODE_ID AS WORK_RPT_M, CODE_NM AS WORK_RPT_M_NM
									FROM
										TB_CM05M01
									WHERE USE_YN = 'Y'
									  AND LEVEL = 3
									START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
									CONNECT BY PRIOR CODE_ID = CODE_KIND
								) TM
								ON T.WORK_RPT_M = TM.WORK_RPT_M
								LEFT OUTER JOIN
								( SELECT CODE_ID AS WORK_RPT_S, CODE_NM AS WORK_RPT_S_NM
									FROM
										TB_CM05M01
									WHERE USE_YN = 'Y'
									  AND LEVEL = 4
									START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
									CONNECT BY PRIOR CODE_ID = CODE_KIND
				      			) TS
				      			ON T.WORK_RPT_S = TS.WORK_RPT_S
								LEFT OUTER JOIN
								(  SELECT  T1.CO_CD
									     , T2.SALES_CD
									     , T2.PRDT_CD
									     , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_CD_NM
									     , T2.ITEM_DIV
									     , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
									     , T1.CLNT_PJT
									     , T2.EQP_NM
									     , T3.CLNT_NM
									 FROM TB_CR02M01 AS T1
									 JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
									 LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
				      			) TD
				      			ON T.CO_CD = TD.CO_CD AND T.SALES_CD = TD.SALES_CD
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
              <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.WORK_RPT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="workRptId !=null and !workRptId.equals('')">
     	           AND T.WORK_RPT_ID = #{workRptId}
              </if>			  			  
              <if test="salesCd != null and !salesCd.equals('')">
     	           AND T.SALES_CD = #{salesCd}
              </if>
              <if test="prdtCd != null and !prdtCd.equals('')">
     	           AND TD.PRDT_CD = #{prdtCd}
              </if>
              <if test="itemDiv != null and !itemDiv.equals('')">
     	           AND TD.ITEM_DIV = #{itemDiv}
              </if>
              <if test="workRptL != null and !workRptL.equals('')">
     	           AND T.WORK_RPT_L = #{workRptL}
              </if>
              <if test="workRptM != null and !workRptM.equals('')">
     	           AND T.WORK_RPT_M = #{workRptM}
              </if>
              <if test="workRptS !=null and !workRptS.equals('')">
     	           AND T.WORK_RPT_S = #{workRptS}
              </if>			  			  

		         ORDER BY T.CO_CD, T.WORK_RPT_NO DESC, T.FILE_TRGT_KEY
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>


  <select id="selectDailyWorkInfo" resultType="CamelMap">
		SELECT
					T.FILE_TRGT_KEY,
					T.CO_CD,
					T.WORK_RPT_NO,
					T.WORK_RPT_ID,
					(SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS WORK_RPT_ID_NM,
					TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WORK_RPT_DT,
					T.WORK_RPT_L,
					T.WORK_RPT_M,
					T.WORK_RPT_S,
					T.WORK_RPT_HOUR,
					T.SALES_CD,
					T.WORK_RPT_RMK,
					T.ETC_FIELD1,
					T.ETC_FIELD2,
					T.ETC_FIELD3,
					T.WORK_RPT_RMK,
					T.ETC_FIELD1,
					T.ETC_FIELD2,
					T.ETC_FIELD3,
					T.CREAT_ID,
					A.CLNT_CD,
					A.CLNT_NM,
					A.CLNT_PJT,
					A.PRDT_CD,
					A.PRDT_CD_NM,
					A.ITEM_DIV,
					A.ITEM_DIV_NM,
					A.EQP_NM
		FROM TB_PM01M01 T
				LEFT OUTER JOIN
				(  SELECT  T1.CO_CD
					     , T2.SALES_CD
					     , T2.PRDT_CD
					     , (SELECT X.PRDT_NM FROM TB_BM01M01 X WHERE X.PRDT_CD = T2.PRDT_CD) AS PRDT_CD_NM
					     , T2.ITEM_DIV
					     , FN_CM05M01_CD_TO_NM(T2.ITEM_DIV) AS ITEM_DIV_NM
					     , T1.CLNT_PJT
					     , T2.EQP_NM
					     , T3.CLNT_CD
					     , T3.CLNT_NM
					 FROM TB_CR02M01 AS T1
					 JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
					 LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
      			) A
      			ON T.CO_CD = A.CO_CD AND T.SALES_CD = A.SALES_CD
       WHERE T.FILE_TRGT_KEY = #{fileTrgtKey}
  </select>

  <select id="selectConfirmCount" parameterType="Map" resultType="int">
    SELECT COUNT(FILE_TRGT_KEY) CNT
      FROM TB_PM01M01
     WHERE FILE_TRGT_KEY = #{fileTrgtKey}
  </select>
  
<update id="updateDailyWork" parameterType="Map">
    UPDATE TB_PM01M01
		SET
			CO_CD					= #{coCd},
			WORK_RPT_NO 			= #{workRptNo},
			WORK_RPT_ID				= #{workRptId},
			WORK_RPT_DT				= #{workRptDt},
			WORK_RPT_L				= #{workRptL},
			WORK_RPT_M				= #{workRptM},
			WORK_RPT_S				= #{workRptS},
			WORK_RPT_HOUR			= #{workRptHour},
			SALES_CD				= #{salesCd},
			WORK_RPT_RMK			= #{workRptRmk},
			ETC_FIELD1				= #{etcField1, jdbcType=VARCHAR},
			ETC_FIELD2				= #{etcField2, jdbcType=VARCHAR},
			ETC_FIELD3				= #{etcField3, jdbcType=VARCHAR},
			UDT_ID					= #{userId},
			UDT_PGM					= #{pgmId},
			UDT_DTTM				= SYSDATE
    WHERE FILE_TRGT_KEY             = #{fileTrgtKey}

  </update>
  
  <select id="selectDailyWorkSeqNext" parameterType="Map" resultType="int">
		SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_PM01M01_SQ01.NEXTVAL,3,0) FROM DUAL
  </select>
  
<insert id="insertDailyWork" parameterType="Map">
    <selectKey keyProperty="workRptNo" resultType="String" order="BEFORE">
      SELECT 'DM' || TO_CHAR(SYSDATE, 'YYYYMMDD')||'-'||LPAD(TB_PM01M01_SQ02.NEXTVAL,4,0) FROM DUAL
    </selectKey>
    INSERT INTO TB_PM01M01
      (
		FILE_TRGT_KEY,
		CO_CD,
		WORK_RPT_NO,
		WORK_RPT_ID,
		WORK_RPT_DT,
		WORK_RPT_L,
		WORK_RPT_M,
		WORK_RPT_S,
		WORK_RPT_HOUR,
		SALES_CD,
		WORK_RPT_RMK,
		ETC_FIELD1,
		ETC_FIELD2,
		ETC_FIELD3,
		CREAT_ID,
		CREAT_PGM,
		CREAT_DTTM
      )
    VALUES
    (
		#{fileTrgtKey},
		#{coCd},
		#{workRptNo},
		#{workRptId},
		#{workRptDt},
		#{workRptL},
		#{workRptM},
		#{workRptS},
		#{workRptHour},
		#{salesCd},
		#{workRptRmk},
		#{etcField1, jdbcType=VARCHAR},
		#{etcField2, jdbcType=VARCHAR},
		#{etcField3, jdbcType=VARCHAR},
		#{userId},
		#{pgmId},
		SYSDATE
    )
  </insert>
  
  <delete id="deleteDailyWork" parameterType="Map">
    DELETE TB_PM01M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
  </delete>
  
</mapper>