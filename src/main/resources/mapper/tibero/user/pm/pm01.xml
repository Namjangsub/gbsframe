<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.pm.pm01.mapper.PM01Mapper">

	<select id="selectDailyWorkCount" parameterType="Map" resultType="int">
		SELECT
            COUNT(*)
            FROM TB_PM01M01 T
				LEFT OUTER JOIN
				( SELECT CODE_ID AS WORK_RPT_L, CODE_NM AS WORK_RPT_L_NM
					FROM
						TB_CM05M01
					WHERE USE_YN = 'Y'
					  AND LEVEL = 2
					START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
					CONNECT BY PRIOR CODE_ID = CODE_KIND
				) A
				ON T.WORK_RPT_L = A.WORK_RPT_L
				LEFT OUTER JOIN
				( SELECT CODE_ID AS WORK_RPT_M, CODE_NM AS WORK_RPT_M_NM
					FROM
						TB_CM05M01
					WHERE USE_YN = 'Y'
					  AND LEVEL = 3
					START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
					CONNECT BY PRIOR CODE_ID = CODE_KIND
				) B
				ON T.WORK_RPT_M = B.WORK_RPT_M
				LEFT OUTER JOIN
				( SELECT CODE_ID AS WORK_RPT_S, CODE_NM AS WORK_RPT_S_NM
					FROM
						TB_CM05M01
					WHERE USE_YN = 'Y'
					  AND LEVEL = 4
					START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
					CONNECT BY PRIOR CODE_ID = CODE_KIND
      			) C 
      			ON T.WORK_RPT_S = C.WORK_RPT_S
				LEFT OUTER JOIN
				(  SELECT  T1.CO_CD
					     , T2.SALES_CD 			--Sales Code
					     , T2.PRDT_CD			--제품구분
					     , T2.ITEM_DIV			--아이템구분
					     , T1.CLNT_PJT			--고객사PJT
					     , T2.EQP_NM			--설비명
					     , T3.CLNT_NM			--고객사
					 FROM TB_CR02M01 AS T1
					 JOIN TB_CR02D02 AS T2 ON T1.CO_CD = T2.CO_CD AND T1.ORDRS_NO = T2.ORDRS_NO
					 LEFT JOIN TB_BM02M01 AS T3 ON T3.CLNT_CD = T1.ORDRS_CLNT_CD
      			) D 
      			ON T.CO_CD = D.CO_CD AND T.SALES_CD = D.SALES_CD
		        WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
              <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.WORK_RPT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="creatId !=null and !creatId.equals('')">
     	           AND T.CREAT_ID = #{creatId}
              </if>			  			  
              <if test="salesCd != null and !salesCd.equals('')">
     	           AND T.SALES_CD = #{salesCd}
              </if>
              <if test="prdtCd != null and !prdtCd.equals('')">
     	           AND D.PRDT_CD = #{prdtCd}
              </if>
              <if test="itemDiv != null and !itemDiv.equals('')">
     	           AND D.ITEM_DIV = #{itemDiv}
              </if>
              <if test="workRptL != null and !workRptL.equals('')">
     	           AND A.WORK_RPT_L = #{workRptL}
              </if>
              <if test="workRptM != null and !workRptM.equals('')">
     	           AND B.WORK_RPT_M = #{workRptM}
              </if>
              <if test="workRptS !=null and !workRptS.equals('')">
     	           AND C.WORK_RPT_S_NM LIKE '%${workRptSNm}%'
              </if>			  			  

	</select>

	<select id="selectDailyWorkList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
				SELECT 		  T.FILE_TRGT_KEY
							, T.CO_CD
							, T.WORK_RPT_NO
							, T.WORK_RPT_ID
							, (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS WORK_RPT_NM
							, TO_CHAR(T.WORK_RPT_DT,'YYYY-MM-DD') AS WORK_RPT_DT
							, T.WORK_RPT_L
							, T.WORK_RPT_M
							, T.WORK_RPT_S
							, A.CODE_NM AS WORK_RPT_L_NM
							, B.CODE_NM AS WORK_RPT_M_NM
							, C.CODE_NM AS WORK_RPT_S_NM
							, T.WORK_RPT_HOUR
							, T.SALES_CD
							, T.WORK_RPT_RMK
							, T.ETC_FIELD1
							, T.ETC_FIELD2
							, T.ETC_FIELD3
							, T.CREAT_ID
							, (SELECT NAME FROM TB_CM06M01 WHERE ID = T.CREAT_ID) AS CREAT_NM
							, TO_CHAR(T.CREAT_DTTM,'YYYY-MM-DD') AS CREAT_DTTM
							, T.UDT_ID
							, (SELECT NAME FROM TB_CM06M01 WHERE ID = T.UDT_ID) AS UDT_NM
							, TO_CHAR(T.UDT_DTTM,'YYYY-MM-DD') AS UDT_DTTM
				  FROM TB_PM01M01 T
           						LEFT OUTER JOIN
           						( SELECT CODE_ID, CODE_NM
									FROM
										TB_CM05M01
									WHERE USE_YN = 'Y'
									  AND LEVEL = 2
									START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
									CONNECT BY PRIOR CODE_ID = CODE_KIND
           						) A
           						ON T.WORK_RPT_L = A.CODE_ID
           						LEFT OUTER JOIN
           						( SELECT CODE_ID, CODE_NM
									FROM
										TB_CM05M01
									WHERE USE_YN = 'Y'
									  AND LEVEL = 3
									START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
									CONNECT BY PRIOR CODE_ID = CODE_KIND
           						) B 
           						ON T.WORK_RPT_M = B.CODE_ID
           						LEFT OUTER JOIN
           						( SELECT CODE_ID, CODE_NM
									FROM
										TB_CM05M01
									WHERE USE_YN = 'Y'
									  AND LEVEL = 4
									START WITH CODE_ID = 'WORKRPT' AND USE_YN = 'Y'
									CONNECT BY PRIOR CODE_ID = CODE_KIND
           						) C 
           						ON T.WORK_RPT_S = C.CODE_ID
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
              <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.WORK_RPT_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
              <if test="creatId !=null and !creatId.equals('')">
     	           AND T.CREAT_ID = #{creatId}
              </if>			  			  
              <if test="salesCd != null and !salesCd.equals('')">
     	           AND T.SALES_CD = #{salesCd}
              </if>
              <if test="prdtCd != null and !prdtCd.equals('')">
     	           AND D.PRDT_CD = #{prdtCd}
              </if>
              <if test="itemDiv != null and !itemDiv.equals('')">
     	           AND D.ITEM_DIV = #{itemDiv}
              </if>
              <if test="workRptL != null and !workRptL.equals('')">
     	           AND A.WORK_RPT_L = #{workRptL}
              </if>
              <if test="workRptM != null and !workRptM.equals('')">
     	           AND B.WORK_RPT_M = #{workRptM}
              </if>
              <if test="workRptS !=null and !workRptS.equals('')">
     	           AND C.WORK_RPT_S_NM LIKE '%${workRptSNm}%'
              </if>			  			  

		         ORDER BY T.CO_CD, T.FILE_TRGT_KEY
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>

  <resultMap id="resultInfoMap" type="CamelMap">
    <collection select="selectPrdtList" property="PRDT_LIST" column="{prjctSeq=PRJCT_SEQ}" ofType="CamelMap"/>
<!--     <collection select="selectFileList" property="FILE_LIST" column="{fileTrgtKey=PRJCT_SEQ}" ofType="CamelMap"/> -->
  </resultMap>


  <select id="selectDailyWorkInfo" resultMap="resultInfoMap">
              SELECT PRJCT_SEQ
					 , T.CO_CD
                     , T.INPEXP_CD
                     , FN_CM05M01_CD_TO_NM(T.INPEXP_CD) INPEXP_NM
					 , T.NEW_PRDT_CD
                     , FN_CM05M01_CD_TO_NM(T.NEW_PRDT_CD) NEW_PRDT_NM
					 , T.CLNT_CD
					 , A.CLNT_NM
					 , T.CLNT_MNG_NM
					 , T.PRJCT_NM
					 , T.EQP_NM
					 , T.EQP_QTY
					 , T.ODR_CD
					 , T.ODR_RMK
					 , T.EPCT_AMT
					 , T.ORDRS_PLAN_AMT
					 , T.WINBD_RMK
					 , TO_CHAR(T.ORDRS_PLAN_DT, 'YYYY-MM-DD') AS ORDRS_PLAN_DT
					 , T.ORDRS_AMT
					 , T.WINBD_CD
					 , TO_CHAR(T.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT
					 , TO_CHAR(T.DUDT_PLAN_DT, 'YYYY-MM-DD') AS DUDT_PLAN_DT
					 , T.MNG_ID
					 , B.NAME as MNG_NM
					 , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
					 , SUBSTR(T.YYYYMM,1,4) || '-' || SUBSTR(T.YYYYMM,5,2) AS YYYYMM
					 , T.PRJCT_CD
					 , T.PRJCT_RMK
					 , T.CREAT_ID
					 , T.CREAT_PGM
					 , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM
					 , T.UDT_ID
					 , T.UDT_PGM
					 , TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM
           			 , ORDRS_PCT
        FROM TB_BM06M01 T 
             LEFT OUTER JOIN TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
             LEFT OUTER JOIN TB_CM06M01 B ON T.MNG_ID = B.ID
       WHERE PRJCT_SEQ = #{prjctSeq}
  </select>

  <select id="selectItemList" resultType="CamelMap">
	SELECT nvl2(b.PRJCT_PRDT_CD,'Y','N') IS_CHK
        , PRJCT_SEQ
        , nvl(PRJCT_PRDT_CD,#{prjctPrdtCd}) PRJCT_PRDT_CD
        , PRJCT_ITEM_CD
        , nvl(PRJCT_PRDT_NEW_CD,#{prjctPrdtNewCd}) PRJCT_PRDT_NEW_CD
        , PRJCT_ITEM_RMK
        , CODE_ID
        , CODE_NM
        , CODE_ETC
      FROM 
      		(SELECT *
               FROM TB_CM05M01
              WHERE CODE_KIND = 'ITEMLIST'
                AND USE_YN    = 'Y'
             ) a LEFT OUTER join
	            (SELECT *
	               FROM TB_BM06D02
	              WHERE PRJCT_SEQ = #{prjctSeq}
	                AND PRJCT_PRDT_CD = #{prjctPrdtCd}
	                AND PRJCT_PRDT_NEW_CD = #{prjctPrdtNewCd}
	             ) b
         		ON a. CODE_ID = b.PRJCT_ITEM_CD
   ORDER BY IS_CHK DESC
  </select>

  <select id="selectPrdtList" resultType="CamelMap">
   SELECT 
          a.PRJCT_SEQ
        , a.PRJCT_PRDT_CD
        , b.PRDT_NM        
        , a.PRJCT_PRDT_QTY
        , a.PRJCT_INPEXP_CD
        , FN_CM05M01_CD_TO_NM(a.PRJCT_INPEXP_CD) PRJCT_INPEXP_NM
        , a.PRJCT_PRDT_NEW_CD
        , FN_CM05M01_CD_TO_NM(a.PRJCT_PRDT_NEW_CD) PRJCT_PRDT_NEW_NM 
        , TO_CHAR(a.PRJCT_PRDT_ORDRS_DT, 'YYYY-MM-DD') AS PRJCT_PRDT_ORDRS_DT
        , TO_CHAR(a.PRJCT_PRDT_PLAN_DT, 'YYYY-MM-DD') AS PRJCT_PRDT_PLAN_DT
        , a.PRJCT_PRDT_RMK
     FROM TB_BM06D01 a LEFT OUTER JOIN TB_BM01M01 b 
                                               ON a.PRJCT_PRDT_CD = b.PRDT_CD
    WHERE a.PRJCT_SEQ = #{prjctSeq}

  </select>

  <select id="selectConfirmCount" parameterType="Map" resultType="int">
    SELECT COUNT(PRJCT_SEQ) CNT
      FROM TB_BM06M01
     WHERE PRJCT_SEQ = #{fileTrgtKey}
  </select>
  
  <select id="selectFileList" resultType="CamelMap">
    SELECT *
      FROM TB_CM08M01
     WHERE FILE_TRGT_TYP = 'TB_BM06M01'
       AND FILE_TRGT_KEY = #{fileTrgtKey}
  </select>

<update id="updateDailyWork" parameterType="Map">
    UPDATE TB_PM01M01
       SET
          CO_CD = #{coCd}
		, WORK_RPT_NO = #{workRptNo}
		, WORK_RPT_ID = #{workRptId}
		, WORK_RPT_DT = #{workRptDt}
		, WORK_RPT_L = #{workRptL}
		, WORK_RPT_M = #{workRptM}
		, WORK_RPT_S = #{workRptS}
		, WORK_RPT_HOUR = #{workRptHour}
		, SALES_CD = #{salesCd}
		, WORK_RPT_RMK = #{workRptRmk}
		, ETC_FIELD1 = #{etcField1}
		, ETC_FIELD2 = #{etcField2}
		, ETC_FIELD3 = #{etcField3}
		, UDT_ID = #{udtId}
		, UDT_PGM = #{udtPgm}
    WHERE FILE_TRGT_KEY = #{fileTrgtKey}


  </update>
  
  <select id="selectDailyWorkSeqNext" parameterType="Map" resultType="int">
		SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_BM06M01_SQ01.NEXTVAL,3,0) FROM DUAL
  </select>
  
<insert id="insertDailyWork" parameterType="Map">
<!--     <selectKey keyProperty="prjctSeq" resultType="String" order="BEFORE"> -->
<!--       SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_BM06M01_SQ01.NEXTVAL,3,0) FROM DUAL -->
<!--     </selectKey> -->
    INSERT INTO TB_PM01M01
      (
          FILE_TRGT_KEY
		, CO_CD
		, WORK_RPT_NO
		, WORK_RPT_ID
		, WORK_RPT_DT
		, WORK_RPT_L
		, WORK_RPT_M
		, WORK_RPT_S
		, WORK_RPT_HOUR
		, SALES_CD
		, WORK_RPT_RMK
		, ETC_FIELD1
		, ETC_FIELD2
		, ETC_FIELD3
		, CREAT_ID
		, CREAT_PGM
		, CREAT_DTTM
		, UDT_ID
		, UDT_PGM
		, UDT_DTTM
      )
    VALUES
    (
		  #{prjctSeq}
		, #{coCd}
		, #{fileTrgtKey}
		, #{coCd}
		, #{workRptNo}
		, #{workRptId}
		, #{workRptDt}
		, #{workRptL}
		, #{workRptM}
		, #{workRptS}
		, #{workRptHour}
		, #{salesCd}
		, #{workRptRmk}
		, #{etcField1}
		, #{etcField2}
		, #{etcField3}
		, #{creatId}
		, #{creatPgm}
		, SYSDATE
		, #{udtId}
		, #{udtPgm}
		, SYSDATE
    )
  </insert>
  
  <insert id="insertDailyWorkPrdt" parameterType="Map">
    INSERT INTO TB_BM06D01
    (
           PRJCT_SEQ
         , PRJCT_PRDT_CD
         , PRJCT_PRDT_QTY
         , PRJCT_INPEXP_CD
         , PRJCT_PRDT_NEW_CD
         , PRJCT_PRDT_ORDRS_DT
         , PRJCT_PRDT_PLAN_DT
         , PRJCT_PRDT_RMK
      )
    VALUES
    (
           #{prjctSeq}
         , #{prjctPrdtCd}
         , #{prjctPrdtQty}
         , #{prjctInpexpCd}
         , #{prjctPrdtNewCd}
         , #{prjctPrdtOrdrsDt}
         , #{prjctPrdtPlanDt}
         , #{prjctPrdtRmk, jdbcType=VARCHAR}      
    )
  </insert>
  
  <insert id="insertDailyWorkDtl" parameterType="Map">

    INSERT INTO TB_BM06D02
    (
           PRJCT_SEQ
         , PRJCT_PRDT_CD
         , PRJCT_ITEM_CD
         , PRJCT_PRDT_NEW_CD
         , PRJCT_ITEM_RMK
      )
    VALUES
    (
	        #{prjctSeq}
	      , #{prjctPrdtCd}
	      , #{prjctItemCd}
	      , #{prjctPrdtNewCd}
	      , #{prjctItemRmk, jdbcType=VARCHAR}
    )
  </insert>
  
  <update id="updateDailyWorkPrdt" parameterType="Map">
    UPDATE TB_BM06D01
       SET
           PRJCT_PRDT_QTY		= #{prjctPrdtQty}
         , PRJCT_INPEXP_CD		= #{prjctInpexpCd}
         , PRJCT_PRDT_ORDRS_DT	= #{prjctPrdtOrdrsDt}
         , PRJCT_PRDT_PLAN_DT	= #{prjctPrdtPlanDt}
         , PRJCT_PRDT_RMK		= #{prjctPrdtRmk, jdbcType=VARCHAR}
     WHERE PRJCT_SEQ           = #{prjctSeq}
           AND PRJCT_PRDT_CD   = #{prjctPrdtCd}
           AND PRJCT_PRDT_NEW_CD= #{prjctPrdtNewCd}
  </update>

  <update id="updateDailyWorkDtl" parameterType="Map">
    UPDATE TB_BM06D02
       SET
           PRJCT_ITEM_RMK  = #{prjctItemRmk, jdbcType=VARCHAR}
     WHERE PRJCT_SEQ       = #{prjctSeq}
       AND PRJCT_PRDT_CD   = #{prjctPrdtCd}
       AND PRJCT_ITEM_CD   = #{prjctItemCd}
       AND PRJCT_PRDT_NEW_CD= #{prjctPrdtNewCd}
  </update>


  <delete id="deleteDailyWork" parameterType="Map">
    DELETE TB_PM01M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
  </delete>
  
  <delete id="deleteDailyWorkPrdtSeqAll" parameterType="Map">
    DELETE TB_BM06D01 WHERE PRJCT_SEQ = #{prjctSeq}
  </delete>
  
  <delete id="deleteDailyWorkDtlSeqAll" parameterType="Map">
    DELETE TB_BM06D02 WHERE PRJCT_SEQ = #{prjctSeq}
  </delete>
  
  
  <delete id="deleteDailyWorkPrdt" parameterType="Map">
    DELETE TB_BM06D01
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd}
       AND PRJCT_PRDT_NEW_CD= #{prjctPrdtNewCd}
  </delete>
  
  <delete id="deleteDailyWorkDtlPrdtAll" parameterType="Map">
    DELETE TB_BM06D02
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd}
       AND PRJCT_PRDT_NEW_CD= #{prjctPrdtNewCd}
  </delete>

  <delete id="deleteDailyWorkDtl" parameterType="Map">
    DELETE TB_BM06D02
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd}
       AND PRJCT_ITEM_CD = #{prjctItemCd}
       AND PRJCT_PRDT_NEW_CD= #{prjctPrdtNewCd}
  </delete>
  
</mapper>