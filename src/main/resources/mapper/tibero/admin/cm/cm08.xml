<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dksys.biz.admin.cm.cm08.mapper.CM08Mapper">
    <insert id="insertFile">
        <selectKey keyProperty="fileKey" resultType="String" order="BEFORE">
            SELECT TB_CM08M01_SQ01.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TB_CM08M01 (
            FILE_KEY,
            FILE_SIZE,
            FILE_TYPE,
            FILE_NAME,
            FILE_PATH,
            FILE_TRGT_TYP,
            FILE_TRGT_KEY,
            USE_YN,
            CREAT_ID,
            CREAT_PGM,
            CREAT_DTTM,
            CLNT_CD,
            PRDT_CD,
            ITEM_CD,
            SALES_CD,
            PRJCT_CD,
            CO_CD,
            COMON_CD,
            ORDRS_NO
        ) VALUES(
			#{fileKey},
			#{fileSize},
			#{fileType},
			#{fileName},
			#{filePath},
			#{fileTrgtTyp},
			#{fileTrgtKey},
			'Y',
			#{userId},
			#{pgmId},
			SYSDATE,
            #{clntCd, jdbcType=VARCHAR},
            #{prdtCd, jdbcType=VARCHAR},
            #{itemCd, jdbcType=VARCHAR},
            #{salesCd, jdbcType=VARCHAR},
            #{prjctCd, jdbcType=VARCHAR},
            #{coCd, jdbcType=VARCHAR},
            #{comonCd, jdbcType=VARCHAR},
            #{ordrsNo, jdbcType=VARCHAR}
        )
    </insert>

    <select id="selectFileList" parameterType="Map" resultType="CamelMap">
        SELECT *
        FROM TB_CM08M01 T
	            INNER JOIN  TB_CM15M01 G ON T.COMON_CD  = G.COMON_CD
		            				    AND G.CO_CD     = #{coCd}
       							   		AND G.FILE_LIST = 'Y'         
        WHERE FILE_TRGT_TYP = #{fileTrgtTyp}
          AND FILE_TRGT_KEY = #{fileTrgtKey}
       	  AND G.USER_ID = #{userId}
    </select>

    <select id="selectFileListAll" parameterType="Map" resultType="CamelMap">
        SELECT *
        FROM TB_CM08M01 T
        WHERE FILE_TRGT_TYP = #{fileTrgtTyp}
          AND FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

    <select id="selectFileInfo" parameterType="Map" resultType="CamelMap">
        SELECT *
        FROM TB_CM08M01
        WHERE FILE_KEY = #{fileKey}
    </select>

    <delete id="deleteFile" parameterType="Map">
        DELETE
        FROM TB_CM08M01
        WHERE FILE_KEY = #{fileKey}
    </delete>

    <select id="selectTreeFileCount" parameterType="Map" resultType="int">
        SELECT
        	COUNT(*)
		    FROM
		        TB_CM08M01 T left outer join TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
					            LEFT OUTER JOIN (
											        SELECT  CODE_ID ID,
											                CODE_NM TEXT,
											                CODE_KIND PARENT,
											                CODE_DESC PARENT_NM,
											                SORT_NO,
											                USE_YN,
											                LPAD(' ', 3*(LEVEL-1)) || LEVEL lvl,
											                REGEXP_REPLACE(SYS_CONNECT_BY_PATH(CODE_NM, '\'), '^\s+\-\>\s+', '') as LPATH,
											                CONNECT_BY_ISLEAF AS IS_LEAF
											        FROM TB_CM05M01
											        START WITH CODE_ID ='FILETREE'
											        CONNECT BY PRIOR CODE_ID = CODE_KIND
											        ORDER SIBLINGS BY CODE_ID ASC) B1 ON T.COMON_CD = B1.ID
		            LEFT OUTER JOIN TB_CM06M01 D ON T.CREAT_ID = D.ID
		            LEFT OUTER JOIN TB_BM01M01 E ON T.PRDT_CD = E.PRDT_CD
		            LEFT OUTER JOIN TB_CM05M01 F ON T.ITEM_CD = F.CODE_ID
		            LEFT OUTER JOIN TB_CM15M01 G ON T.COMON_CD = G.COMON_CD
		        								AND G.CO_CD   = T.CO_CD
        								        AND G.USER_ID = #{userId}
		        WHERE 1=1
		        <if test="coCd != null and !coCd.equals('')">
		            AND T.CO_CD = #{coCd}
		        </if>
		        <if test="comonCd.equals('FITR90')">	        
		        	AND (T.COMON_CD IS NULL OR T.COMON_CD = '' OR B1.ID IS NULL) --저장위치 없는 파일
		        </if>
		        <if test="!comonCd.equals('FITR90')">	        
					AND G.FILE_LIST = 'Y'
		        	AND T.COMON_CD IN (
								SELECT  CODE_ID ID
								  FROM TB_CM05M01
									START WITH CODE_ID = #{comonCd}
									CONNECT BY PRIOR CODE_ID = CODE_KIND		            
		  						) 
		        </if>		  						
		        <if test="fileTrgtKey != null and !fileTrgtKey.equals('')">
		            AND T.FILE_TRGT_KEY= #{fileTrgtKey}  --파일타겟 키값이 있으면 반드시 파일타겟 타입이 있어야 함
		            AND T.FILE_TRGT_TYP= #{fileTrgtTyp}
		        </if>
		        <if test="creatId != null and !creatId.equals('')">
		            AND T.CREAT_ID= #{creatId}
		        </if>
		        <if test="creatNm != null and !creatNm.equals('')">
		            AND D.NAME LIKE '%' || #{creatNm} || '%'
		        </if>
		        <if test="reqDtFrom != null and !reqDtFrom.equals('') and reqDtTo != null and !reqDtTo.equals('')">
		            AND T.CREAT_DTTM BETWEEN to_date(REPLACE(#{reqDtFrom},'-','')) AND to_date(REPLACE(#{reqDtTo},'-',''))+1
		        </if>
		        <if test="searchValue != null and !searchValue.equals('') and searchName != null and !searchName.equals('')">
		            AND ${searchValue} LIKE '%' || #{searchName} || '%'
		        </if>
		        <if test="clntCd != null and !clntCd.equals('')">
		            AND T.CLNT_CD = #{clntCd}
		        </if>
		        <if test="clntNm != null and !clntNm.equals('')">
		            AND A.CLNT_NM LIKE '%' || #{clntNm} || '%'
		        </if>
		        <if test="prdtCd != null and !prdtCd.equals('')">
		            AND T.PRDT_CD = #{prdtCd}
		        </if>
		        <if test="prdtNm != null and !prdtNm.equals('')">
		            AND E.PRDT_NM LIKE '%' || #{prdtNm} || '%'
		        </if>
		        <if test="prjctCd != null and !prjctCd.equals('')">
		            AND T.PRJCT_CD LIKE #{prjctCd}
		        </if>
		        <if test="salesCd != null and !salesCd.equals('')">
		            AND T.SALES_CD LIKE '%' || #{salesCd} || '%'
		        </if>
		        <if test="fileType != null and !fileType.equals('')">
		            AND T.FILE_TRGT_TYP = #{fileType}
		        </if>
		        <if test="fileName != null and !fileName.equals('')">
		            AND T.FILE_NAME LIKE '%' || #{fileName} || '%'
		        </if>
		        <if test="ordrsNo != null and !ordrsNo.equals('')">
		            AND T.ORDRS_NO LIKE '%' || #{ordrsNo} || '%'
		        </if>
    </select>

    <select id="selectTreeFileList" parameterType="Map" resultType="CamelMap">
		SELECT *
		  FROM (     
	        SELECT
	        	ROWNUM AS RNUM, A.*
	        FROM
		        (
		        SELECT
		            T.CO_CD,
		            T.FILE_KEY,
		            T.FILE_SIZE,
		            T.FILE_TYPE,
		            T.FILE_NAME,
		            T.FILE_PATH,
		            T.FILE_TRGT_TYP,
		            F2.CODE_NM 											AS FILE_TRGT_TYP_NM,
		            T.FILE_TRGT_KEY,
		            T.USE_YN,
		            T.CREAT_ID,
		            D.NAME CREAT_NM,
		            T.CREAT_PGM,
		            TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') 		AS CREAT_DTTM,
		            T.CLNT_CD,
		            A.CLNT_NM,
		            T.PRDT_CD,
		            E.PRDT_NM,
		            T.ITEM_CD,
		            F.CODE_NM 											AS ITEM_NM,
		            T.SALES_CD,
		            T.PRJCT_CD,
		            FN_CM05M01_CD_TO_NM(T.PRJCT_CD) 					AS PRJCT_NM,
		            T.COMON_CD,
		            B1.TEXT 											AS COMON_NM,
		            NVL(B1.LPATH, NVL2(T.COMON_CD, T.COMON_CD, 'null')) AS LPATH,
		            G.FILE_UP,
		            G.FILE_DOWN,
		            G.FILE_UPDATE,
		            G.FILE_DELETE,
		            T.ORDRS_NO
		    FROM
		        TB_CM08M01 T left outer join TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
					            LEFT OUTER JOIN (
											        SELECT  CODE_ID ID,
											                CODE_NM TEXT,
											                CODE_KIND PARENT,
											                CODE_DESC PARENT_NM,
											                SORT_NO,
											                USE_YN,
											                LPAD(' ', 3*(LEVEL-1)) || LEVEL lvl,
											                REGEXP_REPLACE(SYS_CONNECT_BY_PATH(CODE_NM, '\'), '^\s+\-\>\s+', '') as LPATH,
											                CONNECT_BY_ISLEAF AS IS_LEAF
											        FROM TB_CM05M01
											        START WITH CODE_ID ='FILETREE'
											        CONNECT BY PRIOR CODE_ID = CODE_KIND
											        ORDER SIBLINGS BY CODE_ID ASC) B1 ON T.COMON_CD = B1.ID
		            LEFT OUTER JOIN TB_CM06M01 D ON T.CREAT_ID = D.ID
		            LEFT OUTER JOIN TB_BM01M01 E ON T.PRDT_CD = E.PRDT_CD
		            LEFT OUTER JOIN TB_CM05M01 F ON T.ITEM_CD = F.CODE_ID
		            LEFT OUTER JOIN TB_CM05M01 F2 ON F2.CODE_KIND = 'DRPDIV' AND  F2.CODE_RPRC = T.FILE_TRGT_TYP
		            LEFT OUTER JOIN TB_CM15M01 G ON T.COMON_CD = G.COMON_CD
		        								AND G.CO_CD   = T.CO_CD
        								        AND G.USER_ID = #{userId}
		        WHERE 1=1
		        <if test="coCd != null and !coCd.equals('')">
		            AND T.CO_CD = #{coCd}
		        </if>
		        <if test="comonCd.equals('FITR90')">	        
		        	AND (T.COMON_CD IS NULL OR T.COMON_CD = '' OR B1.ID IS NULL) --저장위치 없는 파일
		        </if>
		        <if test="!comonCd.equals('FITR90')">	        
					AND G.FILE_LIST = 'Y'
		        	AND T.COMON_CD IN (
								SELECT  CODE_ID ID
								  FROM TB_CM05M01
									START WITH CODE_ID = #{comonCd}
									CONNECT BY PRIOR CODE_ID = CODE_KIND		            
		  						) 
		        </if>		  						
		        <if test="fileTrgtKey != null and !fileTrgtKey.equals('')">
		            AND T.FILE_TRGT_KEY= #{fileTrgtKey}  --파일타겟 키값이 있으면 반드시 파일타겟 타입이 있어야 함
		            AND T.FILE_TRGT_TYP= #{fileTrgtTyp}
		        </if>
		        <if test="creatId != null and !creatId.equals('')">
		            AND T.CREAT_ID= #{creatId}
		        </if>
		        <if test="creatNm != null and !creatNm.equals('')">
		            AND D.NAME LIKE '%' || #{creatNm} || '%'
		        </if>
		        <if test="reqDtFrom != null and !reqDtFrom.equals('') and reqDtTo != null and !reqDtTo.equals('')">
		            AND T.CREAT_DTTM BETWEEN to_date(REPLACE(#{reqDtFrom},'-','')) AND to_date(REPLACE(#{reqDtTo},'-',''))+1
		        </if>
		        <if test="searchValue != null and !searchValue.equals('') and searchName != null and !searchName.equals('')">
		            AND ${searchValue} LIKE '%' || #{searchName} || '%'
		        </if>
		        <if test="clntCd != null and !clntCd.equals('')">
		            AND T.CLNT_CD = #{clntCd}
		        </if>
		        <if test="clntNm != null and !clntNm.equals('')">
		            AND A.CLNT_NM LIKE '%' || #{clntNm} || '%'
		        </if>
		        <if test="prdtCd != null and !prdtCd.equals('')">
		            AND T.PRDT_CD = #{prdtCd}
		        </if>
		        <if test="prdtNm != null and !prdtNm.equals('')">
		            AND E.PRDT_NM LIKE '%' || #{prdtNm} || '%'
		        </if>
		        <if test="prjctCd != null and !prjctCd.equals('')">
		            AND T.PRJCT_CD LIKE #{prjctCd}
		        </if>
		        <if test="salesCd != null and !salesCd.equals('')">
		            AND T.SALES_CD LIKE '%' || #{salesCd} || '%'
		        </if>
		        <if test="fileType != null and !fileType.equals('')">
		            AND T.FILE_TRGT_TYP = #{fileType}
		        </if>
		        <if test="fileName != null and !fileName.equals('')">
		            AND T.FILE_NAME LIKE '%' || #{fileName} || '%'
		        </if>
		        <if test="ordrsNo != null and !ordrsNo.equals('')">
		            AND T.ORDRS_NO LIKE '%' || #{ordrsNo} || '%'
		        </if>
				ORDER BY T.CREAT_DTTM DESC
		        ) A
	    	)
        WHERE
              RNUM BETWEEN #{firstIndex} AND #{lastIndex}

    </select>


    <select id="selectConfirmCount" parameterType="Map" resultType="int">
        SELECT COUNT(*) CNT
        FROM TB_CM08M01 A
            LEFT INNER JOIN TB_CM15M01 B ON A.COMON_CD = B.COMON_CD
         								AND B.CO_CD    = #{coCd}
            							AND B.USER_ID  = #{userId, jdbcType=VARCHAR}
        WHERE FILE_KEY = #{fileKey}
    </select>

    <update id="moveFile">
        UPDATE
            TB_CM08M01
        SET COMON_CD = #{comonCd}
        WHERE FILE_KEY = #{fileKey}
    </update>

    <!-- 	디렉토리 접근권한 관리 (사용자별 접근권한 체크로 임의의 값이 오면 해당 폴더 권한이 있어야 조회됨 -->
    <select id="selectFileInfoUser" parameterType="Map" resultType="CamelMap">
        SELECT A.*
        FROM TB_CM08M01 A
        INNER JOIN TB_CM15M01 B ON A.COMON_CD = B.COMON_CD
	        					AND B.CO_CD   = #{coCd}
        						AND B.USER_ID = #{userId}
        <choose>
            <when test='jobType == "fileList"'>
                AND B.FILE_LIST = 'Y'
            </when>
            <when test='jobType == "fileUp"'>
                AND B.FILE_UP = 'Y'
            </when>
            <when test='jobType == "fileDown"'>
                AND B.FILE_DOWN = 'Y'
            </when>
            <when test='jobType == "fileUpdate"'>
                AND B.FILE_UPDATE = 'Y'
            </when>
            <when test='jobType == "fileDelete"'>
                AND B.FILE_DELETE = 'Y'
            </when>
            <otherwise>
                AND 1 = 0
            </otherwise>
        </choose>
        WHERE FILE_KEY = #{fileKey}
    </select>
    
    
    

	<!-- fileTrgtTyp 별로 서로 다른 경로로 M을 찾아옴 -->
	<select id="selectMByTarget" resultType="CamelMap">
	/* fileTrgtTyp = SALES_CD | ORDRS_NO | CLNT_PJT | CLNT_CD | CO_CD */
		<choose>
		<!-- 1. 물류진행요청 등록 -->
		<when test="fileTrgtTyp == 'CR1001P01'">
			SELECT M.CO_CD, M.ORDRS_NO, M.CLNT_PJT, D.SALES_CD, M.FILE_TRGT_KEY, M.LGIST_NO
			FROM TB_CR11M01 M 
					LEFT OUTER JOIN TB_CR11D01 D ON D.LGIST_NO = M.LGIST_NO
			WHERE M.FILE_TRGT_KEY = #{fileTrgtKey}
			ORDER BY SALES_CD
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!-- 2. PFU관리 -->
		<when test="fileTrgtTyp == 'CR5001P01'">
			SELECT FILE_TRGT_KEY, CO_CD, CLNT_CD, ORDRS_NO, SALES_CD, CLNT_PJT FROM TB_CR50M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!-- 3. 작업일보관리 -->
		<when test="fileTrgtTyp == 'PM0101M01'">
			SELECT ORD_CO_CD AS CO_CD, CLNT_CD, ORDRS_NO, SALES_CD, CLNT_PJT, PRDT_CD, ITEM_DIV, FILE_TRGT_KEY FROM TB_PM01M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
		
		<!-- 4. 작업일보관리 첨부파일 -->
		<when test="fileTrgtTyp == 'PM0101M01_M'">
			SELECT M.ORD_CO_CD AS CO_CD, M.CLNT_CD, M.ORDRS_NO, M.SALES_CD, M.CLNT_PJT, M.PRDT_CD, M.ITEM_DIV, M.FILE_TRGT_KEY
			  FROM TB_PM01D01 D
					LEFT OUTER JOIN TB_PM01M01 M ON M.WORK_RPT_NO = D.WORK_RPT_NO
			 WHERE D.WORK_RPT_NO =  SUBSTR(#{fileTrgtKey}, 1, INSTR(#{fileTrgtKey}, '-', -1) - 1) -- 'DM20240509-6575' 
			   AND D.WORK_RPT_NO_SEQ = SUBSTR(#{fileTrgtKey}, INSTR(#{fileTrgtKey}, '-', -1) + 1)  --'1'
			 FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!--5 출장자 사진 Upload작업 -->
		<when test="fileTrgtTyp == 'PM5001M01'">
			SELECT FILE_TRGT_KEY, CO_CD, SALES_CD FROM TB_PM50M01 WHERE FILE_TRGT_KEY = SUBSTR(#{fileTrgtKey}, 1, 9)
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!--6 출장자 사진 Upload작업 -->
		<when test="fileTrgtTyp == 'PM5001P01_M'">
			SELECT FILE_TRGT_KEY, CO_CD, SALES_CD FROM TB_PM50M01 WHERE FILE_TRGT_KEY = SUBSTR(#{fileTrgtKey}, 1, 9)
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!--7. 요인별 발주 및 출장요청 -->
		<when test="fileTrgtTyp == 'QM0101P01'">
			SELECT FILE_TRGT_KEY, CO_CD, SALES_CD FROM TB_QM01M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!--8. 요인별 발주 및 출장결과 -->
		<when test="fileTrgtTyp == 'QM0101P03'">
			SELECT FILE_TRGT_KEY, CO_CD, SALES_CD FROM TB_QM01M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!--9. 매입 발주 등록 -->
		<when test="fileTrgtTyp == 'SM0201P01'">
			SELECT CO_CD, SALES_CD, ORDRG_NO, PCHS_CLNT_CD AS CLNT_CD, REQ_NO FROM TB_SM02M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--10. 매입 입고 -->
		<when test="fileTrgtTyp == 'SM0301M01'">
			SELECT S.*, M.PCHS_CLNT_CD AS CLNT_CD
			FROM (
					SELECT  S.CO_CD, S.SALES_CD, S.IN_NO, S.REQ_NO,
					    (
					        SELECT MIN(D.ORDRG_NO)
					        FROM TB_SM03D01 D
					        WHERE D.IN_NO = S.IN_NO
					    ) AS ORDRG_NO
					FROM TB_SM03M01 S
					WHERE S.FILE_TRGT_KEY = #{fileTrgtKey}
				) S  LEFT OUTER JOIN TB_SM02M01 M ON M.ORDRG_NO = S.ORDRG_NO
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--10. 매입 입고 -->
		<when test="fileTrgtTyp == 'SM0301P01'">
			SELECT S.*, M.PCHS_CLNT_CD AS CLNT_CD
			FROM (
					SELECT  S.CO_CD, S.SALES_CD, S.IN_NO, S.REQ_NO,
					    (
					        SELECT MIN(D.ORDRG_NO)
					        FROM TB_SM03D01 D
					        WHERE D.IN_NO = S.IN_NO
					    ) AS ORDRG_NO
					FROM TB_SM03M01 S
					WHERE S.FILE_TRGT_KEY = #{fileTrgtKey}
				) S  LEFT OUTER JOIN TB_SM02M01 M ON M.ORDRG_NO = S.ORDRG_NO
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--11. 구매비용 -->
		<when test="fileTrgtTyp == 'SM1001P01'">
			SELECT CO_CD, PCHS_CLNT_CD AS CLNT_CD, COST_NO, SALES_CD, ORDRS_NO, REQ_NO FROM TB_SM10M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--12. 외주관리 -->
		<when test="fileTrgtTyp == 'SM1101P01'">
			SELECT M.CO_CD, M.CTRT_NO, M.CLNT_CD, M.ORDRS_NO, D.SALES_CD
			FROM TB_SM11M01 M
					LEFT OUTER JOIN TB_SM11D02 D ON D.CTRT_NO = M.CTRT_NO AND NVL(D.ORDRS_AMT, 0) != 0
			WHERE M.FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--13. 과제관리 -->
		<when test="fileTrgtTyp == 'WB2101M02'">
			SELECT  CO_CD, SJ_NO, SALES_CD FROM TB_WB21M01 WHERE SJ_NO = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--14. 과제관리 메뉴얼-->
		<when test="fileTrgtTyp == 'WB2101P01'">
			SELECT  CO_CD, SJ_NO, SALES_CD FROM TB_WB21M01 WHERE FILE_TRGT_KEY = SUBSTR(#{fileTrgtKey}, 1, INSTR(#{fileTrgtKey}, '-', 1, 1) - 1)
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!--14. 과제관리 첨부파일-->
		<when test="fileTrgtTyp == 'WB2101P02'">
			SELECT  CO_CD, SJ_NO, SALES_CD FROM TB_WB21M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--15. TASK 실적등록 -->
		<when test="fileTrgtTyp == 'WB2201P02'">
			SELECT CO_CD, SALES_CD, WBS_PLAN_CODE_KIND, FILE_TRGT_KEY FROM TB_WB23M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--16. WBS 계획 문제 -->
		<when test="fileTrgtTyp == 'WB2401P01'">
			SELECT CO_CD, SALES_CD, ISS_NO, WBS_PLAN_CODE_KIND, FILE_TRGT_KEY FROM TB_WB24M02 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--17. WBS 실적 문제 -->
		<when test="fileTrgtTyp == 'WB2401P11'">
			SELECT CO_CD, SALES_CD, ISS_NO, WBS_PLAN_CODE_KIND, FILE_TRGT_KEY  FROM TB_WB24M02 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
	
		<!--17. WBS 실적 문제 -->
		<when test="fileTrgtTyp == 'IM0101P01'">
			SELECT  CO_CD, IMPRVM_NO, SALES_CD FROM TB_IM01M01 WHERE IMPRVM_NO = #{fileTrgtKey}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!-- 예외 -->
		<otherwise>
			SELECT #{salesCd, jdbcType=VARCHAR} SALES_CD
			     , #{clntCd,  jdbcType=VARCHAR} CLNT_CD
			     , #{ordrsNo, jdbcType=VARCHAR} ORDRS_NO
			     , #{prjctCd, jdbcType=VARCHAR} PRJCT_CD
			     , #{prdtCd,  jdbcType=VARCHAR} PRDT_CD
			     , #{itemDiv, jdbcType=VARCHAR} ITEM_DIV
			     , #{coCd,    jdbcType=VARCHAR} CO_CD 
			 FROM DUAL
		</otherwise>
		</choose>
	</select>    
  
  
  
	<select id="selectMByRetriveValue" resultType="CamelMap">
	/* fileTrgtTyp = SALES_CD | ORDRS_NO | CLNT_PJT | CLNT_CD | CO_CD */
		<choose>
		<!-- 1. SALES_CD -->
		<when test="type == 'SALES_CD'">
			SELECT #{coCd, jdbcType=VARCHAR}							AS CO_CD
				 , nvl(#{clntCd, jdbcType=VARCHAR}, M.ORDRS_CLNT_CD)    AS CLNT_CD
				 , M.CLNT_PJT  											AS PRJCT_CD
				 , T.SALES_CD 
				 , T.PRDT_CD 
				 , T.ITEM_DIV
				 , M.ORDRS_NO 
			FROM TB_CR02D02 T
					LEFT OUTER JOIN TB_CR02M01 M ON T.ORDRS_NO = M.ORDRS_NO AND T.CO_CD = M.CO_CD 
	         WHERE T.SALES_CD = #{salesCd}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!-- 2. ORDRS_NO -->
		<when test="type == 'ORDRS_NO'">
			SELECT #{coCd, jdbcType=VARCHAR}							AS CO_CD
				 , M.ORDRS_NO 											AS ORDRS_NO 
				 , nvl(#{clntCd, jdbcType=VARCHAR},M.ORDRS_CLNT_CD)     AS CLNT_CD
				 , M.CLNT_PJT  											AS PRJCT_CD
				 , '' 				AS SALES_CD 
				 , '' 				AS PRDT_CD 
				 , '' 				AS ITEM_DIV 
			FROM TB_CR02M01 M 
	       WHERE M.ORDRS_NO = #{ordrsNo}
			FETCH FIRST 1 ROWS ONLY
		</when>
	
		<!-- 예외 : 입력된 자료 그대로 처리함 -->
		<otherwise>
			SELECT #{salesCd, jdbcType=VARCHAR} SALES_CD
			     , #{clntCd,  jdbcType=VARCHAR} CLNT_CD
			     , #{ordrsNo, jdbcType=VARCHAR} ORDRS_NO
			     , #{prjctCd, jdbcType=VARCHAR} PRJCT_CD
			     , #{prdtCd,  jdbcType=VARCHAR} PRDT_CD
			     , #{itemDiv, jdbcType=VARCHAR} ITEM_DIV
			     , #{coCd,    jdbcType=VARCHAR} CO_CD 
			 FROM DUAL
		</otherwise>
		</choose>
	</select>    
	
	<!-- 1) 채번 (시퀀스) -->
	<select id="nextDlHistId" resultType="long">
		SELECT TB_CM08M02_SQ01.NEXTVAL FROM DUAL
	</select>
	
	<!-- 2) 다운로드 START 이력 INSERT -->
    <insert id="insertDnldStart">
        INSERT INTO TB_CM08M02 (
				  DL_HIST_ID
				, FILE_KEY
				, FILE_NAME
				, FILE_PATH
				, USER_ID
				, DEVICE_TYPE
				, CLIENT_IP
				, XFF_IP
				, USER_AGENT
				, REFERER
				, REQ_ID
				, REQ_URI
				, HTTP_METHOD
				, START_DT
				, END_DT
				, RESULT_CD
        ) VALUES(
				  #{dlHistId}
				, #{fileKey}
				, #{fileName}
				, #{filePath}
				, #{userId}
				, #{deviceType}
				, #{clientIp	, jdbcType=VARCHAR}
				, #{xffIp		, jdbcType=VARCHAR}
				, #{userAgent	, jdbcType=VARCHAR}
				, #{referer		, jdbcType=VARCHAR}
				, #{reqId		, jdbcType=VARCHAR}
				, #{reqUri		, jdbcType=VARCHAR}
				, #{httpMethod	, jdbcType=VARCHAR}
				, SYSTIMESTAMP
				, ''
				, 'P'  <!-- 진행중(Processing) -->
        )
    </insert>
    
	<!-- 3) 다운로드 END 이력 UPDATE (성공/실패 공용) -->
	<update id="updateDnldEnd" parameterType="map">
		UPDATE TB_CM08M02
		   SET END_DT      = SYSTIMESTAMP
		     , RESULT_CD   = #{resultCd}      <!-- 'S' or 'F' -->
		     , HTTP_STATUS = #{httpStatus}
		     , BYTES_SENT  = #{bytesSent}
		     , ERR_MSG     = #{errMsg	, jdbcType=VARCHAR}
		 WHERE DL_HIST_ID  = #{dlHistId}
		   AND RESULT_CD   = 'P'  <!-- 중복 업데이트 방지(선택) -->
	</update>
</mapper>