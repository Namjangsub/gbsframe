<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.admin.cm.cm11.mapper.CM11Mapper">
	<select id="selectSearchDttm" resultType="String">
	SELECT TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') SEARCH_DTTM FROM DUAL
	</select>

	<select id="selectPrjectDashList" resultType="CamelMap">
	SELECT  L.*,
       		ROWNUM AS RN
     FROM (
			SELECT T.ORDRS_CLNT_CD,  
			       T.CLNT_PJT,
			       max(B.CLNT_NM) || '-' || max(CLNT_PJT_NM) AS ROW_TIT,
			       ROUND(SUM(T.PLAN_AMT) /  #{searchUnit}, 0)  AS PLAN_AMT,
			       ROUND(SUM(T.ORDRS_AMT)  /  #{searchUnit}, 0) AS ORDRS_AMT
			  FROM (
								SELECT TO_CHAR(ORDRS_CLNT_CD) ORDRS_CLNT_CD, 
								       CLNT_PJT, 
								       FN_CM05M01_CD_TO_NM(T.CLNT_PJT) CLNT_PJT_NM,
								       0 PLAN_AMT,
								       ORDRS_AMT * EXRATE ORDRS_AMT
								  FROM TB_CR02M01 T
								 WHERE T.CO_CD = #{coCd}
								   AND T.ORDRS_DT  BETWEEN  TO_DATE(#{searchYm} || '01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(#{searchYm} || '01', 'YYYYMMDD'))
					UNION ALL
								SELECT TO_CHAR(CLNT_CD) CLNT_CD, 
								       PRJCT_CD, 
								       FN_CM05M01_CD_TO_NM(B.PRJCT_CD) CLNT_PJT_NM,
								       ORDRS_PLAN_AMT PLAN_AMT,
								       0 ORDRS_AMT
								  FROM TB_BM06M01 B
								 WHERE CO_CD = #{coCd} 
								  AND YYYYMM = #{searchYm} 
				  ) T
				   LEFT OUTER JOIN  TB_BM02M01 B ON T.ORDRS_CLNT_CD = B.CLNT_CD
			   GROUP BY ORDRS_CLNT_CD, CLNT_PJT
			   ORDER BY ORDRS_AMT DESC
		   ) L
<!--       WHERE ROWNUM BETWEEN 1 AND 10	   -->
	</select>
	
	<select id="selectClientTaxDashList" resultType="CamelMap">
	SELECT  L.*,
       		ROWNUM AS RN
     FROM (
			SELECT * 
			  FROM (
					SELECT T.CLNT_CD, 
					       MAX(B.CLNT_NM) AS CLNT_NM,  
					       ROUND(SUM(PLAN_AMT) / #{searchUnit}, 0) AS PLAN_AMT,
					       ROUND(SUM(SALES_AMT) / #{searchUnit}, 0) AS SALES_AMT
					  FROM (
								SELECT ORDRS_CLNT_CD AS CLNT_CD, 
								       0 AS PLAN_AMT,
--								       (SELL_BILL_AMT * EXRATE) + (SELL_BILL_VAT * EXRATE) AS SALES_AMT
								       (SELL_BILL_AMT * EXRATE) AS SALES_AMT
								  FROM TB_CR04M01
								  WHERE CO_CD = #{coCd} 
								    AND SELL_BILL_DT  BETWEEN  TO_DATE(#{searchYm} || '01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(#{searchYm} || '01', 'YYYYMMDD'))
							UNION ALL
								SELECT SALES_PLAN_CLNT_CD AS CLNT_CD,
								       SALES_PLAN_AMT AS PLAN_AMT,
								       0 AS SALES_AMT
								FROM TB_CR10M01
								  WHERE CO_CD = #{coCd} 
								    AND SALES_PLAN_YM = #{searchYm}
								    AND SALES_PLAN_DIV = 'SALESPLANDIV20'
							 ) T
							  LEFT OUTER JOIN  TB_BM02M01 B ON T.CLNT_CD = B.CLNT_CD 
					GROUP BY T.CLNT_CD
					)
			ORDER BY SALES_AMT DESC, CLNT_CD 
		   ) L
<!--       WHERE ROWNUM BETWEEN 1 AND 10	  	 -->
	</select>
	
	<select id="selectClntSelpch1Count" resultType="int">
	  SELECT COUNT(*)
	  FROM  TB_CM05M01
	WHERE  CODE_KIND = 'CO'
	    AND  USE_YN  = 'Y'
	</select>
	
	<select id="selectClientPchsDashList" resultType="CamelMap">
	SELECT  L.*,
       	ROWNUM AS RN
     FROM (
			SELECT T.PCHS_CLNT_CD,  
			       max(B.CLNT_NM)  AS ROW_TIT,
			       ROUND(SUM(PCHS_TOT)  /  #{searchUnit}, 0) AS PCHS_TOT
			  FROM (		
					SELECT 
					        T.CO_CD,
					        S.PCHS_CLNT_CD,
					        T.PCHS_AMT,
					        T.PCHS_VAT,
					        T.PCHS_AMT+T.PCHS_VAT AS PCHS_TOT,
					        T.PCHS_DT
					FROM TB_SM12D01 T
						LEFT OUTER JOIN TB_SM02M01 S ON T.CO_CD      = S.CO_CD 
		                					        AND T.ORDRG_NO   = S.ORDRG_NO
					WHERE T.CO_CD  = #{coCd} 
					  AND T.PCHS_DT  BETWEEN  TO_DATE(#{searchYm} || '01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(#{searchYm} || '01', 'YYYYMMDD'))
 				  ) T
				   LEFT OUTER JOIN  TB_BM02M01 B ON T.PCHS_CLNT_CD = B.CLNT_CD
			   GROUP BY PCHS_CLNT_CD
			   ORDER BY PCHS_TOT DESC
		   ) L
<!--       WHERE ROWNUM BETWEEN 1 AND 10 -->
	</select>
	
	
	<select id="selectFacList" resultType="CamelMap">

	SELECT  L.*,
       		ROWNUM AS RN
     FROM (
			SELECT T.ORDRS_CLNT_CD,  
			       T.CLNT_PJT,
			       max(B.CLNT_NM) || '-' || max(CLNT_PJT_NM) AS ROW_TIT,
			       ROUND(SUM(T.PLAN_AMT) /  #{searchUnit}, 0)  AS PLAN_AMT,
			       ROUND(SUM(T.ORDRS_AMT)  /  #{searchUnit}, 0) AS ORDRS_AMT
			  FROM (
								SELECT TO_CHAR(ORDRS_CLNT_CD) ORDRS_CLNT_CD, 
								       CLNT_PJT, 
								       FN_CM05M01_CD_TO_NM(T.CLNT_PJT) CLNT_PJT_NM,
								       0 PLAN_AMT,
								       ORDRS_AMT * EXRATE ORDRS_AMT
								  FROM TB_CR02M01 T
								 WHERE T.CO_CD = #{coCd}
								   AND T.ORDRS_DT  BETWEEN  TO_DATE(#{searchYm} || '01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(#{searchYm} || '01', 'YYYYMMDD'))
					UNION ALL
								SELECT TO_CHAR(CLNT_CD) CLNT_CD, 
								       PRJCT_CD, 
								       FN_CM05M01_CD_TO_NM(B.PRJCT_CD) CLNT_PJT_NM,
								       ORDRS_PLAN_AMT PLAN_AMT,
								       0 ORDRS_AMT
								  FROM TB_BM06M01 B
								 WHERE CO_CD = #{coCd} 
								  AND YYYYMM = #{searchYm} 
				  ) T
				   LEFT OUTER JOIN  TB_BM02M01 B ON T.ORDRS_CLNT_CD = B.CLNT_CD
			   GROUP BY ORDRS_CLNT_CD, CLNT_PJT
			   ORDER BY ORDRS_AMT DESC
		   ) L
<!--       WHERE ROWNUM BETWEEN 1 AND 5	   -->
	</select>
	
	<select id="selectMonthlyStat" resultType="CamelMap">
	SELECT ROUND(SUM(PCHS_TOT) / #{searchUnit}, 0) PCHS_TOT
	     , ROUND(SUM(SALES_TOT) / #{searchUnit}, 0) SALES_TOT
	     , TRST_DT
	 FROM (
	 		--매입금액
			SELECT sum(T.PCHS_AMT+T.PCHS_VAT) AS PCHS_TOT,
			       0 AS SALES_TOT,
			       SUBSTRING(PCHS_DT, 0, 7)	AS TRST_DT       
			  FROM TB_SM12D01 T
			 WHERE T.CO_CD  = #{coCd}
			   AND T.PCHS_DT  BETWEEN SUBSTRING(#{searchYm}, 0, 4) || '0101' AND SUBSTRING(#{searchYm}, 0, 4)||'1231'  
			 GROUP BY SUBSTRING(PCHS_DT, 0, 7)
		UNION ALL
			--매출금액
			SELECT 0 AS PCHS_TOT,
--			       sum((SELL_BILL_AMT * EXRATE) + (SELL_BILL_VAT * EXRATE)) AS SALES_TOT,
			       sum(SELL_BILL_AMT * EXRATE)  AS SALES_TOT,
			       SUBSTRING(SELL_BILL_DT, 0, 7) AS TRST_DT
			  FROM TB_CR04M01
			 WHERE CO_CD = #{coCd}
			   AND SELL_BILL_DT  BETWEEN  SUBSTRING(#{searchYm}, 0, 4) || '0101' AND SUBSTRING(#{searchYm}, 0, 4)||'1231' 
			 GROUP BY SUBSTRING(SELL_BILL_DT, 0, 7)
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/01' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/02' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/03' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/04' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/05' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/06' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/07' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/08' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/09' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/10' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/11' FROM DUAL
		UNION ALL
		SELECT 0, 0, SUBSTRING(#{searchYm}, 0, 4) || '/12' FROM DUAL)
	GROUP BY TRST_DT
	ORDER BY TRST_DT
	</select>
</mapper>
