<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.cm.cm16.mapper.CM16Mapper">

    <select id="selectItoaIssueListCount" parameterType="Map"  resultType="int">
        <!--어떻게 작성해야할지 잘 모르겠습니다.-->
        SELECT COUNT(*)
        FROM    (
               SELECT *
				 FROM TB_CM16M01
				WHERE 1 = 1 
				 <if test="reqDtFrom == null or reqDtFrom.equals('')">
				  AND REQ_DT BETWEEN to_date(#{reqDtFrom},'YYYY-MM-DD') AND to_date(#{reqDtTo} ,'YYYY-MM-DD')
				 </if>
                )
    </select>

    <select id="selectItoaIssueList" parameterType="Map" resultType="CamelMap">
	    SELECT *
	      FROM (
		    	SELECT    X.*
		    			, ROWNUM AS RN
		    	  FROM (
					SELECT 
							  FILE_TRGT_KEY
							, REQ_DT
							, REQ_TH
							, REQ_DEPT
							, REQ_ID
							, REQ_TYPE
							, ISSUE
							, ACT_CD
							, ACT_DTTM
							, ACT_ID
							, ACT_PROC_TM
							, ACT_DESC
							, RMK
							, CREAT_ID
							, CREAT_PGM
							, CREAT_DTTM
					 FROM TB_CM16M01
					WHERE 1 = 1 
					 <if test="reqDtFrom == null or reqDtFrom.equals('')">
					  AND REQ_DT BETWEEN to_date(#{beginDt},'YYYY-MM-DD') AND to_date(#{reqDtTo} ,'YYYY-MM-DD')
					 </if>
			    ) X 
			) 
		 WHERE RN BETWEEN ${firstIndex} AND ${lastIndex}
    </select>

    <select id="selectConfirmCount" resultType="CamelMap">
        SELECT COUNT(FILE_TRGT_KEY) CNT
        FROM TB_PM01M01
        WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

    <update id="updateItoaIssue" parameterType="Map">
        UPDATE TB_CM16M01
        SET FILE_TRGT_KEY   = #{fileTrgtKey},
            REQ_DT          = #{reqDt},
            REQ_TH          = #{reqTh},
            REQ_DEPT        = #{reqDept},
            REQ_ID          = #{reqId},
            REQ_TYPE        = #{reqType},
            ISSUE           = #{issue},
            ACT_CD          = #{actCd},
            ACT_DTTM        = #{actDttm},
            ACT_ID          = #{actId},
            ACT_PROC_TM     = #{actProcTm},
            ACT_DESC        = #{actDesc},
            RMK             = #{rmk}
        WHERE FILE_TRGT_KEY = #{fileTrgtKey}

    </update>

    <!--시퀀스 객체 어떻게 해야할지 모르겠습니다.-->
    <select id="selectItoaIssueSeqNext" parameterType="Map">
        SELECT TB_CM16M01
    </select>

    <insert id="insertItoaIssue" parameterType="Map">
        <selectKey keyProperty="fileTrgtKey" resultType="String" order="BEFORE">
            SELECT 'DM' || TO_CHAR(SYSDATE, 'YYYYMMDD')||'-'||LPAD(MOD(TB_PM01M01_SQ02.NEXTVAL, 10000), 4, '0') FROM DUAL
        </selectKey>
        INSERT INTO TB_CM16M01
        (
        FILE_TRGT_KEY,
        REQ_DT,
        REQ_TH,
        REQ_DEPT,
        REQ_ID ,
        REQ_TYPE,
        ISSUE,
        ACT_CD,
        ACT_DTTM,
        ACT_ID,
        ACT_PROC_TM,
        ACT_DESC,
        RMK
        )
        VALUES
        (
        #{fileTrgtKey},
        #{reqDt},
        #{reqTh},
        #{reqDept},
        #{reqId},
        #{reqType},
        #{issue},
        #{actCd},
        #{actDttm},
        #{actId},
        #{actProcTm},
        #{actDesc},
        #{rmk}
        )
    
    </insert>

    <delete id="deleteItoaIssue" parameterType="Map">
        DELETE
        TB_CM1601M01 WHERE FILE_TRGT_KEY =
        #{fileTrgtKey}
    </delete>
  
</mapper>    