<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.admin.cm.cm16.mapper.CM16Mapper">

    <select id="selectItoaIssueListCount" parameterType="Map"  resultType="int">
               SELECT COUNT(*)
				 FROM TB_CM16M01
				WHERE 1 = 1 
				 <if test="reqDtFrom != null or !reqDtFrom.equals('')">
				  AND REQ_DTTM BETWEEN to_date(#{reqDtFrom},'YYYY-MM-DD') AND to_date(#{reqDtTo} ,'YYYY-MM-DD')
				 </if>
    </select>

    <select id="selectItoaIssueList" parameterType="Map" resultType="CamelMap">
	    SELECT *
	      FROM (
                SELECT    X.*
                        , ROWNUM AS RN
		    	  FROM (
					SELECT 
                              X.FILE_TRGT_KEY
                            , X.CO_CD
                            , FN_CM05M01_CD_TO_NM(X.CO_CD) CO_NM
                            , TO_CHAR(X.REQ_DTTM, 'YYYY-MM-DD HH24:MI')                 AS REQ_DTTM
                            , C4.DEPT_NM 												AS REQ_DEPT
                            , X.REQ_ID    
							, C6.NAME											        AS REQ_ID_NM
                            , X.REQ_TYPE
                            , A.CODE_NM                                                 AS REQ_TYPE_NM
                            , X.ISSUE
                            , X.ACT_CD						
                            , B.CODE_NM                                                 AS ACT_CD_NM
							, TO_CHAR(X.ACT_DTTM, 'YYYY-MM-DD HH24:MI')                 AS ACT_DTTM
							, X.ACT_ID
                            , (SELECT FN_CM06M01_ID_TO_NM(X.ACT_ID) FROM DUAL)          AS ACT_ID_NM
							, X.ACT_PROC_TM
							, X.ACT_DESC
							, X.RMK
							, X.CREAT_ID
							, (SELECT FN_CM06M01_ID_TO_NM(X.CREAT_ID) FROM DUAL)          	AS CREAT_ID_NM  
							, X.CREAT_PGM
							, TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') 				AS CREAT_DTTM
                            , X.UDT_ID                                                      AS UDT_ID             
							, (SELECT FN_CM06M01_ID_TO_NM(X.UDT_ID) FROM DUAL)          	AS UDT_ID_NM
                            , X.UDT_PGM                                                     AS UDT_PGM            
                            , TO_CHAR(X.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')                  AS UDT_DTT            
					 FROM TB_CM16M01 X
                                LEFT OUTER JOIN TB_CM05M01 A ON X.REQ_TYPE = A.CODE_ID
                                LEFT OUTER JOIN TB_CM05M01 B ON X.ACT_CD = B.CODE_ID
                                LEFT OUTER JOIN TB_CM06M01 D ON X.REQ_ID = D.ID
                                LEFT OUTER JOIN TB_CM06M01 E ON X.ACT_ID = E.ID
                                LEFT OUTER JOIN TB_CM06M01 C6 ON X.REQ_ID = C6.ID
                                LEFT OUTER JOIN TB_CM04M01 C4 ON C6.DEPT_ID = C4.DEPT_ID
					WHERE 1 = 1
                    <if test="coCd !=null and !coCd.equals('')">
                     AND X.CO_CD = #{coCd}
                    </if>
					<if test="reqDtFrom != null or !reqDtFrom.equals('')">
					 AND REQ_DTTM BETWEEN to_date(#{reqDtFrom},'YYYY-MM-DD') AND to_date(#{reqDtTo} ,'YYYY-MM-DD')
					</if>
                    <if test="reqId !=null and !reqId.equals('')">
				     AND X.REQ_ID = #{reqId}
                    </if>
                    <if test="reqIdNm != null and !reqIdNm.equals('')">
                     AND C6.NAME LIKE '%' || #{reqIdNm} || '%'
                    </if>
                    <if test="actId !=null and !actId.equals('')">
				     AND X.ACT_ID = #{actId}
                    </if>
                    <if test="actIdNm != null and !actIdNm.equals('')">
                     AND E.NAME = #{actIdNm}
                    </if>
                    <if test="actCd != null and !actCd.equals('')">
                     AND X.ACT_CD = #{actCd}
                    </if>
                    <if test="reqTypeNm != null and !reqTypeNm.equals('')">
                     AND X.REQ_TYPE = #{reqTypeNm}
                    </if>
                ) X 
			) 
		 WHERE RN BETWEEN ${firstIndex} AND ${lastIndex}
    </select>

    <select id="selectItoaIssueInfo" resultType="CamelMap">
        SELECT 
                  X.FILE_TRGT_KEY
                , X.CO_CD
                , FN_CM05M01_CD_TO_NM(X.CO_CD) CO_NM
                , TO_CHAR(X.REQ_DTTM, 'YYYY-MM-DD HH24:MI')                 AS REQ_DTTM
                , X.REQ_ID    
                , (SELECT FN_CM06M01_ID_TO_NM(X.REQ_ID) FROM DUAL)          AS REQ_ID_NM
                , X.REQ_TYPE
                , A.CODE_NM                                                 AS REQ_TYPE_NM
                , X.ISSUE
                , X.ACT_CD						
                , B.CODE_NM                                                 AS ACT_CD_NM
                , TO_CHAR(X.ACT_DTTM, 'YYYY-MM-DD HH24:MI')                 AS ACT_DTTM
                , X.ACT_ID
                , (SELECT FN_CM06M01_ID_TO_NM(X.ACT_ID) FROM DUAL)          AS ACT_ID_NM
                , X.ACT_PROC_TM
                , X.ACT_DESC
                , X.RMK
                , X.CREAT_ID
                , (SELECT FN_CM06M01_ID_TO_NM(X.CREAT_ID) FROM DUAL)          	AS CREAT_ID_NM  
                , X.CREAT_PGM
                , TO_CHAR(X.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') 				AS CREAT_DTTM
                , X.UDT_ID                                                      AS UDT_ID             
                , (SELECT FN_CM06M01_ID_TO_NM(X.UDT_ID) FROM DUAL)          	AS UDT_ID_NM
                , X.UDT_PGM                                                     AS UDT_PGM            
                , TO_CHAR(X.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS')                  AS UDT_DTT            
		FROM TB_CM16M01 X
                LEFT OUTER JOIN TB_CM05M01 A ON X.REQ_TYPE = A.CODE_ID
                LEFT OUTER JOIN TB_CM05M01 B ON X.ACT_CD = B.CODE_ID
                LEFT OUTER JOIN TB_CM06M01 D ON X.REQ_ID = D.ID
                LEFT OUTER JOIN TB_CM06M01 E ON X.ACT_ID = E.ID
        WHERE X.FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

    <select id="selectConfirmCount" resultType="CamelMap">
        SELECT COUNT(FILE_TRGT_KEY) CNT
        FROM TB_CM16M01
        WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </select>

    <select id="selectItoaIssueSeqNext" parameterType="Map" resultType="String">
        SELECT FILE_TRGT_KEY_SEQ.NEXTVAL FROM DUAL
    </select>

    <insert id="itoaInsertIssue" parameterType="Map">

        <selectKey keyProperty="fileTrgtKey" resultType="String" order="BEFORE">
        SELECT MAX(NVL(TO_NUMBER(FILE_TRGT_KEY),0)) + 1
		  FROM  TB_CM16M01
        </selectKey>
        INSERT INTO TB_CM16M01
            ( 
                  FILE_TRGT_KEY
                , CO_CD
                , REQ_DTTM
                , REQ_ID 
                , REQ_TYPE
                , ISSUE
                , ACT_CD
                , ACT_DTTM
                , ACT_ID
                , ACT_PROC_TM
                , ACT_DESC
                , RMK
                , CREAT_ID
				, CREAT_PGM
				, CREAT_DTTM
				, UDT_ID
				, UDT_PGM
				, UDT_DTTM
            )
        VALUES
            (
                  #{fileTrgtKey}
                , #{coCd}
                , TO_DATE(REPLACE(#{reqDttm}, 'T', ' '), 'YYYY-MM-DD HH24:MI')
                , #{reqId}
                , #{reqType, jdbcType=VARCHAR}
                , #{issue}
                , #{actCd, jdbcType=VARCHAR}
                , TO_DATE(REPLACE(#{actDttm}, 'T', ' '), 'YYYY-MM-DD HH24:MI')
                , #{actId}
                , #{actProcTm}
                , #{actDesc}
                , #{rmk}
                , #{userId}
                , #{pgmId}
                , SYSDATE
				, ''
				, ''
				, ''
            )
    </insert>

    <update id="itoaUpdateIssue" parameterType="Map">
        UPDATE TB_CM16M01
        SET   FILE_TRGT_KEY     = #{fileTrgtKey}
            , CO_CD             = #{coCd}
            , REQ_DTTM          = TO_DATE(REPLACE(#{reqDttm}, 'T', ' '), 'YYYY-MM-DD HH24:MI')
            , REQ_ID            = #{reqId}
            , REQ_TYPE          = #{reqType, jdbcType=VARCHAR}
            , ISSUE             = #{issue}
            , ACT_CD            = #{actCd, jdbcType=VARCHAR}
            , ACT_DTTM          = TO_DATE(REPLACE(#{actDttm}, 'T', ' '), 'YYYY-MM-DD HH24:MI')
            , ACT_ID            = #{actId}
            , ACT_PROC_TM       = #{actProcTm}
            , ACT_DESC          = #{actDesc}
            , RMK               = #{rmk}
            , UDT_ID            = #{userId}
            , UDT_PGM           = #{pgmId}
            , UDT_DTTM          = SYSDATE
        WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </update>

    <delete id="itoaDeleteIssue" parameterType="Map">
        DELETE TB_CM16M01 WHERE FILE_TRGT_KEY = #{fileTrgtKey}
    </delete>

</mapper>    