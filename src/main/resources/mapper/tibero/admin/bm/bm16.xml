<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.admin.bm.bm16.mapper.BM16Mapper">

	<select id="selectPrjctCount" parameterType="Map" resultType="int">
		SELECT
            count(*)
		  FROM TB_BM06M01
        WHERE 1=1

            <if test="coCd !=null and !coCd.equals('')">
  	       AND CO_CD = #{coCd}
		</if>
		<if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
		   AND ORDRS_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
		</if>
        <if test="searchValue != null and !searchValue.equals('') and searchType != null and !searchType.equals('')">
          AND ${searchType} LIKE '%${searchValue}%'
        </if>
        <if test="ordTyp != null and !ordTyp.equals('')">
          AND ORD_TYP = #{ordTyp}
        </if>

	</select>

	<select id="selectPrjctList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
				SELECT PRJCT_SEQ
					 , CO_CD
                     , FN_CM05M01_CD_TO_NM(CO_CD) CO_NM
                     , YYYYMM
                     , INPEXP_CD
					 , FN_CM05M01_CD_TO_NM(INPEXP_CD) INPEXP_NM
					 , NEW_PRDT_CD
                     , FN_CM05M01_CD_TO_NM(NEW_PRDT_CD) NEW_PRDT_NM
                     , PRJCT_CD
                     , PRJCT_NM
                     , EQP_NM
                     , CAR_NM
                     , EQP_QTY
                     , TB_BM06M01.CLNT_CD
                     , TB_BM02M01.CLNT_NM
					 , CLNT_MNG_NM
					 , ODR_CD
                     , FN_CM05M01_CD_TO_NM(ODR_CD) ODR_NM
					 , ODR_RMK
					 , EPCT_AMT
					 , ORDRS_PLAN_AMT
                     , WINBD_CD
					 , WINBD_RMK
					 , ORDRS_PLAN_DT
					 , ORDRS_AMT
					 , ORDRS_DT
					 , DUDT_PLAN_DT
					 , MNG_ID
                     , PRJCT_RMK
                     , ORDRS_PCT
<!-- 					 , CREAT_ID -->
<!-- 					 , CREAT_PGM -->
<!-- 					 , CREAT_DTTM -->
<!-- 					 , UDT_ID -->
<!-- 					 , UDT_PGM -->
<!-- 					 , UDT_DTTM -->
				  FROM TB_BM06M01
            INNER JOIN TB_BM02M01 ON TB_BM06M01.CLNT_CD = TB_BM02M01.CLNT_CD
		         WHERE 1=1
	               <if test="coCd !=null and !coCd.equals('')">
     	           AND CO_CD = #{coCd}
	              </if>
				   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND ORDRS_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
				  </if>
		         ORDER BY YYYYMM, INPEXP_CD
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>

  <resultMap id="resultInfoMap" type="CamelMap">
    <collection select="selectItemList" property="ITEM_LIST" column="{prjctSeq=PRJCT_SEQ}" ofType="CamelMap"/>
    <collection select="selectPrdtList" property="PRDT_LIST" column="{prjctSeq=PRJCT_SEQ}" ofType="CamelMap"/>
<!--     <collection select="selectFileList" property="FILE_LIST" column="{fileTrgtKey=PRJCT_SEQ}" ofType="CamelMap"/> -->
  </resultMap>


  <select id="selectPrjctInfo" resultMap="resultInfoMap">
              SELECT PRJCT_SEQ
					 , T.CO_CD
                     , T.INPEXP_CD
                     , FN_CM05M01_CD_TO_NM(T.INPEXP_CD) INPEXP_NM
					 , T.NEW_PRDT_CD
                     , FN_CM05M01_CD_TO_NM(T.NEW_PRDT_CD) NEW_PRDT_NM
					 , T.CLNT_CD
					 , b.CLNT_NM
					 , T.CLNT_MNG_NM
					 , T.PRJCT_NM
					 , T.EQP_NM
					 , T.EQP_QTY
					 , T.ODR_CD
					 , T.ODR_RMK
					 , T.EPCT_AMT
					 , T.ORDRS_PLAN_AMT
					 , T.WINBD_RMK
					 , T.ORDRS_PLAN_DT
					 , T.ORDRS_AMT
					 , T.WINBD_CD
					 , T.ORDRS_DT
					 , T.DUDT_PLAN_DT
					 , T.MNG_ID
					 , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
					 , T.YYYYMM
					 , T.PRJCT_CD
					 , T.PRJCT_RMK
					 , T.CREAT_ID
					 , T.CREAT_PGM
					 , T.CREAT_DTTM
					 , T.UDT_ID
					 , T.UDT_PGM
					 , T.UDT_DTTM
                     , ORDRS_PCT
                  FROM TB_BM06M01 T LEFT OUTER JOIN
                       TB_BM02M01 b ON T.CLNT_CD = b.CLNT_CD
                 WHERE PRJCT_SEQ = #{prjctSeq}
  </select>


  <select id="selectItemList" resultType="CamelMap">

   SELECT nvl2(b.PRJCT_PRDT_CD,'Y','N') IS_CHK
        , B.PRJCT_ITEM_CD
        , B.*
        , A.*
      FROM (SELECT *
               FROM TB_CM05M01
              WHERE CODE_KIND = 'ITEMLIST'
             ) a LEFT OUTER join
            (SELECT *
               FROM TB_BM06D01
              WHERE PRJCT_SEQ = #{prjctSeq}
             ) b
         ON a. CODE_ID = b.PRJCT_ITEM_CD
      WHERE nvl2(b.PRJCT_ITEM_CD,'Y','N') != 'N'
<!--         and b.PRJCT_PRDT_CD = #{prjctPrdtCd}; -->


<!--   SELECT nvl2(b.PRJCT_PRDT_CD,'Y','N') IS_CHK, -->
<!--          B.PRJCT_ITEM_CD, -->
<!--          B.*, -->
<!--          A.* -->
<!--       FROM (SELECT * -->
<!--                FROM TB_CM05M01 -->
<!--               WHERE CODE_KIND = 'ITEMLIST' -->
<!--              ) a LEFT OUTER join -->
<!--             (SELECT * -->
<!--                FROM TB_BM06D01 -->
<!--               WHERE PRJCT_SEQ = #{prjctSeq} -->
<!--                  AND PRJCT_PRDT_CD = 1 -->
<!--          AND PRJCT_PRDT_CD = #{prjctPrdtCd} -->
<!--              ) b -->
<!--          ON a. CODE_ID = b.PRJCT_ITEM_CD -->
<!--       WHERE nvl2(b.PRJCT_ITEM_CD,'Y','N') != 'N' -->

<!--       and   prjct_prdt_cd = #{prjct_prdt_cd}; -->

<!-- TB_CM05M01에서 CODE_KIND가 'ITEMLIST'인 모든 데이터를 가져온 후,
 TB_BM06D01에서 PRJCT_SEQ가 #{prjctSeq}인 데이터를 왼쪽 외부 조인(LEFT OUTER JOIN).
조인한 결과를 통해, 각각의 레코드에서 B.PRJCT_PRDT_CD의 값이 NULL이 아니면 'Y', NULL이면
 'N'을 반환하는 IS_CHK 칼럼을 선택. 그리고 나머지 모든 B 테이블과 A 테이블의 칼럼을 선택 -->


<!--      SELECT nvl2(b.PRJCT_PRDT_CD,'Y','N') IS_CHK, -->
<!--          B.*, -->
<!--          A.* -->
<!--       FROM  (SELECT * -->
<!--                FROM TB_CM05M01 -->
<!--               WHERE CODE_KIND = 'ITEMLIST' -->
<!--             ) a LEFT OUTER join -->
<!--             (SELECT * -->
<!--                FROM TB_BM06D01 -->
<!--               WHERE PRJCT_SEQ = #{prjctSeq} -->
<!--                 AND PRJCT_PRDT_CD = 1 -->
<!--             ) b -->
<!--            ON a. CODE_ID = b.PRJCT_ITEM_CD -->

<!--            WHERE nvl2(b.PRJCT_ITEM_CD,'Y','N') != 'N'; -->
<!-- 체크가 없으면 안보이는 조건 -->
  </select>

  <select id="selectPrdtList" resultType="CamelMap">
   SELECT DISTINCT
          a.PRJCT_SEQ
        , a.PRJCT_PRDT_CD
        , b.PRDT_NM

     FROM TB_BM06D01 a LEFT OUTER JOIN TB_BM01M01 b
       ON a.PRJCT_PRDT_CD = b.PRDT_CD

    WHERE a.PRJCT_SEQ = #{prjctSeq}

<!--'tb_bm06d01' 테이블에서 'PRJCT_SEQ' 값이 '#{prjctSeq}'와 일치하는 모든 데이터를 선택. 'a'로 표시.

'a'와 'TB_BM01M01' 테이블을 'PRJCT_PRDT_CD' 컬럼을 기준으로 왼쪽 외부 조인
이는 'a'의 'PRJCT_PRDT_CD'와 일치하는 'TB_BM01M01'의 데이터를 가져오며,
'TB_BM01M01'의 데이터가 없는 경우 NULL 값을 가짐. 'TB_BM01M01'의 'PRDT_NM' 열을 'b'로 표시.

조인된 결과에서 다음 열을 선택

'a.PRJCT_SEQ' 열은 'a' 테이블의 'PRJCT_SEQ' 값
'a.PRJCT_PRDT_CD' 열은 'a' 테이블의 'PRJCT_PRDT_CD' 값
'b.PRDT_NM' 열은 'b' 테이블의 'PRDT_NM' 값
중복된 행을 제거하기 위해 SELECT DISTINCT 문을 사용

따라서 결과는 'a.PRJCT_SEQ', 'a.PRJCT_PRDT_CD', 'b.PRDT_NM' 열로 구성된 행의 목록입니다. -->
  </select>

  <select id="selectFileList" resultType="CamelMap">
    SELECT *
      FROM TB_CM08M01
     WHERE FILE_TRGT_TYP = 'TB_BM06M01'
       AND FILE_TRGT_KEY = #{fileTrgtKey}
  </select>

<update id="updatePrjct" parameterType="Map">
    UPDATE TB_BM06M01
          SET
          PRJCT_SEQ                                     = #{prjctSeq}
        , CO_CD                                         = #{coCd}
        , INPEXP_CD                                     = #{inpexpCd}
        , NEW_PRDT_CD                                   = #{newPrdtCd}
        , CLNT_CD                                       = #{clntCd}
        , CLNT_MNG_NM                                   = #{clntMngNm}
        , PRJCT_NM                                      = #{prjctNm}
        , EQP_NM                                        = #{eqpNm}
        , EQP_QTY                                       = #{eqpQty}
        , ODR_CD                                        = #{odrCd}
        , ODR_RMK                                       = #{odrRmk}
        , EPCT_AMT                                      = #{epctAmt}
        , ORDRS_PLAN_AMT                                = #{ordrsPlanAmt}
        , WINBD_RMK                                     = #{winbdRmk}
        , ORDRS_PLAN_DT                                 = #{ordrsPlanDt}
        , WINBD_CD                                      = #{winbdCd}
        , ORDRS_DT                                      = #{ordrsDt}
        , DUDT_PLAN_DT                                  = #{dudtPlanDt}
        , MNG_ID                                        = #{mngId}
        , YYYYMM                                        = #{yyyymm}
        , PRJCT_CD                                      = #{prjctCd}
        , PRJCT_RMK                                     = #{prjctRmk}
        , ORDRS_AMT                                     = #{ordrsAmt}
        , ORDRS_PCT                                     = #{ordrsPct}
        , UDT_ID                                        = #{userId}
        , UDT_PGM                                       = #{pgmId}
        , UDT_DTTM                                      = SYSDATE
    WHERE PRJCT_SEQ                                     = #{prjctSeq}
<!--       AND CO_CD                                         = #{coCd} -->


  </update>

  <update id="updatePrjctDtl" parameterType="Map">
    UPDATE TB_BM06D01
       SET
           PRJCT_SEQ           = #{prjctSeq}
         , PRJCT_PRDT_CD       = #{prjctPrdtCd}
         , PRJCT_ITEM_CD       = #{codeId}
         , PRJCT_ITEM_RMK      = #{prjctItemRmk, jdbcType=VARCHAR}
         , PRJCT_ITEM_SORT     = 1
<!--          , UDT_ID              = #{userId} -->
<!--          , UDT_PGM             = #{pgmId} -->
<!--          , UDT_DTTM            = SYSDATE -->
     WHERE PRJCT_SEQ           = #{prjctSeq}
           AND PRJCT_PRDT_CD   = #{prjctPrdtCd}
           AND PRJCT_ITEM_CD   = #{codeId}
  </update>

<insert id="insertPrjct" parameterType="Map">
    <selectKey keyProperty="prjctSeq" resultType="String" order="BEFORE">
      SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_BM06M01_SQ01.NEXTVAL,3,0) FROM DUAL
    </selectKey>
    INSERT INTO TB_BM06M01
      (
            PRJCT_SEQ
          , CO_CD
          , INPEXP_CD
          , NEW_PRDT_CD
          , CLNT_CD
          , CLNT_MNG_NM
          , PRJCT_NM
          , EQP_NM
          , EQP_QTY
          , ODR_CD
          , ODR_RMK
          , EPCT_AMT
          , ORDRS_PLAN_AMT
          , WINBD_RMK
          , ORDRS_PLAN_DT
          , WINBD_CD
          , ORDRS_DT
          , DUDT_PLAN_DT
          , MNG_ID
          , YYYYMM
          , PRJCT_CD
          , PRJCT_RMK
          , ORDRS_AMT
          , ORDRS_PCT
          , UDT_ID
          , UDT_PGM
          , UDT_DTTM
      )
    VALUES
    (
           #{prjctSeq}
         , #{coCd}
         , #{inpexpCd}
         , #{newPrdtCd}
         , #{clntCd}
         , #{clntMngNm}
         , #{prjctNm}
         , #{eqpNm}
         , #{eqpQty}
         , #{odrCd}
         , #{odrRmk}
         , #{epctAmt}
         , #{ordrsPlanAmt}
         , #{winbdRmk}
         , #{ordrsPlanDt}
         , #{winbdCd}
         , #{ordrsDt}
         , #{dudtPlanDt}
         , #{mngId}
         , #{yyyymm}
         , #{prjctCd}
         , #{prjctRmk}
         , #{ordrsAmt}
         , #{ordrsPct}
         , #{userId}
         , #{pgmId}
         , SYSDATE
    )
  </insert>

  <insert id="insertPrjctDtl" parameterType="Map">

    INSERT INTO TB_BM06D01
    (
           PRJCT_SEQ
         , PRJCT_PRDT_CD
         , PRJCT_ITEM_CD
         , PRJCT_ITEM_RMK
         , PRJCT_ITEM_SORT
<!--          , UDT_ID -->
<!--          , UDT_PGM -->
<!--          , UDT_DTTM -->
      )
    VALUES
    (
        #{prjctSeq}
      , #{prjctPrdtCd}
      , #{codeId}
      , #{prjctItemRmk, jdbcType=VARCHAR}
      , 1
<!--       , #{userId} -->
<!--       , #{pgmId} -->
<!--       , SYSDATE -->
    )
  </insert>

 <delete id="deletePrjct" parameterType="Map">
    DELETE TB_BM06M01
    WHERE PRJCT_SEQ = #{prjctSeq}
  </delete>

   <delete id="deletePrjctDtlAll" parameterType="Map">
    DELETE TB_BM06D01
    WHERE PRJCT_SEQ = #{prjctSeq}
  </delete>

    <delete id="deletePrjctDtl" parameterType="Map">
    DELETE FROM TB_BM06D01
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_ITEM_CD = #{codeId}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd}

  </delete>

    <select id="selectConfirmCount" parameterType="Map" resultType="int">
    SELECT COUNT(PRJCT_SEQ) CNT
      FROM TB_BM06M01
     WHERE PRJCT_SEQ = #{prjctSeq}
  </select>

    <update id="updatePrdtDtl" parameterType="Map">
    UPDATE TB_BM06D01
       SET
           PRJCT_SEQ           = #{prjctSeq}
         , PRJCT_PRDT_CD       = #{prjctPrdtCd}
         , PRJCT_ITEM_CD       = #{codeId}
         , PRJCT_ITEM_RMK      = #{prjctItemRmk, jdbcType=VARCHAR}
         , PRJCT_ITEM_SORT     = 1
         , UDT_ID              = #{userId}
         , UDT_PGM             = #{pgmId}
         , UDT_DTTM            = SYSDATE
     WHERE PRJCT_SEQ           = #{prjctSeq}
           AND PRJCT_PRDT_CD   = #{prjctPrdtCd}
           AND PRJCT_ITEM_CD   = #{codeId}
  </update>
</mapper>