<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.admin.bm.bm16.mapper.BM16Mapper">

	<select id="selectPrjctCount" parameterType="Map" resultType="int">
		SELECT
            count(*)
		  FROM TB_BM06M01 T
           						LEFT OUTER JOIN TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
           						LEFT OUTER JOIN TB_CM06M01 B ON T.MNG_ID = B.ID
        WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.ORDRS_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
			  <if test="searchValue != null and !searchValue.equals('') and searchName != null and !searchName.equals('')">
				   AND ${searchName} LIKE '%${searchValue}%'
			  </if>
              <if test="useYn !=null and !useYn.equals('')">
     	           AND T.USE_YN = #{useYn}
              </if>	

	</select>

	<select id="selectPrjctList" parameterType="Map" resultType="CamelMap">
		SELECT
			*
		FROM(
			SELECT
				ROWNUM AS RNUM, A.*

			FROM
			(
				SELECT T.PRJCT_SEQ
							, T.CO_CD
							, FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
							, T.YYYYMM
							, T.INPEXP_CD
							, FN_CM05M01_CD_TO_NM(T.INPEXP_CD) INPEXP_NM
							, T.NEW_PRDT_CD
							, FN_CM05M01_CD_TO_NM(T.NEW_PRDT_CD) NEW_PRDT_NM
							, T.PRJCT_CD
							, FN_CM05M01_CD_TO_NM(T.PRJCT_CD) CD_PRJCT_NM
							, T.PRJCT_NM
							, T.EQP_NM
							, T.CAR_NM
							, T.EQP_QTY
							, T.CLNT_CD
							, A.CLNT_NM
							, T.CLNT_MNG_NM
							, T.ODR_CD
							, FN_CM05M01_CD_TO_NM(T.ODR_CD) ODR_NM
							, T.ODR_RMK
							, T.EPCT_AMT
							, T.ORDRS_PLAN_AMT
							, T.WINBD_CD
							, T.WINBD_RMK
							, TO_CHAR(T.ORDRS_PLAN_DT, 'YYYY-MM-DD') AS ORDRS_PLAN_DT
							, T.ORDRS_AMT
							, TO_CHAR(T.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT
							, TO_CHAR(T.DUDT_PLAN_DT, 'YYYY-MM-DD') AS DUDT_PLAN_DT
							, T.MNG_ID
							, B.NAME as MNG_NM
							, T.PRJCT_RMK
							, T.ORDRS_PCT
							, T.CREAT_ID
							, T.CREAT_PGM
							, T.CREAT_DTTM
							, T.UDT_ID
							, T.UDT_PGM
							, T.UDT_DTTM
							, T.MAKR_CD
							, T.USE_YN
							, T.ORDRS_PCT
				  FROM TB_BM06M01 T
           						LEFT OUTER JOIN TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
           						LEFT OUTER JOIN TB_CM06M01 B ON T.MNG_ID = B.ID
		         WHERE 1=1
              <if test="coCd !=null and !coCd.equals('')">
     	           AND T.CO_CD = #{coCd}
              </if>
			   <if test="reqDtFrom != null and !reqDtFrom.equals('') and  reqDtTo != null and !reqDtTo.equals('')" >
				   AND T.ORDRS_DT BETWEEN TO_DATE( #{reqDtFrom},'YYYYMMDD') AND TO_DATE( #{reqDtTo},'YYYYMMDD') +1
			  </if>
			  <if test="searchValue != null and !searchValue.equals('') and searchName != null and !searchName.equals('')">
				   AND ${searchName} LIKE '%${searchValue}%'
			  </if>
              <if test="useYn !=null and !useYn.equals('')">
     	           AND T.USE_YN = #{useYn}
              </if>			  			  
		         ORDER BY T.CO_CD, T.YYYYMM, A.CLNT_NM, T.INPEXP_CD, T.PRJCT_SEQ
				) AS a
			) A
		WHERE  RNUM BETWEEN #{firstIndex} AND #{lastIndex}

	</select>

  <resultMap id="resultInfoMap" type="CamelMap">
    <collection select="selectItemList" property="ITEM_LIST" column="{prjctSeq=PRJCT_SEQ}" ofType="CamelMap"/>
    <collection select="selectPrdtList" property="PRDT_LIST" column="{prjctSeq=PRJCT_SEQ}" ofType="CamelMap"/>
<!--     <collection select="selectFileList" property="FILE_LIST" column="{fileTrgtKey=PRJCT_SEQ}" ofType="CamelMap"/> -->
  </resultMap>


  <select id="selectPrjctInfo" resultMap="resultInfoMap">
              SELECT PRJCT_SEQ
					 , T.CO_CD
                     , T.INPEXP_CD
                     , FN_CM05M01_CD_TO_NM(T.INPEXP_CD) INPEXP_NM
					 , T.NEW_PRDT_CD
                     , FN_CM05M01_CD_TO_NM(T.NEW_PRDT_CD) NEW_PRDT_NM
					 , T.CLNT_CD
					 , A.CLNT_NM
					 , T.CLNT_MNG_NM
					 , T.PRJCT_NM
					 , T.EQP_NM
					 , T.EQP_QTY
					 , T.ODR_CD
					 , T.ODR_RMK
					 , T.EPCT_AMT
					 , T.ORDRS_PLAN_AMT
					 , T.WINBD_RMK
					 , TO_CHAR(T.ORDRS_PLAN_DT, 'YYYY-MM-DD') AS ORDRS_PLAN_DT
					 , T.ORDRS_AMT
					 , T.WINBD_CD
					 , TO_CHAR(T.ORDRS_DT, 'YYYY-MM-DD') AS ORDRS_DT
					 , TO_CHAR(T.DUDT_PLAN_DT, 'YYYY-MM-DD') AS DUDT_PLAN_DT
					 , T.MNG_ID
					 , B.NAME as MNG_NM
					 , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
					 , SUBSTR(T.YYYYMM,1,4) || '-' || SUBSTR(T.YYYYMM,5,2) AS YYYYMM
					 , T.PRJCT_CD
					 , T.PRJCT_RMK
					 , T.CREAT_ID
					 , T.CREAT_PGM
					 , TO_CHAR(T.CREAT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS CREAT_DTTM
					 , T.UDT_ID
					 , T.UDT_PGM
					 , TO_CHAR(T.UDT_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS UDT_DTTM
           			 , ORDRS_PCT
        FROM TB_BM06M01 T 
             LEFT OUTER JOIN TB_BM02M01 A ON T.CLNT_CD = A.CLNT_CD
             LEFT OUTER JOIN TB_CM06M01 B ON T.MNG_ID = B.ID
       WHERE PRJCT_SEQ = #{prjctSeq}
  </select>

  <select id="selectItemList" resultType="CamelMap">
	SELECT nvl2(b.PRJCT_PRDT_CD,'Y','N') IS_CHK
        , B.PRJCT_ITEM_CD
        , PRJCT_SEQ
        , PRJCT_PRDT_CD
        , PRJCT_ITEM_CD
        , PRJCT_ITEM_RMK
        , CODE_ID
        , CODE_NM
        , CODE_ETC
      FROM 
      		(SELECT *
               FROM TB_CM05M01
              WHERE CODE_KIND = 'ITEMLIST'
                AND USE_YN    = 'Y'
             ) a LEFT OUTER join
	            (SELECT *
	               FROM TB_BM06D02
	              WHERE PRJCT_SEQ = #{prjctSeq}
	                AND PRJCT_PRDT_CD = #{prjctPrdtCd , jdbcType=VARCHAR}
	             ) b
         		ON a. CODE_ID = b.PRJCT_ITEM_CD
   ORDER BY IS_CHK DESC
  </select>

  <select id="selectPrdtList" resultType="CamelMap">
   SELECT 
          a.PRJCT_SEQ
        , a.PRJCT_PRDT_CD
        , b.PRDT_NM        
        , a.PRJCT_PRDT_QTY
        , a.PRJCT_INPEXP_CD
        , FN_CM05M01_CD_TO_NM(a.PRJCT_INPEXP_CD) PRJCT_INPEXP_NM
        , a.PRJCT_PRDT_NEW_CD
        , FN_CM05M01_CD_TO_NM(a.PRJCT_PRDT_NEW_CD) PRJCT_PRDT_NEW_NM 
        , TO_CHAR(a.PRJCT_PRDT_ORDRS_DT, 'YYYY-MM-DD') AS PRJCT_PRDT_ORDRS_DT
        , TO_CHAR(a.PRJCT_PRDT_PLAN_DT, 'YYYY-MM-DD') AS PRJCT_PRDT_PLAN_DT
        , a.PRJCT_PRDT_RMK
     FROM TB_BM06D01 a LEFT OUTER JOIN TB_BM01M01 b 
                                               ON a.PRJCT_PRDT_CD = b.PRDT_CD
    WHERE a.PRJCT_SEQ = #{prjctSeq}

  </select>

  <select id="selectConfirmCount" parameterType="Map" resultType="int">
    SELECT COUNT(PRJCT_SEQ) CNT
      FROM TB_BM06M01
     WHERE PRJCT_SEQ = #{prjctSeq}
  </select>
  
  <select id="selectFileList" resultType="CamelMap">
    SELECT *
      FROM TB_CM08M01
     WHERE FILE_TRGT_TYP = 'TB_BM06M01'
       AND FILE_TRGT_KEY = #{fileTrgtKey}
  </select>

<update id="updatePrjct" parameterType="Map">
    UPDATE TB_BM06M01
          SET
          CO_CD                                         = #{coCd}
        , YYYYMM                                        = #{yyyymm}
        , PRJCT_CD                                      = #{prjctCd}
        , PRJCT_NM                                      = #{prjctNm}
        , INPEXP_CD                                     = #{inpexpCd}
        , NEW_PRDT_CD                                   = #{newPrdtCd}
        , EQP_NM                                        = #{eqpNm}
        , EQP_QTY                                       = #{eqpQty}
		, CAR_NM=''
        , CLNT_CD                                       = #{clntCd}
        , CLNT_MNG_NM                                   = #{clntMngNm}
        , ODR_CD                                        = #{odrCd}
        , ODR_RMK                                       = #{odrRmk, jdbcType=VARCHAR}
        , EPCT_AMT                                      = #{epctAmt}
        , ORDRS_PLAN_AMT                                = #{ordrsPlanAmt}
        , WINBD_CD                                      = #{winbdCd}
        , WINBD_RMK                                     = #{winbdRmk}
        , ORDRS_PLAN_DT                                 = #{ordrsPlanDt}
        , ORDRS_AMT                                     = #{ordrsAmt}
        , ORDRS_DT                                      = #{ordrsDt}
        , DUDT_PLAN_DT                                  = #{dudtPlanDt}
        , MNG_ID                                        = #{mngId}
        , PRJCT_RMK                                     = #{prjctRmk, jdbcType=VARCHAR}
		, USE_YN=''        
        , ORDRS_PCT                                     = #{ordrsPct}
		, MAKR_CD=''
        , UDT_ID                                        = #{userId}
        , UDT_PGM                                       = #{pgmId}
        , UDT_DTTM                                      = SYSDATE
    WHERE PRJCT_SEQ                                     = #{prjctSeq}


  </update>

<insert id="insertPrjct" parameterType="Map">
    <selectKey keyProperty="prjctSeq" resultType="String" order="BEFORE">
      SELECT TO_CHAR(SYSDATE, 'YYYYMM')||LPAD(TB_BM06M01_SQ01.NEXTVAL,3,0) FROM DUAL
    </selectKey>
    INSERT INTO TB_BM06M01
      (
           PRJCT_SEQ
		, CO_CD         
		, YYYYMM        
		, PRJCT_CD      
		, PRJCT_NM      
		, INPEXP_CD     
		, NEW_PRDT_CD   
		, EQP_NM        
		, EQP_QTY       
		, CAR_NM
		, CLNT_CD       
		, CLNT_MNG_NM   
		, ODR_CD        
		, ODR_RMK       
		, EPCT_AMT      
		, ORDRS_PLAN_AMT
		, WINBD_CD      
		, WINBD_RMK     
		, ORDRS_PLAN_DT 
		, ORDRS_AMT     
		, ORDRS_DT      
		, DUDT_PLAN_DT  
		, MNG_ID        
		, PRJCT_RMK     
		, USE_YN     
		, ORDRS_PCT     
		, MAKR_CD
		, UDT_ID
		, UDT_PGM
		, UDT_DTTM
      )
    VALUES
    (
		  #{prjctSeq}
		, #{coCd}
		, #{yyyymm}
		, #{prjctCd}
		, #{prjctNm}
		, #{inpexpCd}
		, #{newPrdtCd}
		, #{eqpNm}
		, #{eqpQty}
		, #{carNm, jdbcType=VARCHAR}
		, #{clntCd}
		, #{clntMngNm}
		, #{odrCd}
		, #{odrRmk, jdbcType=VARCHAR}
		, #{epctAmt}
		, #{ordrsPlanAmt}
		, #{winbdCd}
		, #{winbdRmk}
		, #{ordrsPlanDt}
		, #{ordrsAmt}
		, #{ordrsDt}
		, #{dudtPlanDt}
		, #{mngId}
		, #{prjctRmk, jdbcType=VARCHAR}
		, #{usrYn, jdbcType=VARCHAR}
		, #{ordrsPct}
		, #{makrCd, jdbcType=VARCHAR}
		, #{userId}
		, #{pgmId}
		, SYSDATE
    )
  </insert>
  
  <insert id="insertPrjctPrdt" parameterType="Map">
    INSERT INTO TB_BM06D01
    (
           PRJCT_SEQ
         , PRJCT_PRDT_CD
         , PRJCT_PRDT_QTY
         , PRJCT_INPEXP_CD
         , PRJCT_PRDT_NEW_CD
         , PRJCT_PRDT_ORDRS_DT
         , PRJCT_PRDT_PLAN_DT
         , PRJCT_PRDT_RMK
      )
    VALUES
    (
           #{prjctSeq}
         , #{prjctPrdtCd}
         , #{prjctPrdtQty}
         , #{prjctInpexpCd}
         , #{prjctPrdtNewCd}
         , #{prjctPrdtOrdrsDt}
         , #{prjctPrdtPlanDt}
         , #{prjctPrdtRmk, jdbcType=VARCHAR}      
    )
  </insert>
  
  <insert id="insertPrjctDtl" parameterType="Map">

    INSERT INTO TB_BM06D02
    (
           PRJCT_SEQ
         , PRJCT_PRDT_CD
         , PRJCT_ITEM_CD
         , PRJCT_ITEM_RMK
      )
    VALUES
    (
        #{prjctSeq}
      , #{prjctPrdtCd}
      , #{prjctItemCd}
      , #{prjctItemRmk, jdbcType=VARCHAR}
    )
  </insert>
  
  <update id="updatePrjctPrdt" parameterType="Map">
    UPDATE TB_BM06D01
       SET
           PRJCT_PRDT_QTY		= #{prjctPrdtQty}
         , PRJCT_INPEXP_CD		= #{prjctInpexpCd}
         , PRJCT_PRDT_NEW_CD	= #{prjctPrdtNewCd}
         , PRJCT_PRDT_ORDRS_DT	= #{prjctPrdtOrdrsDt}
         , PRJCT_PRDT_PLAN_DT	= #{prjctPrdtPlanDt}
         , PRJCT_PRDT_RMK		= #{prjctPrdtRmk, jdbcType=VARCHAR}
     WHERE PRJCT_SEQ           = #{prjctSeq}
           AND PRJCT_PRDT_CD   = #{prjctPrdtCd}
  </update>

  <update id="updatePrjctDtl" parameterType="Map">
    UPDATE TB_BM06D02
       SET
           PRJCT_ITEM_RMK  = #{prjctItemRmk, jdbcType=VARCHAR}
     WHERE PRJCT_SEQ       = #{prjctSeq}
       AND PRJCT_PRDT_CD   = #{prjctPrdtCd}
       AND PRJCT_ITEM_CD   = #{prjctItemCd}
  </update>


  <delete id="deletePrjct" parameterType="Map">
    DELETE TB_BM06M01 WHERE PRJCT_SEQ = #{prjctSeq};
  </delete>
  
  <delete id="deletePrjctPrdtSeqAll" parameterType="Map">
    DELETE TB_BM06D01 WHERE PRJCT_SEQ = #{prjctSeq};
  </delete>
  
  <delete id="deletePrjctDtlSeqAll" parameterType="Map">
    DELETE TB_BM06D02 WHERE PRJCT_SEQ = #{prjctSeq};
  </delete>
  
  
  <delete id="deletePrjctPrdt" parameterType="Map">
    DELETE TB_BM06D01
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd};
  </delete>
  
  <delete id="deletePrjctDtlPrdtAll" parameterType="Map">
    DELETE TB_BM06D02
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd};
  </delete>

  <delete id="deletePrjctDtl" parameterType="Map">
    DELETE TB_BM06D02
     WHERE PRJCT_SEQ     = #{prjctSeq}
       AND PRJCT_PRDT_CD = #{prjctPrdtCd}
       AND PRJCT_ITEM_CD = #{prjctItemCd}
  </delete>
  
</mapper>