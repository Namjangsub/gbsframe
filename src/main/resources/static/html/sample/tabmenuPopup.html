<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script type="text/javascript" src="/static/js/tinymce/tinymce.min.js"></script>

 
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body, div, ul, li { margin: 0; padding: 0; }
        ul, li { list-style: none; }

        .modal-body {
            padding: 10px;
            height: calc(100% - 40px); /* 헤더 높이만큼 뺀 값 */
            overflow-y: auto; /* 세로 스크롤바 생성 */
        }
		
		/*tab css*/
		.tab{float:left; width:100%; height:290px; margin-bottom: 20px; /* 탭과 아래 컨텐츠 사이 여백 */}
		.tabnav{font-size:0; width:100%; border:1px solid #ddd;margin-bottom: -1px; 
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;/* 중복 경계 제거 */}
		.tabnav li{display: inline-block;  height:30px; text-align:center; border-right:1px solid #ddd;}
		.tabnav li a:before{content:""; position:absolute; left:0; top:0px; width:100%; height:3px; }
		.tabnav li a.active:before{background:#7ea21e;}
		.tabnav li a.active{border-bottom:1px solid #fff;}
		.tabnav li a{ position:relative; display:block; background: #f8f8f8; color: #000; padding:0 10px; line-height:30px; text-decoration:none; font-size:12px;}
		.tabnav li a:hover,
		.tabnav li a.active{background:#fff; color:#7ea21e; }
		.tabcontent{padding: 2px; height:600px; border:1px solid #ddd; border-top:none; }
		
        .tabcontainer {
            margin-top: 20px; /* 탭 컨텐츠와 상단 사이의 여백 */
        }
        .mce-content-body {
            max-height: 700px;
            overflow-y: auto;
        }
    </style>
</head>


<body>

<!-- 모달 폼 -->
<div class="modal-body">
	<form id="popForm" onSubmit="return false;">
	<input type="hidden" id="pgmId"     	name="pgmId"	value="CR5001P01">
	<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
	<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->		
	
   	<div class="popup_area of_a" style="width: 100%; height: 100%;">
	    <div class="tit_contents">
	      <h4 class="tit" id="pfuPopTit">설비 기본정보</h4>
	    </div>
	    <div class="form-group popup_table">
	 		<table>
	
		        <colgroup>
		          <col width="10%">
		          <col width="23%">
		          <col width="11%">
		          <col width="23%">
		          <col width="10%">
		          <col width="23%">
		          <col width="10%">
		          <col width="23%">
		        </colgroup>
		        <tr>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
						</select>
					</td>
					<th>고객사</th>
					<td><input type="hidden" id="clntCd" name="clntCd" msg="고객사">
						<input type="text" id="clntNm" name="clntNm" msg="고객사" class="form-control" readonly>
					</td>
					<th>고객사PJT</th>
					<td><input type="hidden" id="clntPjt" name="clntPjt" msg="고객사PJT">
						<input type="text" id="clntPjtNm" name="clntPjtNm" msg="고객사PJT" class="form-control" readonly> 
					</td>
					<th>PFU번호</th>
					<td>
						<input type="text" id="fileTrgtKey" name="fileTrgtKey" msg="PFU번호" class="form-control" readonly>
					</td>
		        </tr>
		        
		        <tr>
					<th class="hit">수주번호</th>
					<td>
						<div class="search_form" >
							<input type="hidden"  id="ordrsCoCd" name="ordrsCoCd"  readonly="readonly">
							<input type="text"  id="ordrsNo" name="ordrsNo" readonly="readonly" required msg="수주번호">
							<a onclick="popOpendOrdrsSearch($('#ordrsNo').val(), $('#ordrsCoCd').val());"><i class="i_search_w" ></i></a>
						</div>
					</td>
					<th class="hit">Sales Code</th>
					<td colspan=3>
						<div class="search_form">
							<input type="text" id="salesCds" name="salesCds" msg="Sales Code" class="form-control" required> 
							<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>연구소접수일</th>
					<td>
						<input type="text" id="rndAcceptDt" name="rndAcceptDt" msg="연구소접수일" class="form-control" readonly> 
					</td>
		        </tr>
		        
		        <tr>
					<th class="hit">장비명</th>
					<td colspan=3>
						<input type="text" id="ctrtNm" name="ctrtNm" msg="장비명" class="form-control" required> 
					</td>
		            <th class="hit" title="운송조건을 확인합니다">운송조건</th>
		            <td>
						<input type="text" id="transOpt" name="transOpt" msg="운송조건" class="form-control" required> 
		            </td>
					<th class="hit">포장/물류정보</th>
					<td>
						<input type="text" id="transInfo" name="transInfo" msg="포장/물류정보" class="form-control" required> 
		            </td>
		        </tr>
		        
		        <tr>
					<th class="hit">장비Type</th>
					<td colspan=1>
                       	<select id="prdtTyp" name="prdtTyp" data-kind="PFU" class="form-control" required msg="장비Type">
                       	</select>
					</td>
					<th class="hit">계약일자</th>
					<td>
						<input id="ctrtDt" name="ctrtDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
					<th class="hit" title="고객담당 정보를 확인합니다">고객담당</th>
					<td>
						<input type="text" id="clntMngNm" name="clntMngNm" msg="고객담당" class="form-control" required> 
					</td>
					<th class="hit">설치주소</th>
					<td>
						<input type="text" id="installAddr" name="installAddr" msg="설치주소" class="form-control" required> 
		            </td>
		        </tr>
		        
		        <tr>
					<th class="hit">제품군</th>
					<td colspan=1>
                       	<select id="prdtDiv" name="prdtDiv" data-kind="PRDTDIV" class="form-control" required msg="제품군">
                       	</select>
					</td>
					<th class="hit">조립완료일자</th>
					<td>
						<input id="prdctnDt" name="prdctnDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
		            <th class="hit" title="고객 E-Mail을 확인합니다">고객 E-Mail</th>
		            <td>
						<input type="text" id="clntMngEmail" name="clntMngEmail" msg="고객 E-Mail" class="form-control" required> 
		            </td>
					<th class="hit">입구Spec</th>
					<td>
		                <div style="display: flex; align-items: center;">
						폭 :　 <input type="text" id="gateWidth" name="gateWidth" msg="입구Spec 폭" class="form-control" style="width:50px;" required>M　　
						높이 :　 <input type="text" id="gateHeight" name="gateHeight" msg="입구Spec 높이" class="form-control"  style="width:50px;" required> M
		                </div>
		            </td>
		        </tr>
		        
		        <tr>
		            <th class="hit" title="담당자 정보를 확인합니다">영업담당자</th>
		            <td>
		                <div class="search_form">
		                    <input type="text" id="mngIdNm" name="mngIdNm" onkeydown="if(event.keyCode==13)openUserTree( this.value);" required readonly>
		                    <input type="hidden" id="mngId" name="mngId" required msg="영업담당자" readonly>
		                    <!--  <a onclick="openUserTree( document.getElementById('mngIdNm').value);"><i class="i_search_w"></i></a> -->
		                </div>
		            </td>
					<th class="hit">T/O완료일자</th>
					<td>
						<input id="acptncDt" name="acptncDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
		            <th class="hit" title="고객전화번호를 확인합니다">고객전화번호</th>
		            <td>
						<input type="text" class="form-control" id="clntMngHp" name="clntMngHp" onkeyup="telNumberFormatter(this);" maxlength="13"> 
		            </td>
					<th class="hit">이동장치</th>
					<td>
						<input type="text" id="transVehicle" name="transVehicle" msg="이동장치" class="form-control" required> 
		            </td>
		        </tr>
			</table>
		</div>
	</div>
		
	
  <div class="tab">
    <ul class="tabnav">
      <li><a href="#tab01">1.PFU 기본정보</a></li>
      <li><a href="#tab02">2.PFU 설비기본 CHECK사양(1)</a></li>
      <li><a href="#tab05">2.PFU 설비기본 CHECK사양(2)</a></li>
      <li><a href="#tab03">3.PFU 사용 부품 MAKER</a></li>
      <li><a href="#tab04">4.PFU 세부 CHECK 사양</a></li>
      <li><a href="#tab09">5.PFU 첨부파일</a></li>
    </ul>
    
<!-- 	Tab 컨텐츠 -->
    <div class="tabcontent">
      <div id="tab01">
	      <div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">1. PFU 기본정보</h4>
		    </div>
			    <div class="form-group popup_table">
			 		<table>
			
			        <colgroup>
			          <col width="10%">
			          <col width="23%">
			          <col width="11%">
			          <col width="23%">
			          <col width="10%">
			          <col width="23%">
			          <col width="10%">
			          <col width="23%">
			        </colgroup>
			        <tr>
						<!-- 콘텐츠 -->
						<div class="contents">
						    <!-- 리스트 -->
						    <div class="ax5_grid">
				              <div class="table_list_tit">
				                  <h5 class="tit">제품 기본정보</h5>
				                  <div class="add_btn_small">
				                      <a onclick= "insertList(AREA01GridView);" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 정보추가</a>
				                      <a onclick= "deleteList(AREA01GridView)" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택정보삭제 </a>
				                  </div>
				              </div>
				              <div>
				              	<div data-ax5grid="AREA01-grid" data-ax5grid-config="{}" style="height:200px; width: 100%" ></div>
				              </div>
						    </div>
						</div>
			        </tr>
			        <tr>
			        	<th  colspan="8">
						      <h4 class="tit">제품 정보(작업포인트) - 형상이미지 파일 첨부</h4>
						</th>
			        </tr>
			        <tr>
						<td colspan="8">
							<textarea id="ctrtRmk" name="ctrtRmk"  msg="제품 정보(작업포인트)">제품 정보(작업포인트)</textarea>
						</td>			
			        </tr>
			      </table>
			      
			</div>
      	</div>
      
      </div><!-- tab01 -->
      
      <div id="tab02">
		<div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">2.PFU 설비기본 CHECK사양</h4>
		    </div>
		
				<!-- 콘텐츠 -->
				<div class="contents">
				    <!-- 리스트 -->
				    <div class="ax5_grid">
		              <div class="table_list_tit">
		                  <h5 class="tit">사용 부품 MAKER</h5>
		                  <div class="add_btn_small">
		                      <a onclick= "insertList(AREA02GridView);" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 부품추가</a>
		                      <a onclick= "deleteList(AREA02GridView)" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택부품삭제 </a>
		                  </div>
		              </div>
		              <div>
		              	<div data-ax5grid="AREA02-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
		              </div>
				    </div>
				</div>
				
		  </div>
		</div><!-- tab02 -->
      
      <div id="tab05">
		<div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">2.PFU 설비기본 CHECK사양(2)</h4>
		    </div>
		
		 		<table>
		        <colgroup>
		          <col width="10%">
		          <col width="23%">
		          <col width="10%">
		          <col width="23%">
		          <col width="10%">
		          <col width="24%">
		        </colgroup>
		
		        <tr>
		        	<th  colspan="6">
					      <h4 class="tit">[ 고객 요청 사항 ]</h4>
					</th>
		        </tr>
		        
		        <tr>
					<td colspan="6">
						<textarea id="custReq" name="custReq"  msg="고객 요청 사항">고객 요청 사항</textarea>
					</td>			
		        </tr>
		
		        <tr>
		        	<th  colspan="6">
					      <h4 class="tit">[ SPARE LIST ]</h4>
					</th>
		        </tr>
		        
		        <tr>
					<td colspan="6">
						<textarea id="spareList" name="spareList"  msg="SPARE LIST">SPARE LIST</textarea>
					</td>			
		        </tr>
		
		        <tr>
		        	<th  colspan="6">
					      <h4 class="tit">[ 특기사항 ] ※별도기록사항 (ex:부대창치, 고객사 사급품, 연계장비 등)</h4>
					</th>
		        </tr>
		        
		        <tr>
					<td colspan="6">
						<textarea id="pfuEtc" name="pfuEtc"  msg="특기사항">특기사항</textarea>
					</td>			
		        </tr>
		      </table>
		  </div>
		</div><!-- tab05 -->
      
      
        <div id="tab03">
			<div class="popup_area of_a" style="width: 100%; height: 100%;">
			    <div class="tit_contents">
			      <h4 class="tit">3. 사용 부품 MAKER</h4>
			    </div>
				<!-- 콘텐츠 -->
				<div class="contents">
				    <!-- 리스트 -->
				    <div class="ax5_grid">
		              <div class="table_list_tit">
		                  <h5 class="tit">사용 부품 MAKER</h5>
		                  <div class="add_btn_small">
		                      <a onclick= "insertList(AREA03GridView);" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 부품추가</a>
		                      <a onclick= "deleteList(AREA03GridView)" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택부품삭제 </a>
		                  </div>
		              </div>
		              <div>
		              	<div data-ax5grid="AREA03-grid" data-ax5grid-config="{}" style="height:500px; width: 100%" ></div>
		              </div>
				  </div>
				</div>
			    
			</div>
		      
        </div>
      
        <div id="tab04">
		<div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">4.PFU 세부 CHECK사양</h4>
		    </div>
		
				<!-- 콘텐츠 -->
				<div class="contents">
				    <!-- 리스트 -->
				    <div class="ax5_grid">
		              <div class="table_list_tit">
		                  <h5 class="tit">세부 CHECK사양</h5>
		                  <div class="add_btn_small">
		                      <a onclick= "insertList(AREA04GridView);" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 사양추가</a>
		                      <a onclick= "deleteList(AREA04GridView)" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택사양삭제 </a>
		                  </div>
		              </div>
		              <div>
		              	<div data-ax5grid="AREA04-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
		              </div>
				    </div>
				</div>
		  </div>
        </div>
      
	    <div id="tab09">
			<div class="popup_area of_a" style="width: 100%; height: 100%;">
			    <div class="tit_contents">
			      <h4 class="tit">5. PFU 첨부파일</h4>
			    </div>
				<!-- 공통 파일 영역 -->
				<div id="fileList_area" style="margin-top: 0px;"></div>
			</div>
	    </div><!-- tab09 -->
      </div><!--tabcontent-->
  </div><!--tab-->
</form>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" onclick="setReportMain();"><i class="fas fa-envelope"></i> PFU 출력</button>
		<button type="button" id="mailSendBtn" onclick="sendMailCall();" authChk><i class="fas fa-envelope"></i> 기타발주서메일</a></button>
	</div>

</div>
<script>
	var tabArrInit = {tab1:true, tab2:true, tab3:true, tab4:true, tab9:true};
	var thisGridRow=0; // 선택된 행 정보 저장할 변수
	var thisGridCol=0; // 선택된 열 정보 저장할 변수
	var paramActionType = modalStack.last().paramObj.actionType

	ax5.ui.grid.formatter["changeYn"] = function () {
		var color = this.value == "N" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E") {
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};

	function gridStyle(row) {
		if (!row) return "";
		if (row.updChk === "D")  return "grid-font-red";
		if (row.matrError === "E")  return "grid-no-msg-font-blue-bold";
		if (pasFloatChk(row.lowerQty) == 0)  return "grid-no-msg-font-blue-bold";
		if (pasFloatChk(row.pchsBomCnt) > 0)  return "grid-font-red";
		return "";
	}

	//1. PFU 기본정보
	var AREA01GridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber    : true,
				showRowSelector   : true,
				multipleSelect    : true,
				sortable: false,
				target: $('[data-ax5grid="AREA01-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function (columnIndex, rowData) {
						this.self.clearSelect();
						this.self.select(this.dindex);
						prdtIdx = this.dindex;
						thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
						thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
						
						var clickedRowIndex = this.dindex;
						var clickedRowElement = this.self.bodyRowTable;
						
					},
					onDBLClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDataChanged: function () {
						if (this.key == "lowerCd") {
							AREA01GridView.target.repaint();   //수정내용 적용하기
						}

						if (this.item.__selected__ == true) {
							prdtIdx = this.dindex;
						}
					},
					mergeCells : ["partDivNm"],
				},
				columns : [
					{key : "partNm", 	label : "구분", 				width : 400,	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partStd", 	label : "FRT", 				width : 300, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partCust", 	label : "RR", 				width : 300, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partEtc", 	label : "비고", 				width : 300, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "changeYn", 	label : "구매수정", 			width : 80,  hidden: true },
		            {key : "updChk", 	label : "updChk", 			width : 80,  hidden: true},
		            {key : "prdtDiv", 	label : "제품분류", 			width : 80,  hidden: true},
		            {key : "areaDiv", 	label : "구매수정", 			width : 80,  hidden: true},
		            {key : "partDiv", 	label : "구매수정", 			width : 80,  hidden: true},
					{key : "partId", 	label : "코드ID", 			width : 80,	 hidden: true},
				],
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 2, label: "줄추가"},
						// {type: 3, label: "내용 삭제"},
						{type: 4, label: "줄삭제"},
					],
					popupFilter: function (item, param) {
						//console.log(item, param);
						if(param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param) {
						// console.log(item, param);
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;
						if (item.label == "붙여넣기") {
// 							console.log('붙여넣기 인덱스 :', thisGridRow, thisGridCol);
							gridPaste(AREA01GridView, thisGridRow, thisGridCol);
						} else if (item.label == "줄추가") {
// 							console.log('추가 인덱스 :', param.dindex);
							//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
							//깊은 복사를 해야 값이 바뀌지 않음~~~~주의 필요
							let tempRow = JSON.parse(JSON.stringify(AREA01GridView.target.list[param.dindex]));
							tempRow.updChk  		= "I";
							AREA01GridView.target.addRow(tempRow,param.dindex+1,);
						} else if (item.label == "줄삭제") {
							// console.log('삭제 인덱스 :', param.dindex);
							AREA01GridView.target.clearSelect();	//선택된 모든 row 선택 해제
							AREA01GridView.target.select(param.dindex);	//현재 클릭한 row 선택
							//삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
							// AREA01GridView.target.removeRow(param.dindex);
							deleteList(AREA01GridView);
						}
						AREA01GridView.target.contextMenu.close();
						//또는 return true;
					}
				},        // contextMenu
			});
			return this;
		},
		setData: function(chk) {
			var target = this.target;
			var formData = {
				"userId" 	: jwt.userId,
				"clntCd" 	: $("#clntCd").val(),
				"ordrsNo" 	: $("#ordrsNo").val(),
				"salesCd" 	: $("#salesCd").val(),
				"prdtDiv" 	: 'PFU01',
				"areaDiv" 	: 'PFUAREA01',
				"fileTrgtKey"	: $("#fileTrgtKey").val(),
			}
			postAjax("/user/cr/cr50/selectPFUAreaItemList", formData, null, function(data) {
				var list = data.result;
				target.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
			});
		} //setData
	}
	

	//2.PFU 설비기본 CHECK사양
	var AREA02GridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber    : true,
				showRowSelector   : true,
				multipleSelect    : true,
				sortable: false,
				target: $('[data-ax5grid="AREA02-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function (columnIndex, rowData) {
						this.self.clearSelect();
						this.self.select(this.dindex);
						thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
						thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
						
					},
					onDBLClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDataChanged: function () {
						if (this.key == "partNm") {
						}
					},
				},
				columns : [
					{key : "partNm", 	label : "설비구분", 			width : 400,	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partStd", 	label : "건양표준", 			width : 400, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
// 					{key : "partCust", 	label : "고객요청", 			width : 260, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partConf", 	label : "확정", 				width : 400, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partEtc", 	label : "비고", 				width : 200, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "changeYn", 	label : "수정", 				width : 80,  hidden: true},
		            {key : "updChk", 	label : "updChk", 			width : 80,  hidden: true},
		            {key : "prdtDiv", 	label : "제품분류", 			width : 80,  hidden: true},
		            {key : "areaDiv", 	label : "영역구분", 			width : 80,  hidden: true},
		            {key : "partDiv", 	label : "PART구분", 			width : 80,  hidden: true},
		            {key : "partId", 	label : "코드ID", 			width : 100, hidden: true},
				],
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 2, label: "줄추가"},
						// {type: 3, label: "내용 삭제"},
						{type: 4, label: "줄삭제"},
					],
					popupFilter: function (item, param) {
						//console.log(item, param);
						if(param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param) {
						// console.log(item, param);
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;
						
						if (item.label == "붙여넣기") {
							gridPaste(AREA02GridView, thisGridRow, thisGridCol);
						} else if (item.label == "줄추가") {
							// console.log('추가 인덱스 :', param.dindex);
							//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
							//깊은 복사를 해야 값이 바뀌지 않음~~~~주의 필요
							let tempRow = JSON.parse(JSON.stringify(AREA02GridView.target.list[param.dindex]));
							tempRow.updChk  		= "I";
							AREA02GridView.target.addRow(tempRow,param.dindex+1,);
						} else if (item.label == "줄삭제") {
							// console.log('삭제 인덱스 :', param.dindex);
							AREA02GridView.target.clearSelect();	//선택된 모든 row 선택 해제
							AREA02GridView.target.select(param.dindex);	//현재 클릭한 row 선택
							//삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
							// AREA02GridView.target.removeRow(param.dindex);
							deleteList(AREA02GridView);
						}
						AREA02GridView.target.contextMenu.close();
						//또는 return true;
					}
				},        // contextMenu
			});
			return this;
		},
		setData: function(chk) {
			var target = this.target;
			var formData = {
				"userId" 	: jwt.userId,
				"clntCd" 	: $("#clntCd").val(),
				"ordrsNo" 	: $("#ordrsNo").val(),
				"salesCd" 	: $("#salesCd").val(),
				"prdtDiv" 	: 'PFU01',
				"areaDiv" 	: 'PFUAREA02',
				"fileTrgtKey"	: $("#fileTrgtKey").val(),
			}
			postAjax("/user/cr/cr50/selectPFUAreaItemList", formData, null, function(data) {
				var list = data.result;
// 				if (list.some(obj => obj.matrYn == "Y")) {
// 					// 하위 BOM list 에서 matrYn의 값중에 "Y"가 하나라도 있으면 자재로 설정
// 					$('[name="matrYn"]').filter('[value="Y"]').prop("checked", true);
// 				}
				target.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
			});
		} //setData
	}
	
	
	

	//3.사용 부품 MAKER
	var AREA03GridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber    : true,
				showRowSelector   : true,
				multipleSelect    : true,
				sortable: false,
				target: $('[data-ax5grid="AREA03-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function (columnIndex, rowData) {
						this.self.clearSelect();
						this.self.select(this.dindex);
						thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
						thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
						
					},
					onDBLClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDataChanged: function () {
						if (this.key == "partNm") {
						}
					},
					mergeCells : ["partDivNm"],
				},
				columns : [
		            {key : "partDivNm", label : "PART", 			width : 80,  hidden: false},
					{key : "partNm", 	label : "부품종류", 			width : "*",	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partStd", 	label : "건양표준", 			width : 360, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partCust", 	label : "고객요청", 			width : 360, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partConf", 	label : "확정", 				width : 360, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partEtc", 	label : "기타코드", 			width : 100, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "changeYn", 	label : "수정", 				width : 80,  hidden: true},
		            {key : "updChk", 	label : "updChk", 			width : 80,  hidden: true},
		            {key : "prdtDiv", 	label : "제품분류", 			width : 80,  hidden: true},
		            {key : "areaDiv", 	label : "구매수정", 			width : 80,  hidden: true},
		            {key : "partDiv", 	label : "구매수정", 			width : 80,  hidden: true},
					{key : "partId", 	label : "코드ID", 			width : 80,	 hidden: true},
				],
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 2, label: "줄추가"},
						// {type: 3, label: "내용 삭제"},
						{type: 4, label: "줄삭제"},
					],
					popupFilter: function (item, param) {
						//console.log(item, param);
						if(param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param) {
						// console.log(item, param);
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;
						
						if (item.label == "붙여넣기") {
							gridPaste(AREA03GridView, thisGridRow, thisGridCol);
						} else if (item.label == "줄추가") {
							// console.log('추가 인덱스 :', param.dindex);
							//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
							//깊은 복사를 해야 값이 바뀌지 않음~~~~주의 필요
							let tempRow = JSON.parse(JSON.stringify(AREA03GridView.target.list[param.dindex]));
							tempRow.updChk  		= "I";
							AREA03GridView.target.addRow(tempRow,param.dindex+1,);
						} else if (item.label == "줄삭제") {
							// console.log('삭제 인덱스 :', param.dindex);
							AREA03GridView.target.clearSelect();	//선택된 모든 row 선택 해제
							AREA03GridView.target.select(param.dindex);	//현재 클릭한 row 선택
							//삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
							// AREA03GridView.target.removeRow(param.dindex);
							deleteList(AREA03GridView);
						}
						AREA03GridView.target.contextMenu.close();
						//또는 return true;
					}
				},        // contextMenu
			});
			return this;
		},
		setData: function(chk) {
			var target = this.target;
			var formData = {
				"userId" 	: jwt.userId,
				"clntCd" 	: $("#clntCd").val(),
				"ordrsNo" 	: $("#ordrsNo").val(),
				"salesCd" 	: $("#salesCd").val(),
				"prdtDiv" 	: 'PFU01',
				"areaDiv" 	: 'PFUAREA03',
				"fileTrgtKey"	: $("#fileTrgtKey").val(),
			}
			postAjax("/user/cr/cr50/selectPFUAreaItemList", formData, null, function(data) {
				var list = data.result;
// 				if (list.some(obj => obj.matrYn == "Y")) {
// 					// 하위 BOM list 에서 matrYn의 값중에 "Y"가 하나라도 있으면 자재로 설정
// 					$('[name="matrYn"]').filter('[value="Y"]').prop("checked", true);
// 				}
				target.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
			});
		} //setData
	}
	
	//4.PFU 세부 CHECK사양
	var AREA04GridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber    : true,
				showRowSelector   : true,
				multipleSelect    : true,
				sortable: false,
				target: $('[data-ax5grid="AREA04-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function (columnIndex, rowData) {
						this.self.clearSelect();
						this.self.select(this.dindex);
						thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
						thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
						
					},
					onDBLClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDataChanged: function () {
						if (this.key == "lowerCd") {
							AREA04GridView.target.repaint();   //수정내용 적용하기
						}

						if (this.item.__selected__ == true) {
							prdtIdx = this.dindex;
						}
					},
				},
				columns : [
					{key : "partNm", 	label : "부품종류", 			width : "*",	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partStd", 	label : "건양표준", 			width : 300, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partCust", 	label : "고객요청", 			width : 300, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partConf", 	label : "확정", 				width : 300, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "partEtc", 	label : "기타코드", 			width : 100, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y"; } } },
					{key : "changeYn", 	label : "수정", 				width : 80,  hidden: true},
		            {key : "updChk", 	label : "updChk", 			width : 80,  hidden: true},
		            {key : "prdtDiv", 	label : "제품분류", 			width : 80,  hidden: true},
		            {key : "areaDiv", 	label : "영역구분", 			width : 80,  hidden: true},
		            {key : "partDiv", 	label : "PART구분", 			width : 80,  hidden: true},
		            {key : "partId", 	label : "코드ID", 			width : 100, hidden: true},
				],
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 2, label: "줄추가"},
						// {type: 3, label: "내용 삭제"},
						{type: 4, label: "줄삭제"},
					],
					popupFilter: function (item, param) {
						//console.log(item, param);
						if(param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param) {
						// console.log(item, param);
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;
						if (item.label == "붙여넣기") {
// 							console.log('붙여넣기 인덱스 :', thisGridRow, thisGridCol);
							gridPaste(AREA04GridView, thisGridRow, thisGridCol);
						} else if (item.label == "줄추가") {
// 							console.log('추가 인덱스 :', param.dindex);
							//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
							//깊은 복사를 해야 값이 바뀌지 않음~~~~주의 필요
							let tempRow = JSON.parse(JSON.stringify(AREA04GridView.target.list[param.dindex]));
							tempRow.updChk  		= "I";
							AREA04GridView.target.addRow(tempRow,param.dindex+1,);
						} else if (item.label == "줄삭제") {
							// console.log('삭제 인덱스 :', param.dindex);
							AREA04GridView.target.clearSelect();	//선택된 모든 row 선택 해제
							AREA04GridView.target.select(param.dindex);	//현재 클릭한 row 선택
							//삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
							// AREA04GridView.target.removeRow(param.dindex);
							deleteList(AREA04GridView);
						}
						AREA04GridView.target.contextMenu.close();
						//또는 return true;
					}
				},        // contextMenu
			});
			return this;
		},
		setData: function(chk) {
			var target = this.target;
			var formData = {
				"userId" 	: jwt.userId,
				"clntCd" 	: $("#clntCd").val(),
				"ordrsNo" 	: $("#ordrsNo").val(),
				"salesCd" 	: $("#salesCd").val(),
				"prdtDiv" 	: 'PFU01',
				"areaDiv" 	: 'PFUAREA04',
				"fileTrgtKey"	: $("#fileTrgtKey").val(),
			}
			postAjax("/user/cr/cr50/selectPFUAreaItemList", formData, null, function(data) {
				var list = data.result;
				target.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
			});
		} //setData
	}

    $(document).ready(function () {
    	$('#fileTrgtKey').val('PFU240006');
    	paramActionType = "U";
	    
        setCommonSelect($("select[data-kind]"));
        
        //계약일자
        $('#ctrtDt').datepicker({ format: "yyyy-mm-dd",  language: "ko",  autoclose: true });
        // 조립완료일자
        $('#prdctnDt').datepicker({ format: "yyyy-mm-dd",  language: "ko",  autoclose: true });
        // T/O완료일자
        $('#acptncDt').datepicker({ format: "yyyy-mm-dd",  language: "ko",  autoclose: true });

		
		AREA01GridView.initView().setData();
		AREA02GridView.initView().setData();
		AREA03GridView.initView().setData();
		AREA04GridView.initView().setData();
		
		
		//TAB Menu Control Start-----------------
		$('.tabcontent > div').hide();
		$('.tabnav a').click(function () {
			$('.tabcontent > div').hide().filter(this.hash).fadeIn();
// 			$('.tabcontent > div').hide().filter(this.hash).show();
			$('.tabnav a').removeClass('active');
			$(this).addClass('active');
			
			if ($(this).attr('href') == "#tab01" && tabArrInit.tab1) {
				AREA01GridView.setData(AREA01GridView.target.list);
				tabArrInit.tab1 = false;
			} else if ($(this).attr('href') == "#tab02" && tabArrInit.tab2) {
				AREA02GridView.setData(AREA02GridView.target.list);
				tabArrInit.tab2 = false;
			} else if ($(this).attr('href') == "#tab03" && tabArrInit.tab3) {
				AREA03GridView.setData(AREA03GridView.target.list);
				tabArrInit.tab3 = false;
			} else if ($(this).attr('href') == "#tab04" && tabArrInit.tab4) {
				AREA04GridView.setData(AREA04GridView.target.list);
				tabArrInit.tab4 = false;
			} else  if ($(this).attr('href') == "#tab09" && tabArrInit.tab9) {
				fileTreeGridView.reqSetData(fileTreeGridView.target.list)
				tabArrInit.tab9 = false;
			}
			
			return false;
		}).filter(':eq(0)').click();
		//TAB Menu Control End-----------------
		

		//textarea WYSIWYGHTML 설정하기
// 		WYSIWYGHTML();

	    $("#save").on("click", function(){
	        var content = tinymce.activeEditor.getContent();
	        console.log(content);
	    });
	    

		// 초기화가 완료될 때까지 대기하고 후속 작업 수행
        Promise.all([
    		WYSIWYGHTML('#ctrtRmk', 700),
    		WYSIWYGHTML('#custReq', 500),
    		WYSIWYGHTML('#spareList', 500),
    		WYSIWYGHTML('#pfuEtc', 500),
        ]).then((editors) => {
               	if (paramActionType == "U") {
       				selectPFUInfo();				//PFU 정보 호출
               	}
        }).catch((error) => {
            console.error('Error initializing TinyMCE:', error);
        });
		
	    // tinymce html 편집기 end ----------------------------------------------------------
	    

		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (paramActionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertPFU();
			});

		} else if (paramActionType == "U") {
			$('#pfuPopTit').text('설비 기본정보 수정');
// 			selectPFUInfo();				//PFU 정보 호출 (WYSIWYGHTML 초기화가 끝나면 자료를 가져와서 화면에 뿌려줍니다.)

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updatePFU();
			});
		}



	    // 그리드 내용 붙여넣기 이벤트 처리-->간헐적 실행으로 오작동~~~ 원인을 모르겠음 아래이벤트로 대체
	    // Ctrl + V 단축키 이벤트 처리
		AREA01GridView.target.$target.on("paste", function (e, a) { gridPaste(AREA01GridView, thisGridRow, thisGridCol); });
		AREA02GridView.target.$target.on("paste", function (e, a) { gridPaste(AREA02GridView, thisGridRow, thisGridCol); });
		AREA03GridView.target.$target.on("paste", function (e, a) { gridPaste(AREA03GridView, thisGridRow, thisGridCol); });
		AREA04GridView.target.$target.on("paste", function (e, a) { gridPaste(AREA04GridView, thisGridRow, thisGridCol); });
		
        
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey	: $("#fileTrgtKey").val()
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//--------------------------------------------------------------- 
		$("#fileAttachTxt").click(); //파일첨부내역 활성화 

		authChk();						// 권한체크

	});
    
 	// 출력 버튼용
	function setReportMain() {
		let fileName = "aaaClobTest.jrf";
		let arg = "coCd#" + $("#coCd").val() + "#partNo#" + "B"
             	+ "#";
		callReport(fileName, arg, "1050", "700", "PFU출력" + "B");
	}
    
	function gridPaste(gridView, thisGridRow, thisGridCol) {
	    navigator.clipboard.readText().then(pasteData => {
	        if (pasteData === undefined || pasteData === "" || thisGridRow === undefined) {
	            return;
	        }

	        // 붙여넣기할 데이터를 배열로 변환한다.
	        pasteData = (pasteData.charAt(pasteData.length - 1) === "\n") ? pasteData : pasteData + "\n";
	        var pasteRows = pasteData.split("\n").map(function (row) {
	            return row.split("\t");
	        });

	        // 붙여넣기를 시작할 셀의 인덱스를 구한다.
	        var startRowIndex = thisGridRow;
	        var startColIndex = thisGridCol;

	        // 붙여넣을 데이터의 행과 열 개수를 구한다.
	        var numRows = pasteRows.length;
	        var numCols = pasteRows[0].length;

	        // 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
	        var gridLength = gridView.target.getList().length;
	        var gridColumns = gridView.target.config.columns;

	        for (var i = 0; i < numRows - 1; i++) {
	            if (startRowIndex + i >= gridLength) {
	                gridView.target.addRow($.extend({"updChk": "I"}, gridView.target.list[thisGridRow], {__index: undefined}));
	                gridView.target.setValue(startRowIndex + i, 'matrError', '');
	                gridView.target.setValue(startRowIndex + i, 'matrErrorText', '');
	                gridLength = gridView.target.getList().length;
	            }

	            for (var j = 0; j < numCols; j++) {
	                var calRow = startRowIndex + i;
	                var calCol = startColIndex + j;
	                // carriage return 문자 삭제
	                var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');

	                if (calCol >= gridColumns.length) {
	                    gridView.target.addColumn();
	                }

	                gridView.target.setValue(calRow, gridColumns[calCol].key, cellData);
	            }
	        }
	        gridView.target.repaint();
	    });
	}
	

    function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}

    
    function insertList(gridView) {
        var newRow = gridView.target.getList("selected")[0];
        if (!newRow) {
            newRow = gridView.target.getList()[gridView.target.list.length - 1];
        }
        
        if (!newRow) {
            newRow = {
                "coCd": $("#coCd").val(),
                "salesCd": $("#salesCd").val(),
                "useYn": "Y",
                "__original_index": 0
            };
        }
        newRow.updChk = "I";
        newRow.fileTrgtKey = 0;
        newRow.__index = "";
        
        gridView.target.addRow($.extend({}, newRow), "last", {focus: "END"});
        setTimeout(function() {
            gridView.target.focus("END");
        }, 100);
    }

    
	function deleteList(gridView) {
	    var delRow = gridView.target.getList("selected");
	    for (var i = delRow.length - 1; i >= 0; i--) {
	        var list = delRow[i];
	        gridView.target.removeRow(list.__index);
	    }
	    gridView.target.repaint(); // 수정 내용 적용하기
	}


    
	function WYSIWYGHTML(selector, maxHeight) {
	    return new Promise((resolve, reject) => {
		    // tinymce html 편집기 start ----------------------------------------------------------
		    var plugins = [
		        "advlist", "autolink", "lists", "link", "image", "charmap", "print", "preview", "anchor",
		        "searchreplace", "visualblocks", "code", "fullscreen", "insertdatetime", "media", "table",
		        "code", "help", "wordcount", "save", 'autoresize'
		    ];
		    var edit_toolbar = 'formatselect fontselect fontsizeselect |'
		               + ' forecolor backcolor |'
		               + ' bold italic underline strikethrough |'
		               + ' alignjustify alignleft aligncenter alignright |'
		               + ' bullist numlist |'
		               + ' table tabledelete |'
		               + ' link image';
	
		    tinymce.init({
	//	     	language: "ko_KR", //한글판으로 변경
		    	license_key: 'gpl',
		        selector: selector,
	            autoresize_bottom_margin: 0,
	            max_height: maxHeight,
	            setup: function (editor) {
	                editor.on('init', function () {
	                    editor.getDoc().body.style.maxHeight = '700px';
	                    editor.getDoc().body.style.overflowY = 'auto';
	                    editor.getBody().style.fontSize = '10pt';
	                    resolve(editor); // 초기화가 완료되면 Promise를 해결합니다.
	                });
	            },
		        height: 300,
		        menubar: false,
		        plugins: plugins,
		        toolbar: edit_toolbar,
		        
		        /*** image upload ***/
		        image_title: true,
		        /* enable automatic uploads of images represented by blob or data URIs*/
		        automatic_uploads: true,
		        /*
		            URL of our upload handler (for more details check: https://www.tiny.cloud/docs/configure/file-image-upload/#images_upload_url)
		            images_upload_url: 'postAcceptor.php',
		            here we add custom filepicker only to Image dialog
		        */
		        file_picker_types: 'image',
		        /* and here's our custom image picker*/
		        file_picker_callback: function (cb, value, meta) {
		            var input = document.createElement('input');
		            input.setAttribute('type', 'file');
		            input.setAttribute('accept', 'image/*');
	
		            /*
		            Note: In modern browsers input[type="file"] is functional without
		            even adding it to the DOM, but that might not be the case in some older
		            or quirky browsers like IE, so you might want to add it to the DOM
		            just in case, and visually hide it. And do not forget do remove it
		            once you do not need it anymore.
		            */
		            input.onchange = function () {
		                var file = this.files[0];
	
		                var reader = new FileReader();
		                reader.onload = function () {
		                    /*
		                    Note: Now we need to register the blob in TinyMCEs image blob
		                    registry. In the next release this part hopefully won't be
		                    necessary, as we are looking to handle it internally.
		                    */
		                    var id = 'blobid' + (new Date()).getTime();
		                    var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
		                    var base64 = reader.result.split(',')[1];
		                    var blobInfo = blobCache.create(id, file, base64);
		                    blobCache.add(blobInfo);
	
		                    /* call the callback and populate the Title field with the file name */
		                    cb(blobInfo.blobUri(), { title: file.name });
		                };
		                reader.readAsDataURL(file);
		            };
		            input.click();
		        },
		        /*** image upload ***/
		        
		        content_style: 'body { font-family:Helvetica,Arial,sans-serif; } p {margin: 0;  font-size:10pt}'
		    });
	    });
	}

	//수주번호 검색
    function popOpendOrdrsSearch(inputValue, coCd) {
        var paramObj = {
            "searchValue" : inputValue,
            "coCd" : coCd
        };
    	
        openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];

            $('#ordrsCoCd').val(row.coCd);
            $('#ordrsNo').val(row.ordrsNo);
            $('#clntCd').val(row.ordrsClntCd);
            $('#clntNm').val(row.clntNm);
            $('#clntPjt').val(row.clntPjtCd);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#ctrtNm').val(row.ctrtNm);
            $('#mngId').val(row.mngId);
            $('#mngIdNm').val(row.mngNm);
            $('#ctrtDt').datepicker('setDate', row.ordrsDt);
        });
    }

	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch(inputValue, coCd) {
		let tempSalesCd = $('#salesCds').val();  //sample 자료 --> 24046-01URFUP,24046-02URFUP,24046-03URFUP
    	if (tempSalesCd != "")  tempSalesCd = tempSalesCd.split(',')[0]; //첫번째 SalesCd만 추출함
        var paramObj = {
           "coCd" : $('#ordrsCoCd').val() != "" ?  $('#ordrsCoCd').val() : $('#coCd').val(),
           "searchValue": tempSalesCd != "" ? tempSalesCd : $('#ordrsNo').val()
        };
        openSecondModal("/static/html/cmn/modal/SalesCodeTreeSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
        	//dataGbn이 "D"==SALES CODE자료만 검색
            var rows = grid.target.getList("selected").filter(item => item.dataGbn === 'D');
        	if (rows.length != 0) {
	            var row = rows[0];
	            $('#ordrsCoCd').val(row.coCd);
	            $('#ordrsNo').val(row.ordrsNo);
	            $('#clntCd').val(row.ordrsClntCd);
	            $('#clntNm').val(row.ordrsClntNm);
	            $('#clntPjt').val(row.clntPjt);
	            $('#clntPjtNm').val(row.clntPjtNm);
	//             $('#ctrtNm').val(row.ctrtNm);	//계약명
	            $('#ctrtNm').val(row.eqpNm); //설비명
	            $('#mngId').val(row.mngId);
	            $('#mngIdNm').val(row.mngNm);
	            $('#ctrtDt').datepicker('setDate', row.ordrsDt);
	            $('#salesCds').val(rows.map(item => item.salesCd).join(","));  //SalesCd 합치기
	            $('#prdtCd').val(row.prdtCd);
	// 			$('#prdtNm').val(row.prdtCdNm);
	//             $('#itemDiv').val(row.itemDiv);
	//             $('#itemDivNm').val(row.itemDivNm);
        	}
        });
    }
    		


	function insertPFU() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();
			filePostAjax("/user/cr/cr50/insertPfu", formData ,function(data) {
				// alert(data.resultMessage);	
				if (data.resultCode == 200) {
					modalStack.last().callback(formData);
					modalStack.close();
				} else {
					alert(data.resultMessage);
				}
			});
		}
	}


	// 수정
	function updatePFU() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();
			if (formData) {
	      		filePostAjax("/user/cr/cr50/updatePfu", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
				$('#ctrtDt').val($('#ctrtDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
				$('#ctrtOrdrsDt').val($('#ctrtOrdrsDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
				$('#ctrtPfmcDt').val($('#ctrtPfmcDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
				$('#ctrtBfPfmcDt').val($('#ctrtBfPfmcDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
				$('#ctrtAfPfmcDt').val($('#ctrtAfPfmcDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
				$('#ctrtAmt').val(addCommaStr($('#ctrtAmt').val()));
				$('#exrate').val(addCommaStr($('#exrate').val()));
			}
		}
	}
	
	function makeFormData() {
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//하위레벨 자료 수정된 자료만 arr 담기
		var modifyRow = AREA01GridView.target.getList("modified");
		var updateRow = [];
		
// 		$.each(modifyRow,function(rowIdx, list) {
// 			list = escapeCha(list);
// 			for (var key in list) {
// 			    if (list.hasOwnProperty(key)) {
// 			        var value = list[key];
// 			        if ((typeof value) == "string") {
// 			        	value = value.replace(/%%C/g, "Ø"); //%%C --> Ø 문자로 대체하기
// 				        if ((value.indexOf("'") !== -1) || (value.indexOf('"') !== -1)) { // 문자열중에 '(작은따옴표) 또는 "(큰따옴표)문자가 있으면 /를 붙여서 쿼리 가능하게 수정
// 					        list[key] = value.replace(/'/g, "\'").replace(/"/g, '\"');
// 					        console.log(key + ": " + value, "After : " + list[key]);
// 				        }
// 			        }
// 			    }
// 			}
			
// 		});
		
		formData.append("updateRowArr", JSON.stringify(updateRow));
		formData.append("pgmId" 		, $("#pgmId").val());
		formData.append("useYn" 		, "Y");	
		

		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#clntCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtDiv').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 
		return 	formData;
		
	}

	function selectPFUInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"coCd" 			: $('#coCd').val(),
			"salesCds" 		: $('#salesCds').val(),
			"fileTrgtKey" 	: $('#fileTrgtKey').val(),
			"prdtDiv" 		: $('#prdtTyp').val(),  //'PFU01',
		}
		postAjax("/user/cr/cr50/selectPfuInfo", formData, null, function(data) {
			//--------- data 구조 -----------------------------
			//  data 
			//    ㄴ--- result :일반필드 data
			//           ㄴ----- resultclob   : CLOB data
			//-----------------------------------------------
			$('#popForm #dudtPlanDt').val('');  //기본 오늘날자이므로 clear
			$('#popForm #ordrsPlanDt').val(''); //기본 오늘날자이므로 clear
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					} else 
					if ($('#popForm #' + key).is('[date]')) {
						$('#popForm #' + key).datepicker('setDate', value);
					}
				}
			});
			
			var clobList = data.result.resultclob[0];
			
			if (data.result.resultclob.length) {
				setContentInEditor('ctrtRmk', clobList.ctrtRmk);
				setContentInEditor('custReq', clobList.custReq);
				setContentInEditor('spareList', clobList.spareList);
				setContentInEditor('pfuEtc', clobList.pfuEtc);
			}
//				$("#popForm #winbdCd").trigger("change");  //수주확정 구분에 따라 수주일 필드 컨디션 조정
	});
	}
	
	function setContentInEditor(editorId, content) {
        var editor = tinymce.get(editorId);
        if (editor) {
            editor.setContent(content);
            editor.save(); // 에디터 내용을 저장하여 화면에 즉시 반영
        } else {
            console.error('Editor not found: ' + editorId);
        }
    }
</script>

</body>
</html>