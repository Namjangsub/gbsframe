<!DOCTYPE html>
<html>
<head>
    <title>AG Grid Vanilla JS Demo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
	<script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
	<script type="text/javascript" src="/static/js/aggrid/ag-grid-community.min.js"></script>
    
	<link rel="stylesheet" href="/static/css/aggrid/ag-theme-quartz.min.css">
    
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <h1>AG Grid 기본 예시 (Community Edition)</h1>
    <p>검색, 정렬, 필터링, 페이지네이션을 확인해보세요!</p>
<div id="qrcode"></div>
		<!-- 콘텐츠 -->
		<div class="contents no_bg">
    		<div id="myGrid" style="height: 500px; width: 80%;" class="ag-theme-quartz"></div>
    	</div>

    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script>

    
    
    
        // Grid Options 설정
        const gridOptions = {
                pagination: true,	// 페이지네이션 활성화
                paginationPageSize: 50, // 한 페이지에 보여줄 로우 수 설정 (기본값)
                quickFilter: true, 	// 빠른 검색 활성화 (전체 컬럼에 대해)
                domLayout: 'autoHeight', // 컬럼 자동 크기 조정 (그리드 초기화 시)// 그리드 높이를 내용에 따라 자동으로 조정
                rowSelection: 'multiple',
                onGridReady: (params) => { // onGridReady 콜백 함수
                    console.log("AG Grid가 준비되었습니다!");
                    // 필요하다면 여기서 API를 사용하여 그리드 조작
                },
                rowHeight: 30, // row 높이지정
//                 rowNumbers: true, //enterprise script
                editType: 'fullRow',
                onSelectionChanged: function(){

                },
                defaultColDef: {
                    editable: true,
                    flex: 1,
                    minWidth: 100,
                  },
            // 컬럼 정의
            columnDefs: [
            	{ field: 'slt', headerName: '선택', width: 80,
            		minWidth: 10,
            		checkboxSelection: true,
            		pinned:'left',
            	},
                { field: 'make', headerName: '제조사', pinned:'left',filter: true, sortable: true ,resizable : false},
                { field: 'model', headerName: '모델', filter: true, cellEditor: CustomTextAreaEditor, sortable: true },
                { field: 'price', headerName: '가격', valueFormatter: numberCellFormatter, filter: 'agNumberColumnFilter', sortable: true },
                { field: 'electric', headerName: '전기차', pinned:'right', cellDataType: 'boolean', filter: true, sortable: true }
            ],
            // 로우 데이터
            rowData: [
                { make: "Tesla", model: "Model Y", price: 64950, electric: true ,headerTooltip: "모델명입니다." },
                { make: "Ford", model: "F-Series", price: 33850, electric: false },
                { make: "Porsche", model: "Macan", price: 62000, electric: false },
                { make: "Mercedes-Benz 123123123123123123", model: "EQE SUV", price: 77900, electric: true },
                { make: "Toyota", model: "Camry", price: 26420, electric: false },
                { make: "Hyundai", model: "IONIQ 5", price: 41800, electric: true },
                { make: "Kia", model: "EV6", price: 42600, electric: true },
                { make: "BMW", model: "iX", price: 87100, electric: true },
                { make: "Audi", model: "Q4 e-tron", price: 49800, electric: true },
                { make: "Honda", model: "CR-V", price: 29500, electric: false }
            ],

//             , searchList: function() {
//             	let _this = this;
//             	let param = inputList.setRangeParam("searchArea");
//             	let param2 = param.jsonString();
//                 //아래와 같은 형식으로 KEY : VALUE 형태로 있어야 함.
//             	//const tt = {USERID : 'TESTYG'};
            	
//             	fetch("/common/search/json/data2.json", {
//             		method : 'POST',
//             		postData: param2,
//             		headers: {
//     					'Content-Type': 'application/json',
//             		},
//             		body: JSON.stringify(param.map),
//             	})
//                 .then((response) => response.json())
//                 .then((data) => GRID.gridOptions.api.setRowData(data.data));
//             }
        };

        // DOM 요소 가져오기
// const eGridDiv = document.querySelector('#myGrid');
        const eGridDiv = $('#myGrid')[0];

        // AG Grid 생성 및 초기화
        let gridApi;
        function createGrid() {
            gridApi = agGrid.createGrid(eGridDiv, gridOptions);
        }

        // 그리드 생성 함수 호출
        createGrid();

        // 빠른 검색 입력 필드 추가 (옵션)
        var $searchInput = $('<input type="text" placeholder="전체 검색..." style="margin:10px 0; padding:5px; width:300px;">');
        $('body').prepend($searchInput); // 또는 .insertBefore($('#myGrid')) 등으로 위치 조절 가능
//         $('body').insertBefore($('#myGrid')); // 또는 .insertBefore($('#myGrid')) 등으로 위치 조절 가능

//         $searchInput.on('input', function () {
//             gridApi.setGridOption('quickFilterText', $(this).val());
//         });


        function numberCellFormatter(params) {
          return Math.floor(params.value)
            .toString()
            .replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
        }
function CustomTextAreaEditor() {}

CustomTextAreaEditor.prototype.init = function(params) {
    this.container = document.createElement('div');
    this.container.style.height = '100%';

    this.textArea = document.createElement('textarea');
    this.textArea.value = params.value ? params.value : '';
    this.textArea.style.width = '100%';
    this.textArea.style.height = '100%';
    this.textArea.style.boxSizing = 'border-box';
    this.textArea.style.resize = 'none';

    // 키 이벤트 핸들링: 엔터, Esc 등 필요시 추가
    this.textArea.addEventListener('keydown', function(e){
        e.stopPropagation();
    });

    this.container.appendChild(this.textArea);
};

CustomTextAreaEditor.prototype.getGui = function() {
    return this.container;
};

CustomTextAreaEditor.prototype.getValue = function() {
    return this.textArea.value;
};

CustomTextAreaEditor.prototype.afterGuiAttached = function() {
    this.textArea.focus();
    this.textArea.select();
};

function insertMn() {
    if (!gridApi) return;
    // 1. 현재 rowData를 가져옴
    const rowData = [];
    gridApi.forEachNode(function(node) {
        rowData.push({ ...node.data });  // 얕은 복사(간단한 데이터면 충분)
    });

    // 2. 마지막 row 데이터 추출
    let lastRow = rowData[rowData.length - 1];

    // 마지막 행의 rnum 값을 찾아 +1
    let newRnum = 1;
    if (rowData.length > 0) {
        // 숫자형 rnum이 아닐 수도 있으니 Number로 변환 후 max
        const maxRnum = Math.max(...rowData.map(r => Number(r.rnum) || 0));
        newRnum = maxRnum + 1;
    }

    if (!lastRow) {
    	lastRow = 
				{
					rnum: 1,
					mnDate: $("#mnDate_S").val(),
					mnWeeks: $('#mnWeeks_S').val(),
					mnSubSeq: 1,			//마지막 등록값에서 +1을 함.
					mnSubject: "",
					gun00MnCnts: "",
					gun60MnCnts: "",
					gun30MnCnts: "",
					gun40MnCnts: "",
					trn5010MnCnts: "",
					trn5020MnCnts: "",
					gun10MnCnts: "",
					gun80MnCnts: "",
					mnStatus: "",
					mnEtcAll: "",
				};
    }

    // 3. 딥카피(완전 복사). 단순 구조면 JSON 방식이 가장 무난
    let newRow = JSON.parse(JSON.stringify(lastRow));
    newRow.rnum = newRnum;
    newRow.mnSubSeq = newRnum;
    newRow.mnSortNo = newRnum;

    gridApi.applyTransaction({ add: [newRow] });

}

// 삭제
function deleteMn() {
    if (!gridApi) return;
    // 1. 선택된 row 배열 추출
    const selectedRows = gridApi.getSelectedRows();
    if (!selectedRows || selectedRows.length === 0) {
        alert('삭제할 행을 선택하세요.');
        return false;
    }

    gridApi.applyTransaction({ remove: selectedRows });
}




//회의 주제 Insert, Update
function pm10_d01_update(item, colKey, value) {
	
	item[colKey] = value;
	var paramObj = {
			mnDate   : $('#mnDate_S').val(),
		    mnWeeks	 : $('#mnWeeks_S').val(),
		    mnDiv	 : $('#mnDiv_S').val(),
			mnSubSeq : (item.mnSubSeq)?item.mnSubSeq : 1,
			mnSubject: item.mnSubject,
			mnSortNo : (item.mnSortNo != null && item.mnSortNo !== '') ? item.mnSortNo : 1,
			mnEtcAll : item.mnEtcAll,
			mnStatus : item.mnStatus,
			userId   : $('#userId').val(),
			pgmId    : $('#pgmId').val()
	};
	postAjax('/user/pm/pm10/pm10_d01_update', paramObj, null, function(data) {
		if (data.resultCode == 200) {

		} else {
			alert('수정 실패: ' + data.resultMessage);
		}
	});
}

//팀별 회의 내용 Insert, Update
function pm10_d03_update(item, colKey, value) {
	const mnDiv = $('#mnDiv_S').val();
	var paramObj = {
		mnDate   	: $('#mnDate_S').val(),
	    mnWeeks	 	: $('#mnWeeks_S').val(),
	    mnDiv	 	: mnDiv,
	    mnSubject 	: item.mnSubject,
		mnSubSeq 	: (item.mnSubSeq)?item.mnSubSeq : 1,
		mnSortNo 	: gPasIntChk(item.mnSortNo),
		mnDeptCd 	: deptCodeMap[colKey],
		mnCnts		: mnDiv=='MNDIV01'? value : '',
		mnEtc		: '',
		mnResult	: mnDiv=='MNDIV02'? value : '',
		mnStatus	: '',
		clntPjt		: '',
		clntCd		: '',
		userId   	: $('#userId').val(),
		pgmId    	: $('#pgmId').val()
	};
	postAjax('/user/pm/pm10/pm10_d03_update', paramObj, null, function(data) {
		if (data.resultCode === 200) {
		} else {
			alert('수정 실패: ' + data.resultMessage);
		}
	});
}
</script>
    
</body>
</html>