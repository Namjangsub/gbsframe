<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8" />
	<title>Office → PDF 미리보기 (pdf.js)</title>
	<script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
	
	<!-- pdf.js 기본 뷰어 -->
	<style>
		body { font-family: sans-serif; margin: 0; padding: 16px; }
		#viewerFrame { width: 100%; height: 80vh; border: 1px solid #ccc; }
	</style>
</head>
<body>
	<div id="localSelect">
		<h3>Office → PDF 변환 (pdf.js)</h3>
		<input type="file" id="file" />
		<button id="btnUpload">변환하기</button>
		<span id="msg" style="margin-left:8px;color:#555;"></span>
		
		<hr/>
	</div>

	<!-- pdf.js 뷰어를 iframe으로 띄움 -->
	<iframe id="viewerFrame" src="" frameborder="0"></iframe>

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>

  <script>

	$(document).ready(function() {
// 	    const paramObj = modalStack.last().paramObj;
// 		serverOfficeFiletoPdf(paramObj.fileKey, paramObj.userId, paramObj.coCd);
	});
	
	
    $("#btnUpload").on("click", function () {
      const file = $("#file")[0].files[0];
//       if (!file) {
//         alert("파일을 선택하세요.");
//         return;
//       }

      
//       const formData = new FormData();
//       formData.append("file", file);
//       $.ajax({
//         url: "/api/convert/pdf",
//         type: "POST",
//         data: formData,
//         processData: false,
//         contentType: false,
//         success: function (pdfUrl) {
//           $("#msg").text("변환 완료");

//           // pdf.js 공식 데모 뷰어에 우리가 만든 PDF를 붙인다.
//           // 주의: pdfUrl이 같은 도메인에 있어야 CORS 문제 안 생김.
//           const viewerBase = "/static/pdfjs/web/viewer.html?file=";
//           // 서버가 https라면 인코딩 필수
//           const full = viewerBase + encodeURIComponent(pdfUrl);
//           $("#viewerFrame").attr("src", full);
//         },
//         error: function (xhr) {
//           $("#msg").text("변환 실패: " + xhr.responseText);
//         }
//       });
   // 서버 파일 변환 (GET)
   // https://ai.gunyangitt.co.kr/api/convert/pdf?fileKey=8316&userId=js.nam&coCd=TRN
      $.ajax({
    	  url: '/api/convert/pdf',
    	  type: 'GET',
    	  data: {
    	    fileKey: '8316',
    	    userId: 'js.nam',
    	    coCd: 'TRN'
    	  }
    	})
    	.done(function (pdfUrl) {
    	  console.log('OK:', pdfUrl);
    	  const encoded = encodeURIComponent(pdfUrl);
    	  const viewerUrl = '/static/pdfjs/web/viewer.html?file=' + encoded;
    	  $('#viewerFrame').attr('src', viewerUrl);

    	})
    	.fail(function (xhr, status, error) {
    	  console.error('AJAX FAIL ===');
    	  console.error('status :', status);          // "error"
    	  console.error('http   :', xhr.status);      // 400, 401, 404, 500 ...
    	  console.error('resp   :', xhr.responseText);// 서버에서 보낸 에러 메시지
    	});
   
    });
    
    function serverOfficeFiletoPdf(fileKey, userId, coCd) {
        $("#localSelect").hide();
        $("#viewerFrame").css("height", "900px");
        $("#msg").text("서버 변환 중...");
        // 1단계: 변환 트리거 호출 (이건 JSON/text로 /api/convert/pdf/{id} 를 돌려줌)
        fetch(`/api/convert/pdf?fileKey=${fileKey}&userId=${userId}&coCd=${coCd}`)
			.then(res => {
				if (!res.ok) throw new Error('변환 요청 실패');
				return res.text();            // 컨트롤러가 ResponseEntity.ok(pdfUrl) 하니까 text로 받음
			})
			.then(pdfUrl => {
				// pdfUrl 예: "/api/convert/pdf/0f3c4d..."
				const viewerUrl = `/static/pdfjs/web/viewer.html?file=${pdfUrl}`;
				$("#viewerFrame").attr("src", viewerUrl);
			})
			.catch(err => {
				console.error(err);
				alert('PDF 변환 실패');
			});
    }
  </script>
</body>
</html>
