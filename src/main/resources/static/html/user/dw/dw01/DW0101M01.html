<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">

	<script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
	<script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
	<script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
	<script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
	<script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
	<script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script type="text/javascript" src="/static/js/global.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
	<script type="text/javascript" src="/static/js/fileTree.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 공통결재 -->
	<script src="/static/js/commApproval.js"></script>
	<!-- 도움말 팝업 -->
	<script src="/static/js/manualPopup.js"></script>

</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="gridView.setData(0);"><button class="bg_gray">검 색</button></a>
				</li>
			</ul>
		</div>

		<div class="contents search">
			<div class="">
				<!--  테이블 인풋 4분할  -->
				<table class="table_input type04">
					<tr>
						<td>
						    <input type="datetime-local" id="from_S" data-search="from"> ~ <input type="datetime-local" id="to_S" data-search="to">
						</td>   
						<th>SalesCd</th>
						<td>
						    <input type="text" id="salesCd_S" placeholder="SalesCD" data-search="salesCd">
						</td>    
						<th>파일명</th>
						<td>
<!-- 						    <input type="text" id="docNo_S" placeholder="DOC_NO" data-search="docNo"> -->
						    <input type="text" id="fileName_S" placeholder="fileName" data-search="fileName">
						</td> 
<!-- 						<td> -->
<!-- 							<div class="search_form"> -->
<!-- 								<input type="hidden" id="userId_S"   name="userId_S"   data-search="userId"> -->
<!-- 								<input type="text"   id="userIdNm_S" name="userIdNm_S" data-search="userIdNm" placeholder="사용자"  -->
<!-- 								onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? userId_S.value = '' : event.keyCode == 13 ? DataSearch() : '';"> -->
<!-- 								<a onclick="openUserSearch();"><i class="i_search_w"></i></a> -->
<!-- 							</div> -->
<!-- 						</td>     -->
						<th>서버종류</th>
						<td>
							<select id="serverName_S" name="serverName_S" data-search="serverName">
								<option value="TEST">TEST</option>
								<option value="PS" selected>PS</option>
							</select>
						</td>
					</tr>

				</table>

				<input type="hidden" id="userId" name="userId">
				<input type="hidden" id="pgmId"  name="pgmId" value="DW0101M01">
			</div>
		</div>

		<div class="contents no_bg">
			<div class="contents_tit">
				<div class="add_btn_small pdl10">
<!-- 					<a onclick="insertQualityReqModal();" style="height: 30px; line-height: 28px; width: 110px;"><i class="fas fa-folder"></i>요인별발주요청서</a> -->
					<a onclick="jsonToExcel(gridView);" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
				</div>
				<select id="recordCnt" class="prae_select" data-search="recordCnt">
					<option value="50">50</option>
					<option value="100" selected>100</option>
					<option value="500">500</option>
					<option value="9999999">전체</option>
				</select>
			</div>
		</div>

		<div class="contents">
			<div class="ax5_grid">
				<div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 725px; width: 100%"></div>
				<div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
			</div>
		</div>
	</div>

<script type="text/javascript">
	var gridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
				multipleSelect: false,
				sortable: true,
				target: $('[data-ax5grid="first-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function () {
						this.self.select(this.dindex);
					},
					onDBLClick: function () {
					},
					columnHeight: 26
				},
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
                        pageNo = this.page.selectPage;
					}
				},
				columns : [
                    {key:'createdAt'		, label:'일시'		, width:130	, align:'center'},
                    {key:'serverName'		, label:'서버'		, width:60	, align:'center'},
                    {key:'actionType'		, label:'구분'		, width:80	, align:'left'},
//                     {key:'userId'			, label:'사용자'		, width:100	, align:'left', 	hidden: false},
//                     {key:'userIdNm'			, label:'사용자'		, width:80	, align:'center'},
//                     {key:'projectCd'		, label:'프로젝트'		, width:160	, align:'left'},
                    {key:'docNo'			, label:'문서번호'		, width:80	, align:'center'},
                    {key:'fileName'			, label:'파일명'		, width:350	, align:'left'},
                    {key:'ext'				, label:'확장자'		, width:60	, align:'center'},
                    {key:'fileSize'			, label:'크기'		, width:80	, align:'right' , formatter: "money"},
                    {key:'checksumSha256'	, label:'해시코드' 	, width:260	, align:'left'},
                    {key:'docId'			, label:'문서Id'		, width:80	, align:'center'},
                    {key:'verId'			, label:'버젼ID'		, width:80	, align:'center'},
                    {key:'auditId'			, label:'감사번호' 	, width:80	, align:'center'},
                    {key:'newPath'			, label:'변경Path' 	, width:160	, align:'left'},
                    {key:'oldPath'			, label:'이전Path' 	, width:160	, align:'left'},
				]
			});
			return this;
		},
		setData : function(_pageNo) {
			var targetObj = this.target;
			const paramObj = {};
			$('[data-search]').each(function () {
				paramObj[$(this).data('search')] = $(this).hasClass('input_calendar')
					? $(this).val().replace(/\-/g, '')
					: $(this).val();
			});
			paramObj.from = fmtLocalYmdHms($('#from_S').val());
			paramObj.to = fmtLocalYmdHms($('#to_S').val());
			paramObj.pageNo = 1;
			paramObj.recordCnt = $('#recordCnt').val();

			postAjax("/user/dw/dw02/drawingAuditsList", paramObj, null, function(data) {
				try {
					var list = data.resultList;
					for (let i = 0; i < list.length; i++) {
						list[i].fileSize = gPasFloatChk(list[i].fileSize) || '';
						list[i].createdAt = fmtLocalYmdHms(list[i].createdAt) || '';
					}
					targetObj.setData({
						list : list,
						page : {
							currentPage   : _pageNo,
							pageSize      : data.paginationInfo.pageSize,
							totalElements : data.paginationInfo.totalRecordCount,
							totalPages    : data.paginationInfo.totalPageCount
						}
					});
					gridHeightResize(gridView, 194); // 194 = 919 - 725 : 화면 Body 높이 - 그리드 기본크기 725
				} catch (error) {
					customAlert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		}
	}

	var excelView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="excel-grid"]'),
				columns: [
                    {key:'createdAt'		, label:'일시'		, width:150},
                    {key:'actionType'		, label:'구분'		, width:90},
                    {key:'userId'			, label:'사용자'		, width:120},
                    {key:'projectCd'		, label:'프로젝트'		, width:120},
                    {key:'docNo'			, label:'문서번호'		, width:160},
                    {key:'fileName'			, label:'파일명'		, width:260},
                    {key:'ext'				, label:'확장자'		, width:60},
                    {key:'fileSize'			, label:'크기'		, width:100, align:'right'},
                    {key:'checksumSha256'	, label:'SHA-256'	, width:360},
                    {key:'docId'			, label:'docId'		, width:60},
                    {key:'verId'			, label:'verId'		, width:60},
                    {key:'auditId'			, label:'auditId'	, width:60},
				]
			});
			return this;
		}
	}

	$(document).ready(function() {
		mainDefaultLoad("기술연구소", "도면변경 감사현황"); // 페이지 타이틀 설정
		setCommonSelect($("#main_area select[data-kind]"));		// 공통코드 set

	    // 기본값: 오늘 00:00 ~ 현재
	    const now = new Date();
	    const start = new Date(); start.setDate(start.getDate() - 1);;
	    $('#from_S').val(fmtLocalYmdHms(start));
	    $('#to_S').val(fmtLocalYmdHms(now));


		//회사 기본값지정
// 		$("#coCd_S").val('GUN');

	    gridView.initView().setData(0);
		excelView.initView();

		//권한체크
		authChk();
		
		// 검색조건 이벤트 bind
		$('[data-search]').on("change", function(){ DataSearch(); });


	});

	function DataSearch() {
		gridView.setData(0);
	}

	function fmtLocalYmdHms(input) {
	  // input: "2025-09-02T06:00:00.000Z" 또는 "2025-09-02T15:00" 등
	  // parseZone: 입력 문자열의 오프셋(Z 포함)
	  // local(): 로컬 타임존(KST)로 환산
	  return moment.parseZone(input).format('YYYY-MM-DD HH:mm:ss');
	}
	  

	// 초기화 버튼용
	function initSearch() {
		$(".contents.search input[type='text']").val("");
		gridView.initView().setData(0);
	}

	// 작성자 검색 //
	function openUserSearch() {
		var paramObj = {
			"coCd" : $('#coCd_S').val(),
			"userId" : $('#userId_S').val(),
			"userNm" : $('#userIdNm_S').val(),
		};

		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					$('#userId_S').val(checkedNode.id);
					$('#userIdNm_S').val(checkedNode.text);
					gridView.setData(0);
				});
	}

	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
	function wbsSalesCodeSearch() {

		var paramObj = {
		   "coCd" : $('#coCd_S').val(),
		   "salesCd": $('#salesCd_S').val()
		};
		openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
			var row = grid.target.getList("selected")[0];
			$('#salesCd_S').val(row.salesCd);
			//$('#wbsClntPjt').val(row.clntPjt); // 고객사 PJT
			//$('#prdtCd_S').val(row.prdtCd); // 제품구분
			//$('#prdtNm_S').val(row.prdtCdNm); // 제품구분
			//$('#itemDiv_S').val(row.itemDiv); // 아이템 구분
			//$('#eqp_nm').val(row.eqpNm); // 설비명
			//$('#clntCd').val(row.ordrsClntCd); // 고객사코드
			//$('#clntNm').val(row.ordrsClntNm); // 고객사명
			gridView.setData(0);
		});
	}

	// 엑셀다운로드2
	function jsonToExcel (grid) {
		const list = grid.target.getList();
		const header = grid.target.colGroup;
		exportJSONToExcel(list, header,  '도면변경현황');
	}


</script>
</body>
</html>