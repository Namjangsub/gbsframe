<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">도면파일 변경이력 상세조회</h4>
	</div>
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="pgmId"     	name="pgmId"	value="DW0301M01">
			<table>
				<colgroup>
					<col width="10%">
					<col width="10%">
					<col width="10%">
					<col width="30%">
					<col width="10%">
					<col width="10%">
					<col width="10%">
					<col width="10%">
				</colgroup>

				<tr>
					<th>SALES CODE</th>
					<td>
						<input type="text" id="salesCd" name="salesCd" class="form-control" readonly>
					</td>
					<th>파일명</th>
					<td>
						<input type="text" id="fileName" name="fileName" class="form-control" readonly>
					</td>
					<th>작업자</th>
					<td>
						<input type="text" id="creatNm" name="creatNm" class="form-control" readonly>
					</td>
					<th>Ver.No</th>
					<td>
						<input type="text" id="verNo" name="verNo" class="form-control" readonly>
					</td>
				</tr>
			</table>
		</div>
	</form>

	<div class="contents_tit">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※버전별 파일 리스트</span>
		</div>
	</div>
	<div class="contents_tit">
		<!-- 리스트 -->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"
					style="height: 620px; width: 100%"></div>
			</div>
		</div>
	</div>
	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	var docId = null;
	var salesCd = null;
	var fileName = null;
	var creatNm = null;
	var verNo = null;
	var paramObj = null;

	var gridViewPop = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: false,
				sortable: false,
					target: $('[data-ax5grid="first-grid-modal"]'),
					header: {
						align: "center",
						selector: true
					},
					body: {
						onClick: function () {
							this.self.select(this.dindex);
						},
						onDBLClick: function () {
							if (this.column.key == "fileName") {
								fileDownload(this.item)
							}
						},
					},
					page : {
						navigationItemCount : 10,
						height : 30,
						display : true,
						firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
						prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
						nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
						lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
						onChange : function() {
							gridView.setData(this.page.selectPage);
						}
					},
					columns : [
								{key: "verId",          label: "파일Key",		width: 50, 		align: "center", hidden: true},
								{key: "docId",          label: "문서번호",		width: 50, 		align: "center", hidden: true},
								{key: "verNo",          label: "VerNo",		width: 50, 		align: "center"},
								{key: "commentTxt",     label: "상세이력", 	width: 100, 	align: "center"},
								{key: "fileName",       label: "파일명",		width: 300, 	align: "left"},
								{key: "fileSize",       label: "파일크기", 	width: 80,		align: "right", formatter: "money"},
								{key: "workDttm",    	label: "작업일시",		width: 130,		align: "center"},
								{key: "confirmBy",		label: "확정자",		width : 80,		align: "center"},
								{key: "confirmAt", 		label: "확정일시",		width : 130, 	align: "center"},
								{key: "confirmActNo",	label: "문제관리번호", 	width : 90,		align: "center"},
								{key: "issText",		label: "문제제목", 	width :260,		align: "left"},
								{key: "dirPath",        label: "파일경로",		width: 700, 	align: "left"},
								{key: "workNm", 		label: "작업자",		width : 80, 	align: "center"},
								{key: "serverName", 	label: "서버종류",		width : 80, 	align: "center", hidden: false},
							]
					});
					return this;
				},

				setData : function(_pageNo) {
						var targetObj = this.target;
						var formData = {
								"docId" 	: docId,
								"pageNo"    : _pageNo + 1
						}

					postAjax("/user/dw/dw03/select_dw03_detailList", formData, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : {
										totalElements : list.length
								}
							});
						} catch (error) {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					});
				},
	}

	$(document).ready(function() {
		// setCommonSelect($(".popup_area select[data-kind]"));

		paramObj = modalStack.last().paramObj;
		docId = paramObj.docId;
		if (paramObj && paramObj != undefined) {
			$.each(paramObj, function (key, val) {
				$('#' + key).val(val);
			});
		}
		gridViewPop.initView().setData(0);

		// authChk();

	});

	// 도면파일 다운로드
	function fileDownload(row) {
		var paramObj = {
			"userId" 	: jwt.userId,
			"docId"		: row.docId,
			"verNo" 	: row.verNo,
			"serverName": row.serverName,
			"fileName"	: row.fileName,
			"dirPath" 	: row.dirPath
		};
		
		postAjax("/user/dw/dw03/dwgFileDownInfo", paramObj, null, function(data) {
			if (data.selectFileDownAuthChk == 0) {
				customAlert("도면파일 다운로드 권한이 없습니다.");
				return false;
			} else {
				const fileInfo = data.fileInfo;
				const filePath = encodeURI(fileInfo.dirPath, "UTF-8");

				fetch(`/admin/cm/cm08/fileDownload?filePath=${filePath}`, {
					method: "GET",
					headers: {
						"Authorization": authorizationToken
					}
				})
				.then(response => {
					if (!response.ok) throw new Error("다운로드 실패");
					return response.blob();
				})
				.then(blob => {
					const downloadUrl = window.URL.createObjectURL(blob);
					const link = document.createElement("a");
					link.href = downloadUrl;
					link.download = row.fileName;  // 다운로드될 파일 이름
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					window.URL.revokeObjectURL(downloadUrl);
				})
				.catch(error => {
					console.error("파일 다운로드 중 오류:", error);
				});
			}
		});
	}
	
</script>