<!DOCTYPE html>
<html lang="ko">
<style>
	.attend-item {
		display: inline-block;
		margin: 5px;
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		cursor: pointer;
		user-select: none;
	}
	.attend-item.to-remove {
		background-color: #fdd;
	}
	.attend-item input {
		margin-right: 4px;
		cursor: auto;
	}
</style>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
</head>

<body>
  <div id="head_area"></div>
  <div id="top_area"></div>
  <div id="main_area" style="position: static;height: 1080px;">
  
		<!-- 페이지 상단 -->
		<!-- <div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="mnGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div> -->
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 5분할 -->
				<table class="table_input type05">

					<tr>
						<!-- <th class= "hit">회사</th>
						<td>
							<select type="hidden" id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required="required" msg="회사">
							</select>
						</td> -->
						<th style="width: 200px; height: 30px; line-height: 30px;font-size: 15px;">임팀장 주간회의 자료</th>

						<th class= "hit">회의일자</th>
						<td>
							<input type="text" id="mnDate_S" class="input_calendar" name="mnDate_S" data-search="mnDate" autocomplete="off" onkeyup="dateMask(this);" required="required" msg="회의일자">
						</td>
						<td style="width: 120px">
							<input id="mnWeeks_S" name="mnWeeks_S" data-search="mnWeeks" style="width:18px; font-size:15px; vertical-align: middle; margin-right:4px;" readonly>
							<span style="font-size:15px; vertical-align: middle;">주차</span>
						</td>
						<th>구분</th>
						<td>
							<select id="mnDiv_S" name="mnDiv_S" data-search="mnDiv"  onchange="mnGridView.setData(0);">
								<option value="MNDIV01" selected>사전공지</option>
								<option value="MNDIV02">회의결과</option>
								<option value="MNDIV99">전체조회</option>
                            </select>
						</td>
						<td></td>
						<td>
							<div class="add_btn_small pdl10" style="width:500px;">
								<a onclick="moveSelectedUp();" id="moveUp"    style="height: 30px; line-height: 28px; margin:0 5px;">▲</a>
								<a onclick="moveSelectedDown();" id="moveDown"  style="height: 30px; line-height: 28px;">▼</a>
								<a onclick="insertMn();" id="addRow" style="width: 80px; height: 30px; line-height: 28px;">행 추가</a>
								<a onclick="deleteMn();" id="deleteRow" style="width: 80px; height: 30px; line-height: 28px;">행 삭제</a>
								<a onclick="setReport();" style="height: 30px; line-height: 28px; width: 100px;"><i class="fas fa-print"></i> 회의록출력</a>
								<a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
							</div>
						</td>
					</tr>
	            </table>
				<!-- 검색조건 END -->
<form id="mainForm" onSubmit="return false;">
		<input type="hidden" id="userId"    name="userId">
		<input type="hidden" id="deptId"     name="deptId">
		<input type="hidden" id="pgmId"     name="pgmId" value="PM1002M01">
</form>
            </div>
        </div>
		<div class="contents attend-area" style="display: flex; align-items: center;">
			<div id="attendCheckboxContainer" style="flex: 1;"></div>
			<div class="add_btn_small pdl10" style="margin-left: auto; margin-right: 30px">
				<a onclick="openUserSearch()"   id="addAttendBtn"    style="height:30px; line-height:28px;">+</a>
				<a onclick="pm10_d02_delete()"  id="removeAttendBtn" style="height:30px; line-height:28px;">-</a>
			</div>
		</div>

		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="mnGrid-grid" data-ax5grid-config="{}" style="height: 900px; width: 100%; overflow-y: auto;" ></div>
			<div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>

		
		
    </div>
    <input type="file" id="fileInput" multiple style="display:none" />                
</body>
</html>

<script type="text/javascript">

let fileRowInserted = false;
let currentFileRow = null;
let currentFileColumn = null;
var mnFileArr = [];
var deleteFileArr = [];
let attendFlag = true;	// 구분이 회의결과일 때 참석자 리스트 update를 위한 flag

const DEFAULT_ATTEND_LIST = [
	{ id: 'EMJ8105',    name: '김태호',   title: '부사장' },
	{ id: 'kimjhv',     name: '김재현',   title: '전 무' },
	{ id: 'kimihz',     name: '김일희',   title: '상 무' },
	{ id: 'K98452000',  name: '김동현',   title: '상 무' },
	{ id: 'shjung',     name: '정상훈',   title: '부 장' },
	{ id: 'h4ng10',     name: '허상렬',   title: '부 장' },
	{ id: 'canmtb',     name: '한동주',   title: '과 장' },
	{ id: 'js.nam',     name: '남장섭',   title: '실 장' },
	{ id: 'cyh',        name: '조영희',   title: '부 장' },
	{ id: 'ycy',        name: '윤치영',   title: '부 장' },
];
let attendList = DEFAULT_ATTEND_LIST.map(u => ({ ...u }));

const FIXED_ORDER = DEFAULT_ATTEND_LIST.map(u => u.id);

//formatter 공통 함수
function valueFormatter() {
	return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : '';
}

// 파일 첨부 셀 함수
function fileCellFormatter() {
	if (!this.item.isFileRow) return valueFormatter.call(this);

	const colKey = this.key;
	// filesByColumn 에 fileType 까지 담아두었다고 가정
	const files  = (this.item.filesByColumn && this.item.filesByColumn[colKey]) || [];

	// 1) 파일 리스트
	const listHtml = files.length ? 
		`<ul class="file-list" style="padding:0; margin:0; list-style:none;">
			${files.map((f,i) =>
				`<li data-idx="${i}" data-col="${colKey}" style="margin:6px 0; display:flex; align-items:center;">
					${$('#mnDiv_S').val() !== 'MNDIV99' ? 
						`<button class="file-remove" data-idx="${i}" data-col="${colKey}" style="font-size:11px; padding:4px 10px; margin-right:6px; background-color:rgb(255,50,0); cursor:pointer;">삭제</button>` 
						: ''}
					<span class="file-preview"
						style="white-space: nowrap; text-decoration:underline; cursor:pointer;" 
						data-filekey="${f.fileKey}" data-filename="${f.name}" data-filetype="${f.fileType}">${f.name}</span>
				</li>`
			).join('')}
		</ul>`
		: '';

	// 2) 추가 버튼
	const btnHtml = (files.length && $('#mnDiv_S').val() !== 'MNDIV99') ? 
		`<div class="file-add-wrap" style="width:100%; text-align:center; margin-top:12px;">
			<button class="file-add-btn" data-col="${colKey}"style="font-size:11px; padding:4px 10px; cursor:pointer;">추가</button>
		</div>`
		: '';

	return listHtml + btnHtml;
}

const baseFileCol = {
    editor: {
        type: "textarea",
        disabled: function () {
            return this.item.isFileRow || $('#mnDiv_S').val() === 'MNDIV99';
        }
    },
    formatter: fileCellFormatter
};

const mnStatusCode = [
	{'CD' : '', 'NM' : ''},
	{'CD' : 'N', 'NM' : '진행'},
	{'CD' : 'Y', 'NM' : '완료'}
]

// 부서 코드 매핑
const deptCodeMap = {
	gun00MnCnts:'GUN00', gun60MnCnts:'GUN60', gun30MnCnts:'GUN30',
	gun40MnCnts:'GUN40', trn5010MnCnts:'TRN5010', trn5020MnCnts:'TRN5020',
	gun10MnCnts:'GUN10', gun80MnCnts:'GUN80'
};

	var mnGridView = {
		initView: function(){
		this.target = new ax5.ui.grid();
		this.target.setConfig({
			frozenColumnIndex : 1,
			showRowSelector: false,
			multipleSelect: false,
			sortable: false,
			showLineNumber: false,
			lineNumberColumnWidth: 30,
			target: $('[data-ax5grid="mnGrid-grid"]'),
			header: {
				align: "center",
				selector: false
			},
			body: {
				columnHeight: 50,
				onClick: function () {
					this.self.clearSelect();
					this.self.select(this.dindex);

					const colKey = this.column.key;
					const files = (this.item.filesByColumn && this.item.filesByColumn[colKey]) || [];
					if ($('#mnDiv_S').val() === 'MNDIV99') return;
					if (this.column.key == 'mnSubject' && this.item.mnSubject === '파일첨부') return;
					if (this.item.mnSubject === '파일첨부' && files.length === 0) {
						currentFileRow    = this.item;
						currentFileColumn = colKey;
						$('#fileInput').click();
					}

				},
				onDBLClick: function () {
					if (this.item.mnSubject === '공지사항') return false;
				},
				onDataChanged: function(){
					if (this.key === 'mnSubject' || this.key === 'mnStatus' || this.key === 'mnEtcAll') {
						pm10_d01_update(this.item, this.key, this.value);
					} else {
						pm10_d03_update(this.item, this.key, this.value);
					}
					// 공지사항(isNoticeRow)이면 순번 재계산 건너뛰기
					if (!this.item.isNoticeRow) {
						recalcSortOrder();
					}
					this.self.repaint(true);
				}
			},
			page: {
				navigationItemCount: 9,
				height: 30,
				display: false,
				firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
				prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
				nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
				lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
				onChange: function () {
					mnGridView.setData(this.page.selectPage);
				}
			},
			columns: [
						{ key: "mnSubject", 	label: "PROJECT<br>/<br>주제", 	align: "left", width: 100, editor: {type: "textarea",disabled: function () {return this.item.isFileRow || this.item.isNoticeRow;}}, formatter: valueFormatter},
						{ key: "mnSubSeq", 		label: "순번", 					align: "left", width: 100, hidden: true},
						{ key: "gun00MnCnts", 	label: "임원", 					align: "left", width: 220, ...baseFileCol},
						{ key: "gun30MnCnts", 	label: "영업<br>국내.해외", 	align: "left", width: 220, ...baseFileCol},
						{ key: "gun60MnCnts", 	label: "생산", 					align: "left", width: 220, ...baseFileCol},
						{ key: "gun40MnCnts", 	label: "연구소", 				align: "left", width: 220, ...baseFileCol},
						{
							key: undefined, 	label: "트루넷", columns: [
								{ key: "trn5010MnCnts", label: "기계", 		align: "left", width: 220, ...baseFileCol},
								{ key: "trn5020MnCnts", label: "전기", 		align: "left", width: 220, ...baseFileCol},
							]
						},
						{ key: "gun10MnCnts", 	label: "경영지원팀<br>총무/인사/제조혁신", 	align: "left", width: 220, ...baseFileCol},
						{ key: "gun80MnCnts", 	label: "전산실", 				align: "left", width: 220, ...baseFileCol},
						{ key: "mnStatus", 		label: "진행/완료", 			align: "left", width: 70, 
							editor: {
								type: 'select', config: {
									columnKeys: { optionValue: 'CD', optionText: 'NM' },
									options : mnStatusCode
								}
							},
							formatter : function() {
								return getComboName(mnStatusCode, this)
							}
						},
						{ key: "mnEtcAll", 		label: "특이사항", 			align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
						{ key: "mnSortNo", 		label: "정렬순서", 			align: "center", width: 80, hidden: true},
						{ key: "mnWeeks", 		label: "주차", 				align: "center", width: 80, hidden: true},
						
					]
			});
			return this;
		},	
		setData: function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {};
			$.each($('#main_area [data-search]'), function(idx, elem){
				if ($(elem).hasClass("input_calendar")) {
					paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
				} else {
					paramObj[$(elem).data("search")] = $(elem).val();
				}
			});
			paramObj.userId    = jwt.userId;
			paramObj.deptCodes = JSON.stringify(Object.values(deptCodeMap));

			postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
				try {
					// data.result가 없으면 빈 배열 처리
					var list = Array.isArray(data.result) ? data.result : [];

					// rnum이 있는 회의록만 추출
					var rows = list.filter(r => r.rnum !== undefined);

					// 공지사항 기본 구조
					let noticeRow = rows.find(r => r.mnSubject === '공지사항');
					if (!noticeRow) {
						noticeRow = {
							mnDate:      $('#mnDate_S').val(),
							mnWeeks:     $('#mnWeeks_S').val(),
							mnSubSeq:    0,
							mnSubject:   '공지사항',
							mnSortNo:    0,
							isNoticeRow: true,
							gun00MnCnts: '', gun30MnCnts: '', gun40MnCnts: '', gun60MnCnts: '',
							trn5010MnCnts: '', trn5020MnCnts: '', gun10MnCnts: '', gun80MnCnts: '',
							mnStatus:    '', mnEtcAll:   ''
						};
					} else {
						noticeRow.isNoticeRow = true;
					}

					// 파일첨부 처리: data.result 중 files 키를 가진 객체에서 JSON 파싱
					const fileEntry   = list.find(r => typeof r.files === 'string');
					const parsedFiles = fileEntry ? JSON.parse(fileEntry.files) : [];

					// fileRow 기본 구조
					const fileRow = {
						mnDate:        $('#mnDate_S').val(),
						mnWeeks:       $('#mnWeeks_S').val(),
						mnSubSeq:      0,
						mnSubject:     '파일첨부',
						gun00MnCnts:   '', gun30MnCnts:   '', gun40MnCnts:   '', gun60MnCnts:   '',
						trn5010MnCnts: '', trn5020MnCnts: '', gun10MnCnts:   '', gun80MnCnts:   '',
						mnStatus:      '', mnEtcAll:      '',
						mnSortNo:      0,
						isFileRow:     true,
						filesByColumn: {}
					};

					// parsedFiles 배열 돌면서 deptCodeMap에 맞춰 바로 filesByColumn에 추가
					parsedFiles.forEach(f => {
						const deptCode = String(f.fileTrgtKey).split('-').length >= 2 ? String(f.fileTrgtKey).split('-')[1] : '';
						const colKey = Object.keys(deptCodeMap)
											.find(key => deptCodeMap[key] === deptCode);
						if (!colKey) return;

						if (!fileRow.filesByColumn[colKey]) {
							fileRow.filesByColumn[colKey] = [];
						}
						fileRow.filesByColumn[colKey].push({
							name:     f.fileName,
							fileKey:  f.fileKey,
							fileType: f.fileType
						});
					});

					// merged 배열 생성
					const nonNoticeRows = rows.filter(r => r.mnSubject !== '공지사항');
					const merged = [...nonNoticeRows, noticeRow, fileRow].sort((a, b) => {
						if (a.isFileRow) return 1;
						if (b.isFileRow) return -1;
						if (a.isNoticeRow) return 1;
						if (b.isNoticeRow) return -1;
						return ( (a.mnSortNo || 0) - (b.mnSortNo || 0) );
					});

						

						// 구분에 따른 그리드 화면 조회
					const deptCols = Object.keys(deptCodeMap);
					merged.forEach(item => {
						deptCols.forEach(colKey => {
							const cntsVal   = item[colKey] || '';
							const resultKey = colKey.replace('MnCnts','MnResult');
							const resultVal = item[resultKey] || '';

							if ($('#mnDiv_S').val() === 'MNDIV01') {
								// 사전공지
								item[colKey] = cntsVal;
							}
							else if ($('#mnDiv_S').val() === 'MNDIV02') {
									// 회의결과가 없으면 사전공지자료를 보여줌
									item[colKey] = (resultVal) ? resultVal : cntsVal;
							}
							else if ($('#mnDiv_S').val() === 'MNDIV99') {
								// 전체조회: 빈 값은 섹션에서 제외
								let parts = [];
								if (cntsVal) {
									parts.push(`[사전공지]\n${cntsVal}`);
								}
								if (resultVal) {
									parts.push(`[회의결과]\n${resultVal}`);
								}
								// 둘 다 비어 있으면 빈 문자열
								item[colKey] = parts.length ? parts.join('\n\n') : '';
							}
						});
					});

					targetObj.setData({
						list: merged,
						page: { totalElements: merged.length }
					});

					select_p10_d02_List(data.d02List || []);
					recalcSortOrder();
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다: " + error.message);
				} finally {
					syncRowHeights();
				}
			});
		}

	}

	var excelView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="excel-grid"]'),
				columns: [
						{ key: "mnSubject", 	label: "PROJECT<br>/<br>주제", 	align: "left", width: 100, editor: {type: "textarea",disabled: function () {return this.item.isFileRow || this.item.isNoticeRow;}}, formatter: valueFormatter},
						{ key: "mnSubSeq", 		label: "순번", 					align: "left", width: 100, hidden: true},
						{ key: "gun00MnCnts", 	label: "임원", 					align: "left", width: 220, ...baseFileCol},
						{ key: "gun30MnCnts", 	label: "영업<br>국내.해외", 	align: "left", width: 220, ...baseFileCol},
						{ key: "gun60MnCnts", 	label: "생산", 					align: "left", width: 220, ...baseFileCol},
						{ key: "gun40MnCnts", 	label: "연구소", 				align: "left", width: 220, ...baseFileCol},
						{
							key: undefined, 	label: "트루넷", columns: [
								{ key: "trn5010MnCnts", label: "기계", 		align: "left", width: 220, ...baseFileCol},
								{ key: "trn5020MnCnts", label: "전기", 		align: "left", width: 220, ...baseFileCol},
							]
						},
						{ key: "gun10MnCnts", 	label: "경영지원팀<br>총무/인사/제조혁신", 	align: "left", width: 220, ...baseFileCol},
						{ key: "gun80MnCnts", 	label: "전산실", 				align: "left", width: 220, ...baseFileCol},
						{ key: "mnStatus", 		label: "진행/완료", 			align: "left", width: 70, 
							editor: {
								type: 'select', config: {
									columnKeys: { optionValue: 'CD', optionText: 'NM' },
									options : mnStatusCode
								}
							},
							formatter : function() {
								return getComboName(mnStatusCode, this)
							}
						},
						{ key: "mnEtcAll", 		label: "특이사항", 			align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
						{ key: "mnSortNo", 		label: "정렬순서", 			align: "center", width: 80, hidden: true},
						{ key: "mnWeeks", 		label: "주차", 				align: "center", width: 80, hidden: true},
					]
			});
			return this;
		}
	}
	
	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    
		// 회사 초기화
		$("#coCd_S").val(jwt.coCd);
		$('#mnDate_S').val(moment().day(5).format('YYYY-MM-DD'));
	}

	$(document).ready(function() {
		//초기설정들
		mainDefaultLoad("사업계획", "임팀장주간회의록");
		setCommonSelect($("#main_area select[data-kind]"));

		// 화면 크기 조절
		$("#top_area").hide();
		$('#head_area').toggleClass('off');
		$('#main_area').toggleClass('on');

		$("#userId").val(jwt.userId);
		$("#deptId").val(jwt.deptId);

		$('.attend-area').hide(); // 참석자 리스트 기본 숨김
		
		// 종료일 (현재날짜의 월 말일)
		$('#mnDate_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true,
			beforeShowDay: function(date) {
				// 5 = 금요일만 선택가능하게 하기
				return date.getDay() === 5;
			}
		}).datepicker("setDate", moment().day(5).toDate());
		$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
		
		// 접속자 회사 set
		$("#coCd_S").val(jwt.coCd);
		$("#userId").val(jwt.userId);
		
		// 참석자 삭제("-") 버튼
		$('#removeAttendBtn').on('click', () => {
			const toRemoveIds = $('.attend-item.to-remove')
								.map((_,el)=>$(el).data('id'))
								.get();
			if (!toRemoveIds.length) {
				return;
			}
			attendList = attendList.filter(u => !toRemoveIds.includes(u.id));
			renderAttendList();
		});
				
		mnGridView.initView().setData();
		excelView.initView();

		// 회의일자 변경 시
		$('#mnDate_S').on('change', function (){
			$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
			mnGridView.initView().setData(0);
		})

		// 구분 변경 시
		$('#mnDiv_S').on('change', function (){
			if ($('#mnDiv_S').val() === 'MNDIV01') {
				$('.attend-area').hide();
				
			}
			else if ($('#mnDiv_S').val() === 'MNDIV02') {
				// 구분이 회의결과로 바뀌면 참석자 리스트 UPDATE 하고 attendFlag를 false로 변경 -> 이 로직은 회의결과로 들어왔을 때 딱 한번 참석자 리스트 업데이트 하기 위함
				if (attendFlag) {
					pm10_d02_update();
				}

				$('.attend-area').show().css('pointer-events', 'auto');
				$('#addAttendBtn, #removeAttendBtn').show();
				$('#attendCheckboxContainer input.attend-checkbox').prop('disabled', false).css('pointer-events', 'auto').css('cursor', 'pointer');
			}
			else if ($('#mnDiv_S').val() === 'MNDIV99') {
				$('.attend-area').show().css('pointer-events', 'none');
				$('#addAttendBtn, #removeAttendBtn').hide();
				$('#attendCheckboxContainer input.attend-checkbox').prop('disabled', true).css('pointer-events', 'none').css('cursor', 'default');
			}
		});

		// 왼쪽 사이드바 닫기 버튼 클릭 시 그리드 데이터 셋팅 
		$('.off_btn').on('click', function(e){
			mnGridView.setData(0);
		});

		$('#fileInput').on('change', function(){
			if (!currentFileRow || !currentFileColumn) return;
			Array.from(this.files).forEach(file => {
				// 서버 전송용 배열에 넣고
				mnFileArr.push({ fileKey: 0, file, row: currentFileRow, column: currentFileColumn });
				// 화면용 컬럼별 배열에 추가
				currentFileRow.filesByColumn = currentFileRow.filesByColumn || {};
				currentFileRow.filesByColumn[currentFileColumn] = currentFileRow.filesByColumn[currentFileColumn] || [];
				currentFileRow.filesByColumn[currentFileColumn].push({ name: file.name, fileKey: 0 });
			});
			mnGridView.target.repaint();

			mnUploadFile();
			$(this).val('');
			currentFileRow = null;
			currentFileColumn = null;
		});

		// 파일 추가
		$('[data-ax5grid="mnGrid-grid"]').on('click', '.file-add-btn', function(e) {
			const colKey = $(this).data('col');
			const $li = $(this).closest('[data-ax5grid-data-index]');
			const dindex = +$li.attr('data-ax5grid-data-index');
			const fileRow = mnGridView.target.list[dindex];

			const normalRows = mnGridView.target.list.filter(r => !r.isFileRow);
			const hasDeptValue = normalRows.some(r => r[colKey] && r[colKey].trim());
			if (!hasDeptValue) {
				alert('먼저 해당 부서에 대한 회의 내용을 입력한 후에만 파일을 첨부할 수 있습니다.');
				return;
			}

			currentFileRow = fileRow;
			currentFileColumn = colKey;
			$('#fileInput').click();
		});

		// 파일 삭제
		$('[data-ax5grid="mnGrid-grid"]').on('click', '.file-remove', function(e) {
			e.stopPropagation();
			const $btn = $(this);
			const idx = $btn.data('idx');
			const colKey = $btn.data('col');
			currentFileColumn = colKey;

			const $rowElem = $btn.closest('[data-ax5grid-data-index]');
			const dindex = +$rowElem.attr('data-ax5grid-data-index');
			const row = mnGridView.target.list[dindex];

			if (row.filesByColumn && row.filesByColumn[colKey]) {
				const removed = row.filesByColumn[colKey].splice(idx, 1)[0];
				deleteFileArr.push({ fileKey: removed.fileKey });

				mnGridView.target.repaint();
				mnUploadFile();
			}
		});
		
		// 이미지 미리보기
		$('[data-ax5grid="mnGrid-grid"]').on('click', '.file-preview', function() {
			const fileKey = $(this).data('filekey');
			const fileName = $(this).data('filename');
			const $li = $(this).closest('li');
			const colKey = $li.data('col');
			const dindex = +$li.closest('[data-ax5grid-data-index]').attr('data-ax5grid-data-index');
			const row = mnGridView.target.list[dindex];

			const allFiles = row.filesByColumn[colKey] || [];
			const imageList = allFiles
				.filter(f => ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'heic'].includes((f.fileType || '').toLowerCase()))
				.map(f => ({
					fileKey: Number(f.fileKey),
					fileName: f.name
				}));
			imageViewPopup(fileKey, fileName, imageList);
		});

		$(window).on('resize', showSize);
		$(function() { showSize(); });
		
		
		//권한체크
// 		authChk();	
			
	});
	
	function showSize() {
// 	   console.log('뷰포트 크기: ' + window.innerWidth + ' × ' + window.innerHeight + ' px');
    	   $('[data-ax5grid="mnGrid-grid"]').height( window.innerHeight - 95);
    	   $('#main_area').height(window.innerHeight);
	}
	
	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    
		// 회사 초기화
		$("#coCd_S").val(jwt.coCd);

		$('#mnDate_S').val(moment().day(5).format('YYYY-MM-DD'));
		$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
		
		// 재검색
		mnGridView.setData(0);
	}

	// 참석자 리스트 불러오기 & 렌더링
	function select_p10_d02_List(list) {
			if (list.length > 0) {
				attendList = list.map(user => ({
					id:       user.id,
					name:     user.name,
					title:    user.title,
					reasonCd: user.reasonCd
				}));
			} else {
				// 기본 참여자 전부를 reasonCd: 'Y' 로 설정
				attendList = DEFAULT_ATTEND_LIST.map(user => ({...user, reasonCd: 'Y'}));
			}

			// 고정 멤버 순서대로 정렬
			reorderAttendList();

			// 렌더링
			renderAttendList();
		
			// DB에서 Y인 것만 체크
			attendList.forEach(item => {
				if (item.reasonCd === 'Y') {
					$(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
					.prop('checked', true);
				}
			});
	}

	// 행 추가
	function insertMn() {
		const grid = mnGridView.target;
		const selected = grid.getList("selected");  // 선택된 행 배열

		let insertIndex;
		if (selected.length > 0) {
			const sel = selected[0];

			if (sel.mnSubject === "공지사항") {
				return false;
			}

			insertIndex = grid.list.findIndex(r =>
				r.mnDate   === sel.mnDate &&
				r.mnSubSeq === sel.mnSubSeq
			) + 1;
		} else {
			insertIndex = grid.list.findIndex(r => r.mnSubject === '공지사항');
			if (insertIndex < 0) {
				// 공지사항이 없으면 맨 끝
				insertIndex = grid.list.length;
			}
		}

		// 새 행 객체 생성
		const newRow = {
			mnDate:      $('#mnDate_S').val(),
			mnWeeks:     $('#mnWeeks_S').val(),
			mnSubSeq:    0,      // 서버에서 INSERT 시 발급
			mnSubject:   '',
			mnSortNo:    0,      // 임시값
			isNoticeRow: false,
			isFileRow:   false
		};

		// 행 추가 및 리페인트
		grid.addRow(newRow, insertIndex);
		grid.repaint();
	}

	// 행 삭제
	function deleteMn() {
		const grid = mnGridView.target;
		const fileRow = grid.list.find(r => r.isFileRow);
		const sel  = grid.getList("selected")[0];
		if (!sel) {
			alert("삭제할 주제를 선택하세요!");
			return false;
		}
		
		if (sel.mnSubject == "파일첨부" || ((sel.mnSubSeq == 0) && (sel.mnSubject == '공지사항'))) {
			return false;
		}

		// 빈행(mnSubSeq===0) 삭제
		if (!sel.mnSubSeq) {
			const idx = grid.list.findIndex(r =>
				r.mnDate   === sel.mnDate &&
				r.mnSubSeq === sel.mnSubSeq
			);
			if (idx >= 0) {
				// 그리드 데이터 배열에서 제거
				grid.list.splice(idx, 1);
				// 다시 렌더링 및 순서 재계산
				grid.setData({ list: grid.list, page: { totalElements: grid.list.length } });
				// recalcSortOrder();
			}
			return;
		}

		// 행(mnSubSeq > 0) 삭제
		const deptCols = Object.keys(deptCodeMap);
		const hasResult = deptCols.some(colKey => {
			const resultKey = colKey.replace('MnCnts', 'MnResult');
			return sel[resultKey] && sel[resultKey].toString().trim() !== '';
		});
		if (hasResult) {
			alert("회의결과가 있는 행은 삭제할 수 없습니다.");
			return false;
		}
		if (!confirm("선택한 행을 정말 삭제하시겠습니까?")) {
			return false;
		}
		var paramObj = {
			mnDate		: sel.mnDate,
			mnSubSeq	: sel.mnSubSeq,
			fileInfoJson 	: JSON.stringify(fileRow.filesByColumn)
		}
		postAjax("/user/pm/pm10/deleteMn", paramObj, null, function(data) {
			if (data.resultCode == 200) {
				mnGridView.setData();
			} else {
				alert("삭제 실패: " + data.resultMessage);
			}
		});
	}
	
	//회의 주제 Insert, Update
	function pm10_d01_update(item, colKey, value) {
		item[colKey] = value;

		// 일반 주제행 목록
		const normalRows = mnGridView.target.list.filter(r => !r.isFileRow && !r.isNoticeRow);

		let newSubSeq;
		let newSortNo;

		if (item.isNoticeRow) {
			// 신규 공지사항: 아직 subSeq가 0일 때만 마지막+1
			newSubSeq  = item.mnSubSeq > 0 ? item.mnSubSeq : normalRows.length + 1;
			newSortNo = normalRows.length + 1;
			// 화면에도 반영
			item.mnSubSeq = newSubSeq;
			item.mnSortNo = newSortNo;
		}
		else {
			// 일반 주제: 위치에 맞춰 계산
			newSubSeq  = item.mnSubSeq || 0;
			newSortNo = normalRows.findIndex(r => r === item) + 1;
			item.mnSortNo = newSortNo;
		}

		var paramObj = {
			mnDate		: $('#mnDate_S').val(),
			mnWeeks		: $('#mnWeeks_S').val(),
			mnSubSeq	: newSubSeq,
			mnSubject	: item.mnSubject,
			mnSortNo	: newSortNo,
			mnEtcAll	: item.mnEtcAll,
			mnStatus	: item.mnStatus,
			userId		: $('#userId').val(),
			pgmId		: $('#pgmId').val()
		};

		postAjax('/user/pm/pm10/pm10_d01_update', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				mnGridView.setData();
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	//팀별 회의 내용 Insert, Update
	function pm10_d03_update(item, colKey, value) {
		// 기존 행들 중 공지·파일 행을 제외하고, seq가 0보다 큰 행만 모은다
		const dataRows = mnGridView.target.list.filter(r => 
			!r.isFileRow && !r.isNoticeRow && r.mnSubSeq > 0
		);

		// 현재 존재하는 mnSubSeq의 최대값을 구한다. 없으면 0
		const maxSeq = dataRows.reduce((max, r) => Math.max(max, r.mnSubSeq || 0), 0);

		// 신규이면 maxSeq + 1, 아니면 기존 seq 유지
		const newSubSeq = item.mnSubSeq > 0 ? item.mnSubSeq : (maxSeq + 1);

		var paramObj = {
			mnDate    : $('#mnDate_S').val(),
			mnWeeks   : $('#mnWeeks_S').val(),
			mnDiv     : $("#mnDiv_S").val(),
			mnSubject : item.mnSubject,
			mnSubSeq  : newSubSeq,
			mnSortNo  : item.isNoticeRow ? (dataRows.length + 1) : gPasIntChk(item.mnSortNo),
			mnDeptCd  : deptCodeMap[colKey],
			mnCnts    : $("#mnDiv_S").val() === 'MNDIV01' ? value : '',  // 사전공지
			mnEtc     : '',
			mnResult  : $("#mnDiv_S").val() === 'MNDIV02' ? value : '',  // 회의결과
			mnStatus  : '',
			clntPjt   : '',
			clntCd    : '',
			userId    : $('#userId').val(),
			pgmId     : $('#pgmId').val()
		};
		postAjax('/user/pm/pm10/pm10_d03_update', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				mnGridView.setData();
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	// 참석자 update
	function pm10_d02_update() {
		if ($("#mnDiv_S").val() == 'MNDIV99') {
			return false;
		}
		const list = attendList.map(item => {
			const isChecked = $(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
								.is(':checked');
			return {
				attendId:  item.id,
				reasonCd:  isChecked ? 'Y' : 'N',
				reasonRmk: ''
			};
		});
		var paramObj = {
			mnDate	: $('#mnDate_S').val(),
			userId	: $('#userId').val(),
			pgmId	: $('#pgmId').val(),
			attendList: list
		}
		postAjax('/user/pm/pm10/pm10_d02_update', paramObj, null, data => {
			if (data.resultCode == 200) {
				if ($("#mnDiv_S").val() == 'MNDIV02') {
					attendFlag = false;			// 프래그 해제
				}
			} else {
				alert('참석자 저장 실패: ' + data.resultMessage);
			}
		});
	}

	// 참석자 삭제
	function pm10_d02_delete() {
		// 삭제할 대상으로 마킹된 ID 목록
		const toRemoveIds = $('.attend-item.to-remove')
			.map((_, el) => $(el).data('id'))
			.get();
		if (!toRemoveIds.length) {
			alert('삭제할 대상을 클릭해 선택하세요.');
			return;
		}

		// 고정멤버는 체크 해제만, 나머지는 삭제
		const fixedToUncheck   = toRemoveIds.filter(id => FIXED_ORDER.includes(id));
		const nonFixedToDelete = toRemoveIds.filter(id => !FIXED_ORDER.includes(id));

		if (fixedToUncheck.length) {
			attendList = attendList.map(u =>
				fixedToUncheck.includes(u.id)
					? { ...u, reasonCd: 'N' }
					: u
			);
			renderAttendList();
			pm10_d02_update(); // 전체 리스트를 보내서 변경된 reasonCd만 반영
		}

		if (nonFixedToDelete.length) {
			postAjax('/user/pm/pm10/pm10_d02_delete', {
				mnDate: $('#mnDate_S').val(),
				attendIds: nonFixedToDelete
			}, null, data => {
				if (data.resultCode === 200) {
					attendList = attendList.filter(u => !nonFixedToDelete.includes(u.id));
					renderAttendList();
				} else {
					alert('참석자 삭제 실패: ' + data.resultMessage);
				}
			});
		}
	}


	// 첨부파일 Start
	function mnUploadFile () {
		var formData = new FormData();

		formData.append("userId", $("#userId").val());
		formData.append("pgmId",  $("#pgmId").val());

		// 신규 업로드 파일들
		$.each(mnFileArr, function(idx, obj){
			if(obj.fileKey === 0){
			formData.append("files", obj.file);
			}
		});

		// 삭제할 파일 키들
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		formData.append("fileTrgtKey", $("#mnDate_S").val().replace(/-/g, "") + "-" + deptCodeMap[currentFileColumn]);
		formData.append("userId", $("#userId").val());
		formData.append("pgmId",  $("#pgmId").val());

		filePostAjax("/user/pm/pm10/mnUploadFile", formData, function(data){
			mnGridView.setData();
			mnFileArr = [];
			deleteFileArr = [];
		});
	}
	
	//엑셀다운로드
	function excelDown() {
		var paramObj = {};
		$.each($('#main_area [data-search]'), function(idx, elem){
			if ($(elem).hasClass("input_calendar")) {
				paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
			} else {
				paramObj[$(elem).data("search")] = $(elem).val();
			}
		});
		paramObj.userId = jwt.userId;
		paramObj.deptCodes = JSON.stringify(Object.values(deptCodeMap));
		postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
			let list = data.result;
			excelView.target.setData({
				list : list,
				page : {
						totalElements : list.length
							}
			});
			var todayDate = new Date().format('yyyyMMddHHmmss');
			excelView.target.exportExcel("임팀장주간회의록"+todayDate+".xls");
		});       
	}
	
	// 체크박스 렌더링 함수
	function renderAttendList() {
		const container = $('#attendCheckboxContainer').empty();
		attendList.forEach(item => {
			// 체크 상태( reasonCd === 'Y' )를 반영해서 input 에 checked 속성 추가
			const isChecked = item.reasonCd === 'Y';
			const $item = $(`
				<div class="attend-item" data-id="${item.id}">
					<input type="checkbox" class="attend-checkbox" ${isChecked ? 'checked' : ''}/>
					${item.name} ${item.title}
				</div>`
			);

			$item.on('click', function(e) {
				if (!$(e.target).hasClass('attend-checkbox')) {
					$(this).toggleClass('to-remove');
				}
			});

			$item.find('.attend-checkbox').on('change', function() {
				pm10_d02_update();
			});
			container.append($item);
		});
	}

	// 참석자 검색
	function openUserSearch() {
		var paramObj = {
			coCd: $('#coCd_S').val(),      // 필요시 조정
			userId: '', userNm: ''
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html",450, 650, "사용자 검색",paramObj,function(tree) {
			const sel = tree.get_checked()[0];
			const node = tree.get_node(sel);
			if (!attendList.some(u => u.id === node.id)) {
				attendList.push({
					id: node.id,
					name: node.text,
					title: node.original.levelNm,
					reasonCd: 'Y'
				});
				reorderAttendList(); // 참석자 정렬
				renderAttendList();  // 추가한 참석자 랜더링
				pm10_d02_update();	 // 추가한 참석자 Update
			}
		});
	}
	
    
    function gridMaxHeightResize() {
		var gridHeigth  = $('[data-ax5grid="mnGrid-grid"]').find('[data-ax5grid-panel-scroll="body"]').height() 
						+ $('[data-ax5grid="mnGrid-grid"]').find('[data-ax5grid-panel="header"]').height();
		if (gridHeigth > 755) {
			mnGridView.target.setHeight(gridHeigth);
		}
    }


	// ax5grid 세팅 후 아래 함수 호출
	function syncRowHeights() {
		var $rows = $('[data-ax5grid="mnGrid-grid"]').find('[data-ax5grid-panel-scroll="body"] tr');
		var maxHeight = 30;
		$rows.each(function(){
		    var rowHeight = $(this).outerHeight();
		    if(rowHeight > maxHeight) maxHeight = rowHeight;
		});
		// grid에 적용
		var oldConfig = mnGridView.target.config.body || {};
	    mnGridView.target.setConfig({
	        body: $.extend({}, oldConfig, { columnHeight: maxHeight })
	    });
	    mnGridView.target.repaint();
	}
	

	// 선택된 행 하나를 위로 한 칸 이동
	function moveSelectedUp() {
		const grid = mnGridView.target;
		const list = grid.list;
		const sel  = grid.getList("selected")[0];

		if (!sel) {
			alert("이동할 행을 선택하세요");
			return;
		}
		// 공지사항/파일첨부 행은 이동 금지
		if (sel.isNoticeRow || sel.isFileRow) return;

		// 현재 선택된 행의 실제 인덱스
		const idx = list.findIndex(r =>
			r.mnDate   === sel.mnDate &&
			r.mnSubSeq === sel.mnSubSeq
		);
		// 가장 앞(0)이거나 유효하지 않은 인덱스면 리턴
		if (idx <= 0) return;

		// 한 칸 위로 스왑
		[list[idx-1], list[idx]] = [list[idx], list[idx-1]];

		grid.setData({ list, page: { totalElements: list.length } });
		recalcSortOrder();
	}

	// 선택된 행 하나를 아래로 한 칸 이동
	function moveSelectedDown() {
		const grid = mnGridView.target;
		const list = grid.list;
		const sel  = grid.getList("selected")[0];

		if (!sel) {
			alert("이동할 행을 선택하세요");
			return;
		}
		// 공지사항/파일첨부 행은 이동 금지
		if (sel.isNoticeRow || sel.isFileRow) return;

		// 현재 선택된 행의 실제 인덱스
		const idx = list.findIndex(r =>
			r.mnDate   === sel.mnDate &&
			r.mnSubSeq === sel.mnSubSeq
		);
		// 유효하지 않거나 마지막 인덱스이면 리턴
		if (idx < 0 || idx >= list.length - 1) return;

		// 한 칸 아래로 스왑
		[list[idx], list[idx+1]] = [list[idx+1], list[idx]];

		grid.setData({ list, page: { totalElements: list.length } });
		recalcSortOrder();
	}

	// 정렬순서 함수
	function recalcSortOrder() {
		const grid    = mnGridView.target;
		const allRows = grid.list;

		const fileRow   = allRows.find(r => r.isFileRow);
		const noticeRow = allRows.find(r => r.isNoticeRow);
		const dataRows  = allRows.filter(r => !r.isFileRow && !r.isNoticeRow);

		// 로우가 없으면 정렬순서 계산 return
		if (dataRows.length == 0 && noticeRow.mnSortNo == 0) {
			return false;
		}

		dataRows.forEach((row, idx) => {
			row.mnSortNo = idx + 1;
		});

		if (noticeRow) {
			noticeRow.mnSortNo = noticeRow.mnSubSeq > 0
				? dataRows.length + 1
				: 0;
		}

		const newList = [
			...dataRows,
			...(noticeRow ? [noticeRow] : []),
			...(fileRow   ? [fileRow]   : [])
		];
		grid.setData({
			list: newList,
			page: { totalElements: newList.length }
		});

		const sortSave = allRows
			.filter(r => !r.isFileRow && r.mnSubSeq > 0)
			.map(r => ({
				mnSubSeq: r.mnSubSeq,
				mnSortNo: r.mnSortNo
			}))

		var paramObj = {
			mnDate: $('#mnDate_S').val(),
			userId: $('#userId').val(),
			pgmId:  $('#pgmId').val(),
			list:   sortSave
		};

		postAjax('/user/pm/pm10/pm10_d01_sortNo_update', paramObj, null, function(data) {
			if (data.resultCode == 200) {
				// mnGridView.setData();
			}
		});
	}

	//Select 선택 코드값 체크하여 명을 출력
	function getComboName(comboArray, key) {
		let rtnNm = "";
		for (const element of comboArray) {
			if (key.value == element.CD) {
				rtnNm = element.NM;
				break;
			}
		}
		return rtnNm;
	}  

	// 참석자 정렬 함수
	function reorderAttendList() {
		attendList.sort((a, b) => {
			const ia = FIXED_ORDER.indexOf(a.id);
			const ib = FIXED_ORDER.indexOf(b.id);
			if (ia !== -1 && ib !== -1) return ia - ib;  // 둘 다 기본 → 순서대로
			if (ia !== -1) return -1;                    // a는 기본, b는 신규 → a 우선
			if (ib !== -1) return 1;                     // b는 기본, a는 신규 → b 우선
			return 0;                                    // 둘 다 신규 → 추가된 순서 유지
		});
	}

	//임팀장주간회의록 출력
	function setReport(_type = "") {
		var arg =  
			"coCd#"			+  $('#coCd_S').val()
			+ "#mnDate#"		+  $("#mnDate_S").val()
			+ "#mnDiv#"	+  $("#mnDiv_S").val()
			+ "#";                 
		var fileName =  "PM1002M01.jrf" ;
		if (_type == '' || _type == 'S' || _type == undefined ) {
			var todayDate = new Date().format('yyyyMMddHHmmss')
			callReport(fileName, arg, 1150, 720, $('#mnDate_S').val()+'임팀장주간회의록'+ todayDate);
		} else { //Export 작업
			ubiExportAjax(fileName, arg, function(response) {
				if (response.resultCode === 200) {
					var base64FileData = response.base64FileData;
					var fileName = response.exportFileName;
					downloadPDFFromBase64(base64FileData, fileName);
				} else {
					alert('PDF 내보내기 실패: ' + response.resultText);
				}

			});
		}
	}    
</script>
