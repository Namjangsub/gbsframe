<!DOCTYPE html>
<html lang="ko">
<style>
	.attend-item {
		display: inline-block;
		margin: 5px;
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		cursor: pointer;
		user-select: none;
	}
	.attend-item.to-remove {
		background-color: #fdd;
	}
	.attend-item input {
		margin-right: 4px;
		cursor: auto;
	}
    /* Toast UI Custom Styles */
    :root { --border:#dcdcdc; --bg:#f7f7f7; --text:#222; }
    .tui-grid-cell-content { white-space:pre-wrap !important; line-height:1.25; }
    .row-notice .tui-grid-cell, .row-files  .tui-grid-cell { background:#fafafa; font-weight:600; }
    #grid .tui-grid-cell { border-right: 1px solid #dcdcdc !important; border-bottom: 1px solid #dcdcdc !important; }

	/* pm1002: 화면 하단 고정 가로 스크롤바(가로 스크롤은 이걸로만) */
	#grid .tui-grid-body-area { overflow-y: scroll !important; overflow-x: hidden !important; scrollbar-gutter: stable; }
	#grid .tui-grid-summary-area { overflow-x: hidden !important; }
	#grid .tui-grid-scrollbar-left-bottom,
	#grid .tui-grid-scrollbar-right-bottom { display: none !important; }
	.pm1002-hscroll {
		position: fixed;
		bottom: 0;
		height: 16px;
		overflow-x: auto;
		overflow-y: hidden;
		background: #fff;
		border-top: 1px solid #dcdcdc;
		z-index: 9999;
		display: none;
	}
	.pm1002-hscroll__inner { height: 1px; }

	/* pm1002: 셀 선택 Cross Position 표시 */
	#grid td.tui-grid-cell.pm1002-xhair-row,
	#grid td.tui-grid-cell.pm1002-xhair-col {
		background: rgba(135, 206, 235, 0.22) !important;
	}
	#grid td.tui-grid-cell.pm1002-xhair-cell {
		background: transparent !important;
		box-shadow: inset 0 0 0 2px #1e6fff;
	}

	.pm1002-crosshair {
		position: fixed;
		z-index: 9998;
		pointer-events: none;
		display: none;
	}
	.pm1002-crosshair__v,
	.pm1002-crosshair__h {
		position: absolute;
		background: rgba(135, 206, 235, 0.22);
	}
	.pm1002-crosshair__v { top: 0; bottom: 0; width: 0; }
	.pm1002-crosshair__h { left: 0; right: 0; height: 0; }
</style>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
	<link rel="stylesheet" href="/static/css/tui-grid/4.21.22/tui-grid.css" />
	<link rel="stylesheet" href="/static/css/gnb.css" />
	<link rel="stylesheet" href="/static/css/main.css" />
	<link rel="stylesheet" href="/static/css/sub.css" />
	<link rel="stylesheet" href="/static/css/common.css" />
	
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/tui-grid/4.21.22/tui-grid.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
</head>

<body>
  <div id="head_area"></div>
  <div id="top_area"></div>
  <div id="main_area" style="position: static;">
  
		<!-- 페이지 상단 -->
		<!-- <div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="mnGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div> -->
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 5분할 -->
				<table class="table_input type05">

					<tr>
						<!-- <th class= "hit">회사</th>
						<td>
							<select type="hidden" id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required="required" msg="회사">
							</select>
						</td> -->
						<th style="width: 200px; height: 30px; line-height: 30px;font-size: 15px;">임팀장 주간회의 자료</th>

						<th class= "hit">회의일자</th>
						<td>
							<input type="text" id="mnDate_S" class="input_calendar" name="mnDate_S" data-search="mnDate" autocomplete="off" onkeyup="dateMask(this);" required="required" msg="회의일자">
						</td>
						<td style="width: 120px">
							<input id="mnWeeks_S" name="mnWeeks_S" data-search="mnWeeks" style="width:18px; font-size:15px; vertical-align: middle; margin-right:4px;" readonly>
							<span style="font-size:15px; vertical-align: middle;">주차</span>
						</td>
						<th>구분</th>
						<td>
							<select id="mnDiv_S" name="mnDiv_S" data-search="mnDiv"  onchange="mnGridView.setData(0);">
								<option value="MNDIV01" selected>사전공지</option>
								<option value="MNDIV02">회의결과</option>
								<option value="MNDIV99">전체조회</option>
                            </select>
						</td>
						<td></td>
						<td>
							<div class="add_btn_small pdl10" style="width:500px;">
								<a onclick="moveSelectedUp();" id="moveUp"    style="height: 30px; line-height: 28px; margin:0 5px;">▲</a>
								<a onclick="moveSelectedDown();" id="moveDown"  style="height: 30px; line-height: 28px;">▼</a>
								<a onclick="insertMn();" id="addRow" style="width: 80px; height: 30px; line-height: 28px;">행 추가</a>
								<a onclick="deleteMn();" id="deleteRow" style="width: 80px; height: 30px; line-height: 28px;">행 삭제</a>
								<a onclick="setReport();" style="height: 30px; line-height: 28px; width: 100px;"><i class="fas fa-print"></i> 회의록출력</a>
								<a onclick="jsonToExcel(mnGridView);" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
							</div>
						</td>
					</tr>
	            </table>
				<!-- 검색조건 END -->
<form id="mainForm" onSubmit="return false;">
		<input type="hidden" id="userId"    name="userId">
		<input type="hidden" id="deptId"     name="deptId">
		<input type="hidden" id="pgmId"     name="pgmId" value="PM1002M01">
		<input type="hidden" id="coCd_S"     name="coCd_S" value="GUN">
</form>
            </div>
        </div>
		<div class="contents attend-area" style="display: flex; align-items: center;">
			<div id="attendCheckboxContainer" style="flex: 1;"></div>
			<div class="add_btn_small pdl10" style="margin-left: auto; margin-right: 30px">
				<a onclick="openUserSearch()"   id="addAttendBtn"    style="height:30px; line-height:28px;">+</a>
				<a onclick="pm10_d02_delete()"  id="removeAttendBtn" style="height:30px; line-height:28px;">-</a>
			</div>
		</div>

		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 리스트 -->
			<div id="grid" style="width: 100%;"></div>

		</div>

		
		
    </div>
	<div id="pm1002HScroll" class="pm1002-hscroll" aria-hidden="true"><div class="pm1002-hscroll__inner"></div></div>
	<div id="pm1002Crosshair" class="pm1002-crosshair" aria-hidden="true">
		<div class="pm1002-crosshair__v"></div>
		<div class="pm1002-crosshair__h"></div>
	</div>
    <input type="file" id="fileInput" multiple style="display:none" />                
</body>
</html>

<script type="text/javascript">


let currentFileRow = null;
let currentFileColumn = null;
var mnFileArr = [];
var deleteFileArr = [];
let attendFlag = true;	// 구분이 회의결과일 때 참석자 리스트 update를 위한 flag

const DEFAULT_ATTEND_LIST = [
	{ id: 'EMJ8105',    name: '김태호',   title: '부사장' },
	{ id: 'kimjhv',     name: '김재현',   title: '전 무' },
	{ id: 'kimihz',     name: '김일희',   title: '상 무' },
	{ id: 'K98452000',  name: '김동현',   title: '상 무' },
	{ id: 'shjung',     name: '정상훈',   title: '부 장' },
	{ id: 'h4ng10',     name: '허상렬',   title: '부 장' },
	{ id: 'canmtb',     name: '한동주',   title: '과 장' },
	{ id: 'js.nam',     name: '남장섭',   title: '실 장' },
	{ id: 'cyh',        name: '조영희',   title: '부 장' },
	{ id: 'jwc',        name: '조완철',   title: '차 장' },
];
let attendList = DEFAULT_ATTEND_LIST.map(u => ({ ...u }));

const FIXED_ORDER = DEFAULT_ATTEND_LIST.map(u => u.id);

// ==========================================
// Toast UI Grid Custom Editor (Textarea) - jQuery Version
// ==========================================
class TextareaEditor {
    constructor(props) {
        const el = $('<textarea>')
            .addClass('form-control')
            .css({
                width: '100%',
                boxSizing: 'border-box', border: '0',
                outline: 'none', resize: 'none',
                padding: '6px 8px', lineHeight: '1.25',
                overflow: 'hidden'
            })
            .val(String(props.value || ''));

        const autoResize = () => {
             el.css('height', 'auto');
             el.css('height', el[0].scrollHeight + 'px');
        };

        el.on('input', autoResize);

        // Event binding using jQuery
        el.on('keydown', (e) => {
             // Alt+Enter for new line, Enter for save (or reverse depending on preference, here Enter=New Line standard behavior)
             // Let's follow the standard: Enter = New Line in Textarea usually, but in Grid usually Enter = Save.
             // Let's allow Enter to add new line, and Ctrl+Enter to save/exit.
             if (e.key === 'Enter' && !e.ctrlKey) {
                 e.stopPropagation(); // Allow newline
             }
             if (e.key === 'Enter' && e.ctrlKey) {
                 e.preventDefault();
                 props.grid.finishEditing(props.rowKey, props.columnInfo.name);
             }
        });

        this.el = el[0]; // Toast UI expects a DOM element
        this.autoResize = autoResize;
    }
    getElement() { return this.el; }
    getValue() { return $(this.el).val(); }
    mounted() { 
        $(this.el).focus().select(); 
        this.autoResize();
    }
}

// Helper for File Upload Trigger
function triggerFileUploadCheck(row, colKey) {
    const normalRows = mnGridView.target.getData().filter(r => !r.isFileRow);
    const hasDeptValue = normalRows.some(r => r[colKey] && String(r[colKey]).trim());
    if (!hasDeptValue) {
        alert('먼저 해당 부서에 대한 회의 내용을 입력한 후에만 파일을 첨부할 수 있습니다.');
        return;
    }
    currentFileRow = row;
    currentFileColumn = colKey;
    $('#fileInput').trigger('click');
}

// ==========================================
// Toast UI Grid Custom Renderer (File) - jQuery Version
// ==========================================
class FileAttachmentRenderer {
    constructor(props) {
        this.el = $('<div>').css({ width: '100%', padding: '2px' })[0];
        this.render(props);
    }
    getElement() { return this.el; }
    
    render(props) {
        const $el = $(this.el).empty();
        $el.off('click'); // Remove previous handlers
        $el.css({ cursor: 'default' }); // Reset cursor

        const row = props.grid.getRow(props.rowKey);

        // Only render for File Row
        if (!row || !row.isFileRow) {
            if (props.value) {
                $el.append($('<span>').css('white-space', 'pre-wrap').text(props.value));
            }
            return;
        }

        const colKey = props.columnInfo.name;
        const files = (row.filesByColumn && row.filesByColumn[colKey]) || [];
        const isViewMode = $('#mnDiv_S').val() === 'MNDIV99';
        const hasFiles = files.length > 0;

        // 1) File List
        if (hasFiles) {
            const $ul = $('<ul>').css({ padding: 0, margin: 0, listStyle: 'none' });
            
            $.each(files, (i, f) => {
                const $li = $('<li>').attr({'data-idx': i, 'data-col': colKey}).css({ margin: '4px 0', display: 'flex', alignItems: 'center' });
                
                // Remove Button
                if (!isViewMode) {
                    $li.append(
                        $('<button>')
                            .addClass('file-remove')
                            .attr({'data-idx': i, 'data-col': colKey})
                            .css({ width: '30px', height: '18px', lineHeight: '18px', padding: '0', textAlign: 'center', fontSize: '11px', marginRight: '6px', backgroundColor: '#ed2224', color: '#fff', border: 'none', borderRadius: '15px', cursor: 'pointer' })
                            .text('삭제')
                    );
                }

                // File Name (Preview)
                $li.append(
                    $('<span>')
                        .addClass('file-preview')
                        .attr({ 'data-col': colKey, 'data-filekey': f.fileKey, 'data-filename': f.name, 'data-filetype': f.fileType })
                        .css({ whiteSpace: 'nowrap', textDecoration: 'underline', cursor: 'pointer', color: '#0056b3' })
                        .text(f.name)
                );
                $ul.append($li);
            });
            $el.append($ul);
        }

        // 2) Add Button OR Empty Cell Click
        if (!isViewMode) {
             if (hasFiles) {
                 // Files exist: Show Add Button
                 const $btnWrap = $('<div>').css({ textAlign: 'center', marginTop: '8px' });
                 const $addBtn = $('<button>')
                     .addClass('file-add-btn')
                     .attr('data-col', colKey)
                     .css({ width: '30px', height: '18px', lineHeight: '18px', padding: '0', textAlign: 'center', fontSize: '11px', cursor: 'pointer',  marginBottom: '16px', border: 'none', borderRadius: '15px', background: '#3860f8', color: '#fff' })
                     .text('추가');
                 $btnWrap.append($addBtn);
                 $el.append($btnWrap);
             } else {
                 // No files: Make cell clickable
                 $el.css({ cursor: 'pointer', minHeight: '30px' });
                 $el.addClass('file-add-cell').attr('data-col', colKey); // Add class for delegation
             }
        }
    }
}

const deptCodeMap = {
	gun00MnCnts:'GUN00', gun60MnCnts:'GUN60', gun30MnCnts:'GUN30',
	gun40MnCnts:'GUN40', trn5010MnCnts:'TRN5010', trn5020MnCnts:'TRN5020',
	gun10MnCnts:'GUN10', gun80MnCnts:'GUN80', gun70MnCnts: 'GUN70'
};

var mnGridView = {
    initView: function() {
        // Theme Application
        tui.Grid.applyTheme('default', {
            cell: {
                normal: { showVerticalBorder: true, showHorizontalBorder: true, border: '#dcdcdc' },
                header: { showVerticalBorder: true, showHorizontalBorder: true, border: '#dcdcdc', background: '#f7f7f7' }
            }
        });

		this.target = new tui.Grid({
            el: $('#grid')[0], // jQuery object to DOM
            scrollX: true,
            scrollY: true,
			bodyHeight: 'fitToParent',
			draggable: true,
            rowHeight: 'auto', // Auto height for multiline
            minRowHeight: 40,
            columns: [
                { header: 'PROJECT\n주제', name: 'mnSubject', width: 120, editor: { type: TextareaEditor }, validation: { dataType: 'string' } },
                { header: '영업\n국내/해외', name: 'gun30MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '생산', name: 'gun60MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '기술연구소', name: 'gun40MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '기계/직접매출', name: 'trn5010MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '전기', name: 'trn5020MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: 'S.PM', name: 'gun70MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '전산', name: 'gun80MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '경영지원,회계', name: 'gun10MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '임원', name: 'gun00MnCnts', width: 220, renderer: { type: FileAttachmentRenderer }, editor: { type: TextareaEditor } },
                { header: '비고', name: 'mnEtcAll', width: 200, editor: { type: TextareaEditor } }
            ],
            columnOptions: {
                resizable: true,
                frozenCount: 1 // Freeze 'PROJECT/주제' column
            }
		});

		// 레이아웃/리렌더 이후 pinned 가로 스크롤바 재측정
		try {
			this.target.on('onGridUpdated', function() { setTimeout(pm1002_updatePinnedHScrollMetrics, 0); });
		} catch(e) {}
		try {
			this.target.on('onGridUpdated', function() { setTimeout(pm1002_reapplyCrosshair, 0); });
		} catch(e) {}

		// Row Drag&Drop: 공지/파일 행은 드래그 금지 + 드롭 후 정렬순서(mnSortNo) 갱신
		try {
			this.target.on('dragStart', function(ev) {
				try {
					var rows = (ev && ev.rows) ? ev.rows : [];
					for (var i = 0; i < rows.length; i++) {
						var r = rows[i];
						if (r && (r.isNoticeRow || r.isFileRow)) {
							if (ev && typeof ev.stop === 'function') ev.stop();
							return;
						}
					}
				} catch(e2) {}
			});
			this.target.on('drop', function() {
				try { pm1002_afterRowReorder(); } catch(e2) {}
			});
		} catch(e) {}

		// 셀 포커스 이동 시 Crosshair 업데이트
		try {
			this.target.on('focusChange', function() { setTimeout(pm1002_updateCrosshairForFocusedCell, 0); });
		} catch(e) {}

		// Event Handling
		this.target.on('editingStart', (ev) => {
             const row = mnGridView.target.getRow(ev.rowKey);
             // Disable editing for File Attachment Row or Notice Row (except specifics if needed)
             if (row.isFileRow) {
                 ev.stop();
                 return;
             }
             if (row.isNoticeRow && ev.columnName !== 'mnSubject') {
                  // Notice row normally only allows editing specific columns or none? 
                  // Original: disabled: function () {return this.item.isFileRow || this.item.isNoticeRow;} for 'mnSubject'
                  // But other columns were editable? Original AX5 config didn't explicitly disable others for Notice.
                  // Let's assume Notice row content columns are editable.
             }
             if (ev.columnName === 'mnSubject' && (row.isFileRow || row.isNoticeRow)) {
                  ev.stop();
             }
        });




        this.target.on('afterChange', (ev) => {
            $.each(ev.changes, (i, change) => {
                const row = mnGridView.target.getRow(change.rowKey);
                if (change.columnName === 'mnSubject' || change.columnName === 'mnStatus' || change.columnName === 'mnEtcAll') {
                    pm10_d01_update(row, change.columnName, change.value);
                } else {
                    pm10_d03_update(row, change.columnName, change.value);
                }
                
                if (!row.isNoticeRow) {
                    recalcSortOrder();
                }
            });
        });

		return this;
	},
     setData: function(_pageNo) {
        var paramObj = {};
        $.each($('#main_area [data-search]'), function(idx, elem){
            if ($(elem).hasClass("input_calendar")) {
                paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
            } else {
                paramObj[$(elem).data("search")] = $(elem).val();
            }
        });
        paramObj.userId    = jwt.userId;
        paramObj.deptCodes = JSON.stringify(Object.values(deptCodeMap));

		postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
           // try {
                var list = Array.isArray(data.result) ? data.result : [];
                var rows = list.filter(r => r.rnum !== undefined);

                // Notice Row Logic
                let noticeRow = rows.find(r => r.mnSubject === '공지사항');
                if (!noticeRow) {
                    noticeRow = {
                        mnDate:      $('#mnDate_S').val(),
                        mnWeeks:     $('#mnWeeks_S').val(),
                        mnSubSeq:    0,
                        mnSubject:   '공지사항',
                        mnSortNo:    0,
                        isNoticeRow: true,
                         gun00MnCnts: '', gun30MnCnts: '', gun40MnCnts: '', gun60MnCnts: '',
                         trn5010MnCnts: '', trn5020MnCnts: '', gun10MnCnts: '', gun80MnCnts: '',
                         mnStatus:    '', mnEtcAll:   ''
                    };
                } else {
                    noticeRow.isNoticeRow = true;
                }

                // File Row Logic
                const fileEntry   = list.find(r => typeof r.files === 'string');
                const parsedFiles = fileEntry ? JSON.parse(fileEntry.files) : [];

                const fileRow = {
                    mnDate:        $('#mnDate_S').val(),
                    mnWeeks:       $('#mnWeeks_S').val(),
                    mnSubSeq:      0,
                    mnSubject:     '파일첨부',
                     gun00MnCnts:   '', gun30MnCnts:   '', gun40MnCnts:   '', gun60MnCnts:   '',
                     trn5010MnCnts: '', trn5020MnCnts: '', gun10MnCnts:   '', gun80MnCnts:   '',
                     mnStatus:      '', mnEtcAll:      '',
                    mnSortNo:      0,
                    isFileRow:     true,
                    filesByColumn: {}
                };

                parsedFiles.forEach(f => {
                    const deptCode = String(f.fileTrgtKey).split('-').length >= 2 ? String(f.fileTrgtKey).split('-')[1] : '';
                    const colKey = Object.keys(deptCodeMap).find(key => deptCodeMap[key] === deptCode);
                    if (!colKey) return;

                    if (!fileRow.filesByColumn[colKey]) {
                        fileRow.filesByColumn[colKey] = [];
                    }
                    fileRow.filesByColumn[colKey].push({
                        name:     f.fileName,
                        fileKey:  f.fileKey,
                        fileType: f.fileType
                    });
                });

                // Sort and Merge
                const nonNoticeRows = rows.filter(r => r.mnSubject !== '공지사항');
                const merged = [...nonNoticeRows, noticeRow, fileRow].sort((a, b) => {
                    if (a.isFileRow) return 1;
                    if (b.isFileRow) return -1;
                    if (a.isNoticeRow) return 1;
                    if (b.isNoticeRow) return -1;
                    return ( (a.mnSortNo || 0) - (b.mnSortNo || 0) );
                });

                // Apply View Mode Logic (Pre/Result/All)
                const deptCols = Object.keys(deptCodeMap);
                merged.forEach(item => {
                    deptCols.forEach(colKey => {
                        const cntsVal   = item[colKey] || '';
                        const resultKey = colKey.replace('MnCnts','MnResult');
                        const resultVal = item[resultKey] || '';

                        if ($('#mnDiv_S').val() === 'MNDIV01') {
                            item[colKey] = cntsVal;
                        }
                        else if ($('#mnDiv_S').val() === 'MNDIV02') {
                             item[colKey] = (resultVal) ? resultVal : cntsVal;
                        }
                        else if ($('#mnDiv_S').val() === 'MNDIV99') {
                            let parts = [];
                            if (cntsVal) parts.push(`[사전공지]\n${cntsVal}`);
                            if (resultVal) parts.push(`[회의결과]\n${resultVal}`);
                            item[colKey] = parts.length ? parts.join('\n\n') : '';
                        }
                    });
                });

				mnGridView.target.resetData(merged);
				try { setTimeout(pm1002_updatePinnedHScrollMetrics, 0); } catch(e) {}
                
                // Add class for styling special rows
                const gridData = mnGridView.target.getData();
                 $.each(gridData, (i, r) => {
                     if (r.isNoticeRow) mnGridView.target.addRowClassName(r.rowKey, 'row-notice');
                     if (r.isFileRow) mnGridView.target.addRowClassName(r.rowKey, 'row-files');
                 });

                select_p10_d02_List(data.d02List || []);
                recalcSortOrder();
                
        //    } catch (error) {
        //        alert("오류 발생!! 전산실 연락 바랍니다: " + error.message);
        //        console.error(error);
        //    }
		});
	}
}

	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    
		// 회사 초기화
		$('#mnDate_S').val(moment().day(5).format('YYYY-MM-DD'));
	}

	$(document).ready(function() {
		//초기설정들
		mainDefaultLoad("사업계획", "임팀장주간회의록");
		setCommonSelect($("#main_area select[data-kind]"));

		// 화면 크기 조절
		$("#top_area").hide();
		$('#head_area').toggleClass('off');
		$('#main_area').toggleClass('on');

		$("#userId").val(jwt.userId);
		$("#deptId").val(jwt.deptId);

		$('.attend-area').hide(); // 참석자 리스트 기본 숨김
		
		// 종료일 (현재날짜의 월 말일)
		$('#mnDate_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true,
			beforeShowDay: function(date) {
				// 5 = 금요일만 선택가능하게 하기
				return date.getDay() === 5;
			}
		}).datepicker("setDate", moment().day(5).toDate())
		.on('changeDate change', function() {
			// 주차 업데이트
			$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
			
			// 그리드 초기화 및 재조회
			mnGridView.target.resetData([]); 
			mnGridView.setData(0);
		});
		$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
		
		// 접속자 회사 set
		$("#userId").val(jwt.userId);
		
		// 참석자 삭제("-") 버튼
		$('#removeAttendBtn').on('click', () => {
			const toRemoveIds = $('.attend-item.to-remove')
								.map((_,el)=>$(el).data('id'))
								.get();
			if (!toRemoveIds.length) {
				return;
			}
			attendList = attendList.filter(u => !toRemoveIds.includes(u.id));
			renderAttendList();
		});
				
		mnGridView.initView().setData();
		try { pm1002_initPinnedHScroll(); } catch(e) {}
		try { pm1002_initCrosshair(); } catch(e) {}



		// 구분 변경 시
		$('#mnDiv_S').on('change', function (){
			if ($('#mnDiv_S').val() === 'MNDIV01') {
				$('.attend-area').hide();
				
			}
			else if ($('#mnDiv_S').val() === 'MNDIV02') {
				// 구분이 회의결과로 바뀌면 참석자 리스트 UPDATE 하고 attendFlag를 false로 변경 -> 이 로직은 회의결과로 들어왔을 때 딱 한번 참석자 리스트 업데이트 하기 위함
				if (attendFlag) {
					pm10_d02_update();
				}

				$('.attend-area').show().css('pointer-events', 'auto');
				$('#addAttendBtn, #removeAttendBtn').show();
				$('#attendCheckboxContainer input.attend-checkbox').prop('disabled', false).css('pointer-events', 'auto').css('cursor', 'pointer');
			}
			else if ($('#mnDiv_S').val() === 'MNDIV99') {
				$('.attend-area').show().css('pointer-events', 'none');
				$('#addAttendBtn, #removeAttendBtn').hide();
				$('#attendCheckboxContainer input.attend-checkbox').prop('disabled', true).css('pointer-events', 'none').css('cursor', 'default');
			}
            setTimeout(showSize, 50);
		});

		// 왼쪽 사이드바 닫기 버튼 클릭 시 그리드 데이터 셋팅 
		$('.off_btn').on('click', function(e){
			mnGridView.setData(0);
		});

		$('#fileInput').on('change', function(){
			if (!currentFileRow || !currentFileColumn) return;
			Array.from(this.files).forEach(file => {
				// 서버 전송용 배열에 넣고
				mnFileArr.push({ fileKey: 0, file, row: currentFileRow, column: currentFileColumn });
				// 화면용 컬럼별 배열에 추가
				currentFileRow.filesByColumn = currentFileRow.filesByColumn || {};
				currentFileRow.filesByColumn[currentFileColumn] = currentFileRow.filesByColumn[currentFileColumn] || [];
				currentFileRow.filesByColumn[currentFileColumn].push({ name: file.name, fileKey: 0 });
			});
			mnGridView.target.setRow(currentFileRow.rowKey, currentFileRow);

			mnUploadFile();
			$(this).val('');
			currentFileRow = null;
			currentFileColumn = null;
		});

		// 파일 추가
		$('#grid').on('click', '.file-add-btn, .file-add-cell', function(e) {
		    // Note: This handler might duplicate with the one inside Renderer if Renderer attaches its own.
		    // Since Renderer attaches to button directly, this delegation might be redundant or valid fallback.
		    // Let's keep it but update logic just in case.
			const colKey = $(this).data('col');
			const data = mnGridView.target.getData();
			const fileRow = data.find(r => r.isFileRow === true);
			if (!fileRow) return;

			const normalRows = data.filter(r => !r.isFileRow);
			const hasDeptValue = normalRows.some(r => r[colKey] && String(r[colKey]).trim());
			if (!hasDeptValue) {
				alert('먼저 해당 부서에 대한 회의 내용을 입력한 후에만 파일을 첨부할 수 있습니다.');
				return;
			}

			currentFileRow = fileRow;
			currentFileColumn = colKey;
			$('#fileInput').trigger('click');
		});

		// 파일 삭제
		$('#grid').on('click', '.file-remove', function(e) {
			e.stopPropagation();
			const idx = $(this).data('idx');
			const colKey = $(this).data('col');
			
			// In Toast UI, simple click on button inside cell doesn't set focus row automatically if we prevent default?
			// But for file row, we can just find the file row.
			const row = mnGridView.target.getData().find(r => r.isFileRow);
            
			if (row && row.filesByColumn && row.filesByColumn[colKey]) {
				const removed = row.filesByColumn[colKey].splice(idx, 1)[0];
				deleteFileArr.push({ fileKey: removed.fileKey });

				// mnGridView.target.repaint(); // Not needed if we resetData
				// Update row data
				mnGridView.target.setRow(row.rowKey, row);
				
				mnUploadFile();
			}
		});
		
		// 이미지 미리보기
		$('#grid').on('click', '.file-preview', function() {
			const fileKey = $(this).data('filekey');
			const fileName = $(this).data('filename');
			const colKey = $(this).data('col');

			const row = mnGridView.target.getData().find(r => r.isFileRow);
			if (!row) return;
			
			const allFiles = row.filesByColumn[colKey];
			const imageList = allFiles
				.map(f => ({
					fileKey: Number(f.fileKey),
					fileName: f.name,
					coCd: $('#coCd_S').val()
				}));
			imageViewPopup('GUN', fileKey, fileName, imageList);
		});

		$(window).on('resize', showSize);
		$(function() { showSize(); });
		
		
		//권한체크
// 		authChk();	
			
	});

	// =========================
	// pm1002: 화면 하단 고정 가로 스크롤바(그리드 body scrollLeft 동기화)
	// =========================
	var pm1002_PINNED_HSCROLL_HEIGHT = 18;
	var __pm1002HScroll = {
		initialized: false,
		barEl: null,
		innerEl: null,
		bodyEl: null,
		syncing: false,
		boundBodyScroll: null
	};

	function pm1002_getGridBodyScrollEl() {
		var root = document.getElementById('grid');
		if (!root) return null;
		// frozenCount 사용 시 rside body가 가로 스크롤 주체
		return root.querySelector('.tui-grid-rside-area .tui-grid-body-area') || root.querySelector('.tui-grid-body-area');
	}

	function pm1002_updatePinnedHScrollPosition() {
		if (!__pm1002HScroll.barEl) return;
		var gridEl = document.getElementById('grid');
		if (!gridEl) return;
		var rect = gridEl.getBoundingClientRect();
		// 뷰포트 기준으로 그리드 폭/좌표에 맞춰 하단 스크롤바를 정렬
		__pm1002HScroll.barEl.style.left = rect.left + 'px';
		__pm1002HScroll.barEl.style.width = rect.width + 'px';
	}

	function pm1002_updatePinnedHScrollMetrics() {
		if (!__pm1002HScroll.initialized) return;
		var bodyEl = pm1002_getGridBodyScrollEl();
		if (!bodyEl) return;

		// body element가 재생성되면(scroll/refreshLayout) 리스너 재바인딩
		if (__pm1002HScroll.bodyEl !== bodyEl) {
			if (__pm1002HScroll.bodyEl && __pm1002HScroll.boundBodyScroll) {
				try { __pm1002HScroll.bodyEl.removeEventListener('scroll', __pm1002HScroll.boundBodyScroll); } catch(e) {}
			}
			__pm1002HScroll.bodyEl = bodyEl;
			__pm1002HScroll.boundBodyScroll = function() {
				if (__pm1002HScroll.syncing) return;
				__pm1002HScroll.syncing = true;
				try { __pm1002HScroll.barEl.scrollLeft = __pm1002HScroll.bodyEl.scrollLeft; } catch(e) {}
				__pm1002HScroll.syncing = false;
			};
			try { __pm1002HScroll.bodyEl.addEventListener('scroll', __pm1002HScroll.boundBodyScroll, { passive: true }); } catch(e) {
				try { __pm1002HScroll.bodyEl.addEventListener('scroll', __pm1002HScroll.boundBodyScroll); } catch(e2) {}
			}
		}
		// 세로/가로 스크롤에 따라 crosshair 재계산
		try {
				if (__pm1002HScroll.bodyEl && __pm1002Crosshair && __pm1002Crosshair.initialized) {
					if (!__pm1002Crosshair.boundOnScroll) {
					__pm1002Crosshair.boundOnScroll = function() { try { pm1002_reapplyCrosshair(); } catch(e) {} };
					}
					// 중복 등록 방지: remove 후 add
					try { __pm1002HScroll.bodyEl.removeEventListener('scroll', __pm1002Crosshair.boundOnScroll); } catch(e2) {}
					try { __pm1002HScroll.bodyEl.addEventListener('scroll', __pm1002Crosshair.boundOnScroll, { passive: true }); } catch(e3) {
						try { __pm1002HScroll.bodyEl.addEventListener('scroll', __pm1002Crosshair.boundOnScroll); } catch(e4) {}
					}
				}
		} catch(e) {}

		pm1002_updatePinnedHScrollPosition();
		var scrollWidth = __pm1002HScroll.bodyEl.scrollWidth || 0;
		var clientWidth = __pm1002HScroll.bodyEl.clientWidth || 0;
		__pm1002HScroll.innerEl.style.width = scrollWidth + 'px';

		var needHScroll = scrollWidth > (clientWidth + 1);
		__pm1002HScroll.barEl.style.display = needHScroll ? 'block' : 'none';
		if (needHScroll) {
			// 현재 위치 동기화
			try { __pm1002HScroll.barEl.scrollLeft = __pm1002HScroll.bodyEl.scrollLeft; } catch(e) {}
		}
	}

	function pm1002_initPinnedHScroll() {
		if (__pm1002HScroll.initialized) return;
		__pm1002HScroll.barEl = document.getElementById('pm1002HScroll');
		if (!__pm1002HScroll.barEl) return;
		__pm1002HScroll.innerEl = __pm1002HScroll.barEl.querySelector('.pm1002-hscroll__inner');
		if (!__pm1002HScroll.innerEl) return;
		__pm1002HScroll.initialized = true;

		var onBarScroll = function() {
			if (!__pm1002HScroll.bodyEl) return;
			if (__pm1002HScroll.syncing) return;
			__pm1002HScroll.syncing = true;
			try { __pm1002HScroll.bodyEl.scrollLeft = __pm1002HScroll.barEl.scrollLeft; } catch(e) {}
			__pm1002HScroll.syncing = false;
		};
		try { __pm1002HScroll.barEl.addEventListener('scroll', onBarScroll, { passive: true }); } catch(e) {
			try { __pm1002HScroll.barEl.addEventListener('scroll', onBarScroll); } catch(e2) {}
		}

		window.addEventListener('resize', function() {
			pm1002_updatePinnedHScrollMetrics();
		});

		// 초기 1회 (그리드 DOM 생성 이후)
		setTimeout(pm1002_updatePinnedHScrollMetrics, 0);
	}
	
	function showSize() {
	    // 1. Ensure the page starts at the top for accurate top position calculation
	    window.scrollTo(0, 0);
	    
	    const winHeight = window.innerHeight;
	    
	    // 2. Lock page-level scrolling to force grid-internal scrolling only
	    $('html, body').css({
	        'overflow': 'hidden',
	        'height': '100%'
	    });
	    
	    // 3. Let main_area be natural height to avoid interfering with calculation
	    $('#main_area').css('height', 'auto');
    	
		if (mnGridView && mnGridView.target) {
            const gridEl = document.getElementById('grid');
            if (gridEl) {
                const rect = gridEl.getBoundingClientRect();
                // 4. Calculate exactly what height is left for the grid
                // Offset by a small margin (e.g., 20px) for bottom breathing room
				const availableHeight = winHeight - rect.top +21;
                
				mnGridView.target.setHeight(Math.max(300, availableHeight-20));
				mnGridView.target.refreshLayout();
				try { pm1002_updatePinnedHScrollMetrics(); } catch(e) {}
				try { pm1002_updateCrosshairForFocusedCell(); } catch(e) {}
			}
		}
	}
	
	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    

		$('#mnDate_S').val(moment().day(5).format('YYYY-MM-DD'));
		$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
		
		// 재검색
		mnGridView.setData(0);
	}

	// 참석자 리스트 불러오기 & 렌더링
	function select_p10_d02_List(list) {
			if (list.length > 0) {
				attendList = list.map(user => ({
					id:       user.id,
					name:     user.name,
					title:    user.title,
					reasonCd: user.reasonCd
				}));
			} else {
				// 기본 참여자 전부를 reasonCd: 'Y' 로 설정
				attendList = DEFAULT_ATTEND_LIST.map(user => ({...user, reasonCd: 'Y'}));
			}

			// 고정 멤버 순서대로 정렬
			reorderAttendList();

			// 렌더링
			renderAttendList();
		
			// DB에서 Y인 것만 체크
			attendList.forEach(item => {
				if (item.reasonCd === 'Y') {
					$(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
					.prop('checked', true);
				}
			});
	}

	// 행 추가
	function insertMn() {
		const grid = mnGridView.target;
		const focused = grid.getFocusedCell();
		let selected = null;
		
		if (focused && focused.rowKey != null) {
			selected = grid.getRow(focused.rowKey);
		}

		let insertIndex;
		const data = grid.getData();
		
		if (selected) {
			if (selected.mnSubject === "공지사항") {
				return false;
			}
			// Find index of the selected row
			const selIdx = grid.getIndexOfRow(selected.rowKey);
			// Logic: Insert after the selected row group? 
			// Original logic: find last index matching mnDate & mnSubSeq + 1. 
			// But here we can't easily iterate visible rows with merged logic if data is just array.
			// Let's simplified: insert after the selected row.
			insertIndex = selIdx + 1;
		} else {
		    // Default: Insert after '공지사항' or at the end
			const noticeRow = data.find(r => r.mnSubject === '공지사항');
			if (noticeRow) {
			    insertIndex = grid.getIndexOfRow(noticeRow.rowKey);
			} else {
			    insertIndex = data.length;
			}
		}

		// 새 행 객체 생성
		const newRow = {
			mnDate:      $('#mnDate_S').val(),
			mnWeeks:     $('#mnWeeks_S').val(),
			mnSubSeq:    0,      // 서버에서 INSERT 시 발급
			mnSubject:   '',
			mnSortNo:    0,      // 임시값
			isNoticeRow: false,
			isFileRow:   false
		};

		// 행 추가
		grid.appendRow(newRow, { at: insertIndex });
		recalcSortOrder();
	}

	// 행 삭제
	function deleteMn() {
		const grid = mnGridView.target;
		const data = grid.getData();
		const fileRow = data.find(r => r.isFileRow);
		
		const focused = grid.getFocusedCell();
		if (!focused || focused.rowKey == null) {
			alert("삭제할 주제를 선택하세요!");
			return false;
		}
		const sel = grid.getRow(focused.rowKey);
		
		if (!sel) return;

		if (sel.mnSubject == "파일첨부" || ((sel.mnSubSeq == 0) && (sel.mnSubject == '공지사항'))) {
			return false;
		}

		// 빈행(mnSubSeq===0) 삭제
		if (!sel.mnSubSeq) {
			grid.removeRow(sel.rowKey);
			return;
		}

		// 행(mnSubSeq > 0) 삭제
		const deptCols = Object.keys(deptCodeMap);
		const hasResult = deptCols.some(colKey => {
			const resultKey = colKey.replace('MnCnts', 'MnResult');
			return sel[resultKey] && sel[resultKey].toString().trim() !== '';
		});
		if (hasResult) {
			alert("회의결과가 있는 행은 삭제할 수 없습니다.");
			return false;
		}
		if (!confirm("선택한 행을 정말 삭제하시겠습니까?")) {
			return false;
		}
		var paramObj = {
			mnDate		: sel.mnDate,
			mnSubSeq	: sel.mnSubSeq,
			fileInfoJson 	: JSON.stringify(fileRow ? (fileRow.filesByColumn || {}) : {})
		}
		postAjax("/user/pm/pm10/deleteMn", paramObj, null, function(data) {
			if (data.resultCode == 200) {
				mnGridView.setData();
			} else {
				alert("삭제 실패: " + data.resultMessage);
			}
		});
	}
	
	//회의 주제 Insert, Update
	function pm10_d01_update(item, colKey, value) {
		item[colKey] = value;

		// 일반 주제행 목록
		const normalRows = mnGridView.target.getData().filter(r => !r.isFileRow && !r.isNoticeRow);

		let newSubSeq;
		let newSortNo;


		// 현재 존재하는 mnSubSeq의 최대값을 구한다
		const maxSeq = normalRows.reduce((max, r) => Math.max(max, r.mnSubSeq || 0), 0);

		if (item.isNoticeRow) {
			// 신규 공지사항
			newSubSeq  = item.mnSubSeq > 0 ? item.mnSubSeq : maxSeq + 1;
			newSortNo = normalRows.length + 1;
			// 화면에도 반영
			item.mnSubSeq = newSubSeq;
			item.mnSortNo = newSortNo;
		}
		else {
			// 일반 주제
			newSubSeq  = item.mnSubSeq > 0 ? item.mnSubSeq : maxSeq + 1;
			newSortNo = normalRows.findIndex(r => r === item) + 1;
			item.mnSortNo = newSortNo;
		}

		var paramObj = {
			mnDate		: $('#mnDate_S').val(),
			mnWeeks		: $('#mnWeeks_S').val(),
			mnSubSeq	: newSubSeq,
			mnSubject	: item.mnSubject,
			mnSortNo	: newSortNo,
			mnEtcAll	: item.mnEtcAll,
			mnStatus	: item.mnStatus,
			userId		: $('#userId').val(),
			pgmId		: $('#pgmId').val()
		};

		postAjax('/user/pm/pm10/pm10_d01_update', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				// mnGridView.setData(); // Prevent refresh to keep unsaved rows and visual order
				if (data.mnSubSeq) {
					item.mnSubSeq = data.mnSubSeq;
				}
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	//팀별 회의 내용 Insert, Update
	function pm10_d03_update(item, colKey, value) {
		// 기존 행들 중 공지·파일 행을 제외하고, seq가 0보다 큰 행만 모은다
		const dataRows = mnGridView.target.getData().filter(r => 
			!r.isFileRow && !r.isNoticeRow && r.mnSubSeq > 0
		);

		// 현재 존재하는 mnSubSeq의 최대값을 구한다. 없으면 0
		const maxSeq = dataRows.reduce((max, r) => Math.max(max, r.mnSubSeq || 0), 0);

		// 신규이면 maxSeq + 1, 아니면 기존 seq 유지
		const newSubSeq = item.mnSubSeq > 0 ? item.mnSubSeq : (maxSeq + 1);

		const mnDeptCd = deptCodeMap[colKey];
		if (!mnDeptCd) {
			// deptCodeMap에 없는 컬럼이면 업데이트 대상 아님 (혹은 오류)
			return;
		}

		var paramObj = {
			mnDate    : $('#mnDate_S').val(),
			mnWeeks   : $('#mnWeeks_S').val(),
			mnDiv     : $("#mnDiv_S").val(),
			mnSubject : item.mnSubject,
			mnSubSeq  : newSubSeq,
			mnSortNo  : item.isNoticeRow ? (dataRows.length + 1) : gPasIntChk(item.mnSortNo),
			mnDeptCd  : mnDeptCd,
			mnCnts    : $("#mnDiv_S").val() === 'MNDIV01' ? value : '',  // 사전공지
			mnEtc     : '',
			mnResult  : $("#mnDiv_S").val() === 'MNDIV02' ? value : '',  // 회의결과
			mnStatus  : '',
			clntPjt   : '',
			clntCd    : '',
			userId    : $('#userId').val(),
			pgmId     : $('#pgmId').val()
		};
		postAjax('/user/pm/pm10/pm10_d03_update', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				// mnGridView.setData(); // Prevent refresh
				// Update subSeq if needed (though mnSubSeq for d03 usually comes from item already)
				// d03 update might insert row if subSeq was 0? Logic says d03 requires subSeq > 0 filter?
				// Actually pm10_d03_update logic: newSubSeq = item.mnSubSeq > 0 ? ... : (maxSeq + 1)
				// So if we inserted, we should update item.mnSubSeq
				if (data.mnSubSeq) {
					item.mnSubSeq = data.mnSubSeq;
				}
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	// 참석자 update
	function pm10_d02_update() {
		if ($("#mnDiv_S").val() == 'MNDIV99') {
			return false;
		}
		const list = attendList.map(item => {
			const isChecked = $(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
								.is(':checked');
			return {
				attendId:  item.id,
				reasonCd:  isChecked ? 'Y' : 'N',
				reasonRmk: ''
			};
		});
		var paramObj = {
			mnDate	: $('#mnDate_S').val(),
			userId	: $('#userId').val(),
			pgmId	: $('#pgmId').val(),
			attendList: list
		}
		postAjax('/user/pm/pm10/pm10_d02_update', paramObj, null, data => {
			if (data.resultCode == 200) {
				if ($("#mnDiv_S").val() == 'MNDIV02') {
					attendFlag = false;			// 프래그 해제
				}
			} else {
				alert('참석자 저장 실패: ' + data.resultMessage);
			}
		});
	}

	// 참석자 삭제
	function pm10_d02_delete() {
		// 삭제할 대상으로 마킹된 ID 목록
		const toRemoveIds = $('.attend-item.to-remove')
			.map((_, el) => $(el).data('id'))
			.get();
		if (!toRemoveIds.length) {
			alert('삭제할 대상을 클릭해 선택하세요.');
			return;
		}

		// 고정멤버는 체크 해제만, 나머지는 삭제
		const fixedToUncheck   = toRemoveIds.filter(id => FIXED_ORDER.includes(id));
		const nonFixedToDelete = toRemoveIds.filter(id => !FIXED_ORDER.includes(id));

		if (fixedToUncheck.length) {
			attendList = attendList.map(u =>
				fixedToUncheck.includes(u.id)
					? { ...u, reasonCd: 'N' }
					: u
			);
			renderAttendList();
			pm10_d02_update(); // 전체 리스트를 보내서 변경된 reasonCd만 반영
		}

		if (nonFixedToDelete.length) {
			postAjax('/user/pm/pm10/pm10_d02_delete', {
				mnDate: $('#mnDate_S').val(),
				attendIds: nonFixedToDelete
			}, null, data => {
				if (data.resultCode === 200) {
					attendList = attendList.filter(u => !nonFixedToDelete.includes(u.id));
					renderAttendList();
				} else {
					alert('참석자 삭제 실패: ' + data.resultMessage);
				}
			});
		}
	}


	// 첨부파일 Start
	function mnUploadFile () {
		var formData = new FormData();

		formData.append("userId", $("#userId").val());
		formData.append("pgmId",  $("#pgmId").val());

		// 신규 업로드 파일들
		$.each(mnFileArr, function(idx, obj){
			if(obj.fileKey === 0){
			formData.append("files", obj.file);
			}
		});

		// 삭제할 파일 키들
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		formData.append("fileTrgtKey", $("#mnDate_S").val().replace(/-/g, "") + "-" + deptCodeMap[currentFileColumn]);
		formData.append("userId", $("#userId").val());
		formData.append("pgmId",  $("#pgmId").val());

		filePostAjax("/user/pm/pm10/mnUploadFile", formData, function(data){
			mnGridView.setData();
			mnFileArr = [];
			deleteFileArr = [];
		});
	}

	// 엑셀다운로드
	// 엑셀다운로드
	function jsonToExcel(grid) {
		const rawData = grid.target.getData();
		const rawCols = grid.target.getColumns();

		// Process data to show file names in File Row
		const list = rawData.map(row => {
			if (row.isFileRow && row.filesByColumn) {
				// Clone row to avoid modifying grid data
				const newRow = { ...row };
				Object.keys(newRow.filesByColumn).forEach(colKey => {
					const files = newRow.filesByColumn[colKey];
					if (Array.isArray(files) && files.length > 0) {
						newRow[colKey] = files.map(f => f.name).join(', ');
					}
				});
				return newRow;
			}
			return row;
		});

		const header = rawCols.map(col => ({
			key: col.name,
			label: String(col.header)
				.replace(/<br\s*\/?>/gi, "\r\n")
				.replace(/<\/?[^>]+>/g, "")
		}));

		exportJSONToExcel(list, header, "임팀장주간회의록");
	}
	
	// 체크박스 렌더링 함수
	function renderAttendList() {
		const container = $('#attendCheckboxContainer').empty();
		attendList.forEach(item => {
			// 체크 상태( reasonCd === 'Y' )를 반영해서 input 에 checked 속성 추가
			const isChecked = item.reasonCd === 'Y';
			const $item = $(`
				<div class="attend-item" data-id="${item.id}">
					<input type="checkbox" class="attend-checkbox" ${isChecked ? 'checked' : ''}/>
					${item.name} ${item.title}
				</div>`
			);

			$item.on('click', function(e) {
				if (!$(e.target).hasClass('attend-checkbox')) {
					$(this).toggleClass('to-remove');
				}
			});

			$item.find('.attend-checkbox').on('change', function() {
				pm10_d02_update();
			});
			container.append($item);
		});
	}

	// 참석자 검색
	function openUserSearch() {
		var paramObj = {
			coCd: $('#coCd_S').val(),      // 필요시 조정
			userId: '', userNm: ''
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html",450, 650, "사용자 검색",paramObj,function(tree) {
			const sel = tree.get_checked()[0];
			const node = tree.get_node(sel);
			if (!attendList.some(u => u.id === node.id)) {
				attendList.push({
					id: node.id,
					name: node.text,
					title: node.original.levelNm,
					reasonCd: 'Y'
				});
				reorderAttendList(); // 참석자 정렬
				renderAttendList();  // 추가한 참석자 랜더링
				pm10_d02_update();	 // 추가한 참석자 Update
			}
		});
	}
	
	// 선택된 행 하나를 위로 한 칸 이동
	function moveSelectedUp() {
		const grid = mnGridView.target;
		const focused = grid.getFocusedCell();
		if (!focused || focused.rowKey == null) {
			alert("이동할 행을 선택하세요");
			return;
		}
		
		const sel = grid.getRow(focused.rowKey);
		if (!sel) return;

		// 공지사항/파일첨부 행은 이동 금지
		if (sel.isNoticeRow || sel.isFileRow) return;
		
		const list = grid.getData();
		const idx = grid.getIndexOfRow(sel.rowKey);
		
		// 가장 앞(0)이거나 유효하지 않은 인덱스면 리턴
		if (idx <= 0) return;
		
		// Check if previous row is NoticeRow? (Usually NoticeRow is at idx 0 or handling separately?
		// Existing logic checks idx <= 0.
		
		// Swap in array
		[list[idx-1], list[idx]] = [list[idx], list[idx-1]];

        grid.resetData(list);
		recalcSortOrder();
		
		// Restore focus
		setTimeout(() => grid.focus(sel.rowKey, focused.columnName), 50);
	}

	// 선택된 행 하나를 아래로 한 칸 이동
	function moveSelectedDown() {
		const grid = mnGridView.target;
		const focused = grid.getFocusedCell();
		if (!focused || focused.rowKey == null) {
			alert("이동할 행을 선택하세요");
			return;
		}
		
		const sel = grid.getRow(focused.rowKey);
		if (!sel) return;

		// 공지사항/파일첨부 행은 이동 금지
		if (sel.isNoticeRow || sel.isFileRow) return;

        const list = grid.getData();
		const idx = grid.getIndexOfRow(sel.rowKey);
		
		// 유효하지 않거나 마지막 인덱스이면 리턴
		if (idx < 0 || idx >= list.length - 1) return;

		// 한 칸 아래로 스왑
		[list[idx], list[idx+1]] = [list[idx+1], list[idx]];

        grid.resetData(list);
		recalcSortOrder();
		
		// Restore focus
		setTimeout(() => grid.focus(sel.rowKey, focused.columnName), 50);
	}

	// 정렬순서 함수
	function recalcSortOrder() {
		const grid    = mnGridView.target;
		const allRows = grid.getData();

		const fileRow   = allRows.find(r => r.isFileRow);
		const noticeRow = allRows.find(r => r.isNoticeRow);
		const dataRows  = allRows.filter(r => !r.isFileRow && !r.isNoticeRow);

		// 로우가 없으면 정렬순서 계산 return
		if (dataRows.length == 0 && noticeRow.mnSortNo == 0) {
			return false;
		}

		// Update sort numbers in grid model and local objects
		dataRows.forEach((row, idx) => {
			const newSortNo = idx + 1;
			row.mnSortNo = newSortNo;
			// Update grid model directly to keep state (focus, etc)
			grid.setValue(row.rowKey, 'mnSortNo', newSortNo);
		});

		if (noticeRow) {
			const newNoticeSort = noticeRow.mnSubSeq > 0 ? dataRows.length + 1 : 0;
			noticeRow.mnSortNo = newNoticeSort;
			grid.setValue(noticeRow.rowKey, 'mnSortNo', newNoticeSort);
		}

		// No need to resetData, we updated values in place
		// grid.resetData(newList);

		const sortSave = allRows
			.filter(r => !r.isFileRow && r.mnSubSeq > 0)
			.map(r => ({
				mnSubSeq: r.mnSubSeq,
				mnSortNo: r.mnSortNo
			}))

		var paramObj = {
			mnDate: $('#mnDate_S').val(),
			userId: $('#userId').val(),
			pgmId:  $('#pgmId').val(),
			list:   sortSave
		};

		postAjax('/user/pm/pm10/pm10_d01_sortNo_update', paramObj, null, function(data) {
			if (data.resultCode == 200) {
				// mnGridView.setData();
			}
		});
	}

	//Select 선택 코드값 체크하여 명을 출력
	function getComboName(comboArray, key) {
		let rtnNm = "";
		for (const element of comboArray) {
			if (key.value == element.CD) {
				rtnNm = element.NM;
				break;
			}
		}
		return rtnNm;
	}  

	// 참석자 정렬 함수
	function reorderAttendList() {
		attendList.sort((a, b) => {
			const ia = FIXED_ORDER.indexOf(a.id);
			const ib = FIXED_ORDER.indexOf(b.id);
			if (ia !== -1 && ib !== -1) return ia - ib;  // 둘 다 기본 → 순서대로
			if (ia !== -1) return -1;                    // a는 기본, b는 신규 → a 우선
			if (ib !== -1) return 1;                     // b는 기본, a는 신규 → b 우선
			return 0;                                    // 둘 다 신규 → 추가된 순서 유지
		});
	}

	function pm1002_applySpecialRowClassNames() {
		var grid = mnGridView && mnGridView.target;
		if (!grid) return;
		try {
			var all = grid.getData();
			for (var i = 0; i < all.length; i++) {
				var r = all[i];
				if (!r) continue;
				if (r.isNoticeRow) {
					try { grid.addRowClassName(r.rowKey, 'row-notice'); } catch(e) {}
				}
				if (r.isFileRow) {
					try { grid.addRowClassName(r.rowKey, 'row-files'); } catch(e) {}
				}
			}
		} catch(e) {}
	}

	function pm1002_afterRowReorder() {
		var grid = mnGridView && mnGridView.target;
		if (!grid) return;
		try { grid.finishEditing && grid.finishEditing(); } catch(e) {}

		var focused = null;
		try { focused = grid.getFocusedCell && grid.getFocusedCell(); } catch(e) {}
		var focusedCol = focused && focused.columnName ? focused.columnName : null;
		var focusedSubSeq = null;
		try {
			if (focused && focused.rowKey != null) {
				var fr = grid.getRow(focused.rowKey);
				if (fr && fr.mnSubSeq) focusedSubSeq = fr.mnSubSeq;
			}
		} catch(e) {}

		var allRows = [];
		try { allRows = grid.getData(); } catch(e) {}
		var noticeRow = null;
		var fileRow = null;
		var dataRows = [];
		for (var i = 0; i < allRows.length; i++) {
			var r = allRows[i];
			if (!r) continue;
			if (r.isFileRow) { fileRow = r; continue; }
			if (r.isNoticeRow) { noticeRow = r; continue; }
			dataRows.push(r);
		}

		var rebuilt = dataRows.slice();
		if (noticeRow) rebuilt.push(noticeRow);
		if (fileRow) rebuilt.push(fileRow);

		// special row가 하단에 고정되도록 데이터 재배치
		try { grid.resetData(rebuilt); } catch(e) {}
		pm1002_applySpecialRowClassNames();
		try { recalcSortOrder(); } catch(e) {}
		try { setTimeout(pm1002_updatePinnedHScrollMetrics, 0); } catch(e) {}

		// 포커스 복원(가능한 경우)
		if (focusedCol && focusedSubSeq) {
			try {
				var rows = grid.getData();
				for (var j = 0; j < rows.length; j++) {
					if (rows[j] && rows[j].mnSubSeq === focusedSubSeq) {
						grid.focus(rows[j].rowKey, focusedCol);
						break;
					}
				}
			} catch(e) {}
		}
	}

	// =========================
	// pm1002: 셀 선택 Cross Position 표시
	// =========================
	var __pm1002Crosshair = {
		initialized: false,
		last: null,
		prev: null,
		boundOnScroll: null
	};

	function pm1002_initCrosshair() {
		if (__pm1002Crosshair.initialized) return;
		__pm1002Crosshair.initialized = true;

		// 그리드 외부 클릭 시 숨김
		document.addEventListener('mousedown', function(e) {
			try {
				var gridEl = document.getElementById('grid');
				if (!gridEl) return;
				if (e && e.target && gridEl.contains(e.target)) return;
				pm1002_hideCrosshair();
			} catch(e2) {}
		}, true);
	}

	function pm1002_hideCrosshair() {
		if (!__pm1002Crosshair.initialized) return;
		__pm1002Crosshair.last = null;
		pm1002_clearCrosshairClasses();
	}

	function pm1002_findCellElement(rowKey, columnName) {
		var gridEl = document.getElementById('grid');
		if (!gridEl) return null;
		var sel = 'td.tui-grid-cell[data-row-key="' + String(rowKey) + '"][data-column-name="' + String(columnName) + '"]';
		return gridEl.querySelector(sel);
	}

	function pm1002_clearCrosshairClasses() {
		var gridEl = document.getElementById('grid');
		if (!gridEl) return;
		var prev = __pm1002Crosshair.prev;
		if (!prev || prev.rowKey == null || !prev.columnName) return;
		try {
			var rowCells = gridEl.querySelectorAll('td.tui-grid-cell[data-row-key="' + String(prev.rowKey) + '"]');
			for (var i = 0; i < rowCells.length; i++) rowCells[i].classList.remove('pm1002-xhair-row');
		} catch(e) {}
		try {
			var colCells = gridEl.querySelectorAll('td.tui-grid-cell[data-column-name="' + String(prev.columnName) + '"]');
			for (var j = 0; j < colCells.length; j++) colCells[j].classList.remove('pm1002-xhair-col');
		} catch(e) {}
		try {
			var cell = pm1002_findCellElement(prev.rowKey, prev.columnName);
			if (cell) cell.classList.remove('pm1002-xhair-cell');
		} catch(e) {}
		__pm1002Crosshair.prev = null;
	}

	function pm1002_applyCrosshair() {
		if (!__pm1002Crosshair.initialized) return;
		var grid = mnGridView && mnGridView.target;
		if (!grid) return;
		if (!__pm1002Crosshair.last || __pm1002Crosshair.last.rowKey == null || !__pm1002Crosshair.last.columnName) {
			pm1002_clearCrosshairClasses();
			return;
		}
		var rowKey = __pm1002Crosshair.last.rowKey;
		var colName = __pm1002Crosshair.last.columnName;
		try {
			var row = grid.getRow && grid.getRow(rowKey);
			if (row && (row.isNoticeRow || row.isFileRow)) {
				pm1002_hideCrosshair();
				return;
			}
		} catch(e) {}

		pm1002_clearCrosshairClasses();
		var gridEl = document.getElementById('grid');
		if (!gridEl) return;
		try {
			var rowCells = gridEl.querySelectorAll('td.tui-grid-cell[data-row-key="' + String(rowKey) + '"]');
			for (var i = 0; i < rowCells.length; i++) rowCells[i].classList.add('pm1002-xhair-row');
		} catch(e) {}
		try {
			var colCells = gridEl.querySelectorAll('td.tui-grid-cell[data-column-name="' + String(colName) + '"]');
			for (var j = 0; j < colCells.length; j++) colCells[j].classList.add('pm1002-xhair-col');
		} catch(e) {}
		try {
			var cell = pm1002_findCellElement(rowKey, colName);
			if (cell) cell.classList.add('pm1002-xhair-cell');
		} catch(e) {}
		__pm1002Crosshair.prev = { rowKey: rowKey, columnName: colName };
	}

	function pm1002_reapplyCrosshair() {
		if (!__pm1002Crosshair.initialized) return;
		if (!__pm1002Crosshair.last || __pm1002Crosshair.last.rowKey == null || !__pm1002Crosshair.last.columnName) return;
		var rowKey = __pm1002Crosshair.last.rowKey;
		var colName = __pm1002Crosshair.last.columnName;
		var gridEl = document.getElementById('grid');
		if (!gridEl) return;
		try {
			var rowCells = gridEl.querySelectorAll('td.tui-grid-cell[data-row-key="' + String(rowKey) + '"]');
			for (var i = 0; i < rowCells.length; i++) rowCells[i].classList.add('pm1002-xhair-row');
		} catch(e) {}
		try {
			var colCells = gridEl.querySelectorAll('td.tui-grid-cell[data-column-name="' + String(colName) + '"]');
			for (var j = 0; j < colCells.length; j++) colCells[j].classList.add('pm1002-xhair-col');
		} catch(e) {}
		try {
			var cell = pm1002_findCellElement(rowKey, colName);
			if (cell) cell.classList.add('pm1002-xhair-cell');
		} catch(e) {}
		if (!__pm1002Crosshair.prev) __pm1002Crosshair.prev = { rowKey: rowKey, columnName: colName };
	}

	function pm1002_updateCrosshairForFocusedCell() {
		if (!__pm1002Crosshair.initialized) return;
		var grid = mnGridView && mnGridView.target;
		if (!grid) return;

		var focused = null;
		try { focused = grid.getFocusedCell && grid.getFocusedCell(); } catch(e) {}
		if (!focused || focused.rowKey == null || !focused.columnName) {
			pm1002_hideCrosshair();
			return;
		}

		__pm1002Crosshair.last = { rowKey: focused.rowKey, columnName: focused.columnName };
		pm1002_applyCrosshair();
	}

	//임팀장주간회의록 출력
	function setReport(_type = "") {
		var arg =  
			"coCd#"			+  $('#coCd_S').val()
			+ "#mnDate#"		+  $("#mnDate_S").val()
			+ "#mnDiv#"	+  $("#mnDiv_S").val()
			+ "#";                 
		var fileName =  "PM1002R01.jrf" ;
		if (_type == '' || _type == 'S' || _type == undefined ) {
			var todayDate = new Date().format('yyyyMMddHHmmss')
			callReport(fileName, arg, 1150, 720, $('#mnDate_S').val()+'임팀장주간회의록'+ todayDate);
		} else { //Export 작업
			ubiExportAjax(fileName, arg, function(response) {
				if (response.resultCode === 200) {
					var base64FileData = response.base64FileData;
					var fileName = response.exportFileName;
					downloadPDFFromBase64(base64FileData, fileName);
				} else {
					alert('PDF 내보내기 실패: ' + response.resultText);
				}

			});
		}
	}    
</script>
