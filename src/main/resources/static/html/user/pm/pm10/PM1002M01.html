<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
</head>

<body>
  <div id="head_area"></div>
  <div id="top_area"></div>
  <div id="main_area">
  
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="mnGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div>
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 4분할 -->
				<table class="table_input type04">

					<tr>
						<th class= "hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required="required" msg="회사">
							</select>
						</td>

						<th class= "hit">회의일자</th>
						<td>
							<input id="mnDate_S" name="mnDate_S" data-search="mnDate" required="required" msg="회의일자">
						</td>
						
						<th>주차</th>
						<td>
							<input type="test" id="mnWeeks_S" name="mnWeeks_S"  data-search="mnWeeks">
						</td>
						<td></td>
						<td></td>
					</tr>			     
	            </table>
				<!-- 검색조건 END -->
<form id="mainForm" onSubmit="return false;">
		<input type="hidden" id="userId"    name="userId">
		<input type="hidden" id="deptId"     name="deptId">
		<input type="hidden" id="pgmId"     name="pgmId" value="PM1002M01">
</form>			        
            </div>
        </div>        

		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<div class="contents_tit">
				<span  style="height: 30px; line-height: 30px;font-size: 15px;">임팀장 주간회의 자료</span>
				<div class="add_btn_small pdl10">
					<!-- <a onclick="insertMn();" style="height: 30px; line-height: 28px;">저장</a> -->
					<a id="addRow" style="height: 30px; line-height: 28px;">+</a>
					<a id="deleteRow" style="height: 30px; line-height: 28px;">-</a>
					<a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
			    </div>
			</div>
		    <!-- 리스트 -->
		      <div class="ax5_grid" data-ax5grid="mnGrid-grid" data-ax5grid-config="{}" style="height: 755px; width: 100%" ></div>
		      <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>
		
    </div>
                    
</body>
</html>

<script type="text/javascript">

const detailInserted = {};

//formatter 공통 함수
function valueFormatter() {
	return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : '';
}

const mnStatusCode = [
	{'CD' : '', 'NM' : ''},
	{'CD' : 'N', 'NM' : '진행'},
	{'CD' : 'Y', 'NM' : '완료'}
]

// 부서 코드 매핑
const deptCodeMap = {
	gun00MnCnts:'GUN00', gun60MnCnts:'GUN60', gun30MnCnts:'GUN30',
	gun40MnCnts:'GUN40', trn5010MnCnts:'TRN5010', trn5020MnCnts:'TRN5020',
	gun10MnCnts:'GUN10', gun80MnCnts:'GUN80'
};

var mnGridView = {
	initView: function(){
	this.target = new ax5.ui.grid();
	this.target.setConfig({
		showRowSelector: false,
		multipleSelect: false,
		sortable: false,
		showLineNumber: false,
		lineNumberColumnWidth: 30,
		target: $('[data-ax5grid="mnGrid-grid"]'),
		header: {
			align: "center",
			selector: false
		},
		body: {
			onClick: function () {
				this.self.clearSelect();				
				this.self.select(this.dindex);
			},
			onDBLClick: function () {
			},
			onDataChanged: function(){
// 				const subSeq = this.item.mnSubSeq;
// 				if (!subSeq) alert('먼저 주제를 입력해주세요.');

				
				if (this.key === 'mnSubject' || this.key === 'mnStatus' || this.key === 'mnEtcAll') {	//주제 테이블 변경자료
					pm10_d01_update(this.item, this.key, this.value); 
				} else {										
					pm10_d03_update(this.item, this.key, this.value);
				}

			}
		},
        page: {
			navigationItemCount: 9,
			height: 30,
			display: false,
			firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
			prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
			nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
			lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
			onChange: function () {
				mnGridView.setData(this.page.selectPage);
			}
        },
        columns: [
					{ key: "mnSubject", 	label: "PROJECT<br>/<br>주제", 	align: "left", width: 100, editor: {type: "textarea"}, formatter: valueFormatter},
					{ key: "mnSubSeq", 		label: "순번", 					align: "left", width: 100, hidden: true},
					{ key: "gun00MnCnts", 	label: "임원", 					align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "gun60MnCnts", 	label: "생산", 					align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "gun30MnCnts", 	label: "영업<br>국내.해외", 	align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "gun40MnCnts", 	label: "연구소", 				align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{
						key: undefined, 	label: "트루넷", columns: [
							{ key: "trn5010MnCnts", label: "기계", 		align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "trn5020MnCnts", label: "전기", 		align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter }
						]
					},
					{ key: "gun10MnCnts", 	label: "경영지원팀<br>총무/인사/제조혁신", 	align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "gun80MnCnts", 	label: "전산실", 				align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "mnStatus", 		label: "진행/완료", 			align: "left", width: 70, 
						editor: {
							type: 'select', config: {
								columnKeys: { optionValue: 'CD', optionText: 'NM' },
								options : mnStatusCode
							}
						},
						formatter : function() {
							return getComboName(mnStatusCode, this)
						}
					},
					{ key: "mnEtcAll", 		label: "특이사항", 			align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "mnSortNo", 		label: "정렬순서", 			align: "center", width: 80 },
					{ key: "mnWeeks", 		label: "주차", 				align: "center", width: 80 },
				]
		});
		return this;
	},	
	setData: function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {};
			$.each($('#main_area [data-search]'), function(idx, elem){
				if( $(elem).attr("class") == "input_calendar" ) {
					paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
				} else {
					paramObj[$(elem).data("search")] = $(elem).val();	
				}
			});
			
			postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
				try {
					let list = data.result;
					pm10_data_list = list;
					targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							} 
					});

				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		} 
	}

	


	var excelView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="excel-grid"]'),
				columns: [     
						]
			});
			return this;
		}
	}
	
	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    
		// 회사 초기화
		$("#coCd_S").val(jwt.coCd);
	
		$.dayInit();
		
		// 재검색
		mnGridView.setData(0);
	}


	$(document).ready(function() {
		//초기설정들		
		mainDefaultLoad("사업계획", "임팀장주간회의록");
		setCommonSelect($("#main_area select[data-kind]"));

		$("#userId").val(jwt.userId);
		$("#deptId").val(jwt.deptId);
		
		$.dayInit = function() {
			// 종료일 (현재날짜의 월 말일)
			$('#mnDate_S').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true,
				beforeShowDay: function(date) {
					// 5 = 금요일만 선택가능하게 하기
					return date.getDay() === 5;
				}
			}).datepicker("setDate", moment().day(5).toDate());

			dateToWeek();	// 주차 계산
		}

	
		// 접속자 회사 set
		$("#coCd_S").val(jwt.coCd);
		$("#userId").val(jwt.userId);
		$.dayInit();
		

	    $("#addRow").on("click", function () {
	    	insertMn();
	    });

	    $("#deleteRow").on("click", function () {
	    	deleteMn();
	    });
		
		mnGridView.initView().setData(0);
		excelView.initView();
		

		// 회의일자 변경 시 주차 계산
		$('#mnDate_S').on('change', function (){
			dateToWeek();
			mnGridView.setData(0);
		});

		
		//권한체크
// 		authChk();	
			
	});

	
	
	function insertMn() {
        var rows = mnGridView.target.list;
        
        // rnum의 최대값 구하기
        const maxRnum = gPasIntChk(Math.max(...rows.map(item => item.rnum))) + 1;
        //하나라도 등록되어 있으면 마지막 자료를 복사하고
        //없으면 초기화
        var newRowData ={};
        if (rows.length > 0) {
        	newRowData = JSON.parse(JSON.stringify(rows[rows.length - 1])); //깊은 복사로 변경처리됨 (그냥 대입은 레퍼러스 형태임)
        	newRowData.mnSubSeq = maxRnum;
        	newRowData.rnum = maxRnum;
        	newRowData.mnWeeks = $("#mnWeeks_S").val();
        	newRowData.mnStatus = "";
        	newRowData.mnEtcAll = "";
        	newRowData.__original_index= rows.length;
        	newRowData.__index= rows.length;
        } else {
			newRowData = 
					{
					    rnum: rows.length+1,
					    mnDate: $("#mnDate_S").val(),
					    mnWeeks: $('#mnWeeks_S').val(),
					    mnSubSeq: maxRnum,			//마지막 등록값에서 +1을 함.
					    mnSubject: "",
					    gun00MnCnts: "",
					    gun60MnCnts: "",
					    gun30MnCnts: "",
					    gun40MnCnts: "",
					    trn5010MnCnts: "",
					    trn5020MnCnts: "",
					    gun10MnCnts: "",
					    gun80MnCnts: "",
					    mnStatus: "",
					    mnEtcAll: "",
					    __original_index: rows.length,
					    __index: rows.length,
					};
    	}
		mnGridView.target.addRow(newRowData, rows.length);
	}
	
	// 삭제
	function deleteMn() {
		console.log(mnGridView.target.getList("selected"));
		const rows = mnGridView.target.getList("selected")[0];
		if (rows.length = 0){
			alert("삭제할 주제를 선택하세요!");
			return false;
		}
		
// 		if (rows.전체 컬럼의 값이 있으면 삭제여부 확인할것]) {
// 			alert("자료가 등록된 상태입니다. 삭제 할까요?");
// 			return false;
// 		}
		var formData = {
				mnDate 		: rows.mnDate,
				mnSubSeq 	: rows.mnSubSeq
		} 
		postAjax("/user/pm/pm10/deleteMn", formData, null, function(data) {
			if (data.resultCode == 200) {
				mnGridView.setData();
			}
		});
	}

	
	//회의 주제 Insert, Update
	function pm10_d01_update(item, colKey, value) {
		const rows = mnGridView.target.list;
		item[colKey] = value;
		var paramObj = {
				mnDate   : $('#mnDate_S').val(),
			    mnWeeks	 : $('#mnWeeks_S').val(),
				mnSubSeq : item.mnSubSeq,
				mnSubject: item.mnSubject,
				mnSortNo : item.mnSortNo,
				mnEtcAll : item.mnEtcAll,
				mnStatus : item.mnStatus,
				mnSortNo : gPasIntChk(Math.max(...rows.map(item => item.rnum))) + 1,
				userId   : $('#userId').val(),
				pgmId    : $('#pgmId').val()
		};
		postAjax('/user/pm/pm10/pm10_d01_update', paramObj, null, function(data) {
			if (data.resultCode == 200) {
// 				mnGridView.setData();
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	//팀별 회의 내용 Insert, Update
	function pm10_d03_update(item, colKey, value) {
		var paramObj = {
			mnDate   	: $('#mnDate_S').val(),
		    mnWeeks	 	: $('#mnWeeks_S').val(),
		    mnSubject 	: item.mnSubject,
			mnSubSeq 	: item.mnSubSeq,
			mnSortNo 	: gPasIntChk(item.mnSortNo),
			mnDeptCd 	: deptCodeMap[colKey],
			mnCnts		: value,
			mnEtc		: '',
			mnResult	: '',
			mnStatus	: '',
			clntPjt		: '',
			clntCd		: '',
			userId   	: $('#userId').val(),
			pgmId    	: $('#pgmId').val()
		};
		postAjax('/user/pm/pm10/pm10_d03_update', paramObj, null, function(data) {
			if (data.resultCode === 200) {
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}
	
	//엑셀다운로드
	function excelDown() {
		var paramObj = {};
		$.each($('#main_area [data-search]'), function(idx, elem){
			if( $(elem).attr("class") == "input_calendar" ) {
				paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
			} else {
				paramObj[$(elem).data("search")] = $(elem).val();	
			}
		});			
		postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
			let list = data.result;
		  	excelView.target.setData({
		  		list : list,
		  		page : {
		                  totalElements : list.length
		        			}
		  	});
 			var todayDate = new Date().format('yyyyMMddHHmmss');
			excelView.target.exportExcel("공급업체평가_"+todayDate+".xls");
		});       
	}
	
 
    function gridResize(size) {
        let tagHeight = (size) * 27 + 50 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 320 ? 320 : tagHeight;
        
        mnGridView.target.setHeight(tagHeight);
    }
    
	// 일자 기준 주차 변환 함수
	function dateToWeek() {
		const dateStr = $('#mnDate_S').val();      // "2025-05-20"
		if (!dateStr) return;
		const week = moment(dateStr, 'YYYY-MM-DD').isoWeek();
		$('#mnWeeks_S').val(week);
	}


	//Select 선택 코드값 체크하여 명을 출력
	function getComboName(comboArray, key) {
		let rtnNm = "";
		for (const element of comboArray) {
			if (key.value == element.CD) {
				rtnNm = element.NM;
				break;
			}
		}
		return rtnNm;
	}  
</script>
