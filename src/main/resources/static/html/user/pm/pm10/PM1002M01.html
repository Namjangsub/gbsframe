<!DOCTYPE html>
<html lang="ko">
<style>
	.attend-item {
		display: inline-block;
		margin: 5px;
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		cursor: pointer;
		user-select: none;
	}
	.attend-item.to-remove {
		background-color: #fdd;
	}
	.attend-item input {
		margin-right: 4px;
		cursor: auto;
	}
</style>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
</head>

<body>
  <div id="head_area"></div>
  <div id="top_area"></div>
  <div id="main_area" style="position: static;height: 1080px;">
  
		<!-- 페이지 상단 -->
		<!-- <div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="mnGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div> -->
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 5분할 -->
				<table class="table_input type05">

					<tr>
						<!-- <th class= "hit">회사</th>
						<td>
							<select type="hidden" id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required="required" msg="회사">
							</select>
						</td> -->
						<th style="width: 200px; height: 30px; line-height: 30px;font-size: 15px;">임팀장 주간회의 자료</th>

						<th class= "hit">회의일자</th>
						<td>
							<input id="mnDate_S" name="mnDate_S" data-search="mnDate" required="required" msg="회의일자">
						</td>
						<td style="width: 120px">
							<input id="mnWeeks_S" name="mnWeeks_S" data-search="mnWeeks" style="width:18px; font-size:15px; vertical-align: middle; margin-right:4px;" readonly>
							<span style="font-size:15px; vertical-align: middle;">주차</span>
						</td>
						<th>구분</th>
						<td>
							<select id="mnDiv_S" name="mnDiv_S" data-search="mnDiv"  onchange="mnGridView.setData(0);">
								<option value="MNDIV01" selected>사전공지</option>
								<option value="MNDIV02">회의결과</option>
								<option value="MNDIV99">전체조회</option>
                            </select>
						</td>
						<td></td>
						<td>
							<div class="add_btn_small pdl10" style="width:400px;">
								<!-- <a onclick="insertMn();" style="height: 30px; line-height: 28px;">저장</a> -->
								<a onclick="moveSelectedUp();" id="moveUp"    style="height: 30px; line-height: 28px; margin:0 5px;">▲</a>
								<a onclick="moveSelectedDown();" id="moveDown"  style="height: 30px; line-height: 28px;">▼</a>
								<a onclick="insertMn();" id="addRow" style="width: 80px; height: 30px; line-height: 28px;">열 추가</a>
								<a onclick="deleteMn();" id="deleteRow" style="width: 80px; height: 30px; line-height: 28px;">열 삭제</a>
								<a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
							</div>
						</td>
					</tr>
	            </table>
				<!-- 검색조건 END -->
<form id="mainForm" onSubmit="return false;">
		<input type="hidden" id="userId"    name="userId">
		<input type="hidden" id="deptId"     name="deptId">
		<input type="hidden" id="pgmId"     name="pgmId" value="PM1002M01">
</form>
            </div>
        </div>
		<div class="contents" style="display: flex; align-items: center;">
			<div id="attendCheckboxContainer" style="flex: 1;"></div>
			<div class="add_btn_small pdl10" style="margin-left: auto; margin-right: 30px">
				<a onclick="openUserSearch()"   id="addAttendBtn"    style="height:30px; line-height:28px;">+</a>
				<a onclick="pm10_d02_delete()"  id="removeAttendBtn" style="height:30px; line-height:28px;">-</a>
				<!-- <a onclick="pm10_d02_update()"  id="saveAttendBtn"   style="width:80px; height:30px; line-height:28px;">저장</a> -->
			</div>
		</div>

		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="mnGrid-grid" data-ax5grid-config="{}" style="height: 925px; width: 100%; overflow-y: auto;" ></div>
			<div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>

		
		
    </div>
    <input type="file" id="fileInput" multiple style="display:none" />                
</body>
</html>

<script type="text/javascript">

let fileRowInserted = false;
let currentFileRow = null;
let currentFileColumn = null;
var mnFileArr = [];
var deleteFileArr = [];

const DEFAULT_ATTEND_LIST = [
	{ id: 'EMJ8105',    name: '김태호',   title: '부사장' },
	{ id: 'kimjhv',     name: '김재현',   title: '전 무' },
	{ id: 'kimihz',     name: '김일희',   title: '상 무' },
	{ id: 'K98452000',  name: '김동현',   title: '상 무' },
	{ id: 'shjung',     name: '정상훈',   title: '부 장' },
	{ id: 'h4ng10',     name: '허상렬',   title: '부 장' },
	{ id: 'canmtb',     name: '한동주',   title: '과 장' },
	{ id: 'js.nam',     name: '남장섭',   title: '실 장' },
	{ id: 'cyh',        name: '조영희',   title: '부 장' },
	{ id: 'ycy',        name: '윤치영',   title: '부 장' },
];
let attendList = DEFAULT_ATTEND_LIST.map(u => ({ ...u }));

const FIXED_ORDER = DEFAULT_ATTEND_LIST.map(u => u.id);

//formatter 공통 함수
function valueFormatter() {
	return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : '';
}

// 파일 첨부 셀 함수
function fileCellFormatter() {
	if (!this.item.isFileRow) return valueFormatter.call(this);

	const colKey = this.key;
	// filesByColumn 에 fileType 까지 담아두었다고 가정
	const files  = (this.item.filesByColumn && this.item.filesByColumn[colKey]) || [];

	// 1) 파일 리스트
	const listHtml = files.length ? 
		`<ul class="file-list" style="padding:0; margin:0; list-style:none;">
			${files.map((f,i) =>
			`<li data-idx="${i}" data-col="${colKey}" style="margin:6px 0; display:flex; align-items:center;">
				<button class="file-remove" data-idx="${i}" data-col="${colKey}"
						style="font-size:11px; padding:4px 10px; margin-right:6px; background-color:rgb(255,50,0); cursor:pointer;">삭제
				</button>
				<!-- preview 가능한 span: fileType 도 data-attr 로 달아줌 -->
				<span class="file-preview"
						style="white-space: nowrap; text-decoration:underline; cursor:pointer;" data-filekey="${f.fileKey}" data-filename="${f.name}" data-filetype="${f.fileType}">${f.name}
				</span>
				</li>`
			).join('')}
		</ul>`
		: '';

	// 2) 추가 버튼
	const btnHtml = files.length ? 
		`<div class="file-add-wrap" style="width:100%; text-align:center; margin-top:12px;">
			<button class="file-add-btn" data-col="${colKey}"style="font-size:11px; padding:4px 10px; cursor:pointer;">추가</button>
		</div>`
		: '';

	return listHtml + btnHtml;
}

const baseFileCol = {
	editor: {
		type: "textarea",
		disabled: function(){ return this.item.isFileRow; }
	},
	formatter: fileCellFormatter
};

const mnStatusCode = [
	{'CD' : '', 'NM' : ''},
	{'CD' : 'N', 'NM' : '진행'},
	{'CD' : 'Y', 'NM' : '완료'}
]

// 부서 코드 매핑
const deptCodeMap = {
	gun00MnCnts:'GUN00', gun60MnCnts:'GUN60', gun30MnCnts:'GUN30',
	gun40MnCnts:'GUN40', trn5010MnCnts:'TRN5010', trn5020MnCnts:'TRN5020',
	gun10MnCnts:'GUN10', gun80MnCnts:'GUN80'
};

var mnGridView = {
	initView: function(){
	this.target = new ax5.ui.grid();
	this.target.setConfig({
        frozenColumnIndex : 1,
		showRowSelector: false,
		multipleSelect: false,
		sortable: false,
		showLineNumber: false,
		lineNumberColumnWidth: 30,
		target: $('[data-ax5grid="mnGrid-grid"]'),
		header: {
			align: "center",
			selector: false
		},
		body: {
			columnHeight: 50,
			onClick: function () {
				this.self.clearSelect();
				this.self.select(this.dindex);

				const colKey = this.column.key;
				const files = (this.item.filesByColumn && this.item.filesByColumn[colKey]) || [];
				if (this.item.mnSubject === '파일첨부' && files.length === 0) {
					const normalRows = this.self.list.filter(r => !r.isFileRow);
					const hasDeptValue = normalRows.some(r => r[colKey] && r[colKey].trim());
					if (!hasDeptValue) {
						alert('먼저 해당 부서에 회의 내용을 입력한 뒤에 파일을 첨부할 수 있습니다.');
						return;
					}
					currentFileRow    = this.item;
					currentFileColumn = colKey;
					$('#fileInput').click();
				}

			},
			onDBLClick: function () {
			},
			onDataChanged: function(){
// 				const subSeq = this.item.mnSubSeq;
// 				if (!subSeq) alert('먼저 주제를 입력해주세요.');
				if (this.item.isFileRow) return;

				if (this.key === 'mnSubject' || this.key === 'mnStatus' || this.key === 'mnEtcAll') {	//주제 테이블 변경자료
					pm10_d01_update(this.item, this.key, this.value); 
				} else {
					pm10_d03_update(this.item, this.key, this.value);
				}

				this.self.repaint(true);
			}
		},
        page: {
			navigationItemCount: 9,
			height: 30,
			display: false,
			firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
			prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
			nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
			lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
			onChange: function () {
				mnGridView.setData(this.page.selectPage);
			}
        },
        columns: [
					{ key: "mnSubject", 	label: "PROJECT<br>/<br>주제", 	align: "center", width: 100, editor: {type: "textarea",disabled: function () {return this.item.isFileRow;}}, formatter: valueFormatter},
					{ key: "mnSubSeq", 		label: "순번", 					align: "left", width: 100, hidden: true},
					{ key: "gun00MnCnts", 	label: "임원", 					align: "left", width: 220, ...baseFileCol},
					{ key: "gun60MnCnts", 	label: "생산", 					align: "left", width: 220, ...baseFileCol},
					{ key: "gun30MnCnts", 	label: "영업<br>국내.해외", 	align: "left", width: 220, ...baseFileCol},
					{ key: "gun40MnCnts", 	label: "연구소", 				align: "left", width: 220, ...baseFileCol},
					{
						key: undefined, 	label: "트루넷", columns: [
							{ key: "trn5010MnCnts", label: "기계", 		align: "left", width: 220, ...baseFileCol},
							{ key: "trn5020MnCnts", label: "전기", 		align: "left", width: 220, ...baseFileCol},
						]
					},
					{ key: "gun10MnCnts", 	label: "경영지원팀<br>총무/인사/제조혁신", 	align: "left", width: 220, ...baseFileCol},
					{ key: "gun80MnCnts", 	label: "전산실", 				align: "left", width: 220, ...baseFileCol},
					{ key: "mnStatus", 		label: "진행/완료", 			align: "left", width: 70, 
						editor: {
							type: 'select', config: {
								columnKeys: { optionValue: 'CD', optionText: 'NM' },
								options : mnStatusCode
							}
						},
						formatter : function() {
							return getComboName(mnStatusCode, this)
						}
					},
					{ key: "mnEtcAll", 		label: "특이사항", 			align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
					{ key: "mnSortNo", 		label: "정렬순서", 			align: "center", width: 80, hidden: true},
					{ key: "mnWeeks", 		label: "주차", 				align: "center", width: 80, hidden: true},
					
				]
		});
		return this;
	},	
	setData: function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {};
			$.each($('#main_area [data-search]'), function(idx, elem){
				if( $(elem).attr("class") == "input_calendar" ) {
					paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
				} else {
					paramObj[$(elem).data("search")] = $(elem).val();	
				}
			});
			paramObj.userId = jwt.userId;
			debugger;
			postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
				try {
					let list = data.result;
					const fileRow = {
						rnum:        0,
						mnDate:      $('#mnDate_S').val(),
						mnWeeks:     $('#mnWeeks_S').val(),
						mnSubSeq:    0,
						mnSubject:   '파일첨부',
						// deptCodeMap의 키들만큼 빈 배열로 초기화
						gun00MnCnts: '', gun60MnCnts: '', gun30MnCnts: '',
						gun40MnCnts: '', trn5010MnCnts: '', trn5020MnCnts: '',
						gun10MnCnts: '', gun80MnCnts: '',
						mnStatus:    '', mnEtcAll: '',
						mnSortNo:    0,
						isFileRow:   true,
						filesByColumn: {}   // 여길 채워줄 거임
					};

					// 파일첨부 정보
					data.result.forEach(row => {
						if (!row.files) return;
						const parsed = JSON.parse(row.files);
						parsed.forEach(f => {
							// parsed 안의 각 객체에서 fileTrgtKey 추출
							const fileTrgtKey = f.fileTrgtKey;       // ex. "20250530-GUN00"
							const deptCode    = fileTrgtKey.substring(9); // "GUN00"
							// deptCodeMap에서 값이 deptCode인 키 찾기
							const colKey = Object.keys(deptCodeMap)
												.find(k => deptCodeMap[k] === deptCode);
							if (!colKey) return;
							// 해당 컬럼 배열이 없으면 빈 배열 생성
							fileRow.filesByColumn[colKey] = fileRow.filesByColumn[colKey] || [];
							// 파일명·키 정보만 넣기
							fileRow.filesByColumn[colKey].push({
								name:    f.fileName,
								fileKey: f.fileKey,
								fileType: f.fileType
							});
						});
					});
					list.push(fileRow);

					targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							}
					});

					select_p10_d02_List(data.d02List);

				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
					syncRowHeights();
// 					gridMaxHeightResize();
				}
			});
		} 
	}

	var excelView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="excel-grid"]'),
				columns: [
							{ key: "mnSubject", 	label: "PROJECT<br>/<br>주제", 	align: "left", width: 100, editor: {type: "textarea"}, formatter: valueFormatter},
							{ key: "mnSubSeq", 		label: "순번", 					align: "left", width: 100, hidden: true},
							{ key: "gun00MnCnts", 	label: "임원", 					align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "gun60MnCnts", 	label: "생산", 					align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "gun30MnCnts", 	label: "영업<br>국내.해외", 	align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "gun40MnCnts", 	label: "연구소", 				align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{
								key: undefined, 	label: "트루넷", columns: [
									{ key: "trn5010MnCnts", label: "기계", 		align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
									{ key: "trn5020MnCnts", label: "전기", 		align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter }
								]
							},
							{ key: "gun10MnCnts", 	label: "경영지원팀<br>총무/인사/제조혁신", 	align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "gun80MnCnts", 	label: "전산실", 				align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "mnStatus", 		label: "진행/완료", 			align: "left", width: 70, 
								editor: {
									type: 'select', config: {
										columnKeys: { optionValue: 'CD', optionText: 'NM' },
										options : mnStatusCode
									}
								},
								formatter : function() {
									return getComboName(mnStatusCode, this)
								}
							},
							{ key: "mnEtcAll", 		label: "특이사항", 			align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
							{ key: "mnSortNo", 		label: "정렬순서", 			align: "center", width: 80, hidden: true},
							{ key: "mnWeeks", 		label: "주차", 				align: "center", width: 80, hidden: true},
						]
			});
			return this;
		}
	}
	
	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    
		// 회사 초기화
		$("#coCd_S").val(jwt.coCd);
		$('#mnDate_S').val(moment().day(5).format('YYYY-MM-DD'));
	}

	$(document).ready(function() {
		//초기설정들
		mainDefaultLoad("사업계획", "임팀장주간회의록");
		setCommonSelect($("#main_area select[data-kind]"));

		// 화면 크기 조절
		// $('#head_area').toggleClass('off');
		$("#top_area").hide();
		$("#main_area").css("position", "static");

		$("#userId").val(jwt.userId);
		$("#deptId").val(jwt.deptId);
		
		// 종료일 (현재날짜의 월 말일)
		$('#mnDate_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true,
			beforeShowDay: function(date) {
				// 5 = 금요일만 선택가능하게 하기
				return date.getDay() === 5;
			}
		}).datepicker("setDate", moment().day(5).toDate());
		$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
		
		// 접속자 회사 set
		$("#coCd_S").val(jwt.coCd);
		$("#userId").val(jwt.userId);
		

		$('#removeAttendBtn').on('click', () => {
			const toRemoveIds = $('.attend-item.to-remove')
								.map((_,el)=>$(el).data('id'))
								.get();
			if (!toRemoveIds.length) {
				return;
			}
			attendList = attendList.filter(u => !toRemoveIds.includes(u.id));
			renderAttendList();
		});
				
		mnGridView.initView();
		excelView.initView();
		

		// 회의일자 변경 시
		$('#mnDate_S').on('change', function (){
			$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
			mnGridView.initView().setData(0);
		})

		// 왼쪽 사이드바 닫기 버튼 클릭 시 그리드 데이터 셋팅 
		$('.off_btn').on('click', function(e){
			mnGridView.setData(0);
		});

		$('#fileInput').off('change').on('change', function(){
			if (!currentFileRow || !currentFileColumn) return;
			Array.from(this.files).forEach(file => {
				// 서버 전송용 배열에 넣고
				mnFileArr.push({ fileKey: 0, file, row: currentFileRow, column: currentFileColumn });
				// 화면용 컬럼별 배열에 추가
				currentFileRow.filesByColumn = currentFileRow.filesByColumn || {};
				currentFileRow.filesByColumn[currentFileColumn] = currentFileRow.filesByColumn[currentFileColumn] || [];
				currentFileRow.filesByColumn[currentFileColumn].push({ name: file.name, fileKey: 0 });
			});
			mnGridView.target.repaint();

			mnUploadFile();
			$(this).val('');
			currentFileRow = null;
			currentFileColumn = null;
		});

		// 파일 추가
		$(document).on('click', '.file-add-btn', function(e) {
			const colKey = $(this).data('col');
			// 클릭된 버튼이 속한 행 (파일첨부 전용 행)
			const $li    = $(this).closest('[data-ax5grid-data-index]');
			const dindex = +$li.attr('data-ax5grid-data-index');
			const fileRow = mnGridView.target.list[dindex];

			// 1) 일반 데이터 행만 필터링
			const normalRows = mnGridView.target.list.filter(r => !r.isFileRow);
			// 2) 그 중에 해당 부서(colKey)에 값이 하나라도 있는지 확인
			const hasDeptValue = normalRows.some(r => r[colKey] && r[colKey].trim());
			if (!hasDeptValue) {
				alert('먼저 해당 부서에 대한 회의 내용을 입력한 후에만 파일을 첨부할 수 있습니다.');
				return;
			}

			// 3) 조건 만족 시에만 파일첨부 창 열기
			currentFileRow    = fileRow;
			currentFileColumn = colKey;
			$('#fileInput').click();
		});

		// 파일 삭제
		$(document).on('click', '.file-remove', function(e) {
			e.stopPropagation();  // 그리드 셀 클릭 이벤트가 트리거되지 않도록
			const $btn   = $(this);
			const idx    = $btn.data('idx');   // li 인덱스
			const colKey = $btn.data('col');   // 컬럼 키
			currentFileColumn = colKey;

			// 해당 버튼이 속한 행의 data-index 가져오기
			const $rowElem = $btn.closest('[data-ax5grid-data-index]');
			const dindex   = +$rowElem.attr('data-ax5grid-data-index');

			const row = mnGridView.target.list[dindex];
			if (row.filesByColumn && row.filesByColumn[colKey]) {
				const removed = row.filesByColumn[colKey].splice(idx, 1)[0];
				deleteFileArr.push({ fileKey: removed.fileKey });

				mnGridView.target.repaint();
				mnUploadFile();
			}
		});

		// 파일 미리보기
		// $(document).on('click', '.file-preview', function(e) {
		// 	e.stopPropagation();   // 그리드 셀 클릭 이벤트 방지
		// 	const fileKey  = $(this).data('filekey');
		// 	const fileName = $(this).data('filename');
		// 	// 필요하다면 tempFileName 조합 로직 추가
		// 	imageViewPopup(fileKey, fileName);
		// });
		
		$(document).on('click', '.file-preview', function() {
			const fileKey  = $(this).data('filekey');
			const fileName = $(this).data('filename');
			const $li      = $(this).closest('li');
			const colKey   = $li.data('col');
			const dindex   = +$li.closest('[data-ax5grid-data-index]').attr('data-ax5grid-data-index');
			const row      = mnGridView.target.list[dindex];

			const allFiles = row.filesByColumn[colKey] || [];
			// const imageList = allFiles
			// 	.filter(f => {
			// 		const ft = (f.fileType || '').toLowerCase();
			// 		return ['jpg','jpeg','png','gif','pdf'].includes(ft);
			// 	})
			// 	.map(f => ({
			// 		fileKey:  f.fileKey,
			// 		fileName: f.name
			// 	}));

			imageViewPopup(fileKey, fileName);
		});

		$(window).on('resize', showSize);
		$(function() { showSize(); });
		
		
		//권한체크
// 		authChk();	
			
	});
	
	function showSize() {
// 	   console.log('뷰포트 크기: ' + window.innerWidth + ' × ' + window.innerHeight + ' px');
	   $('[data-ax5grid="mnGrid-grid"]').height( window.innerHeight - 162);
	   $('#main_area').height(window.innerHeight);
	   mnGridView.setData();
	}
	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");    
		// 회사 초기화
		$("#coCd_S").val(jwt.coCd);

		$('#mnDate_S').val(moment().day(5).format('YYYY-MM-DD'));
		$('#mnWeeks_S').val(moment($('#mnDate_S').val(), 'YYYY-MM-DD').isoWeek());
		
		// 재검색
		mnGridView.setData(0);
	}

	// 참석자 리스트 불러오기 & 렌더링
	function select_p10_d02_List(list) {
			if (list.length > 0) {
				attendList = list.map(user => ({
					id:       user.id,
					name:     user.name,
					title:    user.title,
					reasonCd: user.reasonCd
				}));
			} else {
				// 기본 참여자 전부를 reasonCd: 'Y' 로 설정
				attendList = DEFAULT_ATTEND_LIST.map(user => ({...user, reasonCd: 'Y'}));
			}

			// 고정 멤버 순서대로 정렬
			reorderAttendList();

			// 렌더링
			renderAttendList();
		
			// DB에서 Y인 것만 체크
			attendList.forEach(item => {
				if (item.reasonCd === 'Y') {
					$(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
					.prop('checked', true);
				}
			});
	}
	
	
	function insertMn() {
        var rows = mnGridView.target.list;

		// “파일첨부” 행의 인덱스 찾기
		const fileRowIndex = rows.findIndex(item => item.isFileRow);
		// 일반 데이터 행만 필터링
    	const normalRows = rows.filter(item => !item.isFileRow);
        // rnum의 최대값 구하기
        const maxRnum = gPasIntChk(Math.max(...normalRows.map(item => item.rnum))) + 1;
        //하나라도 등록되어 있으면 마지막 자료를 복사하고
        //없으면 초기화
        var newRowData ={};
        if (normalRows.length > 0) {
        	// newRowData = JSON.parse(JSON.stringify(rows[rows.length - 1])); //깊은 복사로 변경처리됨 (그냥 대입은 레퍼러스 형태임)
        	newRowData = JSON.parse(JSON.stringify(normalRows[normalRows.length - 1])); //깊은 복사로 변경처리됨 (그냥 대입은 레퍼러스 형태임)
			newRowData.mnSubSeq = maxRnum;
			newRowData.mnSortNo = maxRnum;
			newRowData.rnum = maxRnum;
			newRowData.mnWeeks = $("#mnWeeks_S").val();
			newRowData.mnStatus = "";
			newRowData.mnEtcAll = "";
			newRowData.__original_index= rows.length;
			newRowData.__index= rows.length;
        } else {
			newRowData = 
					{
						rnum: rows.length+1,
						mnDate: $("#mnDate_S").val(),
						mnWeeks: $('#mnWeeks_S').val(),
						mnSubSeq: maxRnum,			//마지막 등록값에서 +1을 함.
						mnSubject: "",
						gun00MnCnts: "",
						gun60MnCnts: "",
						gun30MnCnts: "",
						gun40MnCnts: "",
						trn5010MnCnts: "",
						trn5020MnCnts: "",
						gun10MnCnts: "",
						gun80MnCnts: "",
						mnStatus: "",
						mnEtcAll: "",
						__original_index: rows.length,
						__index: rows.length,
					};
		}
		const insertIndex = fileRowIndex >= 0 ? fileRowIndex : rows.length;
		// mnGridView.target.addRow(newRowData, rows.length);
		mnGridView.target.addRow(newRowData, insertIndex); 
	}
	
	// 삭제
	function deleteMn() {
		var rows = mnGridView.target.getList("selected")[0];
		if (rows.length = 0){
			alert("삭제할 주제를 선택하세요!");
			return false;
		}
		
		var formData = {
				mnDate 		: rows.mnDate,
				mnSubSeq 	: rows.mnSubSeq
		}
		postAjax("/user/pm/pm10/deleteMn", formData, null, function(data) {
			if (data.resultCode == 200) {
				mnGridView.setData();
			}

			recalcSortOrder();
		});
	}

	
	//회의 주제 Insert, Update
	function pm10_d01_update(item, colKey, value) {
		const rows = mnGridView.target.list;
		
		item[colKey] = value;
		var paramObj = {
				mnDate   : $('#mnDate_S').val(),
			    mnWeeks	 : $('#mnWeeks_S').val(),
				mnSubSeq : (item.mnSubSeq)?item.mnSubSeq : 1,
				mnSubject: item.mnSubject,
				mnSortNo : (item.mnSortNo != null && item.mnSortNo !== '') ? item.mnSortNo : 1,
				mnEtcAll : item.mnEtcAll,
				mnStatus : item.mnStatus,
				userId   : $('#userId').val(),
				pgmId    : $('#pgmId').val()
		};
		postAjax('/user/pm/pm10/pm10_d01_update', paramObj, null, function(data) {
			if (data.resultCode == 200) {
				pm10_d02_update();
				mnGridView.setData();
// 				recalcSortOrder();

			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	//팀별 회의 내용 Insert, Update
	function pm10_d03_update(item, colKey, value) {
		const div = $('#mnDiv_S').val();	// 구분 값 읽기
		var paramObj = {
			mnDate   	: $('#mnDate_S').val(),
		    mnWeeks	 	: $('#mnWeeks_S').val(),
		    mnSubject 	: item.mnSubject,
			mnSubSeq 	: (item.mnSubSeq)?item.mnSubSeq : 1,
			mnSortNo 	: gPasIntChk(item.mnSortNo),
			mnDeptCd 	: deptCodeMap[colKey],
			mnCnts		: mnDiv=='MNDIV01'? value : '',  //사전공지
   			mnEtc		: '',
   			mnResult	: mnDiv=='MNDIV02'? value : '',		//회의결과
			mnStatus	: '',
			clntPjt		: '',
			clntCd		: '',
			userId   	: $('#userId').val(),
			pgmId    	: $('#pgmId').val()
		};
		
		postAjax('/user/pm/pm10/pm10_d03_update', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				mnGridView.setData();
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}

	// 참석자 update
	function pm10_d02_update() {
		const list = attendList.map(item => {
			const isChecked = $(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
								.is(':checked');
			return {
				attendId:  item.id,
				reasonCd:  isChecked ? 'Y' : 'N',
				reasonRmk: ''
			};
		});
		paramObj = {
			mnDate:     $('#mnDate_S').val(),
			userId:     $('#userId').val(),
			pgmId:      $('#pgmId').val(),
			attendList: list
		}
		postAjax('/user/pm/pm10/pm10_d02_update', paramObj, null, data => {
			if (data.resultCode == 200) {
			} else {
				alert('참석자 저장 실패: ' + data.resultMessage);
			}
		});
	}

	// 참석자 삭제
	function pm10_d02_delete() {
		const toRemoveIds = $('.attend-item.to-remove').map((_, el) => $(el).data('id')).get();
		if (!toRemoveIds.length) {
			alert('삭제할 대상을 클릭해 선택하세요.');
			return;
		}
		const existing = attendList.filter(i => toRemoveIds.includes(i.id) && i.reasonCd !== undefined).map(i => i.id);
		// const localOnly = toRemoveIds.filter(id => !existing.includes(id));

		// // 화면단에만 있는 정보 삭제
		// if (localOnly.length) {
		// 	attendList = attendList.filter(u => !localOnly.includes(u.id));
		// }
		// 테이블에 있는 참석자 삭제
		if (existing.length) {
			paramObj = {
				mnDate:    $('#mnDate_S').val(),
				attendIds: existing
			}
			postAjax('/user/pm/pm10/pm10_d02_delete', paramObj, null, function(data) {
				if (data.resultCode === 200) {
					attendList = attendList.filter(u => !existing.includes(u.id));
					renderAttendList();
				} else {
					alert('참석자 삭제 실패: ' + data.resultMessage);
				}
			});
		} else {
			renderAttendList();
		}
	}

	// 첨부파일 Start
	function mnUploadFile () {
		var formData = new FormData();

		formData.append("userId", $("#userId").val());
		formData.append("pgmId",  $("#pgmId").val());

		// 신규 업로드 파일들
		$.each(mnFileArr, function(idx, obj){
			if(obj.fileKey === 0){
			formData.append("files", obj.file);
			}
		});

		// 삭제할 파일 키들
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		formData.append(
			"fileTrgtKey",
			$("#mnDate_S").val().replace(/-/g, "") + "-" + deptCodeMap[currentFileColumn]
		);
		formData.append("userId", $("#userId").val());
		formData.append("pgmId",  $("#pgmId").val());

		filePostAjax("/user/pm/pm10/mnUploadFile", formData, function(data){
			alert(data.resultMessage);
			mnGridView.setData();
			mnFileArr = [];
			deleteFileArr = [];
		});
	}
	
	//엑셀다운로드
	function excelDown() {
		var paramObj = {};
		$.each($('#main_area [data-search]'), function(idx, elem){
			if( $(elem).attr("class") == "input_calendar" ) {
				paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
			} else {
				paramObj[$(elem).data("search")] = $(elem).val();	
			}
		});
		postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
			let list = data.result;
			excelView.target.setData({
				list : list,
				page : {
						totalElements : list.length
							}
			});
			var todayDate = new Date().format('yyyyMMddHHmmss');
			excelView.target.exportExcel("임팀장주간회의록"+todayDate+".xls");
		});       
	}
	
	// 체크박스 렌더링 함수
	function renderAttendList() {
		const container = $('#attendCheckboxContainer').empty();
		attendList.forEach(item => {
			// 체크 상태( reasonCd === 'Y' )를 반영해서 input 에 checked 속성 추가
			const isChecked = item.reasonCd === 'Y';
			const $item = $(`
				<div class="attend-item" data-id="${item.id}">
					<input type="checkbox" class="attend-checkbox" ${isChecked ? 'checked' : ''}/>
					${item.name} ${item.title}
				</div>`
			);

			$item.on('click', function(e) {
				if (!$(e.target).hasClass('attend-checkbox')) {
					$(this).toggleClass('to-remove');
				}
			});

			$item.find('.attend-checkbox').on('change', function() {
				pm10_d02_update();
			});
			container.append($item);
		});
	}

	// 참석자 검색
	function openUserSearch() {
		var paramObj = {
			coCd: $('#coCd_S').val(),      // 필요시 조정
			userId: '', userNm: ''
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html",450, 650, "사용자 검색",paramObj,function(tree) {
			const sel = tree.get_checked()[0];
			const node = tree.get_node(sel);
			if (!attendList.some(u => u.id === node.id)) {
				attendList.push({
					id: node.id,
					name: node.text,
					title: node.original.levelNm,
					reasonCd: 'Y'
				});
				reorderAttendList(); // 참석자 정렬
				renderAttendList();  // 추가한 참석자 랜더링
				pm10_d02_update();	 // 추가한 참석자 Update
			}
		}
		);
	}
	
    
    function gridMaxHeightResize() {
		var gridHeigth  = $('[data-ax5grid="mnGrid-grid"]').find('[data-ax5grid-panel-scroll="body"]').height() 
						+ $('[data-ax5grid="mnGrid-grid"]').find('[data-ax5grid-panel="header"]').height();
		console.log(gridHeigth);
		if (gridHeigth > 755) {
			mnGridView.target.setHeight(gridHeigth);
		}
    }


	// ax5grid 세팅 후 아래 함수 호출
	function syncRowHeights() {
		var $rows = $('[data-ax5grid="mnGrid-grid"]').find('[data-ax5grid-panel-scroll="body"] tr');
		var maxHeight = 30;
		$rows.each(function(){
		    var rowHeight = $(this).outerHeight();
		    if(rowHeight > maxHeight) maxHeight = rowHeight;
		});
		// grid에 적용
		var oldConfig = mnGridView.target.config.body || {};
	    mnGridView.target.setConfig({
	        body: $.extend({}, oldConfig, { columnHeight: maxHeight })
	    });
	    mnGridView.target.repaint();
	}
	

	// 선택된 행 하나를 위로 한 칸 이동
	function moveSelectedUp() {
		const list = mnGridView.target.list;
		const row = mnGridView.target.getList("selected");

		if (!row.length) { alert("이동할 행을 선택하세요"); return; }

		const idx = list.findIndex(item =>
			item.mnSubSeq === row[0].mnSubSeq &&
			item.mnDate   === row[0].mnDate
		);
		if (idx <= 0) return;
		[list[idx-1], list[idx]] = [list[idx], list[idx-1]];
		mnGridView.target.setData({ list, page:{ totalElements: list.length } });
		recalcSortOrder();
	}

	// 선택된 행 하나를 아래로 한 칸 이동
	function moveSelectedDown() {
		const list = mnGridView.target.list;
		const row = mnGridView.target.getList("selected");

		if (!row.length) { alert("이동할 행을 선택하세요"); return; }

		const idx = list.findIndex(item =>
			item.mnSubSeq === row[0].mnSubSeq &&
			item.mnDate   === row[0].mnDate
		);
		if (idx < 0 || idx === list.length - 1) return;
		[list[idx], list[idx+1]] = [list[idx+1], list[idx]];
		mnGridView.target.setData({ list, page:{ totalElements: list.length } });
		recalcSortOrder();
	}

	// 정렬번호 재계산
	function recalcSortOrder() {
		const list = mnGridView.target.list;

		list.forEach((item, i) => item.mnSortNo = i + 1);
		mnGridView.target.setData({ list, page:{ totalElements: list.length } });

		var paramObj = {
				mnDate	:   $('#mnDate_S').val(),
				userId	:   $('#userId').val(),
				pgmId	:   $('#pgmId').val(),
				list	:   list
		};
		postAjax('/user/pm/pm10/pm10_d01_sortNo_update',paramObj, null, function(data) {
			if (data.resultCode !== 200) {
// 				alert('정렬순서 저장 실패: ' + data.resultMessage);
			}
		});
	}


	//Select 선택 코드값 체크하여 명을 출력
	function getComboName(comboArray, key) {
		let rtnNm = "";
		for (const element of comboArray) {
			if (key.value == element.CD) {
				rtnNm = element.NM;
				break;
			}
		}
		return rtnNm;
	}  

	// 참석자 정렬 함수
	function reorderAttendList() {
		attendList.sort((a, b) => {
			const ia = FIXED_ORDER.indexOf(a.id);
			const ib = FIXED_ORDER.indexOf(b.id);
			if (ia !== -1 && ib !== -1) return ia - ib;  // 둘 다 기본 → 순서대로
			if (ia !== -1) return -1;                    // a는 기본, b는 신규 → a 우선
			if (ib !== -1) return 1;                     // b는 기본, a는 신규 → b 우선
			return 0;                                    // 둘 다 신규 → 추가된 순서 유지
		});
	}

	
</script>
