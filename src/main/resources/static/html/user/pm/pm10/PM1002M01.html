<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	
          
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
</head>

<body>
  <div id="head_area"></div>
  <div id="top_area"></div>
  <div id="main_area">
  
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="mnGridView.setData(0);"><button class="bg_gray">검 색</button></a>			 
	            </li>
            </ul>
        </div>
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 4분할 -->
				<table class="table_input type04">

					<tr>
						<th class= "hit">회사</th>
						<td>
							<select id="coCd" name="coCd" data-kind="CO" data-search="coCd" required="required" msg="회사">
							</select>
						</td>

						<th class= "hit">회의일자</th>
						<td>
							<input id="mnDate_S" name="mnDate_S" data-search="mnDate" required="required" msg="회의일자">
						</td>
						
						<th>주차</th>
						<td>
							<input type="test" id="mnWeeks_S" name="mnWeeks_S"  data-search="mnWeeks">
						</td>
						<td></td>
						<td></td>
					</tr>			     
	            </table>
				<!-- 검색조건 END -->	      
<form id="mainForm" onSubmit="return false;">				      
		<input type="hidden" id="userId"    name="userId">
		<input type="hidden" id="pgmId"     name="pgmId" value="PM1002M01">
</form>			        
            </div>
        </div>        

		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<div class="contents_tit">
				<span  style="height: 30px; line-height: 30px;font-size: 15px;">임팀장 주간회의 자료</span>
				<div class="add_btn_small pdl10">
					<a onclick="inserPurchase('C');" style="height: 30px; line-height: 28px;" authchk>+</a>
					<a onclick="deleteVendEstimate();" style="height: 30px; line-height: 28px;" authChk>-</a>
					<a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;" authChk><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
			    </div>
			</div>
		    <!-- 리스트 -->
		      <div class="ax5_grid" data-ax5grid="mnGrid-grid" data-ax5grid-config="{}" style="height: 755px; width: 100%" ></div>
		      <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>
		
    </div>
                    
</body>
</html>

<script type="text/javascript">

//formatter 공통 함수
function valueFormatter() {
 return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : '';
}

var mnGridView = {
	initView: function(){
	this.target = new ax5.ui.grid();
	this.target.setConfig({
		showRowSelector: false,
		multipleSelect: false,
		sortable: false,
		showLineNumber: false,
		lineNumberColumnWidth: 30,
		target: $('[data-ax5grid="mnGrid-grid"]'),
		header: {
           align: "center",
           selector: false
         },
         body: {
		    mergeCells : ["ordrgNo"],
			onClick: function () {
				this.self.clearSelect();				
			    this.self.select(this.dindex);
			},
			onDBLClick: function () {
				this.self.clearSelect();
				this.self.select(this.dindex);
				var row = this.dindex;
				//거래처조회 화면 call
				if (this.column.key == 'clntNm' || this.column.key == 'salesEmpIdNm' || this.column.key == 'pchsQty' || this.column.key == 'pchsAmt') {
					var paramObj = {
									actionType: "U",
									crnTyp    : "CRNTYP01",
									clntCd    : this.item.pchsClntCd,
									};
					openModal("/static/html/user/pm/pm10/PM1002P01.html", 1500, 870, "", paramObj);
				}
			},
			//그리드값 변경시 실행
            onDataChanged: function () {
            },
	   },
        page: {
			navigationItemCount: 9,
			height: 30,
			display: false,
			firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
			prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
			nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
			lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
			onChange: function () {
				mnGridView.setData(this.page.selectPage); 
			}
        },
        columns: [
            { key: "mnSubject", 	label: "PTOJECT<br>/<br>주제", 		align: "left", width: 100 },
            { key: "gun00MnCnts", 	label: "임원", 						align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
            { key: "gun60MnCnts", 	label: "생산", 						align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
            { key: "gun30MnCnts", 	label: "영업<br>국내.해외", 			align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
            { key: "gun40MnCnts", 	label: "연구소", 						align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
            {
                key: undefined, 	label: "트루넷", columns: [
                    { key: "trn5010MnCnts", label: "기계", 				align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
                    { key: "trn5020MnCnts", label: "전기", 				align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter }
                ]
            },
            { key: "gun10MnCnts", 	label: "경영지원팀<br>총무/인사/제조혁신", 	align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
            { key: "gun80MnCnts", 	label: "전산실", 						align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter },
            { key: "mnStatus", 		label: "진행/완료", 					align: "left", width: 70 },
            { key: "mnEtcAll", 		label: "특이사항", 					align: "left", width: 220, editor: {type: "textarea"}, formatter: valueFormatter }
        
        ]
	});
		return this;
	},
     setData: function(_pageNo) {
   	    	var targetObj = this.target;
			var paramObj = {};
			$.each($('#main_area [data-search]'), function(idx, elem){
				if( $(elem).attr("class") == "input_calendar" ) {
					paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
				} else {
					paramObj[$(elem).data("search")] = $(elem).val();	
				}
			});			
			
			postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
				try {
					let list = data.result;
					targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							} 
					});	

				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
           });
      } 
	}


	var excelView = {
		initView: function(){
		this.target = new ax5.ui.grid();
		this.target.setConfig({
		target: $('[data-ax5grid="excel-grid"]'),
		columns: [     
           ]
		});
		   return this;
    }
}        
  
    
	function initSearch() {
	    // datepicker를 제외한 select, input 값 모두 초기화
	    $(".contents.search select").val("");
	    $(".contents.search input").val("");    
	    // 회사 초기화
	    $("#coCd").val(jwt.coCd);
	
	    $.dayInit();
	    
	    // 재검색
	    mnGridView.setData(0);
	}


	$(document).ready(function() {
		//초기설정들		
		mainDefaultLoad("사업계획", "임팀장주간회의록");
		setCommonSelect($("#main_area select[data-kind]"));
		
		$.dayInit = function() {
	
			// 종료일 (현재날짜의 월 말일)
			$('#mnDate_S').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true,
			    beforeShowDay: function(date) {
			        // 5 = 금요일만 선택가능하게 하기
			        return date.getDay() === 5;
			    }
			}).datepicker("setDate", moment().day(5).toDate());
			
		}
	
		// 접속자 회사 set
		$("#coCd").val(jwt.coCd);
	    $("#userId").val(jwt.userId);
	    $.dayInit();
	    
	    mnGridView.initView().setData(0);
		excelView.initView();
		//권한체크
// 		authChk();	
			
	 });
	 

	//평가내역 팝업
	function openCostDetailNew(param) {
		if (param.coCd == "undefined" || param.coCd == "") {
			alert("수정할 자료를 선택해 주세요.");
			return;
		}

		paramObj = {
			"actionType" : "U",
			"userId" : jwt.userId,
			"pgmId" : "PM1002M01"
		};
		Object.assign(paramObj, param);
		openModal("/static/html/user/pm/pm10/PM1002P01.html", 1000, 520, "", paramObj);
	}
	
	//엑셀다운로드
	function excelDown() {
		var paramObj = {};
		$.each($('#main_area [data-search]'), function(idx, elem){
			if( $(elem).attr("class") == "input_calendar" ) {
				paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
			} else {
				paramObj[$(elem).data("search")] = $(elem).val();	
			}
		});			
		postAjax("/user/pm/pm10/selectMnList", paramObj, null, function(data){
			let list = data.result;
		  	excelView.target.setData({
		  		list : list,
		  		page : {
		                  totalElements : list.length
		        			}
		  	});
 			var todayDate = new Date().format('yyyyMMddHHmmss');
			excelView.target.exportExcel("공급업체평가_"+todayDate+".xls");
		});       
	}  
	
 
    function gridResize(size) {
        let tagHeight = (size) * 27 + 50 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 320 ? 320 : tagHeight;
        
        mnGridView.target.setHeight(tagHeight);
    }
    

	//공급업체평가표 출력
	function setReportMulti(_type = "") {
		if(selectGridValidationM(mnGridView.target)) return false;
		var selDataList = mnGridView.target.getList("selected");
	    
		var fileName = "PM1002R01.jrf";
		var arg =  
			  "coCd#"		+  $('#coCd_S').val()
		    + "#clntCd#"	+  selDataList.map(item => item.pchsClntCd).join(",") 
	    	+ "#year#"		+  $('#trgYear_S').val()
	    	+ "#";                 
	
		if (_type == '' || _type == undefined ) {
			callReport(fileName, arg, 1150, 720, '공급업체평가표');
		} else { //Export 작업
			ubiExportAjax(fileName, arg, function(response) {
				if (response.resultCode === 200) {
					var base64FileData = response.base64FileData;
					var fileName = response.exportFileName;
					downloadPDFFromBase64(base64FileData, fileName);
				} else {
					alert('PDF 내보내기 실패: ' + response.resultText);
				}
	
			});
		}
	
	}    

    
</script>
