<!DOCTYPE html>
<html lang="ko">
	<style>
	.attend-cell{
		position:relative;
		width:100%;
		min-height:44px;
		padding-right:60px;
		box-sizing:border-box;
	}

	.attend-list{
		margin-bottom:8px;
	}

	.attend-item{
		display:inline-block;
		margin:2px;
		padding:2px 6px;
		border:1px solid #ccc;
		border-radius:3px;
		cursor:pointer;
	}

	.attend-item.to-remove{
		background-color:#fdd;
	}

	.attend-btns{
		position:absolute;
		right:6px;
		top:6px;
		display:flex;
		gap:6px;
	}

	.attend-add-btn,
	.attend-remove-btn{
		display:inline-flex;
		align-items:center;
		justify-content:center;
		width:22px;
		height:22px;
		background-color:rgba(201, 201, 201, 0.839);
		color:#000000;
		font-size:12px;
		font-weight:700;
		border-radius:3px;
		text-decoration:none;
		cursor:pointer;
	}

	.attend-remove-btn{
		background-color:rgba(201, 201, 201, 0.839);
	}

</style>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">

	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
	<script src="/static/js/manualPopup.js"></script>
</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area" style="position: static; height: 100%;">
		<!-- <div id="main_area"> -->
		<span style="height: 30px; line-height: 30px;font-size: 15px;margin-left: 15px">회의록 </span>
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<table class="table_input type04">
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required>
								<option value="">전체</option>
							</select>
						</td>
						<th class="hit">업무구분</th>
						<td>
							<select id="bizDiv_S" name="bizDiv_S" data-search="bizDiv" onchange="gridView.setData(0);" required>
								<option value="AGENDA01">프로젝트</option>
								<option value="AGENDA02">일반회의</option>
							</select>
						</td>
						<th>Sales Code</th>
						<td>
							<div class="search_form">
								<input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd"
									onkeyup="if(window.event.keyCode == 13) {wbsSalesCodeSearch();}">
								<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>수주번호</th>
						<td>
							<div class="search_form">
								<input type="text" id="ordrsNo_S" name="ordrsNo_S" data-search="ordrsNo"
									onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''">
								<a onclick="opendOrdrsSearch($('#ordrsNo_S').val(), $('#coCd_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<td></td>
					</tr>
					<tr>
						<th>통합검색</th>
						<td>
							<input type="text" id="dataSearch_S" name="dataSearch_S" data-search="dataSearch"
								onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? gridView.setData(0) : ''; ">
						</td>
						<th>담당자</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="mngId_S" name="mngId_S" data-search="mngId">
								<input type="text" id="mngIdNm_S" name="mngIdNm_S" data-search="mngIdNm"
									onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? mngId_S.value='' : event.keyCode == 13 ? gridView.setData(0) : '' ">
								<a onclick="openUserSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th class="">고객사</th>
						<td>
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm"
									onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>고객사PJT</th>
						<td>
							<select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt" onchange="seletHeaderInfo();">
								<option value="">전체</option>
							</select>
						</td>
					</tr>
				</table>
				<form id="mainForm" onSubmit="return false;">
					<input type="hidden" id="deptId" name="deptId">
					<input type="hidden" id="pgmId" name="pgmId" value="PM2001M01">
				</form>
			</div>
		</div>
		<div class="contents no_bg">
			<div class="contents_tit">
				<span style="height: 30px; line-height: 30px;font-size: 15px;margin-left: 15px">회의록 리스트</span>
				<div class="add_btn_small pdl10">
					<a onclick="insertAg();" id="addRow" style="width: 80px; height: 30px; line-height: 28px;">안건 추가</a>
					<a onclick="deleteAg();" id="deleteRow" style="width: 80px; height: 30px; line-height: 28px;">안건 삭제</a>
					<a onclick="addDateColumn();" style="width: 80px; height: 30px; line-height: 28px;">날짜 추가</a>
					<a onclick="deleteDateColumn();" style="width: 80px; height: 30px; line-height: 28px;">날짜 삭제</a>
					<a onclick="setReport();" style="height: 30px; line-height: 28px; width: 100px;"><i class="fas fa-print"></i> 회의록출력</a>
					<a onclick="jsonToExcel(gridView);" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
				</div>
			</div>
		</div>

		<div class="contents">
			<!-- 콘텐츠 타이틀 -->
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="agenda-grid" data-ax5grid-config="{}"
				style="height: 780px; width: 100%; overflow-y: auto;"></div>
			<div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>
	</div>
	<input type="file" id="fileInput" multiple style="display:none" />
	<input type="text" id="colDatePicker" style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0;" />
</body>

</html>
<script type="text/javascript">

	let fileRowInserted = false;
	let currentFileRow = null;
	let currentFileColumn = null;
	var agFileArr = [];
	var deleteFileArr = [];
	let lastEditBackup = ""; // 마지막 편집 전 값 백업
	let uniqueFileTrgtKey = ""; // 고유 파일대상키

	// 날짜 컬럼 관리
	let dateColSeq = 0;
	let currentDateColKey = null;
	const dateColMap = {};

	function valueFormatter() {
		return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : '';
	}

	function agendaTitleFormatter() {
		// 참석자/파일첨부 행은 가운데 표시
		if (this.item && (this.item.rowType === 'ATTEND' || this.item.rowType === 'FILE')) {
			const txt = (this.item.agendaTitle == null) ? '' : String(this.item.agendaTitle);
			return '<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">'
				+ txt
				+ '</div>';
		}
		return valueFormatter.call(this);
	}

	// 진행상태(Y=완료)일 때 행 색상 클래스 리턴
	function gridColor(dataValue) {
		let rtnColor = "";
		let row = dataValue.item;

		// 참석자/파일첨부 행은 제외
		if (row && (row.rowType === 'ATTEND' || row.rowType === 'FILE')) {
			return "";
		}

		if (row && row.mnStatus == "Y") {
			rtnColor = "grid-cell-red";
		} else {
			rtnColor = "";
		}

		return rtnColor;
	}

	// 진행상태 코드
	const mnStatusCode = [
		{'CD' : '', 'NM' : ''},
		{'CD' : 'N', 'NM' : '진행'},
		{'CD' : 'Y', 'NM' : '완료'}
	];

	// 진행상태 formatter
	function statusFormatter() {
		if (this.item && (this.item.rowType === 'ATTEND' || this.item.rowType === 'FILE')) return '';
		const cd = (this.value == null) ? '' : String(this.value);
		const found = mnStatusCode.find(x => String(x.CD) === cd);
		return found ? found.NM : '';
	}

	// =========================
	// 참석자 셀 formatter (프론트 전용)
	// =========================
	function attendCellFormatter() {
		const colKey = this.key;
		const attends = (this.item.attendByColumn && this.item.attendByColumn[colKey]) || [];

		// 참석자 리스트
		const listHtml = attends.length ?
			`<div class="attend-list">
				${attends.map((u, i) =>
					`<div class="attend-item ${u.toRemove ? 'to-remove' : ''}" data-idx="${i}" data-col="${colKey}">
						${u.name}
					</div>`
				).join('')}
			</div>` : '';

		// 버튼
		const btnHtml = `
					<div class="attend-btns">
						<a class="attend-add-btn" data-col="${colKey}">+</a>
						<a class="attend-remove-btn" data-col="${colKey}">-</a>
					</div>
					`;

		return `<div class="attend-cell">
					${listHtml}
					${btnHtml}
				</div>`;
	}

	function fileCellFormatter() {
		if (!this.item || this.item.rowType !== 'FILE') return valueFormatter.call(this);

		const colKey = this.key;
		const files = (this.item.filesByColumn && this.item.filesByColumn[colKey]) || [];

		const listHtml = files.length ?
			`<ul class="file-list" style="padding:0; margin:0; list-style:none;">
				${files.map((f, i) =>
					`<li data-idx="${i}" data-col="${colKey}" style="margin:6px 0; display:flex; align-items:center;">
						<button class="file-remove" data-idx="${i}" data-col="${colKey}" style="font-size:11px; padding:4px 10px; margin-right:6px; background-color:rgb(255,50,0); cursor:pointer;">삭제</button>
						<span class="file-preview" style="white-space: nowrap; text-decoration:underline; cursor:pointer;" data-idx="${i}" data-col="${colKey}">${f.name}</span>
					</li>`
				).join('')}
			</ul>` : '';

		const btnHtml =
			`<div class="file-add-wrap" style="width:100%; text-align:center; margin-top:12px;">
				<button class="file-add-btn" data-col="${colKey}" style="font-size:11px; padding:4px 10px; cursor:pointer;">추가</button>
			</div>`;

		return listHtml + btnHtml;
	}

	function buildDateColumnConfig(colKey, dateStr) {
		dateColMap[colKey] = dateStr;
		return {
			key: colKey,
			label: `<span class="date-col-label" data-colkey="${colKey}" style="cursor:pointer; text-decoration:underline;">${dateStr}</span>`,
			align: "left",
			width: 500,
			editor: {
				type: "textarea",
				disabled: function () {
					// 참석자/파일첨부 행은 편집 금지
					return this.item && (this.item.rowType === 'ATTEND' || this.item.rowType === 'FILE');
				}
			},
			formatter: function() {
				if (this.item.rowType === 'ATTEND') {
					return attendCellFormatter.call(this);
				} else if (this.item.rowType === 'FILE') {
					return fileCellFormatter.call(this);
				} else {
					return valueFormatter.call(this);
				}
			},
			styleClass: function () { return gridColor(this); }
		};
	}

	var gridView = {
		initView: function(){
			this.target = new ax5.ui.grid();

			// 기본 날짜 컬럼 1개 생성(오늘)
			if (dateColSeq === 0) {
				dateColSeq = 1;
				const today = moment().format('YYYY-MM-DD');
				buildDateColumnConfig('dateCol1', today);
			}

			this.target.setConfig({
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				showLineNumber: false,
				lineNumberColumnWidth: 30,
				target: $('[data-ax5grid="agenda-grid"]'),
				header: {
					align: "center",
					selector: false
				},
				body: {
					columnHeight: 50,
					onClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDBLClick: function () {
						// 클릭 시점(편집 전)에 백업
						lastEditBackup = { dindex: this.dindex, key: this.column.key, value: this.item[this.column.key] };
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDataChanged: function(){
						if (this.key.startsWith('dateCol')) {
							if ($("#salesCd_S").val() == "") {
								customAlert("SALES CODE를 선택해주세요.");
								this.self.setValue(this.dindex, this.key, lastEditBackup.value);
								lastEditBackup = null;
								gridView.target.repaint(true);
								return false;
							}

							if ($("#ordrsNo_S").val() == "") {
								customAlert("수주번호를 선택해주세요.");
								this.self.setValue(this.dindex, this.key, lastEditBackup.value);
								lastEditBackup = null;
								gridView.target.repaint(true);
								return false;
							}
							insert_update_agenda(this.item, this.key, this.value);
							this.item[this.key] = this.value;
						} else if (this.key == 'agendaTitle') {
							insert_update_agenda_title(this.value, this.item);
							this.item[this.key] = this.value;
						}
						gridView.target.repaint(true);
					}
				},
				page: {
					navigationItemCount: 9,
					height: 30,
					display: false,
					firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange: function () {
						gridView.setData(this.page.selectPage);
					}
				},
				columns: [
							{key: "fileTrgtKey", 	label: "파일KEY", align: "center", width: 220, hidden: true},
							{key: "agendaNo", 		label: "안건번호", align: "center", width: 220, hidden: true},
							{key: "agendaVer", 	label: "안건버전", align: "center", width: 220, hidden: true},
							{key: "agendaTitle", 	label: "안건", align: "center", width: 220,
								editor: {
									type: "textarea",
									disabled: function () { return this.item && (this.item.rowType === 'ATTEND' || this.item.rowType === 'FILE');}
								}, formatter: agendaTitleFormatter, styleClass: function () { return gridColor(this); }
							},
							buildDateColumnConfig('dateCol1', dateColMap['dateCol1']),
							{key: "mnStatus", 		label: "진행여부", align: "center", width: 100,
								editor: {
									type: "select",
									disabled: function () {return this.item && (this.item.rowType === 'ATTEND' || this.item.rowType === 'FILE');},
									config: {columnKeys: { optionValue: "CD", optionText: "NM" },options: mnStatusCode}
								}, formatter: statusFormatter, styleClass: function () { return gridColor(this); }
							}
						]
			});

			this.target.setData({ list: [], page: { totalElements: 0 } });

			return this;
		},
		setData: function(_pageNo) {
			if ($("#bizDiv_S").val() == "") {
				customAlert("업무구분을 선택해주세요.");
				return false;
			}

			var targetObj = this.target;
			var formData = {};
			formData["userId"] = jwt.userId;
			$.each($('#main_area [data-search]'), function(idx, elem){
				formData[$(elem).data("search")] = $(elem).val();
			});

			postAjax("/user/pm/pm20/selectAgendaList", formData, null, function(data) {
				try {
					if (data.result == null || data.result.length == 0) {
						targetObj.setData({ list: [], page: { totalElements: 0 } });
						return false;
					}
					var rows = data.result.filter(r => !r.rowType || r.rowType !== 'FILE'); // 안건 데이터만 필터링
					uniqueFileTrgtKey = rows.length > 0 ? rows[0].fileTrgtKey : '';

					// 1) 날짜 목록(컬럼 라벨)
					let dates = [...new Set(rows.map(r => r.agendaDate).filter(Boolean))].sort();
					if (dates.length === 0) {
						dates = [moment().format('YYYY-MM-DD')];
					}

					// 2) 기존 dateCol 컬럼 전부 제거 (targetObj.config.columns 기준)
					for (let i = targetObj.config.columns.length - 1; i >= 0; i--) {
						const c = targetObj.config.columns[i];
						if (c && c.key && c.key.indexOf('dateCol') === 0) {
							targetObj.removeColumn(i);
						}
					}

					// 3) dateColMap / seq 초기화
					Object.keys(dateColMap).forEach(k => delete dateColMap[k]);
					dateColSeq = 0;
					currentDateColKey = null;

					// 4) 날짜 수만큼 agendaDate..n 컬럼 생성
					const dateKeyMap = new Map(); // 'YYYY-MM-DD' -> 'dateColN'

					dates.forEach((d, idx) => {
						const key = "dateCol" + (idx + 1);
						dateColSeq = idx + 1;
						dateKeyMap.set(d, key);

						const statusIdx = targetObj.config.columns.findIndex(c => c && c.key === 'mnStatus');
						const insertIdx = (statusIdx === -1) ? targetObj.config.columns.length : statusIdx;

						targetObj.addColumn(buildDateColumnConfig(key, d), insertIdx);
					});

					// 5) 안건별 가로형 row 만들기
					const rowMap = new Map();

					rows.forEach(r => {
						const id = (r.fileTrgtKey || '') + '|' + (r.agendaNo || '');

						if (!rowMap.has(id)) {
							const baseRow = {
								rowType: 'AGENDA',
								fileTrgtKey: r.fileTrgtKey || '',
								agendaNo: r.agendaNo || '',
								agendaVer: 0,
								agendaVerByCol: {},
								agendaTitle: r.agendaTitle || '',
								mnStatus: r.agendaStatus || 'N'
							};

							dates.forEach(d => {
								baseRow[dateKeyMap.get(d)] = '';
							});

							rowMap.set(id, baseRow);
						}

						const colKey = dateKeyMap.get(r.agendaDate);
						if (colKey) {
							const prev = rowMap.get(id)[colKey];
							const txt  = r.agendaCnts || '';
							rowMap.get(id)[colKey] = prev ? (prev + "\n" + txt) : txt;

							const v = Number(r.agendaVer || 0);
							rowMap.get(id).agendaVerByCol[colKey] = v;
							if (v > Number(rowMap.get(id).agendaVer || 0)) {
								rowMap.get(id).agendaVer = v;
							}
						}

						
					});

					const list = [...rowMap.values()];

					// 파일첨부: data.result에서 rowType='FILE' 찾기
					const fileEntry = (data.result || []).find(r => r && r.rowType === 'FILE' && typeof r.files === 'string');
					const parsedFiles = fileEntry ? JSON.parse(fileEntry.files) : [];

					// 참석자: data.result에서 rowType='ATTEND' 찾기 (백엔드가 attendData를 내려준다는 전제)
					const attendEntry = (data.result || []).find(r => r && r.rowType === 'ATTEND' && typeof r.attendData === 'string');
					let parsedAttends = [];
					if (Array.isArray(data.d02List)) {
						parsedAttends = data.d02List;
					} else if (attendEntry) {
						parsedAttends = JSON.parse(attendEntry.attendData);
					}

					// fileRow 기본 구조
					const fileRow = {
						rowType: 'FILE',
						agendaTitle: '파일첨부',
						mnStatus: '',
						filesByColumn: {}
					};

					// parsedFiles 배열 돌면서 agendaDate에 맞춰 filesByColumn에 추가
					parsedFiles.forEach(f => {
						const agendaDate = f.agendaDate || f.agendadate; // 대소문자 확인
						const colKey = dateKeyMap.get(agendaDate);
						if (!colKey) return;

						if (!fileRow.filesByColumn[colKey]) {
							fileRow.filesByColumn[colKey] = [];
						}
						fileRow.filesByColumn[colKey].push({
							name: f.fileName,
							fileKey: f.fileKey,
							fileType: f.fileType
						});
					});

					// 날짜 컬럼에 빈 값 초기화
					dates.forEach(d => {
						const colKey = dateKeyMap.get(d);
						if (!fileRow.filesByColumn[colKey]) {
							fileRow.filesByColumn[colKey] = [];
						}
					});

					// 최종 리스트: 안건 + 참석자 + 파일첨부
					const attendRow = {
						rowType: 'ATTEND',
						agendaTitle: '참석자',
						mnStatus: '',
						attendByColumn: {}
					};
					dates.forEach(d => {
						const colKey = dateKeyMap.get(d);
						attendRow[colKey] = '';
						attendRow.attendByColumn[colKey] = [];
					});

					// parsedAttends 배열 돌면서 agendaDate에 맞춰 attendByColumn에 추가
					parsedAttends.forEach(a => {
						const colKey = dateKeyMap.get(a.agendaDate);
						if (!colKey) return;
						attendRow.attendByColumn[colKey].push({
							id: a.attendId || a.id,
							name: a.attendNm || a.name,
							toRemove: false
						});
					});

					const finalList = [...list, attendRow, fileRow];

					targetObj.setData({
						list: finalList,
						page: { totalElements: finalList.length }
					});

					// syncFixedRows 호출 제거 (이미 백엔드 데이터로 처리)
					targetObj.repaint();

				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
				}
			});
		}
	};

	$(document).ready(function() {
		//초기설정들
		mainDefaultLoad("공통업무", "회의록");
		setCommonSelect($("#main_area select[data-kind]"));

		// 화면 크기 조절
		$("#top_area").hide();
		$('#head_area').toggleClass('off');
		$('#main_area').toggleClass('on');

		$("#deptId").val(jwt.deptId);
		$("#userId").val(jwt.userId);

		// 접속자 회사 set
		$("#coCd_S").val(jwt.mngCoCd);

		gridView.initView(); // 초기 데이터 로드 제거, 검색 전까지 빈 상태

		// 사이드바 토글 시 재조회 대신 기존 데이터 리페인트/리사이즈만
		$('.off_btn').on('click', function(e){
			// showSize();
			if (gridView.target) {
				gridView.target.repaint();
			}
		});

		// =========================
		// 날짜 컬럼 헤더 클릭 시 datepicker 호출
		// =========================
		$('[data-ax5grid="agenda-grid"]').on('click', '.date-col-label', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const colKey = $(this).data('colkey');
			if (!colKey) return;

			currentDateColKey = colKey;

			const curDate = dateColMap[colKey] || moment().format('YYYY-MM-DD');

			$('#colDatePicker')
				.css({
					left: (e.pageX || 0) + 'px',
					top:  (e.pageY || 0) + 'px'
				})
				.each(function () {
					try { $(this).datepicker('destroy'); } catch (e) {}
				})
				.datepicker({
					format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true
				})
				.datepicker('setDate', curDate)
				.datepicker('show')
				.off('changeDate')
				.on('changeDate', function(ev) {
					const selDate = moment(ev.date).format('YYYY-MM-DD');
					dateColMap[currentDateColKey] = selDate;

					const grid = gridView.target;

					let idx = -1;
					if (grid && grid.config && Array.isArray(grid.config.columns)) {
						idx = grid.config.columns.findIndex(c => c && c.key === currentDateColKey);
					}
					if (idx < 0 && grid && Array.isArray(grid.colGroup)) {
						idx = grid.colGroup.findIndex(c => c && c.key === currentDateColKey);
					}

					if (idx > -1) {
						const newCol = buildDateColumnConfig(currentDateColKey, selDate);
						grid.removeColumn(idx);
						grid.addColumn(newCol, idx);
					} else {
						$('[data-ax5grid="agenda-grid"] .date-col-label[data-colkey="' + currentDateColKey + '"]').text(selDate);
					}

					grid.repaint();
				});
		});

		// =========================
		// 파일첨부 프론트 전용 이벤트
		// =========================
		$('#fileInput').on('change', function(){
			const grid = gridView.target;
			if (!currentFileRow || !currentFileColumn) return;

			Array.from(this.files).forEach(file => {
				// 서버 전송용 배열에 넣고
				agFileArr.push({ fileKey: 0, file, row: currentFileRow, column: currentFileColumn });
				// 화면용 컬럼별 배열에 추가
				currentFileRow.filesByColumn = currentFileRow.filesByColumn || {};
				currentFileRow.filesByColumn[currentFileColumn] = currentFileRow.filesByColumn[currentFileColumn] || [];
				currentFileRow.filesByColumn[currentFileColumn].push({ name: file.name, fileKey: 0 });
			});
			grid.repaint();

			agUploadFile();
			$(this).val('');
			currentFileRow = null;
			currentFileColumn = null;
		});

		// 파일 추가
		$('[data-ax5grid="agenda-grid"]').on('click', '.file-add-btn', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const colKey = $(this).data('col');
			const grid = gridView.target;

			const fileRow = grid.list.find(r => r && r.rowType === 'FILE');
			if (!fileRow) return;

			currentFileRow = fileRow;
			currentFileColumn = colKey;

			$('#fileInput').click();
		});

		// 파일 삭제
		$('[data-ax5grid="agenda-grid"]').on('click', '.file-remove', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const idx = Number($(this).data('idx'));
			const colKey = $(this).data('col');

			const grid = gridView.target;
			const fileRow = grid.list.find(r => r && r.rowType === 'FILE');
			if (!fileRow || !fileRow.filesByColumn || !fileRow.filesByColumn[colKey]) return;

			const removed = fileRow.filesByColumn[colKey].splice(idx, 1)[0];
			if (removed && removed.fileKey) {
				deleteFileArr.push({ fileKey: removed.fileKey });
			}

			grid.repaint();
			agUploadFile();
		});

		// (선택) 파일명 클릭 시 미리보기
		$('[data-ax5grid="agenda-grid"]').on('click', '.file-preview', function(e) {
			e.preventDefault();
			e.stopPropagation();
			const idx = Number($(this).data('idx'));
			const colKey = $(this).data('col');
			const grid = gridView.target;
			const fileRow = grid.list.find(r => r && r.rowType === 'FILE');
			if (!fileRow || !fileRow.filesByColumn || !fileRow.filesByColumn[colKey]) return;
			const f = fileRow.filesByColumn[colKey][idx];
			if (f) {
				const allFiles = fileRow.filesByColumn[colKey];
				const imageList = allFiles.map(f => ({
					fileKey: Number(f.fileKey),
					fileName: f.name,
					coCd: $('#coCd_S').val()
				}));
				imageViewPopup($('#coCd_S').val(), f.fileKey, f.name, imageList);
			}
		});

		// =========================
		// 참석자 프론트 전용 이벤트
		// =========================
		// 참석자 추가
		$('[data-ax5grid="agenda-grid"]').on('click', '.attend-add-btn', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const colKey = $(this).data('col');
			const grid = gridView.target;

			const attendRow = grid.list.find(r => r && r.rowType === 'ATTEND');
			if (!attendRow) return;

			currentAttendColumn = colKey;

			// 여기서 모달 직접 띄우고 선택값 받아서 참석자에 반영
			var paramObj = {
				"coCd"   : $('#coCd_S').val(),
				"userId" : "",
				"userNm" : ""
			};

			openModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function(tree) {
				var checkedId = tree.get_checked()[0];
				if (!checkedId) return;

				var checkedNode = tree.get_node(checkedId);
				if (!checkedNode) return;

				attendRow.attendByColumn = attendRow.attendByColumn || {};
				attendRow.attendByColumn[colKey] = attendRow.attendByColumn[colKey] || [];

				// 참석자 중복체크
				if (attendRow.attendByColumn[colKey].some(u => u && u.id == checkedNode.id && !u.toRemove)) {
					if (typeof customAlert === "function") customAlert("이미 추가된 참석자입니다.");
					return false;
				}

				attendRow.attendByColumn[colKey].push({
					id: checkedNode.id,
					name: checkedNode.text,
					toRemove: false
				});

				grid.repaint();
				pm20_d02_update(attendRow, colKey);
			});
		});

		// 참석자 삭제 모드 토글
		$('[data-ax5grid="agenda-grid"]').on('click', '.attend-remove-btn', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const colKey = $(this).data('col');
			const grid = gridView.target;

			const attendRow = grid.list.find(r => r && r.rowType === 'ATTEND');
			if (!attendRow || !attendRow.attendByColumn || !attendRow.attendByColumn[colKey]) return;

			const attends = attendRow.attendByColumn[colKey];
			const hasToRemove = attends.some(u => u.toRemove);

			if (hasToRemove) {
				// 삭제 실행
				attendRow.attendByColumn[colKey] = attends.filter(u => !u.toRemove);
				grid.repaint();
				pm20_d02_update(attendRow, colKey);
			} else {
				// 삭제 모드 활성화: 모든 attend-item에 to-remove 클래스 토글
				alert('삭제할 참석자를 클릭한 후 다시 - 버튼을 눌러주세요.');
				attends.forEach(u => u.toRemove = true);
				grid.repaint();
			}
		});

		// 참석자 아이템 클릭 (삭제 모드에서 선택)
		$('[data-ax5grid="agenda-grid"]').on('click', '.attend-item', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const idx = Number($(this).data('idx'));
			const colKey = $(this).data('col');
			const grid = gridView.target;

			const attendRow = grid.list.find(r => r && r.rowType === 'ATTEND');
			if (!attendRow || !attendRow.attendByColumn || !attendRow.attendByColumn[colKey]) return;

			const attends = attendRow.attendByColumn[colKey];
			if (attends[idx]) {
				attends[idx].toRemove = !attends[idx].toRemove;
				grid.repaint();
			}
		});

		// $(window).on('resize', showSize);
		// $(function() { showSize(); });

		//권한체크
		// authChk();
	});

	// 참석자 리스트 불러오기 & 렌더링
	function select_p10_d02_List(list) {
		if (list.length > 0) {
			attendList = list.map(user => ({
				id:       user.id,
				name:     user.name,
				title:    user.title,
				reasonCd: user.reasonCd
			}));
		} else {
			// 기본 참여자 전부를 reasonCd: 'Y' 로 설정
			attendList = DEFAULT_ATTEND_LIST.map(user => ({...user, reasonCd: 'Y'}));
		}

		// 고정 멤버 순서대로 정렬
		reorderAttendList();

		// 렌더링
		renderAttendList();
	
		// DB에서 Y인 것만 체크
		attendList.forEach(item => {
			if (item.reasonCd === 'Y') {
				$(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
				.prop('checked', true);
			}
		});
	}
	
	// 주제별 안건 등록 및 수정
	function insert_update_agenda_title(value, item) {
		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"agendaTitle"   : value,
			"userId"        : jwt.userId,
			"agendaStatus"  : item.mnStatus,
			"agendaNo"  	: item.agendaNo
        };

        postAjax('/user/pm/pm20/insert_update_agenda_title', paramObj, null, function(data) {
            if (data.resultCode === 200) {
                gridView.setData();
            } else {
                alert('수정 실패: ' + data.resultMessage);
            }
        });
    }

	// 안건 내용 등록 및 수정
	function insert_update_agenda(item, key, value) {
		// 셀별 버전이 있으면 그걸 쓰고, 없으면 로우 최대+1
		var cellVer = 0;
		if (item.agendaVerByCol && item.agendaVerByCol[key] != null) {
			cellVer = Number(item.agendaVerByCol[key] || 0);
		}
		var nextVer = cellVer > 0 ? cellVer : (Number(item.agendaVer || 0) + 1);
		
		// 헤더 정보 수집
		var paramObj = {
			"fileTrgtKey"	: item.fileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"agendaTitle"	: item.agendaTitle, // 안건
			"agendaDate"	: dateColMap[key], // 날짜
			"agendaCnts"	: value, // 내용
			"userId"		: jwt.userId,
			"agendaVer"   	: String(nextVer)
		};

		// 수정 시 fileTrgtKey와 agendaNo 포함
		if (item.fileTrgtKey) {
			paramObj.fileTrgtKey = item.fileTrgtKey;
		}
		if (item.agendaNo) {
			paramObj.agendaNo = item.agendaNo;
		}

		postAjax('/user/pm/pm20/insert_update_agenda', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				gridView.setData();
			} else {
				alert('수정 실패: ' + data.resultMessage);
			}
		});
	}


	// SALES CODE 검색
	function wbsSalesCodeSearch() {
		var paramObj = {
			"coCd"     : $('#coCd_S').val(),
			"salesCd"  : $('#salesCd_S').val(),
			"searchValue" : $('#salesCd_S').val()
		};
		openModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 700, "SALES CODE 검색", paramObj, function (grid){
			var row = grid.target.getList("selected")[0];
			$('#salesCd_S').val(row.salesCd);
			$('#clntPjt_S').val(row.clntPjt);
			$('#ordrsClntCd_S').val(row.ordrsClntCd);
			$('#ordrsClntNm_S').val(row.ordrsClntNm);
			$('#ordrsNo_S').val(row.ordrsNo);

			gridView.setData(0);
		});
	}

	// 수주번호 검색
	function opendOrdrsSearch(inputValue, coCd) {
		var paramObj = {
			"searchValue" : inputValue,
			"coCd"        : coCd
		};

		openModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 800, "수주번호 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsNo_S').val(row.ordrsNo);
			$('#clntPjt_S').val(row.clntPjt);
			$('#ordrsClntCd_S').val(row.ordrsClntCd);
			$('#ordrsClntNm_S').val(row.clntNm);

			gridView.setData(0);
		});
	}

	// 담당자 검색
	function openUserSearch() {
		var paramObj = {
			"coCd"   : $('#coCd_S').val(),
			"userId" : $('#mngId_S').val(),
			"userNm" : $('#mngIdNm_S').val()
		};

		openModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function(tree) {
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId_S').val(checkedNode.id);
			$('#mngIdNm_S').val(checkedNode.text);

			gridView.setData(0);
		});
	}

	// 거래처 검색
	function opendClntSearch(inputValue) {
		var paramObj = {
			"searchValue" : inputValue,
			"clntDivCd"   : "CLNTDIV12"
		};
		openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsClntCd_S').val(row.clntCd);
			$('#ordrsClntNm_S').val(row.clntNm);

			gridView.setData(0);
		});
	}

	// 첨부파일 업로드
	function agUploadFile () {
		var formData = new FormData();

		formData.append("userId", jwt.userId);
		formData.append("coCd", $('#coCd_S').val());
		formData.append("pgmId",  $('#pgmId').val());
		formData.append("salesCd",  $('#salesCd_S').val());
		formData.append("ordrsNo",  $('#ordrsNo_S').val());
		formData.append("clntCd",  $('#ordrsClntCd_S').val());
		formData.append("prjctCd",  $('#clntPjt_S').val());

		// 신규 업로드 파일들
		$.each(agFileArr, function(idx, obj){
			if(obj.fileKey === 0){
				formData.append("files", obj.file);
			}
		});

		// 삭제할 파일 키들
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		formData.append("fileTrgtKey", uniqueFileTrgtKey + "_" + dateColMap[currentFileColumn]);
		formData.append("userId", jwt.userId);
		formData.append("pgmId",  $('#pgmId').val());

		filePostAjax("/user/pm/pm20/agUploadFile", formData, function(data){
			gridView.setData();
			agFileArr = [];
			deleteFileArr = [];
		});
	}

	// 행 추가 (참석자 로우는 1개만, 항상 마지막)
	function insertAg() {
		const grid = gridView.target;
		const selected = grid.getList("selected");

		let attendIdx = grid.list.findIndex(r => r && r.rowType === 'ATTEND');
		let fileIdx   = grid.list.findIndex(r => r && r.rowType === 'FILE');
		if (attendIdx === -1) attendIdx = grid.list.length;

		// 선택 여부와 관계없이 항상 참석자 행 위에 추가 (맨 아래)
		let insertIndex = attendIdx;

		// 같은 fileTrgtKey의 기존 안건 행들에서 최대 agendaNo 계산
		const existingAgendaRows = grid.list.filter(r => r && r.rowType === 'AGENDA' && r.fileTrgtKey === uniqueFileTrgtKey);
		const maxAgendaNo = existingAgendaRows.length > 0 ? Math.max(...existingAgendaRows.map(r => parseInt(r.agendaNo) || 0)) : 0;
		const newAgendaNo = maxAgendaNo + 1;

		const newAgendaRow = {
			rowType: 'AGENDA',
			fileTrgtKey: uniqueFileTrgtKey,  // fileTrgtKey 설정
			agendaNo: String(newAgendaNo),  // 계산된 agendaNo 설정
			agendaTitle: '',
			mnStatus: 'N',
			agendaVer: 1  // 새로운 행은 버전 1
		};

		const cols = grid.config.columns.map(c => c.key).filter(k => k && k.indexOf('dateCol') === 0);
		cols.forEach(k => {
			newAgendaRow[k] = '';
		});

		grid.addRow(newAgendaRow, insertIndex);
	}

	// 행 삭제 (참석자/파일첨부 삭제 금지)
	function deleteAg() {
		const grid = gridView.target;
		const sel  = grid.getList("selected")[0];
		if (!sel) {
			alert("삭제할 행을 선택하세요!");
			return false;
		}

		const selIndex = sel.__index;
		if (typeof selIndex !== 'number') return false;

		if (grid.list[selIndex] && (grid.list[selIndex].rowType === 'ATTEND' || grid.list[selIndex].rowType === 'FILE')) {
			alert("참석자/파일첨부 행은 삭제할 수 없습니다.");
			return false;
		}

		if (!confirm("선택한 안건을 정말 삭제하시겠습니까?")) {
			return false;
		}

		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"userId"        : jwt.userId,
			"agendaStatus"  : item.mnStatus,
			"agendaNo"  	: item.agendaNo
        };

        // postAjax('/user/pm/pm20/insert_update_agenda_title', paramObj, null, function(data) {
        //     if (data.resultCode === 200) {
        //         gridView.setData();
        //     } else {
        //         alert('수정 실패: ' + data.resultMessage);
        //     }
        // });

		grid.list.splice(selIndex, 1);
		grid.setData({ list: grid.list, page: { totalElements: grid.list.length } });
	}

	// 날짜 추가 (진행여부 컬럼은 마지막 고정)
	function addDateColumn() {
		const grid = gridView.target;

		dateColSeq = dateColSeq + 1;
		const colKey = "dateCol" + dateColSeq;
		const today = moment().format('YYYY-MM-DD');

		const newColumnConfig = buildDateColumnConfig(colKey, today);

		const statusIdx = grid.config.columns.findIndex(c => c && c.key === 'mnStatus');
		const insertIdx = (statusIdx === -1) ? grid.config.columns.length : statusIdx;

		grid.addColumn(newColumnConfig, insertIdx);

		// 데이터 행에 새 컬럼 속성 추가 (빈 값으로 초기화)
		grid.list.forEach(row => {
			if (!row.hasOwnProperty(colKey)) {
				row[colKey] = '';
			}
			if (row && row.rowType === 'FILE') {
				row.filesByColumn = row.filesByColumn || {};
				if (!row.filesByColumn[colKey]) row.filesByColumn[colKey] = [];
			}
		});

		grid.repaint();
	}

	// 날짜 삭제
	function deleteDateColumn() {
		const grid = gridView.target;

		const dateCols = grid.config.columns
			.map((c, i) => ({ c, i }))
			.filter(x => x.c && x.c.key && x.c.key.indexOf('dateCol') === 0);

		if (dateCols.length <= 1) {
			alert("날짜 컬럼은 최소 1개는 있어야 합니다.");
			return;
		}

		let targetKey = currentDateColKey;

		if (!targetKey || !dateCols.some(x => x.c.key === targetKey)) {
			targetKey = dateCols[dateCols.length - 1].c.key;
		}

		const target = dateCols.find(x => x.c.key === targetKey);
		if (!target) return;

		grid.removeColumn(target.i);

		delete dateColMap[targetKey];
		grid.list.forEach(row => {
			if (row && row.hasOwnProperty(targetKey)) {
				delete row[targetKey];
			}
			if (row && row.rowType === 'FILE' && row.filesByColumn && row.filesByColumn.hasOwnProperty(targetKey)) {
				delete row.filesByColumn[targetKey];
			}
		});

		if (currentDateColKey === targetKey) {
			currentDateColKey = null;
		}

		grid.repaint();
	}

	// 엑셀다운로드
	function jsonToExcel(grid) {
		const list = grid.target.getList();
		const raw = grid.target.colGroup;

		const header = raw.map(col => ({
			...col,
			label: String(col.label)
				.replace(/<br\s*\/?>/gi, "\r\n")
				.replace(/<\/?[^>]+>/g, "")
		}));

		exportJSONToExcel(list, header, "회의록");
	}

	function setReport(_type = "") {
		alert("회의록 출력은 백단 연동 후 적용 예정입니다.");
	}

	// 참석자 저장
	function pm20_d02_update(attendRow, colKey) {
		const list = attendRow.attendByColumn[colKey] || [];
		const attendList = list.map(u => ({
			attendId: u.id
		}));

		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"agendaDate"	: dateColMap[colKey],
			"userId"		: jwt.userId,
			"pgmId"			: $('#pgmId').val(),
			"attendList"	: attendList
		};
		postAjax('/user/pm/pm20/pm20_d02_update', paramObj, null, data => {
			if (data.resultCode == 200) {
				// 성공
			} else {
				alert('참석자 저장 실패: ' + data.resultMessage);
			}
		});
	}

</script>
