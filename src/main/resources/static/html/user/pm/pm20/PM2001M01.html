<!DOCTYPE html>
<html lang="ko">
	<style>
	/* 셀 내부 컨테이너 */
	.cell-container {
		display: flex;
		flex-direction: column;
		width: 100%;
		height: 100%;
		min-height: 80px;
		box-sizing: border-box;
	}

	/* 내용 영역 */
	.cell-content {
		flex: 0 0 auto;
		padding: 4px;
		white-space: pre-wrap;
		word-break: break-word;
		min-height: 40px;
	}

	/* 하단 참석자+파일 영역 */
	.cell-bottom {
		display: flex;
		flex-direction: row;
		flex: 1;
		height: 100%;
		min-height: 60px;
		align-items: stretch;
		position: relative;
	}

	/* 참석자+파일 영역 중앙 세로선 */
	.cell-bottom::after {
		content: '';
		position: absolute;
		left: 50%;
		top: 0;
		bottom: 0;
		width: 1px;
		background-color: #ddd;
	}

	/* 참석자 영역 (왼쪽) */
	.cell-attend {
		flex: 1;
		padding: 4px;
		position: relative;
		min-width: 120px;
		box-sizing: border-box;
	}

	/* 파일 영역 (오른쪽) */
	.cell-file {
		flex: 1;
		padding: 4px;
		position: relative;
		min-width: 120px;
		box-sizing: border-box;
	}

	/* 섹션 라벨 */
	.section-label {
		font-size: 11px;
		color: #888;
		margin-bottom: 4px;
		font-weight: bold;
	}

	/* 참석자 관련 스타일 */
	.attend-cell{
		position:relative;
		width:100%;
		min-height:44px;
		padding-right:60px;
		box-sizing:border-box;
	}

	.attend-list{
		margin-bottom:4px;
	}

	.attend-row{
		display:flex;
		flex-wrap:wrap;
		margin-bottom:2px;
	}

	.attend-item{
		display:inline-block;
		margin:1px;
		padding:1px 4px;
		border:1px solid #ccc;
		border-radius:3px;
		cursor:pointer;
		font-size:11px;
	}

	.attend-item.to-remove{
		background-color:#fdd;
	}

	.attend-btns{
		display:flex;
		gap:4px;
		margin-top:4px;
	}

	.attend-add-btn,
	.attend-remove-btn{
		display:inline-flex;
		align-items:center;
		justify-content:center;
		width:18px;
		height:18px;
		background-color:rgba(201, 201, 201, 0.839);
		color:#000000;
		font-size:10px;
		font-weight:700;
		border-radius:3px;
		text-decoration:none;
		cursor:pointer;
	}

	.attend-remove-btn{
		background-color:rgba(201, 201, 201, 0.839);
	}

	/* 파일 관련 스타일 */
	.file-list {
		padding: 0;
		margin: 0;
		list-style: none;
	}

	.file-list li {
		margin: 2px 0;
		display: flex;
		align-items: center;
		font-size: 11px;
	}

	.file-add-wrap {
		margin-top: 4px;
		text-align: center;
	}

	.file-add-btn {
		font-size: 11px;
		padding: 4px 10px;
		cursor: pointer;
		min-width: 10px;
	}
	.file-remove {
		font-size: 11px;
		padding: 4px 10px;
		cursor: pointer;
		max-width: 5px;
		min-width: 5px;
		background-color: rgb(255, 50, 0);
		display: flex;
		justify-content: center;
		align-items: center;
		flex-shrink: 0;
	}

	/* ax5grid cellholder가 td 높이를 채우도록 (.cell-container가 있는 셀만) */
	[data-ax5grid="agenda-grid"] span[data-ax5grid-cellholder]:has(.cell-container) {
		display: block;
		height: 100%;
	}

</style>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">

	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
	<script src="/static/js/manualPopup.js"></script>
</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area" style="position: static; height: 100%;">
		<!-- <div id="main_area"> -->
		<span style="height: 30px; line-height: 30px;font-size: 15px;margin-left: 15px">회의록 </span>
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<table class="table_input type04">
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" onchange="gridView.setData(0);" required>
								<option value="">전체</option>
							</select>
						</td>
						<th class="hit">업무구분</th>
						<td>
							<select id="bizDiv_S" name="bizDiv_S" data-search="bizDiv" required>
								<option value="AGENDA01">프로젝트</option>
								<option value="AGENDA02">일반회의</option>
							</select>
						</td>
						<th>
							<span id="thSalesCd">Sales Code</span>
							<span id="thAgendaDate" style="display:none;">등록기간</span>
						</th>
						<td>
							<div id="tdSalesCd" class="search_form">
								<input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd"
									onkeyup="if(window.event.keyCode == 13) {wbsSalesCodeSearch();}">
								<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
							</div>
							<div id="tdAgendaDate" class="date_input" style="display:none;">
								<input type="text" id="reqDtFrom_S" class="input_calendar" onkeyup="dateMask(this);" data-search="reqDtFrom" autocomplete="off">
								<span>~</span>
								<input type="text" id="reqDtTo_S" class="input_calendar" onkeyup="dateMask(this);" data-search="reqDtTo" autocomplete="off">
							</div>
						</td>
						<th id="thOrdrsNo">수주번호</th>
						<td id="tdOrdrsNo">
							<div class="search_form">
								<input type="text" id="ordrsNo_S" name="ordrsNo_S" data-search="ordrsNo"
									onkeyup="event.keyCode == 13 ? opendOrdrsSearch($('#ordrsNo_S').val(), $('#coCd_S').val()) : ''">
								<a onclick="opendOrdrsSearch($('#ordrsNo_S').val(), $('#coCd_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<td></td>
					</tr>
					<tr>
						<th>통합검색</th>
						<td>
							<input type="text" id="dataSearch_S" name="dataSearch_S" data-search="dataSearch" onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? gridView.setData(0) : ''; ">
						</td>
						<th>담당자</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="mngId_S" name="mngId_S" data-search="mngId">
								<input type="text" id="mngIdNm_S" name="mngIdNm_S" data-search="mngIdNm"
									onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? mngId_S.value='' : event.keyCode == 13 ? gridView.setData(0) : '' ">
								<a onclick="openUserSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th id="thClnt" class="">고객사</th>
						<td id="tdClnt">
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm"
									onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th id="thClntPjt">고객사PJT</th>
						<td id="tdClntPjt">
							<select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt" onchange="opendOrdrsSearch($('#clntPjt_S option:selected').text(),$('#coCd_S').val());">
								<option value="">전체</option>
							</select>
						</td>
					</tr>
				</table>
				<form id="mainForm" onSubmit="return false;">
					<input type="hidden" id="deptId" name="deptId">
					<input type="hidden" id="pgmId" name="pgmId" value="PM2001M01">
				</form>
			</div>
		</div>
		<div class="contents no_bg">
			<div class="contents_tit">
				<span style="height: 30px; line-height: 30px;font-size: 15px;margin-left: 15px">회의록 리스트</span>
				<div class="add_btn_small pdl10">
					<a onclick="insertAg();" id="addRow" style="width: 80px; height: 30px; line-height: 28px;">안건 추가</a>
					<a onclick="deleteAg();" id="deleteRow" style="width: 80px; height: 30px; line-height: 28px;">안건 삭제</a>
					<a onclick="moveAgenda('up');" style="width: 80px; height: 30px; line-height: 28px;">위로</a>
					<a onclick="moveAgenda('down');" style="width: 80px; height: 30px; line-height: 28px;">아래로</a>
					<a onclick="addDateColumn();" style="width: 80px; height: 30px; line-height: 28px;">날짜 추가</a>
					<a onclick="deleteDateColumn();" style="width: 80px; height: 30px; line-height: 28px;">날짜 삭제</a>
					<!-- <a onclick="setReport();" style="height: 30px; line-height: 28px; width: 100px;"><i class="fas fa-print"></i> 회의록출력</a> -->
					<a onclick="jsonToExcel(gridView);" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
				</div>
			</div>
		</div>

		<div class="contents">
			<!-- 콘텐츠 타이틀 -->
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="agenda-grid" data-ax5grid-config="{}" style="width: 100%; height: 790px;"></div>
		</div>
	</div>
	<input type="file" id="fileInput" multiple style="display:none" />
	<input type="text" id="colDatePicker" style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0;" />
</body>

</html>
<script type="text/javascript">

	let fileRowInserted = false;
	let currentFileRow = null;
	let currentFileColumn = null;
	var agFileArr = [];
	var deleteFileArr = [];
	let lastEditBackup = ""; // 마지막 편집 전 값 백업
	let uniqueFileTrgtKey = ""; // 고유 파일대상키

	// 날짜 컬럼 관리
	let dateColSeq = 0;
	let currentDateColKey = null;
	const dateColMap = {};

	function getAgendaVerForCell(row, colKey) {
		const byCol = row && row.agendaVerByCol ? row.agendaVerByCol[colKey] : null;
		const raw = (byCol != null) ? byCol : (row ? row.agendaVer : 0);
		const ver = Number(raw || 0);
		return ver > 0 ? ver : 1;
	}

	// 업무구분이 프로젝트인경우 salesCd, 수주번호, 고객사PJT 중 하나는 반드시 입력되어야 함
	function hasProjectSearchKey() {
		const salesCd = String($('#salesCd_S').val() || '').trim();
		const ordrsNo = String($('#ordrsNo_S').val() || '').trim();
		const clntPjt = String($('#clntPjt_S').val() || '').trim();
		return !!(salesCd || ordrsNo || clntPjt);
	}

	// 완료 여부 체크
	function isAgendaCompleted(row) {
		const v = String((row && row.mnStatus) || '').trim();
		return v === 'Y' || v === '완료';
	}

	// 진행상태 코드
	const mnStatusCode = [
		{'CD' : '', 'NM' : ''},
		{'CD' : 'N', 'NM' : '진행'},
		{'CD' : 'Y', 'NM' : '완료'}
	];

	// =========================
	// 통합 셀 formatter (내용 + 참석자 + 파일)
	// =========================
	function combinedCellFormatter() {
		const colKey = this.key;
		const item = this.item;
		const content = (item[colKey] == null) ? '' : String(item[colKey]);
		const normalizedContent = content.replace(/^[\r\n]+/, '').replace(/\r\n/g, '\n');
		const status = String((item && item.mnStatus) || '').trim();
		const statusUpper = status.toUpperCase();
		const isProgress = (statusUpper === "N" || status === "진행");
		const color = isProgress ? " color:#ff6161;" : "";

		return `<div class="cell-container">
			<div class="cell-content" style="${color}">${normalizedContent.replace(/\n/g, '<br>')}</div>
		</div>`;
	}

	function detailCellFormatter() {
		const colKey = this.key;
		const item = this.item;
		const agendaNo = item.agendaNo || '';
		const agendaVer = getAgendaVerForCell(item, colKey);

		const attends = (item.attendByColumn && item.attendByColumn[colKey]) || [];
		const maxPerRow = 3;

		let attendListHtml = '';
		if (attends.length) {
			let rows = [];
			for (let i = 0; i < attends.length; i += maxPerRow) {
				const rowItems = attends.slice(i, i + maxPerRow);
				const rowHtml = rowItems.map((u, idx) => {
					const realIdx = i + idx;
					return `<div class="attend-item ${u.toRemove ? 'to-remove' : ''}" data-idx="${realIdx}" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}">${u.name}</div>`;
				}).join('');
				rows.push(`<div class="attend-row">${rowHtml}</div>`);
			}
			attendListHtml = `<div class="attend-list">${rows.join('')}</div>`;
		}

		const attendBtnHtml = `
			<div class="attend-btns">
				<a class="attend-add-btn" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}">+</a>
				<a class="attend-remove-btn" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}">-</a>
			</div>`;

		const files = (item.filesByColumn && item.filesByColumn[colKey]) || [];
		const fileListHtml = files.length ?
			`<ul class="file-list">
				${files.map((f, i) =>
					`<li data-idx="${i}" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}">
						<button class="file-remove" data-idx="${i}" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}">X</button>
						<span class="file-preview" data-idx="${i}" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}" data-filekey="${f.fileKey}" data-filename="${f.name}" style="text-decoration:underline; cursor:pointer; margin-left:4px;">${f.name}</span>
					</li>`
				).join('')}
			</ul>` : '';

		const fileBtnHtml = `
			<div class="file-add-wrap">
				<button class="file-add-btn" data-col="${colKey}" data-agenda="${agendaNo}" data-ver="${agendaVer}">파일추가</button>
			</div>`;

		return `<div class="cell-container">
			<div class="cell-bottom">
				<div class="cell-attend">
					<div class="section-label">참석자</div>
					${attendListHtml}
					${attendBtnHtml}
				</div>
				<div class="cell-file">
					<div class="section-label">첨부파일</div>
					${fileListHtml}
					${fileBtnHtml}
				</div>
			</div>
		</div>`;
	}

	function buildDateColumnConfig(colKey, dateStr) {
		dateColMap[colKey] = dateStr;
		return {
			key: colKey,
			label: `<span class="date-col-label" data-colkey="${colKey}" style="cursor:pointer; text-decoration:underline;">${dateStr}</span>`,
			align: "left",
			width: 350,
			editor: {
				type: "textarea",
				disabled: function () {
					// 편집은 내용 영역만 가능 (참석자/파일은 버튼으로 관리)
					return this.item && this.item.rowType === 'DETAIL';
				}
			},
			formatter: function() {
				if (this.item.rowType === 'DETAIL') {
					return detailCellFormatter.call(this);
				}
				return combinedCellFormatter.call(this);
			}
		};
	}

	function sortDateColumns(grid) {
		if (!grid || !grid.config || !Array.isArray(grid.config.columns)) return;

		const dateCols = grid.config.columns.filter(c => c && c.key && c.key.indexOf('dateCol') === 0);
		if (dateCols.length === 0) return;

		// remove existing date columns
		for (let i = grid.config.columns.length - 1; i >= 0; i--) {
			const c = grid.config.columns[i];
			if (c && c.key && c.key.indexOf('dateCol') === 0) {
				grid.removeColumn(i);
			}
		}

		// re-add sorted by date
		dateCols.sort((a, b) => {
			const da = dateColMap[a.key] || '';
			const db = dateColMap[b.key] || '';
			return da.localeCompare(db);
		});

		const statusIdx = grid.config.columns.findIndex(c => c && c.key === 'mnStatus');
		const insertIdx = (statusIdx === -1) ? grid.config.columns.length : statusIdx;
		dateCols.forEach((c, idx) => {
			grid.addColumn(buildDateColumnConfig(c.key, dateColMap[c.key] || ''), insertIdx + idx);
		});
	}


	var gridView = {
		initView: function(){
			this.target = new ax5.ui.grid();

			// 기본 날짜 컬럼 1개 생성(오늘)
			if (dateColSeq === 0) {
				dateColSeq = 1;
				const today = moment().format('YYYY-MM-DD');
				buildDateColumnConfig('dateCol1', today);
			}

			this.target.setConfig({
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				showLineNumber: false,
				lineNumberColumnWidth: 30,
				target: $('[data-ax5grid="agenda-grid"]'),
				header: {
					align: "center",
					selector: false
				},
				body: {
					mergeCells: ["salesCd", "clntNmPjt", "ordrsNo", "agendaTitle", "mnStatus"],
					columnHeight: 50,
					mergeCellsAllowEditor: true,
					onClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
						if (this.column && this.column.key && this.column.key.indexOf('dateCol') === 0) {
							currentDateColKey = this.column.key;
						}
					},
					onDBLClick: function () {
						if (isAgendaCompleted(this.item)) {
							customAlert("완료된 안건은 수정할 수 없습니다.");
							gridView.setData(0);
							return false;
						}
						// 클릭 시점(편집 전)에 백업
						lastEditBackup = { dindex: this.dindex, key: this.column.key, value: this.item[this.column.key] };
						this.self.clearSelect();
						this.self.select(this.dindex);
					},
					onDataChanged: function(){
						const prev = (this.before !== undefined)
						? this.before
						: (lastEditBackup && lastEditBackup.key === this.key && lastEditBackup.dindex === this.dindex)
							? lastEditBackup.value
							: undefined;

						if (prev !== undefined && prev === this.value) {
						lastEditBackup = null;
						return false;
						}

					if (this.key.startsWith('dateCol')) {
						if (isAgendaCompleted(this.item)) {
							customAlert("완료된 안건은 수정할 수 없습니다.");
							this.self.setValue(this.dindex, this.key, prev);
							lastEditBackup = null;
							// gridView.target.repaint(true);
							gridView.setData(0);
							return false;
						}
						if (!this.item || !String(this.item.agendaTitle || '').trim()) {
							customAlert("안건 제목을 먼저 입력해주세요.");
							this.self.setValue(this.dindex, this.key, prev);
								lastEditBackup = null;
								gridView.target.repaint(true);
								return false;
							}
							if ($("#bizDiv_S").val() == "AGENDA01") {
								if (!hasProjectSearchKey()) {
									customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
									this.self.setValue(this.dindex, this.key, prev);
									lastEditBackup = null;
									gridView.target.repaint(true);
									return false;
								}
							}
							if (!dateColMap[this.key]) {
								customAlert("날짜 컬럼이 유효하지 않습니다.");
								this.self.setValue(this.dindex, this.key, prev);
								lastEditBackup = null;
								gridView.target.repaint(true);
								return false;
							}
							insert_update_agenda(this.item, this.key, this.value, this.dindex, prev);
							this.item[this.key] = this.value;
					} else if (this.key == 'agendaTitle') {
						if (isAgendaCompleted(this.item)) {
							customAlert("완료된 안건은 수정할 수 없습니다.");
							this.self.setValue(this.dindex, this.key, prev);
							lastEditBackup = null;
							// gridView.target.repaint(true);
							gridView.setData(0);
							return false;
						}
						insert_update_agenda_title(this.value, this.item, this.dindex, prev);
						this.item[this.key] = this.value;
						} else if (this.key == 'mnStatus') {
							update_agenda_status(this.value, this.item, this.dindex, prev);
							this.item[this.key] = this.value;
						}

						gridView.target.repaint(true);
						lastEditBackup = null;
					}
									},
				page: {
					navigationItemCount: 9,
					height: 30,
					display: false,
					firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange: function () {
						gridView.setData(this.page.selectPage);
					}
				},
				columns: [
							{key: "fileTrgtKey", 	label: "파일KEY", align: "center", width: 220, hidden: true},
							{key: "agendaNo", 		label: "안건번호", align: "center", width: 220, hidden: true},
							{key: "agendaVer", 		label: "안건버전", align: "center", width: 150, hidden: true},
							{key: "ordrsNo", 		label: "수주번호", align: "center", width: 70, hidden: true},
							{key: "clntPjt", 		label: "고객사PJT", align: "center", width: 110, hidden: true},
							{key: "clntPjtNm", 		label: "PJT", align: "center", width: 70, hidden: true},
							{ key: "clntNmPjt", 	label: "고객사/PJT", align: "center", width: 150,
									formatter: function () {return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : ''; }
							},
							{key: "salesCd", 		label: "SALES CODE", align: "center", width: 110},
							{key: "agendaTitle", 	label: "안건", align: "center", width: 150,
								editor: {
									type: "textarea",
									disabled: function () { return this.item && this.item.rowType === 'DETAIL';}
								},
								formatter: function () {return '<span style="display:block; height:100%; white-space:pre;' + ((String((this.item && this.item.mnStatus) || '').trim().toUpperCase() === "N" || String((this.item && this.item.mnStatus) || '').trim() === "진행") ? ' color:#ff6161;' : '') + '">' + ((this.value == null) ? '' : String(this.value)) + '</span>';}
							},
							buildDateColumnConfig('dateCol1', dateColMap['dateCol1']),
							{key: "mnStatus", 		label: "진행여부", align: "center", width: 100,
								editor: {
									type: "select",
									disabled: function () {return this.item && this.item.rowType === 'DETAIL';},
									config: {columnKeys: { optionValue: "CD", optionText: "NM" },options: mnStatusCode}
								},
								formatter: function () {return (mnStatusCode.find(x => String(x.CD) === String((this.value == null) ? '' : this.value)) || {}).NM || '';}
							}
						]
			});

			this.target.setData({ list: [], page: { totalElements: 0 } });

			return this;
		},
		setData: function(_pageNo) {
			uniqueFileTrgtKey = "";
			if ($("#bizDiv_S").val() == "") {
				customAlert("업무구분을 선택해주세요.");
				return false;
			}

			var targetObj = this.target;
			var formData = {};
			formData["userId"] = jwt.userId;

			// 프로젝트: 기존 검색조건 사용 / 일반회의: 담당자로 검색
			if ($("#bizDiv_S").val() == "AGENDA02") {
				formData["coCd"] = $("#coCd_S").val();
				formData["bizDiv"] = $("#bizDiv_S").val();
				formData["mngId"] = $("#mngId_S").val();
				formData["dataSearch"] = $("#dataSearch_S").val();
				formData["reqDtFrom"] = $("#reqDtFrom_S").val();
				formData["reqDtTo"] = $("#reqDtTo_S").val();
			} else {
				// 프로젝트: 조회는 고객사/고객사PJT로도 허용, 수정은 별도 체크
				if (!hasProjectSearchKey()) {
					targetObj.setData({ list: [], page: { totalElements: 0 } });
					return false;
				}
				// 프로젝트: 기존대로 모든 검색조건 사용
				$.each($('#main_area [data-search]'), function(idx, elem){
					formData[$(elem).data("search")] = $(elem).val();
				});
			}

			postAjax("/user/pm/pm20/selectAgendaList", formData, null, function(data) {
				try {
					if (data.result == null || data.result.length == 0) {
						// 기존 dateCol 컬럼 전부 제거
						for (let i = targetObj.config.columns.length - 1; i >= 0; i--) {
							const c = targetObj.config.columns[i];
							if (c && c.key && c.key.indexOf('dateCol') === 0) {
								targetObj.removeColumn(i);
							}
						}

						// dateColMap / seq 초기화
						Object.keys(dateColMap).forEach(k => delete dateColMap[k]);
						dateColSeq = 1;
						currentDateColKey = null;

						// 오늘 날짜 컬럼 하나만 추가
						const today = moment().format('YYYY-MM-DD');
						const statusIdx = targetObj.config.columns.findIndex(c => c && c.key === 'mnStatus');
						const insertIdx = (statusIdx === -1) ? targetObj.config.columns.length : statusIdx;
						targetObj.addColumn(buildDateColumnConfig('dateCol1', today), insertIdx);

						targetObj.setData({ list: [], page: { totalElements: 0 } });
						return false;
					}
					var rows = data.result.filter(r => !r.rowType || r.rowType !== 'FILE'); // 안건 데이터만 필터링
					uniqueFileTrgtKey = rows.length > 0 ? rows[0].fileTrgtKey : '';

					// 1) 날짜 목록(컬럼 라벨)
					let dates = [...new Set(rows.map(r => r.agendaDate).filter(Boolean))].sort();
					if (dates.length === 0) {
						dates = [moment().format('YYYY-MM-DD')];
					}

					// 2) 기존 dateCol 컬럼 전부 제거 (targetObj.config.columns 기준)
					for (let i = targetObj.config.columns.length - 1; i >= 0; i--) {
						const c = targetObj.config.columns[i];
						if (c && c.key && c.key.indexOf('dateCol') === 0) {
							targetObj.removeColumn(i);
						}
					}

					// 3) dateColMap / seq 초기화
					Object.keys(dateColMap).forEach(k => delete dateColMap[k]);
					dateColSeq = 0;
					currentDateColKey = null;

					// 4) 날짜 수만큼 agendaDate..n 컬럼 생성
					const dateKeyMap = new Map(); // 'YYYY-MM-DD' -> 'dateColN'

					dates.forEach((d, idx) => {
						const key = "dateCol" + (idx + 1);
						dateColSeq = idx + 1;
						dateKeyMap.set(d, key);

						const statusIdx = targetObj.config.columns.findIndex(c => c && c.key === 'mnStatus');
						const insertIdx = (statusIdx === -1) ? targetObj.config.columns.length : statusIdx;

						targetObj.addColumn(buildDateColumnConfig(key, d), insertIdx);
					});

					// 파일첨부: data.result에서 rowType='FILE' 찾기
					const fileEntry = (data.result || []).find(r => r && r.rowType === 'FILE' && typeof r.files === 'string');
					const parsedFiles = fileEntry ? JSON.parse(fileEntry.files) : [];

					// 참석자: d02List 또는 attendData에서 가져오기
					let parsedAttends = [];
					if (Array.isArray(data.d02List)) {
						parsedAttends = data.d02List;
					}

					// 5) 안건별 가로형 row 만들기 (참석자/파일 포함)
					const rowMap = new Map();
					const norm = function (v) {
						return (v === null || v === undefined) ? '' : String(v).trim();
					};

					rows.forEach(r => {
						const id = (r.fileTrgtKey || '') + '|' + (r.agendaNo || '');

						if (!rowMap.has(id)) {
							const baseRow = {
								rowType: 'AGENDA',
								fileTrgtKey: r.fileTrgtKey || '',
								agendaNo: r.agendaNo || '',
								agendaVer: 0,
								agendaVerByCol: {},
								agendaTitle: r.agendaTitle || '',
								mnStatus: r.agendaStatus || 'N',
								salesCd: norm(r.salesCd),
								clntPjt: r.clntPjt || '',
								clntPjtNm: r.clntPjtNm || '',
								clntNmPjt: r.clntNmPjt || '',
								ordrsNo: norm(r.ordrsNo),
								attendByColumn: {},
								filesByColumn: {}
							};

							dates.forEach(d => {
								const colKey = dateKeyMap.get(d);
								baseRow[colKey] = '';
								baseRow.attendByColumn[colKey] = [];
								baseRow.filesByColumn[colKey] = [];
							});

							rowMap.set(id, baseRow);
						}

						const colKey = dateKeyMap.get(r.agendaDate);
						if (colKey) {
							const prev = rowMap.get(id)[colKey];
							const txt  = r.agendaCnts || '';
							rowMap.get(id)[colKey] = prev ? (prev + "\n" + txt) : txt;

							const v = Number(r.agendaVer || 0);
							rowMap.get(id).agendaVerByCol[colKey] = v;
							if (v > Number(rowMap.get(id).agendaVer || 0)) {
								rowMap.get(id).agendaVer = v;
							}
						}
					});

					// 참석자를 각 안건에 매핑 (안건별+버전별+날짜별)
					parsedAttends.forEach(a => {
						const colKey = dateKeyMap.get(a.agendaDate);
						if (!colKey) return;

						const agendaNo = a.agendaNo || '';
						const agendaVer = a.agendaVer || '';
						// 해당 안건 찾기
						for (const [id, row] of rowMap) {
							// 안건번호가 있으면 매칭
							if (agendaNo && row.agendaNo !== agendaNo) continue;
							// 버전이 있으면 매칭 (셀별 버전과 비교)
							if (agendaVer && row.agendaVerByCol && row.agendaVerByCol[colKey]) {
								if (String(row.agendaVerByCol[colKey]) !== String(agendaVer)) continue;
							}

							if (!row.attendByColumn[colKey]) {
								row.attendByColumn[colKey] = [];
							}
							// 중복 체크
							if (!row.attendByColumn[colKey].some(u => u.id === (a.attendId || a.id))) {
								row.attendByColumn[colKey].push({
									id: a.attendId || a.id,
									name: a.attendNm || a.name,
									toRemove: false
								});
							}
						}
					});

					// 파일을 각 안건에 매핑 (안건별+날짜별)
					parsedFiles.forEach(f => {
						const agendaDate = f.agendaDate || f.agendadate;
						const colKey = dateKeyMap.get(agendaDate);
						if (!colKey) return;

						const agendaNo = f.agendaNo || f.agendano || '';
						// 해당 안건 찾기
						for (const [id, row] of rowMap) {
							// 안건번호가 있으면 매칭
							if (agendaNo) {
								if (String(row.agendaNo) !== String(agendaNo)) continue;
							}

							if (!row.filesByColumn[colKey]) {
								row.filesByColumn[colKey] = [];
							}
							row.filesByColumn[colKey].push({
								name: f.fileName,
								fileKey: f.fileKey,
								fileType: f.fileType
							});
							// 안건번호가 있으면 해당 안건에만 추가하고 break
							if (agendaNo) break;
						}
					});

					const finalList = [];
					for (const [id, row] of rowMap) {
						finalList.push(row);
						finalList.push({
							rowType: 'DETAIL',
							fileTrgtKey: row.fileTrgtKey || '',
							agendaNo: row.agendaNo || '',
							agendaVer: row.agendaVer || 0,
							agendaVerByCol: row.agendaVerByCol || {},
							agendaTitle: row.agendaTitle || '',
							mnStatus: row.mnStatus || '',
							salesCd: norm(row.salesCd),  // 병합을 위해 같은 값 복사
							clntPjt: row.clntPjt || '',
							clntPjtNm: row.clntPjtNm || '',  // 병합을 위해 같은 값 복사
							clntNmPjt: row.clntNmPjt || '',  // 병합을 위해 같은 값 복사
							ordrsNo: norm(row.ordrsNo),  // 병합을 위해 같은 값 복사
							attendByColumn: row.attendByColumn || {},
							filesByColumn: row.filesByColumn || {}
						});
					}

					targetObj.setData({
						list: finalList,
						page: { totalElements: finalList.length }
					});
					sortDateColumns(targetObj);
					targetObj.align();
					targetObj.repaint();
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
				} finally {
					syncRowHeights();
				}
			});
		}
	};

	$(document).ready(function() {
		//초기설정들
		mainDefaultLoad("공통업무", "회의록");
		setCommonSelect($("#main_area select[data-kind]"));

		// 화면 크기 조절
		$("#top_area").hide();
		$('#head_area').toggleClass('off');
		$('#main_area').toggleClass('on');

		$('#thAgendaDate, #tdAgendaDate').hide(); // 날짜 필드 초기 숨김

		$("#deptId").val(jwt.deptId);
		$("#userId").val(jwt.userId);

		// 접속자 회사 set
		$("#coCd_S").val(jwt.mngCoCd);

        const storedParams = localStorage.getItem("PM2001M01_PARAMS");
        if(storedParams){
            try {
                const params = JSON.parse(storedParams);
                if(params.salesCd) $('#salesCd_S').val(params.salesCd);
                if(params.ordrsNo) $('#ordrsNo_S').val(params.ordrsNo);
                if(params.coCd) {
                    $('#coCd_S').val(params.coCd);
                    // Trigger change if needed, or just set value
                }
                
                // If enough data is present, auto-search
                if(params.salesCd || params.ordrsNo){
                    // Ensure grid is initialized before calling setData
                    setTimeout(function(){
                         if(gridView && gridView.target) {
                             gridView.setData(0);
                         }
                    }, 500); 
                }
            } catch(e) {
                console.error("Param load error", e);
            }
            // Clear used params? Maybe keep for refresh support.
            // localStorage.removeItem("PM2001M01_PARAMS"); 
        }
		// 시작일 (현재날짜의 월 첫일)
		$('#reqDtFrom_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", moment(new Date()).startOf("month").toDate())
		.on("changeDate", function(){
			if($('#reqDtFrom_S').val() > $('#reqDtTo_S').val()){
				customAlert("날짜를 확인해주세요");
				$('#reqDtTo_S').datepicker("setDate", new Date($('#reqDtFrom_S').val()));
			}
		});

		// 종료일 (현재날짜의 월 말일)
		$('#reqDtTo_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", moment(new Date()).endOf("month").toDate())
		.on("changeDate", function(){
			if($('#reqDtFrom_S').val() > $('#reqDtTo_S').val()){
				customAlert("날짜를 확인해주세요");
				$('#reqDtFrom_S').datepicker("setDate", new Date($('#reqDtTo_S').val()));
			}
		});

		gridView.initView(); // 초기 데이터 로드 제거, 검색 전까지 빈 상태

		$('#bizDiv_S').on('change', function () {
			const bizDiv = $("#bizDiv_S").val();

			if (bizDiv == "AGENDA02") {
				// 일반회의: 프로젝트 관련 검색필드 초기화
				$("#salesCd_S").val("");
				$("#ordrsNo_S").val("");
				$("#ordrsClntCd_S").val("");
				$("#ordrsClntNm_S").val("");
				$("#clntPjt_S").val("");
				$("#mngId_S").val(jwt.userId);
				$("#mngIdNm_S").val(jwt.userNm || "");
				// 일반회의: 프로젝트 관련 필드 숨김
				$('#thSalesCd, #tdSalesCd, #thOrdrsNo, #tdOrdrsNo, #thClnt, #tdClnt, #thClntPjt, #tdClntPjt').hide();
				$('#thAgendaDate, #tdAgendaDate').show();
			} else {
				// 프로젝트: 담당자 필드 초기화
				$("#mngId_S").val("");
				$("#mngIdNm_S").val("");
				// 프로젝트: 프로젝트 관련 필드 표시
				$('#thSalesCd, #tdSalesCd, #thOrdrsNo, #tdOrdrsNo, #thClnt, #tdClnt, #thClntPjt, #tdClntPjt').show();
				$('#thAgendaDate, #tdAgendaDate').hide();
			}

			(function () {
				if (!gridView || !gridView.target) return;
				const keys = ["salesCd", "clntNmPjt"];
				const isProject = (bizDiv == "AGENDA01");
				const cols = gridView.target.config.columns || [];
				cols.forEach(c => {
					if (c && keys.includes(c.key)) {
						c.hidden = !isProject;
					}
				});
				if (Array.isArray(gridView.target.colGroup)) {
					gridView.target.colGroup.forEach(c => {
						if (c && keys.includes(c.key)) {
							c.hidden = !isProject;
						}
					});
				}
				gridView.target.align();
				gridView.target.repaint();
			})();

			// 그리드 재조회
			gridView.setData(0);
		});

		// 초기 로드 시 업무구분에 따른 필드 표시/숨김 설정
		(function() {
			const bizDiv = $("#bizDiv_S").val();
			if (bizDiv == "AGENDA02") {
				$('#thSalesCd, #tdSalesCd, #thOrdrsNo, #tdOrdrsNo, #thClnt, #tdClnt, #thClntPjt, #tdClntPjt').hide();
				$('#thAgendaDate, #tdAgendaDate').show();
			} else {
				$('#thSalesCd, #tdSalesCd, #thOrdrsNo, #tdOrdrsNo, #thClnt, #tdClnt, #thClntPjt, #tdClntPjt').show();
				$('#thAgendaDate, #tdAgendaDate').hide();
			}
		})();

		// 사이드바 토글 시 재조회 대신 기존 데이터 리페인트/리사이즈만
		$('.off_btn').on('click', function(e){
			// showSize();
			if (gridView.target) {
				gridView.target.repaint();
			}
		});

		// =========================
		// 날짜 컬럼 헤더 클릭 시 datepicker 호출
		// =========================
		$('[data-ax5grid="agenda-grid"]').on('click', '.date-col-label', function(e) {
			e.preventDefault();
			e.stopPropagation();

			const colKey = $(this).data('colkey');
			if (!colKey) return;

			currentDateColKey = colKey;

			const curDate = dateColMap[colKey] || moment().format('YYYY-MM-DD');

			$('#colDatePicker')
				.css({
					left: (e.pageX || 0) + 'px',
					top:  (e.pageY || 0) + 'px'
				})
				.each(function () {
					try { $(this).datepicker('destroy'); } catch (e) {}
				})
				.datepicker({
					format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true
				})
				.datepicker('setDate', curDate)
				.datepicker('show')
				.off('changeDate')
				.on('changeDate', function(ev) {
					const selDate = moment(ev.date).format('YYYY-MM-DD');
					const prevDate = dateColMap[currentDateColKey] || moment().format('YYYY-MM-DD');

					const grid = gridView.target;
					const hasCompleted = (grid && Array.isArray(grid.list)) ? grid.list.some(r => r && r.rowType === 'AGENDA' && isAgendaCompleted(r)) : false;
					if (hasCompleted) {
						customAlert("완료된 안건이 있어 날짜 변경이 불가합니다.");
						return;
					}

					let idx = -1;
					if (grid && grid.config && Array.isArray(grid.config.columns)) {
						idx = grid.config.columns.findIndex(c => c && c.key === currentDateColKey);
					}
					if (idx < 0 && grid && Array.isArray(grid.colGroup)) {
						idx = grid.colGroup.findIndex(c => c && c.key === currentDateColKey);
					}

					update_agenda_date(prevDate, selDate, function(success) {
						if (!success) {
							return;
						}
						dateColMap[currentDateColKey] = selDate;
						if (idx > -1) {
							const newCol = buildDateColumnConfig(currentDateColKey, selDate);
							grid.removeColumn(idx);
							grid.addColumn(newCol, idx);
						} else {
							$('[data-ax5grid="agenda-grid"] .date-col-label[data-colkey="' + currentDateColKey + '"]').text(selDate);
						}
						sortDateColumns(grid);
						grid.repaint();
					});
				});
		});

		// =========================
		// 파일첨부 프론트 전용 이벤트
		// =========================
		$('#fileInput').on('change', function(){
			const grid = gridView.target;
			if (!currentFileRow || !currentFileColumn) return;

			Array.from(this.files).forEach(file => {
				// 서버 전송용 배열에 넣고
				agFileArr.push({ fileKey: 0, file, row: currentFileRow, column: currentFileColumn, agendaNo: currentFileRow.agendaNo });
				// 화면용 컬럼별 배열에 추가
				currentFileRow.filesByColumn = currentFileRow.filesByColumn || {};
				currentFileRow.filesByColumn[currentFileColumn] = currentFileRow.filesByColumn[currentFileColumn] || [];
				currentFileRow.filesByColumn[currentFileColumn].push({ name: file.name, fileKey: 0 });
			});
			grid.repaint();

			agUploadFile(currentFileRow.agendaNo);
			$(this).val('');
			currentFileRow = null;
			currentFileColumn = null;
		});

		// 파일 추가 (안건별)
		$('[data-ax5grid="agenda-grid"]').on('click', '.file-add-btn', function(e) {
			e.preventDefault();
			e.stopPropagation();
			if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
				customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				return;
			}

			const colKey = $(this).data('col');
			const agendaNo = $(this).data('agenda');
			const grid = gridView.target;

			// 해당 안건 로우 찾기
			const agendaRow = grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo == agendaNo);
			if (!agendaRow) return;
			if (isAgendaCompleted(agendaRow)) {
				customAlert("완료된 안건은 수정할 수 없습니다.");
				gridView.setData(0);
				return;
			}

			// 해당 셀에 내용이 없으면 alert
			const content = agendaRow[colKey] || '';
			if (!content.trim()) {
				alert('안건을 작성해주세요.');
				return;
			}

			currentFileRow = agendaRow;
			currentFileColumn = colKey;

			$('#fileInput').click();
		});

		// 파일 삭제 (안건별)
		$('[data-ax5grid="agenda-grid"]').on('click', '.file-remove', function(e) {
			e.preventDefault();
			e.stopPropagation();
			if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
				customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				return;
			}

			const idx = Number($(this).data('idx'));
			const colKey = $(this).data('col');
			const agendaNo = $(this).data('agenda');

			const grid = gridView.target;
			const agendaRow = grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo == agendaNo);
			if (!agendaRow || !agendaRow.filesByColumn || !agendaRow.filesByColumn[colKey]) return;
			if (isAgendaCompleted(agendaRow)) {
				customAlert("완료된 안건은 수정할 수 없습니다.");
				gridView.setData(0);
				return;
			}

			const removed = agendaRow.filesByColumn[colKey].splice(idx, 1)[0];
			if (removed && removed.fileKey) {
				deleteFileArr.push({ fileKey: removed.fileKey });
			}

			currentFileRow = agendaRow;
			currentFileColumn = colKey;

			grid.repaint();
			agUploadFile(agendaNo);
		});

		// 파일명 클릭 시 미리보기 (안건별)
		$('[data-ax5grid="agenda-grid"]').on('click', '.file-preview', function(e) {
			e.preventDefault();
			e.stopPropagation();
			const fileKey = $(this).data('filekey');
			const fileName = $(this).data('filename');
			const colKey = $(this).data('col');
			const agendaNo = $(this).data('agenda');
			const grid = gridView.target;
			const agendaRow = grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo == agendaNo);
			if (!agendaRow || !agendaRow.filesByColumn || !agendaRow.filesByColumn[colKey]) return;
			const allFiles = agendaRow.filesByColumn[colKey];
			const imageList = allFiles.map(f => ({
				fileKey: Number(f.fileKey),
				fileName: f.name,
				coCd: $('#coCd_S').val()
			}));
			imageViewPopup($('#coCd_S').val(), fileKey, fileName, imageList);
		});

		// =========================
		// 참석자 프론트 전용 이벤트 (안건별)
		// =========================
		// 참석자 추가
		$('[data-ax5grid="agenda-grid"]').on('click', '.attend-add-btn', function(e) {
			e.preventDefault();
			e.stopPropagation();
			if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
				customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				return;
			}

			const colKey = $(this).data('col');
			const agendaNo = $(this).data('agenda');
			const grid = gridView.target;

			// 해당 안건 로우 찾기
			const agendaRow = grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo == agendaNo);
			if (!agendaRow) return;
			if (isAgendaCompleted(agendaRow)) {
				customAlert("완료된 안건은 수정할 수 없습니다.");
				gridView.setData(0);
				return;
			}

			currentAttendColumn = colKey;

			var paramObj = {
				"coCd"   : $('#coCd_S').val(),
				"userId" : "",
				"userNm" : "",
				"pm20Flag": "Y"
			};

			openModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function(tree, personNodes) {
				agendaRow.attendByColumn = agendaRow.attendByColumn || {};
				agendaRow.attendByColumn[colKey] = agendaRow.attendByColumn[colKey] || [];

				var addedCount = 0;
				var duplicateCount = 0;

				// 다중 선택 모드 (personNodes가 있는 경우)
				if (personNodes && personNodes.length > 0) {
					personNodes.forEach(function(node) {
						// 참석자 중복체크
						if (agendaRow.attendByColumn[colKey].some(u => u && u.id == node.id && !u.toRemove)) {
							duplicateCount++;
							return;
						}
						agendaRow.attendByColumn[colKey].push({
							id: node.id,
							name: node.text,
							toRemove: false
						});
						addedCount++;
					});
				} else {
					// 단일 선택 모드 (기존 로직)
					var checkedId = tree.get_checked()[0];
					if (!checkedId) return;

					var checkedNode = tree.get_node(checkedId);
					if (!checkedNode) return;

					// 참석자 중복체크
					if (agendaRow.attendByColumn[colKey].some(u => u && u.id == checkedNode.id && !u.toRemove)) {
						if (typeof customAlert === "function") customAlert("이미 추가된 참석자입니다.");
						return false;
					}

					agendaRow.attendByColumn[colKey].push({
						id: checkedNode.id,
						name: checkedNode.text,
						toRemove: false
					});
					addedCount++;
				}

				if (addedCount > 0) {
					grid.repaint();
					pm20_d02_update(agendaRow, colKey);
				}

				if (duplicateCount > 0 && addedCount > 0) {
					customAlert(addedCount + "명 추가, " + duplicateCount + "명 중복으로 제외되었습니다.");
				} else if (duplicateCount > 0 && addedCount == 0) {
					customAlert("선택된 사용자가 모두 이미 추가된 참석자입니다.");
				}
			});
		});

		// 참석자 삭제 모드 토글 (안건별)
		$('[data-ax5grid="agenda-grid"]').on('click', '.attend-remove-btn', function(e) {
			e.preventDefault();
			e.stopPropagation();
			if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
				customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				return;
			}

			const colKey = $(this).data('col');
			const agendaNo = $(this).data('agenda');
			const grid = gridView.target;

			const agendaRow = grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo == agendaNo);
			if (!agendaRow || !agendaRow.attendByColumn || !agendaRow.attendByColumn[colKey]) return;
			if (isAgendaCompleted(agendaRow)) {
				customAlert("완료된 안건은 수정할 수 없습니다.");
				gridView.setData(0);
				return;
			}

			const attends = agendaRow.attendByColumn[colKey];
			const hasToRemove = attends.some(u => u.toRemove);

			if (hasToRemove) {
				// 삭제 실행
				const removeIds = attends.filter(u => u.toRemove).map(u => u.id).filter(Boolean);
				if (!removeIds.length) {
					alert("삭제할 참석자를 선택하세요.");
					return;
				}
				const agendaDate = dateColMap[colKey];
				if (!agendaDate || !uniqueFileTrgtKey) {
					alert("날짜 정보가 없어 삭제할 수 없습니다.");
					return;
				}

				// 해당 셀의 버전 가져오기
				const agendaVer = (agendaRow.agendaVerByCol && agendaRow.agendaVerByCol[colKey]) || agendaRow.agendaVer || '1';

				var paramObj = {
					"fileTrgtKey"	: uniqueFileTrgtKey,
					"agendaNo"		: agendaNo,
					"agendaVer"		: String(agendaVer),
					"agendaDate"	: agendaDate,
					"attendIds"		: removeIds,
					"userId"		: jwt.userId,
					"pgmId"			: $('#pgmId').val()
				};

				postAjax('/user/pm/pm20/pm20_d02_delete_selected', paramObj, null, data => {
					if (data.resultCode == 200) {
						agendaRow.attendByColumn[colKey] = attends.filter(u => !u.toRemove);
						grid.repaint();
					} else {
						alert('참석자 삭제 실패: ' + data.resultMessage);
					}
				});
			} else {
				// 삭제 모드 활성화
				alert('삭제할 참석자를 클릭한 후 다시 - 버튼을 눌러주세요.');
				attends.forEach(u => u.toRemove = true);
				grid.repaint();
			}
		});

		// 참석자 아이템 클릭 (삭제 모드에서 선택, 안건별)
		$('[data-ax5grid="agenda-grid"]').on('click', '.attend-item', function(e) {
			e.preventDefault();
			e.stopPropagation();
			if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
				customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				return;
			}

			const idx = Number($(this).data('idx'));
			const colKey = $(this).data('col');
			const agendaNo = $(this).data('agenda');
			const grid = gridView.target;

			const agendaRow = grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo == agendaNo);
			if (!agendaRow || !agendaRow.attendByColumn || !agendaRow.attendByColumn[colKey]) return;
			if (isAgendaCompleted(agendaRow)) {
				customAlert("완료된 안건은 수정할 수 없습니다.");
				gridView.setData(0);
				return;
			}

			const attends = agendaRow.attendByColumn[colKey];
			if (attends[idx]) {
				attends[idx].toRemove = !attends[idx].toRemove;
				grid.repaint();
			}
		});

		$('#dataSearch_S, #reqDtFrom_S, #reqDtTo_S').on("change", function(){
			gridView.setData(0);
		});

		// $(window).on('resize', showSize);
		// $(function() { showSize(); });

		//권한체크
		// authChk();
	});

	// ax5grid 세팅 후 아래 함수 호출
	function syncRowHeights() {
		var $rows = $('[data-ax5grid="agenda-grid"]').find('[data-ax5grid-panel-scroll="body"] tr');
		var maxHeight = 50;
		var hasContentRow = false;
		$rows.each(function(){
			var $tr = $(this);
			var hasText = $.trim($tr.find('.cell-content').text()) !== '';
			var hasAttend = $tr.find('.attend-item').length > 0;
			var hasFile = $tr.find('.file-list li').length > 0;
			if (!(hasText || hasAttend || hasFile)) {
				return;
			}
			hasContentRow = true;
			var rowHeight = $tr.outerHeight();
			if(rowHeight > maxHeight) maxHeight = rowHeight;
		});
		if (!hasContentRow) {
			maxHeight = 50;
		}
		// grid에 적용
		var oldConfig = gridView.target.config.body || {};
		gridView.target.setConfig({
			body: $.extend({}, oldConfig, { columnHeight: maxHeight })
		});
		gridView.target.repaint();
	}


	// 참석자 리스트 불러오기 & 렌더링
	function select_p10_d02_List(list) {
		if (list.length > 0) {
			attendList = list.map(user => ({
				id:       user.id,
				name:     user.name,
				title:    user.title,
				reasonCd: user.reasonCd
			}));
		} else {
			// 기본 참여자 전부를 reasonCd: 'Y' 로 설정
			attendList = DEFAULT_ATTEND_LIST.map(user => ({...user, reasonCd: 'Y'}));
		}

		// 고정 멤버 순서대로 정렬
		reorderAttendList();

		// 렌더링
		renderAttendList();
	
		// DB에서 Y인 것만 체크
		attendList.forEach(item => {
			if (item.reasonCd === 'Y') {
				$(`#attendCheckboxContainer .attend-item[data-id="${item.id}"] .attend-checkbox`)
				.prop('checked', true);
			}
		});
	}
	
	// 주제별 안건 등록 및 수정
	function insert_update_agenda_title(value, item, dindex, prevValue) {
		// 프로젝트일 때만 salesCd/ordrsNo/clntPjt 중 하나 필수
		if ($("#bizDiv_S").val() == "AGENDA01") {
			if (!hasProjectSearchKey()) {
				customAlert("SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				if (typeof dindex === 'number') {
					gridView.target.setValue(dindex, "agendaTitle", prevValue);
				}
				return false;
			}
		}
		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"agendaTitle"   : value,
			"userId"        : jwt.userId,
			"agendaStatus"  : item.mnStatus,
			"agendaNo"  	: item.agendaNo
        };

        postAjax('/user/pm/pm20/insert_update_agenda_title', paramObj, null, function(data) {
            if (data.resultCode === 200) {
                gridView.setData();
            } else {
                alert('수정 실패: ' + data.resultMessage);
				if (typeof dindex === 'number') {
					gridView.target.setValue(dindex, "agendaTitle", prevValue);
				}
            }
        });
    }

	// 진행여부 수정
	function update_agenda_status(value, item, dindex, prevValue) {
		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"agendaNo"  	: item.agendaNo,
			"agendaStatus"  : value,
			"userId"        : jwt.userId,
			"pgmId"			: $('#pgmId').val()
		};
		postAjax('/user/pm/pm20/pm20_update_status', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				const detail = gridView.target.list.find(r =>
					r && r.rowType === 'DETAIL' && String(r.agendaNo || '') === String(item.agendaNo || '')
				);
				if (detail) {
					detail.mnStatus = value;
				}
				gridView.target.repaint(true);
			} else {
				alert('수정 실패: ' + data.resultMessage);
				if (typeof dindex === 'number') {
					gridView.target.setValue(dindex, "mnStatus", prevValue);
				}
			}
		});
	}

	// 날짜 컬럼 변경 저장
	function update_agenda_date(oldDate, newDate, cb) {
		if (!uniqueFileTrgtKey || !oldDate || !newDate) {
			if (cb) cb(false);
			return;
		}
		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"oldDate"		: oldDate,
			"newDate"		: newDate,
			"userId"		: jwt.userId,
			"pgmId"			: $('#pgmId').val()
		};
		postAjax('/user/pm/pm20/pm20_update_agenda_date', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				if (cb) cb(true);
			} else {
				alert('날짜 변경 실패: ' + data.resultMessage);
				if (cb) cb(false);
			}
		});
	}

	// 안건 내용 등록 및 수정
	function insert_update_agenda(item, key, value, dindex, prevValue) {
		// 프로젝트일 때만 salesCd/ordrsNo/clntPjt 중 하나 필수 체크
		if ($("#bizDiv_S").val() == "AGENDA01") {
			if (!hasProjectSearchKey()) {
				customAlert("SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
				if (typeof dindex === 'number') {
					gridView.target.setValue(dindex, key, prevValue);
				}
				return false;
			}
		}
		// 셀별 버전이 있으면 그걸 쓰고, 없으면 로우 최대+1
		var cellVer = 0;
		if (item.agendaVerByCol && item.agendaVerByCol[key] != null) {
			cellVer = Number(item.agendaVerByCol[key] || 0);
		}
		var nextVer = cellVer > 0 ? cellVer : (Number(item.agendaVer || 0) + 1);
		
		// 헤더 정보 수집
		var paramObj = {
			"fileTrgtKey"	: item.fileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"agendaTitle"	: item.agendaTitle, // 안건
			"agendaDate"	: dateColMap[key], // 날짜
			"agendaCnts"	: value, // 내용
			"userId"		: jwt.userId,
			"agendaVer"   	: String(nextVer)
		};

		// 수정 시 fileTrgtKey와 agendaNo 포함
		if (item.fileTrgtKey) {
			paramObj.fileTrgtKey = item.fileTrgtKey;
		}
		if (item.agendaNo) {
			paramObj.agendaNo = item.agendaNo;
		}

		postAjax('/user/pm/pm20/insert_update_agenda', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				item.agendaVerByCol = item.agendaVerByCol || {};
				item.agendaVerByCol[key] = nextVer;
				item.agendaVer = Math.max(Number(item.agendaVer || 0), Number(nextVer || 0));
				gridView.setData();
			} else {
				alert('수정 실패: ' + data.resultMessage);
				if (typeof dindex === 'number') {
					gridView.target.setValue(dindex, key, prevValue);
				}
			}
		});

	}


	// SALES CODE 검색
	function wbsSalesCodeSearch() {
		var paramObj = {
			"coCd"     : $('#coCd_S').val(),
			"salesCd"  : $('#salesCd_S').val(),
			"searchValue" : $('#salesCd_S').val()
		};
		openModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 700, "SALES CODE 검색", paramObj, function (grid){
			var row = grid.target.getList("selected")[0];
			$('#salesCd_S').val(row.salesCd);
			$('#clntPjt_S').val(row.clntPjt);
			$('#ordrsClntCd_S').val(row.ordrsClntCd);
			$('#ordrsClntNm_S').val(row.ordrsClntNm);
			$('#ordrsNo_S').val(row.ordrsNo);

			gridView.setData(0);
		});
	}

	// 수주번호 검색
	function opendOrdrsSearch(inputValue, coCd) {
		var paramObj = {
			"searchValue" : inputValue,
			"coCd"        : coCd
		};

		openModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 800, "수주번호 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsNo_S').val(row.ordrsNo);
			$('#clntPjt_S').val(row.clntPjt);
			$('#ordrsClntCd_S').val(row.ordrsClntCd);
			$('#ordrsClntNm_S').val(row.clntNm);

			gridView.setData(0);
		});
	}

	// 담당자 검색
	function openUserSearch() {
		var paramObj = {
			"coCd"   : $('#coCd_S').val(),
			"userId" : $('#mngId_S').val(),
			"userNm" : $('#mngIdNm_S').val()
		};

		openModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function(tree) {
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId_S').val(checkedNode.id);
			$('#mngIdNm_S').val(checkedNode.text);

			gridView.setData(0);
		});
	}

	// 거래처 검색
	function opendClntSearch(inputValue) {
		var paramObj = {
			"searchValue" : inputValue,
			"clntDivCd"   : "CLNTDIV12"
		};
		openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsClntCd_S').val(row.clntCd);
			$('#ordrsClntNm_S').val(row.clntNm);

			gridView.setData(0);
		});
	}

	// 첨부파일 업로드 (안건별)
	function agUploadFile (agendaNo) {
		var formData = new FormData();

		formData.append("userId", jwt.userId);
		formData.append("coCd", $('#coCd_S').val());
		formData.append("pgmId",  $('#pgmId').val());
		formData.append("salesCd",  $('#salesCd_S').val());
		formData.append("ordrsNo",  $('#ordrsNo_S').val());
		formData.append("clntCd",  $('#ordrsClntCd_S').val());
		formData.append("prjctCd",  $('#clntPjt_S').val());
		formData.append("agendaNo", agendaNo || '');

		// 신규 업로드 파일들
		$.each(agFileArr, function(idx, obj){
			if(obj.fileKey === 0){
				formData.append("files", obj.file);
			}
		});

		// 삭제할 파일 키들
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		// fileTrgtKey에 안건번호 포함: fileTrgtKey_agendaNo_agendaDate
		const agendaVer = getAgendaVerForCell(currentFileRow, currentFileColumn);
		formData.append("fileTrgtKey", uniqueFileTrgtKey + "_" + agendaNo + "_" + dateColMap[currentFileColumn]);
		formData.append("userId", jwt.userId);
		formData.append("pgmId",  $('#pgmId').val());

		filePostAjax("/user/pm/pm20/agUploadFile", formData, function(data){
			gridView.setData();
			agFileArr = [];
			deleteFileArr = [];
		});
	}

	// 행 추가
	function insertAg() {
		const grid = gridView.target;
		if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
			customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
			return;
		}
		// 프로젝트일 때만 salesCd/ordrsNo/clntPjt 중 하나 필수 체크
		if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
			return;
		}

		const cols = grid.config.columns.map(c => c.key).filter(k => k && k.indexOf('dateCol') === 0);

		const sel = grid.getList("selected")[0];
		const selAgenda = (sel && sel.rowType === 'DETAIL')
			? grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo === sel.agendaNo && r.fileTrgtKey === sel.fileTrgtKey)
			: ((sel && sel.rowType === 'AGENDA') ? sel : null);

		let insertIndex = grid.list.length;
		if (selAgenda) {
			const detailIdx = grid.list.findIndex(r =>
				r && r.rowType === 'DETAIL' && r.agendaNo === selAgenda.agendaNo && r.fileTrgtKey === selAgenda.fileTrgtKey
			);
			if (detailIdx >= 0) {
				insertIndex = detailIdx + 1; // 선택 안건(AGENDA+DETAIL) 아래
			} else if (typeof selAgenda.__index === 'number') {
				insertIndex = selAgenda.__index + 1;
			}
		}

		const appendRow = (agendaNo) => {
			const clntNm = $('#ordrsClntNm_S').val() || '';
			const clntPjt = $('#clntPjt_S').val() || '';
			const clntPjtNm = ($('#clntPjt_S option:selected').text() || '').trim();
			const clntPjtNmVal = (clntPjtNm && clntPjtNm !== '전체') ? clntPjtNm : '';
			const clntNmPjt = (clntNm && clntPjtNmVal) ? (clntNm + ' /' + '\n' + clntPjtNmVal) : (clntNm || clntPjtNmVal || '');

			const newAgendaRow = {
				rowType: 'AGENDA',
				fileTrgtKey: uniqueFileTrgtKey,
				agendaNo: String(agendaNo),
				agendaTitle: '',
				mnStatus: 'N',
				agendaVer: 1,
				salesCd: $('#salesCd_S').val() || '',  // 검색조건의 salesCd
				ordrsNo: $('#ordrsNo_S').val() || '',  // 검색조건의 ordrsNo
				clntPjt: clntPjt,
				clntPjtNm: clntPjtNmVal,
				clntNmPjt: clntNmPjt,
				attendByColumn: {},
				filesByColumn: {}
			};
			cols.forEach(k => {
				newAgendaRow[k] = '';
				newAgendaRow.attendByColumn[k] = [];
				newAgendaRow.filesByColumn[k] = [];
			});
			grid.addRow(newAgendaRow, insertIndex);

			const detailRow = {
				rowType: 'DETAIL',
				fileTrgtKey: newAgendaRow.fileTrgtKey,
				agendaNo: newAgendaRow.agendaNo,
				agendaTitle: newAgendaRow.agendaTitle,
				mnStatus: newAgendaRow.mnStatus,
				agendaVer: newAgendaRow.agendaVer,
				agendaVerByCol: newAgendaRow.agendaVerByCol || {},
				salesCd: newAgendaRow.salesCd,  // 병합을 위해 같은 값 복사
				ordrsNo: newAgendaRow.ordrsNo,  // 병합을 위해 같은 값 복사
				clntPjt: newAgendaRow.clntPjt,  // 병합을 위해 같은 값 복사
				clntPjtNm: newAgendaRow.clntPjtNm,  // 병합을 위해 같은 값 복사
				clntNmPjt: newAgendaRow.clntNmPjt,  // 병합을 위해 같은 값 복사
				attendByColumn: newAgendaRow.attendByColumn,
				filesByColumn: newAgendaRow.filesByColumn
			};
			cols.forEach(k => { detailRow[k] = ''; });
			grid.addRow(detailRow, insertIndex + 1);
		};

		const existingAgendaRows = grid.list.filter(r => r && r.rowType === 'AGENDA' && r.fileTrgtKey === uniqueFileTrgtKey);
		const maxAgendaNo = existingAgendaRows.length > 0 ? Math.max(...existingAgendaRows.map(r => parseInt(r.agendaNo) || 0)) : 0;

		if (selAgenda && uniqueFileTrgtKey) {
			const newAgendaNo = (parseInt(selAgenda.agendaNo) || 0) + 1;
			// 마지막 안건 뒤에 추가하는 경우 shift 없이 바로 추가
			if (newAgendaNo > maxAgendaNo) {
				appendRow(newAgendaNo);
				grid.repaint();
				return;
			}
			const paramObj = {
				"fileTrgtKey"	: uniqueFileTrgtKey,
				"bizDiv"		: $('#bizDiv_S').val(),
				"userId"        : jwt.userId,
				"pgmId"			: $('#pgmId').val(),
				"fromAgendaNo"	: String(newAgendaNo)
			};
			postAjax('/user/pm/pm20/shift_agenda_order', paramObj, null, function(data) {
				if (data.resultCode === 200) {
					// 로컬 리스트도 shift
					grid.list.forEach(r => {
						if (r && (r.rowType === 'AGENDA' || r.rowType === 'DETAIL') && r.fileTrgtKey === uniqueFileTrgtKey) {
							const n = parseInt(r.agendaNo);
							if (!isNaN(n) && n >= newAgendaNo) {
								r.agendaNo = String(n + 1);
							}
						}
					});
					appendRow(newAgendaNo);
					grid.repaint();
				} else {
					alert('안건 추가 실패: ' + data.resultMessage);
				}
			});
			return;
		}

		appendRow(maxAgendaNo + 1);
	}

	// 행 삭제
	function deleteAg() {
		const grid = gridView.target;
		if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
			customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
			return false;
		}
		const sel  = grid.getList("selected")[0];
		if (!sel) {
			alert("삭제할 행을 선택하세요!");
			return false;
		}

		const selAgenda = (sel.rowType === 'DETAIL')
			? grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo === sel.agendaNo && r.fileTrgtKey === sel.fileTrgtKey)
			: sel;
		if (!selAgenda) return false;

		const selIndex = selAgenda.__index;
		if (typeof selIndex !== 'number') return false;

		const isEmptyAgenda = function(row) {
			if (!row) return true;
			const titleEmpty = !String(row.agendaTitle || '').trim();
			const dateKeys = Object.keys(row).filter(k => k && k.indexOf('dateCol') === 0);
			const hasDateContent = dateKeys.some(k => String(row[k] || '').trim() !== '');
			const hasAttends = row.attendByColumn && Object.values(row.attendByColumn).some(a => (a || []).length > 0);
			const hasFiles = row.filesByColumn && Object.values(row.filesByColumn).some(a => (a || []).length > 0);
			return titleEmpty && !hasDateContent && !hasAttends && !hasFiles;
		};

		// 저장되지 않은 빈 안건은 서버 호출 없이 로컬에서만 삭제
		if (isEmptyAgenda(selAgenda)) {
			const fileKey = selAgenda.fileTrgtKey || '';
			const agendaNo = selAgenda.agendaNo;
			const newList = grid.list.filter(r => {
				if (!r) return false;
				if (r.rowType !== 'AGENDA' && r.rowType !== 'DETAIL') return true;
				if (agendaNo && String(r.agendaNo || '') !== String(agendaNo)) return true;
				if (fileKey && String(r.fileTrgtKey || '') !== String(fileKey)) return true;
				return false;
			});
			grid.setData({ list: newList, page: { totalElements: newList.length } });
			grid.repaint();
			return;
		}

		const hasValues = Object.keys(selAgenda || {}).some(k => k && k.indexOf('dateCol') === 0 && String(selAgenda[k] || '').trim() !== '');
		if (hasValues && !confirm("선택한 안건에 내용이 있습니다. 정말 삭제하시겠습니까?")) {
			return false;
		}

		var paramObj = {
			"fileTrgtKey"	: selAgenda.fileTrgtKey || uniqueFileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"userId"        : jwt.userId,
			"agendaStatus"  : selAgenda.mnStatus,
			"agendaNo"  	: selAgenda.agendaNo
        };

        postAjax('/user/pm/pm20/delete_agenda', paramObj, null, function(data) {
            if (data.resultCode === 200) {
                gridView.setData();
            } else {
                alert('삭제 실패: ' + data.resultMessage);
            }
        });
	}

	// 안건 순서 이동
	function moveAgenda(direction) {
		const grid = gridView.target;
		const sel = grid.getList("selected")[0];
		if (!sel) {
			alert("이동할 안건을 선택하세요!");
			return;
		}
		const selAgenda = (sel.rowType === 'DETAIL')
			? grid.list.find(r => r && r.rowType === 'AGENDA' && r.agendaNo === sel.agendaNo && r.fileTrgtKey === sel.fileTrgtKey)
			: sel;
		if (!selAgenda) {
			alert("안건 행만 이동 가능합니다.");
			return;
		}
		if (!selAgenda.fileTrgtKey || !selAgenda.agendaNo) {
			alert("저장 후 이동 가능합니다.");
			return;
		}

		const curIdx = selAgenda.__index;
		if (typeof curIdx !== 'number') return;

		let targetIdx = -1;
		if (direction === 'up') {
			for (let i = curIdx - 1; i >= 0; i--) {
				const r = grid.list[i];
				if (r && r.rowType === 'AGENDA') { targetIdx = i; break; }
			}
		} else {
			for (let i = curIdx + 1; i < grid.list.length; i++) {
				const r = grid.list[i];
				if (r && r.rowType === 'AGENDA') { targetIdx = i; break; }
			}
		}

		if (targetIdx === -1) {
			alert("이동할 안건이 없습니다.");
			return;
		}

		const target = grid.list[targetIdx];
		if (!target || !target.fileTrgtKey || !target.agendaNo) {
			alert("이동할 안건 정보가 없습니다.");
			return;
		}
		if (target.fileTrgtKey !== selAgenda.fileTrgtKey) {
			alert("같은 회의 내에서만 이동 가능합니다.");
			return;
		}

		const paramObj = {
			"fileTrgtKey"	: selAgenda.fileTrgtKey,
			"fromAgendaNo"	: selAgenda.agendaNo,
			"toAgendaNo"	: target.agendaNo,
			"userId"        : jwt.userId,
			"pgmId"			: $('#pgmId').val()
		};

		postAjax('/user/pm/pm20/update_agenda_order', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				gridView.setData();
			} else {
				alert('이동 실패: ' + data.resultMessage);
			}
		});
	}


	// 날짜 추가 (진행여부 컬럼은 마지막 고정)
	function addDateColumn() {
		const grid = gridView.target;
		if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
			customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
			return;
		}

		const curDate = moment().format('YYYY-MM-DD');
		const $anchor = $('.add_btn_small a').filter(function(){
			return $(this).text().trim() === '날짜 추가';
		}).first();
		const pos = $anchor.length ? $anchor.offset() : { left: 0, top: 0 };
		const left = pos.left;
		const top = pos.top + ($anchor.outerHeight() || 0);

		$('#colDatePicker')
			.css({ left: left + 'px', top: top + 'px' })
			.each(function () {
				try { $(this).datepicker('destroy'); } catch (e) {}
			})
			.datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true
			})
			.datepicker('setDate', curDate)
			.datepicker('show')
			.off('changeDate')
			.on('changeDate', function(ev) {
				const selDate = moment(ev.date).format('YYYY-MM-DD');

				const exists = Object.values(dateColMap).some(d => d === selDate);
				if (exists) {
					alert("이미 등록된 날짜입니다.");
					return;
				}

				dateColSeq = dateColSeq + 1;
				const colKey = "dateCol" + dateColSeq;
				const newColumnConfig = buildDateColumnConfig(colKey, selDate);

				const statusIdx = grid.config.columns.findIndex(c => c && c.key === 'mnStatus');
				const insertIdx = (statusIdx === -1) ? grid.config.columns.length : statusIdx;

				grid.addColumn(newColumnConfig, insertIdx);

				// 데이터 행에 새 컬럼 속성 추가 (빈 값으로 초기화)
				grid.list.forEach(row => {
					if (!row.hasOwnProperty(colKey)) {
						row[colKey] = '';
					}
					if (row && row.rowType === 'DETAIL') {
						row.filesByColumn = row.filesByColumn || {};
						if (!row.filesByColumn[colKey]) row.filesByColumn[colKey] = [];
					}
					if (row && row.rowType === 'DETAIL') {
						row.attendByColumn = row.attendByColumn || {};
						row.attendByColumn[colKey] = row.attendByColumn[colKey] || [];
						if (!row.hasOwnProperty(colKey)) row[colKey] = '';
					}
				});

				sortDateColumns(grid);
				grid.repaint();
			});
	}

	// 날짜 삭제
	function deleteDateColumn() {
		const grid = gridView.target;
		if ($("#bizDiv_S").val() == "AGENDA01" && !hasProjectSearchKey()) {
			customAlert("프로젝트일 경우 SALES CODE/수주번호/고객사PJT 중 하나를 선택해주세요.");
			return;
		}

		const dateCols = grid.config.columns
			.map((c, i) => ({ c, i }))
			.filter(x => x.c && x.c.key && x.c.key.indexOf('dateCol') === 0);

		if (dateCols.length <= 1) {
			alert("날짜 컬럼은 최소 1개는 있어야 합니다.");
			return;
		}

		let targetKey = currentDateColKey;

		if (!targetKey || !dateCols.some(x => x.c.key === targetKey)) {
			alert("삭제할 날짜 컬럼을 선택하세요.");
			return;
		}

		const target = dateCols.find(x => x.c.key === targetKey);
		if (!target) return;

		const hasValues = grid.list.some(row => row && row.hasOwnProperty(targetKey) && String(row[targetKey] || '').trim() !== '');
		if (hasValues && !confirm("선택한 날짜 컬럼에 내용이 있습니다. 정말 삭제하시겠습니까?")) {
			return;
		}

		const dateVal = dateColMap[targetKey];
		const paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"coCd"			: $('#coCd_S').val(),
			"bizDiv"		: $('#bizDiv_S').val(),
			"salesCd"		: $('#salesCd_S').val(),
			"ordrsNo"		: $('#ordrsNo_S').val(),
			"clntCd"		: $('#ordrsClntCd_S').val(),
			"clntPjt"		: $('#clntPjt_S').val(),
			"deptId"		: $('#deptId').val(),
			"pgmId"			: $('#pgmId').val(),
			"userId"        : jwt.userId,
			"agendaDate"	: dateVal
		};

		postAjax('/user/pm/pm20/delete_agenda_date', paramObj, null, function(data) {
			if (data.resultCode === 200) {
				gridView.setData();
			} else {
				alert('삭제 실패: ' + data.resultMessage);
			}
		});
	}

	// 엑셀다운로드
	function jsonToExcel(grid) {
		const rawList = grid.target.getList();
		const list = rawList.map(row => {
			if (!row || !row.rowType) return row;
			const next = { ...row };
			if (row.rowType === 'DETAIL') {
				Object.keys(row.attendByColumn || {}).forEach(colKey => {
					const names = (row.attendByColumn[colKey] || []).map(u => u.name || u.attendNm || u.id).filter(Boolean);
					const lines = [];
					if (names.length) {
						lines.push("참석자 : " + names.join(", "));
					}
					next[colKey] = lines.join("\n");
				});
				Object.keys(row.filesByColumn || {}).forEach(colKey => {
					const names = (row.filesByColumn[colKey] || []).map(f => f.name || f.fileName).filter(Boolean);
					const lines = [];
					const prev = next[colKey] ? String(next[colKey]) : "";
					if (prev) lines.push(prev);
					if (names.length) {
						lines.push("첨부파일 : " + names.join(", "));
					}
					next[colKey] = lines.join("\n");
				});
			}
			return next;
		});
		const raw = grid.target.colGroup;

		const header = raw.map(col => ({
			...col,
			label: String(col.label)
				.replace(/<br\s*\/?>/gi, "\r\n")
				.replace(/<\/?[^>]+>/g, "")
		}));

		exportJSONToExcel(list, header, "회의록");
	}

	// 회의록 출력
	function setReport(_type = "") {
		if (true) {
			customAlert("회의록 출력물 작업중입니다.");
			return false;
		}
		var arg =  
			"coCd#"			+  $('#coCd_S').val()
			+ "#mnDate#"		+  $("#mnDate_S").val()
			+ "#mnDiv#"	+  $("#mnDiv_S").val()
			+ "#";                 
		var fileName =  "PM2001R01.jrf" ;
		if (_type == '' || _type == 'S' || _type == undefined ) {
			var todayDate = new Date().format('yyyyMMddHHmmss')
			callReport(fileName, arg, 1150, 720, $('#mnDate_S').val()+'회의록'+ todayDate);
		} else { //Export 작업
			ubiExportAjax(fileName, arg, function(response) {
				if (response.resultCode === 200) {
					var base64FileData = response.base64FileData;
					var fileName = response.exportFileName;
					downloadPDFFromBase64(base64FileData, fileName);
				} else {
					alert('PDF 내보내기 실패: ' + response.resultText);
				}

			});
		}
	}    

	// 참석자 저장 (안건별)
	function pm20_d02_update(agendaRow, colKey) {
		const list = agendaRow.attendByColumn[colKey] || [];
		const attendList = list.map(u => ({
			attendId: u.id
		}));

		// 해당 셀의 버전 가져오기
		const agendaVer = (agendaRow.agendaVerByCol && agendaRow.agendaVerByCol[colKey]) || agendaRow.agendaVer || '1';

		var paramObj = {
			"fileTrgtKey"	: uniqueFileTrgtKey,
			"agendaNo"		: agendaRow.agendaNo,
			"agendaVer"		: agendaVer,
			"agendaDate"	: dateColMap[colKey],
			"userId"		: jwt.userId,
			"pgmId"			: $('#pgmId').val(),
			"attendList"	: attendList
		};
		postAjax('/user/pm/pm20/pm20_d02_update', paramObj, null, data => {
			if (data.resultCode == 200) {
				gridView.setData();
			} else {
				alert('참석자 저장 실패: ' + data.resultMessage);
			}
		});
	}

</script>
