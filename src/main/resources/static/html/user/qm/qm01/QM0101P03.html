<div id="qmPopFormRslt" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">요인별 발주 및 출장결과 등록</h4>
    </div>
  <form id="popForm2" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="QM0101P03">
 	<table>
        <colgroup>
          <col width="10%">
          <col width="15%">
          <col width="10%">
          <col width="16%">
          <col width="10%">
          <col width="14%">
          <col width="10%">
          <col width="15%">
        </colgroup>
	  <tbody class='reqInformatio'>
        <tr>
          <th colspan="8" height="30" style="margin-left:0px;text-align:left;">요인별 발주 및 출장요청서</th>
        </tr>
        <tr>
			<th>회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" class="form-control input-sm" >
				</select>
			</td>
			<th>접수자</th>
			<td>
				<div class="search_form">
					<input type="hidden" id="regId" name="regId">
					<input type="text"	id="regNm" data-search="regNm" readonly="readonly">
				</div>
			</td>
			<th>출장자</th>
			<td style="text-align:left;">
				<div id="BUSTCD-radioButtonContainer"></div>
			</td>
			<th >관리번호</th>
			<td>
				 <div class="search_form">
				  <input type="text" id="reqNo" name="reqNo" readonly="readonly" >
				 </div>
			</td>
        </tr>
		 <tr>
			<th>발행일자</th>
			<td>
				<input type="text" id="ordrgDt" name="ordrgDt" readonly="readonly">
			</td>
			<th>요구일정</th>
			<td>
				<input type="text" id="reqDt" name="reqDt" readonly="readonly" >
			</td>
			<th>출장자명</th>
			<td>
			     <input type="text" id="bustNm" name="bustNm" readonly="readonly" >
			</td>
			<th>수주번호</th>
			<td>
                <input type="text" id="ordrsNo" name="ordrsNo" readonly="readonly">
			</td>
        </tr>
        <tr>
			<th>발행자</th>
			<td>
                 <div class="search_form">
			    	<input type="hidden" id="ordrgId" name="ordrgId"  data-search="ordrgId">
             		<input type="text"	id="ordrgNm" data-search="ordrgNm" readonly="readonly">
                 </div>
			</td>
			<th>요청구분</th>
			<td style="text-align:left;">
			  <div id="REQCD-radioButtonContainer"></div>
			</td>
			<th>출장장소(고객사)</th>
			<td>
			     <input type="text" id="bustPe" name="bustPe" readonly="readonly">
			</td>
			<th>대표도면번호</th>
			<td>
				<input type="text" id="matrDrwNo" name="matrDrwNo" readonly="readonly" >
			</td>
        </tr>
        <tr>
		   <th>SalesCode</th>
				<td>
					<div class="search_form">
					    <input type="text" id="salesCd" name="salesCd" readonly="readonly" >
				    </div>
				</td>
			<th>사내작업</th>
			<td style="text-align:left;">
			    <div id="INWKCD-radioButtonContainer"></div>
			</td>
			<th>고객사</th>
			<td>
			    <input type="hidden" id="clntCd" name="clntCd" >
				<input type="text" id="clntNm" name="clntNm" readonly="readonly">
			</td>
			<th>Project명</th>
			<td>
			    <input type="text" id="projNm" name="projNm" readonly="readonly">
			</td>
        </tr>
        <tr>
			<th>분류</th>
			<td>
				<input type="text" id="partCdNm" name="partCdNm" readonly="readonly">
			</td>
			<th>요청 등록 사유</th>
			<td>
				<input type="text" id="subCdNm" name="subCdNm">
				<input type="hidden" id="subCd" name="subCd">
			</td>
			<th>고객사PJT</th>
            <td>
                <div class="search_form">
                    <select id="clntPjt" name="clntPjt" data-kind="PRJCTCD"></select>
                </div>
            </td>
			<th>신작구분</th>
			<td>
			   <input type="hidden" id="ordrsdtldiv20" name="ordrsdtldiv20">
			   <input type="text" id="newCd" name="newCd">
			</td>
        </tr>
        <tr>
			<th>일정지연상황</th>
			<td colspan= "1">
				<select id="scdSts" name="scdSts" data-kind="SCDSTS" data-search="scdSts" msg="일정지연상황">
					<option value="">지연상황 선택(필수)</option>
				</select>
			</td>
			<td colspan= "2">
			</td>
			<td colspan= "2">
			</td>
			<th>문제등록번호</th>
			<td>
				<input type="text" id="workRptNo" name="workRptNo" readonly>
			</td>
        </tr>
        <tr>
          <th >요청 비고</th>
          <td colspan= "7" style="text-align:left;">
            <textarea class="form-control" id="reqRmk" name="reqRmk" style="height: 100px;" readonly="readonly"></textarea>
          </td>
        </tr>
    </tbody>
	<tbody class='rsltInformatio'>
        <tr>
          <th colspan="8" height="30" style="margin-left:0px;text-align:left;">요인별 결과 등록</th>
        </tr>
        <tr>
	       <th class="hit">결과 등록자</th>
		     <td>
	           	<div class="search_form">
				   <input type="hidden" id="resRegId" name="resRegId" required msg="결과 등록자 ID">
	               <input type="text"	id="resRegNm" data-search="resRegNm" msg="결과 등록자" onclick="openFirstResUserSearch();" readonly>
	               <a onclick="openFirstResUserSearch();"><i class="i_search_w" id="userIdBtn"></i></a>
	            </div>
		     </td>
	       <th class="hit">등록일자</th>
	         <td>
	           	<input id="resDt" name="resDt" class="input_calendar form-control" required msg="등록일자">
	         </td>
              <th style="color:blue;" class="hit">조치자 투입공수</th>
              <td>
                   <input type="text" id="actMh" name="actMh" comma onkeyup="onlyNumber(this)" required msg="조치자 투입공수" >
              </td>
			<th>실적번호</th>
               <td>
      	 		<input type="hidden" id="resReqNo" name="resReqNo" >
        		<input type="text" id="rsltNo" name="rsltNo" readonly="readonly">
	           </td>
	    </tr>
	    <tr>
	      <th >결과사유</th>
			<td colspan= "3" style="text-align:left; vertical-align:top;">
				<div id="COBGB-checkboxContainer"></div>
			</td>
		    <td colspan="4">
			  <div>
				<table>
				   <tr>
				    <th>조치 도면 파일명(확인용)</th>
				      <td colspan="3">
					    <textarea  id="actCompDgnFileNm" name="actCompDgnFileNm" rows="5" style="width:570px;" disabled msg="조치 도면 파일명"></textarea>
				      </td>
				  </tr>
				  <tr>
					<th>발생공급업체</th>
					<td colspan="3">
						<input type="hidden" id="vendCd" name="vendCd" data-search="vendCd" msg="발생공급업체">
						<div class="search_form">
							<input type="text" id="vendCdNm" name="vendCdNm" data-search="vendCdNm" onkeyup="event.keyCode == 8 ? vendCd.value='' : '' " style="width: 100%;">
							<a onclick="openClntSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				  </tr>
				  <tr>
				    <th class="hit">기계분류</th>
				      <td colspan="1">
		                    <select id="mcPartCd" name="mcPartCd" data-kind="MCPARTCD" required msg="기계분류">
								<option value="">선택(필수)</option>
							</select>
				      </td>
				    <th>발주요청 기계분류</th>
				      <td colspan="1">
		                	<input type="text" id="mcPartCdReqNm" name="mcPartCdReqNm" readonly>
				      </td>
				  </tr>
				  <tr>
				    <th class="hit">영향도</th>
				      <td colspan="1">
		                    <select id="impactCd" name="impactCd" data-kind="IMPACTCD" required msg="영향도">
								<option value="">선택(필수)</option>
							</select>
				      </td>
				    <th >발주요청 영향도</th>
				      <td colspan="1">
		                	<input type="text" id="impactCdReqNm" name="impactCdReqNm" readonly>
				      </td>
				  </tr>
				  <tr>
				    <th class="hit">중요도</th>
				      <td colspan="1">
		                    <select id="importantCd" name="importantCd" data-kind="IMPORTANTCD" required msg="중요도">
								<option value="">선택(필수)</option>
							</select>
				      </td>
				    <th>발주요청 중요도</th>
				      <td colspan="1">
		                	<input type="text" id="importantCdReqNm" name="importantCdReqNm" readonly>
				      </td>
				  </tr>
				  <!-- <tr>
				  		<td colspan="4">-</td>
				  </tr> -->
<!-- 				    <th >비고</th>  -->
<!-- 					  <td colspan="3">	 -->
<!-- 						 <textarea  class="form-control" id="rsltRmk" name="rsltRmk" rows="5" style="width:570px;" maxlength="1000"></textarea>		 -->
<!-- 					  </td> -->
				   <tr>
				    <th class="hit">원인</th>
				      <td colspan="3">
						<div class="aiContainer">
					    	<textarea  class="form-control" id="measRst" name="measRst" rows="5" style="width:570px;" maxlength="1000" required msg="원인"></textarea>
							<div class="ai-mark" onclick="openapi('measRst');">AI</div>
						</div>
				      </td>
				  </tr>
				  <tr>
				   <th class="hit">결과</th>
				     <td colspan="3">
						<div class="aiContainer">
					   		<textarea  class="form-control" id="resltRst" name="resltRst" rows="5" style="width:570px;" maxlength="1000" required msg="결과를 입력하세요"></textarea>
							<div class="ai-mark" onclick="openapi('resltRst');">AI</div>
						</div>
				     </td>
				  </tr>
				  <tr>
					 <th class="hit">근본원인</th>
					 <td colspan=3 style="text-align:left;">
						<div id="FDMTSOLUT-radioButtonContainer"></div>
					 </td>
				  </tr>
				  <tr>
					 <th>지연일수</th>
					 <td colspan="3">
						<div>
							<input type="text" id="delayDay" name="delayDay" comma onkeyup="onlyNumber(this)" msg="지연일수" placeholder="해당건으로 지연된 일수를 입력">
						</div>
					 </td>
				  </tr>
<!-- 				  <tr> -->
<!-- 				   <th class="hit">고찰 내용</th>  -->
<!-- 				     <td colspan="3"> -->
<!-- 				        <textarea class="form-control" id="thghRst" name="thghRst" rows="5" style="width:570px;" maxlength="1000" required msg="고찰 내용"></textarea>	 -->
<!-- 				     </td>  -->
<!-- 				  </tr> -->
				</table>
			 </div>
		  </td>
	    </tr>
	    <tr>
	    <td colspan= 8>
		    <!-- 공유대상자-->
		    <div class="popup_table" id="approval_trgt">
		        <table style="border:0px;">
		            <tr style="height:30px;">
		              <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
		              <td>
			              <div class="add_btn_small pdl10" id="plus-minus">
					          <a onclick="insertShareUserModal1();" style="height: 30px; line-height: 28px;" authchk>+</a>
					          <a onclick="deleteShareUser1();" style="height: 30px; line-height: 28px;" authchk>-</a>
					      </div>
		              </td>
		            </tr>
		            <tr>
		              <td colspan="2">
		               <div>
						 <div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 200px; width: 100%;" ></div>
					   </div>
					  </td>
					</tr>
		        </table>
		    </div>
		    </td>
		 </tr>
       </tbody>
      </table>
    </form>

	<!-- 공통 파일 영역-->
    <div id="fileList_area"></div>
	<!-- 공통 파일 영역 -->
	 <br>
    <div class="col-xs-2" style="height: 70px;">
    </div>

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="setMouseTrackerVisible(false); modalStack.close();">닫기</button>
	</div>

  </div>
<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	var gridObj = null;
    var approvalList = null;
    var reqNo = null;
    var rsltNo = null;
    var clntPjt = "";
    var teleNo = ""; //카카오 접수자 전화번호변수
 	// 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;

	// 코칭 수정 변수
	var originMeasRst = null;	// 기존 원인 값
	var originResltRst = null;	// 기존 결과/근본대책 값
	let kakaoDiff = null;		// 변경된 원인, 결과 값 알림 메세지 삽입 변수

    var userDeptId = modalStack.last().paramObj.deptId;
    var userDept = userDeptId.substr(0, 5);
	//분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 start
	const standardDate = "2024-07-09"; //발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
	var currentDate = ""; //발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
	//분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 end

	var fromJobType = "REQ"; //default 발주요청서 작업구분--> REQ,  이슈에서 처리할경우 ISS//작업 구분 발주요청서가 시작이면 default 값인 REQ로 작업 진행하고 아니면 ISS가 파라메터로 넘오옴
	if (modalStack.last().paramObj.issNo != undefined && modalStack.last().paramObj.issNo != "") fromJobType = "ISS"; //기존 등록자료 수정모드로 진입시 처리하기 위함
	if (modalStack.last().paramObj.fromJobType != undefined) fromJobType = modalStack.last().paramObj.fromJobType;

	var gridViewPop1 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $('#popForm2').find('[data-ax5grid="second-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 50},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: false},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 80},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 60},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 90},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 130},
					{key: "etcField1",			label: "투입공수",	align: "center",	width: 60},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: 200},
//                     {key: "telNo",      		label: "H.P",		align: "center",   width: 130},
                    {key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},
                    {key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			var targetObj = this.target;
        			var formData = {
     	        			"fileTrgtKey" : fileTrgtKey,
     	        			"reqNo"  : rsltNo,
     	        			"pageNo" : _pageNo + 1
     	    		}

   					postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : {
											totalElements : list.length
								}
							});

							gridResize(gridViewPop1, list.length); //그리드 높이 조정
						} catch (error) {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
   	  				});
          		},

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    }
   	  					});

					gridResize(gridViewPop1, _list.length); //그리드 높이 조정
          		}
  	}

	//************************************************************************************
	/*radio button,  checkbox 공통코드에서 가져오기 start
	 *  아래의 코드가 HTML에 추가함
	 *  <div id="COBGB-checkboxContainer"></div>
	 *  <div id="COBTP-radioButtonContainer"></div>
	 */
	//************************************************************************************

	function createRadioOptions(groupName, _type) {
		var param = {
				"codeKind" : groupName,
		};
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", param , null,  function(data){
			const codeList = data.childCodeList;
			var container = $('#popForm2 #' + groupName + '-radioButtonContainer');
			var typeStr = _type =="radio" ? "radio" : "checkbox";
			codeList.forEach(item => {
				const iHtml = '<td><input type="' + typeStr  + '" id="' + item.codeId +
				                              '" name="' + item.codeKind +
				                             '" value="' + item.codeId +
				                        '" data-label="' + item.codeNm +
				              '" onchange="fnc(this)"> ' + item.codeNm + ' </td>';
				container.append(iHtml);
			});
		})
	}

	// 근본원인 체크박스 설정 (위의 함수를 가공함)
	function createRadioOption_FDMTSOLUT(groupName, _type) {
		let codeEtc = '';
		var param = {
			"codeKind" : groupName,
			"codeEtc"	: codeEtc
		};
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", param , null,	function(data){
			const codeList = data.childCodeList;
			const container = $(' #' + groupName + '-radioButtonContainer')
				.empty()
				.css({
					display: 'grid',
					'grid-template-columns': 'repeat(2, max-content)',
					'margin-left': '10px',
					'column-gap': '32px',
			});
			var typeStr = _type
			codeList.forEach((item, idx) => {
				const iHtml = `
					<div>
						<input
							type="${typeStr}"
							id="${item.codeId}"
							name="${item.codeKind}"
							value="${item.codeId}"
							data-label="${item.codeNm}"
							onchange="fnc(this)"
						>
						${item.codeNm}
					</div>
				`;
				container.append(iHtml);
			});
		})
	}

	function createCheckBox(deptCode) {
		if (deptCode == 'TRN30') deptCode = 'TRN50';	//트루넷직접매출
		if (deptCode == 'GUN70') deptCode = 'GUN60';	//생산관리
		if (deptCode == 'GUN90') deptCode = 'TRN50';	//구매협력업체
		if (deptCode == 'GUN50') deptCode = 'TRN50';	//구매외주팀 (건양ITT)
		if (deptCode == 'GUN95') deptCode = 'TRN50';	//실적관리용 (건양ITT)
		if (deptCode == 'GUN80') deptCode = 'GUN40';	//전산실
		if ($('#popForm2 #ordrgId').val() == 'gyrsult10') deptCode = 'GUN40';	//외부설계

		$('#popForm2 #COBGB-checkboxContainer').empty();

		//발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함 start

		currentDate =  $('#popForm2 #ordrgDt').val(); //발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
		var codeEtc = fromJobType;
   		if (currentDate > standardDate) {
   			codeEtc = fromJobType;
   		} else {
   			codeEtc = '';
   		}
		//발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함 start
		var param = {
			"userDept" : deptCode,
       		"codeEtc"  : codeEtc,
 		};
		postAjaxSync("/admin/cm/cm05/selectCheckboxList", param , null,  function(data){
			var codeList = data.childCodeList;
			var container = $('#popForm2 #COBGB-checkboxContainer');
			var lastKind = '';
			const table = $('<table>').appendTo('#popForm2 #COBGB-checkboxContainer')
			var tableRow = '';
			$.each(codeList, function (index, item){
				if (lastKind != item.codeKind) {
					tableRow = $('<tr>').appendTo(table);
					var trElement = $('<tr>');
					$('<th>').attr('rowspan', item.rowCnt).css('width', '90').text(item.codeDesc).appendTo(tableRow);
					lastKind = item.codeKind;
				} else {
					tableRow = $('<tr>').appendTo(table);
					var trElement = $('<tr>');
				}
				const comboName= "CODECOBGB";
				const iHtml =
				  '<input type="radio" id="' + item.codeId +
									 '" name="' + comboName +
									'" value="' + item.codeId +
							   '" data-label="' + item.codeNm +
				     '" onchange="fnc(this)" style="margin-left:20px"> ' + item.codeNm + '\n';

			     let etcInput = '';
	             if (item.codeId.length > 2) {
		             if (item.codeId.slice(-2) =='99'){
		            	 etcInput =
		            		 '<span id="etcInputWrapper" style="display:none; margin-left:5px;">' +
		            	     '<input type="text" id="etcInput" name="etcInput" msg="기타사유" placeholder="기타사유" style="width:150px;">' +
		            	     '</span>\n';
		             }
	             }
				const tdElement  = $('<td>').attr('style', 'text-align:left;height:20px;').text('').appendTo(tableRow);
				tdElement.append(iHtml + etcInput);

			});
		})
// 		gridViewPop1.initView();
	}


	function fnc(thisButton) {
       const inputType = thisButton.type;
       const inputName = thisButton.name;
       const inputvalue = thisButton.value;
       
// 		if (inputType === 'radio') {
// 			console.log(thisButton.dataset.label + ' radio button. = ' + $("input[name='COBTP']:checked").val() + ' 선택');
// 		} else if (inputType === 'checkbox') {
// 			console.log(thisButton.dataset.label + ' checkbox. = ' + thisButton.value + '의 상태는 ' + thisButton.checked);
// 		}
		if (thisButton.id == 'COBTP99') {
			$("#popForm2 #COBGB9999").prop("checked", $("#popForm2 #COBTP99")[0].checked);
		}
		if (inputName === 'CODECOBGB' && inputvalue.length > 2) {
			const etcField = inputvalue.slice(-2); 
	      
			if (etcField == '99') {
				$('#popForm2 #etcInputWrapper').show();
				$('#popForm2 #etcInput').focus().attr('required', true).closest('td').prev('th').addClass('hit');
			} else {
				$('#popForm2 #etcInputWrapper').hide();
				$('#popForm2 #etcInput').val('').removeAttr('required').closest('td').prev('th').removeClass('hit');
			}
		}
	}
/*************************************************************************************
 * radio button,  checkbox 공통코드에서 가져오기 end
 */
//*************************************************************************************

	$(document).ready(function() {
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		reqNo = modalStack.last().paramObj.reqNo;
		rsltNo = modalStack.last().paramObj.rsltNo;
		gridObj = modalStack.last().paramObj.gridObj; // To_DO에서 넘어온 데이터

		$("#popForm2 #fileTrgtKey").val(fileTrgtKey);

		setCommonSelect($("#popForm2 select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm2 #resRegId").val(jwt.userId);
		$("#popForm2 #resRegNm").val(jwt.userNm);

		//처리일자//
		$('#popForm2 #resDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());

		gridViewPop1.initView();

		//createRadioOptions('COBTP', "radio");  //분류 자동 생성
		createRadioOptions('BUSTCD', "checkbox");  //출장차 구분
		createRadioOptions('INWKCD', "checkbox");  //사내작업 구분
		createRadioOptions('REQCD', "radio");  //요청구분 구분
		createRadioOption_FDMTSOLUT('FDMTSOLUT', 'checkbox') // 근본원인 구분

		authChk();						// 권한체크

		//요청내용에 대하여 읽기전용으로 바꾸기
// 		$('.reqInformatio input, .reqInformatio textarea, .reqInformatio select').toggleClass('no-clickColor');
		$('#popForm2 .reqInformatio input[type="checkbox"], .reqInformatio input[type="radio"], .reqInformatio select').toggleClass('no-clickColor');


		$("#popForm2 #ordrgId").val(modalStack.last().paramObj.userId);
		$("#popForm2 #ordrgNm").val(modalStack.last().paramObj.userName);
		$("#popForm2 #regId").val(modalStack.last().paramObj.userId);
		$("#popForm2 #regNm").val(modalStack.last().paramObj.userName);
		$("#popForm2 #creatId").val(modalStack.last().paramObj.userId);

		if (actionType == "C") {
			rsltNo = '';
			createCheckBox(userDept);	//부서별 장애원인 자동 생성 (수정일경우 등록된 자료에 따라 재설정함.)
			
			$("#qmPopFormRslt #actionBtn").text("등록");
			$('#qmPopFormRslt #actionBtn').on("click", function() {
				insertQualityResp();
			});

		} else if (actionType == "U" || actionType == "I") {
			$('#qmPopFormRslt').find('.tit').text('요인별 발주 및 출장결과 수정');

			$('#qmPopFormRslt #actionBtn').text("수정");
			$('#qmPopFormRslt #actionBtn').on("click", function() {
				updateQualityResp();
			});
			
		}

		selectQtyReqInfo();

		
		// 결재시 수정하면 change 이벤트 적용
		$('#qmPopFormRslt').on('input paste drop change','#measRst, #resltRst, #FDMTSOLUT-radioButtonContainer input[type=checkbox]',function() {
			if ($('#qmPopFormRslt  #commentBtn').length === 0 && gridObj) {	// 결재 정보 그리드가 있어야지 코칭수정 버튼 활성화
				const callCmdBtn = '<button id="commentBtn">코칭수정</button>';
				$('#qmPopFormRslt .popup_bottom_btn').first().prepend(callCmdBtn);
				$('#qmPopFormRslt #commentBtn').on("click", function() { updateQualityResultComment('결과수정'); });
			}
		});
		
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
				fileTrgtTyp	: $("#popForm2 #pgmId").val(),
				fileTrgtKey	: fileTrgtKey,
	            todoNo		: rsltNo,	//결재정보처리를 위함
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

	});



	// 결재시 코멘트 추가 수정
	function updateQualityResultComment(){
		var formData = makeFormData();
		filePostAjax("/user/qm/qm01/updateQualityResultComment", formData,function(data) {
			if (data.resultCode == 200) {
				$('#qmPopFormRslt #commentBtn').remove();
				// 카카오톡 메세지 문구 추가 설정
				// 원인
				const newMeasRaw = formData.get("measRst");
				const originMeasRaw = originMeasRst;
				const newMeasClean    = newMeasRaw.replace(/\r\n/g, "\n");
				const originMeasClean = originMeasRaw.replace(/\r\n/g, "\n");

				let diffMeas = "";
				if (newMeasClean.startsWith(originMeasClean)) {
					diffMeas = newMeasClean.slice(originMeasClean.length);
				} else if (newMeasClean.includes(originMeasClean)) {
					diffMeas = newMeasClean.split(originMeasClean)[1];
				}
				diffMeas = diffMeas.replace(/^[\r\n]+/, "");

				// 결과
				const newResltRaw    = formData.get("resltRst");
				const originResltRaw = originResltRst;
				const newResltClean    = newResltRaw.replace(/\r\n/g, "\n");
				const originResltClean = originResltRaw.replace(/\r\n/g, "\n");

				let diffReslt = "";
				if (newResltClean.startsWith(originResltClean)) {
					diffReslt = newResltClean.slice(originResltClean.length);
				} else if (newResltClean.includes(originResltClean)) {
					diffReslt = newResltClean.split(originResltClean)[1];
				}
				diffReslt = diffReslt.replace(/^[\r\n]+/, "");

				// 전역 kakaoDiff 설정
				kakaoDiff = { cause: diffMeas, result: diffReslt };

				// diff가 있으면 카톡 발송
				if (diffMeas || diffReslt) {
					kakaoTodo();
				}
            }
		});
	}
	
	// 공유대상자 추가//
    function insertShareUserModal1() {

    	if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

        var paramObj = {};
        var appshaList = gridViewPop1.target.list;
        paramObj["coCd"] = $('#popForm2 #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $('#popForm2 #ordrgId').val();
        paramObj["userNm"] =  $('#popForm2 #ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
        		}).map(function(item) {
	        		  	return {
	        			    gb: "결재",
	        			    id: item.usrNm,
	        			    text: item.name,
	        			    parent: item.jik,
	        			    deptNm: item.dtNm,
	        			    telNo: item.telNo,
	        			    offTelNo: item.offTelNo,
	        			    email: item.email,
	        			    todoId: item.usrNm,
	        			};
        		});
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
        		}).map(function(item) {
				  		return {
						    gb: "공유",
						    id: item.usrNm,
						    text: item.name,
						    parent: item.jik,
						    deptNm: item.dtNm,
						    telNo: item.telNo,
						    offTelNo: item.offTelNo,
						    email: item.email,
						    todoId: item.usrNm,
						};
				});

        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//     		console.log('결재라인 : ', approvalGrid.target.list);
//     		console.log('공유라인 : ', shareGrid.target.list);

    		var appArray = approvalGrid.target.list.map(function(item) {
    			  return {
    				  	gb: "결재",
    				  	usrNm: item.id,
    				  	name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id,
					};
			});
    		var shaArray = shareGrid.target.list.map(function(item) {
  			  return {
	  				  	gb: "공유",
						usrNm: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
	                    todoId: item.id,
					};
			});
  			gridViewPop1.setData2(appArray.concat(shaArray));

//     		approvalGrid.id //userId
//     		approvalGrid.text //성명
//     		approvalGrid.parent //직책
//     		approvalGrid.deptNm //부서
//     		approvalGrid.telNo
//     		approvalGrid.offTelNo
//     		approvalGrid.email

//     		shareGrid.id //userId
//     		shareGrid.text //성명
//     		shareGrid.parent //직책
//     		shareGrid.deptNm //부서
//     		shareGrid.telNo
//     		shareGrid.offTelNo
//     		shareGrid.email
        });

    }

    function deleteShareUser1(){
    	if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

    	var selRow = parseInt(gridViewPop1.target.selectedDataIndexs);
	 		if( isNaN(selRow) ) {
	 			alert("선택된 행이 없습니다.");
	 			return;
	 		} else {
	 				if( selRow > -1 ) {
	 					//gridViewPop.target.removeRow(selRow);
	 					var todoKey = gridViewPop1.target.getList()[selRow].todoKey;
					if( typeof(todoKey) == "undefined" ) {
						gridViewPop1.target.removeRow(selRow);
						$.gridNoSet(gridViewPop1, "sanctnSn");
					} else {
						var gridList = gridViewPop1.target.getList("selected")[0];
						var paramObj = {
								todoKey			: gridList.todoKey,
								todoNo			: $("#popForm2 #rsltNo").val(),
								sanctnSn		: gridList.sanctnSn,
								todoDiv1CodeId	: gridList.todoDiv1CodeId,
								todoDiv2CodeId	: gridList.todoDiv2CodeId,
						}
		 		        if(paramObj.todoKey && paramObj.sanctnSn && paramObj.todoDiv1CodeId && paramObj.todoDiv2CodeId ) {
	 	 						deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
	 	 							if (data.resultCode == 200) {
	 	 								gridViewPop1.setData(0);
	 	 							} else {
	 	 								alert("삭제중 오류가 발생했습니다");
	 	 							}
	 	 						});
		 		        } else {
		 		        	alert("삭제중 오류가 발생했습니다.")
		 		        }
					}
	 			}
	 		}
    }



	function selectQtyReqInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
	        "reqNo" 		: reqNo,
	        "rsltNo" 		: rsltNo,
		}

		postAjaxSync("/user/qm/qm01/selectQtyReqInfo", formData, null, function(data) {
			//workRptNo = issNo : 문제등록번호가 존재하면 문제건임 ==> "ISS"
				
            //발행자에 따라 등록사유 선택항목 재생성 작업
            //if (data.result.ordrgId.slice(0,7) == 'gyrsult') return false
            //    -->퇴사자인경우 작성자를 기준으로 생성해야함므로 작성자의 부서가 필요함
            // 작성자의 부서는 작성자 정보 출력시 저장해야함.
            if (data.result.ordrgId.slice(0,7) == 'gyrsult') {
          		createCheckBox(data.result.regDeptId);	//퇴사자인경우 작성자기준으로 등록사유 생성함
            } else {
    			createCheckBox(data.result.deptCd);	//부서별 장애원인 자동 생성 (수정일경우 등록된 자료에 따라 재설정함.)
            }
           
         	// 체크 대상 키들을 배열로 정의
            const checkKeys = ['reqCd', 'partCd', 'subCd', 'bustCd01', 'bustCd02', 'inwkCd01', 'inwkCd02'];

            for (const key in data.result) {
                if (data.result.hasOwnProperty(key)) {
                    const value = data.result[key];
                    
                    // 체크박스 처리
                    if (checkKeys.includes(key)) {
                        $('#popForm2 #' + value).prop("checked", true);
                    } else 	                    
                    // 특수한 키 'clntPjtNm' 처리
                    if (key === 'clntPjtNm') {
                        clntPjt = value;
                    } else 
	                    // 텍스트 입력 필드에 값 설정
                    {
                    	$('#popForm2 #' + key).val(value);
                    }
					
					if (key == 'fdmtSolutCd') {	// 근본원인 체크하기
					const codes = value.split(',');
					codes.forEach(code => {
						$(`input[name="FDMTSOLUT"][value="${code}"]`).prop('checked', true);
					});
				}
                }
            }
			if (actionType == 'C'){
				$("#popForm2 #rsltNo").val('RES' + $("#popForm2 #reqNo").val().substr(3,10));
				rsltNo = $("#popForm2 #rsltNo").val();
				$("#popForm2 #mcPartCd").val('');
				$("#popForm2 #impactCd").val('');
				$("#popForm2 #importantCd").val('');
				// 결과 등록 시 등록 정상적인 등록일 때 기계분류, 영향도, 중요도 선택불가 및 필수해제
				// 영업 : 고객추가요구(COBGB1204), 고객사양변경(COBGB1205), 제품DATA 변경(COBGB1206), 이벤트대응(COBGB1301), 양산대응(COBGB1301)
				// 공통 : 정상(COBGB2101), 선발주(COBGB2102)
				// 생산 : 정상구매(COBGB3001)
				// 트루넷 : 정상발주(COBGB4501)
				if (data.result.subCd == 'COBGB1204' || data.result.subCd == 'COBGB1205' || data.result.subCd == 'COBGB1206' || data.result.subCd == 'COBGB1301' || data.result.subCd == 'COBGB1301' || data.result.subCd == 'COBGB1303' ||
					data.result.subCd == 'COBGB2101'|| data.result.subCd == 'COBGB2102' || data.result.subCd == 'COBGB3001' || data.result.subCd == 'COBGB4501'					
				) {	
					$("#popForm2 #mcPartCd").removeAttr('required').closest('td').prev('th').removeClass('hit')
					  						.css({ 'background-color': '#e6e6e6', 'pointer-events': 'none' })
					$("#popForm2 #impactCd").removeAttr('required').closest('td').prev('th').removeClass('hit')
					  						.css({ 'background-color': '#e6e6e6', 'pointer-events': 'none' })
					$("#popForm2 #importantCd").removeAttr('required').closest('td').prev('th').removeClass('hit')
					  						.css({ 'background-color': '#e6e6e6', 'pointer-events': 'none' })
				}
			}

			
			// 일정지연상황이 정상관리가능이 아니면 지연일수 입력 필수임 
			if ($('#popForm2 #ordrgId').val() == jwt.userId || $('#popForm2 #regId').val() == jwt.userId) {
				if (data.result.scdSts === 'SCDSTS01')  {
					$('#popForm2 #delayDay').removeAttr('required').closest('td').prev('th').removeClass('hit');
				} else {
					$('#popForm2 #delayDay').attr('required', true).closest('td').prev('th').addClass('hit');
				}
			}
			
			// 발행자의 Id가 gyrsult로 시작할 경우 작성자는 로그인한 유저
			if (actionType == 'C' || actionType == 'U') {
				if ($("#popForm2 #ordrgId").val().slice(0, 7) == 'gyrsult') {
					$("#popForm2 #regId").val(jwt.userId);
					$("#popForm2 #regNm").val(jwt.userNm);
					$("#qmPopFormRslt #actionBtn").show();
				}
			}
			
			// 각 텍스트 에어리어 크기 조절
			txtareaHeightResize($('#popForm2 #reqRmk'));

			//문제등록사유 코드의 끝 2자리가 99이면 기타 이며, 기타인경우 사유가 있음
			if (data.result.subCd.slice(-2) === '99') {
				$('#popForm2 #etcInputWrapper').show();
				$('#popForm2 #etcInput').val(data.result.etcInput).attr('required', true).closest('td').prev('th').addClass('hit');
			} else {
				$('#popForm2 #etcInputWrapper').hide();
				$('#popForm2 #etcInput').val('').removeAttr('required').closest('td').prev('th').removeClass('hit');
			}
			

			if ($("#popForm2 #ordrgId").val() != jwt.userId && $("#popForm2 #regId").val() != jwt.userId){
				$("#qmPopFormRslt #actionBtn").hide();
				 //모든 입력 기능 통제하기
				 disableFormAll('popForm2');
				 setMouseTrackerVisible(true, `발행자 ${data.result.ordrgNm}만 결과 등록 가능합니다....`);
			}
		});
	

		selectQtyReqRespInfo();
	}


	 // 등록
	function insertQualityResp() {
		if($('#popForm2').find("input[name='CODECOBGB']:checked").val() == undefined || $('#popForm2').find("input[name='CODECOBGB']:checked").val() == ""){
	        alert("등록사유를 선택해주세요");
	        return false;
		}
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			if ($("input[name='FDMTSOLUT']:checked").val() == undefined) {
				alert("근본원인을 선택해주세요.");
			} else {
				var formData = makeFormData();
				filePostAjax("/user/qm/qm01/insertQualityResp", formData,function(data) {
					if (data.resultCode == 200) {
	// 					kakaoTodo();
						gridView.setData(0);
						modalStack.close();
					}
				});
			}
		}
	}

	// 수정
	function updateQualityResp(){
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return false;
		}
		if($('#popForm2').find("input[name='CODECOBGB']:checked").val() == undefined || $('#popForm2').find("input[name='CODECOBGB']:checked").val() == ""){
	        alert("등록사유를 선택해주세요");
	        return false;
		}
		if ($("input[name='FDMTSOLUT']:checked").val() == undefined) {
			alert("근본원인을 선택해주세요.");
			return false;
		} 
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
	      	filePostAjax("/user/qm/qm01/updateQualityResp", formData,function(data) {
				if (data.resultCode == 200) {
					kakaoTodo();
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('#popForm2').find('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('#popForm2').find('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 근본원인 체크된 객체들 배열로 변환하고 조인
		const rootCauses = $('#FDMTSOLUT-radioButtonContainer input[type="checkbox"]:checked')
					.map(function() { return this.value; })
					.get()   // jQuery 객체 -> 일반 배열
					.join(',');  // ["A","B","C"] -> "A,B,C"

		// 폼데이터 생성
		var formData = new FormData($("#popForm2")[0]);
		formData.append("coCd", $('#popForm2 #coCd').val());
		formData.append("vendCd", $('#popForm2 #vendCd').val())    // 발생공급업체
		formData.set('FDMTSOLUT', rootCauses);

		/*	결재그리드 insert make start */
	    //이슈진행상태가 완료이면 조치자의 담당팀장 결재라인에 자동 등록 처리하기
//     	approvalTeamManagerInfoData($('#resRegId').val());
    	selectTeamManagerApprovalAdd();

		//결재그리드
        var rowSharngList = gridViewPop1.target.list;
        var ParamObj = modalStack.last().paramObj;
        ParamObj.rsltNo = $("#popForm2 #rsltNo").val();	//최최등록시에는 파라메터에 정보가 없음
        ParamObj.actionType = 'U';  //결재모드는 수정으로 접근하기 위함

        if(rowSharngList.length > 0) {
            var approvalArr = []; //결재정보

            //각업무에 맞는 param insert - 하드코딩값
    		var addParam = {
    					  coCd: $("#popForm2 #coCd").val()
    					, salesCd: $('#popForm2 #salesCd').val()
    					, pgmId: $("#popForm2 #pgmId").val()
    					, pgPath: "/user/qm/qm01/QM0101P03.html"
    					, sanctnSttus: "N"
    					, salesCd: $("#popForm2 #salesCd").val()
    					, todoCoCd: $("#popForm2 #coCd").val()
    					, todoNo: $("#popForm2 #rsltNo").val()
    					, todoFileTrgtKey: modalStack.last().paramObj.fileTrgtKey
    					, pgParam: JSON.stringify(ParamObj)
    					, userId: jwt.userId
    					, todoTitl:  $("#popForm2 #clntNm").val() + '-' + clntPjt + $('#popForm2').find("input[name='CODECOBGB']:checked")[0].dataset.label + " 발주및출장요청서 결과 "
    					, todoKey: ""
    					, todoCodeKind: ""
    					, todoCodeId: ""
    			};

            let 결재순번 = 0;
            let 공유순번 = 0;
            $.each(rowSharngList, function(idx, elem) {
            	/* rowSharngList 내용입니다.
		           	/* rowSharngList 내용입니다.
		           	{
					    "rnum": "2",
					    "wbsPlancoCd": "GUN",
					    "coCd": "GUN",
					    "wbsPlancoCdNm": "건양ITT",
					    "usrNm": "gyrsult10",
					    "empNo": "gyrsult10",
					    "name": "외부설계",
					    "telNo": "010-1234-1321",
					    "email": "발주요청서 실적 관리용입니다.",
					    "dtNm": "실적관리용",
					    "jik": "담 당",
					    "todoDiv1CodeId": "TODODIV20",
					    "gb": "결재",
					    "sanctnSttus": "N",
					    "sanctnSttusNm": "미승인",
					    "creatDttm": "2024-07-01",
					    "todoKey": "5778",
					    "sanctnSn": "2",
					    "todoId": "gyrsult10",
					    "todoDiv2CodeId": "TODODIV2020",
					    "salesCd": "24000-00DUMMY",
					    "flag": "U",
					    "__original_index": 1,
					    "__index": 1
					}
            	*/
            	if (elem.usrNm.includes('gyrsult')) {
            		//퇴사자 또는 외주업체담담자등록용으로 결재 제외처리함
            		// gyrsult10 외부설계
            		// gyrsult20 외부기계
            		// gyrsult30 외부전기
            		// gyrsult90 퇴사자
            	} else {
	                var approvalListObj = elem;

	                addParam["todoId"] = elem.usrNm;
	                addParam["empNo"] = elem.empNo;
	                addParam["name"] = elem.name;
	                addParam["telNo"] = elem.telNo;
	                addParam["email"] = elem.eMail;
	                addParam["gb"] = elem.gb;
	                if (elem.gb == '공유') {
	                	공유순번 += 1;
	                	approvalListObj["sanctnSn"] = 공유순번;
	                	approvalListObj["todoDiv1CodeId"] = "TODODIV10";
	                	approvalListObj["todoDiv2CodeId"] = "TODODIV1050";
	                }
	                else if (elem.gb == '결재') {
	                	결재순번 += 1;
	                	approvalListObj["sanctnSn"] = 결재순번;
	                	approvalListObj["todoDiv1CodeId"] = "TODODIV20";
	                	approvalListObj["todoDiv2CodeId"] = "TODODIV2030";
	                }
	                const mergedParam = {...addParam, ...approvalListObj}//속성합치기
	                approvalArr.push(mergedParam);
            	}
            });
            formData.append("approvalArr", JSON.stringify(approvalArr));
        }
        /*	결재그리드 insert make end */

        //---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		formData.append("ordrsNo", $("#popForm2 #ordrsNo").val());
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#popForm2 #clntCd').val());			//첨부화일용
		formData.append("prdtCd" , $('#popForm2 #prdtCd').val(""));			//첨부화일용
		formData.append("itemCd" , $('#popForm2 #itemDiv').val(""));			//첨부화일용
		formData.append("prjctCd", $('#popForm2 #clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용

		//---------------------------------------------------------------

        //---------------------------------------------------------------
		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

	   return formData;
	}

	//결재 여부
	function approvalYn() {
		var gridList = gridViewPop1.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
        	var msgArr = [];
	        $.each(gridList, function (idx, elem) {
	        	//결재자가 본인이 아니면서 상태가 Y인 경우
	        	if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
	        })
		}
		return inCnt;
	}




	function setByCoCd(value) {
		$('#popForm2 #coCd option:not([value="'+value+'"])').remove();
	}

	function selectAuth(value){
		userDeptId = value;
		userDept = userDeptId.substr(0, 5);
	}

	function selectQtyReqRespInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"rsltNo" : rsltNo,
			"reqNo" : rsltNo,	//결재정보 조회를 위해 결과서번호로 조회하기 위함.
		}

		postAjaxSync("/user/qm/qm01/selectQtyReqRespInfo", formData, null, function(data) {
			if (data.result) {
				$.each(data.result, function(key, value) {
					if(key == "subCd" ){
						$('#'+value).prop("checked", true);
					} else
					if (key == 'todoYn'){
						if(value == 'Y'){
							//결재대상자 load
							gridViewPop1.initView().setData(0);
							}
					} else
					if ($('#popForm2 #' + key)[0]) {
						$('#popForm2 #' + key).val(value);
						if ($('#popForm2 #' + key).hasClass("input_calendar")) {
							$('#popForm2 #' + key).datepicker("update");
						}
					}
				});

				if (data.result.sameTimeResult== 'Y' || data.approval[0] == 'Y'){	//결재가 한개라도 진행이 되었으면 알림창
				    //input readonly, radio.checkbox disabled
					$.each($('#popForm2  select, input, textarea'), function(idx, elem){
						var id = $(elem).attr("ID");
						if( id ) {
							var eleId = '#qmPopFormRslt #'+id;
							if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
							if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
							if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
							if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
						}
					});
					
					$('#qmPopFormRslt #actionBtn').remove();
					$('#qmPopFormRslt #plus-minus').remove();
					$('#qmPopFormRslt .tit').text('요인별 발주 및 출장요청 조회');

					//모든 입력 기능 통제하기
					disableFormAll('popForm2');
				}
				originMeasRst = data.result.measRst;	// 원인
				originResltRst = data.result.resltRst;	// 결과

				//문제등록사유 코드의 끝 2자리가 99이면 기타 이며, 기타인경우 사유가 있음
				if (data.result.subCd.slice(-2) === '99') {
					$('#popForm2 #etcInputWrapper').show();
					$('#popForm2 #etcInput').val(data.result.etcInput).attr('required', true).closest('td').prev('th').addClass('hit');
				} else {
					$('#popForm2 #etcInputWrapper').hide();
					$('#popForm2 #etcInput').val('').removeAttr('required').closest('td').prev('th').removeClass('hit');
				}
				
				//발주요청서와 결과를 동시에 입력한자료인 경우 수정기능 없음(발주요청서에서 처리함)
				if (data.result.sameTimeResult == 'Y') {
					$("#qmPopFormRslt #actionBtn").hide();
					//모든 입력 기능 통제하기
					disableFormAll('popForm2');
				}
				// 각 텍스트 에어리어 크기 조절
				txtareaHeightResize($('#popForm2 #actCompDgnFileNm'));
				txtareaHeightResize($('#popForm2 #measRst'));
				txtareaHeightResize($('#popForm2 #resltRst'));

				gridViewPop1.setData();
			}
		});

	}

	// 등록자 검색 //
    function openFirstResUserSearch() {
    	var paramObj = {
    		  "coCd" : $('#popForm2 #resCoCd').val(),
    		"userId" : $('#popForm2 #resRegId').val(),
    		"userNm" : $('#popForm2 #resRegNm').val(),
			"useYn": "Y"
    	};
//     	if (actionType == "C"){
        	openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
        				var checkedId = tree.get_checked()[0];
        				var checkedNode = tree.get_node(checkedId);
        				$('#popForm2 #resRegId').val(checkedNode.id);
        				$('#popForm2 #resRegNm').val(checkedNode.text);
                        createCheckBox(checkedNode.parent.slice(0,5))
                        selectAuth(checkedNode.parent);
        			});
//     	}
    }



	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
// 		console.log('---gridNoset run ---');
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}


	/*
	#	TODO 알림톡발송 시작
	#
	*/
// 	$("#approvalReqTodoBtn").on("click", function () {
// 		kakaoTodo();
// 	});

	var kakaoErr = [];

	function kakaoTodo() {
        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	            "userId" : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });
        }

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
	     var paramObj1 = {
	             "coCd" : $("#popForm2 #coCd").val(),
	             "userId" : $("#popForm2 #resRegId").val()
	         };
	      postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
	          if (data.result[0] == undefined
	               || data.result[0].telNo == "") {
	        	  teleNo = "051-312-2400";
	          }
	          else {
	        	  teleNo = data.result[0].telNo;

	          }
	      });
	     //---------------------------------------

		let param = {
				"tmplatDiv": "TMPLATDIV02"
				, "coCd": $("#popForm2 #coCd").val()				//해당업무의 coCd(트르넷발주 TRN )
				, "todoDiv1CodeId": "TODODIV20"					//공통코드 해당업무 - 결재
				, "todoDiv2CodeId": "TODODIV2030"					//공통코드 해당업무 - 결재 - 발주서
				, "todoDiv1CodeNm": "결재"						//공통코드 해당업무 - 결재 - 발주서
				//, "todoDiv2CodeNm": "발주 및 출장 요청"						//공통코드 해당업무 - 결재 - 발주서
				, "title": "발주 및 출장 결과서"
				, "sanctnDiv2": "결재"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
				, "todoNo": $("#popForm2 #rsltNo").val()
				, "clntCd": "1"					//발신회사는 로그인사용자 회사
				, "clntNm": clntNm				//로그의 수신거래처명
				, "ordrgMngNm": $("#popForm2 #resRegNm").val()			//발주작성자(담당자)
				, "ordrgMngTelNo": teleNo		//담당자전화번호
				, "creatPgm"  : "QM0101P03"
		}
		commKaKaoSendTodo(param);

		//공유
		let param2 = {
				"tmplatDiv": "TMPLATDIV02"
					, "coCd": $("#popForm2 #coCd").val()				//해당업무의 coCd(트르넷발주 TRN )
					, "todoDiv1CodeId": "TODODIV10"					//공통코드 해당업무 - 결재
					, "todoDiv2CodeId": "TODODIV1050"					//공통코드 해당업무 - 결재 - 발주서
					, "todoDiv1CodeNm": "공유"						//공통코드 해당업무 - 결재 - 발주서
					, "title": "발주 및 출장 결과서"
					, "sanctnDiv2": "공유"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
					, "todoNo": $("#popForm2 #rsltNo").val()
					, "clntCd": "1"					//발신회사는 로그인사용자 회사
					, "clntNm": clntNm				//로그의 수신거래처명
					, "ordrgMngNm": $("#popForm2 #resRegNm").val()			//발주작성자(담당자)
					, "ordrgMngTelNo": teleNo		//담당자전화번호
					, "creatPgm"  : "QM0101P03"
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
	    	kakaoCnt = 0;
// 	    	alert("알림톡이 정상 발송되었습니다.");
	    }
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
// 		console.log('---카카오 발주및출장결과서 알림톡발송시작 --' + param);

		//알림톡수신번호 채번
		var maxMessageId = null;			//message id(unique key)
		var talkMessage = null 				//발송될 내용 template
		var mobile = null					//수신인 휴대전화번호
		//var title = null					//todo title
		var todoDiv2CodeNm = null					//todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
					, function(data) {
						if(data.resultList.length > 0 ) {
							if( data.resultList[0].maxMessageId != "" ) {
								sendList = data.resultList;
							} else {
								alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
								return;
							}

						}
		});
		//user search ajax end

		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;

			if (kakaoDiff) {
				// 변경내용 추가
				let insertLines = "";
				if (kakaoDiff.cause)  insertLines += `원인 : ${kakaoDiff.cause}\n`;
				if (kakaoDiff.result) insertLines += `결과 : ${kakaoDiff.result}\n`;

				// 변경된 게 있으면 “요청업무” 바로 아래에 삽입
				if (insertLines) {
					talkMessage = talkMessage.replace(
					/(요청업무\s*:[^\r\n]*)(\r?\n)/,
					`$1$2${insertLines}`
					);
				}
			}

			//로그용
			param.rcvId = sendObj.todoId;			//todo 수신id
			param.rcvNm = sendObj.name;				//todo 수신자명
			param.nameTo = sendObj.name;				//todo 수신자명
			//title		= sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = todoDiv2CodeNm;
			//param.title = title;								//요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}
			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.title = param.title;					//알림톡 타이틀 -
			talkBody.message = message;				//알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;				//휴대전화번호
			talkBody.template = "10003";			//템플릿관리화면 템플릿ID	- 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end
		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}



	function gridResize(gridObj, size) {
	        var tagHeight = (size) * 27 + 60 ;
	        tagHeight = tagHeight > 750 ? 750 : tagHeight;
	        tagHeight = tagHeight < 100 ? 100 : tagHeight;

	        gridObj.target.setHeight(tagHeight);
	}



    //조치담당자 팀장 정보 가져오기
	function selectTeamManagerApprovalAdd() {
    	//------------------------------------------------
    	//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
    	//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
    	//------------------------------------------------
    	let appshaList = gridViewPop1.target.getList();

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		var tempActId = $("#popForm2 #resRegId").val();	//발행자ID
		if (tempActId.slice(0,7) == 'gyrsult') return false; //실적관리용 ID는 결제 제외처리함.

        $.each(appshaList, function(idx, item){
            if (item.gb === "결재") {
            	appArray.push(item);
            } else {
            	//공유일경우 조치담당자가 공유에 있으면 제외처리함.
            	if (item.usrNm != tempActId) {
            		shaArray.push(item);
            	}
            }
        });
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------

		//발행자의 팀장 정보 가져오기 결제자 정보 추가
// 		appArray = approvalUserInfoData(tempActId, appArray);
		appArray = approvalTeamManagerInfoData(tempActId, appArray);
// 		appArray = approvalTeamManagerInfoData(jwt.userId, appArray);

		//발행자와 결과등록자가 다른 경우 발행자 결제자동등록 처리
		if ($("#popForm2 #ordrgId").val() != $("#popForm2 #resRegId").val()) appArray = approvalUserInfoData($("#popForm2 #ordrgId").val(), appArray);

		// 중요도가 최상(비용상, 빈도상)이면 사장님 결재라인에 자동 등록
		if ($('#importantCd').val() == 'IMPORTCD01') {
			appArray = approvalTeamManagerSpecialInfoData('ceo', appArray);
		}

		// 발주요청서 등록 시 영업 및 연구소가 등록 시 해당 특정 유저 결재권자 자동 추가
		if (jwt.deptId.slice(0, 5) == 'GUN30') {
			appArray = approvalTeamManagerSpecialInfoData('EMJ8105', appArray);		// 영업이 등록 시 김태호 부사장님 추가
		} else if (jwt.deptId.slice(0, 5) == 'GUN40') {
			appArray = approvalTeamManagerSpecialInfoData('kimjhv', appArray);		// 연구소가 등록 시 김재현 전무님 추가
		}

		gridViewPop1.setData2(appArray.concat(shaArray));
	}

    //조치담당자정보 자동 추가하기
	function approvalUserInfoData (appUserId, appArray) {
	    var formData = {
	        "userId" : appUserId,
	    }
	    postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
	    	if (data.resultList != '' && data.resultList!=null) {
	    		//조치결과 결자자 정보 가져오기
	    		let list = data.resultList[0];
	    		if (appArray.some(item => item.usrNm === list.usrNm)) {
	    			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
	    		} else {
	    			appArray.push({
		                        gb: "공유",
		                        usrNm: list.usrNm,
		                        name: list.name,
		                        jik: list.jik,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                    });
	    		}
	    	}
		});
		return appArray;
	}



    //담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        	}
		});
		return appArray;
	}

	 //특정담당자 정보 가져오기
	 function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        	}
		});
		return appArray;
	}

	function txtareaHeightResize(obj) {
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;
		if(rowCount < 4)
			obj.css('height', "96px");
		else
			obj.css('height', (rowCount * 19) + "px");
	}

	// 발생공급업체 검색
	function openClntSearch() {
		var paramObj = {
				"searchValue" :  '',
				"clntDivCd"   : ""
		}
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#popForm2 #vendCd').val(row.clntCd);
			$('#popForm2 #vendCdNm').val(row.clntNm);
		});
	}
	
	
	// 특정 조건에 따라 표시/숨김 제어
	function setMouseTrackerVisible(visible, text = '조치담당자만 결과 처리가능합니다....') {
		const $form = $('#popForm2'); // 특정 폼 대상

		if (visible) {
			// 이미 있으면 다시 append 하지 않음
			if ($('#mouseTrackerLabel').length === 0) {
				$('body').append('<div id="mouseTrackerLabel"></div>');
			}

			$('#mouseTrackerLabel')
				.text(text)
				.css({
					position: 'fixed',
					zIndex: 9999,
					pointerEvents: 'none',
					background: 'rgba(0,0,0,0.6)',
					color: '#fff',
					padding: '3px 6px',
					fontSize: '14px',
					borderRadius: '4px'
				})
				.show();

			// 이벤트 중복 방지를 위해 네임스페이스로 unbind → bind
			$form
				.off('mousemove.mouseTracker')
				.on('mousemove.mouseTracker', function (e) {
				$('#mouseTrackerLabel').css({
					top: e.clientY + 15 + 'px',
					left: e.clientX + 15 + 'px'
				});
			});

		} else {
			$form.off('mousemove.mouseTracker'); // 해당 폼에만 적용된 이벤트 제거
			$('#mouseTrackerLabel').remove();
		}
	}
</script>