<div id="qmpopFormQ01" class="popup_area of_a" style="width: 100%; height: 100%;">
   <div class="tit_contents">
      <h4 class="tit">요인별 발주 및 출장요청 등록</h4>
   </div>
   <form id="popFormQ01" onSubmit="return false;">
      <div class="form-group popup_table">
         <input type="hidden" id="fileTrgtKey"			name="fileTrgtKey">
         <input type="hidden" id="issFileTrgtKey"		name="issFileTrgtKey">
         <input type="hidden" id="pgmId"        		name="pgmId"   value="QM0101P01">
      <table>
         <colgroup>
            <col width="10%">
            <col width="15%">
            <col width="10%">
            <col width="16%">
            <col width="10%">
            <col width="14%">
            <col width="10%">
            <col width="15%">
         </colgroup>
         <tr>
         <th class="hit">회사</th>
         <td>
            <select id="coCd" name="coCd" data-kind="CO" class="form-control input-sm"  msg="회사" required >
            </select>
         </td>
         <th class="hit">작성자</th>
         <td>
            <div class="search_form">
               <input type="hidden" id="regId" name="regId" data-search="regId" msg="작성자">
               <input type="hidden" id="regDeptId" name="regDeptId" data-search="regDeptId" msg="작성자부서코드">
               <input type="text"   id="regNm" data-search="regNm" class="form-control" msg="작성자이름" onclick="openSecondUserSearch();" readonly>
               <a onclick="openSecondUserSearch();"><i class="i_search_w" id="userIdBtn"></i></a>
            </div>
         </td>
         <th>출장자</th>
         <td style="text-align:left;">
            <div id="BUSTCD-radioButtonContainer"></div>   
         </td>
         <th >관리번호</th>
         <td>
               <div class="search_form">
               <input type="text" id="reqNo" name="reqNo" readonly="readonly" >
               </div>
         </td>
         </tr>
         <tr>
         <th class="hit">발행일자</th>
         <td>
            <input id="ordrgDt" name="ordrgDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"   msg="발행일자"  date  required>
         </td>
         <th class="hit">사내요구일</th>
         <td>
            <input id="reqDt" name="reqDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"    msg="사내요구일"  date  required >
         </td>
         <th class="hit">고객요구일</th>
         <td>
            <input id="custReqDt" name="custReqDt"   msg="고객요구일"  date readonly style="color: red;" title="SalesCode를 다시 검색하면 고객요구일자가 변경됩니다.">
         </td>
         <th>수주번호</th>
         <td>
                  <input type="text" id="ordrsNo" name="ordrsNo" readonly="readonly">
         </td>
         </tr>
         <tr>
         <th class="hit">발행자</th>
         <td>
                  <div class="search_form">
                  <input type="hidden" id="ordrgId" name="ordrgId"  data-search="ordrgId" msg="발행자아이디" >
                     <input type="text"   id="ordrgNm" data-search="ordrgNm" class="form-control" msg="발행자" onclick="openFirstUserSearch();" readonly>
                     <a onclick="openFirstUserSearch();"><i class="i_search_w" id="userIdBtn"></i></a>
                  </div>
         </td>
         <th class="hit">요청구분</th>
         <td style="text-align:left;">
            <div id="REQCD-radioButtonContainer"></div>
         </td>
         <th>출장자명</th>
         <td>
               <input type="text" id="bustNm" class="form-control" name="bustNm" >
         </td>
         <th>대표도면번호</th>
         <td>
            <input type="text" id="matrDrwNo" name="matrDrwNo" readonly="readonly" >
         </td>
         </tr>
         <tr>
         <th class="hit">SalesCode</th>
            <td>
               <div class="search_form">
                     <input type="hidden" id="ordrsDiv" name="ordrsDiv" >
                     <input type="hidden" id="ordrsDivNm" name="ordrsDivNm" >
                     <input type="hidden" id="orgnSalesCd" name="orgnSalesCd" >
                     <input type="text" id="salesCd" name="salesCd" class="form-control" msg="salesCode" readonly="readonly" >
                     <a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
                  </div>
            </td>
         <th>사내작업</th>
         <td style="text-align:left;">
            <div id="INWKCD-radioButtonContainer"></div>
         </td>
         <th>출장장소(고객사)</th>
         <td>
               <input type="text" id="bustPe" name="bustPe" class="form-control">
         </td>
         <th>설비명</th>
         <td>
               <input type="text" id="eqpNm" name="eqpNm" readonly="readonly">
         </td>
         </tr>
         <tr>
         <th class="hit">분류</th>
         <td colspan= "3" >
            <div id="COBTP-radioButtonContainer"></div>
         </td>
         <th>고객사</th>
         <td>
               <input type="hidden" id="clntCd" name="clntCd" data-search="clntCd" msg="고객사코드">
            <input type="text" id="clntNm" name="clntNm" data-search="clntNm" msg="고객사" readonly="readonly">
         </td>
         <th>신작구분</th>
         <td>
            <input type="hidden" id="ordrsdtldiv20" name="ordrsdtldiv20">
            <input type="text" id="newCd" name="newCd" readonly="readonly" >
         </td>
         </tr>
         <tr>
         <th class="hit">일정지연상황</th>
         <td colspan= "3">
            <select id="scdSts" name="scdSts" data-kind="SCDSTS" data-search="scdSts" msg="일정지연상황" required>
               <option value="">지연상황 선택(필수)</option>
            </select>
         </td>
         <th>고객사PJT</th>
            <td>
                  <select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" >
                        <option value=""></option>
                  </select>
            </td>
         <th>문제등록번호</th>
         <td>
            <input type="text" id="workRptNo" name="workRptNo" readonly>
         </td>
         </tr>

      <tr>
         <th rowspan="1">등록 사유</th>
         <td rowspan="1" colspan= "3" style="text-align:left; vertical-align:top;">
            <div id="COBGB-checkboxContainer"></div>
         </td>
            
            <td colspan= 4>
               <div>
                  <table style="border:0px;">
                  <colgroup>
                     <col width="10%">
                     <col width="14%">
                     <col width="10%">
                     <col width="15%">
                  </colgroup>
               <tr>
				<th>발생공급업체</th>
				<td colspan="3">
					<input type="hidden" id="vendCd" name="vendCd" data-search="vendCd" msg="발생공급업체">
					<div class="search_form">
						<input type="text" id="vendCdNm" name="vendCdNm" data-search="vendCdNm" onkeyup="event.keyCode == 8 ? vendCd.value='' : '' " style="width: 100%;">
						<a onclick="openClntSearch();"><i class="i_search_w"></i></a>
					</div>
				</td>
               </tr>            
               <tr>
                  <th class="hit">기계분류</th>
                  <td colspan="1">
                        <div>
                           <select id="mcPartCdReq" name="mcPartCd" data-kind="MCPARTCD" required msg="기계분류">
                        <option value="">선택(필수)</option>
                     </select>
                        </div>
                  </td>
                  <th>문제 기계분류</th>
                  <td colspan="1">
                        <input type="text" id="mcPartCdIssNm" name="mcPartCdIssNm" readonly>
                        </div>
                  </td>
         </tr>			        
               <tr>
                  <th class="hit">영향도</th>
                  <td colspan="1">
                        <div>
                           <select id="impactCdReq" name="impactCd" data-kind="IMPACTCD" required msg="영향도">
                        <option value="">선택(필수)</option>
                     </select>
                        </div>
                  </td>
                  <th >문제 영향도</th>
                  <td colspan="1">
                        <div>
                        <input type="text" id="impactCdIssNm" name="impactCdIssNm" readonly>
                        </div>
                  </td>
               </tr>
               <tr>
                  <th class="hit">중요도</th>
                  <td colspan="1">
                        <div>
                           <select id="importantCdReq" name="importantCd" data-kind="IMPORTANTCD" required msg="중요도">
                        <option value="">선택(필수)</option>
                     </select>
                        </div>
                  </td>
                  <th>문제 중요도</th>
                  <td colspan="1">
                        <div>
                        <input type="text" id="importantCdIssNm" name="importantCdIssNm" readonly>
                        </div>
                  </td>
               </tr>
               
               
               
         <tr>
            <th class="hit">조치 도면 반영 일시</th>
            <td colspan="3">
               <input type="datetime-local" id="actCompDttm" name="actCompDttm"   required msg="조치자 도면반영일시"  style="height:25px" max="9999-12-31T00:00"  onfocus="setCurrentDateTime(this)">
            </td>
      </tr>
         <tr>
            <th class="hit">조치  파일 저장명</th>
            <td colspan="3">
               <textarea  class="form-control" id="actCompDgnFileNm" name="actCompDgnFileNm" rows="4" maxlength="1000" required msg="조치  파일 저장명" placeholder="예: 24011-01NVFIP-1230-001R1.dwg
      24011-01NVFIP-2530-001R1.dwg 처럼 여기에 저장된 도면 파일명을 입력하세요.
   도면수정이 없거나 관련 없으면  '해당 사항 없음'으로 입력하세요."></textarea>
            </td>
         </tr>
         
               <tr class="reqResultArea">
                        <th style="color:blue;" class="hit">조치자 투입공수</th>
                        <td>
                           <input type="text" id="actMh" name="actMh" comma onkeyup="onlyNumber(this)" required msg="조치자 투입공수" placeholder="조치자 투입 Day/Man를 입력">
                        </td>
                  <th>실적번호</th>
                        <td>
                     <input type="text" id="rsltNo" name="rsltNo" readonly="readonly">
                     <input type="hidden" id="sameTimeResult" name="sameTimeResult" readonly="readonly">
                     </td>
               </tr>
               <tr class="reqResultArea">
                  <th class="hit">원인</th>
                  <td colspan="3">
                  <div class="aiContainer">
                     <textarea  class="form-control" id="measRst" name="measRst" rows="4" maxlength="1000" required msg="원인" placeholder="근본 원인을 입력"></textarea>
                     <div class="ai-mark" onclick="openapi('measRst');">AI</div>
                  </div>
                  </td>
               </tr>
               <tr class="reqResultArea">
               <th class="hit">결과/근본대책</th>
                  <td colspan="3">
                  <div class="aiContainer">
                        <textarea  class="form-control" id="resltRst" name="resltRst" rows="4" maxlength="1000" required msg="처리 결과" placeholder="결과/근본대책을 입력하세요"></textarea>
                     <div class="ai-mark" onclick="openapi('resltRst');">AI</div>
                  </div>
                  </td>
               </tr>
               
               <!-- 공유대상자-->
                  <tr style="height:30px;">
                     <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
                     <td colspan="3">
                        <div class="add_btn_small pdl10" id="plus-minus">
                           <a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;" authchk>+</a>
                           <a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;" authchk>-</a>
                     </div>
                     </td>
                  </tr>
                  <tr>
                     <td colspan="4">
                     <div>
                        <div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 300px; width: 100%;" ></div>
                        </div>
                  </td>
                  </tr>
               
            </table>
      </div>
         </td>
      </tr>
         <tr>
         <th >비고</th> <!-- 기타선택시 비고 입력값 필수 -->
         <td colspan= "7" style="text-align:left;">
         <div class="aiContainer">
               <textarea class="form-control" id="reqRmk" name="reqRmk" style="height: 150px;" maxlength="1000"></textarea>
            <div class="ai-mark" onclick="openapi('reqRmk');">AI</div>
         </div>
         </td>
         </tr>
      </table>
   </form>


   <!-- 공통 파일 영역-->
    <div id="fileList_area"></div>
   <!-- 공통 파일 영역 -->
   <div>
   <br>
   <br></div>
    <!-- 하단 버튼 -->
   <div class ="popup_bottom_btn">
      <button type="button" id="actionBtn" authChk>결과일괄등록</button>
      <button type="button" id="actionBtn2" authChk>요청서등록(구매)</button>
      <button id="reportRegBtn" class="report_btn" type="button" onclick="setReportMain('Report');" authChk>발주요청서출력</button>
      <button type="button" class="close_btn"
         onclick="modalStack.close();">닫기</button>
   </div>

      <div class="overlay"></div>

 </div>
<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
    var approvalList = null;
    var reqNo = null;
    var tReqNo = null; //insert시 reqNo값 가지고오기 위함
    var clntPjt = "";
    var teleNo = ""; //카카오 접수자 전화번호변수
	//분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 start
	const standardDate = "2024-07-09"; //발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
	var currentDate = ""; //발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
	//분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 end
    const currFormId = "#popFormQ01";	//현재화면의 Form ID,  poup 화면을 중복으로 Call 할시 필드명 중복으로 구분 안됨
    const currDivId = "#qmpopFormQ01";		//현재화면의 Form ID,  poup 화면을 중복으로 Call 할시 필드명 중복으로 구분 안됨
    
	//담당자가 바뀌었을때 문제등록 사유 유지하기 위함 변수 설정
    var tempCOBTP =  ''; //$("input[name='COBTP']:checked").val();
    var tempCOBTPTxt = ''; //$("input[name='COBTP']:checked").attr('data-label');
    var tempCODECOBGB = ''; //$("input[name='CODECOBGB']:checked").val();
    var tempCODECOBGBTxt =''; // $("input[name='CODECOBGB']:checked").attr('data-label');

    // 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
	var kakaoErr = [];


	// 크기 조절할 textarea ID 리스트
	const textAreas = [
	    '#actCompDgnFileNm', // 조치 파일 저장명
	    '#measRst',  // 원인
	    '#resltRst',  // 처리 결과
	    '#reqRmk'  // 비고
	];
	
    var userDeptId = "";	//부서코드 full
    var userDept = "";		//부서코드 5자리
	var fromJobType = "REQ"; //default 발주요청서 작업구분--> REQ,  이슈에서 처리할경우 ISS//작업 구분 발주요청서가 시작이면 default 값인 REQ로 작업 진행하고 아니면 ISS가 파라메터로 넘오옴
	if (modalStack.last().paramObj.issNo != undefined && modalStack.last().paramObj.issNo != "") fromJobType = "ISS"; //기존 등록자료 수정모드로 진입시 처리하기 위함
	if (modalStack.last().paramObj.fromJobType != undefined) fromJobType = modalStack.last().paramObj.fromJobType;

   var gridViewPop = {
      initView : function() {
           this.target = new ax5.ui.grid();
           this.target.setConfig({
               showRowSelector: true,
               multipleSelect: false,
               sortable: false,
                target: $('[data-ax5grid="first-grid-modal"]'),
                header: {
                   align: "center",
                   selector: true
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
               mergeCells : ["gb"],
                },
            page : {
               navigationItemCount : 10,
               height : 30,
               display : true,
               firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
               prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
               nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
               lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
               onChange : function() {
                  gridView.setData(this.page.selectPage);
               }
            },
             columns : [
                   {key: "gb",               label: "구분",         align: "center",   width: 40},
                    {key: "sanctnSn",          label: "순번",       align: "center",   width: 50},
                    {key: "coCd",               label: "coCd",      align: "center",   width: 50, hidden: true},
                       {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                       //{key: "wbsSharngUserId",   label: "ID",         align: "center",   width: 130, hidden: false},
                       {key: "usrNm",            label: "ID",         align: "center",   width: 130, hidden: true},
                       {key: "empNo",            label: "사원번호",    align: "center",   width: 130, hidden: true},
                       {key: "name",             label: "성명",         align: "center",   width: 80},
                       {key: "jik",                label: "직위",         align: "center",   width: 60},
                       {key: "creatDttm",         label: "요청일자",    align: "center",   width: 90},
                       {key: "todoCfDt",            label: "확인일자",      align: "center",   width: 130},
                       {key: "todoCfOpn",         label: "확인의견",    align: "left",     width: 200},
//                        {key: "telNo",            label: "H.P",      align: "center",   width: 130},
                       {key: "todoKey",            label: "todoKey",      align: "center",   width: 130, hidden: true},
                       {key: "sanctnSttus",         label: "sanctnSttus",      align: "center",   width: 130, hidden: true},
                       {key: "todoId",            label: "todoId",      align: "center",   width: 130, hidden: true},
                       {key: "flag",               label: "flag",      align: "center",   width: 130, hidden: true}
                     ]
               });
                 return this;
              },

              setData : function(_pageNo) {
                 var targetObj = this.target;
                 var formData = {
                         "fileTrgtKey" : fileTrgtKey,
                         "reqNo" : reqNo,
                         "pageNo" : _pageNo + 1
                  }

                  postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
                     try {
                        var list = data.result;
                        targetObj.setData({
                            list : list,
                            page : { totalElements : list.length }
                        });

                        // 수주취소, 가수주로 등록된 salesCode는 발주요청서출력 불가
                        if ($('#ordrsDiv').val() == "ORDRSDIV8" || $('#ordrsDiv').val() == "ORDRSDIV9") { 
                           $('#reportRegBtn').hide();
                        } else {
                           $.each(list, function(idx, elem){
                              if(elem.sanctnSn == 1 && elem.gb == "결재") {
                                 $('#reportRegBtn').show();
                              }
                           });
                        }
                        gridResize(gridViewPop, list.length); //그리드 높이 조정
                     } catch {
                        alert("오류 발생!! 전산실 연락 바랍니다", error.message);
                        return null; // 오류 발생 시 null 반환
                     } finally {
                        // console.log("함수 실행 완료.");
                     }
                  });
              },

              setData2 : function(_list) {
                  var targetObj = this.target;
                  targetObj.setData({
                        list : _list,
                        page : { totalElements : _list.length }
                  	});
					gridResize(gridViewPop, _list.length); //그리드 높이 조정
              },
              setData3 : function(_pageNo) {
                 var targetObj = this.target;
                 var paramObj = { "userId": jwt.userId
                             	, "appDiv": 'APPDIV02'
                 				};
                 postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
                    try {
                        var list = data.result;
                        targetObj.setData({
                            list : list,
                            page : { totalElements : list.length }
                        });
                        
                        gridResize(gridViewPop, list.length); //그리드 높이 조정
                    } catch {
                        alert("오류 발생!! 전산실 연락 바랍니다", error.message);
                        return null; // 오류 발생 시 null 반환
                    } finally {
                        // console.log("함수 실행 완료.");
                    }
                });
             }
     }

   //************************************************************************************
   /*radio button,  checkbox 공통코드에서 가져오기 start
    *  아래의 코드가 HTML에 추가함
    *  <div id="COBGB-checkboxContainer"></div>
    *  <div id="COBTP-radioButtonContainer"></div>
    */
   //************************************************************************************

   function createRadioOptions(groupName, _type) {
    	//분류(COBTP) 이면 codeEtc가 REQ인 자료만 생성 함.
		let codeEtc = '';
		//발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
		if (groupName=='COBTP') {
    		if (currentDate > standardDate) {
    			codeEtc = fromJobType;
    		} else {
    			codeEtc = '';
    		}
    	}
      var param = {
            "codeKind" : groupName,
            "codeEtc"  : codeEtc
      };
      postAjaxSync("/admin/cm/cm05/selectChildCodeList", param , null,  function(data){
         const codeList = data.childCodeList;
         var container = $(currFormId +' #' + groupName + '-radioButtonContainer');
         container.empty();
         var typeStr = _type =="radio" ? "radio" : "checkbox";
         codeList.forEach(item => {
            const iHtml = '<td><input type="' + typeStr  + '" id="' + item.codeId +
                                          '" name="' + item.codeKind +
                                         '" value="' + item.codeId +
                                    '" data-label="' + item.codeNm +
                          '" onchange="fnc(this)"> ' + item.codeNm + ' </td>';
            container.append(iHtml);
         });

         if (actionType == "C") {	//신규등록인경우 선택 분류코드 제거하기
	         //업무(정상)=COBTP00 은 생산팀 전용 설정
	         if (userDept != 'GUN60') $('#COBTP00').closest('td').remove();
// 			 A/S(유상) = COBTP04 , A/S(무상)=COBTP05 은 영업팀 전용 설정
// 	         if (userDept != 'GUN30') {
// 	        	 $('#COBTP04').closest('td').remove();
// 	        	 $('#COBTP05').closest('td').remove();
// 	         }
         }
      })
   }

	function createCheckBox(deptCode) {
		if (deptCode == 'TRN30') deptCode = 'TRN50';	//트루넷직접매출
		if (deptCode == 'GUN70') deptCode = 'GUN60';	//생산관리
		if (deptCode == 'GUN90') deptCode = 'TRN50';	//구매협력업체
		if (deptCode == 'GUN50') deptCode = 'TRN50';	//구매외주팀 (건양ITT)
		if (deptCode == 'GUN95') deptCode = 'TRN50';	//실적관리용 (건양ITT)
		if (deptCode == 'GUN80') deptCode = 'GUN40';	//전산실
		if ($(currFormId +' #ordrgId').val() == 'gyrsult10') deptCode = 'GUN40';	//외부설계

		$(currFormId +' #COBGB-checkboxContainer').empty();

		//발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함 start
		var codeEtc = fromJobType;
   		if (currentDate > standardDate) {
   			codeEtc = fromJobType;
   		} else {
   			codeEtc = '';
   		}
		//발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함 start

		var param = {
			"userDept" : deptCode,
			"codeEtc"  : codeEtc
		};

		postAjaxSync("/admin/cm/cm05/selectCheckboxList", param , null,  function(data){
			var codeList = data.childCodeList;
			var container = $(currFormId +' #COBGB-checkboxContainer');
			var lastKind = '';
			const table = $('<table>').appendTo(currFormId +' #COBGB-checkboxContainer')
			var tableRow = '';
			$.each(codeList, function (index, item){
			   if (lastKind != item.codeKind) {
			      tableRow = $('<tr>').appendTo(table);
			      var trElement = $('<tr>');
			      $('<th>').attr('rowspan', item.rowCnt).css('width', '90').text(item.codeDesc).appendTo(tableRow);
			      lastKind = item.codeKind;
			   } else {
			      tableRow = $('<tr>').appendTo(table);
			      var trElement = $('<tr>');
			   }
			   const comboName= "CODECOBGB";
			   const iHtml =
			     '<input type="radio" id="' + item.codeId +
			                   '" name="' + comboName +
			                  '" value="' + item.codeId +
			               '" data-label="' + item.codeNm +
			        '" onchange="fnc(this)" style="margin-left:20px"> ' + item.codeNm + '\n';
             let etcInput = '';
             if (item.codeId.length > 2) {
	             if (item.codeId.slice(-2) =='99'){
	            	 etcInput =
	            		 '<span id="etcInputWrapper" style="display:none; margin-left:5px;">' +
	            	     '<input type="text" id="etcInput" name="etcInput" msg="기타사유" placeholder="기타사유" style="width:150px;">' +
	            	     '</span>\n';
	             }
             }

			   const tdElement  = $('<td>').attr('style', 'text-align:left;height:20px;').text('').appendTo(tableRow);
			   tdElement.append(iHtml + etcInput);

			});
		})
		
		gridViewPop.initView();
		const grdiHeight = $(currFormId +' #COBGB-checkboxContainer').height()-(260);
		gridViewPop.target.setHeight(grdiHeight< 140 ? 140 : grdiHeight);
   }

   function fnc(thisButton) {
       const inputType = thisButton.type;
       const inputName = thisButton.name;
       const inputvalue = thisButton.value;
//       const inputType = $(thisButton).attr('type');
//       if (inputType === 'radio') {
//          console.log(thisButton.dataset.label + ' radio button. = ' + $("input[name='COBTP']:checked").val() + ' 선택');
//       } else if (inputType === 'checkbox') {
//          console.log(thisButton.dataset.label + ' checkbox. = ' + thisButton.value + '의 상태는 ' + thisButton.checked);
//       }
      if (thisButton.id == 'COBTP99') {
         $("#COBGB9999").prop("checked", $("#COBTP99")[0].checked);
      }

      if (inputName === 'CODECOBGB' && inputvalue.length > 2) {
		  const etcField = inputvalue.slice(-2); 
      
	       if (etcField == '99') {
	         $('#etcInputWrapper').show();
	         $('#etcInput').focus().attr('required', true);
	       } else {
	         $('#etcInputWrapper').hide();
	         $('#etcInput').val('').removeAttr('required', 'true');
	       }
      }
      
      const checkCOBTP = ['COBTP00', 'COBTP01', 'COBTP04', 'COBTP06', 'COBTP08', 'COBTP09'];
      // 키가 목록에 있는 경우 체크하기
      if (checkCOBTP.includes($('input[name="COBTP"]:checked').val())) {  //분류가 출도(정상)	 A/S(유상)	 SPARE(유상)	 고객E/O	 설치시운전(정상) 인경우 자동 등록
    	  let cobtpTxt = $('input[name="COBTP"]:checked').data('label');
    	  if (cobtpTxt == undefined) cobtpTxt='';
    	  
    	  let codecobgbTxt = $('input[name="CODECOBGB"]:checked').data('label');
    	  if (codecobgbTxt == undefined) codecobgbTxt='';
    	  
    	  $(currFormId + ' #measRst').val(cobtpTxt + '\n' + codecobgbTxt);
    	  $(currFormId + ' #resltRst').val(cobtpTxt + '\n' + codecobgbTxt);
      }
   }
/*************************************************************************************
 * radio button,  checkbox 공통코드에서 가져오기 end
 */
//*************************************************************************************
	$(document).ready(function() {
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
        issFileTrgtKey = modalStack.last().paramObj.issFileTrgtKey;
		reqNo = modalStack.last().paramObj.reqNo;
        if (reqNo == undefined) fileTrgtKey = 0; //이슈에서 넘어온 fileTrgtKey는 이슈등록에 대한 번호임.
		$(currFormId + " #fileTrgtKey").val(fileTrgtKey);


		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);


		$(currFormId + " #coCd").prop("disabled", true);
		$(currFormId + " #clntPjt").css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		//발행일자//
		$(currFormId + " #ordrgDt").datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true})
								   .datepicker("setDate", new Date());

		//요구일정//
		$(currFormId + " #reqDt").datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true})
								 .datepicker("setDate", new Date());

		//요구일정//
// 		$(currFormId + " #custReqDt").datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true});
		//분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 start
		currentDate =  $(currFormId + " #ordrgDt").val(); //발주요청서 처리 절차변경일자기준 20240708일자로 코드 변경처리함
		//분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 end

	    selectAuth(jwt.deptId); //발행자 부서코드

		createRadioOptions('COBTP', "radio");  //분류 자동 생성
		createRadioOptions('BUSTCD', "checkbox");  //출장자 구분
		createRadioOptions('INWKCD', "checkbox");  //사내작업 구분
		createRadioOptions('REQCD', "radio");  //요청구분 구분
		authChk();                  // 권한체크
		
		// if (modalStack.last().paramObj.actDeptId == undefined){
		// 		alert("비정상적으로 실행되었습니다.");
		// 		modalStack.close();
		// 	return false;
		// }
		$(currFormId + " #reportRegBtn").hide();  //발주요청서 출력버튼 기본은 숨김 처리--> 1번결재자가 결재완료 되면 보임. 2023.11.27 정상훈차장 요청
		let savedSubCd = ""; // 등록사유 변수
		let savedEtcInput = ""; // 등록사유 변수
		if (actionType == "C") {
			$(currFormId + " #ordrgDt").parent('td').addClass('no-click'); //발행일자
			$(currFormId + " #regNm").parent('div').addClass('no-click');  //작성자
			if (fromJobType == "REQ") {
				$(currFormId + " #ordrgId").val(jwt.userId);
				$(currFormId + " #ordrgNm").val(jwt.userNm);
				$(currFormId + " #regId").val(jwt.userId);
				$(currFormId + " #regNm").val(jwt.userNm);
			} else { //"ISS" 인경우 문제관리정보를 불러옴
				$(currFormId + " #regId").val(jwt.userId);
				$(currFormId + " #regNm").val(jwt.userNm);
				var formData = {
					"fileTrgtKey" : issFileTrgtKey
				}
				postAjaxSync("/user/wb/wb24/selectIssueInfo", formData, null, function(data) {
					// key와 태그 id의 매핑 객체 정의
					const keyToTagMap = {
						actId          : "ordrgId",
						actNm          : "ordrgNm",
						issNo          : "workRptNo",
						newCdNm        : "newCd",
						mcPartCdNm     : "mcPartCdIssNm",
						importantCdNm  : "importantCdIssNm",
						impactCdNm     : "impactCdIssNm"
					};
					let title = '';
					let contents = '';
					//부서별 발주요청서 등록사유 자동 생성하기
					if (data.result) {
						$.each(data.result, function(key, value) {
							// 문제에서 발주요청서 등록 시 기계분류, 영향도, 중요도 셋팅X 사용자가 직접 선택하게
							if (key === 'mcPartCd' || key === 'impactCd' || key === 'importantCd') {
								return true;
							}
							const tagId = keyToTagMap[key] || key;
							const $elem = $(currFormId + ' #' + tagId);

							if ($elem.length) {
								$elem.val(value);

								if ($elem.is('[comma]')) {
										onlyNumber($elem[0]);
								}
							}
							if (key == 'salesCd'){$('#matrDrwNo').val(value);} // 도면번호 처리
							if (key == 'actDeptId'){selectAuth(value)};
							if (key == 'subCd'){savedSubCd = value;}   // 등록사유 저장해놓고 나중에 등록사유 태그쪽에 값 넣기
							if (key == 'etcInput'){savedEtcInput = value;}   // 등록사유 저장해놓고 나중에 등록사유 태그쪽에 값 넣기
							if (key == 'issSj') {title = value;}   // 제목 처리
							if (key == 'issCnts') {contents = value;} // 내용 처리
						});
						// 제목과 내용을 합쳐서 reqRmk 필드에 설정
						if (title !== '' || contents !== '') {
							let tempRmk = "제목:" + title + "\n\n" + "내용:" + contents;
							$(currFormId + " #reqRmk").val(tempRmk);
							$(currFormId + " #salesCd").parent('div').addClass('no-click');
						}
					}
				});
			}
           //REQ, ISS 에 따라 부서가 달라지므로 여기에 위치시킴
            createCheckBox(userDept);   //부서별 장애원인 자동 생성
		      gridViewPop.setData3();	  //결재라인에 등록된 결재선 가져오기

	         //발주요청서 발행 btn 없애기~입력시에는 사용 안함
	         $(currDivId + ' #reportRegBtn').remove();

	         $(currDivId + ' #actionBtn').text("결과일괄등록");
	         $(currDivId + ' #actionBtn').on("click", function() { insertQualityReq('결과일괄등록');  });
	         
	         $(currDivId + ' #actionBtn2').text("요청서등록(구매)");
	         $(currDivId + ' #actionBtn2').on("click", function() { insertQualityReq('결과분리등록'); });

            //등록사유체크하기(ISS=이슈에서 시작하면 이슈의 등록정보를 재활용)
            if (fromJobType == "ISS") {
               if (savedSubCd) {
                  $(currFormId + ' #' + savedSubCd).prop("checked", true);	//문제에서 조회한 등록사유 설정
               }
               $(currFormId + ' #COBTP03').prop("checked", true);	//분류 --> 장애
            }


			//문제등록사유 코드의 끝 2자리가 99이면 기타 이며, 기타인경우 사유가 있음
			if (savedSubCd.slice(-2) === '99') {
				$('#popForm2 #etcInputWrapper').show();
				$('#popForm2 #etcInput').val(savedEtcInput).attr('required', true);
			} else {
				$('#popForm2 #etcInputWrapper').hide();
				$('#popForm2 #etcInput').val('').removeAttr('required');
			}

		} else if (actionType == "U" || actionType == "S" || actionType == "T" ) {
		     $(currDivId + ' .tit').text('요인별 발주 및 출장요청 수정');

	         if (fileTrgtKey == '0' || fileTrgtKey == '' ) {
	        	 alert('정보 불일치가 발생되었습니다.  전산실 연락 바랍니다.');
	        	 return false;
	         }

	         if (reqNo == '0' || reqNo == '' || reqNo == undefined) {
	        	 alert('자료조회 불가. 정보 불일치가 발생되었습니다.  전산실 연락 바랍니다.');
	        	 return false;
	         }

	         selectQtyReqInfo();
	         if (actionType == "S" || actionType == "T" ) {	//결재모드인면 필수입력 제외처리 (조치 도면 반영 일시, 조치 도면 파일 저장명)
		         $(currDivId + ' .tit').text('요인별 발주 및 출장요청 조회');
		         $(currFormId + ' #actCompDgnFileNm').removeAttr('required');
		         $(currFormId + ' #actCompDttm').removeAttr('required');
	         }

	         $(currFormId + ' input#coCd').attr('required', 'required');
	         $(currFormId + ' #coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	         $(currFormId + ' #salesCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

	         $(currFormId + " #ordrgDt").prop("disabled", true);
// 	         $(currFormId + " #reqDt").prop("disabled", true);
             $(currFormId + " #regNm").prop("disabled", true);
	         $(currFormId + " #ordrgNm").prop("disabled", true);
	         gridViewPop.initView().setData(0);

	         $(currDivId + " #actionBtn").text("수정");
	         $(currDivId + " #actionBtn").on("click", function() { updateQualityReq(); });
	         $(currDivId + " #actionBtn2").remove();

			 //모든 입력 기능 통제하기
			 disableFormAll('popFormQ01');
		}
		// TODO 리스트에서 호출 시 공유 : actionType:T  결재: actionType:S 처리 부분
		var _todoViewMode =modalStack.last().paramObj.todoView;
		if (_todoViewMode != undefined && _todoViewMode == "INQ") {
			$(currDivId + ' .tit').text('요인별 발주 및 출장요청 조회');

			$(currDivId + ' #actionBtn').remove();
			$(currDivId + " #plus-minus").remove();
			 //모든 입력 기능 통제하기
			 disableFormAll('popFormQ01');

			//input readonly, radio.checkbox disabled
			$.each($(currFormId + ' select, input, textarea'), function(idx, elem){
	            var id = $(elem).attr("ID");
	            if( id ) {
	               var eleId = currFormId + ' #'+id;
	               if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
	               if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
	               if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	               if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
	            }

			});


		}

		//문제에서 넘어온것이 아닌 정상 출도인경우 분류코드는 필수 아님
		if (fromJobType != 'ISS'){
			$(currFormId + " #mcPartCdReq").closest('td').prev('th').removeClass('hit');
			$(currFormId + " #mcPartCdReq").removeAttr('required', 'true');
			$(currFormId + " #mcPartCdReq").css({'background-color':'#e6e6e6', 'pointer-events':'none'})
			$(currFormId + " #impactCdReq").closest('td').prev('th').removeClass('hit');
			$(currFormId + " #impactCdReq").removeAttr('required', 'true');
			$(currFormId + " #impactCdReq").css({'background-color':'#e6e6e6', 'pointer-events':'none'})
			$(currFormId + " #importantCdReq").closest('td').prev('th').removeClass('hit');
			$(currFormId + " #importantCdReq").removeAttr('required', 'true');
			$(currFormId + " #importantCdReq").css({'background-color':'#e6e6e6', 'pointer-events':'none'})
		}
		

	    if (modalStack.last().paramObj.callRoute != "대시보드문제현황에서실행하면이슈번호링크제거하기") {
			//이슈번호 클릭시 이슈내용 조회화면 호출하기
	        $('#popFormQ01 #workRptNo').on("click", function() {
	        	if (this.value) {
	            	// 문제관리에서 계획 문제 수정 구분자는 "U3"
	                var paramObj = {
	                        "actionType"     : "I",
	                        "coCd"           : $(currFormId + ' #coCd').val(),
	                        "salesCd"        : $(currFormId + ' #salesCd').val(),
	                        "issFileTrgtKey" : $(currFormId + ' #issFileTrgtKey').val(),		//문제번호???? TB_WB24M02.FILE_TRGT_KEY = #{fileTrgtKey}
	                    };
	                openSecondModal("/static/html/user/wb/wb24/WB2401P11.html", 1200, 870, "WBS 문제 현황 확인", paramObj, function (){
	                });
	        	}
	        });
	    }
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
            fileTrgtTyp		: $(currFormId + " #pgmId").val(),
            fileTrgtKey		: fileTrgtKey,
            todoNo			: $(currFormId + " #reqNo").val(),		//결재정보처리를 위함
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		// 크기 조절할 textarea ID 리스트
		$(textAreas.join(',')).keydown(function () {
			// 각 textarea에 대해 크기 조절 함수 호출
			    txtareaHeightResize($(this));
		});
		
		let currDate = new Date().format("yyyy-MM-dd");
		// 사내요구일자는 현재일 이전은 등록안되게 차단하기 2025.03.10 남장섭
		$('#reqDt').on('change', function() {
			if ($('#reqDt').val() < currDate) {
				alert('사내요구일자는 이전일자로 설정 불가합니다.');
				$('#reqDt').datepicker("setDate", currDate);
			}
		});

//       if (approvalList.length == 0) {
//          alert("결재선 지정 정보가 존재하지 않습니다. 기준관리에서 결재선을 추가 하세요");
//       }
   });



   //결재 여부
   function approvalYn() {
      var gridList = gridViewPop.target.getList();
      var inCnt = 0;
      if( gridList.length > 0 ) {
           var msgArr = [];
           $.each(gridList, function (idx, elem) {
              //결재자가 본인이 아니면서 상태가 Y인 경우
              if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
           })
      }
      return inCnt;
   }

   // 공유대상자 추가//
    function insertShareUserModal() {
       if( approvalYn() ) {
         alert("결재가 이미 진행중입니다.");
         return;
      }

        var paramObj = {};
        var appshaList = gridViewPop.target.list;
        paramObj["coCd"] = $(currFormId + ' #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $(currFormId + ' #ordrgId').val();
        paramObj["userNm"] =  $(currFormId + ' #ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
              }).map(function(item) {
                      return {
                          gb: "결재"
                        , id: item.usrNm
                        , text: item.name
                        , parent: item.jik
                        , deptNm: item.dtNm
                        , telNo: item.telNo
                        , offTelNo: item.offTelNo
                        , email: item.email
                        , id: item.todoId
                        , todoKey: item.todoKey
                        , sanctnSn: item.sanctnSn
                        , sanctnSttus: item.sanctnSttus
                        , todoCfDt: item.todoCfDt
                        , todoCfOpn: item.todoCfOpn
                        , flag: item.flag
                        , coCd: item.coCd
                    };
              });
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
              }).map(function(item) {
                    return {
                        gb: "공유"
                      , id: item.usrNm
                      , text: item.name
                      , parent: item.jik
                      , deptNm: item.dtNm
                      , telNo: item.telNo
                      , offTelNo: item.offTelNo
                      , email: item.email
                      , id: item.todoId
                      , todoKey: item.todoKey
                      , sanctnSn: item.sanctnSn
                      , sanctnSttus: item.sanctnSttus
                      , todoCfDt: item.todoCfDt
                      , todoCfOpn: item.todoCfOpn
                      , flag: item.flag
                      , coCd: item.coCd
                  };
            });

        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//           console.log('결재라인 : ', approvalGrid.target.list);
//           console.log('공유라인 : ', shareGrid.target.list);

          var appArray = approvalGrid.target.list.map(function(item) {
               return {
                       gb: "결재"
                     , usrNm: item.id
                     , name: item.text
                     , jik: item.parent
                     , dtNm: item.deptNm
                     , telNo: item.telNo
                     , offTelNo: item.offTelNo
                     , email: item.email
                     , todoId: item.id
                     , todoKey: item.todoKey
                     , sanctnSn: item.sanctnSn
                     , sanctnSttus: 'N'	//신규 등록은 무조건 미결상태임
                     , todoCfDt: item.todoCfDt
                     , todoCfOpn: item.todoCfOpn
                     , flag: item.flag
                     , coCd: item.coCd
               };
         });
          var shaArray = shareGrid.target.list.map(function(item) {
             return {
                       gb: "공유"
                     , usrNm: item.id
                     , name: item.text
                     , jik: item.parent
                     , dtNm: item.deptNm
                     , telNo: item.telNo
                     , offTelNo: item.offTelNo
                     , email: item.email
                     , todoId: item.id
                     , todoKey: item.todoKey
                     , sanctnSn: item.sanctnSn
                     , sanctnSttus: 'N'	//신규 등록은 무조건 미결상태임
                     , todoCfDt: item.todoCfDt
                     , todoCfOpn: item.todoCfOpn
                     , flag: item.flag
                     , coCd: item.coCd
               };
         });
           gridViewPop.setData2(appArray.concat(shaArray));

//           approvalGrid.id //userId
//           approvalGrid.text //성명
//           approvalGrid.parent //직책
//           approvalGrid.deptNm //부서
//           approvalGrid.telNo
//           approvalGrid.offTelNo
//           approvalGrid.email

//           shareGrid.id //userId
//           shareGrid.text //성명
//           shareGrid.parent //직책
//           shareGrid.deptNm //부서
//           shareGrid.telNo
//           shareGrid.offTelNo
//           shareGrid.email
        });

    }

    function deleteShareUser(){

       if( approvalYn() ) {
         alert("결재가 이미 진행중입니다.");
         return false;
      }

       var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
       if( isNaN(selRow) ) {
//           alert("선택된 행이 없습니다.");
          return false;
       } else {
             if( selRow > -1 ) {
                //gridViewPop.target.removeRow(selRow);
                var todoKey = gridViewPop.target.getList()[selRow].todoKey;
                var gridList = gridViewPop.target.getList("selected")[0];
            if( typeof(todoKey) == "undefined" ) {
               gridViewPop.target.removeRow(selRow);
               $.gridNoSet(gridViewPop, "sanctnSn");
            } else {
               var paramObj = {
                     todoNo: $(currFormId + " #reqNo").val(),
                     todoKey: gridList.todoKey,
                     sanctnSn: gridList.sanctnSn,
                     todoDiv1CodeId: gridList.todoDiv1CodeId,
                     todoDiv2CodeId: gridList.todoDiv2CodeId
               }
//                if( confirm("선택행을 삭제하시겠습니까?")) {
                  deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
                     if (data.resultCode == 200) {
//                         alert(data.resultMessage);
                        gridViewPop.setData(0);
                     } else {
                        alert("삭제중 오류가 발생했습니다");
                     }
                  });
//                }
            }
          }
       }
    }


    // 발행자 검색 //
    function openFirstUserSearch() {
       if (actionType == "C"){
    	    tempCOBTP = $("input[name='COBTP']:checked").val() == undefined ? tempCOBTP : $("input[name='COBTP']:checked").val();
    	    tempCOBTPTxt = $("input[name='COBTP']:checked").val() == undefined ? tempCOBTPTxt : $("input[name='COBTP']:checked").attr('data-label');
    	    tempCODECOBGB = $("input[name='CODECOBGB']:checked").val() == undefined ? tempCODECOBGB : $("input[name='CODECOBGB']:checked").val();
    	    tempCODECOBGBTxt = $("input[name='CODECOBGB']:checked").val() == undefined ? tempCODECOBGBTxt : $("input[name='CODECOBGB']:checked").attr('data-label');
             var paramObj = {
                  "coCd" : $(currFormId + ' #coCd').val(),
                "userId" : $(currFormId + ' #ordrgId').val(),
                "userNm" : $(currFormId + ' #ordrgNm').val(),
               "useYn": "Y"
             };
             openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
	             var checkedId = tree.get_checked()[0];
	             var checkedNode = tree.get_node(checkedId);
	             
	             $(currFormId + ' #ordrgId').val(checkedNode.id);
	             $(currFormId + ' #ordrgNm').val(checkedNode.text);
	
	             //발행자에 따라 등록사유 선택항목 재생성 작업
	             //if (tempActId.slice(0,7) == 'gyrsult') return false
	             //    -->퇴사자인경우 작성자를 기준으로 생성해야함므로 작성자의 부서가 필요함
	             // 작성자의 부서는 작성자 정보 출력시 저장해야함.
	             if (checkedNode.id.slice(0,7) == 'gyrsult') {
	           	  createCheckBox(jwt.deptId.slice(0,5));
	                 selectAuth(jwt.deptId);
	             } else {
	             	  createCheckBox(checkedNode.parent.slice(0,5));
	                 selectAuth(checkedNode.parent);
	             }
	
	             createRadioOptions('COBTP', "radio");  //분류 자동 생성
	             if (fromJobType != "REQ") {
		             if ($(currFormId + ' #' + tempCOBTP).length) {
				     	 $(currFormId + ' #'+ tempCOBTP).prop("checked", true);	//등록사유 문제에서 등록된 내용으로 설정하기
		             } else {
						 alert(checkedNode.text + ' [' +tempCOBTPTxt +'] 등록사유가 존재하지 않습니다. 확인 바랍니다.')
					 }

					 if ($(currFormId + ' #' + tempCODECOBGB).length) {
						 $(currFormId + ' #' + tempCODECOBGB).prop("checked", true);	//분류 --> 장애
					 } else {
						 alert(checkedNode.text + ' [' + tempCODECOBGBTxt + '] 분류가 존재하지 않습니다. 확인 바랍니다.')
					 }
	             }
	               
	        });
       }
    }

    // 접수자 검색 //
    function openSecondUserSearch() {
       if (actionType =="C"){ // 등록 및 발행자가 퇴사자일 때 작성자 검색 가능
          var paramObj = {
               "coCd" : $(currFormId + ' #coCd').val(),
             "userId" : $(currFormId + ' #regId').val(),
             "userNm" : $(currFormId + '#regNm').val(),
            "useYn": "Y"
          };
          openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
                   var checkedId = tree.get_checked()[0];
                   var checkedNode = tree.get_node(checkedId);
                   $(currFormId + '#regId').val(checkedNode.id);
                   $(currFormId + '#regNm').val(checkedNode.text);
                });
       }
    }
   function selectQtyReqInfo() {                  //그리드에 뿌리는 데이터
      var formData = {
         "fileTrgtKey" 	: fileTrgtKey,
         "reqNo" 		: reqNo,
      }
      postAjaxSync("/user/qm/qm01/selectQtyReqInfo", formData, null, function(data) {
		if (data.approval[0] == 'Y'){	//결재가 한개라도 진행이 되었으면 알림창
		    //input readonly, radio.checkbox disabled
			$.each($(currFormId + ' select, input, textarea'), function(idx, elem){
				var id = $(elem).attr("ID");
				if( id ) {               
					var eleId = currFormId + ' #'+id;
					if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
					if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
					if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
					if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
				}
			});
			
			$(currDivId + ' #actionBtn').remove();
			$(currDivId + ' #plus-minus').remove();
			$(currDivId + ' .tit').text('요인별 발주 및 출장요청 조회');
			 //모든 입력 기능 통제하기
			 disableFormAll('popFormQ01');
		}
    	  
    	 //분류,등록사유 자동생성시 20240708이전에는 전체 옵션 표시, 이후에는 정상, 문제 분리 표시용 end
		 //workRptNo = issNo : 문제등록번호가 존재하면 문제건임 ==> "ISS"
    	 if (data.result.workRptNo) fromJobType = "ISS" ;
			createRadioOptions('COBTP', "radio");  //분류 자동 생성
			$(currFormId + '#ordrgId').val(data.result.ordrgId);

            //발행자에 따라 등록사유 선택항목 재생성 작업
            //if (data.result.ordrgId.slice(0,7) == 'gyrsult') return false
            //    -->퇴사자인경우 작성자를 기준으로 생성해야함므로 작성자의 부서가 필요함
            // 작성자의 부서는 작성자 정보 출력시 저장해야함.
            if (data.result.ordrgId.slice(0,7) == 'gyrsult') {
            	let tempRegDeptId = data.result.regDeptId;
          		createCheckBox(tempRegDeptId);	//퇴사자인경우 작성자기준으로 등록사유 생성함
                selectAuth(tempRegDeptId);
            } else {
    			createCheckBox(data.result.deptCd);
    			selectAuth(data.result.deptCd);
            }

			fileTrgtKey = data.result.fileTrgtKey; //발주요청서의 등록번호로 설정하기

// 			selectApprovalCheck(reqNo);

        	// 체크할 키 목록
            const checkKeys = ['reqCd', 'partCd', 'subCd', 'bustCd01', 'bustCd02', 'bustCd03', 'inwkCd01' , 'inwkCd02'];
            const checkDateKeys = ['ordrgDt', 'reqDt'];
            $.each(data.result, function(key, value) {
                // 키가 목록에 있는 경우 체크하기
                if (checkKeys.includes(key)) {
                    $(currFormId + ' #' + value).prop("checked", true);
                } else 
                if (checkDateKeys.includes(key)) {
                    $(currFormId + ' #' + key).datepicker('setDate', value);
                } else 
                if (key == 'clntPjtNm') {
                    clntPjt = value;
                 } else
                if (key == 'todoYn'){
                     if(value == 'Y'){
//                         $("#approval_trgt").show();
//                         $("#approvalReqBtn").hide();
//                         $("#approvalReqBtn").removeAttr("onclick");
                        //결재대상자 load
                        gridViewPop.initView().setData(0);
                     }
                } else
                if ($(currFormId + ' #' + key)[0]) {
                    $(currFormId + ' #' + key).val(value);
                }
            });
            
            const subCdElement = $(currFormId + ' #' + data.result.subCd);
            if (subCdElement.length) {
            	//등록사유가 SUB_CD ==COBGBxxyy 존재하는 경우에는 Option 정상선택 되어 있음.
            } else {
            	//등록사유가 SUB_CD ==COBGBxxyy 존재하지 않는경우
            	
            	// table의 마지막에 추가우
            	//선택 옵션을 추가하고 선택되게 함.
            	const comboName= "CODECOBGB";
 			    const iHtml =
 			    	`<tr><th rowspan="1" style="width: 90px;">${data.result.midNm}</th>
 			    	     <td><input type="radio" id="${data.result.subCd}" name="${comboName}" value="${data.result.subCd}" data-label="${data.result.subCdNm}" onchange="fnc(this)" style="margin-left:20px" readonly> ${data.result.subCdNm}
 			             </td></tr>`;
            	$('#COBGB-checkboxContainer table tbody').append(iHtml);
            	$(currFormId + ' #' + data.result.subCd).prop("checked", true);
            }

			//문제등록사유 코드의 끝 2자리가 99이면 기타 이며, 기타인경우 사유가 있음
			if (data.result.subCd.slice(-2) === '99') {
				$(currFormId + ' #etcInputWrapper').show();
				$(currFormId + ' #etcInput').val(data.result.etcInput).attr('required', true);
			} else {
				$(currFormId + ' #etcInputWrapper').hide();
				$(currFormId + ' #etcInput').val('').removeAttr('required');
			}
            
            monthCloseChk($(currFormId + ' #ordrgDt').val());

			if ( data.result.sameTimeResult == 'Y') { //결과일괄등록
				//발주요청서와 결과서를 동시에 처리한 자료이면 화면 변경없음
				$(currDivId + ' .tit').text($(currDivId + ' .tit').text() + ' [결과자료 일괄등록된 건입니다.]');
			} else {
				$(currDivId + ' .tit').text($(currDivId + ' .tit').text() + ' [결과 추가 등록 자료]');
				$('.reqResultArea').css('display', 'none');
				//화면 컨트롤 필요
				formFieldControl('결과분리등록');
// 				$(currFormId + " #actMh").css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 				$(currFormId + " #measRst").css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 				$(currFormId + " #resltRst").css({'background-color':'#e6e6e6', 'pointer-events':'none'});
				$(currFormId + " #actMh").attr('readonly', true)
				$(currFormId + " #measRst").attr('readonly', true)
				$(currFormId + " #resltRst").attr('readonly', true)
			}
			
			// 각 텍스트 에리어 크기 조절
			txtareaHeightResize($(currFormId + ' #actCompDgnFileNm'));
			txtareaHeightResize($(currFormId + ' #measRst'));
			txtareaHeightResize($(currFormId + ' #resltRst'));
			txtareaHeightResize($(currFormId + ' #reqRmk'));

      });
   }


	function formFieldControl(_procType='결과일괄등록') {                  //필수입력필드 조정
	 	 //발주요청서만 등록하는 경우에는 결과용 자료는 필수 제외처리함.
		if (_procType == '결과일괄등록'){
			//조치자투입공수,원인,처리결과  필수입력이므로 변경없음
		} else {
		 	//조치자투입공수, 원인 처리결과  필수 제외 처리하기~~
		 	$(currFormId + " #actMh").removeAttr('required').closest('td').prev('th').removeClass('hit');
		 	$(currFormId + " #measRst").removeAttr('required').closest('td').prev('th').removeClass('hit');
		 	$(currFormId + " #resltRst").removeAttr('required').closest('td').prev('th').removeClass('hit');
		}
	}

    // 등록
   function insertQualityReq(_procType='결과일괄등록') {
	  formFieldControl(_procType);		//필수입력필드 조정
	  
      if (inputValidation($('.popup_area [required]'))) {                  // 필수 필드의 유효성 검사
         if($(currFormId + " #salesCd").val() == ""){
            alert("SalesCode를 선택해주세요");
         }else if($("input[name='REQCD']:checked").val() == undefined){
            alert("요청구분을 선택해주세요");
         }else if($("input[name='COBTP']:checked").val() == undefined || $("input[name='COBTP']:checked").val() == ""){
              alert("등록 사유를  선택하세요");
         }else if($("input[name='CODECOBGB']:checked").val() == undefined || $("input[name='CODECOBGB']:checked").val() == ""){
              alert("등록사유를 선택해주세요");
         }else if ($("#ordrsDiv").val() == 'ORDRSDIV2' && $("input[name='COBTP']:checked").val() != 'COBTP04') { //A/S유상
            	 alert("A/S유상 수주번호입니다. 분류코드 확인바랍니다.");
         }else if ($("#ordrsDiv").val() == 'ORDRSDIV3' && $("input[name='COBTP']:checked").val() != 'COBTP05') { //A/S무상
            	 alert("A/S무상 수주번호입니다. 분류코드 확인바랍니다.");
         }else {
            var formData = makeFormData(_procType); 
            filePostAjax("/user/qm/qm01/insertQualityReq", formData, function(data) {
                     alert(data.resultMessage); 
                     if (data.resultCode == 200) {

                    	tReqNo = data.reqNo;  						//insert시 reqNo값 가지고오기 위함
                    	$(currFormId + ' #reqNo').val(tReqNo);		//java단에서 reqNo가지고와서 관리번호 값 넣기
                    	kakaoTodo();								//kakaoTodo() 호출

                        if (typeof gridView !== 'undefined') gridView.setData(0);
                        if (typeof salesGridView !== 'undefined') salesGridView.setData(0);

                		modalStack.last().callback("ok");
                        modalStack.close();                           // 모달을 닫음
                     }
                  });
         }
      }
   }

   // 수정
   function updateQualityReq(){
      if( approvalYn() ) {
         alert("결재가 이미 진행중입니다.");
         return;
      }
      
       if (inputValidation($('.popup_area [required]'))) {
    	  const procType = $(currFormId + ' #sameTimeResult').val() == 'Y' ? "결과일괄등록" : "결과분리등록";
          var formData = makeFormData(procType);

              /* 결재그리드 insert make end */
            filePostAjax("/user/qm/qm01/updateQualityReq", formData,function(data) {
                  alert(data.resultMessage);
                  if (data.resultCode == 200) {
                     kakaoTodo();
                     if (typeof gridView !== 'undefined') gridView.setData(0);
                     if (typeof salesGridView !== 'undefined') salesGridView.setData(0);
                	 modalStack.last().callback("ok");
                     modalStack.close();
                  }
               });
         }
   }

   //----------------------------------------------//

   function makeFormData(_procType='결과일괄등록') {
      // 금액 콤마 제거
//       $.each($('.popup_area input[comma]'), function(idx, elem) {
//          deleteComma(elem);
//       });
      // 날짜 하이픈 제거
      $.each($('.popup_area input[date]'), function(idx, elem) {
         deleteHyphen(elem);
      });

		//1. 조치담당자 결재 자동등록 처리하기
		//2. 조치담당자 팀장 결재 자동등록 처리하기
		//3. 이슈 등록자 담당팀장 결재 자동 등록 처리하기
		selectTeamManagerApprovalAdd();  //($("#issSts").val() == 'ISSSTS03')에달 등록인지 결과인지 판단함

      
      // 폼데이터 생성
      var formData = new FormData($("#popFormQ01")[0]);
      formData.append("coCd", $(currFormId + ' #coCd').val());
      formData.append("ordrgDt", $(currFormId + ' #ordrgDt').val());  //발행일자
      formData.append("reqDt", $(currFormId + ' #reqDt').val());   //요구일자
      formData.append("deptCd", userDept);   //부서코드 5자리
      formData.append("deptCd2", userDeptId);   //부서코드 Full
      formData.append("issNo",  $(currFormId + ' #workRptNo').val());   //문제등록번호
      formData.append("vendCd", $(currFormId + ' #vendCd').val())    // 발생공급업체
    	
      //결과까지 일괄 처리할건가 분리할건가 구분자임 [결과일괄등록, 결과분리등록]
      formData.append("procType", _procType);    

      var inwkCd = [];
      var bustCd = [];
      $("#INWKCD-radioButtonContainer").find('input:checked').each(function(index){
         if ($(this).is(":checked")==true){
            inwkCd += $(this).val() + ',';
//             console.log(inwkCd);
         }
      });
      $("#BUSTCD-radioButtonContainer").find('input:checked').each(function(index){
         if ($(this).is(":checked")==true){
            bustCd += $(this).val() + ',';
//             console.log(bustCd);
         }
      });
      formData.append("bustCd", bustCd);
      formData.append("inwkCd", inwkCd);
        //---------------------------------------------------------------
      //-------itemarr  --첨부화일 처리를 위한 부분 시작
      //---------------------------------------------------------------
      formData.append("ordrsNo", $(currFormId + " #ordrsNo").val());
      formData.append("userId" , jwt.userId);
      formData.append("clntCd" , $(currFormId + ' #clntCd').val());         //첨부화일용
      formData.append("prdtCd" , $(currFormId + ' #prdtCd').val(""));         //첨부화일용
      formData.append("itemCd" , $(currFormId + ' #itemDiv').val(""));         //첨부화일용
      formData.append("prjctCd", $(currFormId + ' #clntPjt').val());      //첨부화일용
      formData.append("comonCd", treeModule.getFileNodeId());   //첨부화일용

      //---------------------------------------------------------------

        //---------------------------------------------------------------
      var fileUploadArr = [];
      var tempArr = [];

      tempArr = treeModule.getFileArr();
      $.each(tempArr, function(idx, obj) {
         if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
         }
      });

      formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
      formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));


      //---------------------------------------------------------------
      //--첨부화일 처리를 위한 부분 끝
      //---------------------------------------------------------------

       // 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가
      // 공유 : TODODIV10, TODODIV1040  결재 :TODODIV20, TODODIV2020

		//결재그리드
       var rowSharngList = gridViewPop.target.list;
       var ParamObj = modalStack.last().paramObj;

       var approvalArr = []; //결재정보
		//TITLE 추가
       var tempTitl = $(currFormId + " #clntNm").val() + ',' + clntPjt + ',' + $(currFormId + " input[name='COBTP']:checked")[0].dataset.label + ', ' + $(currFormId + " input[name='CODECOBGB']:checked")[0].dataset.label ;

      //각업무에 맞는 param insert - 하드코딩값
		var addParam = {
					  coCd: $(currFormId + ' #coCd').val()
					, salesCd: $(currFormId + ' #salesCd').val()
					, pgmId: $(currFormId + ' #pgmId').val()
					, pgPath: "/user/qm/qm01/QM0101P01.html"
					, sanctnSttus: "N"
					, todoCoCd: $(currFormId + ' #coCd').val()
					, todoNo: $(currFormId + ' #reqNo').val()
					, todoFileTrgtKey: $(currFormId + ' #fileTrgtKey').val()
					, userId: jwt.userId
					, todoTitl:  wordRemove(tempTitl)
					, todoTitle:  wordRemove(tempTitl)
					, todoKey: ""
					, todoCodeKind: ""
					, todoCodeId: ""
			};

        let 결재순번 = 0;
        let 공유순번 = 0;
       if(rowSharngList.length > 0) {
           $.each(rowSharngList, function(idx, elem) {
		           	/* rowSharngList 내용입니다.
		           	{
					    "rnum": "2",
					    "wbsPlancoCd": "GUN",
					    "coCd": "GUN",
					    "wbsPlancoCdNm": "건양ITT",
					    "usrNm": "gyrsult10",
					    "empNo": "gyrsult10",
					    "name": "외부설계",
					    "telNo": "010-1234-1321",
					    "email": "발주요청서 실적 관리용입니다.",
					    "dtNm": "실적관리용",
					    "jik": "담 당",
					    "todoDiv1CodeId": "TODODIV20",
					    "gb": "결재",
					    "sanctnSttus": "N",
					    "sanctnSttusNm": "미승인",
					    "creatDttm": "2024-07-01",
					    "todoKey": "5778",
					    "sanctnSn": "2",
					    "todoId": "gyrsult10",
					    "todoDiv2CodeId": "TODODIV2020",
					    "salesCd": "24000-00DUMMY",
					    "flag": "U",
					    "__original_index": 1,
					    "__index": 1
					}
			   	*/
			   	if (elem.usrNm.includes('gyrsult')) {
			   		//퇴사자 또는 외주업체담담자등록용으로 결재 제외처리함
			   		// gyrsult10 외부설계
			   		// gyrsult20 외부기계
			   		// gyrsult30 외부전기
			   		// gyrsult90 퇴사자
			   	} else {
	               var approvalListObj = elem;

	               addParam["todoId"] = elem.usrNm;
	               addParam["empNo"] = elem.empNo;
	               addParam["name"] = elem.name;
	               addParam["telNo"] = elem.telNo;
	               addParam["email"] = elem.eMail;
	               addParam["gb"] = elem.gb;

	               ParamObj["actionType"] = (elem.gb == '공유')? "T" : "S";
	               addParam["pgParam"] = JSON.stringify(ParamObj);

	               if (elem.gb == '공유') {
		               	공유순번 += 1;
		               	approvalListObj["sanctnSn"] = 공유순번;
		               	approvalListObj["todoDiv1CodeId"] = "TODODIV10";
		               	approvalListObj["todoDiv2CodeId"] = "TODODIV1040";
	               } else if (elem.gb == '결재') {
		               	결재순번 += 1;
		               	approvalListObj["sanctnSn"] = 결재순번;
		               	approvalListObj["todoDiv1CodeId"] = "TODODIV20";
		               	approvalListObj["todoDiv2CodeId"] = "TODODIV2020";
	               }
	               const mergedParam = {...addParam, ...approvalListObj}//속성합치기
	               approvalArr.push(mergedParam);
			   	}
           });
       }

		//작성자와 발행자가 다를경우 발행자에게 공유카톡 자동 발송 추가
		if ($(currFormId + ' #ordrgId').val().includes('gyrsult')) {
			//외주업체이면 공유제외 처리함
		} else {
			if (!$(currFormId + ' #ordrgId').val().includes('gyrsult') && $(currFormId + ' #regId').val() != $(currFormId + ' #ordrgId').val()) {

	            addParam["todoId"] = $(currFormId + ' #ordrgId').val();
	            addParam["usrNm"] = $(currFormId + ' #ordrgId').val();
	            addParam["empNo"] = $(currFormId + ' #ordrgId').val();
	            addParam["name"] = $(currFormId + ' #ordrgNm').val();
	            addParam["telNo"] = '';
	            addParam["email"] = '';
	            addParam["gb"] = '공유';
	            ParamObj["actionType"] = "T";
	            addParam["pgParam"] = JSON.stringify(ParamObj);

	            var approvalListObj = {};

	           	공유순번 += 1;
	           	approvalListObj["sanctnSn"] = 공유순번;
	           	approvalListObj["todoDiv1CodeId"] = "TODODIV10";
	           	approvalListObj["todoDiv2CodeId"] = "TODODIV1040";

	            const mergedParam = {...addParam, ...approvalListObj}//속성합치기
	            approvalArr.push(mergedParam);
			}
		}
		formData.append("approvalArr", JSON.stringify(approvalArr));
	    /*	결재그리드 insert make end */

		formData.append("S_todoDiv1CodeId", "TODODIV10");
		formData.append("S_todoDiv2CodeId", "TODODIV1040");

		return formData;
	}

   function wordRemove(originalWord) {
		let tempWord = originalWord.replace(/주식회사/g, '');
		tempWord = tempWord.replace(/\(주\)/g, '');
		tempWord = tempWord.replace(/,,/g, ',');
		tempWord = tempWord.replace(/\(주\)/g, '');
		tempWord = tempWord.replace(/ ,/g, ',');
	   return tempWord;
   }

   function opendOrdrsSearch() {
       var paramObj = {
             "searchValue" : $(currFormId + ' #ordrsNo').val(),
             "coCd" : $(currFormId + ' #coCd').val()
          };

       openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 800, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $(currFormId + ' #ordrsNo').val(row.ordrsNo);
        });
    }

   //Sales Code (수주마스터, 수주상세테이블 조인) 검색
   function wbsSalesCodeSearch() {
      if (actionType == "C"){
         var paramObj = {
            "coCd" : $(currFormId + ' #coCd').val(),
            "salesCd": $(currFormId + ' #salesCd').val()
         };

         openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 650, "SALES CODE 검색", paramObj, function (grid){
               var row = grid.target.getList("selected")[0];
               $(currFormId + ' #salesCd').val(row.salesCd);
               $(currFormId + ' #matrDrwNo').val(row.salesCd);
               $(currFormId + ' #clntPjt').val(row.clntPjt);
               $(currFormId + ' #clntPjtCd').val(row.clntPjtCd);
               $(currFormId + ' #clntCd').val(row.ordrsClntCd);
               $(currFormId + ' #clntNm').val(row.ordrsClntNm);
               $(currFormId + ' #newCd').val(row.ordrsDtlDiv20Nm);
               $(currFormId + ' #ordrsdtldiv20').val(row.ordrsDtlDiv20);
               $(currFormId + ' #ordrsNo').val(row.ordrsNo);
               $(currFormId + ' #prdtCd').val(row.prdtCd);
               $(currFormId + ' #itemDiv').val(row.itemDiv);
               $(currFormId + ' #eqpNm').val(row.eqpNm);
               $(currFormId + ' #ordrsDiv').val(row.ordrsDiv);		//수주구분 "ORDRSDIV2"
               $(currFormId + ' #ordrsDivNm').val(row.ordrsDivNm);	//수주구분명 "유상A/S
               $(currFormId + ' #orgnSalesCd').val(row.orgnSalesCd);	//수주구분명 "유상A/S
               if (row.ordrsDiv == 'ORDRSDIV2') {
                  $(currFormId + ' #COBTP04').prop("checked", true);
               } else if (row.ordrsDiv == 'ORDRSDIV3') {
                  $(currFormId + ' #COBTP05').prop("checked", true);
               }
               //발주요청서 고객요구일자는 과제에 등록된 출고일자를 기본적용 없으면 수주에 있는 납기예정일자를 고객요구일자로 적용 
               if (row.deDt!='' && row.deDt!=undefined) {
	               $(currFormId + ' #custReqDt').val(row.deDt);	//과제에 등록된 출고일자
               } else {
                   $(currFormId + ' #custReqDt').val(row.dudtIntendDt);	//수주에 등록된 납기예정일자
               }
               if (row.ordrsDiv == "ORDRSDIV8" || row.ordrsDiv == "ORDRSDIV9") {
                  alert(row.salesCd + ' 가수주, 수주취소건은 발주요청서 발행불가입니다. 영업PM에게 확인 바랍니다.');
                  $('#actionBtn').hide();
                  $('#actionBtn2').hide();
     			 //모든 입력 기능 통제하기
     			 disableFormAll('popFormQ01');
               } else {
                  $('#actionBtn').show();
                  $('#actionBtn2').show();
               }
         });
      }
   }



   function setByCoCd(value) {
      $(currFormId + ' #coCd option:not([value="'+value+'"])').remove();
   }

   function selectAuth(value){
	      userDeptId = value;		//부서코드 Full
	      userDept = userDeptId.substr(0, 5);  //부서코드 5자리
   }

   //등록시 그리드값 배열 저장
   $.approvalInsertArr = function(gridObj, addParam) {
      var gridList = gridObj.target.getList();
      var gridColumns = gridObj.target.columns;
      var detailArr = [];
      var msgArr = [];
      var errCnt = 0;
      if( gridList.length > 0 ) {
           var msgArr = [];
           $.each(gridList, function (idx, elem) {
               var detailObj = {};
              //컬럼수 루프
              for(var i=0; i<gridColumns.length; i++) {
               var key = gridColumns[i].key;
               var val = elem[key];
               if( typeof(val) == "undefined") val = "";
               detailObj["idx"] = i + 1;
               //발주순번 은 select key로  ORDRG_SEQ
               detailObj[key] = val;
              }
               //필수값 체크를 여기서 한다.
               if( detailObj['todoId'] != ""  ) {
                  detailArr.push(detailObj);
               }
               //공유/결재구분
               if( detailObj['gb'] == "결재" ) {
                  detailObj['todoDiv1CodeId'] = "TODODIV20";
                  detailObj['todoDiv2CodeId'] = "TODODIV2020";
               } else if( detailObj['gb'] == "공유" ) {
                  detailObj['todoDiv1CodeId'] = "TODODIV10";
                  detailObj['todoDiv2CodeId'] = "TODODIV1040";
               }
               //추가할 param
            $.each(addParam, function(key, val){
               detailObj[key] = val;
            });
            //TITLE 추가
            var tempTitl = $(currFormId + ' #clntNm').val() + ',' + clntPjt + ',' + $("input[name='COBTP']:checked")[0].dataset.label + ', ' + $("input[name='CODECOBGB']:checked")[0].dataset.label ;
            tempTitl = tempTitl.replace(/주식회사/g, '');
            tempTitl = tempTitl.replace(/(주)/g, '');
            tempTitl = tempTitl.replace(/,,/g, ',');
            detailObj['todoTitl'] = tempTitl;
           });
           //error alert 후 종료
           if( msgArr.length > 0 ) {
              alert(msgArr.join("\r\n"));
              return false;
           }
      }
      return detailArr;
   }

   //입력그리드 No. 재정립
   $.gridNoSet = function(gridObj, key) {
//       console.log('---gridNoset run ---');
      var gridList = gridObj.target.getList();
      if( gridList.length > 0 ) {
         $.each(gridList, function (idx, elem) {
            let detailObj = {};
            gridObj.target.setValue(idx, key, idx+1);
         });
         gridObj.target.repaint();
      }
   }


//    function selectApprovalCheck(value) {
//       var formData = {
//             "reqNo" : value
//       }
//       postAjaxSync("/user/qm/qm01/selectApprovalChk", formData, null, function(data) {//결재가 진행이 되었는지 안되었는지 DB체크
// 			var list = data.result[0]
// 			if (list == 'Y'){//결재가 한개라도 진행이 되었으면 알림창
			
// 			    //input readonly, radio.checkbox disabled
// 				$.each($(currFormId + ' select, input, textarea'), function(idx, elem){
// 					var id = $(elem).attr("ID");
// 					if( id ) {
// 						var eleId = currFormId + ' #'+id;
// 						if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
// 						if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
// 						if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 						if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
// 					}
				
// 				});
				
// 				$(currDivId + ' #actionBtn').remove();
// 				$(currDivId + ' #plus-minus').remove();
// 				$(currDivId + ' .tit').text('요인별 발주 및 출장요청 조회');
// 			}
//       });
//    }

   function setReportMain(_type) {
      var selDataList = gridViewPop.target.list;
		//20240104 남장섭 구매팀 허상렬팀장 요청으로 결재 승인이 없더라도 출력가능하게 수정
//       if(selDataList.sanctnSttus != "Y"){
//          alert('팀장 결재전에는 출력할 수 없습니다.');
//          return false;
//       }
      //sanctnSttus 값이 Y인 자료의 정리
	  var filteredData = selDataList.filter(function(item) {
            return item.gb=='결재' && item.sanctnSttus === "Y";
        });
	  if(filteredData.length == 0){
		  alert('발주요청서는 팀장 또는 검증을 위한 한명 이상 결재가 필요 합니다.\n결재 완료전 발행 할 수 없습니다.');
		  return false;
	  }


      var fileName = "QM0101R01.jrf";
      var arg =
           "coCd#"      +  $(currFormId + ' #coCd').val()
          + "#reqNo#"   +  $(currFormId + ' #reqNo').val()
          + "#userId#"   +  jwt.userId
          + "#";

      if (_type == 'Report') {
         callReport(fileName, arg, 1150, 720, '발주요청서');
      } else { //Export 작업
         ubiExportAjax(fileName, arg, function(response) {
            if (response.resultCode === 200) {
               var base64FileData = response.base64FileData;
               var fileName = response.exportFileName;
               downloadPDFFromBase64(base64FileData, fileName);
            } else {
               alert('PDF 내보내기 실패: ' + response.resultText);
            }

         });
      }

   }



   /*
   #   TODO 알림톡발송 시작
   #
   */
//    $("#approvalReqTodoBtn").on("click", function () {
//       kakaoTodo();
//    });
   function kakaoTodo() {

       //message load
       if (kakaoErr.length == 0) {
	        var paramObj = {
	            "userId" : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });
       }

      let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

      // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
        var paramObj1 = {
                "coCd" : $(currFormId + ' #coCd').val(),
                "userId" : $(currFormId + ' #regId').val()
            };
         postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
             if (data.result[0] == undefined
                  || data.result[0].telNo == "") {
                teleNo = "051-312-2400";
             }
             else {
                teleNo = data.result[0].telNo;

             }
         });
        //---------------------------------------
      let param = {
            "tmplatDiv": "TMPLATDIV02"
            , "coCd": $(currFormId + ' #coCd').val()            //해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": "TODODIV20"               //공통코드 해당업무 - 결재
            , "todoDiv2CodeId": "TODODIV2020"               //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv1CodeNm": "결재"                  //공통코드 해당업무 - 결재 - 발주서
            //, "todoDiv2CodeNm": "발주 및 출장 요청"                  //공통코드 해당업무 - 결재 - 발주서
            , "title": "발주 및 출장 요청"
            , "sanctnDiv2": "결재"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $(currFormId + ' #reqNo').val()
            //, "todoNo": tReqNo
            , "clntCd": "1"               //발신회사는 로그인사용자 회사
            , "clntNm": clntNm            //로그의 수신거래처명
            , "ordrgMngNm": $(currFormId + ' #regNm').val()         //발주작성자(담당자)
            , "ordrgMngTelNo": teleNo      //담당자전화번호
            , "creatPgm"  : "QM0101P01"
      }
      commKaKaoSendTodo(param);

      //공유
      let param2 = {
            "tmplatDiv": "TMPLATDIV02"
               , "coCd": $(currFormId + ' #coCd').val()            //해당업무의 coCd(트르넷발주 TRN )
               , "todoDiv1CodeId": "TODODIV10"               //공통코드 해당업무 - 결재
               , "todoDiv2CodeId": "TODODIV1040"               //공통코드 해당업무 - 결재 - 발주서
               , "todoDiv1CodeNm": "공유"                  //공통코드 해당업무 - 결재 - 발주서
               , "title": "발주 및 출장 요청"
               , "sanctnDiv2": "공유"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
               , "todoNo": $(currFormId + ' #reqNo').val()
               //, "todoNo": tReqNo
               , "clntCd": "1"               //발신회사는 로그인사용자 회사
               , "clntNm": clntNm            //로그의 수신거래처명
               , "ordrgMngNm": $(currFormId + ' #regNm').val()         //발주작성자(담당자)
               , "ordrgMngTelNo": teleNo      //담당자전화번호
               , "creatPgm"  : "QM0101P01"
      }
      commKaKaoSendTodo(param2);

      if (kakaoCnt > 0) {
          kakaoCnt = 0;
//           alert("알림톡이 정상 발송되었습니다.");
       }
   }

   //to-do결재요청 알림톡
   function commKaKaoSendTodo(param) {
//       console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);

      //알림톡수신번호 채번
      var maxMessageId = null;         //message id(unique key)
      var talkMessage = null             //발송될 내용 template
      var mobile = null               //수신인 휴대전화번호
      var title = null               //todo title
      var todoDiv2CodeNm = null               //todo title
      var sendList = [];
      let talkParam = {};
      let talkBody = {};
      let sendCnt = 0;
      postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
               , function(data) {
                  if(data.resultList.length > 0 ) {
                     if( data.resultList[0].maxMessageId != "" ) {
                        sendList = data.resultList;
                     } else {
                        alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                        return;
                     }

                  }
      });
      //user search ajax end

      //대상 loop
      $.each(sendList, function (key, sendObj) {
         maxMessageId = sendObj.maxMessageId;
         talkMessage = sendObj.messageDesc;
         mobile =  sendObj.telNo;
         //로그용
         param.rcvId = sendObj.todoId;         //todo 수신id
         param.rcvNm = sendObj.name;            //todo 수신자명
         param.nameTo = sendObj.name;            //todo 수신자명
         //title      = sendObj.todoTitl;
         todoDiv2CodeNm =   sendObj.todoTitl;
         param.todoDiv2CodeNm = todoDiv2CodeNm;
         //param.title = title;                        //요청내용제목
         param.sendDt = sendObj.sendDt;

         if(mobile == "" || mobile == null) {
            alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
            return;
         }
         if(talkMessage == "" || talkMessage == null) {
            alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
            return;
         }
         //message 치환
         let message = talkMessage;
         let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
         //loop
         $.each(splitStr, function (key, val) {
            let compKey = val.substring(1, val.length-1);
            if( compKey != "" && compKey != "undefined" ) {
               if( typeof(param[compKey]) != "undefined" ) {
                  let val2 = '#'+val;
                  message = message.replaceAll(val2, param[compKey]);
               }
            }
         });

         talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
         talkParam.serverName = "gyitt2400";
         talkParam.paymentType = "P";
         talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
         talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);
		if (param.title.length > 50) {
			param.title = param.title.substring(0, 49); // 50자까지만 자르기
		}
         talkBody.title = param.title;               //알림톡 타이틀 -
         talkBody.message = message;            //알림톡 메시지 (1000 byte)
         talkBody.mobile = mobile;            //휴대전화번호
         talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
         let talkJson = JSON.stringify(talkBody);
         sendCnt = kakaoSendReal(talkJson, talkParam, param);
      });
      //대상 loop end
      if( sendCnt > 0 ) {
         //alert("알림톡 정상 발송되었습니다.");
         kakaoCnt++;
      }
   }

   //조치담당자 팀장 정보 가져오기
	function selectTeamManagerInfo(paramUserId) {
		//결자자 정보 가져오기//결자자 정보 가져오기 gridViewPop2
       var appshaList = gridViewPop.target.list.map(function(item) {
			            return {
			                gb: item.gb,
			                usrNm: item.usrNm,
			                name: item.name,
			                jik: item.jik,
			                dtNm: item.dtNm,
			                telNo: item.telNo,
			                offTelNo: item.offTelNo,
			                email: item.email,
			            };
			        });


       var appArray = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
			            return {
			                gb: item.gb,
			                usrNm: item.usrNm,
			                name: item.name,
			                jik: item.jik,
			                dtNm: item.dtNm,
			                telNo: item.telNo,
			                offTelNo: item.offTelNo,
			                email: item.email
			            };
			        });
       var shaArray =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
			            return {
			                gb: item.gb,
			                usrNm: item.usrNm,
			                name: item.name,
			                jik: item.jik,
			                dtNm: item.dtNm,
			                telNo: item.telNo,
			                offTelNo: item.offTelNo,
			                email: item.email
			            };
			        });

       var formData = {
           "userId" : paramUserId,
       }
       postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
       	if (data.result != '' && data.result!=null) {
       		//결자자 정보 가져오기
       		let list = data.result;
       		if (appArray.some(item => item.usrNm === list.id)) {
       			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
       		} else {
       			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                        todoNo: $('#rsltNo').val(),
		                        sanctnSn: 0,
		                    });
       		}

       		gridViewPop.setData2(appArray.concat(shaArray));
       	}
		});
	}


    //조치담당자 팀장 정보 가져오기
	function selectTeamManagerApprovalAdd() {
    	//------------------------------------------------
    	//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
    	//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
    	//------------------------------------------------
		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		var tempActId = $(currFormId + ' #ordrgId').val();	//발행자ID


		/*	결재그리드 insert make start */
	    //발행자의 담당팀장 결재라인에 자동 등록 처리하기 Start
	    //발행자가 퇴사자인경우 작성자의 팀장 자동 결재 등록 처리됨
	    if (tempActId.includes('gyrsult')) {
	    	selectTeamManagerInfo($(currFormId + ' #regId').val());
	    } else {
			selectTeamManagerInfo($(currFormId + ' #ordrgId').val());
	    }
	    //발행자의 담당팀장 결재라인에 자동 등록 처리하기 End


    	let appshaList = gridViewPop.target.getList();

// 		if (tempActId.slice(0,7) == 'gyrsult') return false; //실적관리용 ID는 결제 제외처리함.

        $.each(appshaList, function(idx, item){
        	if (!item.usrNm.includes('gyrsult')) {
	            if (item.gb === "결재") {
	            	appArray.push(item);
	            } else {
	            	//공유일경우 조치담당자가 공유에 있으면 제외처리함.
	            	if (item.usrNm != tempActId) {
	            		shaArray.push(item);
	            	}
	            }
        	}
        });
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------


		//발행자의 팀장 정보 가져오기
// 		appArray = approvalUserInfoData(tempActId, appArray);
		appArray = approvalTeamManagerInfoData(tempActId, appArray);
		if (userDept == 'GUN40') {
			appArray = approvalTeamManagerSpecialInfoData('shjung', appArray);		//특정유저 추가하기(설계이면 정상훈차장 추가)
			appArray = approvalTeamManagerSpecialInfoData('h4ng10', appArray);		//특정유저 추가하기(설계이면 허상렬팀장 추가) 20250123 허상렬팀장 제외요청
			appArray = approvalTeamManagerSpecialInfoData('K98452000', appArray);	//특정유저 추가하기(설계이면 김동현이사 추가) 20250123 허상렬팀장 제외요청
		}

      // 중요도가 최상(비용상, 빈도상)이면 사장님 결재라인에 자동 등록
      if ($('#importantCd').val() == 'IMPORTCD01') {
         appArray = approvalTeamManagerSpecialInfoData('ceo', appArray);
      }
// 		appArray = approvalTeamManagerInfoData(jwt.userId, appArray);


		gridViewPop.setData2(appArray.concat(shaArray));
	}

    //조치담당자정보 자동 추가하기
	function approvalUserInfoData (appUserId, appArray) {
	    var formData = {
	        "userId" : appUserId,
	    }
	    postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
	    	if (data.resultList != '' && data.resultList!=null) {
	    		//조치결과 결자자 정보 가져오기
	    		let list = data.resultList[0];
	    		if (appArray.some(item => item.usrNm === list.usrNm)) {
	    			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
	    		} else {
	    			appArray.push({
		                        gb: "공유",
		                        usrNm: list.usrNm,
		                        name: list.name,
		                        jik: list.jik,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                    });
	    		}
	    	}
		});
		return appArray;
	}



    //담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        	}
		});
		return appArray;
	}


    //특정담당자 정보 가져오기
	function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        	}
		});
		return appArray;
	}


	// 포커스 시 현재 날짜와 시간 설정
	function setCurrentDateTime(input) {
		if (!input.value) { // 값이 없으면 현재 날짜와 시간을 설정
			const now = new Date();
			const year = now.getFullYear();
			const month = String(now.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
			const day = String(now.getDate()).padStart(2, '0');
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');

			// "yyyy-MM-ddThh:mm" 형식으로 설정
			const currentDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
			input.value = currentDateTime;
		}
	}
	


	function gridResize(gridObj, size) {
	        var tagHeight = (size) * 27 + 60 ;
	        tagHeight = tagHeight > 750 ? 750 : tagHeight;
	        tagHeight = tagHeight < 100 ? 100 : tagHeight;

	        gridObj.target.setHeight(tagHeight);
	}


	function txtareaHeightResize(obj) {
		let rowCount = obj.val().split(/\r\n|\r|\n/).length;
		if(rowCount < 3) {
			obj.css('height', "76px");
		} else {
			if (rowCount > 24)  rowCount = 23;
			obj.css('height', (rowCount * 21) + "px");
		}
	}

	// 발생공급업체 검색
	function openClntSearch() {
		var paramObj = {
				"searchValue" :  $(currFormId + ' #vendCdNm').val(),
				"clntDivCd"   : ""
		}
		openThirdModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$(currFormId + ' #vendCd').val(row.clntCd);
			$(currFormId + ' #vendCdNm').val(row.clntNm);
		});
	}

</script>