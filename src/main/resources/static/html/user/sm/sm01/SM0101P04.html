<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">구매BOM 하위도번</h4>
    </div>
  <div class="form-group popup_table">
   <form id="pop04Form" onSubmit="return false;">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="SM0101M01">
		<input type="hidden" id="coCd_SSS" name="coCd_SSS">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="20%">
          <col width="11%">
          <col width="10%">
        </colgroup>

        <tr>
			<th class="hit">Sales Code</th>
			<td>
				<input type="text" id="salesCd_SSS" name="salesCd_SSS" class="form-control" required="required" msg="Sales Code" readonly="readonly">
			</td>
			<th class="hit">상위코드</th>
			<td>
				<input type="text" id="upperCd_SSS" name="upperCd_SSS" class="form-control" required="required" msg="Sales Code" readonly="readonly">
			</td>
			<th>적용레벨</th>
			<td>
				<input style="text-align: center;" type="text" id="lvl_SSS" name="lvl_SSS" class="form-control" readonly="readonly">
			</td>
        </tr>
        <tr>
			<th>BOM 수량</th>
			<td>
				<input data-positive type="text" id="dsgnBomQty_SSS" name="dsgnBomQty_SSS" class="form-control">
			</td>
			<th>명칭</th>
			<td colspan="3">
				<input data-maxlength="100" type="text" id="dsgnNm_SSS" name="dsgnNm_SSS" class="form-control">
			</td>
        </tr>
      </table>
    </form>

	<!-- 콘텐츠 -->
	  <div class="contents" style="margin-top: 10px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">하위 도번</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                	<a onclick="initGridLowBom()" style="width: 60px;" authchk> 초기화</a>
		                    <a onclick="addRowLevel()" style="" authchk>+</a>
		                    <a onclick="delRowLevel()" style="" authchk>-</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="pop-bom-grid" data-ax5grid-config="{}" style="height:520px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>
	    </div>
	  </div>
	</div>


	<!-- 공통 파일 영역
	<div id="fileList_area"></div>
     -->
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtnLevel" authChk>적용</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">

var selectBomArr = [];
var original_bomLevelArr = [];
var bomLevelArr = [];
var delRowIndexArr = [];

var lowLvl_ckColumn = "lastDsgnNo,dsgnNm,dsgnBomQty";

const lowLvlGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: true,
		    	 sortable: false,
		         target: $('[data-ax5grid="pop-bom-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: true
		         },
		         body: {
		        	 	 //mergeCells : ["lvl", "salesCd","dsgnNo","upperCd","lowerCd"],
			        	 onClick: function () {
				        		this.self.clearSelect();
				             	this.self.select(this.dindex);
			        	 },
						 onDBLClick: function () {
						 },
			             onDataChanged: function () {
								/* * 입력항목이 이전데이타와 같다면 저장체크(dtaChk) 지움
							   * 데이타조회 initGridDataNullValue 사용 , 이전데이타 조회
							   */
							if(isSameValue(this.list , this.dindex, lowLvl_ckColumn) == true){
								this.item.__modified__ = false;
							}
			            	if(this.key != "dtaChk" && this.key != "__selected__" && this.item.__modified__){
				            	this.item.dtaChk = "U";
				            }
			            	else if(this.key != "dtaChk" && this.key != "__selected__") {
			            		this.item.dtaChk = "";
			            	}

							if(this.key == "lastDsgnNo" && this.value != ""){
								this.item.lastDsgnNo = this.value.replace(/[^A-Za-z0-9]/g, ""); //입력은 영문,숫자만
								var this_dindex = this.dindex;
								var this_lastDsgnNo = this.item.lastDsgnNo;
								var isOverLap = false;
								if(this.item.lastDsgnNo != "") {
									$.each($.extend({}, this.list), function (idx, obj) {
										if(this_dindex != obj.__index && obj.lastDsgnNo != "" && obj.lastDsgnNo == this_lastDsgnNo){
											isOverLap = true;
										}
									});
								}
								if(isOverLap) {
									alert("중복된 도번 입니다.");
									this.item.lastDsgnNo = "";
									this.item.lowerCd = "";
									this.item.dsgnNo = "";
								}
								else {
									this.item.lowerCd = this.item.upperCd + adPer(this.item.lastDsgnNo);
									this.item.dsgnNo = this.item.lowerCd;
								}
							}

							this.self.repaint();
			             }
	             },
		        columns : [
		        	{key: "dtaChk",label: " ", width: 30, 	styleClass: "grid-font-blue-bold"},
		        	{key: "coCd", label: "CO", width: 50,hidden:true},
		        	{key: "salesCd", label: "Sales Code", width: 120,hidden:true},
		        	{key: "lvl", label: "LVL", width: 50},
		        	{key: "lastDsgnNo"  , label: "도번", width: 90,align: "left",
		        		editor:{type:  "text",
		        			disabled: function () {
		        				if(this.item.dtaChk == "D"){
			        		        return true;
		        				} else {
		        					return false;
		        				}
		        		    },
		        		    attributes: {
		        		        'maxlength': 4, 'data-maxlength': 4
		        		    }
    					}
                    },
					{key: "dsgnNm" , label: "명칭" 	,width: 280,align: "left",
		        		editor:{type:  "text",
		        			disabled: function () {
		        				if(this.item.dtaChk == "D"){
			        		        return true;
		        				} else {
		        					return false;
		        				}
		        		    },
		        		    attributes: { 'maxlength': 30 }
    					}
                    },
					{key: "dsgnBomQty" , label: "수량" 	,width: 60,align: "right",
		        		editor:{type:  "number",
		        			disabled: function () {
		        				if(this.item.dtaChk == "D"){
			        		        return true;
		        				} else {
		        					return false;
		        				}
		        		    },
	        		    	attributes: { 'maxlength': 5 }
						}
                	},
		        	{key: "dsgnNo" , label: "적용도번" ,width: 200,align: "left",hidden:false},
					{key: "upperCd", label: "upperCd" ,width: 160,align: "left",hidden:true},
					{key: "lowerCd", label: "lowerCd" ,width: 180,align: "left",hidden:true},
			     ]
		    });
			return this;
		},

		initData: function(){
			var list = original_bomLevelArr;
			this.target.setData({
				list : list,
			    page : {
			    		totalElements : list.length
			    	   }
			});
		},


        setData: function(_pageNo){
        	bomLevelArr = initGridDataNullValue(bomLevelArr, this.target.columns, lowLvl_ckColumn);
			var list = bomLevelArr;
			this.target.setData({
				list : list,
			    page : {
			    		totalElements : list.length
			    	   }
			});

     	} //setData
     }



 	$(document).ready(function() {
		let loadData = {
			coCd_SSS : modalStack.last().paramObj.coCd,
			salesCd_SSS : modalStack.last().paramObj.salesCd,
			upperCd_SSS : modalStack.last().paramObj.upperCd,
			lvl_SSS : modalStack.last().paramObj.lvl,
		};
		loadFormData("#pop04Form", loadData);

		authChk();// 권한체크

		/**
		 * grid 초기화
		*/
		var sendLowData = modalStack.last().paramObj.sendLowData;
		original_bomLevelArr = JSON.parse(sendLowData);
		bomLevelArr = JSON.parse(JSON.stringify(original_bomLevelArr));

		var sendSelectData = modalStack.last().paramObj.sendSelectData;
		selectBomArr = JSON.parse(sendSelectData);
		$("#dsgnNm_SSS").val(selectBomArr.dsgnNm);
		$("#dsgnBomQty_SSS").val(selectBomArr.dsgnBomQty);

		lowLvlGridView.initView().setData(0);
		//console.log("====lowLvlGridView>>",lowLvlGridView);

		$('#actionBtnLevel').on("click", function() {
			sendBomLevel();
		});

 	});

 	//그리드 입력 초기화
 	this.initGridLowBom = function () {
		lowLvlGridView.initData();
 	}

 	this.addRowLevel = function () {
 		let newRow = {};
		newRow = {dtaChk:"I"
			, coCd: $("#coCd_SSS").val()
			, salesCd: $("#salesCd_SSS").val()
			, lvl: $("#lvl_SSS").val()
			, upperCd: $("#upperCd_SSS").val()
			, dsgnNo:""
			, lowerCd: ""
			, lastDsgnNo: ""
		};
		lowLvlGridView.target.addRow($.extend({}, newRow), "last");
 	}

 	this.delRowLevel = function () {
		if(selectGridValidationM(lowLvlGridView.target)) return;
		var selDataList = lowLvlGridView.target.getList("selected");
		for(var i=selDataList.length-1; i >= 0; i--){
			var selData = selDataList[i];
			var selDtaChk = selData.dtaChk;
			if(selDtaChk == "I"){
				if(!isEmpty(selData.bom_index)) {
					let delIndex = Number(selData.bom_index);
					delRowIndexArr.push(delIndex);//두번째이상 팝업에서 입력됨
				}
				lowLvlGridView.target.removeRow(selData.__index);
			}
			else {
				lowLvlGridView.target.setValue(selData.__index, "dtaChk", "D");
			}
		}
	}

	this.gridDataValidation = function(gridObj){
		var dataList = gridObj.getList();
		for(i=0; i<dataList.length; i++){
			if(empty(dataList[i]["lastDsgnNo"])){
				gridObj.clearSelect();
				gridObj.select(i);
				gridObj.focused = true;
				alert("[도번]은 필수입력 항목입니다.");
				return true;
			}
		}
		return false;
	}

	function sendBomLevel() {
		if(gridDataValidation(lowLvlGridView.target)) return;

		var sel_dsgnNm = nvl(selectBomArr.dsgnNm,"");
		var inp_dsgnNm = nvl($("#dsgnNm_SSS").val(),"");
		var sel_dsgnBomQty = nvl(selectBomArr.dsgnBomQty,"");
		var inp_dsgnBomQty = nvl($("#dsgnBomQty_SSS").val(),"");

		if(sel_dsgnNm != inp_dsgnNm || sel_dsgnBomQty != inp_dsgnBomQty){
			if(selectBomArr.dtaChk != "I" && selectBomArr.dtaChk != "D") {
				selectBomArr.dtaChk = "U";
			}
			else {
				selectBomArr.dtaChk = "";
			}
			if(sel_dsgnNm != inp_dsgnNm){
				selectBomArr.dsgnNm = $("#dsgnNm_SSS").val();
			}
			if(sel_dsgnBomQty != inp_dsgnBomQty){
				selectBomArr.dsgnBomQty = $("#dsgnBomQty_SSS").val();
			}
		}
		else {
			selectBomArr.dtaChk = "";
		}

		let bomList = lowLvlGridView.target.getList();
		let data = {
			   selectBom : selectBomArr
			 , lvlBomList : bomList
			 , delInputRowIndexArr : delRowIndexArr
		};
		modalStack.last().callback(data);
		modalStack.close();
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

</script>