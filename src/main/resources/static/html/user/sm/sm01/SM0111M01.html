<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">

<script src="/static/js/jquery-latest.min.js"></script>
<script src="/static/js/jquery.serializeObject.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script src="/static/js/moment/moment-with-locales.js"></script>
<script src="/static/js/jstree/jstree.min.js"></script>
<script src="/static/js/ax5/ax5core.min.js"></script>
<script src="/static/js/ax5/ax5grid.min.js"></script>
<script src="/static/js/ax5/ax5mask.min.js"></script>
<script src="/static/js/ax5/ax5modal.min.js"></script>
<script src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5calendar.min.js"></script>
<script src="/static/js/ax5/ax5picker.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script src="/static/js/ax5/ax5formatter.min.js"></script>
<script src="/static/js/ax5/ax5combobox.min.js"></script>

<script src="/static/js/global.js"></script>
<script src="/static/js/fileTree.js"></script>

</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	
	<div id="main_area">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					 <a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					 <a onclick="gridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div>
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 3분할 -->
				<table class="table_input type04">
				
					<!-- 검색조건 1행 -->
					<tr>
						<th class= "hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사">
						      <option value="">전체</option>
							</select>
						</td>
						
						<th class= "hit">수주일자</th>
						<td>
							<div class="date_input">
			                    <input id="reqDtFrom_S" name="reqDtFrom"  class="input_calendar" autocomplete="off"
			                      msg="시작일자" data-search="reqDtFrom" onchange="gridView.setData(0);">
			                    <span>~</span>
			                    <input id="reqDtTo_S" name="reqDtTo"  class="input_calendar" autocomplete="off"
			                      msg="종료일자" data-search="reqDtTo" onchange="gridView.setData(0);">
			                  </div>
						</td>
						
						<th>&nbsp;</th>
						<td>&nbsp;</td>
						
						<th>고객사</th>
						<td>
						    <input type="hidden" id="clntCd_S" name="clntCd_S"  data-search="clntCd" msg="고객사">
		                    <div class="search_form" >
		                    <input type="text" id="clntNm_S" name="clntNm_S"  data-search="clntNm" onkeyup="event.keyCode == 8 ? vendCd_S.value='' : event.keyCode == 13 ? openClntSearch('P') : '' "> 
		                    <a onclick="openClntSearch('P');"><i class="i_search_w"></i></a>
		                    </div>
						</td>
					</tr>
					  
					<!-- 검색조건 2행 -->                    
					<tr>
					  <th>Sales Code</th>
		                <td>
							<div class="search_form">
		                        <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''">
		                        <a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
		                    </div>
		                    <input type="hidden" id="salesNm_S" name="salesNm_S" >
						</td>
		
						<th>제품 구분</th>
						<td>
						    <input type="hidden" id="prdtCd_S" name="prdtCd_S" data-search="prdtCd" >
		                    <div class="search_form">
		                      <input type="text" id="prdtNm_S" name="prdtNm_S" data-search="prdtNm"  onkeyup="event.keyCode == 8 ? prdtCd_S.value='' : event.keyCode == 13 ? openPrdtSearch() : '' ">
		                        <a onclick="openPrdtSearch();"><i class="i_search_w"></i></a>
		                    </div>
						</td>
						
						<th>아이템 구분</th>
						<td>
							<select id="itemCd_S" name="itemCd_S" data-kind="ITEMLIST" data-search="itemCd" >
		                        <option value="">전체</option>
		                    </select>   
						</td>
		
						<th>공유대상자</th>
						<td>
								<input type="hidden" id="salesMngId_S" name="salesMngId_S" data-search="mngId">
		                            <div class="search_form">
		                             <input type="text" id="salesMngNm_S" name="salesMngNm_S" data-search="mngNm" 
		                             onkeyUp="if(window.event.keyCode == 8){salesMngId_S.value = ''}  else if(window.event.keyCode == 13){gridView.setData(0);};">
		                                <a onclick="openUserTree();"><i class="i_search_w"></i></a>
		                            </div>
						</td>           
		            </tr>
		
		            <!-- 검색조건 3행 -->   
					<tr>
					
						<th>고객사 PJT</th>
						<td>
						    <input type="text"  id="clntPjt_S" name="clntPjt_S"  data-search="clntPjt">
						</td>
					 
						<th>설비명</th>
						<td>
						    <input type="text"  id="eqpNm_S" name="eqpNm_S"  data-search="eqpNm">
						</td>
					 
						<th>관리번호</th>
						<td>
							<div class="search_form"  style="width: 100%;">
								<input type="text"  id="wbsPlanNo_S" name="wbsPlanNo_S" onkeyUp="if(event.keyCode == 13){gridView.setData(0);};">
								<a onclick="wbsPlanNoSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>        
					
						<th></th>
						<td>
						</td>  
					                  
					</tr>
					      
		            <!-- 검색조건 END -->
	            </table>
	            <input type="hidden" id="userId"    name="userId">
                <input type="hidden" id="pgmId"     name="pgmId" value="WB0101M02">
            </div>
        </div>
        <!-- 콘텐츠 -->
		<div class="contents no_bg">
		      <div class="contents_tit">
		        <div class="add_btn_small pdl10">
		          <!-- <a onclick="insertWbsPlanModal('C', '1', 0);" style="height: 30px; line-height: 28px;">1레벨</a>
		          <a onclick="insertWbsPlanModal('C', '2', 0);" style="height: 30px; line-height: 28px;">2레벨</a>
                  <a onclick="insertWbsPlanModal('C', '3', 0);" style="height: 30px; line-height: 28px;">3레벨</a> -->
                  <a onclick="" style="height: 30px; line-height: 28px; width: 60px;">계획마감</a>
                  <a onclick="" style="height: 30px; line-height: 28px; width: 60px;">계획삭제</a>
                  <a onclick="" style="height: 30px; line-height: 28px; width: 60px;">실적마감</a>
                  <a onclick="" style="height: 30px; line-height: 28px; width: 60px;">실적삭제</a>
		          <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
		          
		        </div>
		        <select id="recordCnt" class="prae_select" onchange="gridView.setData(0);">
		          <option value="10">10</option>
		          <option value="20" selected>20</option>
		          <option value="50">50</option>
		          <option value="100">100</option>
		          <option value="9999999">전체</option>
		        </select>
        </div>

		
		<!-- 콘텐츠 -->

    <div class="row" style="margin-top: 15px;">
      <div class="col-xs-8" style="padding-right: 5px;">
        <div class="contents" style="margin: 0px; padding: 0px; height: 700px; width: 100%; min-width: 200px">
		      <div class="ax5_grid" data-ax5grid="sales-grid" data-ax5grid-config="{}" style="height: 700px; width: 100%" ></div>            
        </div>
      </div>
      <div class="col-xs-4" style="padding-left: 0;">
		<div class="contents">
		    <!-- 리스트 -->
		      <div class="ax5_grid" data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 700px; width: 100%" ></div>
		      <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>
      </div>
    </div>		
		
		
		
		
    </div>
                    
</body>
</html>

<script type="text/javascript">
	var isFirst = true;
	var beforeIndex ='';
	ax5.ui.grid.formatter["chkYn"] = function () {
	    var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
	    if (this.value == "E"){
	        return ' ';
	    } else {
	        return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
	    }
	};
	var salesGridView = {
		    initView : function() {
		        this.target = new ax5.ui.grid();
		        this.target.setConfig({
			        showLineNumber: false,
					showRowSelector : true,
					multipleSelect : true,
					sortable : false,
		            target: $('[data-ax5grid="sales-grid"]'),
		            header : {
		                align : "center",
		                selector : true
		            },
		            body: {
		            	mergeCells : ["ordrsClntNm","ordrsNo","salesCd"],
		            	columnHeight: 26,
		                onClick: function () {
		                	var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                            	salesGridView.target.select(obj.__origin_index__, {selected: false});
                            });		                	
		                    this.self.select(this.dindex);
		                    if (this.item.dataGbn == 'D') {
			                    gridView.setData(0, this.item.salesCd);
		                    }
		                    
		                },
		                onDBLClick: function () {
		                	var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                            	salesGridView.target.select(obj.__origin_index__, {selected: false});
                            })		                	
		                    this.self.select(this.dindex);
		                    //debugger;
		                    if (this.item.dataGbn == 'D') {
			                    gridView.setData(0, this.item.salesCd);
		                    }
		                    
		                },
		           },
		           columns: [
		               {key: "upperCd",  		label: "upperCd", 		width: 160, hidden: false},
		               {key: "lowerCd",  		label: "lowerCd", 		width: 280, hidden: false,  treeControl: true},
		               {key: "lvl",				label: "LVL",			width: 80, align: "left" },
		               {key: "dsgnNo",  		label: "dsgnNo", 		width: 160, hidden: false, align: "left"},
		               {key: "path",  			label: "path", 			width: 300, hidden: false, align: "left"},
		               {key: "dataGbn",  		label: "원시구분", 		width: 80, hidden: false},
		           ],
		           page : {
	                    navigationItemCount : 10,
	                    height : 30,
	                    use : true,
	                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
	                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
	                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
	                    onChange : function() {
	                        gridView.setData(this.page.selectPage);
	                    }
	                },
	                tree: {
	                    use: true,
	                    indentWidth: 15,
	                    arrowWidth: 15,
	                    iconWidth: 18,
	                    icons: {
	                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
	                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                        groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
	                        collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
	                        itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
	                    },
		               columnKeys: {
		                   parentKey: "upperCd",
		                   selfKey: "lowerCd",
		               }
		           }
		        });
		        return this;
		    },
		    setData : function(_pageNo) {
	            var targetObj = this.target;
    			var paramObj = {
    					"coCd": $('#coCd_S').val(),
 	               }
	            postAjax("/user/sm/sm01/bomTreeList", paramObj, null, function(data){
	                var list = data.resultList;
	                    targetObj.setData({
	                        list : list,
	                        page : {
	                            totalElements : list.length,
	                        }
	                    });
	            });
	        } 
		    
		}
		var gridView = {
		    initView : function() {
		        this.target = new ax5.ui.grid();
		        this.target.setConfig({
		        	showRowSelector: true,
		            multipleSelect: true,
		            sortable: false,
		            target: $('[data-ax5grid="first-grid"]'),
		            header : {
		                align : "center",
		                selector : false
		            },
		           columns: [
						{key: "rnum",  label: "NO.", hidden:true},
						{key: "lvl",  label: "lvl", hidden:true},
						{key: "codeId",  label: "codeId", align: "left", width: 200, hidden:true, treeControl: true},
						{key: "codeKind",  label: "codeKind", hidden:true},
						{key: "coCd",  label: "회사코드", hidden:true},
						{key: "coCdNm",  label: "회사명", width: 80, hidden:true, align: "center"},
						{key: "salesCd",  label: "SALES CD", width: 100, hidden:true, align: "center"},
						{key: "codeNm",  label: "WBS 계획구분", align: "left", width: 200,  treeControl: true},

	        	   		{key: "fileTreeKey",  		label: "fileTreeKey", hidden:true},
	        	   		{key: "wbsPlanNo",  		label: "wbsPlanNo", hidden:true},
						{key: "wbsPlanStsCodeId",	label: "계획상태코드",   hidden: true},
	        	   		{key: "rsltsFileTrgtKey",  	label: "rsltsFileTrgtKey", hidden:true},
	        	   		{key: "rsltsWbsPlanNo",  	label: "rsltsWbsPlanNo", hidden:true},
						{key: "wbsPlanId",			label: "담당자",      hidden:true},
						{key: "wbsPlanNm",            label: "담당자",      hidden:true},
						{key: "wbsPlanDt",            label: "담당자",      hidden:true},
						{key: "wbsPlanStsNm",		label: "계획상태",      hidden:true}, 
						{key: "wbsPlanMngId",     label: "담당자",      hidden:true}, 
						{key: "wbsPlanMngNm",     label: "담당자",      align: "center",   width: 80}, 
						{key: "wbsPlanCnts",      label: "주요내용",      align: "left",   width: 100},
                        {key: "wbsPlanRmk",      label: "비고",      align: "left",   width: 100},    
						{label: "계획", columns: [  
							{key: "wbsPlanChkYn",		label: "계획",      align: "center",   width: 40, formatter: "chkYn"},  
							{key: "wbsPlansDt",			label: "시작일자",      align: "center",   width: 80},
							{key: "wbsPlaneDt",			label: "종료일자",      align: "center",   width: 80},
							{key: "lockYn",      		label: "잠금",      align: "center",   width: 40, formatter: "chkYn"},
							{key: "closeYn",      		label: "마감",      align: "center",   width: 40, formatter: "chkYn"},
							]},
						{label: "실적", columns: [ 
							{key: "wbsRsltsChkYn",      label: "실적",      align: "center",   width: 40, formatter: "chkYn"},  
							{key: "wbsRsltsRate",		label: "진행율",      align: "center",   width: 60},                   
							{key: "wbsRsltssDt",		label: "시작일자",      align: "center",   width: 80},
							{key: "wbsRsltseDt",		label: "종료일자",      align: "center",   width: 80},
							{key: "rsltsLockYn",      	label: "잠금",      align: "center",   width: 40, formatter: "chkYn"},
							{key: "rsltsCloseYn",      	label: "마감",      align: "center",   width: 40, formatter: "chkYn"},
							{key: "wbsPlanMh",			label: "계획공수",      align: "center",   width: 80},                   
							{key: "wbsRsltsMh",			label: "실적공수",      align: "center",   width: 80},
							{key: "wbsRsltsCnts",      label: "주요내용",      align: "left",   width: 100},
	                        {key: "wbsRsltsRmk",      label: "비고",      align: "left",   width: 100},    
						]},
						{key: "wbsRsltsId",			label: "담당자",      align: "center",   width: 80},                   
						{key: "wbsRsltsDt",			label: "실적일자",      align: "center",   width: 80},
						{key: "ordrsClntCd",      label: "고객사",     hidden: true},
						{key: "ordrsClntNm",      label: "고객사",      align: "center",   width: 130},
						{key: "clntPjt",      label: "고객사PJT",      align: "center",   width: 100},
						{key: "ordrsDtlDiv20",      label: "신작구분",      hidden: true},
						{key: "ordrsDtlDiv20Nm",      label: "신작",      align: "center",   width: 40},
						{key: "prdtCd",      label: "제품구분",      hidden: true},
						{key: "prdtCdNm",      label: "제품",      align: "center",   width: 130},
						{key: "itemDiv",      label: "ITEM구분",      hidden: true},
						{key: "itemDivNm",      label: "ITEM",      align: "center",   width: 100},	 
						
						{key: "creatId",      label: "생성자", align: "center",   width: 80},
                        {key: "creatPgm",      label: "생성프로그램ID",      hidden: true},
                        {key: "creatDttm",      label: "생성일시",      align: "center",   width: 80},                   
                        {key: "udtId",      label: "최종변경자",      align: "center",   width: 80},
                        {key: "udtPgm",      label: "최종수정프로그램ID",      hidden: true},
                        {key: "udtDttm",      label: "최종변경일자",      align: "center",   width: 80},
						
                        {key: "dsgnDifCodeId",      label: "설계난이도코드",      hidden: true},
						{key: "dsgnDifCodeNm",      label: "설계난이드명",      hidden: true},
						{key: "dsgnPlanHour",      label: "설계계획공수",      hidden: true},                   
						{key: "prdctnDifCodeId",      label: "생산난이도코드",      hidden: true},
						{key: "prdctnDifCodeNm",      label: "생산난이도명",      hidden: true},
						{key: "prdctnPlanHour",      label: "생산계획공수",      hidden: true},                   
						{key: "wbsPlanOsYn",      label: "계획외주코드",      hidden: true},
						{key: "wbsPlanOsNm",      label: "계획외주유무",      hidden: true},   
						{key: "wbsPlanCodeKind",      label: "WBS 상위코드",    hidden: true},
						{key: "wbsPlanCodeId",      label: "WBS 코드",      hidden: true},
						{key: "wbsPlanNo",      label: "WBS NO",      hidden: true},
						{key: "isLeaf", label: "isLeaf", align: "left", width: 60, hidden: true },
		           ],
		            body: {
		            	mergeCells : ["coCdNm","salesCd"],
		                columnHeight: 26,
 		                onClick: function () {
 		                	 /* var list = gridView.target.getList("selected");
 		                	 $.each(list, function(idx, obj){
                                 gridView.target.select(obj.__index, {selected: false});
                             }); */
 		                },
 		                
		                onDBLClick: function () {
		                	if (beforeIndex) {
		                		this.self.select(beforeIndex);
		                	}
		                    this.self.select(this.dindex);
		                    //debugger;
		                    if (
		                    	this.column.key=='wbsPlanChkYn' ||
		                    	this.column.key=='wbsPlansDt' || 
		                    	this.column.key=='wbsPlansDt' || 
		                    	this.column.key=='lockYn' || 
		                    	this.column.key=='closeYn') {
		                    	//계획 입력 또는 수정 작업
			                    var insUpd = this.item.fileTrgtKey ? 'U' : 'C';
			                    insertWbsPlanModal(insUpd, this.item.lvl-1, this.dindex);
							} else if (
			                    	this.column.key=='wbsRsltsChkYn' ||
			                    	this.column.key=='wbsRsltsRate' || 
			                    	this.column.key=='wbsRsltssDt' || 
			                    	this.column.key=='wbsRsltseDt' || 
			                    	this.column.key=='rsltsLockYn' || 
			                    	this.column.key=='rsltsCloseYn' || 
			                    	this.column.key=='wbsPlanMh' || 
			                    	this.column.key=='wbsRsltsMh') {
								//실적 입력 또는 수정 작업
			                    var insUpd = this.item.rsltsFileTrgtKey ? 'U' : 'C';
			                    insertWbsRsltsModal(insUpd, this.item.lvl-1, this.dindex);
							}
		                    
		                    beforeIndex = this.dindex;
		                },
		           },
		           page : {
	                    navigationItemCount : 10,
	                    height : 30,
	                    use : true,
	                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
	                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
	                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
	                    onChange : function() {
	                        gridView.setData(this.page.selectPage);
	                    }
	                },
	                tree: {
	                    use: true,
	                    indentWidth: 15,
	                    arrowWidth: 15,
	                    iconWidth: 18,
	                    icons: {
	                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
	                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                        groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
	                        collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
	                        itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
	                    },
		               columnKeys: {
		                   parentKey: "codeKind",
		                   selfKey: "codeId",
		               }
		           }
		        });
		        return this;
		    },
		    setData : function(_pageNo, paramSalesCode) {
		    	if (isFirst) return;
	            var targetObj = this.target;
	            var paramObj = {"coCd": $('#coCd_S').val(),
                      "salesCd" : paramSalesCode,
                      "pageNo" : _pageNo + 1,
                      "recordCnt" : $('#recordCnt').val()};
	            postAjax("/user/wb/wb01/selectNewWbsPlanTreeList", paramObj, null, function(data){
	                var list = data.fileList;
	                    targetObj.setData({
	                        list : list,
	                        page : {
	                            totalElements : list.length,
	                        }
	                    });
	            });
	        } 
		    
		}
	
	var excelView = {
	        initView: function(){
	        this.target = new ax5.ui.grid();
	        this.target.setConfig({
	        target: $('[data-ax5grid="excel-grid"]'),
	        columns: [
	        	 {key: "rnum",  label: "NO.", hidden:true},
	        	 {key: "fileTreeKey",  label: "fileTreeKey", hidden:true},
                 {key: "id",  label: "id", hidden:true},
                 {key: "pid",  label: "pid", hidden:true},
                 {key: "coCd",  label: "회사코드", hidden:true},
                 {key: "coCdNm",  label: "회사명", width: 80, align: "center"},
                 {key: "salesCd",  label: "SALES CD", width: 100, align: "center"},
                 {key: "codeNm",  label: "WBS 계획구분", align: "left", width: 130, enableFilter: true, treeControl: true},
                 {key: "wbsPlanStsCodeId",      label: "계획상태코드",      hidden: true},
                 {key: "wbsPlanStsNm",      label: "계획상태",      align: "center",   width: 70}, 
                 {key: "wbsPlansDt",      label: "시작일자",      align: "center",   width: 100},
                 {key: "wbsPlaneDt",      label: "종료일자",      align: "center",   width: 100},
                 {key: "wbsPlanMngId",      label: "담당자",      hidden: true},
                 {key: "wbsPlanMngNm",      label: "담당자",      align: "center",   width: 80},                   
                 {key: "lockYn",      label: "잠금",      align: "center",   width: 40},
                 {key: "closeYn",      label: "마감",      align: "center",   width: 40},
                 {key: "wbsRsltsDt",      label: "실적",      align: "center",   width: 40},  
                 {key: "ordrsClntCd",      label: "고객사",     hidden: true},
                 {key: "ordrsClntNm",      label: "고객사",      align: "center",   width: 130},
                 {key: "clntPjt",      label: "고객사PJT",      align: "center",   width: 100},
                 {key: "ordrsDtlDiv20",      label: "신작구분",      hidden: true},
                 {key: "ordrsDtlDiv20Nm",      label: "신작",      align: "center",   width: 40},
                 {key: "prdtCd",      label: "제품구분",      hidden: true},
                 {key: "prdtCdNm",      label: "제품",      align: "center",   width: 130},
                 {key: "itemDiv",      label: "ITEM구분",      hidden: true},
                 {key: "itemDivNm",      label: "ITEM",      align: "center",   width: 100},     
                 {key: "wbsPlanCnts",      label: "주요내용",      align: "left",   width: 200},
                 {key: "wbsPlanRmk",      label: "비고",      align: "left",   width: 100},                   
                 {key: "wbsPlanId",      label: "작성자",      hidden: true},
                 {key: "wbsPlanNm",      label: "작성자",      align: "center",   width: 80},
                 {key: "wbsPlanDt",      label: "작성일",   align: "center",   width: 80}, 
                 {key: "creatId",      label: "생성자",      hidden: true},
                 {key: "creatNm",      label: "생성자",      align: "center",   width: 80},
                 {key: "creatPgm",      label: "생성프로그램ID",      hidden: true},
                 {key: "creatDttm",      label: "생성일시",      align: "center",   width: 80},                   
                 {key: "udtId",      label: "최종변경자",      hidden: true},
                 {key: "udtNm",      label: "최종변경자",      align: "center",   width: 80},
                 {key: "udtPgm",      label: "최종수정프로그램ID",      hidden: true},
                 {key: "udtDttm",      label: "최종변경일자",      align: "center",   width: 80},
                 {key: "dsgnDifCodeId",      label: "설계난이도코드",      hidden: true},
                 {key: "dsgnDifCodeNm",      label: "설계난이드명",      hidden: true},
                 {key: "dsgnPlanHour",      label: "설계계획공수",      hidden: true},                   
                 {key: "prdctnDifCodeId",      label: "생산난이도코드",      hidden: true},
                 {key: "prdctnDifCodeNm",      label: "생산난이도명",      hidden: true},
                 {key: "prdctnPlanHour",      label: "생산계획공수",      hidden: true},                   
                 {key: "wbsPlanOsYn",      label: "계획외주코드",      hidden: true},
                 {key: "wbsPlanOsNm",      label: "계획외주유무",      hidden: true},   
                 {key: "wbsPlanCodeKind",      label: "WBS 상위코드",      hidden: true},
                 {key: "wbsPlanCodeId",      label: "WBS 코드",      hidden: true},
                 {key: "wbsPlanNo",      label: "WBS NO",      hidden: true}
	                 ]
	        });
	           return this;
	    }
	}        
	
	    $(document).ready(function() {

	        mainDefaultLoad("WBS", "일정계획관리");          // 페이지 타이틀 설정
	        setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set

	        $("#coCd_S").val(jwt.coCd);
	        // 시작일 (현재날짜의 월 첫일)
	        $('#reqDtFrom_S').datepicker({
	            format : "yyyy-mm-dd",
	            language : "ko",
	            autoclose : true
	        })

	        .datepicker("setDate", moment(new Date()).startOf("month").toDate())
	        .on("changeDate", function(){
	            if($('#reqDtFrom_S').val() > $('#reqDtTo_S').val()){
	                alert("날짜를 확인해주세요");
	                $('#reqDtFrom_S').datepicker("setDate", new Date($('#reqDtTo_S').val()));
	            }
	        });

	        // 종료일 (현재날짜의 월 말일)
	        $('#reqDtTo_S').datepicker({
	            format : "yyyy-mm-dd",
	            language : "ko",
	            autoclose : true
	        })
	        .datepicker("setDate", moment(new Date()).endOf("month").toDate())
	        .on("changeDate", function(){
	            if($('#reqDtFrom_S').val() > $('#reqDtTo_S').val()){
	                alert("날짜를 확인해주세요");
	                $('#reqDtTo_S').datepicker("setDate", new Date($('#reqDtFrom_S').val()));
	            }
	        });


	        isFirst = false;    
	        salesGridView.initView().setData(0);
	        gridView.initView();
	        excelView.initView();
	          // 검색조건 이벤트 bind
	        $('[data-search]').on("change", function(){
	            gridView.setData(0);
	        });
	        
	        //권한체크
	        authChk();

	    });
	    
	    // 초기화 버튼용
	    function initSearch() {
	        $('[data-search]').off("change");   //바인딩기능 오프
	        $('.contents.search select, .contents.search input').val("");
	        $("#reqDtFrom_S").val(dateToStr(moment(new Date()).startOf("month").toDate()));
	        $("#reqDtTo_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
	        $("#coCd_S").val(jwt.coCd);
	        // 검색조건 이벤트 bind
	        $('[data-search]').on("change", function(){
	            gridView.setData(0);
	        });
	        salesGridView.initView().setData(0);
	        gridView.initView().setData(0);
	    }
	 
	    // 고객사 검색
	    function openClntSearch(openType) {
	        var paramObj = {
	                "searchValue" :  $("#clntNm_S").val()
	        }       
	        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
	            var row = grid.target.getList("selected")[0];
	            if(openType == "P"){
	                $('#clntCd_S').val(row.clntCd);
	                $('#clntNm_S').val(row.clntNm);
	                gridView.setData(0);
	            }else if(openType == "V"){
	                $('#vendCd_S').val(row.clntCd);
	                $('#vendNm_S').val(row.clntNm);
	            }
	        });
	    }
	 
	    //제품코드 검색
	    function openPrdtSearch(){
	        var paramObj = {
	                "coCd": $('#coCd').val(),
	                "prdtCd": $('#prdtCd_S').val(),
	                "prdtNm": $('#prdtNm_S').val(),
	                "useYn" : "Y"
	        }
	        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
	            var row = grid.target.getList("selected")[0];
	            $("#prdtCd_S").val(row.prdtCd);
	            $("#prdtNm_S").val(row.prdtNm);
	        });
	    }
	    
	    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
	    function wbsSalesCodeSearch() {
	        var paramObj = {
	           "coCd" : $('#coCd_S').val(),
	           "salesCd": $('#salesCd_S').val()
	        };
	        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid){
	            var row = grid.target.getList("selected")[0];
	            $('#salesCd_S').val(row.salesCd);
	        });
	    }
	    
	    //관리번호 (WbsPlanNo) 검색
	    function wbsPlanNoSearch() {
	        var paramObj = {
	           "coCd" : $('#coCd_S').val(),
	           "wbsPlanNo": $('#wbsPlanNo_S').val()
	        };
	        openSecondModal("/static/html/cmn/modal/wbsPlanNoSearch.html", 450, 300, "관리번호 검색", paramObj, function (grid){
	            var row = grid.target.getList("selected")[0];
	            $('#wbsPlanNo_S').val(row.wbsPlanNo);
	        });
	    }
	    
	    //공유대상자 검색
	    function openUserTree() {
	        var paramObj = {
	            "coCd" : $('#coCd_S').val(),
	            "userId": $('#salesMngNm_S').val(),
	            "useYn": "Y"
	        };
	        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
	            var checkedId = tree.get_checked()[0];
	            var checkedNode = tree.get_node(checkedId);
	            $('#salesMngId_S').val(checkedNode.id);
	            $('#salesMngNm_S').val(checkedNode.text);
	        });
	    }
	  
	    
	    function excelDown() {
	    	var paramObj = {"coCd": $('#coCd_S').val(),
                    "reqDtFrom" : $("#reqDtFrom_S").val().replace(/\-/g, ''),
                    "reqDtTo": $("#reqDtTo_S").val().replace(/\-/g, ''),
                    "clntCd" : $("#clntCd_S").val(),
                    "clntNm" : $("#clntNm_S").val(),
                    "salesCd" : $("#salesCd_S").val(),
                    "prdtCd" : $("#prdtCd_S").val(),
                    "prdtNm" : $("#prdtNm_S").val(),
                    "itemCd" : $("#itemCd_S").val(),
                    "clntPjt" : $("#clntPjt_S").val(),
                    "eqpNm" : $("#eqpNm_S").val(),
                    "salesMngId" : $("#salesMngId_S").val(),
                    "salesMngNm" : $("#salesMngNm_S").val(),
                    "wbsPlanNo" : $("#wbsPlanNo_S").val()
                    };
	        postAjax("/user/wb/wb01/selectWbsPlanExcelList", paramObj, null, function(data){
	            var list = data.resultList;
	            excelView.target.setData({
	               list : list,
	               page : {
	                         totalElements : list.length,
	               }
	            });
	            var todayDate = new Date().format('yyyyMMddHHmmss');
	            excelView.target.exportExcel("일정계획등록_"+todayDate+".xls");
	         });   
	    }
	    
	    function deleteWbs() {
	        var row = gridView.target.getList("selected")[0];
	        if (row != undefined) {
	            //계획 미마감, 미잠금 상태, 실적 데이터 없을 경우에서 삭제 가능, 삭제 시 해당 SALES코드와 같은 계획, TODO-LIST 계획 공유 삭제 
	            if (row.closeYn == "Y" || row.lockYn == "Y") {
	              alert("선택된 WBS 계획은 잠금 또는 마감된 상태입니다. 삭제할  수 없습니다.");  
	              return;
	            } 
	        }

	        var formData = {	       
	            "coCd" : row.coCd,
	            "salesCd" : row.salesCd,
	            "wbsPlanNo" : row.wbsPlanNo,
	            "codeKind" : row.wbsPlanCodeKind,
	            "codeId" : row.wbsPlanCodeId,
	            "S_todoDiv1CodeId" : "TODODIV10",
	            "S_todoDiv2CodeId" : "TODODIV1010"
	        };           
	        postAjax("/user/wb/wb01/selectWbsPlanDeleteConfirmCount", formData, null, function(data){
	            if(data.result == 0) {
	                if(confirm("삭제하시겠습니까?")){
	                    deleteAjax("/user/wb/wb01/deleteWbsPlanlist", formData, null, function(data){
	                        if(data.resultCode == 200){
	                            alert(data.resultMessage);
	                            gridView.setData(0);
	                        }
	                    });
	                }
	            } else {
	                alert("하위 레벨 데이터가 존재합니다."); 
	            }
	        });          
	  }	  
	    
	  /*계획 수정 or 등록 버튼 클릭 시*/
	  function insertWbsPlanModal(type, lvl, idx) {	
		  var row = gridView.target.getList()[idx]; 
		 // debugger;
          
          if (row != undefined) {
              var actionType = type;
              var fileTrgtKey = row.fileTrgtKey;
              var coCd = row.coCd;
              var lvl = lvl;
              var idx1 = null;
              var idx2 = null;
              var idx3 = null;
              var salesCd = row.salesCd;
              
              if (lvl == 1) {
                  idx1 = idx;
              }
              else if (lvl == 2) {
                  idx2 = idx;
                  
                  //1레벨 조회
                  var list1 = gridView.target.getList();
                  $.each(list1, function(idx, obj){
                      var row1 = gridView.target.getList()[obj.__index];
                      if (row1.coCd == row.coCd && row1.salesCd == row.salesCd && row1.codeId == row.codeKind) {
                          idx1 = obj.__index;                         
                      }
                  });
              }
              else if (lvl == 3) {
                  idx3 = idx;
                  //2레벨 조회
                  var list1 = gridView.target.getList();
                  $.each(list1, function(idx, obj){
                      var row1 = gridView.target.getList()[obj.__index];
                      if (row1.coCd == row.coCd && row1.salesCd == row.salesCd && row1.codeId == row.codeKind) {
                          idx2 = obj.__index;                         
                      }
                  });

                  //1레벨 조회
                  var row2 = gridView.target.getList()[idx2];                    
                  var list2 = gridView.target.getList();
                  $.each(list2, function(idx, obj){
                      var row3 = gridView.target.getList()[obj.__index];
                      if (row3.coCd == row2.coCd && row3.salesCd == row2.salesCd && row3.codeId == row2.codeKind) {
                          idx1 = obj.__index;                         
                      }
                  });
              }

              //alert("lvl:" + lvl + "idx1:" +  idx1 +  "idx2:" +  idx2  + "idx3:"  + idx3 + "  salesCd:"  + salesCd);
              if (type == 'U') {
                  var paramObj = {
                      "actionType" : actionType,
                      "fileTrgtKey" : fileTrgtKey,
                      "coCd" : coCd,
                      "lvl"      : lvl,
                      "idx1"      : idx1,
                      "idx2"   : idx2,
                      "idx3"  : idx3,
                      "salesCd" : salesCd
                  };
              } else {
                  var paramObj = {
                          "actionType" : actionType,
                          "fileTrgtKey" : 0,
                          "coCd" : coCd,
                          "lvl"      : lvl,
                          "idx1"      : idx1,
                          "idx2"   : idx2,
                          "idx3"  : idx3,
                          "salesCd" : salesCd
                  }
              }
              openModal("/static/html/user/wb/wb01/WB0111P01.html", 1600, 850, "", paramObj, function(data) {
                  gridView.setData(0);
              }); 
          }
	 }
	        
	  /*실적 수정 or 등록 버튼 클릭 시*/
	  function insertWbsRsltsModal(type, lvl, idx) {
		    var row = gridView.target.getList()[idx]; 
		    if (row != undefined) {
			    var actionType = type;
			    var fileTrgtKey = row.rsltsFileTrgtKey;
			    var coCd = row.coCd;
			    var lvl = lvl;
			    var idx1 = null;
			    var idx2 = null;
	            var idx3 = null;
	            var salesCd = row.salesCd;
	            
	            if (lvl == 1) {
	            	idx1 = idx;
	            }
	            else if (lvl == 2) {
	            	idx2 = idx;
	            	
	            	//1레벨 조회
	            	var list1 = gridView.target.getList();
                    $.each(list1, function(idx, obj){
                    	var row1 = gridView.target.select(obj.__index);
                    	if (row1.coCd == row.coCd && row1.salesCd == row.salesCd && row1.codeId == row.codeKind) {
                    		idx1 = obj.__index;                    		
                    	}
                    });
	            }
                else if (lvl == 3) {
                	idx3 = idx;
                	//2레벨 조회
                    var list1 = gridView.target.getList();
                    $.each(list1, function(idx, obj){
                        var row1 = gridView.target.select(obj.__index);
                        if (row1.coCd == row.coCd && row1.salesCd == row.salesCd && row1.codeId == row.codeKind) {
                            idx2 = obj.__index;                         
                        }
                    });

                    //1레벨 조회
                    var row2 = gridView.target.getList()[idx2];                    
                    var list2 = gridView.target.getList();
                    $.each(list2, function(idx, obj){
                        var row3 = gridView.target.select(obj.__index);
                        if (row3.coCd == row2.coCd && row3.salesCd == row2.salesCd && row3.codeId == row2.codeKind) {
                            idx1 = obj.__index;                         
                        }
                    });
                }

	            //alert("lvl:" + lvl + "idx1:" +  idx1 +  "idx2:" +  idx2  + "idx3:"  + idx3 + "  salesCd:"  + salesCd);
	            if (type == 'U') {
	                var paramObj = {
	                		"actionType" : actionType,
	                        "fileTrgtKey" : fileTrgtKey,
	                        "coCd" : coCd,
	                        "lvl"      : lvl,
	                        "idx1"      : idx1,
	                        "idx2"   : idx2,
	                        "idx3"  : idx3,
	                        "salesCd" : salesCd
	                };
	            } else {
	                var paramObj = {
	                		"actionType" : actionType,
	                        "fileTrgtKey" : 0,
	                        "coCd" : coCd,
	                        "lvl"      : lvl,
	                        "idx1"      : idx1,
	                        "idx2"   : idx2,
	                        "idx3"  : idx3,
	                        "salesCd" : salesCd
	                }
	            }
	            openModal("/static/html/user/wb/wb01/WB0111P02.html", 1600, 850, "", paramObj, function(data) {
	                gridView.setData(0);
	            });
		    }
	 }

</script>
