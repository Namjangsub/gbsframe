
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<script src="/static/js/jstree/jstree.min.js"></script>
<style>
	.add_btn_small {
		display: inline-block;
		padding: 0px;
	}
	
	.add_btn_small a {
		display: inline-block;
		width: 33px;
		height: 20px;  
		line-height: 20px;
		text-align: center;
		color: #444;
		background: #ffffff;
		box-shadow: 1px 1px rgba(0, 0, 0, 0.15);
	}
	
	
	 div#wrapper {
		width: 950px;
		height: 700px;
		margin-left: 500px;
	 }
	 
	 div#form {
		float: left;
		padding: 10px 0px 0px 10px;
		width: 400px;
		height: 700px;
		border: 1px solid;
	 }
	 
	 div#tree_wrapper {
		float: left;
		padding: 10px 0px 0px 10px;
		width: 500px;
		height: 700px;
		margin-left: 2px;
		border: 1px dashed;
		display: none;
	 }
	 
	 div#MatrBomTree  {
		margin: 0px 2px 0px 2px;
	/*   width: 470px; */
		height: 640px;
		border: 1px solid;
		overflow: auto;
	 }
	 
	 div#search_guide_wrapper {
		padding: 10px 0px 0px 10px;
		width: 500px;
		height: 700px;
		margin-left: 2px;
		border: 1px dashed;
		float: left;
	 }
    .resizable-div {
      border: 1px dashed #bbb9b9;
    }

	</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">구매BOM 등록</h4>
	</div>
	
	<div class="form-group popup_table">
		<form id="popForm" onSubmit="return false;">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
			<input type="hidden" id="pgmId" name="pgmId" value="SM0101P01">
			
			<table>
				<colgroup>
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
				</colgroup>
				
				<tr>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control" required="required" msg="회사" readonly="readonly">
							
						</select>
					</td>
					
					<th>수주번호</th>
					<td>
						<input type="text" id="ordrsNo" name="ordrsNo" class="form-control" required="required" msg="Sales Code" readonly="readonly">
					</td>
					
					<th>Sales Code</th>
					<td>
						<input type="text" id="salesCd" name="salesCd" class="form-control" required="required" msg="Sales Code" readonly="readonly">
					</td>

					<th>고객사</th>
					<td>
						<input type="text" id="clntNm" name="clntNm" class="form-control" msg="고객사" readonly="readonly">
					</td>
					
					<th>고객사PJT</th>
					<td>
						<input type="hidden" id="clntPjt" name="clntPjt" class="form-control" msg="고객사PJT" readonly="readonly">
						<input type="text" id="clntPjtNm" name="clntPjtNm" class="form-control" msg="고객사PJT" readonly="readonly">
					</td>
				</tr>
		
				<tr>
					<th style="height:26px">아이템구분</th>
					<td>
						<input type="text" id="itemDivNm" name="itemDivNm" class="form-control" msg="아이템구분" readonly="readonly">
					</td>
					
					<th>제품구분</th>
					<td colspan="3">
						<input type="text" id="prdtNm" name="prdtNm" class="form-control" msg="제품명" readonly="readonly">
					</td>

					<th>설비명</th>
					<td colspan="3">
						<input type="text" id="eqpNm" name="eqpNm" msg="설비명" class="form-control" readonly="readonly">
					</td>
				</tr>
			</table>
		</form>
		
		<div class="row" style="margin-top: 5px;">
			<div id="treeFrame" class="col-xs-3 resizable-div" style="padding-right: 1px; min-height: 247px; ">
				<div class="contents" style="margin: 0px; padding: 0px; height: 100%;  min-height: 245px; min-width: 200px;">
					<h3 class="location">
						<span class="page_tit" style="text-align: left;"> PART내역</span>
					</h3>
					<div style="float: right;">
						<a id="bomsyncBtn" class="btn btn-default btn-sm" onclick="syncBom();" authChk>설계BOM적용</a>
						<a id="treeExpandBtn" class="btn btn-default btn-sm" onclick="treeExpandClose()"><i class="fas fa-chevron-up"></i></a>
					</div>
					<div id="MatrBomTree" style="height: 650px;  width: 100%; text-align: left;" ></div>
				</div>
			</div>
			
			<div id="gridFrame" class="col-xs-9 resizable-div" style="padding-left: 1px; padding-right: 20px; min-height:247px;">
				<div class="contents " style="margin:0px; padding:0px; height: 100%; width: 100%; min-height:200px; min-width: 245px">
					<h3 class="location">
						<span class="page_tit" style="text-align: left;"> BOM자재</span>
					</h3>

					<div class="search_form" style="width:90px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
						<input data-maxlength="300" style="height:25px;" type="text" id="pchsClntNm_S" name="pchsClntNm_S" placeholder="발주거래처명">
					</div>
					
					<div class="search_form" style="width:90px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
						<input data-maxlength="300" style="height:25px;" type="text" id="mngNm_S" name="mngNm_S" placeholder="발주담당자명">
					</div>
					
					<div class="search_form" style="width:90px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
						<input data-maxlength="300" style="height:25px;" type="text" id="matr_dlvplcNm" name="matr_dlvplcNm" placeholder="물품배송처">
					</div>

					<div style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
						<input data-positive style="width:80px;height:25px;" type="text" id="matr_bomQty" name="matr_bomQty" placeholder="발주대상수량"
						onkeyUp="if(window.event.keyCode == 13){matrGridDataChange('bomQty','matr_bomQty');}">
					</div>

					<div style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
						<input data-positive style="width:80px;height:25px;" type="text" id="matr_posQty" name="matr_posQty" placeholder="소요량"
						onkeyUp="if(window.event.keyCode == 13){matrGridDataChange('posQty','matr_posQty');}">
					</div>
					
					<div class="add_btn pdl10" style="float:right;margin-right:8px; margin-top: 8px;">
						<button type="button" id="actionBtn" authChk>등록</button>
						<a data-onclick="openMatListSearchMulti()" onclick="openMatListSearchMulti()" style="width: 80px;" authchk><i class="fas fa-folder-plus"></i> 자재검색</a>
						<a data-onclick="updateBomMtrlSecondModal()" onclick="updateBomMtrlSecondModal()" style="width: 80px;" authchk><i class="fas fa-money-check"></i> 자재수정 </a>
						<a data-onclick="delRowMatr()" onclick="delRowMatr()" style="width: 50px;" authchk><i class="fas fa-trash"></i> 삭제 </a>
					</div>

					<div data-ax5grid="matr-grid" data-ax5grid-config="{}" style="height: 650px;  min-height:200px;"></div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" class="close_btn" onclick="modalStack.last().callback(); modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	var thisGridRow = null; // 선택된 행 정보 저장할 변수
	var thisGridCol = null; // 선택된 열 정보 저장할 변수
	var actionType = null;
	var firstGrid = null;
	var secondGrid = null;

	var matrArr = [];  //자재 데이타

	var before_bomIdx = -1;
	var before_dsgnNo = null;
	var before_lowerCd = null;
	var select_bomIdx = -1;
	var select_dsgnNo = null;
	var select_lowerCd = null;
	var select_upperCd = null;
	var treeChkRefresh = '';	//왼쪽 jstree refresh 변경여부

	let bomData = "";

	function gridStyle(row) {
		if (!row) return "";
		if (row.dtaChk === "D")  return "grid-cell-orange";
		if (row.matrYn == "자재") {
			if (pasFloatChk(row.bomQty) == 0)  return "grid-no-msg-font-blue-bold";
		}
		return "";
	}
	
	var matrGridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect  : true,
				sortable        : false,
				target          : $('[data-ax5grid="matr-grid"]'),
				header : {
					align    : "center",
					selector : true
				},
				body: {
					//mergeCells : ["coCd","salesCd", "dsgnNo", "upperCd","lowerCd","ordrgDiv10"],
					onClick: function () {
						$.each($.extend({}, this.list), function(idx, obj) {
							matrGridView.target.select(obj.__index, {selected: false});
						});
						this.self.select(this.dindex);
					},
					onDBLClick: function () {
						if (this.item.matrYn != "자재") {
							matrGridView.setData(this.item.treeLowerCd);							
						} else {
							if(this.item.matrCd == undefined || this.item.matrCd === '') {
								return;
							}
							updateBomMtrlSecondModal();
						}
					},
					onDataChanged: function () {
						// 입력항목이 이전데이타와 같다면 저장체크(dtaChk) 지움
						// 데이타조회 initGridDataNullValue 사용 , 이전데이타 조회
						if(isSameValue(this.list, this.dindex, getViewColumnKey(matrGridView.target,["dtaChk"])) == true) {
							this.item.__modified__ = false;
						}
						
						if(this.item.dtaChk != "I" && this.key != "dtaChk" && this.key != "__selected__" && this.item.__modified__) {
							if(isEmpty(this.item.dtaChk)) {
								this.item.dtaChk = "U";
							}
						} else if (this.item.dtaChk != "I" && this.key != "dtaChk" && this.key != "__selected__") {
							this.item.dtaChk = "";
						}
						
						if(this.key == "bomQty" && this.value != "") {
							this.item.bomQty = Number(this.item.bomQty.replace(/[^0-9]/g,""));
						}
						
						if(this.key == "posQty" && this.value != "") {
							this.item.posQty = Number(this.item.posQty.replace(/[^0-9]/g,""));
						}
						
						if(this.item.matrCd == undefined || this.item.matrCd === ''){
							setClearValue(this.dindex);
						}
						
						this.self.repaint();
					},
				},
				columns : [
					{key: "text", label: "도번/품명", width: 250, align: "left", treeControl: true, styleClass: function () { return gridStyle(this.item); }},
					{key: "dtaChk"     , label: " "           , width: 30 , hidden:true},
					{key: "coCd"       , label: "CO"          , width: 50 , align: "center", hidden:true},
					{key: "ordrsNo"    , label: "ordrsNo"     , width: 80 , align: "center", hidden:true},
					{key: "salesCd"    , label: "salesCd"     , width: 120, align: "left"  , hidden:true},
					{key: "matrSeq"    , label: "자재순번"    , width: 70 , align: "center", hidden:true},
					{key: "oldUpperCd" , label: "이전상위코드", width: 160, align: "left"  , hidden:true},
					{key: "oldLowerCd" , label: "이전하위코드", width: 180, align: "left"  , hidden:true},
					{key: "matrYn"	   , label: "자재"    	  , width: 35, align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "pchsClntNm1", label: "최종구매업체", width: 80 , align: "left", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrMat", label: "소재/Maker", width: 100, align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrSpec", label: "형번/규격", width: 120, align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrSize"   , label: "크기"        , width: 80, align: "center", styleClass: function () { return gridStyle(this.item); },
						editor:{type: "text",
							attributes: {'maxlength': 100,'data-maxlength': 100},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					{key: "pchsClntNm", label: "발주거래처명"    , width: 118, align: "left", styleClass: function () { return gridStyle(this.item); },
						editor : {
							type: "text",
							attributes: {'maxlength': 100,'data-maxlength': 300},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					{key: "mngNm", label: "담당자"    , width: 80, align: "left", styleClass: function () { return gridStyle(this.item); },
						editor : {
							type: "text",
							attributes: {'maxlength': 20,'data-maxlength': 20},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					// {key: "popupGrid1", label: " "     , width: 30 , align: "center", formatter: "popupGrid1"},
					{key: "dlvplcNm"  , label: "물품배송처", width: 118, align: "left", styleClass: function () { return gridStyle(this.item); },
						editor : {type: "text",
							attributes: {'maxlength': 100,'data-maxlength': 300},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					// {key: "popupGrid2", label: " "           , width: 30,	align: "center", formatter: "popupGrid2"},
					{key: "bomQty"    , label: "발주대상수량", width: 80 , align: "right" , styleClass: function () { return gridStyle(this.item); },
						editor:{type: "number",
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					{key: "posQty"    , label: "소요량"      , width: 60 , align: "right" , styleClass: function () { return gridStyle(this.item); },
						editor:{type: "number",
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					{key: "matrCd"    , label: "자재코드"    , width: 80 , align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrRmk"       , label: "설계 비고"          , width: 150, align: "left", styleClass: function () { return gridStyle(this.item);}},
					{key: "popupGrid3", label: " "           , width: 30 , align: "center", formatter: "popupGrid3"},
					{key: "matrSpec"  , label: "비고"    , width: 100, align: "left",
						editor : {type: "text",
							attributes: {'maxlength': 300,'data-maxlength': 300},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						},
						hidden:true
					},
					{key: "matrMakrNm", label: "제조사"  , width: 100, align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrWt"    , label: "중량(kg)"    , width: 60, align: "right", formatter:"money", 
						editor:{type: "number",
							disabled : function () {
								return this.item.matrYn == "true";
							}
						}
					},
					{key: "matrUnit"  , label: "단위"    , width: 100, align: "center",
						editor: {type: "select",
							config: {
								columnKeys: {optionValue: 'value',optionText: 'text'},
								options: options_07
							},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						},
						formatter: function () {
							var result_text = "";
							var itemValue = this.item.matrUnit;
							$.each(options_07, function (idx, elem) {
								if(itemValue == elem.value) result_text = elem.text;
							});
							return result_text;
						}
					},
					{key: "matrNm"    , label: "자재명"      , width: 160, align: "left", styleClass: function () { return gridStyle(this.item); }},
					{key: "useYn"      , label: "사용여부"    , width: 70 , align: "center", formatter: "useYn"},
					{key: "matrStockCd", label: "재고관리"    , width: 70 , align: "center", formatter: "useYn"},
					{key: "originNm"   , label: "원산지"      , width: 100, align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrDrwNo"  , label: "대표도면"    , width: 120, align: "center", styleClass: function () { return gridStyle(this.item); }},
					{key: "matrTestDiv", label: "입고검사구분", width: 100, align: "center",
						editor: {type: "select",
							config: {
								columnKeys: {optionValue: 'value',optionText: 'text'},
								options: options_08
							},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						},
						formatter: function () {
							var result_text = "";
							var itemValue = this.item.matrTestDiv;
							$.each(options_08, function (idx, elem) {
								if(itemValue == elem.value) result_text = elem.text;
							});
							return result_text;
						}
					},
					{key: "dlvrRqmDay" , label: "납품소요일자" , width: 100, align: "right", formatter:"money"},
					{key: "matrPurcDiv", label: "구매/외주구분", width: 100, align: "center",
						editor: {type: "select",
							config: {
								columnKeys: {optionValue: 'value',optionText: 'text'},
								options: options_09
							},
							disabled : function () {
								return this.item.matrYn == "true";
							}
						},
						formatter: function () {
							var result_text = "";
							var itemValue = this.item.matrPurcDiv;
							$.each(options_09, function (idx, elem) {
								if(itemValue == elem.value) result_text = elem.text;
							});
							return result_text;
						}
					},
					{key: "minOrdrgQty"   , label: "최소발주량"    , width: 100, align: "right" , formatter:"money"},
					{key: "matrSaftQty"   , label: "안전재고"      , width: 100, align: "right" , formatter:"money"},
					{key: "dsgn2dMd"      , label: "2D설계소요일"  , width: 100, align: "right" , formatter:"money"},
					{key: "avrg2dMd"      , label: "2D평균소요일"  , width: 100, align: "right" , formatter:"money"},
					{key: "dsgn3dMd"      , label: "3D설계소요일"  , width: 100, align: "right" , formatter:"money"},
					{key: "avrg3dMd"      , label: "3D평균소요일"  , width: 100, align: "right" , formatter:"money"},
					{key: "prdctnRqmMd"   , label: "생산소요일"    , width: 100, align: "right" , formatter:"money"},
					{key: "prdctnAvrgMd"  , label: "생산평균소요일", width: 100, align: "right" , formatter:"money"},
					{key: "matrPartNo"    , label: "파트번호"      , width: 100, align: "center"},
					{key: "pchsClntCd1"   , label: "구매업체1"     , width: 80 , align: "right" , hidden:true},
					{key: "pchsClntPct1"  , label: "발주비율1"     , width: 80 , align: "right"},
					{key: "pchsClntCd2"   , label: "구매업체2"     , width: 80 , align: "right" , hidden:true},
					{key: "pchsClntNm2"   , label: "구매업체1"     , width: 80 , align: "left"},
					{key: "pchsClntPct2"  , label: "발주비율2"     , width: 80 , align: "right"},
					{key: "pchsClntCd3"   , label: "구매업체3"     , width: 80 , align: "right" , hidden:true},
					{key: "pchsClntNm3"   , label: "구매업체1"     , width: 80 , align: "left"},
					{key: "pchsClntPct3"  , label: "발주비율3"     , width: 80 , align: "right"},
					{key: "matrUpr"       , label: "최종구매단가"  , width: 100, align: "right" , formatter: "money"},
					{key: "matrAvrgUpr"   , label: "평균구매단가"  , width: 100, align: "right" , formatter: "money"},
					{key: "matrLastTrstDt", label: "최종거래일자"  , width: 100, align: "center", styleClass: function () { return gridStyle(this.item);}},
					{key: "matrAtntCd", label: "대체자재코드", width: 100, align: "center", styleClass: function () { return gridStyle(this.item);}},
					{key: "matrNo", label: "자재번호", width: 100, align: "center", styleClass: function () { return gridStyle(this.item);}},
					{key: "upperNm"   , label: "상위"  , width: 80 , align: "left", hidden:true},
					{key: "lowerNm"   , label: "하위"  , width: 80 , align: "left", hidden:true},
					{key: "avlbStrtDt", label: "FROM"  , width: 80 , align: "left", hidden:true},
					{key: "avlbEndDt" , label: "TO"    , width: 80 , align: "left", hidden:true},
					{key: "partNo"    , label: "PART"  , width: 80 , align: "left", hidden:true},
					{key: "unitNo"    , label: "UNIT"  , width: 80 , align: "left", hidden:true},
					{key: "revNo"     , label: "리버전", width: 80 , align: "left", hidden:true},
					{key: "dsgnNo"    , label: "도번" , width: 160, align: "left", styleClass: function () { return gridStyle(this.item);}},
					{key: "treeUpperCd", label: "상위코드"    , width: 60, align: "left", hidden:true},
					{key: "treeLowerCd", label: "하위코드"    , width: 60, align: "left", hidden:true},
					{key: "upperCd"    , label: "상위코드"    , width: 60, align: "left", hidden:false},
					{key: "lowerCd"    , label: "하위코드"    , width: 60, align: "left", hidden:false},
				],
				tree: {
					use: true,
					indentWidth: 15,
					arrowWidth: 15,
					iconWidth: 18,
					icons: {
						openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
						collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
						groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
						collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
						itemIcon: '<i class="fa fa-cog" aria-hidden="true"></i>'
					},
					columnKeys: {
						parentKey: "treeUpperCd",
						selfKey: "treeLowerCd",
					}
				}
			});
			return this;
		},
		selectGrid : function(click_dsgnNo) {
			
		},
		setData: function(select_lowerCd, select_upperCd) {
			var target = this.target;
			if(select_upperCd == null || select_upperCd == "") {
				select_upperCd = "top";
			}
			var formData = {
				"coCd"    : $("#coCd").val(),
				"ordrsNo" : $("#ordrsNo").val(),
				"salesCd" : $("#salesCd").val(),
				"upperCd" : select_upperCd,
				"lowerCd" : select_lowerCd
			}

			postAjax("/user/sm/sm01/selectBomMatrList", formData, null, function(data) {
				var list = data.resultList;

				target.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
				gridHeightResize(matrGridView, 229); // 229 = 919 - 690 : 화면 Body 높이 - 그리드 기본크기 690
				$('#MatrBomTree').height($('body').height()-229);
			});
		}
	}

	//"nextPrcsnNm",
	ax5.ui.grid.formatter["popupGrid1"] = function () {
		var aHtml = "";
		aHtml += '<a style="background:url(/static/img/svg/search.svg) no-repeat 50% 50%;background-size:18px 18px;opacity:0.5;" ';
		aHtml += 'onclick="openClntSearchGrid(\'pchsClntNm\','+this.dindex+');" data-onclick="openClntSearchGrid(\'pchsClntNm\','+this.dindex+');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>';
		
		if(this.item.matrCd == undefined || this.item.matrCd === '') {
			aHtml = "";
		}
		return aHtml;
	};
	
	//dlvplcNm
	ax5.ui.grid.formatter["popupGrid2"] = function () {
		var aHtml = "";
		aHtml += '<a style="background:url(/static/img/svg/search.svg) no-repeat 50% 50%;background-size:18px 18px;opacity:0.5;" ';
		aHtml += 'onclick="openClntSearchGrid(\'dlvplcNm\','+this.dindex+');" data-onclick="openClntSearchGrid(\'dlvplcNm\','+this.dindex+');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>';
		return aHtml;
	};
	
	//openMatListSearch
	ax5.ui.grid.formatter["popupGrid3"] = function () {
		var aHtml = "";
		aHtml += '<a style="background:url(/static/img/svg/search.svg) no-repeat 50% 50%;background-size:18px 18px;opacity:0.5;" ';
		aHtml += 'onclick="openMatListSearchGrid(\'matrCd\','+this.dindex+');" data-onclick="openMatListSearchGrid(\'matrCd\','+this.dindex+');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>';
		if(this.item.matrCd == undefined || this.item.matrCd === '') {
			aHtml = "";
		}
		return aHtml;
	};

	ax5.ui.grid.formatter["useYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if(this.item.matrCd == undefined || this.item.matrCd === '') {
			return ;
		}
	
		if (this.value == "E") {
			return '';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};
	
	var bom_ckColumn = "lastDsgnNo,dsgnNm,dsgnBomQty,upperCd,lowerCd";
	
	//선택자재 그리트 값변경
	function matrGridDataChange(column, val_id) {
		var thisValue = $('[name="'+val_id+'"]').val();
		if(val_id == "matr_ordrgDiv20" || val_id == "matr_ordrgDiv10") {
			if(isEmpty(thisValue)) {
				$('[name="'+val_id+'"]').css("color","gray");
			} else {
				$('[name="'+val_id+'"]').css("color","#444444");
			}
		}
		var selDataList = matrGridView.target.getList("selected");
		if(selDataList.length == 0) return;
		$.each($.extend({}, selDataList), function(idx, elem) {
			if(isEmpty(elem.dtaChk)) {
				elem.dtaChk = "";
			}
			matrGridView.target.setValue(elem.__index, column, thisValue);
		});
	}
	
	//그리드 거래처 검색
	function openClntSearchGrid(column, rowIndex) {
		var __select__  =  getValue(matrGridView.target.list, rowIndex, "__selected__");
		if(__select__ == true){
			matrGridView.target.select(rowIndex);
		}
		var searchValue = getValue(matrGridView.target.list, rowIndex, column);
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: searchValue}, function (grid) {
			var row = grid.target.getList("selected")[0];
			var set_clntNm = row.clntNm;
			var set_clntCd = row.clntCd;
			matrGridView.target.setValue(rowIndex, "pchsClntCd", set_clntCd);
			matrGridView.target.setValue(rowIndex, column, set_clntNm);
		});
	}

	//그리드 자재품번 검색
	function openMatListSearchGrid(column, rowIndex) {
		var __select__  =  getValue(matrGridView.target.list, rowIndex, "__selected__");
		if(__select__ == true){
			matrGridView.target.select(rowIndex);
		}
		var searchValue = getValue(matrGridView.target.list, rowIndex, column);
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"searchValue" : searchValue
		}
		openSecondModal("/static/html/cmn/modal/matListSearchMulti.html", 1200, 700, "자재 검색", paramObj, function (grid) {
			var selData = matrGridView.target.getList("selected")[0];
			var gridRow = grid;
			
			gridRow.dtaChk      = selData.dtaChk;
			gridRow.coCd        = selData.coCd;
			gridRow.ordrsNo     = selData.ordrsNo;
			gridRow.salesCd     = selData.salesCd;
			gridRow.oldUpperCd  = selData.oldUpperCd;
			gridRow.oldLowerCd  = selData.oldLowerCd;
			gridRow.dsgnNo      = selData.dsgnNo;
			gridRow.upperCd     = selData.upperCd;
			gridRow.lowerCd     = selData.lowerCd;
			gridRow.ordrgDiv20  = selData.ordrgDiv20;
			gridRow.ordrgDiv10  = selData.ordrgDiv10;
			gridRow.nextPrcsnNm = selData.nextPrcsnNm;
			gridRow.dlvplcNm    = selData.dlvplcNm;
			gridRow.bomQty      = selData.bomQty;
			gridRow.posQty      = selData.posQty;
			gridRow.pchsClntNm  = selData.pchsClntNm;
			gridRow.matrSeq     = selData.matrSeq;
			
			gridRow.__index = selData.__index;
			gridRow.__origin_index__ = selData.__origin_index__;
			gridRow.__modified__ = selData.__modified__;
			gridRow.__selected__ = selData.__selected__;
		
			gridRow.text = gridRow.matrNm;

			if(selData.dtaChk == "I"||selData.dtaChk == "D") {
				gridRow.dtaChk = selData.dtaChk;
			}else{
				gridRow.dtaChk = "U";
			}

			$.each($.extend({}, gridRow), function (key, value) {
				matrGridView.target.setValue(rowIndex, key, value);
			});
		});
	}
	
	$(document).ready(function() {
		setComboOptions($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		let loadData = {
			"ordrsNo"   : modalStack.last().paramObj.ordrsNo,
			"salesCd"   : modalStack.last().paramObj.salesCd,
			"clntNm"    : modalStack.last().paramObj.clntNm,
			"clntPjt"   : modalStack.last().paramObj.clntPjt,
			"clntPjtNm" : modalStack.last().paramObj.clntPjtNm,
			"itemDivNm" : modalStack.last().paramObj.itemDivNm,
			"eqpNm"     : modalStack.last().paramObj.eqpNm,
			"prdtNm"    : modalStack.last().paramObj.prdtNm,
		}
		loadFormData("#popForm", loadData);
		initLoadForm(".table_list_tit");

		$("#userId").val(jwt.userId);
		$("#mngNm_S").val(jwt.userNm);
		
		actionType = modalStack.last().paramObj.actionType;
		
		//grid 초기화
		matrGridView.initView();
		
		initMatrBomTree(); //왼쪽 트리 그리기
		
		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertBomMatr();
			});
		} else if (actionType == "U") {
			$('.tit').text('구매BOM 수정');
			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateBomMatr();
			});
		}

		$(".resizable-div").resizable();
		// 사이즈 조정 시 태그 자동 크기 조절
		$("#gridFrame").resize(function() {
			var workWidth = $("#main_area").width() - 10;

		    var tagHeight = $("#gridFrame").height() - 45 ;
		    var tagWidth  = $("#gridFrame").width();
		    tagWidth = tagWidth < 100 ? 100 : tagWidth;
		    tagWidth = tagWidth > workWidth ? workWidth : tagWidth;
		    	
		    $('[data-ax5grid="matr-grid"]').height(tagHeight);
		    $('[data-ax5grid-container="root"]').height(tagHeight);
		    $('#treeFrame').height(tagHeight + 45);
		    $('#MatrBomTree').height(tagHeight);
		    $('#treeFrame .contents').height(tagHeight+50);

			var chgWidth = workWidth - tagWidth -2;
		    chgWidth = (tagWidth + chgWidth) > workWidth ?  (workWidth - tagWidth) : chgWidth;
			$("#gridFrame").width(tagWidth);
		    $("#treeFrame").width(chgWidth);
		    $('#MatrBomTree').width(chgWidth);
		    $('#treeFrame .contents').width(chgWidth);
		});			
		// 사이즈 조정 시 태그 자동 크기 조절
		$("#treeFrame").resize(function() {
			var workWidth = $("#popForm").width() - 10;
			
		    var tagHeight = $("#treeFrame").height() ;
		    var tagWidth  = $("#treeFrame").width();
		    tagWidth = tagWidth < 100 ? 100 : tagWidth;
		    tagWidth = tagWidth > workWidth ? workWidth : tagWidth;
		    
		    $('#MatrBomTree').height(tagHeight -45);
		    $('#treeFrame .contents').height(tagHeight);
		    $('#gridFrame').height(tagHeight);
		    $('[data-ax5grid="matr-grid"]').height(tagHeight - 45);
		    $('[data-ax5grid-container="root"]').height(tagHeight- 45);
		    
		    $("#treeFrame").width(tagWidth);
		    $('#MatrBomTree').width(tagWidth);
		    $('#treeFrame .contents').width(tagWidth);
		    var chgWidth = workWidth - tagWidth -2;
		    chgWidth = (tagWidth + chgWidth) > workWidth ?  (workWidth - tagWidth) : chgWidth;
		    $("#gridFrame").width(chgWidth);
		});			
		
		var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		$("#fileTrgtKey").val(param_fileTrgtKey);
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: $("#popForm #pgmId").val(),
			fileTrgtKey	: param_fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		authChk();// 권한체크
	});
	
	function dataRefreshMatrBomTree() {
		$('#MatrBomTree').jstree(true).settings.core.data = selectMatrBomTree();
		$('#MatrBomTree').jstree(true).refresh();
	}
	
	
	function initMatrBomTree() {
		$("#MatrBomTree").jstree("destroy");
		$("#MatrBomTree").jstree(
		{
			plugins : ['types',  'search' ],
  			core : {
// 				"check_callback": checkOperation,
				dblclick_toggle: false,
				data : selectMatrBomTree()
			},
  			
//			1. plugins에 Contextmenu를 추가한다.
//			2. item에서 넘어오는 $node는 메뉴 클릭할 때 선택한 node를 가르킨다. 
//			3. return 항목에 메뉴들을 정의한다.
//			4. 메뉴에 action에 메뉴를 클릭하면 실행할 코드를 넣는다 
			contextmenu : {
  				"items" : function($node) {
  					console.log("Context menu items function called.");
  					console.log("$node:", $node);
//   					var tree = $("#MatrBomTree").jstree(true);
  					return {
	  					"create" : { 
	  		        		"separator_before" : false,
	  						"separator_after" : true,
	  						"icon": "glyphicon glyphicon-edit",
	  						"label" : "BOM 수정",
	  						"_disabled":  true,
// 	  						"action" : function(obj){createBom('U',$node)}
	  					},
	  					"remove" : {
	  						"separator_before" : false,
	  						"separator_after" : true,
	  						"icon": "glyphicon glyphicon-erase",
	  						"label" : "BOM 삭제",
	  						"_disabled":  false,
// 	  						"action" : function(obj){deleteBom($node)}
	  					}
  					}
  				}
  			} ,
			types : {
  				'unit'      : { 'icon' : 'glyphicon glyphicon-folder-close' },
				'unit-open' : { 'icon' : 'glyphicon glyphicon-folder-open' },
				'leaf'      : { 'icon' : 'glyphicon glyphicon-cog' }
  			}
  		}).on('loaded.jstree', function() {
			// 루트 노드 로드 완료 시
			// 최상위 노드 펼침
			$('#MatrBomTree').jstree(true).open_node($('#MatrBomTree li[aria-level=1]').eq(0).attr('id'));
			
			//첫번째 노드 검색해서 선택하기
			var firstNode = $('#MatrBomTree').jstree(true).get_node('#').children[0];
			$('#MatrBomTree').jstree(true).activate_node(firstNode);
		}).on("refresh.jstree", function() {
			// 리프레시 완료 시
			if (treeChkRefresh) {
				$('#MatrBomTree').jstree(true).deselect_all();
		 		$('#MatrBomTree').jstree(true).select_node(treeChkRefresh);
				$('#MatrBomTree').jstree(true).open_all(treeChkRefresh);
		 		treeChkRefresh = '';
				return false;
			} else {
				var selectedId = $('#MatrBomTree').jstree(true).get_selected()[0];
				$('#MatrBomTree').jstree(true).deselect_all();
				$('#MatrBomTree').jstree(true).select_node(selectedId);
			}
// 		}).on('mousedown', function(event) {
// 		    if (event.which === 3) { // Right mouse button
// 		        var node = $(event.target).closest('.jstree-node');
// 		        if (node.length > 0) {
// 		            $('#MatrBomTree').jstree('show_contextmenu', node);
// 		        }
// 		    }
		}).on("select_node.jstree", function(e, data) {
			// 노드 선택 시 발생 이벤트
			
			// BOM정보 set
			bomData = data.node.original;
			if (bomData.matGubun != "자재") {
				matrGridView.setData(data.node.original.lowerCd, data.node.original.upperCd);
			};
        }).on('open_node.jstree', function(e, data) {
			// 노드 열릴 때
			data.instance.set_type(data.node, 'unit-open');
  		}).on('close_node.jstree', function(e, data) {
			// 노드 닫힐 때
  			data.instance.set_type(data.node, 'unit');
  		}).on('create_node.jstree', function(e, data){
			// 노드 생성 시
  			$('#MatrBomTree').jstree(true).deselect_all();
  			$('#MatrBomTree').jstree(true).select_node(data.node.id);
  			// setBomInfo(data.node);
  		}).on('dblclick.jstree', function(e, data) {
  			// 노드 더블클릭 시
  			var node = $(this).jstree(true).get_node(this);
//   			createBom('U');

//***************************************************************
//마우스 드래그앤 드롭처리시 오류 발생 가능으로 기능제거 여기부터 시작 남장섭 240327
//***************************************************************
//   		}).on('copy_node.jstree', function(e, data) {
//   		    let targetNodeId = data.parent;		 //To 부모노드 ID
//   		    let targetNode = $("#MatrBomTree").jstree(true).get_node(targetNodeId);
//   			if (data.old_parent == data.parent || targetNode.parent == '#' || targetNode.id == '#'){ //동일한자리이거나 이동위치가 Top인경우
//   				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
//   				return false;
//   			}
//   		    if (targetNode.original.matGubun != undefined ) {
// 	  			if (targetNode.original.matGubun == '자재') {
// 	  				alert('자재코드는 하위 자재를 넣을수 없습니다.');
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
//   		    }
//   		    //선택된 노드정보를 가져와서 자재로 등록된 내용만 복사 대상으로 추출
// 	  		let seletedNodes = data.instance.get_selected(true)
// 	  		let chkNodes = $.grep(seletedNodes, function (o) {
// 	  			return data.instance.is_leaf(o) && o.original.matGubun == '자재';})
// 	  		if (seletedNodes.length > 1) {
// 	  			if (chkNodes.length == 0) {
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  			if (!confirm(chkNodes.length + '건을 [' + targetNode.text + ']로 복사 하시겠습니까?')) {
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  		} else {
// 	  			if (!confirm(data.node.text + '를  [' + targetNode.text + ']으로 복사 하시겠습니까?')) {
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  			chkNodes = [ data.node ];
// 	  		}

  		    
  		    
// 	  		let nodeInfoArr = [];
// 	  		$.each(chkNodes, function (i, o) {	//복하사고자하는 노드정보 배열임
// 	  			let nodeInfo = {};
// 	  			nodeInfo.coCd		= $('#coCd').val();
// 	  			nodeInfo.ordrsNoTo	= $('#ordrsNo').val();
// 	  			nodeInfo.ordrsNo 	= $('#ordrsNo').val();
// 	  			nodeInfo.salesCd	= $('#salesCd').val();
// 	  			nodeInfo.salesCdTo	= $('#salesCd').val();  //Target sales Code 230720 추가
// 	  			nodeInfo.parentIdTo	= targetNodeId;
// 	  			nodeInfo.upperCdTo	= targetNode.original.lowerCd;
// 	  			nodeInfo.upperKeyTo	= targetNodeId;
// 	  			nodeInfo.bomQtyTo	= targetNode.original.dsgnBomQty;
// 	  			nodeInfo.upperNm	= targetNode.original.dsgnNm;
// 	  			nodeInfo.dsgnNmTo	= targetNode.original.dsgnNm;
// 	  			nodeInfo.dsgnNoTo	= targetNode.original.dsgnNo;
// 	  			nodeInfo.partNoTo	= targetNode.original.partNo;
// 	  			nodeInfo.unitNoTo	= targetNode.original.unitNo;
// 	  			nodeInfo.revNoTo	= targetNode.original.revNo;
// 	  			nodeInfo.parent		= o.parent;
// 	  			nodeInfo.upperCd	= o.original.upperCd;
// 	  			nodeInfo.upperKey	= o.parent;
// 	  			nodeInfo.childId	= o.id;
// 	  			nodeInfo.lowerCd	= o.original.lowerCd;
// 	  			nodeInfo.matrSeq	= o.original.matrSeq;
// 	  			nodeInfo.lowerKey	= o.id;
// 	  			nodeInfo.matrCd		= o.original.matrCd;
// 	  			nodeInfo.changeYn	= "Y";    // 도면번호에 SalesCd 변경 여부임 변경없을경우 'N'
// 	  			nodeInfo.userId		= jwt.userId;
// 	  			nodeInfo.pgmId		= $('#pgmId').val();
// 	  			//백엔드 서비스단에서 재귀호출을 통합 하위 복사로 대체함
// 				nodeInfoArr.push(nodeInfo);

// 	  		})
	  		
// 	  			postAjaxSync("/user/sm/sm01/copyMatrBomTree", nodeInfoArr, null, function(data){
// 	 				if(data.resultCode == 200){
// 					} else {
// 						//오류처리 트리를 원복해야함
// 	  					alert(data.resultMessage);
// 					}
// 					treeChkRefresh = targetNodeId;
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  			});  
//   			$('#MatrBomTree').jstree(true).select_node(targetNodeId);
// 			$('#MatrBomTree').jstree(true).open_all(targetNodeId);
// 		}).on('move_node.jstree', function(e, data){
// 	  		// 노드 이동완료 시
//   		    //선택된 노드정보를 가져와서 자재로 등록된 내용만 복사 대상으로 추출
//   			let curParent = $('#MatrBomTree').jstree(true).get_node(data.parent);	//타겟 위치 노드 ID
//   			let oldParent = $('#MatrBomTree').jstree(true).get_node(data.old_parent); //예전 노드 ID
// 	  		if(curParent == oldParent || curParent.parent == '#' || curParent.id == '#') { //동일한자리이거나 이동위치가 Top인경우 
//   				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  			return false;
// 	  		}
// 	  			if (curParent.original && curParent.original.matGubun == '자재') {
// 	  				alert('자재코드는 하위 자재를 넣을수 없습니다.');
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  		let seletedNodes = data.instance.get_selected(true)
// 	  		let chkNodes = $.grep(seletedNodes, function (o) {
// 	  			return data.instance.is_leaf(o) && o.original.matGubun == '자재';})
// 	  		if (seletedNodes.length > 1) {
// 	  			if (chkNodes.length == 0) {
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  			if (!confirm(chkNodes.length + '건을 [' + curParent.text + ']로 이동 하시겠습니까?')) {
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  		} else {
// 	  			if (!confirm(data.node.text + '를  [' + curParent.text + ']으로 이동 하시겠습니까?')) {
// 	  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
// 	  				return false;
// 	  			}
// 	  			chkNodes = [ data.node];
// 	  		}

  			
// 	  		let nodeInfoArr = [];		//자식 노드 전체를 담기위한 영역
// 	  		$.each(chkNodes, function (i, o) {	//이동 하려는 노드정보 배열임
// 				let nodeInfo = {};		//노드정보 재구성용
  		  
// 				nodeInfo.coCd 		= o.original.coCd;
// 				nodeInfo.ordrsNo 	= o.original.ordrsNo;
// 				nodeInfo.salesCd	= o.original.salesCd;
// 				nodeInfo.matrSeq 	= o.original.matrSeq;
// 				nodeInfo.upperCd	= o.original.upperCd;
// 				nodeInfo.lowerCd	= o.original.lowerCd
				
// 				nodeInfo.upperCdTo	= curParent.original.lowerCd;
// 				nodeInfo.upperNmTo	= curParent.original.lowerNm;
// 				nodeInfo.bomQtyTo	= curParent.original.dsgnBomQty;
// 	  			nodeInfo.dsgnNoTo	= curParent.original.dsgnNo;
// 	  			nodeInfo.dsgnNmTo	= curParent.original.dsgnNm;
// 				nodeInfo.partNoTo	= curParent.original.partNo;
// 				nodeInfo.unitNoTo	= curParent.original.unitNo;
// 				nodeInfo.revNoTo	= curParent.original.revNo;
				
// 				nodeInfo.bomQty		= oldParent.original.dsgnBomQty;
// 				nodeInfo.partNo		= oldParent.original.partNo;
// 				nodeInfo.unitNo		= oldParent.original.unitNo;
// 				nodeInfo.revNo		= oldParent.original.revNo;
// 				nodeInfo.userId		= jwt.userId;
// 				nodeInfo.pgmId		= $('#pgmId').val();
			
// 				nodeInfoArr.push(nodeInfo);

//   			});
//   			postAjaxSync("/user/sm/sm01/moveMatrBom", nodeInfoArr, null, function(data){
//  				if(data.resultCode == 200){
//  				} else {
//    					alert(data.resultMessage);
//  				}
//   			});
//   			$('#MatrBomTree').jstree(true).select_node(curParent);
// 			$('#MatrBomTree').jstree(true).open_all(curParent);
// 			treeChkRefresh = curParent;
//  			dataRefreshMatrBomTree(); //왼쪽 트리 그리기

//***************************************************************
//마우스 드래그앤 드롭처리시 오류 발생 가능으로 기능제거  여기까지  끝 남장섭 240327
//*************************************************************** 				
		}).on('keydown', function(event) {
		    if (event.ctrlKey || event.metaKey) {
		        // Check for Ctrl+C (copy) shortcut
		        if (event.keyCode === 67) {
		        	copyNodes();
		        	window.pasteJobCode = "copy";
		            event.preventDefault(); 
		        }
		        // Check for Ctrl+C (copy) shortcut
		        if (event.keyCode === 88) {
		        	copyNodes();
		        	window.pasteJobCode = "move";
		            event.preventDefault(); 
		        }
		        // Check for Ctrl+V (paste) shortcut
		        else if (event.keyCode === 86) {
		        	pasteNodes();
		            event.preventDefault();
		        }
		    };
		});
  	}

	function copyNodes() {
	    let selectedNodes =  $('#MatrBomTree').jstree(true).get_selected();
	    let tempNode = $('#MatrBomTree').jstree(true).get_node(selectedNodes[0]);
		window.copiedNodes = [];
		selectedNodes.forEach(function(node) { //복하사고자하는 노드정보 배열임
		    let selNode = $('#MatrBomTree').jstree(true).get_node(node);
	    	if (selNode.parent != tempNode.parent || selNode.original.matGubun != '자재') {
	    		alert("자재가 아니거나 도면번호가 다르면 복사할수 없습니다. 동일 자료만 선택하세요!");
	    		window.copiedNodes = [];
	    		return false;
	    	}
	    	 window.copiedNodes.push(selNode)
	    });
	}

	function pasteNodes() {
        let targetNodeId = $('#MatrBomTree').jstree(true).get_selected()[0];
		$('#MatrBomTree').jstree(true).open_all(targetNodeId);
	    if (window.copiedNodes || targetNodeId) {
  		    let targetNode = $('#MatrBomTree').jstree(true).get_node(targetNodeId);;		 //To 부모노드 ID
	  		let nodeInfoArr = [];
        	let copiedNodes = window.copiedNodes;
        	for (var i = 0; i < copiedNodes.length; i++) {
	        	let node = copiedNodes[i];

	  			if (node.parent == targetNode.parent || targetNode.parent == '#' || targetNode.id == '#'){ //동일한자리이거나 이동위치가 Top인경우
	//   				alert("같은자리에는 복사할 수 없습니다.");
	  				return false;
	  			}
	  		    if (targetNode.original.matGubun != undefined ) {
		  			if (targetNode.original.matGubun == '자재') {
		  				alert('자재코드는 하위 자재를 넣을수 없습니다.');
		  				return false;
		  			}
	  		    }
	  		  	if (isNodeMatrExists(targetNode, node.original.matrCd)) {
	  				alert(node.text + ' 동일한 자재가 등록되어 있습니다.');
	  				return false;
	  		  	}
	  			let nodeInfo = {};
	  			nodeInfo.coCd		= $('#coCd').val();
	  			nodeInfo.ordrsNoTo	= $('#ordrsNo').val();
	  			nodeInfo.ordrsNo 	= $('#ordrsNo').val();
	  			nodeInfo.salesCd	= $('#salesCd').val();
	  			nodeInfo.salesCdTo	= $('#salesCd').val();  //Target sales Code 230720 추가
	  			
	  			nodeInfo.parentIdTo	= targetNodeId;
	  			nodeInfo.upperCdTo	= targetNode.original.lowerCd;
	  			nodeInfo.upperKeyTo	= targetNodeId;
	  			nodeInfo.bomQtyTo	= targetNode.original.dsgnBomQty;
	  			nodeInfo.upperNm	= targetNode.original.dsgnNm;
	  			nodeInfo.upperNmTo	= targetNode.original.dsgnNm;
	  			nodeInfo.dsgnNmTo	= targetNode.original.dsgnNm;
	  			nodeInfo.dsgnNoTo	= targetNode.original.dsgnNo;
	  			nodeInfo.partNoTo	= targetNode.original.partNo;
	  			nodeInfo.unitNoTo	= targetNode.original.unitNo;
	  			nodeInfo.revNoTo	= targetNode.original.revNo;
	  			
	  			nodeInfo.parent		= node.parent;
	  			nodeInfo.upperCd	= node.original.upperCd;
	  			nodeInfo.upperKey	= node.parent;
	  			nodeInfo.childId	= node.id;
	  			nodeInfo.lowerCd	= node.original.lowerCd;
	  			nodeInfo.matrSeq	= node.original.matrSeq;
	  			nodeInfo.lowerKey	= node.id;
	  			nodeInfo.matrCd		= node.original.matrCd;
	  			nodeInfo.changeYn	= "Y";    // 도면번호에 SalesCd 변경 여부임 변경없을경우 'N'
	  			nodeInfo.userId		= jwt.userId;
	  			nodeInfo.pgmId		= $('#pgmId').val();
	  			//백엔드 서비스단에서 재귀호출을 통합 하위 복사로 대체함
				nodeInfoArr.push(nodeInfo);
	
		  	};
		  	let callPgmId = "";
        	if (window.pasteJobCode == "copy") {
        		callPgmId = "/user/sm/sm01/copyMatrBomTree";
        	} else if (window.pasteJobCode == "move") {
        		callPgmId = "/user/sm/sm01/moveMatrBom"
        	} else {
        		return false;
        	}
  			postAjaxSync(callPgmId, nodeInfoArr, null, function(data){
 				if(data.resultCode == 200){
				} else {
					//오류처리 트리를 원복해야함
  					alert(data.resultMessage);
				}
				treeChkRefresh = targetNodeId;
  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
  			});  
	    }
	}
	// Tree dnd check
	//callback 사용 안함.--> 백엔드에서 처리하고 결과를 트리에 그리므로 사용안함
	function checkOperation(operation, node, parent, position, more) {
// 		console.log(operation, node, parent, position, "more:", more, "more.core:", more.core);
// 		if (position == 1) return false;
// 		if (more && more.core) { // 노드가 드랍되었을 때
// 			if(operation == "move_node"){
// 				console.log('position : '+ position, 'node.id :'+node.id );
// 				if (!$("#actionBtn").length) return false; //수정버튼이 없는 사용자는 작업권한이 없어 수정 못함
// // 				if (position == 1) return false;
// 				if(node.id == "new"){
// 					alert("신규로 추가한 BOM을 저장해 주세요.");
// 					return false;
// 				}else{
// 					// 자식노드중에 같은게 있는지 확인
// 					const result = isNodeNameExists(parent, node.text);
// 		    		if (result) {
// 		    			$("#MatrBomTree").jstree().search(node.text,true,false,parent.id);
// 		    			alert("동일한 아이템이 존재합니다.");
// 		    			$('#MatrBomTree').jstree(true).refresh();
// 		  				return false;
// 			   		} 	
		    		
// 					var confirmMessage = "BOM을 이동하시겠습니까?";
// 					if(!confirm(confirmMessage)){
// 						return false;
// 					}
// 					return true;
// 				}
// 			} else if(operation == "create_node"){
//     			$('#MatrBomTree').jstree(true).refresh();	//기능 없음
//     			return false;
// 			} else if(operation == "copy_node"){
// 				if (!$("#actionBtn").length) return false; //수정버튼이 없는 사용자는 작업권한이 없어 수정 못함
				// 노드가 드랍되었을 때
				// 자식노드중에 같은게 있는지 확인
// 				const result = isNodeNameExists(parent, node.text);
// 	    		if (result) {
// 	    			$("#MatrBomTree").jstree().search(node.text,true,false,parent.id);
// 	    			alert("동일한 아이템이 존재합니다.");
// 	    			$('#MatrBomTree').jstree(true).refresh();
// 	  				return false;
// 		   		} 			
// 				return true;
// 			}
// 		} //if (more && more.core)
	}  	// function	}

	// 특정 노드 아래에 있는 자식 노드들 중에서 특정 노드명이 있는지 체크
    function isNodeNameExists(node, nodeName) {
		if (!node || !node.children.length) { // 해당 노드가 없거나 자식 노드가 없는 경우
			return false;
		}
		
		let result = false;
		node.children.forEach(childNodeId => {
		    const childNode = $("#MatrBomTree").jstree(true).get_node(childNodeId);
		    if (childNode.text === nodeName) {
		      result = true;
		      return false; // break the loop
		    } 
		});
		
		return result;
	}    

	// 특정 노드 아래에 있는 자식 노드들 중에서 동일한 자재코드 체크
    function isNodeMatrExists(node, _matrCode) {
		if (!node || !node.children.length) { // 해당 노드가 없거나 자식 노드가 없는 경우
			return false;
		}
		
		let result = false;
		node.children.forEach(childNodeId => {
		    const childNode = $("#MatrBomTree").jstree(true).get_node(childNodeId);
		    if (childNode.original.matrCd === _matrCode) {
		      result = true;
		      return false; // break the loop
		    } 
		});
		
		return result;
	}    
    
	function  deleteBom() {
		if (!$("#actionBtn").length) return false; //삭제버튼이 없는 사용자는 작업권한이 없어 삭제 못함
		var node = $('#MatrBomTree').jstree(true).get_selected()[0];
		var currNode = $("#MatrBomTree").jstree(true).get_node(node);
		if (confirm(currNode.text + "삭제하시겠습니까?")) {
			var paramObj = {
				"coCd"        : $('#coCd').val(),
				"ordrsNo"     : $('#ordrsNo').val(),
				"salesCd"     : $('#salesCd').val(),
				"matrSeq"    : currNode.original.matrSeq,
				"upperKey"    : currNode.original.parent,
				"lowerKey"    : currNode.original.id
			}
			postAjax("/user/sm/sm14/deleteBom", paramObj, null, function(data) {
				if (data.resultCode == 200) {
					// alert(data.resultMessage);
// 					$('#MatrBomTree').jstree(true).settings.core.data = selectMatrBomTree();
				} else {
  					alert(data.resultMessage);
  				}
// 				$('#MatrBomTree').jstree(true).refresh();
  				dataRefreshMatrBomTree(); //왼쪽 트리 그리기
  			});
		}
  	}
	
	// BOM 트리 데이터 select
	function selectMatrBomTree() {
		var MatrBomTree = null;
		var paramObj = {
			"coCd" : $("#coCd").val(),
			"ordrsNo" : $("#ordrsNo").val(),
			"salesCd" : $("#salesCd").val()
		};
		postAjaxSync("/user/sm/sm01/selectBomSalesTreeList", paramObj, null, function(data){
			MatrBomTree = data.result;
		});
		return MatrBomTree;
	}

	// 등록
	function insertBomMatr() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			setFormLock(".popup_area");
			filePostAjax("/user/sm/sm01/insertBom", formData, function(data) {
				if (data.resultCode == 200) {
					//grid 초기화
					matrGridView.initView();
					dataRefreshMatrBomTree(); //왼쪽 트리 그리기
					// modalStack.close();
				} else {
					alert(data.resultMessage);
				}
			});
		}
	}

	// 수정
	function updateBomMatr() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 formData를 생성
			// setFormLock(".popup_area");
	      	filePostAjax("/user/sm/sm01/updateBom", formData,function(data) {
				if (data.resultCode == 200) {
					//grid 초기화
					matrGridView.initView();
					dataRefreshMatrBomTree(); //왼쪽 트리 그리기
					// modalStack.close();
				} else {
					alert(data.resultMessage);
				}
			});
		}
	}

	//----------------------------------------------//
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = getFormData("#popForm");
		//--var formData = new FormData($("#popForm")[0]);

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		//현재 자재정보 그리드정보를 matrArr에  update 한다
		var matrGridList = matrGridView.target.list;
		var matrArrList = [];
		
		if(matrGridList.length > 0){
			$.each(matrGridList, function (idx, elem) {
				matrArrList.push(elem);
			});
		}

 		$.each(matrArrList,function(idx, obj) {
 			if(isEmpty(obj.dtaChk)){
 				obj.dtaChk = "";
 			}
 		});
 		
		formData.append("matrArr", JSON.stringify(matrArrList));
		//세부 아이템 자료 끝
		return formData;
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	
	//자재품번 검색 (왼쪽 BOM그리드의 선택된 ROW를 기준으로 자재 검색 실행하기)
	//Default작업 type은 "BOM"으로 왼쪽 BOM 그리드의 선택 ROW를 기준으로 검색처리함.
	//    작업 Type이 "MATR"은 오른쪽 자재 그리드의 최상단을 기준으로 검색함. -->(진입시점은 화면에서 엔터키를 누를때 진입함)
	function openMatListSearchMulti(_type = 'BOM') {
		var bomData = matrGridView.target.list[0];
		var matrLength = matrGridView.target.list.length;
		let tempSearchValue ="";
		if (bomData) {
			if (bomData.matrMno) { tempSearchValue = bomData.matrMno == "-" ? "" : bomData.matrMno; }  //형번 "BYGS10100-45H"
			else if (bomData.matrMat) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (bomData.matrMat == "-") ? "" : bomData.matrMat;}  //소재 "SMC/부경금속"
			else if (bomData.matrSpec) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (bomData.matrSpec == "-") ? "" : bomData.matrSpec;}  //규격
			else if (bomData.matrNm) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (bomData.matrNm == "-") ? "" : bomData.matrNm;}  //자재명 "손잡이"
		}
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"searchValue" : tempSearchValue.replace(/ /g, '')
		}
		openSecondModal("/static/html/cmn/modal/matListSearchMulti.html", 1200, 700, "자재 검색", paramObj, function (dataList) {
			let matrLength = matrGridView.target.list.length;
	        $.each($.extend({}, dataList), function (idx, elem) {
	        	var row_index = Number(idx);
				var newRow = elem;

				var vmatr_bomQty = null;
				if($('#matr_bomQty').val() == '') {
					vmatr_bomQty = bomData.bomQty;
				} else {
					vmatr_bomQty = $('#matr_bomQty').val();
				}

				var vmatr_posQty = null;
				if($('#matr_posQty').val() == '') {
					vmatr_posQty = bomData.bomQty;
				} else {
					vmatr_posQty = $('#matr_posQty').val();
				}

				newRow.dtaChk = "I";
				newRow.matrYn = "자재";
				newRow.coCd = bomData.coCd;
				newRow.ordrsNo = bomData.ordrsNo;
				newRow.salesCd = bomData.salesCd;
				newRow.dsgnNo = bomData.dsgnNo;
				newRow.partNo = bomData.partNo;
				newRow.unitNo = bomData.unitNo;
				newRow.revNo  = bomData.revNo;
				newRow.dsgnNm = bomData.dsgnNm;
				newRow.text = newRow.matrNm;
				
				// newRow.upperCd = bomData.upperCd;
				// newRow.lowerCd = bomData.lowerCd;
				newRow.upperCd = bomData.lowerCd;
				newRow.lowerCd = '.';
				newRow.ordrgDiv10 = $('#matr_ordrgDiv10').val();
				newRow.ordrgDiv20 = $('#matr_ordrgDiv20').val();
				
				//1. 자재마스터에 등록된 관리담당자명을 발주담당자명에 저장 
				if (newRow.matrMngIdNm != undefined || newRow.matrMngIdNm != "") {
					newRow.mngNm = newRow.matrMngIdNm;
				}
				//제조사가 SMC인경우 발주담당자는 성진주과장이면 구매업체는 대영유공압
				if (newRow.matrMat) {
					if (newRow.matrMat.indexOf('SMC') !== -1) {
						newRow.mngNm = "성진주";
						newRow.pchsClntNm = "대영유공압";
					}
				}
				//발주담당자, 구매업체, 배송업체가 비어 있으면 대표입력내용으로 교체
				if (newRow.pchsClntNm==undefined || newRow.pchsClntNm=="") newRow.pchsClntNm = $('#pchsClntNm_S').val();
				if (newRow.mngNm==undefined || newRow.mngNm=="") newRow.mngNm = $('#mngNm_S').val();
				if (newRow.dlvplcNm==undefined || newRow.dlvplcNm=="") newRow.dlvplcNm = $('#matr_dlvplcNm').val();
				if (newRow.pchsClntNm==undefined || newRow.pchsClntNm=="") newRow.pchsClntNm = newRow.pchsClntNm1;
				// newRow.bomQty = $('#matr_bomQty').val();
				// newRow.posQty = $('#matr_posQty').val();
				newRow.bomQty = vmatr_bomQty;
				newRow.posQty = vmatr_posQty;
				newRow.matrSeq = matrLength+(row_index+1);
				matrGridView.target.addRow($.extend({}, newRow), "last", {focus: "END"});
	        });
		});
	}

	//자재삭제
	this.delRowMatr = function() {

		if(selectGridValidationM(matrGridView.target)) return;
		
		var selDataList = matrGridView.target.getList("selected");
		
		//ax5Grid.deleteRow("selected"); 사용시 삭제이력 ax5Grid.getList("deleted");
		for(var i=selDataList.length-1; i >= 0; i--) {
			var selData = selDataList[i];
			var matrDtaChk = selData.dtaChk;
			if(selData.matrCd == undefined || selData.matrCd == ''){
				//설계BOM에서 넘어온경우에는 삭제 안됨
				// matrGridView.target.setValue(selData.__origin_index__, "dtaChk", "");
			} else {
				if(matrDtaChk == "I") {
					matrGridView.target.removeRow(selData.__index);
				} else {
					if(matrDtaChk == "D") {
						matrGridView.target.setValue(selData.__origin_index__, "dtaChk", "");
					}else{
						matrGridView.target.setValue(selData.__origin_index__, "dtaChk", "D");
					}
				}
				//자재인경우만 처리
			}
		}
	}

	//Bom-자재 수정
	function updateBomMtrlSecondModal() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		if(selData.matrCd == undefined || selData.matrCd === '') return;
		if(selData.dtaChk == "D" || selData.dtaChk == "I") return;
		
		var paramObj = selData;
        var fileTrgtKey = selData.fileTrgtKey;
        paramObj.actionType = "U";
        paramObj.sendLowData = JSON.stringify(selData);
        openSecondModal("/static/html/user/sm/sm01/SM0101P02.html", 1300, 550, "", paramObj, function(data) {
        	//matrGridView.target.updateRow($.extend({}, matrGridView.target.list[selData.__index], data), selData.__index);
        	$.each($.extend({}, data), function (key, value) {
        		matrGridView.target.setValue(selData.__origin_index__, key, value);
        	});
        	//if(isEmpty(selData.dtaChk)) {
	        //	matrGridView.target.setValue(selData.__index, "dtaChk", "U");
        	//}
		});
	}

	function treeExpandClose(selector) {
		selector = selector ? selector : "MatrBomTree" ;
		var node = $('#' + selector).jstree(true).get_selected()[0];
		node = node ? node : "#" ;
		// 특정 노드의 펼침/접힘 상태 확인
		var isOpen = $('#' + selector).jstree("is_open", node);
		if (isOpen) {
			//console.log("노드가 펼쳐져 있습니다.");
			$('#' + selector).jstree("close_all", node)
		} else {
			//console.log("노드가 접혀 있습니다.");
			$('#' + selector).jstree("open_all", node)
		}
		
		var iconElement = $("#treeExpandBtn i");
		var currentClass = iconElement.attr("class");
		
		if (currentClass == "fas fa-chevron-down") {
			iconElement.removeClass("fas fa-chevron-down");
			iconElement.addClass("fas fa-chevron-up");
		} else if (currentClass == "fas fa-chevron-up") {
			iconElement.removeClass("fas fa-chevron-up");
			iconElement.addClass("fas fa-chevron-down");
		}
	}

	function setClearValue(_idx){
		var _key = ["dtaChk", "pchsClntNm", "dlvplcNm", "bomQty", "posQty", "goodsDiv", "goodsDiv", "matrClntDiv", "matrDiv", "matrGrp","matrUnit","matrTestDiv"];
		for(var _z=0;_z<_key.length;_z++){
			matrGridView.target.setValue(_idx, _key[_z], "");
		}
	}

	function syncBom() {
		//버튼이 없는 사용자는 작업권한이 없어 처리 못함
		// if (!$("#bomsyncBtn").length) return false;
		var node = $('#MatrBomTree').jstree(true).get_selected()[0];
		var currNode = $("#MatrBomTree").jstree(true).get_node(node);
		if (confirm(currNode.text + "설계BOM기준 적용처리 하시겠습니까?")) {
			var target = this.target;
			var formData = {
				"coCd"        : $('#coCd').val(),
				"salesCd"     : $('#salesCd').val(),
				"upperKey"    : currNode.original.parent,
				"lowerKey"    : currNode.original.id
			}
			postAjax("/user/sm/sm01/syncBom", formData, null, function(data) {
				alert("적용되었습니다.");
				initMatrBomTree(); //왼쪽 트리 그리기
  			});
		}
  	}

    function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}
	
</script>