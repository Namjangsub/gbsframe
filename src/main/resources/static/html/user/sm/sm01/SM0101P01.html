<style>
* input[comma] {
  text-align: right;
 }
.grid-cell-gray {
	background: #d3d3d3;
}
	
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">구매BOM 등록</h4>
    </div>

  <div class="form-group popup_table">
  <form id="popForm" onSubmit="return false;">
      <input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
      <input type="hidden" id="pgmId"     name="pgmId" value="SM0101M01">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
			<th class="hit">회사</th>
			<td>
			  <select id="coCd" name="coCd" data-kind="CO" class="form-control" required="required" msg="회사" readonly="readonly">
			  </select>
			</td>
			<th>Sales Code</th>
			<td>
				<input type="text" id="salesCd" name="salesCd" class="form-control" required="required" msg="Sales Code" readonly="readonly">
			</td>
			<th>고객사</th>
			<td>
				<input type="text" id="clntNm" name="clntNm" class="form-control" msg="고객사" readonly="readonly">
			</td>
			<th>고객사PJT</th>
			<td>
				<input type="text" id="clntPjt" name="clntPjt" class="form-control" msg="고객사PJT" readonly="readonly"> 
			</td>
        </tr>

        <tr>
			<th>제품구분</th>
			<td>
				<input type="text" id="prdtNm" name="prdtNm" class="form-control" msg="제품명" readonly="readonly">
			</td>
			<th>아이템구분</th>
			<td>
				<input type="text" id="itemDivNm" name="itemDivNm" class="form-control" msg="아이템구분" readonly="readonly">
			</td>
			<th>설비명</th>
			<td colspan="3">
				<input type="text" id="eqpNm" name="eqpNm" msg="설비명" class="form-control" readonly="readonly">
			</td>
        </tr>

      </table>

    </form>

		<!-- 콘텐츠 -->
	  <div class="contents" style="margin-top: 10px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="width: 100%">
	            <li style="width: 35%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a onclick="addRowBom()" style="" authchk>+</a>
		                    <a onclick="delRowBom()" style="" authchk>-</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="bom-grid" data-ax5grid-config="{}" style="height:350px; width: 100%" ></div>
	                </div>
	            </li>
	            <li style="width: 63%; margin-left: 8px;">
	                <div class="table_list_tit">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">BOM 자재정보</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a onclick="openMatListSearch()" style="width: 50px;" authchk><i class="fas fa-folder-plus"></i> 등록</a>
		                    <a onclick="modRowMatr()" style="width: 50px;" authchk><i class="fas fa-money-check"></i> 수정 </a>
		                    <a onclick="delRowMatr()" style="width: 50px;" authchk><i class="fas fa-trash"></i> 삭제 </a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="matr-grid" data-ax5grid-config="{}" style="height:350px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>


	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>
	
<script type="text/javascript">
  
var actionType = null;

var firstGrid = null;
var secondGrid = null;

var matrArr = [];  //자재 데이타

var before_bomIdx = -1;
var before_dsgnNo = null;
var select_bomIdx = -1;
var select_dsgnNo = null;

var bomGridView_notchange = false;

var bomGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="bom-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: false
		         },
		         body: {
		        	 	 mergeCells : ["partNo", "unitNo", "revNo"],//editor 는 merge 안됨
			        	 onClick: function () {
			        		this.self.clearSelect();
			             	this.self.select(this.dindex);
			             	select_bomIdx = this.dindex;
			             	select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
			             	
			             	//원본데이타에서 화면데이터 제거 --> 화면데이타 put 원본데이타에.
			             	matrGridView.selectGrid(select_dsgnNo);
			             	before_bomIdx = this.dindex;
			             	before_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
			             	
			        	 },
			        	 /*
						 onDBLClick: function () {
						 	//updatePrdtList('U');
						 },
						 */
			             onDataChanged: function () {
			            	//if(bomGridView_notchange) return;
			            	
			            	if (this.item.__selected__ == true) {
			                	//before_bomIdx = this.dindex;
			                }
			            	
			            	if(this.key == "partNo" || this.key == "unitNo" || this.key == "revNo"){//입력항목일때
				            	if(this.item.dtaChk != "I") {
				            		this.item.dtaChk = "U";
				            	}
			            	}

			            	//입력후 partNo, unitNo, revNo 입력 문자크기 잘못 입력시 지움
			            	if(this.item.lvl >= 1 && this.key == "partNo" && this.value != "" && (this.item.partNo).length < 4){
			            		this.item.partNo = "";
			            		this.item.upperCd = "";
			            		this.item.lowerCd = "";
			            		this.item.dsgnNo = "";
			            		this.item.unitNo = "";
			            		this.item.revNo = "";
			            	}
			            	else if(this.item.lvl >= 2 && this.key == "unitNo" && this.value != "" && (this.item.unitNo).length < 3){
			            		this.item.unitNo = "";
			            		this.item.upperCd = "";
			            		this.item.lowerCd = "";
			            		this.item.dsgnNo = "";
			            		this.item.revNo = "";
			            	}
			            	else if(this.item.lvl >= 3 && this.key == "revNo" && this.value != "" && (this.item.revNo).length < 2){
			            		this.item.revNo = "";
			            		this.item.upperCd = "";
			            		this.item.lowerCd = "";
			            		this.item.dsgnNo = "";
			            	}
			            	
			            	//입력후 partNo, unitNo, revNo 로  dsgnNo,lowerCd 생성
			            	if(this.item.lvl == 1 && this.key == "partNo" && this.item.partNo != ""){
			            		this.item.upperCd = this.item.salesCd;
			            		this.item.lowerCd = this.item.salesCd + adPer(this.item.partNo);
			            	}
			            	else if(this.item.lvl == 2 && this.key == "unitNo" && this.item.partNo != "" && this.item.unitNo != ""){
			            		this.item.upperCd = this.item.salesCd + adPer(this.item.partNo);
			            		this.item.lowerCd = this.item.salesCd + adPer(this.item.partNo) + adPer(this.item.unitNo);
			            	}
			            	else if(this.item.lvl == 3 && this.key == "revNo" && this.item.partNo != "" && this.item.unitNo != "" && this.item.revNo != ""){
			            		this.item.upperCd = this.item.salesCd + adPer(this.item.partNo) + adPer(this.item.unitNo);
			            		this.item.lowerCd = this.item.salesCd + adPer(this.item.partNo) + adPer(this.item.unitNo) + adPer(this.item.revNo);
			            	}
			            	this.item.dsgnNo = this.item.lowerCd;
			            	
			            	//Mast 삭제시 자재삭제 실데이타는 deleteBomMatrAll -> deleteBom 으로 삭제시 모든 자재삭제
			            	if(this.key == "dtaChk" && this.value != ""){
				            	if(this.item.dtaChk == "D") {
				            		var delIdxArray = findIndexArray(matrArr, "dsgnNo", this.item.dsgnNo);
				        			for(var i=delIdxArray.length-1; i >= 0; i--){
				        				matrArr.splice(delIdxArray[i],1);
				        			}
				        			var list = getFilterData(this.item.dsgnNo);
				        			matrGridView.target.setData({
				                		list : list,
				                		page : {
				                			totalElements : list.length
				                		}
				           			});
				            	}
			            	}
			            	
			            	//PART, UNIT 변경시 하위정보 변경 >>> 하위 찾기 메소드 필요..
			            	if(this.key == "partNo"||this.key == "unitNo"){
			            		/*
			            		var new_partNo = this.item.partNo;
			            		var new_unitNo = this.item.unitNo;
			            		var new_revNo = this.item.revNo;
			            		var new_lowerCd = this.item.lowerCd;//변경된 값
			            		var old_lowerCd = this.item.oldLowerCd;

			            		var bomGridView_oldPartNo = this.item.oldPartNo;
			            		console.log("======oldPartNo====>"+bomGridView_oldPartNo);
			            		//var bomGridView_oldUnitNo = this.item.oldUnitNo;
			            		//var bomGridView_oldRevNo  = this.item.oldRevNo;
			            		//var bomGridView_lowerCd = this.item.lowerCd;//변경된 값
			            		//var bomGridView_upperCd = this.item.upperCd;//변경된 값
			            		var bomGridList = bomGridView.target.getList();
			            		//bomGridView_notchange = true;
		        				$.each(bomGridList, function (idx, elem) {
		        					if(elem.oldLowerCd.indexOf(old_lowerCd) == 0) {
		        						//var new_lowerCd = elem.salesCd + adPer(new_partNo) + adPer(new_unitNo) + adPer(new_revNo);
		        						var set_lowerCd = elem.lowerCd.replace(old_lowerCd,new_lowerCd);
		        						console.log("===========partNo>> onChange ########"+idx+"   >>>"+elem.lowerCd+ ">>> "+set_lowerCd);
		        						
		        						bomGridView.target.setValue(idx, "partNo", new_partNo);
		        						bomGridView.target.setValue(idx, "lowerCd",set_lowerCd);
		        						bomGridView.target.setValue(idx, "dsgnNo", set_lowerCd);
		        					}
		        				});
		        				//bomGridView_notchange = false;
		        				*/
			            	}
			            	
			            	//BOM 입력(partNo,unitNo,revNo)시 자재정보의 dsgnNo,lowerCd,upperCd Change
			            	if(this.key == "partNo"||this.key == "unitNo"||this.key == "revNo"){
			            		//console.log("===========partNo>> onChange 2222222");
			            		var matrGridList = matrGridView.target.getList();
			            		if(matrGridList.length > 0) {
			            			var matrGridView_dsgnNo = "";
			            			var matrGridView_upperCd = "";
			            			var matrGridView_lowerCd = "";
			            			if((this.key == "partNo" && this.item.partNo != "")
					            			||(this.key == "unitNo" && this.item.unitNo != "")
					            			||(this.key == "revNo" && this.item.revNo != "")){//입력항목 && 입력값이 있을때
			            				matrGridView_dsgnNo = this.item.dsgnNo;
			            				matrGridView_lowerCd = this.item.lowerCd;
			            				matrGridView_upperCd = this.item.upperCd;
			            			}
			            			
			            			//현재편집중인 자재정보 반영
			        				$.each(matrGridList, function (idx, elem) {
			        					elem.dsgnNo = matrGridView_dsgnNo;
			        					elem.lowerCd = matrGridView_lowerCd;
			        					elem.upperCd = matrGridView_upperCd;
			        					elem.dtaChk = "U";
			        				});
				        			matrGridView.target.setData({
				                		list : matrGridList,
				                		page : {
				                			totalElements : matrGridList.length
				                		}
				           			});
			            		}
				            }//end if//자재정보
				            
			            	bomGridView.target.repaint();
			             }//,
	             },
		        columns : [
		        	//,hidden:true
		        	{key: "dtaChk",label: " ", width: 30, 	styleClass: "grid-font-blue-bold"},
		        	{key: "coCd", label: "CO", width: 50,hidden:true},
		        	{key: "salesCd", label: "Sales Code", width: 120,hidden:true},
		        	{key: "lvl", label: "LVL", width: 50},
	                {key: "partNo", label: "PART", width: 80, 
		        		editor:{type:  "number",
			        			disabled: function () {
			        				if(this.item.lvl >= 1){
				        		        return false;
			        				} else {
			        					return true;
			        				}
			        		    },
			        		    attributes: {
			        		        'maxlength': 4, 'data-maxlength': 4
			        		    }
        				},
        				styleClass: function () {
        					if(this.item.lvl < 1){
        						return "grid-cell-gray"
        					}
        				}
	                },
	                {key: "unitNo", label: "UNIT", width: 80,
		        		editor:{type: "number",
			        			disabled: function () {
			        				if(this.item.lvl >= 2){
				        		        return false;
			        				} else {
			        					return true;
			        				}
			        		    },
			        		    attributes: {
			        		        'maxlength': 3, 'data-maxlength': 3
			        		    }
	        			},
        				styleClass: function () {
        					if(this.item.lvl < 2){
        						return "grid-cell-gray"
        					}
        				}
	                },
	                {key: "revNo", label: "REV", width: 80,
		        		editor: {type: "text",
		        			disabled: function () {
		        				if(this.item.lvl >= 3){
			        		        return false;
		        				} else {
		        					return true;
		        				}
		        		    },
		        		    attributes: {
		        		        'maxlength': 2
		        		    }
            			},
        				styleClass: function () {
        					if(this.item.lvl < 3){
        						return "grid-cell-gray"
        					}
        				}
	                },
		        	{key: "dsgnNo" , label: "도번" 	,width: 200,align: "left"},
					{key: "upperCd", label: "상위코드" ,width: 160,align: "left",hidden:true},
					{key: "lowerCd", label: "하위코드" ,width: 180,align: "left",hidden:true}
			     ]
		    });
			return this;
		},


        setData: function(_pageNo){
			var target = this.target;
			var formData = {
				"salesCd" 		: $("#salesCd").val(),
			}

    		postAjax("/user/sm/sm01/selectBuyBomList", formData, null, function(data) {
				var list = data.resultList;
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});
				if(list.length > 0){
					bomGridView.target.clearSelect();
					//bomGridView.target.focus("HOME")
					bomGridView.target.select(0);
					bomGridView.target.focused = true;
					select_bomIdx = 0;
					before_bomIdx = 0;
					select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
					before_dsgnNo = select_dsgnNo;
					
					//자재정보 조회
					matrGridView.setData('A');
				}
    	 	});
     	} //setData
     }


var matrGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: false,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="matr-grid"]'),
		         header: {
			        		 align: "center",
			        		 selector: false
			    },
		        body: {
		        		   mergeCells : ["coCd","salesCd", "dsgnNo", "upperCd","lowerCd","ordrgDiv10"],
  			               onClick: function () {
  			               this.self.select(this.dindex);
			          },
			          onDBLClick: function () {
			        	  modRowMatr();
			          },
			          onDataChanged: function () {
			            	//아이템 상세내역이 수정이 있으면 저장 필요
			            	
			            	if(this.key != "dtaChk"){//입력항목일때
				            	if(this.item.dtaChk != "I") {
				            		this.item.dtaChk = "U";
				            	}
			            	}
			            	matrGridView.target.repaint();
			          },
		        },
		        columns : [
		        		 {key: "dtaChk",label: " ", width: 30, 	styleClass: "grid-font-blue-bold"}
			 	 	 	,{key: "coCd", 				label: "CO", 			width: 50,	align: "center",hidden:true}
						,{key: "salesCd", 			label: "Sales Code", 	width: 120,	align: "left",hidden:true}
						,{key: "dsgnNo", 			label: "도번", 			width: 180,	align: "left",hidden:true}
						,{key: "matrSeq", 			label: "자재순번", 		width: 70,	align: "center"}
						,{key: "oldUpperCd", 		label: "이전상위코드", 		width: 160,	align: "left",hidden:true}
						,{key: "oldLowerCd", 		label: "이전하위코드", 		width: 180,	align: "left",hidden:true}
						,{key: "upperCd", 			label: "현재상위코드", 		width: 160,	align: "left",hidden:true}
						,{key: "lowerCd", 			label: "현재하위코드", 		width: 180,	align: "left",hidden:true}
						,{key: "ordrgDiv10", 		label: "발주용도", 		width: 100,	align: "left"
							, editor: {type: "select",
								config: {
									columnKeys: {optionValue: 'value',optionText: 'text'},
									options: options_01
								},
								disabled: function () {
									return false;
								}
							}
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.ordrgDiv10;
								$.each(options_01, function (idx, elem) {
									if(itemValue == elem.value)
									{
										result_text = elem.text;
									}
								});
								return result_text;
							}
						 }
						,{key: "ordrgDiv20", 		label: "발주유형", 		width: 100,	align: "left"
							, editor: {type: "select",
								config: {
									columnKeys: {optionValue: 'value',optionText: 'text'},
									options: options_02
								},
								disabled: function () {
									return false;
								}
							}
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.ordrgDiv20;
								$.each(options_02, function (idx, elem) {
									if(itemValue == elem.value)
									{
										result_text = elem.text;
									}
								});
								return result_text;
							}
						 }
						,{key: "nextPrcsnNm", 		label: "후행업체", 		width: 150,	align: "left", editor: {type: "text",attributes: {'maxlength': 150,'data-maxlength': 300}}}
						,{key: "dlvplcNm", 			label: "배송처", 			width: 150,	align: "left", editor: {type: "text",attributes: {'maxlength': 150,'data-maxlength': 300}}}
						,{key: "bomQty", 			label: "수량", 			width: 60,		align: "right", editor:{type:  "number"}}
						,{key: "matrCd", 			label: "자재코드", 		width: 80,		align: "center"}
						,{key: "matrNm", 			label: "자재명", 			width: 160,		align: "left"}
						,{key: "goodsDiv", 			label: "자재구분", 		width: 90,	align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.goodsDiv;
								$.each(options_03, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrClntDiv", 		label: "거래처구분", 			width: 120,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrClntDiv;
								$.each(options_04, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrDiv", 			label: "자재유형", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrDiv;
								$.each(options_05, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrGrp", 			label: "자재그룹", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrGrp;
								$.each(options_06, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrMat", 			label: "소재", 				width: 100,		align: "center"}
						,{key: "matrSize", 			label: "크기", 				width: 100,		align: "center"}
						,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "left"}
						,{key: "matrMakrNm", 		label: "제조사", 				width: 100,		align: "center"}
						,{key: "matrMno", 			label: "Model No", 			width: 100,		align: "center"}
						,{key: "matrWt", 			label: "중량", 				width: 100,		align: "right"}
						,{key: "matrUnit", 			label: "단위", 				width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrUnit;
								$.each(options_07, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "useYn", 			label: "사용여부", 			width: 70,		align: "center", formatter: "useYn"}
						,{key: "matrStockCd", 		label: "재고관리", 			width: 70,		align: "center", formatter: "useYn"}
						,{key: "originNm", 			label: "원산지", 				width: 100,		align: "center"}
						,{key: "matrDrwNo", 		label: "대표도면", 			width: 120,		align: "center"}
						,{key: "matrTestDiv", 		label: "입고검사구분", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrTestDiv;
								$.each(options_08, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "dlvrRqmDay", 		label: "납품소요일자", 			width: 100,		align: "right"}
						,{key: "matrPurcDiv", 		label: "구매/외주구분", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrPurcDiv;
								$.each(options_09, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "minOrdrgQty", 		label: "최소발주량", 			width: 100,		align: "right"}
						,{key: "matrSaftQty", 		label: "안전재고", 			width: 100,		align: "right"}
						,{key: "dsgn2DMd", 			label: "2D설계소요일", 			width: 100,		align: "right"}
						,{key: "avrg2DMd", 			label: "2D평균소요일", 			width: 100,		align: "right"}
						,{key: "dsgn3DMd", 			label: "3D설계소요일", 			width: 100,		align: "right"}
						,{key: "avrg3DMd", 			label: "3D평균소요일", 			width: 100,		align: "right"}
						,{key: "prdctnRqmMd", 		label: "생산소요일", 			width: 100,		align: "right"}
						,{key: "prdctnAvrgMd", 		label: "생산평균소요일", 			width: 100,		align: "right"}
						,{key: "matrPartNo", 		label: "파트번호", 			width: 100,		align: "center"}
						,{key: "pchsClntCd1", 		label: "구매업체1", 			width: 80,		align: "right"}
						,{key: "pchsClntPct1", 		label: "구매업체1%", 			width: 80,		align: "right"}
						,{key: "pchsClntCd2", 		label: "구매업체2", 			width: 80,		align: "right"}
						,{key: "pchsClntPct2", 		label: "구매업체2%", 			width: 80,		align: "right"}
						,{key: "pchsClntCd3", 		label: "구매업체3", 			width: 80,		align: "right"}
						,{key: "pchsClntPct3", 		label: "구매업체3%", 			width: 80,		align: "right"}
						,{key: "matrUpr", 			label: "최종구매단가", 			width: 100,		align: "right",  formatter: "money"}
						,{key: "matrAvrgUpr", 		label: "평균구매단가", 			width: 100,		align: "right",  formatter: "money"}
						,{key: "matrRmk", 			label: "비고", 				width: 150,		align: "left"}
						,{key: "matrLastTrstDt", 	label: "최종거래일자", 			width: 100,		align: "center"}
						,{key: "matrAtntCd", 		label: "대체자재코드", 			width: 100,		align: "center"}
						,{key: "matrNo", 			label: "자재번호", 			width: 100,		align: "center"}
		         	]
		    });
			return this;
		},
		
		selectGrid : function(click_dsgnNo) {
			if(before_bomIdx == select_bomIdx) return; //선택행 변경없을때 사용안함.
			
			var delIdxArray = findIndexArray(matrArr, "dsgnNo", before_dsgnNo);
			
			var af_gridList = this.target.getList();
			if(af_gridList.length > 0) {
				$.each(af_gridList, function (idx, elem) {
					matrArr.push(elem);
				});
			}
			//행삭제는 index가 변경되므로 아래에서 삭제
			for(var i=delIdxArray.length-1; i >= 0; i--){
				matrArr.splice(delIdxArray[i],1);
			}
			
			//var target = this.target;
			var list = getFilterData(click_dsgnNo);
			this.target.setData({
        		list : list,
        		page : {
        			totalElements : list.length
        		}
   			});
		},
		
		setData: function(_mod){
			if(_mod != "A"){
				var target = this.target;
				var sel_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
				var list = getFilterData(sel_dsgnNo);
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});
			} else {
				var target = this.target;
				var formData = {
					"coCd" 		: $("#coCd").val(),
					"salesCd" 	: $("#salesCd").val()
				}

	    		postAjax("/user/sm/sm01/selectBomMatrList", formData, null, function(data) {
	    			matrArr = data.resultList;//원본데이타
	    			var sel_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
					var list = getFilterData(sel_dsgnNo);
					target.setData({
	            		list : list,
	            		page : {
	            			totalElements : list.length
	            		}
	       			});
	    	 	});				
			}	
		}
	}


 	$(document).ready(function() {
 		//debugger;
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#salesCd").val(modalStack.last().paramObj.salesCd);
		$("#clntNm").val(modalStack.last().paramObj.clntNm);
		$("#clntPjt").val(modalStack.last().paramObj.clntPjt);
		$("#itemDivNm").val(modalStack.last().paramObj.itemDivNm);
		$("#eqpNm").val(modalStack.last().paramObj.eqpNm);
		$("#prdtNm").val(modalStack.last().paramObj.prdtNm);
		
		//$("#userId").val(jwt.userId);
		
		//$('#ordrsPlanAmt, #ordrsAmt').on('keyup', ordRemCal);

		authChk();// 권한체크

		actionType = modalStack.last().paramObj.actionType;

		/**
		 * grid 초기화
		*/
		bomGridView.initView();
		matrGridView.initView();
		
		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertBomMatr();
			});
			//등록시 ROOT 데이타 생성
			var newRow = {};
			newRow = {dtaChk:"I",coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:0, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:".", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			bomGridView.target.clearSelect();
			bomGridView.target.select(0);
			bomGridView.target.focused = true;
		} else if (actionType == "U") {
			$('.tit').text('구매BOM 수정')
			
			//selectBuyBomList();//수정시 조회
			
			bomGridView.setData(0);

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateBomMatr();
			});
		}
		
		var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		 $("#fileTrgtKey").val(param_fileTrgtKey);
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey	: param_fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  
	});
	
	// 등록
	function insertBomMatr() {
		if(gridDataValidation(bomGridView.target)) return;
		if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
			var formData = makeFormData();									// 요청이 통과하면 formData를 생성
			filePostAjax("/user/sm/sm01/insertBom", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);							// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {						// 요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView1.setData(0);							// 결과갑시 200인 경우 리드 뷰를 업데이트
							modalStack.close();								// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateBomMatr() {
		if(gridDataValidation(bomGridView.target)) return;
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 formData를 생성
	      	filePostAjax("/user/sm/sm01/updateBom", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView1.setData(0);
							modalStack.close();
						}
					});
		}
	}
	 /* 기존 저장과 중복 될 수 있음. 개별 저장 완료 후 수정 필요 */
	 /* 프로젝트 인서트, 업데이트 조건에 따른 간섭이 없는지 재확인 할 것 */

	//----------------------------------------------//
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		var bomArr = [];
		var bomlist = bomGridView.target.list;
		$.each(bomlist,function(idx, obj) {
			if(isEmpty(obj.dtaChk)){
				obj.dtaChk = "";
			}
		});
		formData.append("bomArr", JSON.stringify(bomlist));
		
		//현재 자재정보 그리드정보를 matrArr에  update 한다
		var matrGridList = matrGridView.target.list;
		if(matrGridList.length > 0){
			var delIdxArray = [];
			if(!isEmpty(before_dsgnNo)){
				delIdxArray = findIndexArray(matrArr, "dsgnNo", before_dsgnNo);
			}
			$.each(matrGridList, function (idx, elem) {
				matrArr.push(elem);
			});
			if(!isEmpty(before_dsgnNo)){
				for(var i=delIdxArray.length-1; i >= 0; i--){
					matrArr.splice(delIdxArray[i],1);
				}
			}
		}

		$.each(matrArr,function(idx, obj) {
			if(isEmpty(obj.dtaChk)){
				obj.dtaChk = "";
			}
		});
		formData.append("matrArr", JSON.stringify(matrArr));
		//세부 아이템 자료 끝
		return formData;
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();		
	}

	//Bom 추가
	function addRowBom(){
		//if(selectGridValidation(bomGridView.target)) return;
		var selData = bomGridView.target.getList("selected")[0];
		var bomLength = bomGridView.target.list.length;
		var isBomSelect = !isEmpty(selData);
		let newRow = {};
		if(bomGridView.target.list.length != 0 && isBomSelect == false){
			alert("구매 BOM 행추가시 상위목록을 선택하여야 합니다.");
			return;
		}
		else if(bomGridView.target.list.length == 0 && isBomSelect == false ) {
			//ROOT 데이타 생성
			newRow = {dtaChk:"I", coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:0, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:".", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			//1레벨 데이타 생성
			newRow = {dtaChk:"I", coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:1, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:$("#salesCd").val(), lowerCd:""};	
			bomGridView.target.addRow($.extend({}, newRow), "last");
		}
		else if(isBomSelect == true ){
			var selLevel = Number(selData.lvl);
			var targetLevel = selLevel+1;
			if(targetLevel > 3){
				alert("3레벨[REV] 이상 은 [행추가] 할 수 없습니다. 2레벨 이하를 선택 후 [행추가] 하세요.");
				return;
			}
			if(targetLevel > 3) targetLevel = 3;//3레벨까지 가능 -- SalesCd > PART > UNIT > REV
			newRow = {    dtaChk:"I"
						, coCd: $("#coCd").val()
						, salesCd: $("#salesCd").val()
						, lvl: targetLevel
						, partNo: selData.partNo
						, unitNo: selData.unitNo
						, revNo:  selData.revNo
						, dsgnNo:""
						, upperCd: ""    //입력후 행추가 하지 않는다. selData.lowerCd
						, lowerCd: ""
					};
			bomGridView.target.addRow($.extend({}, newRow),selData.__index+1,);

			//_this.target.updateRow($.extend({}, _this.target.list[_selthis.dindex], {data1: data.value}), _selthis.dindex);
			//_dindex = 2;
			//bomGridView.target.addRow($.extend({}, newRow));
			//var dindex = 1;
			//.$.extend({}, 추가할 내용),삽인할위치,갯수);
			//bomGridView.target.addRow($.extend({}, bomGridView.target.list[dindex], newRow),0,);
			//bomGridView.target.addRow(newRow);
        	//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
	        //firstGrid.addRow($.extend({}, firstGrid.list[param.dindex], {__index: undefined}),param.dindex+1,);		
	        //firstGrid.setValue(param.dindex, 'updcheck', 1);
		}
		//console.log(bomGridView.target.getList());
	}
	
	//Bom 삭제
	function delRowBom() {
		if(selectGridValidation(bomGridView.target)) return;
		var selData = bomGridView.target.getList("selected")[0];
		var isBomSelect = !isEmpty(selData);
		var selLevel = selData.lvl;
		if(selLevel == 0){
			alert("최상위는 삭제 할 수 없습니다.");
			return -1;
		}
		var bomDtaChk = selData.dtaChk;
		if(bomDtaChk == "I"){
			bomGridView.target.removeRow(selData.__index);
		}
		else {
			bomGridView.target.setValue(selData.__index, "dtaChk", "D");
		}
	}
	
	//자재추가 - 사용안함.
	this.addRowMatr = function() {
		var bomData = bomGridView.target.getList("selected")[0];
		var matrLength = matrGridView.target.list.length;
		let newRow = {};
		newRow = { dtaChk:"I"
			, coCd: bomData.coCd
			, salesCd: bomData.salesCd
			, dsgnNo: bomData.dsgnNo
			, upperCd: bomData.upperCd
			, lowerCd: bomData.lowerCd
			, matrSeq: matrLength+1
		};
		
		matrGridView.target.addRow($.extend({}, newRow), "last");
	}
	
	//자재품번 검색
	function openMatListSearch() {
		if(gridDataValidation(bomGridView.target)) return;
		//debugger;
		var bomData = bomGridView.target.getList("selected")[0];
		var matrLength = matrGridView.target.list.length;
		var paramObj = {
			"coCd" : $('#coCd_S').val(),
			"searchValue" : $("#matrCd_S").val()
		}
		
		openSecondModal("/static/html/cmn/modal/matListSearch.html", 1200, 700, "자재 검색", paramObj, function (grid) {
			var newRow = grid.target.getList("selected")[0];
			newRow.dtaChk = "I";
			newRow.coCd = bomData.coCd;
			newRow.salesCd = bomData.salesCd;
			newRow.dsgnNo = bomData.dsgnNo;
			newRow.upperCd = bomData.upperCd;
			newRow.lowerCd = bomData.lowerCd;
			newRow.matrSeq = matrLength+1;
			matrGridView.target.addRow($.extend({}, newRow), "last");
		});
	}
	
	//자재수정
	this.modRowMatr = function() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		console.log(selData);
		var matrDtaChk = selData.dtaChk;
		var paramObj = {
				"coCd" : $('#coCd_S').val(),
				"searchValue" : selData.matrCd
			}
		
		openSecondModal("/static/html/cmn/modal/matListSearch.html", 1200, 700, "자재 검색", paramObj, function (grid) {
			var newRow = grid.target.getList("selected")[0];
			if(selData.dtaChk == "I"||selData.dtaChk == "D"){
				newRow.dtaChk = selData.dtaChk;
			} else {
				newRow.dtaChk = "U";
			}
			matrGridView.target.updateRow($.extend({}, matrGridView.target.list[selData.__index], newRow), selData.__index);
		});
	}
	//자재삭제
	this.delRowMatr = function() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		var matrDtaChk = selData.dtaChk;
		if(matrDtaChk == "I"){
			matrGridView.target.removeRow(selData.__index);
		}
		else {
			matrGridView.target.setValue(selData.__index, "dtaChk", "D");
		}
	}
	
	this.getFilterData = function(sel_dsgnNo) {
		const resultData = matrArr.filter(function(element){
			return sel_dsgnNo == element.dsgnNo;
		});
		return resultData;
	}

	this.gridDataValidation = function(gridObj){
		var dataList = gridObj.getList();
		for(i=0; i<dataList.length; i++){
			if(dataList[i]["lvl"] >= "1"){ //1,2,3 레벨체크
				if(empty(dataList[i]["partNo"])){
					gridObj.clearSelect();
					gridObj.select(i);
					gridObj.focused = true;
					alert("구매 BOM의 [PART]는 필수입력 항목입니다.");
					return true;
				}
			}
			if(dataList[i]["lvl"] >= "2"){
				if(empty(dataList[i]["unitNo"])){
					gridObj.clearSelect();
					gridObj.select(i);
					gridObj.focused = true;
					alert("구매 BOM의 [UNIT]는 필수입력 항목입니다.");
					return true;
				}
			}
			if(dataList[i]["lvl"] >= "3"){
				if(empty(dataList[i]["revNo"])){
					gridObj.clearSelect();
					gridObj.select(i);
					gridObj.focused = true;
					alert("구매 BOM의 [REV]는 필수입력 항목입니다.");
					return true;
				}
			}
			if(dataList[i]["lvl"] >= "1"){ //1,2,3 레벨체크
				if(empty(dataList[i]["upperCd"])||empty(dataList[i]["lowerCd"])||empty(dataList[i]["dsgnNo"])){
					gridObj.clearSelect();
					gridObj.select(i);
					gridObj.focused = true;
					alert("구매 BOM의 [PART][UNIT][REV]으로 레벨을 구성하지 못했습니다  삭제후 제입력 하세요.");
					return true;
				}
			}
		}
		return false;
	}
	function empty(str){
		if(typeof str == "undefined" || str == null || str == "")
			return true;
		else
			return false ;
	}
	
	this.findIndexArray = function(gridObj, column, value) {
		var resultArray = [];
		if( gridObj.length > 0 ) {
	        $.each($.extend({}, gridObj), function (idx, elem) {
				if(elem[column] == value) {
					resultArray.push(idx);
				}
	        });			
		}
		return resultArray;
	}
	
	this.findIndex = function(gridObj, appId) {
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			var idArr = [];			
	        $.each(gridList, function (idx, elem) {
        		//idArr.push(elem.appId);
	        });			
	        if( idArr.indexOf(appId) > -1 ) {
	        	//return true;
	        } else {
	        	//return false;
	        }
	        return 0;
		}
		return -1;
	}
	
	function adPer(str){
		if(typeof str == "undefined" || str == null || str == "") {
			return "";
		}
		return "-"+str ;
	}	

</script>