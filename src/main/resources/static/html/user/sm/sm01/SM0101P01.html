<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">구매BOM 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
      <!-- 
      <input type="hidden" id="prjctInfo" style="display: none" multiple="multiple" onchange="setPrjct(this);">
      <input type="hidden" id="prjctSeq"  name="prjctSeq">
       -->
      <input type="hidden" id="pgmId"     name="pgmId" value="SM0101M01">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
			<th class="hit">회사</th>
			<td>
			  <select id="coCd" name="coCd" data-kind="CO" required="required" msg="회사" readonly>
			  </select>
			</td>
			<th>Sales Code</th>
			<td>
				<input type="text" id="salesCd" name="salesCd" required="required" msg="Sales Code" readonly>
			</td>
			<th>고객사</th>
			<td>
				<input type="text" id="clntNm" name="clntNm" msg="고객사" readonly>
			</td>
			<th>고객사PJT</th>
			<td>
				<input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT" readonly> 
			</td>
        </tr>

        <tr>
			<th>제품구분</th>
			<td>
				<input type="text" id="prdtNm" name="prdtNm" msg="제품명" readonly>
			</td>
			<th>아이템구분</th>
			<td>
				<input type="text" id="itemDivNm" name="itemDivNm" msg="아이템구분" readonly>
			</td>
			<th>설비명</th>
			<td colspan="3">
				<input type="text" id="eqpNm" name="eqpNm" msg="설비명" readonly>
			</td>
        </tr>

      </table>

    </form>

		<!-- 콘텐츠 -->
	  <div class="contents" style="margin-top: 10px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:350px; width: 100%">
	            <li style="width: 35%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a onclick="addRowBom()" style="" authchk>+</a>
		                    <a onclick="delRowBom()" style="" authchk>-</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="bom-grid" data-ax5grid-config="{}" style="height:300px; width: 100%" ></div>
	                </div>
	            </li>
	            <li style="width: 63%; margin-left: 8px;">
	                <div class="table_list_tit">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">자재정보</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a onclick="addRowMatr()" style="" authchk>+</a>
		                    <a onclick="delRowMatr()" style="" authchk>-</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="matr-grid" data-ax5grid-config="{}" style="height:300px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>


	<!-- 공통 파일 영역 -->
        <div class="col-sm-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 400px;padding: 5px">
                    <div id="deptTreeOrdars"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
                <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
            </div>
        </div>
        	
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
  
var actionType = null;

var firstGrid = null;
var secondGrid = null;

var bomArr = []; //bom
var bomDeleteArr = [];//삭제 내용 저장
var detailArr = [];

var matrArr = [];  //자재 데이타
var fillter_matrArr = [];  //필터링 자재 데이타

var before_bomIdx = -1; //제품선택병경 체크용 인덱스
var before_dsgnNo = null;

var select_bomIdx = -1; //제품선택병경 체크용 인덱스
var select_dsgnNo = null;


var saveWork = false;	 //제품 아이템 수정 내역 체크
var savePrdtCd = null;	 //제품선택변경 체크용
var savePrdtNewCd = null;	//제품선택변경 체크용

let selectedRowKey;
let previousSelectedRowKey;
let selectedPrdtCd;
let selectedPrdtNm;

var bomGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="bom-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: false
		         },
		         body: {
			        	 onClick: function () {
			             	this.self.select(this.dindex);
			             	select_bomIdx = this.dindex;
			             	select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
			             	
			             	//원본데이타에서 화면데이터 제거 --> 화면데이타 put 원본데이타에.
			             	matrGridView.mastClick(select_dsgnNo);
			             	before_bomIdx = this.dindex;
			             	before_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
			             	
			             	//matrGridView.initView();
			             	//matrGridView.setData(0);
			                /*
			                if (saveWork) {
		                		matrArr[before_bomIdx] = matrGridView.target.list;
		                		saveWork = false;
			                }
			                
			                savePrdtCd = this.item.prjctPrdtCd;
			                savePrdtNewCd = this.item.prjctPrdtNewCd;
			                matrGridView.setData(savePrdtCd, savePrdtNewCd);
			                */
			        	 },
			        	 /*
						 onDBLClick: function () {
						 	updatePrdtList('U');
						 },
						 */
			             onDataChanged: function () {
			            	if (this.item.__selected__ == true) {
			                	//before_bomIdx = this.dindex;
			                	//savePrdtCd = this.item.prjctPrdtCd;
			                	//savePrdtNewCd = this.item.prjctPrdtNewCd;
			                }
			            	
			            	if(this.key == "dtaChk"){
				            	if(this.item.dtaChk != "I") {
				            		this.item.dtaChk = 'U';
				            	}
			            	}

			            	//입력후 partNo, unitNo, revNo 입력 문자크기 잘못 입력시 지움
			            	if(this.item.lvl == 1 && this.key == "partNo" && this.value != "" && (""+this.item.partNo).length < 4){
			            		this.item.partNo = "";
			            	}
			            	else if(this.item.lvl == 2 && this.key == "unitNo" && this.value != "" && (""+this.item.partNo).length < 3){
			            		this.item.partNo = "";
			            	}
			            	else if(this.item.lvl == 3 && this.key == "revNo" && this.value != "" && (""+this.item.partNo).length < 2){
			            		this.item.partNo = "";
			            	}
			            	
			            	//입력후 partNo, unitNo, revNo 로  dsgnNo,lowerCd 생성
			            	if(this.item.lvl == 1 && this.key == "partNo"){
			            		this.item.dsgnNo = this.item.salesCd + adPer(this.item.partNo);
			            	}
			            	else if(this.item.lvl == 2 && this.key == "unitNo"){
			            		this.item.dsgnNo = this.item.salesCd + adPer(this.item.partNo) + adPer(this.item.unitNo);
			            	}
			            	else if(this.item.lvl == 3 && this.key == "revNo"){
			            		this.item.dsgnNo = this.item.salesCd + adPer(this.item.partNo) + adPer(this.item.unitNo) + adPer(this.item.revNo);
			            	}
			            	this.item.lowerCd = this.item.dsgnNo;
			            	
			             },
	             },
		        columns : [
		        	//,hidden:true
		        	{key: "dtaChk",label: " ", width: 30},
		        	{key: "fileTrgtKey",label: "k", width: 30,hidden:true},
		        	{key: "coCd", label: "CO", width: 50},
		        	{key: "salesCd", label: "Sales Code", width: 120},
		        	{key: "lvl", label: "LVL", width: 50},
	                {key: "partNo", label: "PART", width: 80, 
		        		editor:{type:  "number",
			        			disabled: function () {
			        				if(this.item.lvl >= 1){
				        		        return false;
			        				} else {
			        					return true;
			        				}
			        		    },
			        		    attributes: {
			        		        'maxlength': 4, 'data-maxlength': 4
			        		    }
        				}
	                },
	                {key: "unitNo", label: "UNIT", width: 80,
		        		editor:{type: "number",
			        			disabled: function () {
			        				if(this.item.lvl >= 2){
				        		        return false;
			        				} else {
			        					return true;
			        				}
			        		    },
			        		    attributes: {
			        		        'maxlength': 3, 'data-maxlength': 3
			        		    }
	        			}
	                },
	                {key: "revNo", label: "REV", width: 80,
		        		editor: {type: "text",
		        			disabled: function () {
		        				if(this.item.lvl >= 3){
			        		        return false;
		        				} else {
		        					return true;
		        				}
		        		    },
		        		    attributes: {
		        		        'maxlength': 2
		        		    }
            			}
	                },
		        	{key: "dsgnNo" , label: "도번" 	,width: 120,align: "left"},
					{key: "upperCd", label: "상위코드" ,width: 110,align: "left"},
					{key: "lowerCd", label: "하위코드" ,width: 130,align: "left"}
			     ]
		    });
			return this;
		},


        setData: function(_pageNo){
			var target = this.target;
			var formData = {
				"salesCd" 		: $("#salesCd").val(),
			}

    		postAjax("/user/sm/sm01/selectBuyBomList", formData, null, function(data) {
				var list = data.resultList;
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});
				if(list.length > 0){
					bomGridView.target.clearSelect();
					//bomGridView.target.focus("HOME")
					bomGridView.target.select(0);
					bomGridView.target.focused = true;
					select_bomIdx = 0;
					before_bomIdx = 0;
					select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
					before_dsgnNo = select_dsgnNo;
					
					//자재정보 조회
					matrGridView.setData('A');
				}
    	 	});
        	/*
			if (chk) {
				var target = this.target;
				var list = bomGridView.target.list
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			 });
        	} else {
				var target = this.target;
				var formData = {
					"salesCd" 		: $("#salesCd").val(),
				}
	
	    		postAjax("/user/sm/sm01/selectBuyBomList", formData, null, function(data) {
					var list = data.resultList;
					target.setData({
	            		list : list,
	            		page : {
	            			totalElements : list.length
	            		}
	       			 });
	    	 	});
        	}
        	*/
     	} //setData
     }


var matrGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: false,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="matr-grid"]'),
		         header: {
			        		 align: "center",
			        		 selector: false
			    },
		        body: {
  			               onClick: function () {
  			               this.self.select(this.dindex);
			          },
			          onDBLClick: function () {
		
			          },
			          onDataChanged: function () {
			            	//아이템 상세내역이 수정이 있으면 저장 필요
			            	saveWork = true;
			            	this.item.itemUpd = 'U';
			          },
		        },
		        columns : [
		        		 {key: "itemUpd",label: " ", width: 30}
						,{key: "dsgnNo", 			label: "도번", 			width: 180,	align: "left"}
			 	 	 	,{key: "coCd", 				label: "CO", 			width: 50,	align: "center"}
						,{key: "salesCd", 			label: "Sales Code", 	width: 120,	align: "left"}
						,{key: "matrSeq", 			label: "순번", 			width: 70,	align: "center"}
						,{key: "upperCd", 			label: "상위코드", 		width: 160,	align: "left"}
						,{key: "lowerCd", 			label: "하위코드", 		width: 180,	align: "left"}
						,{key: "ordrgDiv10", 		label: "발주용도", 		width: 100,	align: "left"}
						,{key: "ordrgDiv20", 		label: "발주유형", 		width: 100,	align: "left"}
						,{key: "nextPrcsnNm", 		label: "후행업체", 		width: 100,	align: "left"}
						,{key: "dlvplcNm", 			label: "배송처", 			width: 100,	align: "left"}
						,{key: "matrCd", 			label: "자재코드", 		width: 100,	align: "left"}
						,{key: "matrNm", 			label: "자재명", 			width: 120,	align: "left"}
						,{key: "goodsDiv", 			label: "제품/자재구분", 		width: 100,	align: "left"}
						,{key: "matrClntDiv", 		label: "거래처구분", 		width: 100,	align: "left"}
						,{key: "matrDiv", 			label: "자재유형", 		width: 100,	align: "left"}
						,{key: "matrGrp", 			label: "자재분류-자재그룹", 	width: 100,	align: "left"}
						,{key: "matrMat", 			label: "소재", 			width: 100,	align: "left"}
						,{key: "matrSize", 			label: "크기", 			width: 100,	align: "left"}
						,{key: "matrSpec", 			label: "규격", 			width: 100,	align: "left"}
						,{key: "matrMakrNm", 		label: "제조사", 			width: 100,	align: "left"}
						,{key: "matrMno", 			label: "형번(Model No)", 	width: 100,	align: "left"}
						,{key: "matrWt", 			label: "중량", 			width: 100,	align: "left"}
						,{key: "matrUnit", 			label: "단위", 			width: 100,	align: "left"}
						,{key: "originNm", 			label: "원산지", 			width: 100,	align: "left"}
						,{key: "matrDrwNo", 		label: "대표도면", 		width: 100,	align: "left"}
						,{key: "matrTestDiv", 		label: "입고검사구분", 		width: 100,	align: "left"}
						,{key: "dlvrRqmDay", 		label: "납품소요일자", 		width: 100,	align: "left"}
						,{key: "matrPurcDiv", 		label: "구매/외주구분", 		width: 100,	align: "left"}
						,{key: "minOrdrgQty", 		label: "최소발주량", 		width: 100,	align: "left"}
						,{key: "matrSaftQty", 		label: "안전재고", 		width: 100,	align: "left"}
						,{key: "matrStockCd", 		label: "재고관리여부", 		width: 100,	align: "left"}
						,{key: "dsgn2DMd", 			label: "2D설계소요일", 		width: 100,	align: "left"}
						,{key: "avrg2DMd", 			label: "2D평균소요일", 		width: 100,	align: "left"}
						,{key: "dsgn3DMd", 			label: "3D설계소요일", 		width: 100,	align: "left"}
						,{key: "avrg3DMd", 			label: "3D평균소요일", 		width: 100,	align: "left"}
						,{key: "prdctnRqmMd", 		label: "생산소요일", 		width: 100,	align: "left"}
						,{key: "prdctnAvrgMd", 		label: "생산평균소요일", 		width: 100,	align: "left"}
						,{key: "useYn", 			label: "사용여부", 		width: 100,	align: "left"}
						,{key: "matrPartNo", 		label: "파트번호", 		width: 100,	align: "left"}
						,{key: "pchsClntCd1", 		label: "구매업체1", 		width: 100,	align: "left"}
						,{key: "pchsClntPct1", 		label: "구매업체1%", 		width: 100,	align: "left"}
						,{key: "pchsClntCd2", 		label: "구매업체2", 		width: 100,	align: "left"}
						,{key: "pchsClntPct2", 		label: "구매업체2%", 		width: 100,	align: "left"}
						,{key: "pchsClntCd3", 		label: "구매업체3", 		width: 100,	align: "left"}
						,{key: "pchsClntPct3", 		label: "구매업체3%", 		width: 100,	align: "left"}
						,{key: "matrUpr", 			label: "최종구매단가", 		width: 100,	align: "left"}
						,{key: "matrAvrgUpr", 		label: "평균구매단가", 		width: 100,	align: "left"}
						,{key: "matrRmk", 			label: "비고", 			width: 100,	align: "left"}
						,{key: "matrLastTrstDt", 	label: "최종거래일자", 		width: 100,	align: "left"}
						,{key: "matrAtntCd", 		label: "대체자재코드", 		width: 100,	align: "left"}
						,{key: "matrNo", 			label: "자재번호", 		width: 100,	align: "left"}
		        	/*
		               {key : "isChk",    			label : "선택",   		width : 80,
	          	  			editor: {type: "checkbox",	config: {trueValue : "Y",	falseValue : "N"}}}
	                  ,{key : "prjctSeq",  			label : "프로젝트시퀀스", 	width : 40,		hidden: true}
	                  ,{key : "prjctPrdtCd",  		label : "제품코드", 		hidden: true}
		              ,{key : "codeId",				label : "코드아이디",  	hidden: true}
		              ,{key : "prjctItemCd", 		label : "등록아이템코드", 	width : 100,	hidden: true}
		              ,{key : "codeNm",  	  		label : "아이템내역",     	width : 200,}
			          ,{key : "prjctPrdtNewCd",  	label : "신규",    		width : 50,		hidden: true}
		              ,{key : "prjctItemRmk", 		label : "비고",   		width : 300,  	editor: {type: "textarea"}}
		              */
		         	]
		    });
			return this;
		},
		
		mastClick : function(click_dsgnNo) {
			if(before_bomIdx == select_bomIdx) return;
			var delArray = [];
			var _delArrayIndex = 0;
			console.log("click_dsgnNo######>>[[[["+click_dsgnNo+"]]]] matrArr.length>>"+matrArr.length);
			console.log("before_bomIdx######>>=["+before_bomIdx+"]=");
			console.log("select_bomIdx######>>=["+select_bomIdx+"]=");
			/*
			$.each($.extend({}, matrArr), function (idx, elem) {
				if(_dsgnNo == elem.dsgnNo)
				{
					delArray[_delArrayIndex++] = idx;
				}
	        });
			const gridList = this.target.getList();
			console.log("!!!!gridList.length>>"+gridList.length);
			$.each(gridList, function (idx, elem) {
				matrArr.push(elem);
			});
			console.log("matrArr.length######Push>>"+matrArr.length);
			//데이타의 역순 Index로 삭제한다.
			for(var i=delArray.length-1; i >= 0; i--){
				//console.log("delArray[i]>>"+delArray[i]);
				matrArr.splice(delArray[i],1);
			}
			console.log("matrArr.length#####del>>"+matrArr.length);
			
			
			*/
			
			console.log("################# before_dsgnNo>>"+before_dsgnNo);
			
			var delIdxArray = findIndexArray(matrArr, before_dsgnNo);
			console.log(delIdxArray);
			
			var af_gridList = this.target.getList();
			console.log("Push ******************>>"+af_gridList.length);
			if(af_gridList.length > 0) {
				$.each(af_gridList, function (idx, elem) {
					console.log("#####push>>>>>"+elem.dsgnNo);
					matrArr.push(elem);
				});
			}
			
			for(var i=delIdxArray.length-1; i >= 0; i--){
				console.log("#####delIndex>>>>>"+delIdxArray[i]);
				matrArr.splice(delIdxArray[i],1);
			}
			console.log("matrArr.length 삭제후 ########>>"+matrArr.length);
			console.log("matrArr.length END #######>>"+matrArr.length);
			
			console.log(matrArr);
			//var target = this.target;
			var list = getFilterData(click_dsgnNo);
			this.target.setData({
        		list : list,
        		page : {
        			totalElements : list.length
        		}
   			});
		},
		
		setData: function(_mod){
			if(_mod != "A"){
				var target = this.target;
				var sel_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
				var list = getFilterData(sel_dsgnNo);
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});
			} else {
				var target = this.target;
				var formData = {
					"salesCd" 		: $("#salesCd").val(),
				}

	    		postAjax("/user/sm/sm01/selectBomMatrList", formData, null, function(data) {
	    			matrArr = data.resultList;//원본데이타
	    			var sel_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
					var list = getFilterData(sel_dsgnNo);
					target.setData({
	            		list : list,
	            		page : {
	            			totalElements : list.length
	            		}
	       			});
	    	 	});				
			}
			
			/*
			secondGrid = this.target;			
			if (matrArr[before_bomIdx]) {
				var list = matrArr[before_bomIdx];
				secondGrid.setData({
					list : list,
					page : {
						totalElements : list.length
					}
		     	});
			} else {
				if (prdtCd) {
		   		 	var formData = {
						"salesCd" 		: $("#salesCd").val()
		   		 	}
					postAjax("/user/sm/sm01/selectBomMatrList", formData, null, function(data) {
							var list = data.itemList;
							secondGrid.setData({
								list : list,
								page : {
									totalElements : list.length
								}
					     	});
					});
				}
			}
			*/
		}
}

 	$(document).ready(function() {
 		//debugger;
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#salesCd").val(modalStack.last().paramObj.salesCd);
		$("#clntNm").val(modalStack.last().paramObj.clntNm);
		$("#clntPjt").val(modalStack.last().paramObj.clntPjt);
		$("#itemDivNm").val(modalStack.last().paramObj.itemDivNm);
		$("#eqpNm").val(modalStack.last().paramObj.eqpNm);
		$("#prdtNm").val(modalStack.last().paramObj.prdtNm);
		
		//$("#userId").val(jwt.userId);
		
		//$('#ordrsPlanAmt, #ordrsAmt').on('keyup', ordRemCal);

		authChk();// 권한체크

		actionType = modalStack.last().paramObj.actionType;
		savePrdtCd = '';
		savePrdtNewCd = '';

		/**
		 * grid 초기화
		*/
		bomGridView.initView();
		matrGridView.initView();
		
		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertBomMatr();
			});
			//등록시 ROOT 데이타 생성
			var newRow = {};
			newRow = {__index: undefined, dtaChk:"I",coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:0, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:".", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			bomGridView.target.clearSelect();
			bomGridView.target.select(0);
			bomGridView.target.focused = true;
		} else if (actionType == "U") {
			$('.tit').text('구매BOM 수정')
			
			//selectBuyBomList();//수정시 조회
			
			bomGridView.setData(0);

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateBomMatr();
			});
		}
		
		var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey : param_fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  
	});
	
	function selectBuyBomList() {						//그리드에 뿌리는 데이터
		var formData = {
			"salesCd" : $("#salesCd").val()
		}
	
		return;
		postAjax("/user/sm/sm01/selectBuyBomList", formData, null, function(data) {
				$.each(data.result, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				
				var prdtList = data.result;
				
				if (prdtList.length) {
					//bomGridView.setData(0); 		//첫 번째 그리드의 데이터를 불러오기
					//savePrdtCd = prdtList[0].prjctPrdtCd;
					//savePrdtNewCd = prdtList[0].prjctPrdtNewCd;
					//matrGridView.setData(savePrdtCd, savePrdtNewCd); 
// 					bomGridView.target.focus("HOME");
				}
				//before_bomIdx = 0;
		});
	}


	//-----아래로 인서트,업데이트 PrdtList , ItemList 개별 저장 ----------------------//
    //--  SD0601M01 복사 수정 본 참고자료-----  //

	function updatePrdtList(type){
		
        if (saveWork) {
       		matrArr[before_bomIdx] = matrGridView.target.list;
       		saveWork = false;
		}		
		
		if ( type == 'U') {
			if (selectGridValidation(bomGridView.target))
				return;
			var paramObj = bomGridView.target.getList("selected")[0];
				paramObj["prdtActionType"] = type;
		} else {
			var paramObj = {prdtActionType : type};
		}
		
		openSecondModal("/static/html/user/sm/sm01/bm1602d01.html", 690, 280, "대상설비", paramObj, function (rtnData) {
			var idx; //수정이면 이전 인덱스에 해당하는 값을 대체, 아니면 추가
			var crudChk;
			
			if ( type == 'U') {
				idx = bomGridView.target.getList("selected")[0].__index;
				crudChk = 'U';
			} else {
				idx = bomGridView.target.getList().length;
				crudChk = 'I';
			}
			before_bomIdx = idx;
			
			bomGridView.target.list[idx] = {
				  prjctSeq			: (type =="U") ? rtnData.prjctSeq : 0,  //처음 파라메터 프로젝트 키값
				  prjctInpexpCd		: $("#inpexpCd").val(),
				  prjctInpexpNm		: rtnData.prjctInpexpNm,
				  prjctPrdtNewCd	: rtnData.prjctPrdtNewCd,
				  prjctPrdtNewNm	: rtnData.prjctPrdtNewNm,
				  prjctPrdtCd		: rtnData.prjctPrdtCd,
				  prdtNm			: rtnData.prdtNm,
				  prjctPrdtQty		: rtnData.prjctPrdtQty,
				  prjctPrdtOrdrsDt	: rtnData.prjctPrdtOrdrsDt,
				  prjctPrdtPlanDt	: rtnData.prjctPrdtPlanDt,
				  prjctPrdtRmk		: rtnData.prjctPrdtRmk,
				  __index			: idx,
				  prjctCrudChk		: crudChk,
        		  dtaChk			:'U'
			};
// 			bomGridView.target.repaint();
/*
			bomGridView.setData('chk');
			bomGridView.target.focus("END");
			savePrdtCd = rtnData.prjctPrdtCd;
			savePrdtNewCd = rtnData.prjctPrdtNewCd;
			matrGridView.setData(savePrdtCd, savePrdtNewCd); 		
			*/
				
		});
	}

	
	function deletePrdtList(idx){
		if (selectGridValidation(bomGridView.target))
			return;
		var obj = bomGridView.target.getList("selected")[0];
		if (obj.prjctSeq) {
			obj.prjctCrudChk = 'D';   //DB에 등록된 자료인 경우 삭제 로 저장
			bomDeleteArr.push(obj);
		}
		bomGridView.target.list.splice(idx,1);
		bomGridView.target.repaint();
	}


	 // 등록
	function insertBomMatr() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();															// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/user/sm/sm01/insertBom", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);														// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {													//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);																// 결과갑시 200인 경우 리드 뷰를 업데이트
							modalStack.close();																  // 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateBomMatr() {
		if (inputValidation($('.popup_area [required]'))) {									// 필수 필드의 유효성 검사
			var formData = makeFormData();													// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
	      	filePostAjax("/user/sm/sm01/updateBom", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							saveWork = false;
// 							selectPrjctInfo();
							modalStack.close();
						}
					});
		}
	}
	 /* 기존 저장과 중복 될 수 있음. 개별 저장 완료 후 수정 필요 */
	 /* 프로젝트 인서트, 업데이트 조건에 따른 간섭이 없는지 재확인 할 것 */

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		//제품-설비자료 준비
		bomArr = bomDeleteArr.slice(0);
		var list = bomGridView.target.list;
		$.each(list,function(idx, obj) {
			if (obj.dtaChk == 'U') {
				if (obj.prjctCrudChk != 'I') {
					obj.prjctCrudChk = 'U';
				}
				bomArr.push(obj);
			}
		});
		
		formData.append("bomArr", JSON.stringify(bomArr));
		//제품-설비자료  끝		

		//세부 아이템 자료 준비
        if (saveWork) {
			matrArr[before_bomIdx] = matrGridView.target.list;
       		saveWork = false;
        }
		
		detailArr = [];
		$.each(matrArr,function(before_bomIdx, list) {
			if (list) {
// 			var list = matrGridView.target.list;
				$.each(list,function(idx, obj) {
					if (obj.itemUpd == 'U') {
						if (!obj.prjctItemCd && obj.isChk == 'Y') {
							//obj.dtaChk = 'I';
							obj.prjctSeq = $("#prjctSeq").val();
							obj.prjctItemCd = obj.codeId;
							detailArr.push(obj);
						} else if (obj.prjctItemCd && obj.isChk == 'Y') {
							//obj.dtaChk = 'U';
							detailArr.push(obj);
						} else if (obj.prjctItemCd && obj.isChk == 'N') {
							//obj.dtaChk = 'D';
							detailArr.push(obj);
						}
					}
				});
			}
		});		

		formData.append("matrArr", JSON.stringify(detailArr));//선택된 ROW 만 formData에 저장
		//세부 아이템 자료 끝
		return formData;
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();		
	}

	//Bom 추가
	function addRowBom(){
		let param = {dindex: selectedRowKey};
		
		//bomGridView.addRow($.extend({}, {...}), "first");
		//ax5Grid.addRow($.extend({}, {...}), "last", {focus: "END"});
		//ax5Grid.addRow($.extend({}, {...}), "last", {focus: "HOME"});
		//ax5Grid.addRow($.extend({}, {...}), "last", {focus: 10});
     	//firstGrid.addRow($.extend({}, firstGrid.list[param.dindex], {__index: undefined}),param.dindex+1,);		
     	//firstGrid.setValue(param.dindex, 'updcheck', 1);
		//bomGridView.addRow($.extend({}, bomGridView.list[param.dindex], {__index: undefined}),param.dindex+1,);
		//bomGridView.target.addRow($.extend({}, bomGridView.target.list[param.dindex], {__index: undefined}),param.dindex+1,);
		
		//let newRow = {__index: undefined, dtaChk:"I"};
		//console.log(bomGridView.target.list.length);
		//console.log(bomGridView.target.getList("selected")[0]);
		var selData = bomGridView.target.getList("selected")[0];
		var bomLength = bomGridView.target.list.length;
		var isBomSelect = !isEmpty(selData);
		//console.log(selData);
		console.log("bomLength>>"+bomLength+"  isBomSelect>>"+isBomSelect);
		let newRow = {};
		if(bomGridView.target.list.length != 0 && isBomSelect == false){
			alert("구매 BOM 행추가시 상위목록을 선택하여야 합니다.");
			return -1;
		}
		else if(bomGridView.target.list.length == 0 && isBomSelect == false ) {
			//ROOT 데이타 생성
			newRow = {dtaChk:"I", coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:0, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:".", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			//1레벨 데이타 생성
			newRow = {dtaChk:"I", coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:1, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:$("#salesCd").val(), lowerCd:""};	
			bomGridView.target.addRow($.extend({}, newRow), "last");
		}
		else if(isBomSelect == true ){
			var selLevel = selData.lvl;
			var targetLevel = selLevel+1;
			if(targetLevel > 3) targetLevel = 3;//3레벨까지 가능 -- SalesCd > PART > UNIT > REV
			newRow = {    dtaChk:"I"
						, coCd: $("#coCd").val()
						, salesCd: $("#salesCd").val()
						, lvl: targetLevel
						, partNo: selData.partNo
						, unitNo: selData.unitNo
						, revNo:  selData.revNo
						, dsgnNo:""
						, upperCd:$("#salesCd").val()
						, lowerCd: ""
					};
			//_this.target.updateRow($.extend({}, _this.target.list[_selthis.dindex], {data1: data.value}), _selthis.dindex);
			//_dindex = 2;
			//bomGridView.target.addRow($.extend({}, newRow));
			//var dindex = 1;
			//.$.extend({}, 추가할 내용),삽인할위치,갯수);
			bomGridView.target.addRow($.extend({}, newRow),selData.__index+1,);
			//bomGridView.target.addRow($.extend({}, bomGridView.target.list[dindex], newRow),0,);
			//bomGridView.target.addRow(newRow);
        	//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
	        //firstGrid.addRow($.extend({}, firstGrid.list[param.dindex], {__index: undefined}),param.dindex+1,);		
	        //firstGrid.setValue(param.dindex, 'updcheck', 1);
		}
		
		
		//console.log(bomGridView.target.getList());
	}
	
	//Bom 삭제
	function delRowBom() {
		var selData = bomGridView.target.getList("selected")[0];
		var isBomSelect = !isEmpty(selData);
		if(bomGridView.target.list.length != 0 && isBomSelect == false){
			alert("삭제 행을 선택하여야 합니다.");
			return -1;
		}
		var selLevel = selData.lvl;
		if(selLevel == 0){
			alert("최상위는 삭제 할 수 없습니다.");
			return -1;
		}
		var bomDtaChk = selData.dtaChk;
		if(bomDtaChk == "I"){
			bomGridView.target.removeRow(selData.__index);
		}
		else {
			bomGridView.target.setValue(selData.__index, "dtaChk", "D");
		}
	}
	
	//자재추가
	this.addRowMatr = function() {
		var bomData = bomGridView.target.getList("selected")[0];
		var matrLength = matrGridView.target.list.length;
		let newRow = {};
		newRow = { itemUpd:"I"
			, coCd: bomData.coCd
			, salesCd: bomData.salesCd
			, dsgnNo: bomData.dsgnNo
			, upperCd: bomData.upperCd
			, lowerCd: bomData.lowerCd
			, matrSeq: matrLength+1
		};
		
		matrGridView.target.addRow($.extend({}, newRow), "last");
	}
	
	//자재삭제
	this.delRowMatr = function() {
		var selData = matrGridView.target.getList("selected")[0];
		if(isEmpty(selData)){
			alert("삭제 행을 선택하여야 합니다.");
			return;
		}
		matrGridView.target.removeRow(selData.__index);
	}
	
	this.getFilterData = function(sel_dsgnNo) {
		const resultData = matrArr.filter(function(element){
			return sel_dsgnNo == element.dsgnNo;
		});
		return resultData;
	}

	this.findIndexArray = function(gridObj, _dsgnNo) {
		var resultArray = [];
		if( gridObj.length > 0 ) {
	        $.each($.extend({}, gridObj), function (idx, elem) {
				if(elem.dsgnNo == _dsgnNo) {
					resultArray.push(idx);
				}
	        });			
		}
		return resultArray;
	}
	
	this.findIndex = function(gridObj, appId) {
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			var idArr = [];			
	        $.each(gridList, function (idx, elem) {
        		//idArr.push(elem.appId);
	        });			
	        if( idArr.indexOf(appId) > -1 ) {
	        	//return true;
	        } else {
	        	//return false;
	        }
	        return 0;
		}
		return -1;
	}
	
	function addRowMatr2() {
		let newRow = {__index: undefined};
		matrGridView.addRow(newRow);
	}

	function addRow() {
		let param = {dindex: selectedRowKey};

		// 행이 없거나 셀렉트키가 없는 경우에는 새로운 행을 추가하고 종료
		if (bomGridView.list.length === 0 || typeof selectedRowKey === 'undefined') {
			let newRow = {__index: undefined, upperCd: "", lowerCd: "", partNo: "", unitNo: ""};
			bomGridView.addRow(newRow);
			return;
		}

		console.log('추가 인덱스 :', param.dindex);

		let lastRow = bomGridView.list[param.dindex];
		let newRow = $.extend({}, lastRow, {__index: undefined, upperCd: "", lowerCd: "", partNo: "", unitNo: ""});

		if (lastRow.matrDrwNo && !lastRow.partNo) {
			newRow.upperCd = lastRow.matrDrwNo;
			newRow.matrDrwNo ="";
			let maxPartNo = Math.max(...bomGridView.list.map(row => row.partNo ? parseInt(row.partNo) : 0), 0);
			newRow.partNo = String(maxPartNo + 1000);
			newRow.lowerCd = newRow.partNo;
			bomGridView.addRow(newRow, bomGridView.list.length);
			bomGridView.setValue(param.dindex, 'updcheck', bomGridView.list.length);
		}
		else if (lastRow.partNo && !lastRow.unitNo) {
			newRow.upperCd = lastRow.partNo;
			let maxUnitNo = Math.max(
					...bomGridView.list
							.filter(row => row.upperCd === lastRow.partNo)
							.map(row => row.unitNo ? parseInt(row.unitNo) : 0),
					0
			);
			newRow.unitNo = String(maxUnitNo + 100);
			newRow.lowerCd = newRow.unitNo;
			let partNoIndices = bomGridView.list
					.map((row, index) => row.partNo === lastRow.partNo ? index : -1)
					.filter(index => index !== -1)
					.reverse();

			let maxPartNoIndex = partNoIndices.length > 0 ? partNoIndices[0] : -1;

			if (maxPartNoIndex + 1 <= bomGridView.list.length) {
				bomGridView.addRow(newRow, maxPartNoIndex + 2);
			} else {
				bomGridView.addRow(newRow);
			}
			bomGridView.setValue(param.dindex, 'updcheck', partNoIndices+1);
		}



	}

	
	
	
	function adPer(str){
		if(typeof str == "undefined" || str == null || str == "") {
			return "";
		}
		return "-"+str ;
	}	

</script>