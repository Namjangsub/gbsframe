<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">구매BOM 등록</h4>
	</div>
	
	<div class="form-group popup_table">
		<form id="popForm" onSubmit="return false;">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
			<input type="hidden" id="pgmId" name="pgmId" value="SM0101P01">
			
			<table>
				<colgroup>
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="11%">
				</colgroup>
				
				<tr>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control" required="required" msg="회사" readonly="readonly">
							
						</select>
					</td>
					
					<th>수주번호</th>
					<td>
						<input type="text" id="ordrsNo" name="ordrsNo" class="form-control" required="required" msg="Sales Code" readonly="readonly">
					</td>
					
					<th>Sales Code</th>
					<td>
						<input type="text" id="salesCd" name="salesCd" class="form-control" required="required" msg="Sales Code" readonly="readonly">
					</td>

					<th>고객사</th>
					<td>
						<input type="text" id="clntNm" name="clntNm" class="form-control" msg="고객사" readonly="readonly">
					</td>
					
					<th>고객사PJT</th>
					<td>
						<input type="hidden" id="clntPjt" name="clntPjt" class="form-control" msg="고객사PJT" readonly="readonly">
						<input type="text" id="clntPjtNm" name="clntPjtNm" class="form-control" msg="고객사PJT" readonly="readonly">
					</td>
				</tr>
		
				<tr>
					<th style="height:26px">아이템구분</th>
					<td>
						<input type="text" id="itemDivNm" name="itemDivNm" class="form-control" msg="아이템구분" readonly="readonly">
					</td>
					
					<th>제품구분</th>
					<td colspan="3">
						<input type="text" id="prdtNm" name="prdtNm" class="form-control" msg="제품명" readonly="readonly">
					</td>

					<th>설비명</th>
					<td colspan="3">
						<input type="text" id="eqpNm" name="eqpNm" msg="설비명" class="form-control" readonly="readonly">
					</td>
				</tr>
			</table>
		</form>
		
		<!-- 콘텐츠 -->
		<div class="contents" style="margin-top: 10px;">
			<!-- 리스트 -->
			<div class="ax5_grid" style="width: 100%">
				<ul class="ul_list" style="width: 100%">
					<li style="width: 30%;">
						<div class="table_list_tit" style="width: 100%;">
							<h5 style="width:80px;color: #444;font-size: 16px;float:left; text-align:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">PART내역</h5>
							<!-- <div style="width:300px;float:left;margin-left:8px;margin-top:12px;text-align:left;color:#304a8a;">
								※ 명칭 ,수량은 붙여넣기 가능 합니다.
							</div>
							<div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
								<a data-onclick="initBomGrid()" onclick="initBomGrid()" style="width: 60px;" authchk> 초기화</a>
								<a data-onclick="addRowBomPopup()" onclick="addRowBomPopup()" style="" authchk>+</a>
								<a data-onclick="delRowBom()" onclick="delRowBom()" style="" authchk>-</a>
							</div> -->
						</div>
						<div>
							<div data-ax5grid="bom-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
						</div>
					</li>
					<li style="width: 69%; margin-left: 8px;">
						<div class="table_list_tit">
							<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;margin-right: 20px;">BOM 자재</h5>
							
							<!-- <div style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">
								<select id="matr_ordrgDiv20" style="color:gray;" name="matr_ordrgDiv20" data-kind="ORDRGDIV20" onchange="matrGridDataChange('ordrgDiv20','matr_ordrgDiv20');">
									<option value="">발주용도</option>
								</select>
							</div> -->

							<!-- <div style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">
								<select id="matr_ordrgDiv10" style="color:gray;" name="matr_ordrgDiv10" data-kind="ORDRGDIV10" onchange="matrGridDataChange('ordrgDiv10','matr_ordrgDiv10');">
									<option value="">발주유형</option>
								</select>
							</div> -->

<!-- 							<div class="search_form" style="width:140px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;"> -->
<!-- 								<input data-maxlength="300" style="height:25px;" type="text" id="matr_nextPrcsnNm" name="matr_nextPrcsnNm" placeholder="후행업체" -->
<!-- 								onkeyUp="if(window.event.keyCode == 13){matrGridDataChange('nextPrcsnNm','matr_nextPrcsnNm');}"> -->
<!-- 								<a data-onclick="openClntSearchDataChange('nextPrcsnNm','matr_nextPrcsnNm');" onclick="openClntSearchDataChange('nextPrcsnNm','matr_nextPrcsnNm');"><i class="i_search_w"></i></a> -->
<!-- 							</div> -->
							<div class="search_form" style="width:90px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
<!-- 								발주거래처명 -->
								<input data-maxlength="300" style="height:25px;" type="text" id="pchsClntNm_S" name="pchsClntNm_S" placeholder="발주거래처명">
							</div>
							<div class="search_form" style="width:90px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
<!-- 								발주담당자명 -->
								<input data-maxlength="300" style="height:25px;" type="text" id="mngNm_S" name="mngNm_S" placeholder="발주담당자명">
							</div>
							<div class="search_form" style="width:90px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
<!-- 								물품배송처  -->
								<input data-maxlength="300" style="height:25px;" type="text" id="matr_dlvplcNm" name="matr_dlvplcNm" placeholder="물품배송처">
<!-- 								onkeyUp="if(window.event.keyCode == 13){matrGridDataChange('dlvplcNm','matr_dlvplcNm');}"> -->
<!-- 								<a data-onclick="openClntSearchDataChange('dlvplcNm','matr_dlvplcNm');" onclick="openClntSearchDataChange('dlvplcNm','matr_dlvplcNm');"><i class="i_search_w"></i></a> -->
							</div>

							<div style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
								<input data-positive style="width:80px;height:25px;" type="text" id="matr_bomQty" name="matr_bomQty" placeholder="발주대상수량"
								onkeyUp="if(window.event.keyCode == 13){matrGridDataChange('bomQty','matr_bomQty');}">
							</div>

							<div style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 7px;">
								<input data-positive style="width:80px;height:25px;" type="text" id="matr_posQty" name="matr_posQty" placeholder="소요량"
								onkeyUp="if(window.event.keyCode == 13){matrGridDataChange('posQty','matr_posQty');}">
							</div>

							<div class="add_btn pdl10" style="float:right;margin-right:8px; margin-top: 8px;">
								<a data-onclick="openMatListSearchMulti()" onclick="openMatListSearchMulti()" style="width: 80px;" authchk><i class="fas fa-folder-plus"></i> 자재검색</a>
								<a data-onclick="updateBomMtrlSecondModal()" onclick="updateBomMtrlSecondModal()" style="width: 80px;" authchk><i class="fas fa-money-check"></i> 자재수정 </a>
								<a data-onclick="delRowMatr()" onclick="delRowMatr()" style="width: 50px;" authchk><i class="fas fa-trash"></i> 삭제 </a>
							</div>
						</div>
						<div>
							<div data-ax5grid="matr-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>
	
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.last().callback(); modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">

var thisGridRow = null; // 선택된 행 정보 저장할 변수
var thisGridCol = null; // 선택된 열 정보 저장할 변수

//"nextPrcsnNm",
ax5.ui.grid.formatter["popupGrid1"] = function () {
	var aHtml = "";
	aHtml += '<a style="background:url(/static/img/svg/search.svg) no-repeat 50% 50%;background-size:18px 18px;opacity:0.5;" ';
	aHtml += 'onclick="openClntSearchGrid(\'pchsClntNm\','+this.dindex+');" data-onclick="openClntSearchGrid(\'pchsClntNm\','+this.dindex+');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>';

	if(this.item.matrCd == undefined || this.item.matrCd === ''){ aHtml = "";}
    return aHtml;
};

//dlvplcNm
ax5.ui.grid.formatter["popupGrid2"] = function () {
	var aHtml = "";
	aHtml += '<a style="background:url(/static/img/svg/search.svg) no-repeat 50% 50%;background-size:18px 18px;opacity:0.5;" ';
	aHtml += 'onclick="openClntSearchGrid(\'dlvplcNm\','+this.dindex+');" data-onclick="openClntSearchGrid(\'dlvplcNm\','+this.dindex+');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>';

    return aHtml;
};

//openMatListSearch
ax5.ui.grid.formatter["popupGrid3"] = function () {
	var aHtml = "";
	aHtml += '<a style="background:url(/static/img/svg/search.svg) no-repeat 50% 50%;background-size:18px 18px;opacity:0.5;" ';
	aHtml += 'onclick="openMatListSearchGrid(\'matrCd\','+this.dindex+');" data-onclick="openMatListSearchGrid(\'matrCd\','+this.dindex+');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>';

	if(this.item.matrCd == undefined || this.item.matrCd === ''){ aHtml = "";}
    return aHtml;
};

ax5.ui.grid.formatter["useYn"] = function () {
	var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
	if(this.item.matrCd == undefined || this.item.matrCd === ''){ return ;}
	if (this.value == "E"){
		return '';
	} else {
		return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
	}
};

var bom_ckColumn = "lastDsgnNo,dsgnNm,dsgnBomQty,upperCd,lowerCd";
//선택자재 그리트 값변경
function matrGridDataChange(column, val_id) {
	var thisValue = $('[name="'+val_id+'"]').val();
	if(val_id == "matr_ordrgDiv20" || val_id == "matr_ordrgDiv10"){
		if(isEmpty(thisValue)){
			$('[name="'+val_id+'"]').css("color","gray");
		}
		else {
			$('[name="'+val_id+'"]').css("color","#444444");
		}
	}

	var selDataList = matrGridView.target.getList("selected");
	if(selDataList.length == 0) return;

	$.each($.extend({}, selDataList), function(idx, elem){
		if(isEmpty(elem.dtaChk)){
			elem.dtaChk = "";
		}
		matrGridView.target.setValue(elem.__index, column, thisValue);
    });
}

//그리드 거래처 검색
function openClntSearchGrid(column, rowIndex) {
	var __select__  =  getValue(matrGridView.target.list, rowIndex, "__selected__");
	if(__select__ == true){
		matrGridView.target.select(rowIndex);
	}

	var searchValue = getValue(matrGridView.target.list, rowIndex, column);
	openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: searchValue}, function (grid) {
		var row = grid.target.getList("selected")[0];
		var set_clntNm = row.clntNm;
		var set_clntCd = row.clntCd;
		matrGridView.target.setValue(rowIndex, "pchsClntCd", set_clntCd);
		matrGridView.target.setValue(rowIndex, column, set_clntNm);
	});
}

//그리드 자재품번 검색
function openMatListSearchGrid(column, rowIndex) {
	var __select__  =  getValue(matrGridView.target.list, rowIndex, "__selected__");
	if(__select__ == true){
		matrGridView.target.select(rowIndex);
	}

	var searchValue = getValue(matrGridView.target.list, rowIndex, column);
	var paramObj = {
		"coCd" : $('#coCd').val(),
		"searchValue" : searchValue
	}

// 	openSecondModal("/static/html/cmn/modal/matListSearch.html", 1200, 700, "자재 검색", paramObj, function (grid) {
	openSecondModal("/static/html/cmn/modal/matListSearchMulti.html", 1200, 700, "자재 검색", paramObj, function (grid) {
		var selData = matrGridView.target.getList("selected")[0];
// 		var gridRow = grid.target.getList("selected")[0];
		var gridRow = grid;
		
		gridRow.dtaChk = selData.dtaChk;
		gridRow.coCd = selData.coCd;
		gridRow.ordrsNo = selData.ordrsNo;
		gridRow.salesCd = selData.salesCd;
		gridRow.oldUpperCd = selData.oldUpperCd;
		gridRow.oldLowerCd = selData.oldLowerCd;
		gridRow.dsgnNo = selData.dsgnNo;
		gridRow.upperCd = selData.upperCd;
		gridRow.lowerCd = selData.lowerCd;
		gridRow.ordrgDiv20 = selData.ordrgDiv20;
		gridRow.ordrgDiv10 = selData.ordrgDiv10;
		gridRow.nextPrcsnNm = selData.nextPrcsnNm;
		gridRow.dlvplcNm = selData.dlvplcNm;
		gridRow.bomQty = selData.bomQty;
		gridRow.posQty = selData.posQty;
//		gridRow.pchsClntCd = selData.pchsClntCd;
		gridRow.pchsClntNm = selData.pchsClntNm;
		gridRow.matrSeq = selData.matrSeq;
		
		gridRow.__index = selData.__index;
		gridRow.__origin_index__ = selData.__origin_index__;
		gridRow.__modified__ = selData.__modified__;
		gridRow.__selected__ = selData.__selected__;
	
		gridRow.text = gridRow.matrNm;

		if(selData.dtaChk == "I"||selData.dtaChk == "D"){
			gridRow.dtaChk = selData.dtaChk;
		}else{
			gridRow.dtaChk = "U";
		}

    	$.each($.extend({}, gridRow), function (key, value) {
    		matrGridView.target.setValue(rowIndex, key, value);
    	});

	});
}

var actionType = null;

var firstGrid = null;
var secondGrid = null;

var matrArr = [];  //자재 데이타

var before_bomIdx = -1;
var before_dsgnNo = null;
var before_lowerCd = null;
var select_bomIdx = -1;
var select_dsgnNo = null;
var select_lowerCd = null;
var select_upperCd = null;

var bomGridView = {
	initView: function() {
		this.target = new ax5.ui.grid();
		this.target.setConfig({
			//frozenRowIndex:1,
			frozenColumnIndex : 3,
			showRowSelector   : false,
			multipleSelect    : true,
			sortable          : false, 
			target : $('[data-ax5grid="bom-grid"]'),
			header : {
				align: "center",
				selector: false
			},
			body: {
				//mergeCells : ["salesCd"],//editor 는 merge 안됨
				onClick: function () {
					thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
					thisGridRow = this.colIndex; // 선택된 열 정보 가져오기
					$.each($.extend({}, this.list), function(idx, obj) {
						bomGridView.target.select(obj.__index, {selected: false});//this.self.select 사용시 멀티선택됨
					});
					
					this.self.select(this.doindex);
					select_bomIdx = this.dindex;
					select_dsgnNo = this.item.dsgnNo;
					select_lowerCd = this.item.lowerCd;
					select_upperCd = this.item.upperCd;
					
					//원본데이타에서 화면데이터 제거 --> 화면데이타 put 원본데이타에.
					//2023.09.19 김성욱 수정 select_dsgnNo -> select_lowerCd
					//matrGridView.selectGrid(select_lowerCd);

					// 2023.10.17 김성욱 수정
					// matrGridView.selectGrid(select_dsgnNo);
					
					if (this.item.matGubun=="자재") select_lowerCd = select_upperCd;
					
					matrGridView.setData(select_lowerCd);
					// 2023.10.17 김성욱 수정 끝
				},
				onDBLClick: function () {
					thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
					thisGridRow = this.colIndex; // 선택된 열 정보 가져오기
					clearSelectMulti(bomGridView);
					this.self.select(this.dindex);
					//addRowBomPopup();
				},
				onDataChanged: function () {
					/* * 입력항목이 이전데이타와 같다면 저장체크(dtaChk) 지움
					* 데이타조회 initGridDataNullValue 사용 , 이전데이타 조회
					*/
					if(isSameValue(this.list , this.dindex, bom_ckColumn) == true) {
						this.item.__modified__ = false;
					}
					
					if(this.item.dtaChk != "I" && this.key != "dtaChk" && this.key != "__selected__" && this.item.__modified__) {
						this.item.dtaChk = "U";
					} else if(this.item.dtaChk != "I" && this.key != "dtaChk" && this.key != "__selected__") {
						this.item.dtaChk = "";
					}
					
					if(this.key == "dsgnBomQty" && this.value != "") {
						this.item.dsgnBomQty = Number(this.item.dsgnBomQty.replace(/[^0-9]/g,""));
					}
					this.self.repaint();
				}
			},
			columns : [
				//,hidden:true
				{key: "dtaChk"     , label: " "      , width: 30 , styleClass: "grid-font-blue-bold", hidden:true},
				{key: "fileTrgtKey", label: "Key"    , width: 50 , hidden:true},
				{key: "coCd"       , label: "CO"     , width: 50 , hidden:true},
				{key: "ordrsNo"    , label: "ordrsNo", width: 80 , hidden:true},
				{key: "salesCd"    , label: "salesCd", width: 120, hidden:true},
				{key: "lvl"        , label: "LVL"    , width: 30},
				{key: "text"       , label: "도번" 	 , width: 250, align: "left"  , treeControl: true},
				{key: "dsgnBomQty" , label: "수량"   , width: 40 , align: "right" , formatter: "money"},

				{key: "dsgnNm"    , label: "명칭" , align: "left"  , width: 220, hidden:true},
				{key: "matrMat"   , label: "소재/Maker" , align: "left"  , width: 100 },
				{key: "matrSpec"   , label: "형번/규격" , align: "left"  , width: 120 },
				{key: "matrMakrNm", label: "비고", align: "left"  , width: 80 },
				{key: "matrSpec"  , label: "규격" , align: "left"  , width: 80},

				{key: "lastDsgnNo",	label: "입력" ,		width: 50,	align: "left",hidden:true},
				{key: "upperCd",	label: "upperCd",	width: 160,	align: "left",hidden:true},
				{key: "lowerCd",	label: "lowerCd",	width: 180,	align: "left",hidden:true},
				{key: "oldUpperCd",	label: "oldUpperCd",width: 160,	align: "left",hidden:true},
				{key: "oldLowerCd",	label: "oldLowerCd",width: 180,	align: "left",hidden:true},
				{key: "matGubun"  , label: "자재구분", width: 80 , align: "left", hidden:true},
				{key: "collapse"  , label: "접기", width: 80 , align: "left", hidden:true},
				{key: "dsgnNo" , label: "도번" 	 , width: 330,align: "left" },
			],
// 			contextMenu: {
// 				iconWidth: 20,
// 				acceleratorWidth: 100,
// 				itemClickAndClose: false,
// 				icons: {
// 					'arrow': '<i class="fa fa-caret-right"></i>'
// 				},
// 				items: [
// 				    {type: 1, label: "붙여넣기"},
// 				    {divide: true},
// 				    {type: 2, label: "행추가"},
// 				    {type: 3, label: "행삭제"},
// 				],
// 				popupFilter: function (item, param) {
// 					if(param.element) {
// 						return true;
// 					} else {
// 						return item.type == 1;
// 					}
// 				},
// 				onClick: function (item, param) {
// 					thisTarget = bomGridView.target;
// 					thisGridRow = param.dindex;
// 					thisGridCol = param.colIndex;
// 					if (item.label == "붙여넣기") {
// 						gridPaste();
// 					} else if (item.label == "행추가") {
// 						clearSelectMulti(bomGridView);	//선택된 모든 row 선택 해제
// 						thisTarget.select(param.dindex);	//현재 클릭한 row 선택
// 						addRowBomPopup();
// 					} else if (item.label == "행삭제") {
// 						clearSelectMulti(bomGridView);	//선택된 모든 row 선택 해제
// 						thisTarget.select(param.dindex);	//현재 클릭한 row 선택
// 						delRowBom();
// 					}
// 					thisTarget.contextMenu.close();
// 					//또는 return true;
// 				}
// 			},// contextMenu
			tree: {
				use: true,
				indentWidth: 15,
				arrowWidth: 15,
				iconWidth: 18,
				icons: {
					openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
					collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
					collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
					itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
				},
				columnKeys: {
					parentKey: "upperCd",
					selfKey: "lowerCd",
				}
			}
		});
		return this;
	},
	setData: function(_pageNo) {
		var target = this.target;
		var formData = {
			"coCd" : $("#coCd").val(),
			"ordrsNo" : $("#ordrsNo").val(),
			"salesCd" : $("#salesCd").val()
		}
		postAjax("/user/sm/sm01/selectBuyBomList", formData, null, function(data) {
//			var list = initGridDataNullValue(data.resultList, target.columns, bom_ckColumn);
			//console.log("====list>>",list);
			var list = data.resultList;
			target.setData({
				list : list,
				page : {
					totalElements : list.length
				}
			});
			
			if(list.length > 0) {
				//bomGridView.target.clearSelect();
				//bomGridView.target.focus("HOME")
				bomGridView.target.select(0);
				bomGridView.target.focused = true;
				select_bomIdx = 0;
				before_bomIdx = 0;
				select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
				select_lowerCd = bomGridView.target.getList("selected")[0].lowerCd;
				before_dsgnNo = select_dsgnNo;
				before_lowerCd = select_lowerCd;

				//자재정보 조회
				matrGridView.setData(select_lowerCd);
				//matrGridView.setData("filter");
			}
		});
	} //setData
}

var matrGridView = {
	initView: function() {
		this.target = new ax5.ui.grid();
		this.target.setConfig({
			showRowSelector : true,
			multipleSelect  : true,
			sortable        : false,
			target          : $('[data-ax5grid="matr-grid"]'),
			header : {
				align    : "center",
				selector : true
			},
			body: {
				//mergeCells : ["coCd","salesCd", "dsgnNo", "upperCd","lowerCd","ordrgDiv10"],
				onClick: function () {
					$.each($.extend({}, this.list), function(idx, obj) {
						matrGridView.target.select(obj.__index, {selected: false});
					});
					this.self.select(this.dindex);
				},
				onDBLClick: function () {

					if (this.item.matrYn != "자재") {
						matrGridView.setData(this.item.treeLowerCd);
// 						bomGridView.target.clearSelect();
						var list = bomGridView.target.getList();
				    	$.each(list, function(idx, obj){
				    		bomGridView.target.select(obj.__index, {selected: false});
				        });
						bomGridView.target.select(this.doindex);
					} else {
						if(this.item.matrCd == undefined || this.item.matrCd === '') return;
						
						updateBomMtrlSecondModal();
					}
				},
				onDataChanged: function () {
					/* * 입력항목이 이전데이타와 같다면 저장체크(dtaChk) 지움
					* 데이타조회 initGridDataNullValue 사용 , 이전데이타 조회
					*/
					if(isSameValue(this.list , this.dindex, getViewColumnKey(matrGridView.target,["dtaChk"])) == true) {
						this.item.__modified__ = false;
					}
					
					if(this.item.dtaChk != "I" && this.key != "dtaChk" && this.key != "__selected__" && this.item.__modified__) {
						if(isEmpty(this.item.dtaChk)) {
							this.item.dtaChk = "U";
						}
					} else if (this.item.dtaChk != "I" && this.key != "dtaChk" && this.key != "__selected__") {
						this.item.dtaChk = "";
					}
					
					if(this.key == "bomQty" && this.value != "") {
						this.item.bomQty = Number(this.item.bomQty.replace(/[^0-9]/g,""));
					}
					
					if(this.key == "posQty" && this.value != "") {
						this.item.posQty = Number(this.item.posQty.replace(/[^0-9]/g,""));
					}
					
					if(this.item.matrCd == undefined || this.item.matrCd === ''){
						setClearValue(this.dindex);
					}
					
					this.self.repaint();
				},
			},
			columns : [
// 				{key: "lvl"        , label: "LVL"    , width: 30},
				{key: "text"      , label: "도번/품명" 	 , width: 250, align: "left"  , treeControl: true, styleClass: function () {return  (this.item.dtaChk == "D")? "grid-cell-orange":"";}},
				{key: "treeUpperCd"   , label: "상위코드"    , width: 60, align: "left", hidden:true},
				{key: "treeLowerCd"   , label: "하위코드"    , width: 60, align: "left", hidden:true},
				{key: "upperCd"   , label: "상위코드"    , width: 60, align: "left", hidden:true},
				{key: "lowerCd"   , label: "하위코드"    , width: 60, align: "left", hidden:true},
 				{key: "dtaChk"    , label: " "           , width: 30 , hidden:true},
				{key: "coCd"      , label: "CO"          , width: 50 , align: "center", hidden:true},
				{key: "ordrsNo"   , label: "ordrsNo"     , width: 80 , align: "center", hidden:true},
				{key: "salesCd"   , label: "salesCd"     , width: 120, align: "left"  , hidden:true},
				{key: "matrSeq"   , label: "자재순번"    , width: 70 , align: "center", hidden:true},
				{key: "oldUpperCd", label: "이전상위코드", width: 160, align: "left"  , hidden:true},
				{key: "oldLowerCd", label: "이전하위코드", width: 180, align: "left"  , hidden:true},
				{key: "matrYn"	  , label: "자재"    	, width: 35, align: "center", styleClass: function () {return  (this.item.dtaChk == "D")? "grid-cell-orange":"";}},
				{key: "pchsClntNm1"   , label: "최종구매업체"     , width: 80 , align: "left", styleClass: function () {return  (this.item.dtaChk == "D")? "grid-cell-orange":"";}},
				{key: "matrMat"   , label: "소재/Maker"    , width: 100, align: "center", styleClass: function () {return  (this.item.dtaChk == "D")? "grid-cell-orange":"";}},
				{key: "matrSpec"   , label: "형번/규격",  width: 120, align: "center", styleClass: function () {return  (this.item.dtaChk == "D")? "grid-cell-orange":"";}},
				{key: "matrSize"  , label: "크기"    , width: 80, align: "center", 
					editor:{type: "text",
						attributes: {'maxlength': 100,'data-maxlength': 100},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				{key: "pchsClntNm", label: "발주거래처명"    , width: 118, align: "left",
					editor : {
						type: "text",
						attributes: {'maxlength': 100,'data-maxlength': 300},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				{key: "mngNm", label: "담당자"    , width: 80, align: "left",
					editor : {
						type: "text",
						attributes: {'maxlength': 20,'data-maxlength': 20},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
// 				{key: "popupGrid1", label: " "     , width: 30 , align: "center", formatter: "popupGrid1"},
				{key: "dlvplcNm"  , label: "물품배송처", width: 118, align: "left",
					editor : {type: "text",
						attributes: {'maxlength': 100,'data-maxlength': 300},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				// {key: "popupGrid2", label: " "           , width: 30,	align: "center", formatter: "popupGrid2"},
				{key: "bomQty"    , label: "발주대상수량", width: 80 , align: "right" , 
					editor:{type: "number",
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				{key: "posQty"    , label: "소요량"      , width: 60 , align: "right" , 
					editor:{type: "number",
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				{key: "matrCd"    , label: "자재코드"    , width: 80 , align: "center"},
				{key: "popupGrid3", label: " "           , width: 30 , align: "center", formatter: "popupGrid3"},
				{key: "matrSpec"  , label: "비고"    , width: 100, align: "left",
					editor : {type: "text",
						attributes: {'maxlength': 300,'data-maxlength': 300},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				{key: "matrMakrNm", label: "제조사"  , width: 100, align: "center"},
				{key: "matrWt"    , label: "중량(kg)"    , width: 60, align: "right", formatter:"money", 
					editor:{type: "number",
						disabled : function () {
							return this.item.matrYn == "true";
						}
					}
				},
				{key: "matrUnit"  , label: "단위"    , width: 100, align: "center",
					editor: {type: "select",
						config: {
							columnKeys: {optionValue: 'value',optionText: 'text'},
							options: options_07
						},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					},
					formatter: function () {
						var result_text = "";
						var itemValue = this.item.matrUnit;
						$.each(options_07, function (idx, elem) {
							if(itemValue == elem.value) result_text = elem.text;
						});
						return result_text;
					}
				},
				{key: "matrNm"    , label: "자재명"      , width: 160, align: "left"},
// 				{key: "goodsDiv"  , label: "자재구분"    , width: 90 , align: "center",
// 					editor : {type: "select",
// 						config : {
// 							columnKeys : {optionValue: 'value',optionText: 'text'},
// 							options    : options_03
// 						},
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					},
// 					formatter : function () {
// 						var result_text = "";
// 						var itemValue = this.item.goodsDiv;
// 						$.each(options_03, function (idx, elem) {
// 							if(itemValue == elem.value) result_text = elem.text;
// 						});
// 						return result_text;
// 					}
// 				},
// 				{key: "matrClntDiv", label: "거래처구분", width: 120, align: "center",
// 					editor: {type: "select",
// 						config: {
// 							columnKeys: {optionValue: 'value',optionText: 'text'},
// 							options: options_04
// 						},
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					},
// 					formatter: function () {
// 						var result_text = "";
// 						var itemValue = this.item.matrClntDiv;
// 						$.each(options_04, function (idx, elem) {
// 							if(itemValue == elem.value) result_text = elem.text;
// 						});
// 						return result_text;
// 					}
// 				},
// 				{key: "matrDiv", label: "자재유형", width: 100, align: "center",
// 					editor: {type: "select",
// 						config: {
// 							columnKeys: {optionValue: 'value',optionText: 'text'},
// 							options: options_05
// 						},
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					},
// 					formatter: function () {
// 						var result_text = "";
// 						var itemValue = this.item.matrDiv;
// 						$.each(options_05, function (idx, elem) {
// 							if(itemValue == elem.value) result_text = elem.text;
// 						});
// 						return result_text;
// 					}
// 				},
// 				{key: "matrGrp", label: "자재그룹", width: 100, align: "center",
// 					editor: {type: "select",
// 						config: {
// 							columnKeys: {optionValue: 'value',optionText: 'text'},
// 							options: options_06
// 						},
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					},
// 					formatter: function () {
// 						var result_text = "";
// 						var itemValue = this.item.matrGrp;
// 						$.each(options_06, function (idx, elem) {
// 							if(itemValue == elem.value) result_text = elem.text;
// 						});
// 						return result_text;
// 					}
// 				},
				{key: "useYn"      , label: "사용여부"    , width: 70 , align: "center", formatter: "useYn"},
				{key: "matrStockCd", label: "재고관리"    , width: 70 , align: "center", formatter: "useYn"},
				{key: "originNm"   , label: "원산지"      , width: 100, align: "center"},
				{key: "matrDrwNo"  , label: "대표도면"    , width: 120, align: "center"},
				{key: "matrTestDiv", label: "입고검사구분", width: 100, align: "center",
					editor: {type: "select",
						config: {
							columnKeys: {optionValue: 'value',optionText: 'text'},
							options: options_08
						},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					},
					formatter: function () {
						var result_text = "";
						var itemValue = this.item.matrTestDiv;
						$.each(options_08, function (idx, elem) {
							if(itemValue == elem.value) result_text = elem.text;
						});
						return result_text;
					}
				},
				{key: "dlvrRqmDay" , label: "납품소요일자" , width: 100, align: "right", formatter:"money"},
				{key: "matrPurcDiv", label: "구매/외주구분", width: 100, align: "center",
					editor: {type: "select",
						config: {
							columnKeys: {optionValue: 'value',optionText: 'text'},
							options: options_09
						},
						disabled : function () {
							return this.item.matrYn == "true";
						}
					},
					formatter: function () {
						var result_text = "";
						var itemValue = this.item.matrPurcDiv;
						$.each(options_09, function (idx, elem) {
							if(itemValue == elem.value) result_text = elem.text;
						});
						return result_text;
					}
				},
				{key: "minOrdrgQty"   , label: "최소발주량"    , width: 100, align: "right" , formatter:"money"},
				{key: "matrSaftQty"   , label: "안전재고"      , width: 100, align: "right" , formatter:"money"},
				{key: "dsgn2dMd"      , label: "2D설계소요일"  , width: 100, align: "right" , formatter:"money"},
				{key: "avrg2dMd"      , label: "2D평균소요일"  , width: 100, align: "right" , formatter:"money"},
				{key: "dsgn3dMd"      , label: "3D설계소요일"  , width: 100, align: "right" , formatter:"money"},
				{key: "avrg3dMd"      , label: "3D평균소요일"  , width: 100, align: "right" , formatter:"money"},
				{key: "prdctnRqmMd"   , label: "생산소요일"    , width: 100, align: "right" , formatter:"money"},
				{key: "prdctnAvrgMd"  , label: "생산평균소요일", width: 100, align: "right" , formatter:"money"},
				{key: "matrPartNo"    , label: "파트번호"      , width: 100, align: "center"},
				{key: "pchsClntCd1"   , label: "구매업체1"     , width: 80 , align: "right" , hidden:true},
				{key: "pchsClntPct1"  , label: "발주비율1"     , width: 80 , align: "right"},
				{key: "pchsClntCd2"   , label: "구매업체2"     , width: 80 , align: "right" , hidden:true},
				{key: "pchsClntNm2"   , label: "구매업체1"     , width: 80 , align: "left"},
				{key: "pchsClntPct2"  , label: "발주비율2"     , width: 80 , align: "right"},
				{key: "pchsClntCd3"   , label: "구매업체3"     , width: 80 , align: "right" , hidden:true},
				{key: "pchsClntNm3"   , label: "구매업체1"     , width: 80 , align: "left"},
				{key: "pchsClntPct3"  , label: "발주비율3"     , width: 80 , align: "right"},
				{key: "matrUpr"       , label: "최종구매단가"  , width: 100, align: "right" , formatter: "money"},
				{key: "matrAvrgUpr"   , label: "평균구매단가"  , width: 100, align: "right" , formatter: "money"},
				{key: "matrRmk"       , label: "비고"          , width: 150, align: "left"},
				{key: "matrLastTrstDt", label: "최종거래일자"  , width: 100, align: "center",
// 					editor: {type: "date",
// 						config: { content: { config: { mode: "day", selectMode: "day" } } },
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					}
				},
				{key: "matrAtntCd", label: "대체자재코드", width: 100, align: "center",
// 					editor: {
// 						type: "text",
// 						attributes: {'maxlength': 20},
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					}
				},
				{key: "matrNo", label: "자재번호", width: 100, align: "center",
// 					editor: {
// 						type: "text",
// 						attributes: {'maxlength': 20},
// 						disabled : function () {
// 							return this.item.matrYn == "true";
// 						}
// 					}
				},
				{key: "upperNm"   , label: "상위"  , width: 80 , align: "left", hidden:true},
				{key: "lowerNm"   , label: "하위"  , width: 80 , align: "left", hidden:true},
				{key: "avlbStrtDt", label: "FROM"  , width: 80 , align: "left", hidden:true},
				{key: "avlbEndDt" , label: "TO"    , width: 80 , align: "left", hidden:true},
				{key: "partNo"    , label: "PART"  , width: 80 , align: "left", hidden:true},
				{key: "unitNo"    , label: "UNIT"  , width: 80 , align: "left", hidden:true},
				{key: "revNo"     , label: "리버전", width: 80 , align: "left", hidden:true},
				{key: "dsgnNo"    , label: "도번" , width: 160, align: "left" },
			],
			tree: {
				use: true,
				indentWidth: 15,
				arrowWidth: 15,
				iconWidth: 18,
				icons: {
					openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
					collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
					collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
					itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
				},
				columnKeys: {
					parentKey: "treeUpperCd",
					selfKey: "treeLowerCd",
				}
			}
		});
		return this;
	},
	selectGrid : function(click_dsgnNo) {
// 		if(before_bomIdx == select_bomIdx) return; //선택행 변경없을때 사용안함.
		
// 		//2023.09.19 김성욱 수정 select_dsgnNo -> select_lowerCd
// 		var delIdxArray = findIndexArray(matrArr, "dsgnNo", before_dsgnNo);
// 		//var delIdxArray = findIndexArray(matrArr, "upperCd", click_dsgnNo);
		
// 		var af_gridList = this.target.getList();
// 		if(af_gridList.length > 0) {
// 			$.each(af_gridList, function (idx, elem) {
// 				matrArr.push(elem);
// 			});
// 		}
		
// 		//행삭제는 index가 변경되므로 아래에서 삭제
// 		for(var i=delIdxArray.length-1; i >= 0; i--) {
// 			matrArr.splice(delIdxArray[i],1);
// 		}
		
// 		//var target = this.target;
// 		var list = getFilterData_dsgnNo(click_dsgnNo);
// 		this.target.setData({
// 			list : list,
// 			page : {
// 				totalElements : list.length
// 			}
// 		});
	},
	setData: function(select_lowerCd) {
		var bom_selList = bomGridView.target.getList("selected");
		var sel_dsgnNo = "";

		var target = this.target;
		if(select_upperCd == null || select_upperCd == "") {
			select_upperCd = "top";
		}
		var formData = {
			"coCd"    : $("#coCd").val(),
			"ordrsNo" : $("#ordrsNo").val(),
			"salesCd" : $("#salesCd").val(),
			"upperCd" : select_upperCd,
			"lowerCd" : select_lowerCd
		}

		postAjax("/user/sm/sm01/selectBomMatrList", formData, null, function(data) {
//			matrArr = initGridDataNullValue(data.resultList, target.columns, getViewColumnKey(matrGridView.target,["dtaChk"]));

			var list = data.resultList;
//			var list = matrArr;
			
			target.setData({
				list : list,
				page : {
					totalElements : list.length
				}
			});
		});
	}
}

 	$(document).ready(function() {
		setComboOptions($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		/*
		$("#salesCd").val(modalStack.last().paramObj.salesCd);
		$("#clntNm").val(modalStack.last().paramObj.clntNm);
		$("#clntPjt").val(modalStack.last().paramObj.clntPjt);
		$("#itemDivNm").val(modalStack.last().paramObj.itemDivNm);
		$("#eqpNm").val(modalStack.last().paramObj.eqpNm);
		$("#prdtNm").val(modalStack.last().paramObj.prdtNm);
		*/
		let loadData = {
			"ordrsNo" : modalStack.last().paramObj.ordrsNo,
			"salesCd" : modalStack.last().paramObj.salesCd,
			"clntNm" : modalStack.last().paramObj.clntNm,
			"clntPjt" : modalStack.last().paramObj.clntPjt,
			"clntPjtNm" : modalStack.last().paramObj.clntPjtNm,
			"itemDivNm" : modalStack.last().paramObj.itemDivNm,
			"eqpNm" : modalStack.last().paramObj.eqpNm,
			"prdtNm" : modalStack.last().paramObj.prdtNm,
		}
		loadFormData("#popForm", loadData);
		initLoadForm(".table_list_tit");

		$("#userId").val(jwt.userId);
		$("#mngNm_S").val(jwt.userNm);

		//$('#ordrsPlanAmt, #ordrsAmt').on('keyup', ordRemCal);

		actionType = modalStack.last().paramObj.actionType;

		/**
		 * grid 초기화
		*/
		bomGridView.initView();
		matrGridView.initView();

		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertBomMatr();
			});
			//등록시 ROOT 데이타 생성
			var newRow = {};
			newRow = {dtaChk:"I",coCd: $("#coCd").val(), ordrsNo: $("#ordrsNo").val(), salesCd: $("#salesCd").val() , lvl:0, dsgnNo:$("#salesCd").val(), upperCd:"top", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			//bomGridView.target.clearSelect();
			bomGridView.target.select(0);
			bomGridView.target.focused = true;
		} else if (actionType == "U") {
			$('.tit').text('구매BOM 수정')

			bomGridView.setData(0);

			matrGridView.setData(0);

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateBomMatr();
			});
		}

		var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		 $("#fileTrgtKey").val(param_fileTrgtKey);
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey	: param_fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

	    // Ctrl + V 단축키 이벤트 처리
		bomGridView.target.$target.on("paste", function (e, a) {
			gridPaste();
		});

		authChk();// 권한체크

	});

	// //초기화
	// function initBomGrid(){
	// 	if (actionType == "C") {
	// 		bomGridView.initView();
	// 		matrGridView.initView();
	// 		var newRow = {};
	// 		newRow = {dtaChk:"I",coCd: $("#coCd").val(), ordrsNo: $("#ordrsNo").val(), salesCd: $("#salesCd").val() , lvl:0, dsgnNo:$("#salesCd").val(), upperCd:"top", lowerCd:$("#salesCd").val()};
	// 		bomGridView.target.addRow($.extend({}, newRow), "last");
	// 		bomGridView.target.select(0);
	// 		bomGridView.target.focused = true;
	// 	}
	// 	else {
	// 		bomGridView.setData(0);
	// 	}
	// }

	// 등록
	function insertBomMatr() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			setFormLock(".popup_area");
			filePostAjax("/user/sm/sm01/insertBom", formData, function(data) {
				if (data.resultCode == 200) {
					gridView.setData(main_pageNo,true);
// 					modalStack.close();
				} else {
					alert(data.resultMessage);
				}
			});
		}
	}

	// 수정
	function updateBomMatr() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 formData를 생성
//			setFormLock(".popup_area");
	      	filePostAjax("/user/sm/sm01/updateBom", formData,function(data) {
				if (data.resultCode == 200) {
					matrGridView.setData(select_lowerCd);
//					modalStack.close();
				} else {
					alert(data.resultMessage);
				}
			});
		}
	}

	//----------------------------------------------//
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = getFormData("#popForm");
		//--var formData = new FormData($("#popForm")[0]);

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		//현재 자재정보 그리드정보를 matrArr에  update 한다
		var matrGridList = matrGridView.target.list;
		var matrArrList = [];
		
		if(matrGridList.length > 0){
			$.each(matrGridList, function (idx, elem) {
				matrArrList.push(elem);
			});
		}

 		$.each(matrArrList,function(idx, obj) {
 			if(isEmpty(obj.dtaChk)){
 				obj.dtaChk = "";
 			}
 		});
 		
		formData.append("matrArr", JSON.stringify(matrArrList));
		//세부 아이템 자료 끝
		return formData;
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	// //구매Bom 추가수정팝업
	// function addRowBomPopup() {
	// 	var selData = bomGridView.target.getList("selected")[0];
	// 	var isBomSelect = !isEmpty(selData);
	// 	if(bomGridView.target.list.length != 0 && isBomSelect == false){
	// 		alert("구매 BOM 행추가시 상위목록을 선택하여야 합니다.");
	// 		return;
	// 	}
	// 	if(selData.dtaChk == "D"){
	// 		alert("선택된 행은 삭제 대기 상태 입니다.");
	// 		return;
	// 	}
	// 	var targetLevel = Number(selData.lvl)+1;
	// 	let bom_List = JSON.parse(JSON.stringify(bomGridView.target.list));
	// 	let bom_Arr = getTreeBomData(bom_List);
	// 	//console.log("====bom_Arr>>>",bom_Arr);
	// 	let sendLowData = getFilterLevelData(bom_Arr, targetLevel, selData.lowerCd);
	// 	var paramObj = {};
	// 	paramObj.coCd = selData.coCd;
	// 	paramObj.ordrsNo = selData.ordrsNo;
	// 	paramObj.salesCd = selData.salesCd;
	// 	paramObj.upperCd = selData.lowerCd;
	// 	paramObj.lvl = targetLevel;
	// 	paramObj.sendLowData = JSON.stringify(sendLowData);
	// 	paramObj.sendSelectData = JSON.stringify(selData);
	// 	openSecondModal("/static/html/user/sm/sm01/SM0101P04.html", 830, 750, "", paramObj, function (data) {
	// 		//현재 Row 데이타 명칭,수량 수정  data.selectBom   data.selectBom.dtaChk == "U"||data.selectBom.dtaChk == "I"
	// 		if(!isEmpty(data.selectBom.dtaChk)){
	// 			let select_bom =  data.selectBom;
	// 			bomGridView.target.updateRow($.extend({}, bomGridView.target.list[selData.__index], select_bom), selData.__index);
	// 		}

	// 		//collbackData 의 bom_index 로 데이타 update data.lvlBomList __children__  __children__ : []
	// 		if(data.lvlBomList) {
	// 			let lvl_bom_list = data.lvlBomList;

	// 			$.each(lvl_bom_list,function(idx, elem) {
	// 				//console.log("====elem>>",elem);
	// 				if(elem.dtaChk == "I" && isEmpty(elem.bom_index)) {
	// 					bomGridView.target.addRow($.extend({}, elem), "last"); //행추가- 위치는 Tree로 정렬
	// 					clearSelectMulti(bomGridView);
	// 				}
	// 				else if( (elem.dtaChk == "I" && !isEmpty(elem.bom_index)) || elem.dtaChk == "U" || elem.dtaChk == "D") {
	// 					//하위도번 변경 해당행의 lowerCd를 upperCd로 사용하는 행이 있다면 교체한다.
	// 					let bom_Arr = getTreeBomData(bomGridView.target.list);
	// 					var lowIndexArray = findLowerArray(bom_Arr, elem.before_lowerCd,"upperCd","lowerCd");//현재행으로 변경전값으로 before_lowerCd 검색
	// 					//console.log("====lowIndexArray>>",lowIndexArray);
	// 					for(var iidx = 0; iidx<lowIndexArray.length; iidx++) {
	// 						//도번 변경 && 삭제가 아닐때 하위도번변경
	// 						//console.log("===============>>>5-2-0", (elem.dtaChk != "D"));
	// 						var _index = Number(lowIndexArray[iidx]);
	// 						var low_elem = bom_Arr[_index];
	// 						var before_lowerCd = elem.before_lowerCd;
	// 						var sel_lowerCd = low_elem.lowerCd;
	// 						var to_lowerCd = elem.lowerCd;
	// 						var set_upperCd = low_elem.upperCd.replace(before_lowerCd,to_lowerCd);
	// 						var set_lowerCd = low_elem.lowerCd.replace(before_lowerCd,to_lowerCd);
	// 						if(before_lowerCd != to_lowerCd && elem.dtaChk != "D") {

	// 							matrArrChange(sel_lowerCd, set_lowerCd, set_upperCd); //자재데이타 변경

	// 							bomGridView.target.setValue(_index, "upperCd", set_upperCd);
	// 							bomGridView.target.setValue(_index, "lowerCd", set_lowerCd);
	// 							bomGridView.target.setValue(_index, "dsgnNo" , set_lowerCd);

	// 							//bomGridView.target.setValue(_index, "dtaChk" , "U");
	// 						}

	// 						if(elem.dtaChk == "D"){//삭제시 하위 모두 삭제
	// 							bomGridView.target.setValue(_index, "dtaChk" , "D");
	// 						}
	// 					}
	// 					//도번,입력도번 도변경필요
	// 					var _lowerCd = elem.lowerCd;
	// 					var _lastDsgnNo = _lowerCd.substring(_lowerCd.lastIndexOf('-')+1,_lowerCd.length);

	// 					var real_elem = bom_Arr[elem.bom_index];
	// 					var selLvl_lowerCd = real_elem.lowerCd;

	// 					matrArrChange(selLvl_lowerCd, elem.lowerCd, real_elem.upperCd); //자재데이타 변경

	// 					//updateRow 로 반영시 화면에 반영안됨.
	// 					//bomGridView.target.updateRow($.extend({}, bomGridView.target.list[elem.bom_index], elem), elem.bom_index);
	// 					bomGridView.target.setValue(elem.bom_index, "dsgnNm", elem.dsgnNm);
	// 					bomGridView.target.setValue(elem.bom_index, "dsgnBomQty", elem.dsgnBomQty);

	// 					bomGridView.target.setValue(elem.bom_index, "lowerCd", elem.lowerCd);
	// 					bomGridView.target.setValue(elem.bom_index, "lastDsgnNo", _lastDsgnNo);
	// 					bomGridView.target.setValue(elem.bom_index, "dsgnNo", elem.lowerCd);

	// 					if(elem.dtaChk == "D"){
	// 						bomGridView.target.setValue(elem.bom_index, "dtaChk" , elem.dtaChk);
	// 					}
	// 				}
	// 			});

	// 			//matrArr 에 lowerCd --> lowerCd 는 후처리로 변경 //임시로 dsgnNo 에 저장 lowerCd 반영
	// 			$.each(matrArr,function(idx, elem) {
	// 				matrArr[idx].lowerCd = matrArr[idx].dsgnNo;
	// 			});

	// 			let delInputRowArr = data.delInputRowIndexArr;
	// 			//오름차순으로
	// 			delInputRowArr.sort(function(a, b) {
	// 				  return b - a; //오름차순  //return a - b; //내림차순
	// 			});

	// 			for(var i=0;i<delInputRowArr.length;i++){
	// 				var del_Index = delInputRowArr[i];
	// 				bomGridView.target.removeRow(del_Index);
	// 			}

	// 			//bomGridView.target.repaint();
	// 		}//if
	// 		//clearSelectMulti(bomGridView);

	// 		bomGridView.target.select(selData.__index, {selected: true});
	// 	});//openSecondModal
	// }

	//자재그리드의 자재 데이타 (matrArr) 에서  upperCd, dsgnNo 변경  --> lowerCd 는 후처리로 변경
	this.matrArrChange = function(sel_lowerCd, to_lowerCd, to_upperCd){
		var idxArray = findIndexArray(matrArr, "lowerCd", sel_lowerCd);
		$.each(idxArray, function (idx, row) {
			let _index = Number(row);
			//console.log("====idxArray>>_index>>",_index);
			matrArr[_index].upperCd = to_upperCd;
			matrArr[_index].dsgnNo = to_lowerCd; //임시로 dsgnNo 에 저장 lowerCd는 변경안함.
			if(matrArr[_index].dtaChk != "I") {
				matrArr[_index].dtaChk = "U";
			}
		});
	}

	this.getFilterLevelData = function(obj, sel_lvl, sel_upperCd) {
		const resultData = obj.filter(function(element){
			return sel_lvl == element.lvl && sel_upperCd == element.upperCd;
		});
		return resultData;
	}
	//그리드가 트리일경우 사용
	function getTreeBomData(bom_list) {
		var resultBomArr = [];
		var bom_index = 0;
		$.each(bom_list, function (idx, elem) {
			if(isEmpty(elem.dtaChk)){
				elem.dtaChk = "";
			}
			var bomData = {};
			bomData.dtaChk = elem.dtaChk;
			bomData.lvl = elem.lvl;
			bomData.fileTrgtKey = elem.fileTrgtKey;
			bomData.coCd = elem.coCd;
			bomData.ordrsNo = elem.ordrsNo;
			bomData.salesCd = elem.salesCd;
			bomData.dsgnNo = elem.dsgnNo;
			bomData.lastDsgnNo = elem.lastDsgnNo;
			bomData.dsgnNm = elem.dsgnNm;
			bomData.dsgnBomQty = elem.dsgnBomQty;
			bomData.upperCd = elem.upperCd;
			bomData.lowerCd = elem.lowerCd;
			bomData.before_lowerCd = elem.lowerCd; //하위를 찾기위한 변경전 lowerCd
			bomData.bom_index = bom_index++;

			resultBomArr.push(bomData);
		});

		return resultBomArr;
	}

	// //Bom 삭제
	// function delRowBom() {
	// 	if(selectGridValidation(bomGridView.target)) return;
	// 	var selData = bomGridView.target.getList("selected")[0];
	// 	var isBomSelect = !isEmpty(selData);
	// 	//하위레벨의 데이타 유무 체크
	// 	let bom_Arr = getTreeBomData(bomGridView.target.list);
	// 	var lowIndexArray = findLowerArray(bom_Arr, selData.lowerCd,"upperCd","lowerCd");
	// 	var bomDtaChk = selData.dtaChk;

	// 	if(bomDtaChk == "D"){
	// 		alert("이미 삭제 예약된 BOM 입니다.");
	// 		return;
	// 	}

	// 	if(selData.lvl == 0){
	// 		if(checkMatrGridCrud(matrGridView.target)) return;
	// 		if(!confirm("최상위는 삭제 할 수 없습니다. 하위레벨 모두를 삭제하시겠습니까?")) return;
	// 		if(lowIndexArray.length > 0) {
	// 			setFormLock(".popup_area", true , function () {
	// 				deleteRowIndexArray(bomGridView.target, lowIndexArray);
	// 				setFormUnLock(".popup_area" , true);
	// 			});
	// 		}
	// 		return;
	// 	}
	// 	else {
	// 		if(checkMatrGridCrud(matrGridView.target)) return;
	// 	}

	// 	if(lowIndexArray.length > 0) {
	// 		if(!confirm("하위레벨이 있습니다. 모두를 삭제하시겠습니까?")) return;
	// 		setFormLock(".popup_area", true , function () {
	// 			deleteRowIndexArray(bomGridView.target, lowIndexArray);
	// 			setFormUnLock(".popup_area" , true);
	// 		});
	// 	}

	// 	if(bomDtaChk == "I"){
	// 		bomGridView.target.removeRow(selData.__index);
	// 	}
	// 	else {
	// 		bomGridView.target.setValue(selData.__index, "dtaChk", "D");
	// 	}
	// }

	this.deleteCrudMatr = function (_dsgnNo) {
		for(var i=matrArr.length-1; i >= 0; i--){
			var elem = matrArr[i];
			if((elem.dtaChk == "D" || elem.dtaChk == "U") && elem.dsgnNo == _dsgnNo) {
				elem.dtaChk = "";
			}
		}
	}

	this.findArrayPush = function (_array, _dsgnNo) {
		$.each($.extend({}, matrArr), function (idx, elem) {
			if(elem.dtaChk == "I" && elem.dsgnNo == _dsgnNo) {
				_array.push(idx);
			}
		});
	}

	//구매Bom 그리드의 하위를 삭제한다.
	this.deleteRowIndexArray = function(gridObj, low_indexArray) {
		var list = gridObj.getList();
		var delMatrIndexArray = [];
		for(var i=low_indexArray.length-1; i >= 0; i--){
			var _index = Number(low_indexArray[i]);
			//구매Bom 삭제처리 전에 [matrArr] 자재의 D,U는 상태제거 , I는 row 삭제 dsgnNo
			var _dsgnNo = list[_index].dsgnNo;
			//자재의 D,U는 상태제거
			deleteCrudMatr(_dsgnNo);
			findArrayPush(delMatrIndexArray,_dsgnNo);//I는 row 삭제 dsgnNo

			if(list[_index].dtaChk == "I"){
				gridObj.removeRow(_index);
			}
			else {
				gridObj.setValue(_index, "dtaChk", "D");
			}
		}

		//오름차순으로
		delMatrIndexArray.sort(function(a, b) {
			  return b - a;
		});
		for(var i=0;i<delMatrIndexArray.length;i++){
			var index = Number(delMatrIndexArray[i]);
			matrArr.splice(index,1);
		}
	}

	//작업중인 자재정보가 있습니다. 삭제 하시겠습니까?
	this.checkMatrGridCrud = function(gridObj){
		var gridList = gridObj.getList();
		var isDataCrud = false;
		for(var i=gridList.length-1; i >= 0; i--){
			var elem = gridList[i];
			var _dtaChk = elem["dtaChk"];
			if(_dtaChk == "I"||_dtaChk == "U"||_dtaChk == "D"){
				isDataCrud = true;
				break;
			}
		}
		if(isDataCrud) {
			if(!confirm("작업중인 자재정보가 있습니다. 삭제 하시겠습니까?")) {
				return true;
			} else {
				//구매Bom 삭제처리 전에 ==matrGridView 자재의 D,U는 상태제거 , I는 row 삭제
				for(var i=gridList.length-1; i >= 0; i--){
					var elem = gridList[i];
					if(elem.upperCd != "top") { //레벨 0의 자재는 변경하지 않는다.
						if(elem.dtaChk == "D"||elem.dtaChk == "U") {
							gridObj.setValue(i, "dtaChk", ""); //구매Bom 삭제전 모든자재 삭제됨.
						}
						if(elem.dtaChk == "I"){
							gridObj.removeRow(i);
						}
					}
				}
				return false;
			}
		}
		return false;
	}

	//선택+하위계층중 입력,수정중인  matrArr 에서 삭제

	//자재추가 - 사용안함.
	this.addRowMatr = function() {
		var bomData = bomGridView.target.getList("selected")[0];
		var isBomSelect = !isEmpty(bomData);
		var matrLength = matrGridView.target.list.length;
		let newRow = {};
		newRow = { dtaChk:"I"
			, coCd: bomData.coCd
			, ordrsNo: bomData.ordrsNo
			, salesCd: bomData.salesCd
			, dsgnNo: bomData.dsgnNo
			, upperCd: bomData.upperCd
			, lowerCd: bomData.lowerCd
			, matrSeq: matrLength+1
		};

		matrGridView.target.addRow($.extend({}, newRow), "last");
	}

	//자재품번 검색
	function openMatListSearchMulti() {
		var bomData = bomGridView.target.getList("selected")[0];
// 		var bomData = matrGridView.target.list[0];
		var matrLength = matrGridView.target.list.length;
		var tempSearchValue ="";
		if (bomData) {
			if (bomData.matrMno) { tempSearchValue = bomData.matrMno == "-" ? "" : bomData.matrMno; }  //형번 "BYGS10100-45H" 
			else if (bomData.matrMat) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (bomData.matrMat == "-") ? "" : bomData.matrMat;}  //소재 "SMC/부경금속"
			else if (bomData.matrSpec) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (bomData.matrSpec == "-") ? "" : bomData.matrSpec;}  //규격
			else if (bomData.matrNm) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (bomData.matrNm == "-") ? "" : bomData.matrNm;}  //자재명 "손잡이"
		}
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"searchValue" : tempSearchValue.replace(/ /g, '')
		}

		openSecondModal("/static/html/cmn/modal/matListSearchMulti.html", 1200, 700, "자재 검색", paramObj, function (dataList) {
	        $.each($.extend({}, dataList), function (idx, elem) {
	        	var row_index = Number(idx);
				var newRow = elem;

				var vmatr_bomQty = null;
				if($('#matr_bomQty').val() == '') {
					vmatr_bomQty = bomData.dsgnBomQty;
				} else {
					vmatr_bomQty = $('#matr_bomQty').val();
				}

				var vmatr_posQty = null;
				if($('#matr_posQty').val() == '') {
					vmatr_posQty = bomData.dsgnBomQty;
				} else {
					vmatr_posQty = $('#matr_posQty').val();
				}

				newRow.dtaChk = "I";
				newRow.matrYn = "자재";
				newRow.coCd = bomData.coCd;
				newRow.ordrsNo = bomData.ordrsNo;
				newRow.salesCd = bomData.salesCd;
				newRow.dsgnNo = bomData.path.replaceAll(" > ", "-");
				newRow.partNo = bomData.partNo;
				newRow.unitNo = bomData.unitNo;
				newRow.dsgnNm = bomData.dsgnNm;
				newRow.text = newRow.matrNm;
				
				// newRow.upperCd = bomData.upperCd;
				// newRow.lowerCd = bomData.lowerCd;
				newRow.upperCd = bomData.lowerCd;
				newRow.lowerCd = '.';
				newRow.ordrgDiv10 = $('#matr_ordrgDiv10').val();
				newRow.ordrgDiv20 = $('#matr_ordrgDiv20').val();
				
				//1. 자재마스터에 등록된 관리담당자명을 발주담당자명에 저장 
				if (newRow.matrMngIdNm != undefined || newRow.matrMngIdNm != "") {
					newRow.mngNm = newRow.matrMngIdNm;
				}
				//제조사가 SMC인경우 발주담당자는 성진주과장이면 구매업체는 대영유공압
				if (newRow.matrMat) {
					if (newRow.matrMat.indexOf('SMC') !== -1) {
						newRow.mngNm = "성진주";
						newRow.pchsClntNm = "대영유공압";
					}
				}
				//발주담당자, 구매업체, 배송업체가 비어 있으면 대표입력내용으로 교체
				if (newRow.pchsClntNm==undefined || newRow.pchsClntNm=="") newRow.pchsClntNm = $('#pchsClntNm_S').val();
				if (newRow.mngNm==undefined || newRow.mngNm=="") newRow.mngNm = $('#mngNm_S').val();
				if (newRow.dlvplcNm==undefined || newRow.dlvplcNm=="") newRow.dlvplcNm = $('#matr_dlvplcNm').val();
				// newRow.bomQty = $('#matr_bomQty').val();
				// newRow.posQty = $('#matr_posQty').val();
				newRow.bomQty = vmatr_bomQty;
				newRow.posQty = vmatr_posQty;
				newRow.matrSeq = matrLength+(row_index+1);
				matrGridView.target.addRow($.extend({}, newRow), "last", {focus: "END"});
	        });
		});
	}

	//자재삭제
	this.delRowMatr = function() {

		if(selectGridValidationM(matrGridView.target)) return;
		
		var selDataList = matrGridView.target.getList("selected");
		
		//ax5Grid.deleteRow("selected"); 사용시 삭제이력 ax5Grid.getList("deleted");
		for(var i=selDataList.length-1; i >= 0; i--) {
			var selData = selDataList[i];
			var matrDtaChk = selData.dtaChk;
			if(selData.matrCd == undefined || selData.matrCd == ''){
				//설계BOM에서 넘어온경우에는 삭제 안됨
// 				matrGridView.target.setValue(selData.__origin_index__, "dtaChk", "");
			} else {
				if(matrDtaChk == "I") {
					matrGridView.target.removeRow(selData.__index);
				} else {
					if(matrDtaChk == "D") {
						matrGridView.target.setValue(selData.__origin_index__, "dtaChk", "");
					}else{
						matrGridView.target.setValue(selData.__origin_index__, "dtaChk", "D");
					}
				}
				//자재인경우만 처리
			}
		}
	}

	//자재데이타에 필터적용
	this.getFilterData_dsgnNo = function(sel_dsgnNo) {
		const resultData = matrArr.filter(function(element){
			return sel_dsgnNo == element.dsgnNo;
		});
		return resultData;
	}

	//Bom-자재 수정
	function updateBomMtrlSecondModal() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		if(selData.matrCd == undefined || selData.matrCd === '') return;
		if(selData.dtaChk == "D" || selData.dtaChk == "I") return;
		
		var paramObj = selData;
        var fileTrgtKey = selData.fileTrgtKey;
        paramObj.actionType = "U";
        paramObj.sendLowData = JSON.stringify(selData);
        openSecondModal("/static/html/user/sm/sm01/SM0101P02.html", 1300, 550, "", paramObj, function(data) {
        	//matrGridView.target.updateRow($.extend({}, matrGridView.target.list[selData.__index], data), selData.__index);
        	$.each($.extend({}, data), function (key, value) {
        		matrGridView.target.setValue(selData.__origin_index__, key, value);
        	});
        	//if(isEmpty(selData.dtaChk)) {
	        //	matrGridView.target.setValue(selData.__index, "dtaChk", "U");
        	//}
		});
	}

	// 거래처 검색
	function openClntSearchDataChange(col_id, val_id) {
		var thisValue = $('[name="'+val_id+'"]').val();
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: thisValue}, function (grid) {
			var row = grid.target.getList("selected")[0];
			//$('#outClntCd').val(row.clntCd);
			$('[name="'+val_id+'"]').val(row.clntNm);

			matrGridDataChange(col_id,val_id);
		});
	}

	this.gridPaste = function() {
		var pasteData = "";
		var this_target = bomGridView.target;

		navigator.clipboard.readText().then(pasteData => {
			//console.log('클립보드에 저장된 값:', pasteData);
			if (isEmpty(pasteData)) {
				return;
			}

			// 붙여넣기할 데이터를 배열로 변환한다.
			pasteData = (pasteData.charAt(pasteData.length - 1) === "\n") ? pasteData : pasteData + "\n";
			var pasteRows = pasteData.split("\n").map(function(row) {
			  	return row.split("\t");
			});

			if(isEmpty(thisGridRow)) thisGridRow = 0;
			if(isEmpty(thisGridCol)) thisGridCol = 0;

			// 붙여넣기를 시작할 셀의 인덱스를 구한다.
			var startRowIndex = thisGridRow;
			var startColIndex = thisGridCol;

			// 붙여넣을 데이터의 행과 열 개수를 구한다.
			var numRows = pasteRows.length;
			var numCols = pasteRows[0].length;

			var gridLength = this_target.getList().length;
			var viewColumnsKey = getViewColumnKey(this_target); //화면의 보이는 순서
			var editorColumnsKey = getEditorColumnKey(this_target);//입력가능한컬럼

			// 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
			for (var i = 0; i < numRows-1; i++) {

				var editorColIndex = 0;
				for (var j = 0; j < numCols; j++) {
					var calRow = startRowIndex + i;
			   		var calCol = startColIndex + j; //선택한 ColIndex

			   		//입력데이타만 붙여넣기
			   		var isEditorColum = false;
			   		for(var eck=0; eck<editorColumnsKey.length; eck++){
			   			if(viewColumnsKey[calCol] == editorColumnsKey[eck]){
			   				isEditorColum = true;
			   			}
			   		}

			   		var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
			   		//시작점없는 붙여넣기, 빈칸 앞 붙여넣기
			   		if(!isEmpty(cellData)) {
				   		if(!isEmpty(thisGridCol) && isEditorColum) { //시작점이 있는 붙여넣기(그리드에서 시작점 선택.)
				   			if(gridLength-1 < calRow) break; //행추가 붙여넣기 사용안함.
				   			//도번(Length:4) , 수량(숫자검사)
			   				var col_Id = viewColumnsKey[calCol];
			   				if(col_Id == "dsgnBomQty" && isNaN(cellData) ){
			   					alert("수량이 숫자가아닙니다. ["+cellData+"]");
		   						return true;
			   				}
				   			//console.log("===========>","["+gridLength+"]["+calRow+"], ["+j+"]["+calCol+"]  ["+viewColumnsKey[calCol]+"]");
				   			this_target.setValue(calRow, viewColumnsKey[calCol], cellData);
				   		}
			   		}

				}
			}
		});
	};
	
	function setClearValue(_idx){
		var _key = ["dtaChk", "pchsClntNm", "dlvplcNm", "bomQty", "posQty", "goodsDiv", "goodsDiv", "matrClntDiv", "matrDiv", "matrGrp","matrUnit","matrTestDiv"];
		for(var _z=0;_z<_key.length;_z++){
			matrGridView.target.setValue(_idx, _key[_z], "");
		}
	}
</script>