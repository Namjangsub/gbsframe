<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">구매BOM 등록</h4>
    </div>

  <div class="form-group popup_table">
  <form id="popForm" onSubmit="return false;">
      <input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
      <input type="hidden" id="pgmId"     name="pgmId" value="SM0101M01">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
			<th class="hit">회사</th>
			<td>
			  <select id="coCd" name="coCd" data-kind="CO" class="form-control" required="required" msg="회사" readonly="readonly">
			  </select>
			</td>
			<th>Sales Code</th>
			<td>
				<input type="text" id="salesCd" name="salesCd" class="form-control" required="required" msg="Sales Code" readonly="readonly">
			</td>
			<th>고객사</th>
			<td>
				<input type="text" id="clntNm" name="clntNm" class="form-control" msg="고객사" readonly="readonly">
			</td>
			<th>고객사PJT</th>
			<td>
				<input type="text" id="clntPjt" name="clntPjt" class="form-control" msg="고객사PJT" readonly="readonly"> 
			</td>
        </tr>

        <tr>
			<th>제품구분</th>
			<td>
				<input type="text" id="prdtNm" name="prdtNm" class="form-control" msg="제품명" readonly="readonly">
			</td>
			<th>아이템구분</th>
			<td>
				<input type="text" id="itemDivNm" name="itemDivNm" class="form-control" msg="아이템구분" readonly="readonly">
			</td>
			<th>설비명</th>
			<td colspan="3">
				<input type="text" id="eqpNm" name="eqpNm" msg="설비명" class="form-control" readonly="readonly">
			</td>
        </tr>

      </table>

    </form>

		<!-- 콘텐츠 -->
	  <div class="contents" style="margin-top: 10px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="width: 100%">
	            <li style="width: 36%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a onclick="initBomGrid()" style="width: 60px;" authchk> 초기화</a>
		                    <a onclick="addRowBom()" style="" authchk>+</a>
		                    <a onclick="delRowBom()" style="" authchk>-</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="bom-grid" data-ax5grid-config="{}" style="height:350px; width: 100%" ></div>
	                </div>
	            </li>
	            <li style="width: 62%; margin-left: 8px;">
	                <div class="table_list_tit">
	                	<h5 style="color: #444;font-size: 16px;float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">BOM 자재정보</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                	<!-- 
		                    <a onclick="insertProdSecondModal('C')" style="width: 120px;" authchk><i class="fas fa-folder-plus"></i> 자재마스터 등록</a>
		                     -->
		                    <a onclick="openMatListSearch()" style="width: 80px;" authchk><i class="fas fa-folder-plus"></i> 자재검색</a>
		                    <a onclick="updateBomMtrlSecondModal()" style="width: 50px;" authchk><i class="fas fa-money-check"></i> 수정 </a>
		                    <a onclick="delRowMatr()" style="width: 50px;" authchk><i class="fas fa-trash"></i> 삭제 </a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="matr-grid" data-ax5grid-config="{}" style="height:350px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>


	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>
	
<script type="text/javascript">
  
var actionType = null;

var firstGrid = null;
var secondGrid = null;

var matrArr = [];  //자재 데이타

var before_bomIdx = -1;
var before_dsgnNo = null;
var select_bomIdx = -1;
var select_dsgnNo = null;

var bomGridView_notchange = false;

var bomGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: true,
		    	 sortable: false,
		         target: $('[data-ax5grid="bom-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: true
		         },
		         body: {
		        	 	 mergeCells : ["partNo", "unitNo", "revNo"],//editor 는 merge 안됨
			        	 onClick: function () {
		                	var list = bomGridView.target.getList();//"selected"
		                	$.each(list, function(idx, obj){
		                		bomGridView.target.select(obj.__index, {selected: false});
	                        });
			             	this.self.select(this.dindex);

			             	select_bomIdx = this.dindex;
			             	select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
			             	
			             	//원본데이타에서 화면데이터 제거 --> 화면데이타 put 원본데이타에.
			             	matrGridView.selectGrid(select_dsgnNo);
			             	before_bomIdx = this.dindex;
			             	before_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
			        	 },
						 onDBLClick: function () {
							 addRowBom();
						 },
			             onDataChanged: function () {
			            	//if(bomGridView_notchange) return;
			            	
			            	if (this.item.__selected__ == true) {
			                	//before_bomIdx = this.dindex;
			                }
			            	
			            	if(this.key == "lastDsgnNo" || this.key == "dsgnNm" || this.key == "bomQty" || this.key == "dsgnNo" || this.key == "upperCd" || this.key == "lowerCd"){//입력항목일때
				            	if(this.item.dtaChk != "I") {
				            		this.item.dtaChk = "U";
				            	}
			            	}

			            	//BOM 입력(partNo,unitNo,revNo)시 자재정보의 dsgnNo,lowerCd,upperCd Change
			            	if(this.key == "dsgnNo" || this.key == "upperCd" || this.key == "lowerCd"){
				            }//end if//자재정보
				            
			            	//bomGridView.target.repaint();
			            	this.self.repaint();
			             }//,
	             },
		         columns : [
		        	//,hidden:true
		        	{key: "dtaChk",label: " ", width: 30, 	styleClass: "grid-font-blue-bold"},
		        	{key: "fileTrgtKey", label: "Key", width: 50,hidden:true},
		        	{key: "coCd", label: "CO", width: 50,hidden:true},
		        	{key: "salesCd", label: "Sales Code", width: 120,hidden:true},
		        	{key: "lvl", label: "LVL", width: 40},
		        	{key: "partNo" , label: "PART"	, width: 80,align: "left",hidden:true},
		        	{key: "unitNo" , label: "UNIT"	, width: 80,align: "left",hidden:true},
		        	{key: "revNo"  , label: "REV" 	, width: 80,align: "left",hidden:true},
		        	{key: "dsgnNo" , label: "도번" 	,width: 300,align: "left" ,  treeControl: true},
					{key: "dsgnNm" , label: "명칭" 	,width: 90,align: "left", 
		        		editor:{type:  "text",
		        		    attributes: { 'maxlength': 30 }
    					}
                    },
					{key: "bomQty" , label: "수량" 	,width: 60,align: "right", 
		        		editor:{type:  "number",
	        		    	attributes: { 'maxlength': 5 }
						}
                	},
		        	{key: "lastDsgnNo", label: "입력" 	, width: 50,align: "left",hidden:true},
					{key: "upperCd", label: "upperCd" ,width: 160,align: "left",hidden:true},
					{key: "lowerCd", label: "lowerCd" ,width: 180,align: "left",hidden:true},
					{key: "oldUpperCd", label: "oldUpperCd" ,width: 160,align: "left",hidden:true},
					{key: "oldLowerCd", label: "oldLowerCd" ,width: 180,align: "left",hidden:true},
			     ],
	              tree: {
	                    use: true,
	                    indentWidth: 15,
	                    arrowWidth: 15,
	                    iconWidth: 18,
	                    icons: {
	                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
	                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                        groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
	                        collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
	                        itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
	                    },
		                columnKeys: {
		                parentKey: "upperCd",
		                selfKey: "lowerCd",
		               }
		           }
		    });
			return this;
		},


        setData: function(_pageNo){
			var target = this.target;
			var formData = {
				"salesCd" 		: $("#salesCd").val(),
			}

    		postAjax("/user/sm/sm01/selectBuyBomList", formData, null, function(data) {
				var list = data.resultList;
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});
				if(list.length > 0){
					//bomGridView.target.clearSelect();
					//bomGridView.target.focus("HOME")
					bomGridView.target.select(0);
					bomGridView.target.focused = true;
					select_bomIdx = 0;
					before_bomIdx = 0;
					select_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
					before_dsgnNo = select_dsgnNo;
					
					//자재정보 조회
					matrGridView.setData('A');
				}
    	 	});
     	} //setData
     }


var matrGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: false,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="matr-grid"]'),
		         header: {
			        		 align: "center",
			        		 selector: false
			    },
		        body: {
		        		   //mergeCells : ["coCd","salesCd", "dsgnNo", "upperCd","lowerCd","ordrgDiv10"],
  			               onClick: function () {
  			               this.self.select(this.dindex);
			          },
			          onDBLClick: function () {
			        	  //modRowMatr();
			        	  updateBomMtrlSecondModal();
			          },
			          onDataChanged: function () {
			            	//아이템 상세내역이 수정이 있으면 저장 필요
			            	
			            	if(this.key != "dtaChk"){//입력항목일때
				            	if(this.item.dtaChk != "I") {
				            		this.item.dtaChk = "U";
				            	}
			            	}
			            	matrGridView.target.repaint();
			          },
		        },
		        columns : [
		        		 {key: "dtaChk",label: " ", width: 30, 	styleClass: "grid-font-blue-bold"}
			 	 	 	,{key: "coCd", 				label: "CO", 			width: 50,	align: "center",hidden:true}
						,{key: "salesCd", 			label: "Sales Code", 	width: 120,	align: "left",hidden:true}
						,{key: "matrSeq", 			label: "자재순번", 		width: 70,	align: "center"}
						,{key: "oldUpperCd", 		label: "이전상위코드", 		width: 160,	align: "left",hidden:true}
						,{key: "oldLowerCd", 		label: "이전하위코드", 		width: 180,	align: "left",hidden:true}
						,{key: "dsgnNo", 			label: "도번", 			width: 180,	align: "left",hidden:true}
						,{key: "upperCd", 			label: "상위코드", 		width: 160,	align: "left",hidden:true}
						,{key: "lowerCd", 			label: "하위코드", 		width: 180,	align: "left",hidden:true}
						,{key: "ordrgDiv10", 		label: "발주용도", 		width: 100,	align: "left"
							, editor: {type: "select",
								config: {
									columnKeys: {optionValue: 'value',optionText: 'text'},
									options: options_01
								},
								disabled: function () {
									return false;
								}
							}
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.ordrgDiv10;
								$.each(options_01, function (idx, elem) {
									if(itemValue == elem.value)
									{
										result_text = elem.text;
									}
								});
								return result_text;
							}
						 }
						,{key: "ordrgDiv20", 		label: "발주유형", 		width: 100,	align: "left"
							, editor: {type: "select",
								config: {
									columnKeys: {optionValue: 'value',optionText: 'text'},
									options: options_02
								},
								disabled: function () {
									return false;
								}
							}
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.ordrgDiv20;
								$.each(options_02, function (idx, elem) {
									if(itemValue == elem.value)
									{
										result_text = elem.text;
									}
								});
								return result_text;
							}
						 }
						,{key: "nextPrcsnNm", 		label: "후행업체", 		width: 150,	align: "left", editor: {type: "text",attributes: {'maxlength': 150,'data-maxlength': 300}}}
						,{key: "dlvplcNm", 			label: "배송처", 			width: 150,	align: "left", editor: {type: "text",attributes: {'maxlength': 150,'data-maxlength': 300}}}
						,{key: "bomQty", 			label: "수량", 			width: 60,		align: "right", editor:{type:  "number"}}
						,{key: "posQty", 			label: "소유량", 			width: 60,		align: "right", editor:{type:  "number"}}
						,{key: "matrCd", 			label: "자재코드", 		width: 80,		align: "center"}
						,{key: "matrNm", 			label: "자재명", 			width: 160,		align: "left"}
						,{key: "goodsDiv", 			label: "자재구분", 		width: 90,	align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.goodsDiv;
								$.each(options_03, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrClntDiv", 		label: "거래처구분", 			width: 120,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrClntDiv;
								$.each(options_04, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrDiv", 			label: "자재유형", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrDiv;
								$.each(options_05, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrGrp", 			label: "자재그룹", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrGrp;
								$.each(options_06, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "matrMat", 			label: "소재", 				width: 100,		align: "center"}
						,{key: "matrSize", 			label: "크기", 				width: 100,		align: "center"}
						,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "left"}
						,{key: "matrMakrNm", 		label: "제조사", 				width: 100,		align: "center"}
						,{key: "matrMno", 			label: "Model No", 			width: 100,		align: "center"}
						,{key: "matrWt", 			label: "중량", 				width: 100,		align: "right"}
						,{key: "matrUnit", 			label: "단위", 				width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrUnit;
								$.each(options_07, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "useYn", 			label: "사용여부", 			width: 70,		align: "center", formatter: "useYn"}
						,{key: "matrStockCd", 		label: "재고관리", 			width: 70,		align: "center", formatter: "useYn"}
						,{key: "originNm", 			label: "원산지", 				width: 100,		align: "center"}
						,{key: "matrDrwNo", 		label: "대표도면", 			width: 120,		align: "center"}
						,{key: "matrTestDiv", 		label: "입고검사구분", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrTestDiv;
								$.each(options_08, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "dlvrRqmDay", 		label: "납품소요일자", 			width: 100,		align: "right"}
						,{key: "matrPurcDiv", 		label: "구매/외주구분", 			width: 100,		align: "center"
							, formatter: function () {
								var result_text = "";
								var itemValue = this.item.matrPurcDiv;
								$.each(options_09, function (idx, elem) {
									if(itemValue == elem.value) result_text = elem.text;
								});
								return result_text;
							}
						 }
						,{key: "minOrdrgQty", 		label: "최소발주량", 			width: 100,		align: "right"}
						,{key: "matrSaftQty", 		label: "안전재고", 			width: 100,		align: "right"}
						,{key: "dsgn2DMd", 			label: "2D설계소요일", 			width: 100,		align: "right"}
						,{key: "avrg2DMd", 			label: "2D평균소요일", 			width: 100,		align: "right"}
						,{key: "dsgn3DMd", 			label: "3D설계소요일", 			width: 100,		align: "right"}
						,{key: "avrg3DMd", 			label: "3D평균소요일", 			width: 100,		align: "right"}
						,{key: "prdctnRqmMd", 		label: "생산소요일", 			width: 100,		align: "right"}
						,{key: "prdctnAvrgMd", 		label: "생산평균소요일", 			width: 100,		align: "right"}
						,{key: "matrPartNo", 		label: "파트번호", 			width: 100,		align: "center"}
						,{key: "pchsClntCd1", 		label: "구매업체1", 			width: 80,		align: "right"}
						,{key: "pchsClntPct1", 		label: "구매업체1%", 			width: 80,		align: "right"}
						,{key: "pchsClntCd2", 		label: "구매업체2", 			width: 80,		align: "right"}
						,{key: "pchsClntPct2", 		label: "구매업체2%", 			width: 80,		align: "right"}
						,{key: "pchsClntCd3", 		label: "구매업체3", 			width: 80,		align: "right"}
						,{key: "pchsClntPct3", 		label: "구매업체3%", 			width: 80,		align: "right"}
						,{key: "matrUpr", 			label: "최종구매단가", 			width: 100,		align: "right",  formatter: "money"}
						,{key: "matrAvrgUpr", 		label: "평균구매단가", 			width: 100,		align: "right",  formatter: "money"}
						,{key: "matrRmk", 			label: "비고", 				width: 150,		align: "left"}
						,{key: "matrLastTrstDt", 	label: "최종거래일자", 			width: 100,		align: "center"}
						,{key: "matrAtntCd", 		label: "대체자재코드", 			width: 100,		align: "center"}
						,{key: "matrNo", 			label: "자재번호", 			width: 100,		align: "center"}
		         	]
		    });
			return this;
		},
		
		selectGrid : function(click_dsgnNo) {
			if(before_bomIdx == select_bomIdx) return; //선택행 변경없을때 사용안함.
			
			var delIdxArray = findIndexArray(matrArr, "dsgnNo", before_dsgnNo);
			
			var af_gridList = this.target.getList();
			if(af_gridList.length > 0) {
				$.each(af_gridList, function (idx, elem) {
					matrArr.push(elem);
				});
			}
			//행삭제는 index가 변경되므로 아래에서 삭제
			for(var i=delIdxArray.length-1; i >= 0; i--){
				matrArr.splice(delIdxArray[i],1);
			}
			
			//var target = this.target;
			var list = getFilterData(click_dsgnNo);
			this.target.setData({
        		list : list,
        		page : {
        			totalElements : list.length
        		}
   			});
		},
		
		setData: function(_mod){
			if(_mod != "A"){
				var target = this.target;
				var sel_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
				var list = getFilterData(sel_dsgnNo);
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});
			} else {
				var target = this.target;
				var formData = {
					"coCd" 		: $("#coCd").val(),
					"salesCd" 	: $("#salesCd").val()
				}

	    		postAjax("/user/sm/sm01/selectBomMatrList", formData, null, function(data) {
	    			matrArr = data.resultList;//원본데이타
	    			var sel_dsgnNo = bomGridView.target.getList("selected")[0].dsgnNo;
					var list = getFilterData(sel_dsgnNo);
					target.setData({
	            		list : list,
	            		page : {
	            			totalElements : list.length
	            		}
	       			});
	    	 	});
			}	
		}
	}


 	$(document).ready(function() {
 		//debugger;
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#salesCd").val(modalStack.last().paramObj.salesCd);
		$("#clntNm").val(modalStack.last().paramObj.clntNm);
		$("#clntPjt").val(modalStack.last().paramObj.clntPjt);
		$("#itemDivNm").val(modalStack.last().paramObj.itemDivNm);
		$("#eqpNm").val(modalStack.last().paramObj.eqpNm);
		$("#prdtNm").val(modalStack.last().paramObj.prdtNm);
		
		//$("#userId").val(jwt.userId);
		
		//$('#ordrsPlanAmt, #ordrsAmt').on('keyup', ordRemCal);

		authChk();// 권한체크

		actionType = modalStack.last().paramObj.actionType;

		/**
		 * grid 초기화
		*/
		bomGridView.initView();
		matrGridView.initView();
		
		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertBomMatr();
			});
			//등록시 ROOT 데이타 생성
			var newRow = {};
			newRow = {dtaChk:"I",coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:0, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:".", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			//bomGridView.target.clearSelect();
			bomGridView.target.select(0);
			bomGridView.target.focused = true;
		} else if (actionType == "U") {
			$('.tit').text('구매BOM 수정')
			
			bomGridView.setData(0);

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateBomMatr();
			});
		}
		
		var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		 $("#fileTrgtKey").val(param_fileTrgtKey);
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey	: param_fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  
	});
	
	function initBomGrid(){
		bomGridView.setData(0);
	}
	
	function clearSelectBomTree(){
		var list = bomGridView.target.getList();//"selected"
    	$.each(list, function(idx, obj){
    		bomGridView.target.select(obj.__index, {selected: false});
        });		
	}
	
	// 등록
	function insertBomMatr() {
		if(gridDataValidation(bomGridView.target)) return;
		if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
			var formData = makeFormData();									// 요청이 통과하면 formData를 생성
			filePostAjax("/user/sm/sm01/insertBom", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);							// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {						// 요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView1.setData(0);							// 결과갑시 200인 경우 리드 뷰를 업데이트
							modalStack.close();								// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateBomMatr() {
		if(gridDataValidation(bomGridView.target)) return;
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 formData를 생성
	      	filePostAjax("/user/sm/sm01/updateBom", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView1.setData(0);
							modalStack.close();
						}
					});
		}
	}
	
	//----------------------------------------------//
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		var bomlist = bomGridView.target.list;
		var bomArr = getTreeBomData(bomlist);
		formData.append("bomArr", JSON.stringify(bomArr));
		
		//현재 자재정보 그리드정보를 matrArr에  update 한다
		var matrGridList = matrGridView.target.list;
		if(matrGridList.length > 0){
			var delIdxArray = [];
			if(!isEmpty(before_dsgnNo)){
				delIdxArray = findIndexArray(matrArr, "dsgnNo", before_dsgnNo);
			}
			$.each(matrGridList, function (idx, elem) {
				matrArr.push(elem);
			});
			if(!isEmpty(before_dsgnNo)){
				for(var i=delIdxArray.length-1; i >= 0; i--){
					matrArr.splice(delIdxArray[i],1);
				}
			}
		}

		$.each(matrArr,function(idx, obj) {
			if(isEmpty(obj.dtaChk)){
				obj.dtaChk = "";
			}
		});
		formData.append("matrArr", JSON.stringify(matrArr));
		//세부 아이템 자료 끝
		return formData;
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	//구매Bom 추가수정팝업
	function addRowBom() {
		var selData = bomGridView.target.getList("selected")[0];
		var isBomSelect = !isEmpty(selData);
		if(bomGridView.target.list.length != 0 && isBomSelect == false){
			alert("구매 BOM 행추가시 상위목록을 선택하여야 합니다.");
			return;
		}
		if(selData.dtaChk == "D"){
			alert("선택된 행은 삭제 대기 상태 입니다.");
			return;
		}
		var targetLevel = Number(selData.lvl)+1;
		let bom_List = JSON.parse(JSON.stringify(bomGridView.target.list));
		let bom_Arr = getTreeBomData(bom_List);
		//console.log("====bom_Arr>>>",bom_Arr);
		let sendLowData = getFilterLevelData(bom_Arr, targetLevel, selData.lowerCd);
		var paramObj = {};
		paramObj.coCd = selData.coCd;
		paramObj.salesCd = selData.salesCd;
		paramObj.upperCd = selData.lowerCd;
		paramObj.lvl = targetLevel;
		paramObj.sendLowData = JSON.stringify(sendLowData);
		paramObj.sendSelectData = JSON.stringify(selData);
		openSecondModal("/static/html/user/sm/sm01/SM0101P04.html", 830, 500, "", paramObj, function (data) {
			//matrGridView.target.addRow($.extend({}, newRow), "last");
			//console.log("====collbackData>>",data);
			
			//현재 Row 데이타 명칭,수량 수정  data.selectBom   data.selectBom.dtaChk == "U"||data.selectBom.dtaChk == "I"
			if(!isEmpty(data.selectBom.dtaChk)){
				let select_bom =  data.selectBom;
				bomGridView.target.updateRow($.extend({}, bomGridView.target.list[selData.__index], select_bom), selData.__index);
			}
			
			//collbackData 의 bom_index 로 데이타 update data.lvlBomList __children__  __children__ : []
			if(data.lvlBomList) {
				let lvl_bom_list = data.lvlBomList;
				
				$.each(lvl_bom_list,function(idx, elem) {
					if(elem.dtaChk == "I" && isEmpty(elem.bom_index)) {
						bomGridView.target.addRow($.extend({}, elem), "last"); //행추가- 위치는 Tree로 정렬
						clearSelectBomTree();
					}
					else if( (elem.dtaChk == "I" && !isEmpty(elem.bom_index)) || elem.dtaChk == "U") {
						//하위 변경 해당행의 lowerCd를 upperCd로 사용하는 행이 있다면 교체한다.
						let bom_Arr = getTreeBomData(bomGridView.target.list);
						var lowIndexArray = findLowerArray(bom_Arr, elem.before_lowerCd);//현재행으로 변경전값으로 before_lowerCd 검색
						//console.log("====lowIndexArray>>",lowIndexArray);
						
						for(var iidx = 0; iidx<lowIndexArray.length; iidx++) {
							var _index = Number(lowIndexArray[iidx]);
							var low_elem = bom_Arr[_index];
							var before_lowerCd = elem.before_lowerCd;
							var sel_lowerCd = low_elem.lowerCd;
							var to_lowerCd = elem.lowerCd;
							var set_upperCd = low_elem.upperCd.replace(before_lowerCd,to_lowerCd);
							var set_lowerCd = low_elem.lowerCd.replace(before_lowerCd,to_lowerCd);
							
							//console.log("====iidx>>",iidx);
							//console.log("====sel_lowerCd>>",sel_lowerCd);
							//console.log("====before_lowerCd>>",before_lowerCd);
							//console.log("====set_lowerCd>>",set_lowerCd);
							//console.log("====set_upperCd>>",set_upperCd);
							matrArrChange(sel_lowerCd, set_lowerCd, set_upperCd); //자재데이타 변경
							
							bomGridView.target.setValue(_index, "upperCd", set_upperCd);
							bomGridView.target.setValue(_index, "lowerCd", set_lowerCd);
							bomGridView.target.setValue(_index, "dsgnNo" , set_lowerCd);
						}
						//도번,입력도번 도변경필요 
						var _lowerCd = elem.lowerCd;
						var _lastDsgnNo = _lowerCd.substring(_lowerCd.lastIndexOf('-')+1,_lowerCd.length);
						//console.log("====elem.before_lowerCd>>",elem.before_lowerCd);
						//console.log("====elem.lowerCd>>",elem.lowerCd);
						var real_elem = bom_Arr[elem.bom_index];
						var selLvl_lowerCd = real_elem.lowerCd;
						//console.log("====selLvl_lowerCd>>",selLvl_lowerCd);
						
						matrArrChange(selLvl_lowerCd, elem.lowerCd, real_elem.upperCd); //자재데이타 변경
						
						//updateRow 로 반영시 화면에 반영안됨.
						//bomGridView.target.updateRow($.extend({}, bomGridView.target.list[elem.bom_index], elem), elem.bom_index);
						bomGridView.target.setValue(elem.bom_index, "dsgnNm", elem.dsgnNm);
						bomGridView.target.setValue(elem.bom_index, "bomQty", elem.bomQty);

						bomGridView.target.setValue(elem.bom_index, "lowerCd", elem.lowerCd);
						bomGridView.target.setValue(elem.bom_index, "lastDsgnNo", _lastDsgnNo);
						bomGridView.target.setValue(elem.bom_index, "dsgnNo", elem.lowerCd);					
					}
				});
				
				//matrArr 에 lowerCd --> lowerCd 는 후처리로 변경 //임시로 dsgnNo 에 저장 lowerCd 반영
				$.each(matrArr,function(idx, elem) {
					matrArr[idx].lowerCd = matrArr[idx].dsgnNo;
				});
				
				let delInputRowArr = data.delInputRowIndexArr;
				//오름차순으로
				delInputRowArr.sort(function(a, b) {
					  return b - a; //오름차순  //return a - b; //내림차순
				});
				
				for(var i=0;i<delInputRowArr.length;i++){
					var del_Index = delInputRowArr[i]; 
					bomGridView.target.removeRow(del_Index);
				}
				
				//bomGridView.target.repaint();
			}//if
			//clearSelectBomTree();
			
			bomGridView.target.select(selData.__index, {selected: true});
		});//openSecondModal
	}
	
	//자재그리드의 자재 데이타 (matrArr) 에서  upperCd, dsgnNo 변경  --> lowerCd 는 후처리로 변경
	this.matrArrChange = function(sel_lowerCd, to_lowerCd, to_upperCd){
		var idxArray = findIndexArray(matrArr, "lowerCd", sel_lowerCd);
		$.each(idxArray, function (idx, row) {
			let _index = Number(row);
			//console.log("====idxArray>>_index>>",_index);
			matrArr[_index].upperCd = to_upperCd;
			matrArr[_index].dsgnNo = to_lowerCd; //임시로 dsgnNo 에 저장 lowerCd는 변경안함.
			if(matrArr[_index].dtaChk != "I") {
				matrArr[_index].dtaChk = "U";
			}
		});
	}

	this.getFilterLevelData = function(obj, sel_lvl, sel_upperCd) {
		const resultData = obj.filter(function(element){
			return sel_lvl == element.lvl && sel_upperCd == element.upperCd;
		});
		return resultData;
	}
	//그리드가 트리일경우 사용
	function getTreeBomData(bom_list) {
		var resultBomArr = [];
		var bom_index = 0;
		$.each(bom_list, function (idx, elem) {
			if(isEmpty(elem.dtaChk)){
				elem.dtaChk = "";
			}
			var bomData = {};
			bomData.dtaChk = elem.dtaChk;
			bomData.lvl = elem.lvl;
			bomData.fileTrgtKey = elem.fileTrgtKey;
			bomData.coCd = elem.coCd;
			bomData.salesCd = elem.salesCd;
			bomData.partNo = elem.partNo;
			bomData.unitNo = elem.unitNo;
			bomData.revNo = elem.revNo;
			bomData.dsgnNo = elem.dsgnNo;
			bomData.lastDsgnNo = elem.lastDsgnNo;
			bomData.dsgnNm = elem.dsgnNm;
			bomData.bomQty = elem.bomQty;
			bomData.upperCd = elem.upperCd;
			bomData.lowerCd = elem.lowerCd;
			bomData.before_lowerCd = elem.lowerCd; //하위를 찾기위한 변경전 lowerCd
			bomData.bom_index = bom_index++;
			
			resultBomArr.push(bomData);
		});
		
		return resultBomArr;
	}
	//Bom 추가
	function addRowBom222(){
		//if(selectGridValidation(bomGridView.target)) return;
		var selData = bomGridView.target.getList("selected")[0];
		var isBomSelect = !isEmpty(selData);
		let newRow = {};
		if(bomGridView.target.list.length != 0 && isBomSelect == false){
			alert("구매 BOM 행추가시 상위목록을 선택하여야 합니다.");
			return;
		}
		else if(bomGridView.target.list.length == 0 && isBomSelect == false ) {
			//ROOT 데이타 생성
			newRow = {dtaChk:"I", coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:0, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:".", lowerCd:$("#salesCd").val()};
			bomGridView.target.addRow($.extend({}, newRow), "last");
			//1레벨 데이타 생성
			newRow = {dtaChk:"I", coCd: $("#coCd").val(), salesCd: $("#salesCd").val() , lvl:1, partNo:"", unitNo:"", revNo:"", dsgnNo:$("#salesCd").val(), upperCd:$("#salesCd").val(), lowerCd:""};	
			bomGridView.target.addRow($.extend({}, newRow), "last");
		}
		else if(isBomSelect == true ){
			var selLevel = Number(selData.lvl);
			var targetLevel = selLevel+1;
			if(targetLevel > 3){
				alert("3레벨[REV] 이상 은 [행추가] 할 수 없습니다. 2레벨 이하를 선택 후 [행추가] 하세요.");
				return;
			}
			if(targetLevel > 3) targetLevel = 3;//3레벨까지 가능 -- SalesCd > PART > UNIT > REV
			newRow = {    dtaChk:"I"
						, coCd: $("#coCd").val()
						, salesCd: $("#salesCd").val()
						, lvl: targetLevel
						, partNo: selData.partNo
						, unitNo: selData.unitNo
						, revNo:  selData.revNo
						, dsgnNo:""
						, upperCd: ""    //입력후 행추가 하지 않는다. selData.lowerCd
						, lowerCd: ""
					};
			bomGridView.target.addRow($.extend({}, newRow),selData.__index+1,);

			//_this.target.updateRow($.extend({}, _this.target.list[_selthis.dindex], {data1: data.value}), _selthis.dindex);
			//_dindex = 2;
			//bomGridView.target.addRow($.extend({}, newRow));
			//var dindex = 1;
			//.$.extend({}, 추가할 내용),삽인할위치,갯수);
			//bomGridView.target.addRow($.extend({}, bomGridView.target.list[dindex], newRow),0,);
			//bomGridView.target.addRow(newRow);
        	//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
	        //firstGrid.addRow($.extend({}, firstGrid.list[param.dindex], {__index: undefined}),param.dindex+1,);		
	        //firstGrid.setValue(param.dindex, 'updcheck', 1);
		}
	}
	
	//Bom 삭제
	function delRowBom() {
		if(selectGridValidation(bomGridView.target)) return;
		var selData = bomGridView.target.getList("selected")[0];
		var isBomSelect = !isEmpty(selData);
		//하위레벨의 데이타 유무 체크
		//let bom_List = JSON.parse(JSON.stringify(bomGridView.target.list));
		//let bom_Arr = getTreeBomData(bom_List);
		let bom_Arr = getTreeBomData(bomGridView.target.list);
		var indexArray = findLowerArray(bom_Arr, selData.lowerCd);

		if(selData.lvl == 0){
			if(!confirm("최상위는 삭제 할 수 없습니다. 하위레벨 모두를 삭제하시겠습니까?")) return;
			if(indexArray.length > 0) {
				deleteRowIndexArray(bomGridView.target, indexArray);
			}
		}
		var bomDtaChk = selData.dtaChk;
		
		if(bomDtaChk == "I"){
			if(indexArray.length > 0) {
				if(!confirm("하위레벨이 있습니다. 모두를 삭제하시겠습니까?")) return;
				deleteRowIndexArray(bomGridView.target, indexArray);
				bomGridView.target.removeRow(selData.__index);
			}
			else {
				bomGridView.target.removeRow(selData.__index);
			}
		}
		else {
			if(indexArray.length > 0) {
				if(!confirm("하위레벨이 있습니다. 모두를 삭제하시겠습니까?")) return;
				deleteRowIndexArray(bomGridView.target, indexArray);
				bomGridView.target.setValue(selData.__index, "dtaChk", "D");
			}
			else {
				bomGridView.target.setValue(selData.__index, "dtaChk", "D");
			}
		}
	}
	
	this.deleteRowIndexArray = function(gridObj, indexArray) {
		var list = gridObj.getList();
		for(var i=indexArray.length-1; i >= 0; i--){
			var _index = Number(indexArray[i]);
			if(list[_index].dtaChk == "I"){
				gridObj.removeRow(_index);
			}
			else {
				gridObj.setValue(_index, "dtaChk", "D");
			}
		}
	}
	
	//현재데이타로 계층관계의 Index를 return 한다.
	this.findLowerArray = function(gridObj, _lowerCd) {
		var resultArray = [];
		selecLowerIndex(gridObj ,resultArray , _lowerCd);
		return resultArray;
	}
	
	this.selecLowerIndex = function(gridObj, rArray, value) {
		if( gridObj.length > 0 ) {
	        $.each($.extend({}, gridObj), function (idx, elem) {
	        	var upperCd = elem.upperCd;
	        	var lowerCd = elem.lowerCd;
				if(elem["upperCd"] == value) {
					rArray.push(idx);
					selecLowerIndex(gridObj, rArray, elem.lowerCd);//재귀메소드
				}
	        });			
		}
	}
	
	//자재추가 - 사용안함.
	this.addRowMatr = function() {
		var bomData = bomGridView.target.getList("selected")[0];
		var matrLength = matrGridView.target.list.length;
		let newRow = {};
		newRow = { dtaChk:"I"
			, coCd: bomData.coCd
			, salesCd: bomData.salesCd
			, dsgnNo: bomData.dsgnNo
			, upperCd: bomData.upperCd
			, lowerCd: bomData.lowerCd
			, matrSeq: matrLength+1
		};
		
		matrGridView.target.addRow($.extend({}, newRow), "last");
	}
	
	//자재품번 검색
	function openMatListSearch() {
		var bomData = bomGridView.target.getList("selected")[0];
		var matrLength = matrGridView.target.list.length;
		var paramObj = {
			"coCd" : $('#coCd_S').val(),
			"searchValue" : $("#matrCd_S").val()
		}
		
		openSecondModal("/static/html/cmn/modal/matListSearch.html", 1200, 700, "자재 검색", paramObj, function (grid) {
			var newRow = grid.target.getList("selected")[0];
			newRow.dtaChk = "I";
			newRow.coCd = bomData.coCd;
			newRow.salesCd = bomData.salesCd;
			newRow.dsgnNo = bomData.dsgnNo;
			newRow.upperCd = bomData.upperCd;
			newRow.lowerCd = bomData.lowerCd;
			newRow.matrSeq = matrLength+1;
			matrGridView.target.addRow($.extend({}, newRow), "last");
		});
	}
	
	//자재수정
	this.modRowMatr = function() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		var matrDtaChk = selData.dtaChk;
		var paramObj = {
				"coCd" : $('#coCd_S').val(),
				"searchValue" : selData.matrCd
			}
		
		openSecondModal("/static/html/cmn/modal/matListSearch.html", 1200, 700, "자재 검색", paramObj, function (grid) {
			var newRow = grid.target.getList("selected")[0];
			if(selData.dtaChk == "I"||selData.dtaChk == "D"){
				newRow.dtaChk = selData.dtaChk;
			} else {
				newRow.dtaChk = "U";
			}
			matrGridView.target.updateRow($.extend({}, matrGridView.target.list[selData.__index], newRow), selData.__index);
		});
	}
	//자재삭제
	this.delRowMatr = function() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		var matrDtaChk = selData.dtaChk;
		if(matrDtaChk == "I"){
			matrGridView.target.removeRow(selData.__index);
		}
		else {
			matrGridView.target.setValue(selData.__index, "dtaChk", "D");
		}
	}
	
	this.getFilterData = function(sel_dsgnNo) {
		const resultData = matrArr.filter(function(element){
			return sel_dsgnNo == element.dsgnNo;
		});
		return resultData;
	}

	this.gridDataValidation = function(gridObj){
		var dataList = gridObj.getList();
		for(i=0; i<dataList.length; i++){
			if(empty(dataList[i]["upperCd"])){
				//gridObj.clearSelect();
				gridObj.select(i);
				gridObj.focused = true;
				alert("구매 BOM의 [upperCd]는 필수입력 항목입니다.");
				return true;
			}
			if(empty(dataList[i]["lowerCd"])){
				//gridObj.clearSelect();
				gridObj.select(i);
				gridObj.focused = true;
				alert("구매 BOM의 [lowerCd]는 필수입력 항목입니다.");
				return true;
			}
			if(empty(dataList[i]["dsgnNo"])){
				//gridObj.clearSelect();
				gridObj.select(i);
				gridObj.focused = true;
				alert("구매 BOM의 [dsgnNo]는 필수입력 항목입니다.");
				return true;
			}
		}
		return false;
	}

	//Bom-자재 수정
	function updateBomMtrlSecondModal() {
		if(selectGridValidation(matrGridView.target)) return;
		var selData = matrGridView.target.getList("selected")[0];
		var paramObj = selData;
        //var fileTrgtKey = selData.fileTrgtKey;
        var fileTrgtKey = selData.fileTrgtKey;
        //paramObj.actionType = isEmpty(fileTrgtKey) ? "C":"U";
        paramObj.actionType = "U";
        paramObj.sendLowData = JSON.stringify(selData);
        openSecondModal("/static/html/user/sm/sm01/SM0101P02.html", 1300, 550, "", paramObj, function(data) {
        	//console.log("====data>>",data);
        	//data.dtaChk = "U";
        	matrGridView.target.updateRow($.extend({}, matrGridView.target.list[selData.__index], data), selData.__index);
        	matrGridView.target.setValue(selData.__index, "dtaChk", "U");
		});
	}
	
	this.findIndexArray = function(gridObj, column, value) {
		var resultArray = [];
		if( gridObj.length > 0 ) {
	        $.each($.extend({}, gridObj), function (idx, elem) {
				if(elem[column] == value) {
					resultArray.push(idx);
				}
	        });			
		}
		return resultArray;
	}
	
	this.findIndex = function(gridObj, appId) {
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			var idArr = [];			
	        $.each(gridList, function (idx, elem) {
        		//idArr.push(elem.appId);
	        });			
	        if( idArr.indexOf(appId) > -1 ) {
	        	//return true;
	        } else {
	        	//return false;
	        }
	        return 0;
		}
		return -1;
	}
	
	function adPer(str){
		if(typeof str == "undefined" || str == null || str == "") {
			return "";
		}
		return "-"+str ;
	}	

</script>