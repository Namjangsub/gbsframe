<style>
.popup_bottom_btn {
	bottom: 25px;
}

.columnSideBySide {
  /* float: left;
  padding: 5px;
  width: 50%; */
  flex: 50%;
}

.rowSideBySide {
/*.rowSideBySide::after {
   content: "";
  clear: both;
  display: table; */
  display: flex;
}
</style>
<div class="popup_area of_a" style=" height: 100%;">
    <div id="first-focus" class="tit_contents">
        <h4 class="tit">구매BOM</h4>
    </div>
    <div class="add_btn_small pdl10" style="margin-right:8px;">
        <button id="actionBtn">생성</button>
    </div>
    <div class="toggle-div" style="padding-left: 0;">
    
        <div class="popup_table">
        
            <form id="popForm">
                <input type="hidden" id="pgmId" name="pgmId" value="CR0101M01">
                <table>
                    <tr>
                        <th class="hit">회사</th>
	                    <td>
	                        <select id="coCd_S_Org" style="width:100%;" data-kind="CO"
	                                required="required">
	                            <option value="">전체</option>
	                            <option value="10">건양ITT</option>
	                        </select>
	                    </td>
                        <th class="hit">Sales Code</th>
	                    <td>
	                        <input type="hidden" id="salesCd_S_Org" name="salesCd_S">
	                        <div class="search_form">
	                            <input type="text" id="salesCdNm_S_Org" name="salesCdNm_S_Org" onchange="updateTopLeftTableData();">
	                            <a onclick="opendSalesCdSearch($('#salesCd_S_Org').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                        <th class="hit">회사</th>
	                    <td>
	                        <select id="coCd_S_Clon" style="width:100%;" data-kind="CO"
	                                required="required">
	                            <option value="">전체</option>
	                            <option value="10">건양ITT</option>
	                        </select>
	                    </td>
                        <th class="hit">Sales Code</th>
	                    <td>
	                        <input type="hidden" id="salesCd_S_Clon" name="salesCd_S">
	                        <div class="search_form">
	                            <input type="text" id="salesCdNm_S_Clon" name="salesCdNm_S_Clon" onchange="updateTopRightTableData();">
	                            <a onclick="opendSalesCdSearchClon($('#salesCdNm_S_Clon').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                    </tr>
                    <tr>
						<th class="hit" title="고객사를 선택합니다">고객사</th>
						<td>
							<input type="hidden" id="bomClntCd" name="bomClntCd">
							<div class="search_form">
								<input onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);" type="text"
									   id="bomClntNm" name="bomClntNm" required>
								<a onclick="openSecondClntSearch(document.getElementById('bomClntNm').value);">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
                        <th class="">고객사 PJT</th>
	                    <td>
	                        <div class="search_form">
	                            <input type="text" id="clntPjt_S_Org" name="clntPjt_S" class="modal-clntPjt_S">
	                        </div>
                    	</td>
                    	
                        <th class="">고객사</th>
	                    <td>
	                        <input type="hidden" id="bomClntCd_S" name="bomClntCd_S">
	                        <div class="search_form">
	                            <input type="text" id="bomClntNm_S" name="bomClntNm_S"
	                                   >
	                            <a onclick="opendClntSearch($('#bomClntNm_S').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                        <th class="">고객사 PJT</th>
	                    <td>
	                        <div class="search_form">
	                            <input type="text" id="clntPjt_S_Clon" name="clntPjt_S" class="modal-clntPjt_S">
	                        </div>
                    	</td>
                    </tr>
                    <tr>
                        <th class="">설비명</th>
	                    <td colspan="1">
	                        <div class="search_form">
	                            <input type="text" id="eqpNm_S" name="eqpNm_S" class="modal-eqpNm_S">
	                        </div>
	                    </td>
	                    <th colspan="2"></th>
	                    
                        <th class="">설비명</th>
	                    <td colspan="1">
	                        <div class="search_form">
	                            <input type="text" id="eqpNm_S" name="eqpNm_S" class="modal-eqpNm_S">
	                        </div>
	                    </td>
	                    <th colspan="2"></th>
                    </tr>
                    <tr>
                        <th class="">제품구분</th>
	                    <td>
							<select id="itemList_S" style="width:100%;" data-kind="ITEMLIST"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
						</td>
                        <th class="">아이템구분</th>
	                    <td>
	                        <select id="itemList_S" style="width:100%;" data-kind="ITEMLIST"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
	                    </td>
                        <th class="">제품구분</th>
	                    <td>
							<select id="itemList_S" style="width:100%;" data-kind="ITEMLIST"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
						</td>
                        <th class="">아이템구분</th>
	                    <td>
	                        <select id="itemList_S" style="width:100%;" data-kind="ITEMLIST"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
	                    </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <br>
    <div class="popup_table" style="">
        <div class="toggle-div" style="padding-left: 0;">
            <div class="" style="padding-left: 0;">
                <div id="bom_grid" class="contents"
                     style="margin:0px; padding:0px; height: 380px; width: 100%; min-width: 200px;border-radius:0;">
                    <h3 class="location">
                        <a class="file_tag" id="file_tag"
                           style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                        <span class="page_tit" style="text-align: right;"></span>
                    </h3>
                    <div class="rowSideBySide">
	                    <div class="columnSideBySide">
					        <div class="contents_tit">
					            <div>
									<span style="font-size: 14px;float:left;margin-left: 8px;margin-top:8px;">구매BOM</span>
					                <div class="add_btn pdl10" style="margin-right:8px;">
					                    <a onclick="addRow()" style="" authchk>+</a>
					                    <a onclick="deleteRow()" style="" authchk>-</a>
					                </div>
					            </div>
					        </div>
		                    <div class="contents" style="margin:0px;padding:0 5px;height:80%;min-width:300px">
		                        <div data-ax5grid="top-left-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
		                    </div>
		                </div>
		                <div class="columnSideBySide">
		                	<!-- 콘텐츠 타이틀 -->
					        <div class="contents_tit">
					            <div>
									<span style="font-size: 14px;float:left;margin-left: 8px;margin-top:8px;">자재정보</span>
					                <div class="add_btn pdl10" style="margin-right:8px;">
					                    <a onclick="addRightGridRow()" style="" authchk>+</a>
					                    <a onclick="removeRightGridRow()" style=" " authchk>-</a>
					                </div>
					            </div>
					        </div>
		                    <div class="contents" style="margin:0px;padding:0 5px;height:80%;min-width:300px">
		                        <div data-ax5grid="top-right-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
		                    </div>
		                </div>
		            </div>
                </div>
            </div>
        </div>
    </div>
    <br>
   
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
        <button id="actionBtn" onclick="updateTable()" authchk>등록</button>
        <button class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
</div>

<script type="text/javascript">


	
	function deleteRow(){
		topLeftGrid.removeRow();
	}
	
	function updateTable() {
		var rowList = topLeftGrid.list;
		console.log(rowList)
		
		if(rowList.length == 0) {
			alert("추가할 행이 존재하지 않습니다.");
			return;
		}
		
		var detailArr = [];
		
		$.each(rowList, function(idx, elem){
			var detailObj = {};
			detailObj["coCd"] = $('#coCd_S_Org').val();
			detailObj["salesCd"] = $('#salesCdNm_S_Org').val();
			detailObj["bomSeq"] = elem.bomSeq;
			detailObj["matrPartNo"] = elem.matrPartNo;
			detailObj["unitNo"] = elem.unitNo;
			detailObj["revNo"] = elem.revNo;
			detailObj["matrCd"] = elem.matrCd;
			detailObj["matrNm"] = elem.matrNm;
			detailObj["matrSaftQty"] = elem.matrSaftQty;
			detailArr.push(detailObj);
		});
		
		var formData = {
			"detailArr" : JSON.stringify(detailArr)
		}
		console.log("formData" + formData.detailArr)
		postAjax("/user/sm/sm01/updateBom", formData, null, function(data){
			if(data.resultCode == 200){
				alert(data.resultMessage);
				//shipGridView.setData(0);
			}
		});
	}
	
    /* 견적서함수 */
    //견적 번호 조회 함수
    function getMaxBomNumber() {
        let paramObj = {}; // Add any parameters needed for the requbom
        // postAjax("/user/sm/sm01/maxBom", paramObj, null, function (data) {
        // 	// Set the received maximum bomimation number to the input field
        // 	$("#bomNo").val(data.maxBomNo);
        // });
    }

    // 견적 정보 조회 함수
    function selectBomInfo() {
        var paramObj = modalStack.last().paramObj;
        postAjax("/user/sm/sm01/selectBomInfo", paramObj, null, function (data) {
            setBomInfo(data.bomInfo);
        });
    }

    // 견적 정보 설정 함수
    function setBomInfo(bomInfo) {
        //메인정보 세팅
        $.each(bomInfo, function (key, value) {
            if ($('#' + key)[0]) {
                if ($('#' + key).is('[date]')) {
                    $('#' + key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
                } else {
                    if ($('#' + key).is('[comma]')) {
                        value = addCommaStr(value);
                    }
                    if (key == "coCd") {
                        setByCoCd(value)
                    }
                    $('#' + key).val(value);
                }
            }
        });


        $.each(bomInfo.bomDetailList, function (idx, obj) {
            if (idx != 0) addRow();
            $addedRow = $("tr[name='detailRow']:last");

            $.each($addedRow.find('[name]'), function (idx, elem) {
                var itemValue = obj[elem.name];
                if (itemValue) {
                    if ($(elem).is("[comma]")) {
                        itemValue = addCommaStr(itemValue);
                    }
                    $(elem).val(itemValue);
                }
            });
        });
        countTot();


        $.each(bomInfo.bomFileList, function (idx, obj) {
            fileArr.push({
                'fileKey': obj.fileKey,
                'fileName': obj.fileName,
                'fileType': obj.fileType,
                'fileSize': obj.fileSize,
                'file': obj
            });
        });


    }
    
    function opendSalesCdSearch(inputValue) {
    	openSecondModal("/static/html/cmn/modal/salesCdSearch.html", 600, 420, "Sales Code 검색", {searchValue: inputValue}, function (grid) {
            var row = grid.target.getList("selected")[0];
            console.log(row)
			$('#salesCdNm_S_Org').val(row.salesCd);
			var paramObjTopRight = {"salesCode": row.salesCd};
			postAjax("/user/sm/sm01/selectBomList", paramObjTopRight, null, function (data) {
				$("#bomClntNm").val(data.resultList[0].clntNm);
				$("#clntPjt_S_Org").val(data.resultList[0].clntPjt);
				$("#eqpNm_S").val(data.resultList[0].eqpNm);
				topLeftGrid.setData({
					list: data.resultList,
					page: {
						currentPage: data.paginationInfo.currentPageNo,
						pageSize: data.paginationInfo.pageSize,
						totalElements: data.resultList.length,
						totalPages: data.paginationInfo.totalPageCount
					}
				});
			});

        });
    }


	function opendSalesCdSearchClon(inputValue) {
		openSecondModal("/static/html/cmn/modal/salesCdSearch.html", 600, 420, "Sales Code 검색", {searchValue: inputValue}, function (grid) {
			var row = grid.target.getList("selected")[0];
			console.log(row)
			$('#salesCdNm_S_Clon').val(row.salesCd);
			/* $('#bomClntCd_S').val(row.clntCd);
            $('#bomClntNm_S').val(row.clntNm);
            gridView.setData(0); */
		});
	}

    // 거래처 검색 함수
    function openSecondClntSearch(id) {
        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: id}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#bomClntCd').val(row.clntCd);
            $('#bomClntNm').val(row.clntNm);

            var paramObj = {
                "coCd": $('#coCd').val(),
                "clntCd": row.clntCd
            }
            setMngInfo(paramObj);
            $("#bomClntNm").focus();
            $("#bomClntNm").trigger("click");
        });
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {
                $('#salesEmpId').val(data.mngInfo.salesEmpId);
                $('#salesEmpNm').val(data.mngInfo.salesEmpNm);
            } else {
                $('#salesEmpId').val("");
                $('#salesEmpNm').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch(id) {

        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        var paramObj = {
            "coCd": "GUN", //$('#coCd').val(),
            "userId": $('#salesEmpId').val(),
            "useYn": "Y",
            "searchValue": id
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#mngId").val(checkedNode.id);
            $("#mngIdVisible").val(checkedNode.text);
            // $("#salesEmpNm").val(checkedNode.text);
            $("#mngId").focus();
            $("#mngId").trigger("click");
        });
    }


    // 제품 검색 함수
    function openSecondPrdtSearch(elem) {
        $targetRow = $(elem).closbom('tr[name="detailRow"]');
        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#bomClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            // 값 초기화
            $targetRow.find('input[name]').val("");
            // input 제어
            if (row.prdtStockCd == "Y") {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", false);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", false);
                $targetRow.find('input[name="bomQty"]').attr("readonly", false);
                $targetRow.find('input[name="bomWt"]').attr("readonly", false);
            } else {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", true);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", true);
            }
            $.each(row, function (key, value) {
                if ($targetRow.find('[name="' + key + '"]')[0]) {
                    $targetRow.find('[name="' + key + '"]').val(value);
                }
            });
            $targetRow.find('input[name="bomUpr"]').val(row.ordrgUpr);

            countTot();
        });
    }
    
    // 현장 검색 함수
    function openSecondSiteSearch() {
        var paramObj = {
            "coCd": $('#popForm #coCd').val(),
            "clntCd": $('#popForm #bomClntCd').val(),
            "clntNm": $('#popForm #bomClntNm').val(),
            "insertYn": "Y",
            "isClntReq": "Y"
        }

        openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#prjctCd').val(row.siteCd);
            $('#prjctNm').val(row.siteNm);
        });
    }


    /* 기타함수 */

    // 문자열을 주어진 바이트 길이로 자르는 함수
    function cutStr(str, maxByte) {

        for (b = i = 0; c = str.charCodeAt(i);) {
            b += c >> 7 ? 2 : 1;
            if (b > maxByte)
                break;
            i++;
        }
        return str.substring(0, i);
    }

    // 견적 정보 삽입 함수
    function insertBom() {
        if ( inputValidation($('.popup_area [required]'))) {
            var formData = makeFormData();



            filePostAjax("/user/sm/sm01/insertBom", formData, function (data) {
                modalStack.close();

                if (data.resultCode==200) {
                    alert(data.resultMessage);
                    var newBomData = data.newBom // 문자열을 JSON으로 변환합니다


                    document.getElementById("coCd_S").value = document.getElementById("coCd").value
                    document.getElementById("bomNo_S").value = data.param.newBom.bomNo;
                    document.getElementById("bomDeg_S").value = data.param.newBom.bomDeg;
                    document.getElementById("strtDt_S").value="0001-01-01";
                    document.getElementById("endDt_S").value="9999-12-31";
                    gridView.setData(0);
                }
            });
        }
    }

    // 견적 정보 업데이트 함수
    function updateBom() {
        //비고 문자열 길이 필드길이로 byte 자르기
        if (validateRequiredFields() && inputValidation($('.popup_area input[required]'))) {
            var formData = makeFormData();
            filePutAjax("/user/sm/sm01/updateBom", formData, function (data) {
                if (data.resultCode == 0) {
                    alert("수주가 등록된 견적은 업데이트할 수 없습니다.");
                } else if (data.resultCode) {
                    alert(data.resultMessage);
                    document.getElementById("coCd_S").value = document.getElementById("coCd").value
                    document.getElementById("bomNo_S").value = data.param.updateBom.bomNo;
                    document.getElementById("bomDeg_S").value = data.param.updateBom.bomDeg;
                    document.getElementById("strtDt_S").value="0001-01-01";
                    document.getElementById("endDt_S").value="9999-12-31";
                    gridView.setData(0);
                    modalStack.close();
                }

            });
        }
    }

    // 폼 데이터 생성 함수
    function makeFormData() {
        var elementsToReformat = $('.popup_area input[comma], #bomAmt, #bomNegoAmt, #exrate');
        // 금액 콤마 제거
        $.each($('.popup_area input[comma], #bomAmt, #bomNegoAmt,#exrate'), function (idx, elem) {
            deleteComma(elem);
        });


        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });


        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);
        formData.append("fileTrgtKey", paramObj.fileTrgtKey);
        // 첨부파일 추가







        // 상세내역 추가
        var detailArr = [];
        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                alert(elem);
                formData.append(elem, JSON.elem.value);
            });

        });

        var rowList = topLeftGrid.getList();
        if (rowList.length == 0) {
            alert("추가할 항목을 선택해주세요_");
            return;
        }
        var detailArr = [];

        $.each(rowList, function (idx, elem) {
            var detailObj = {};
            detailObj["bomSeq"] = idx + 1;
            detailObj["matrDrwNo"] = elem.matrDrwNo;


            detailArr.push(detailObj);

        });


        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    function makeFormDataWithDeg() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#bomAmt, #bomNegoAmt,#exrate'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });

        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);
        formData.append("fileTrgtKey", paramObj.fileTrgtKey);
        // 첨부파일 추가

        $.each(newFiles, function (idx, obj) {
            // Append formData for each file
            formData.append("comonCd_" + idx, obj.comonCd);
            formData.append("filePath_" + idx, obj.filePath);
            formData.append("fileName_" + idx, obj.fileName);
            formData.append("fileKey_" + idx, obj.fileKey);
        });


        $.each(filteredFiles, function (idx, obj) {
            var newIdx = newFiles.length + idx;
            formData.append("comonCd_" + newIdx, obj.comonCd);
            formData.append("filePath_" + newIdx, obj.filePath);
            formData.append("fileName_" + newIdx, obj.fileName);
            formData.append("fileKey_" + newIdx, obj.fileKey);
        });

        //  treeModule.initFileArrays();

        // 상세내역 추가
        var detailArr = [];
        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                alert(elem);
                formData.append(elem, JSON.elem.value);
            });

        });

        var rowList = grid.getList();
        if (rowList.length == 0) {
            alert("추가할 항목을 선택해주세요_");
            return;
        }
        var detailArr = [];

        $.each(rowList, function (idx, elem) {
            var detailObj = {};
            detailObj["bomSeq"] = idx + 1;
            detailObj["bomDtlDiv"] = elem.bomDtlDiv;
            detailObj["bomComm"] = elem.bomComm;
            detailObj["bomSpec"] = elem.bomSpec;
            detailObj["bomUnit"] = elem.bomUnit;
            detailObj["bomQty"] = elem.bomQty;
            detailObj["bomUpr"] = elem.bomUpr;
            detailObj["bomRmk"] = elem.bomRmk;

            detailArr.push(detailObj);

        });


        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    // 체크박스 전체 선택/해제 함수
    function allChk(elem) {
        if ($(elem).prop("checked")) {
            $("[name='detailChkBox']").prop("checked", true);
        } else {
            $("[name='detailChkBox']").prop("checked", false);
        }
    }

    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#bomCoprt').data("rprc", value);
        $('#bomCoprt option:not([value=""])').remove()
        setCommonSelect($('#bomCoprt'));
    }


    //견적서 출력 선택 팝업 설정 함수
    function setReportPopup() {
        var paramObj = modalStack.last().paramObj;
        var iChk;
        var rptName;

        openSecondModal("/static/html/user/sm/sm01/SD0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
            var arg = "i_bom_no#" + paramObj.bomNo + "#"
                + "iChk#" + iChk + "#"
                + "imgPrt#" + imgPrt + "#";
            callReport(rptName, arg, 750, 900);
        });


    }


    /* 파일관련함수 */


    /* 리스너 */
    $(document).on("change", "input[name='bomQty'], input[name='bomWt'], input[name='bomAmt'], input[name='expAmt']", function () {

    });

    $(document).on("click", "#fileBtn", function () {
        $("#file").click();
    });
    
    /* document.ready */
    $(document).ready(function () {
    	//$("#coCd").val(jwt.coCd)
		var formData = {
			"coCd": $('#coCd_S_Clon').val(),
			"salesCd": $('#salesCdNm_S_Clon').val()
		}
		console.log("updateTopRightTableData")
		console.log(formData)
		postAjax("/user/sm/sm01/selectBomList", formData, null, function (data) {
			initTopRightTableData(data);
		});


        try {
            $("#coCd").focus();
            $("#coCd").trigger("click");
        } catch (error) {
            console.error("현재위치 로그::2" + error); // 콘솔에 에러 메시지를 출력합니다.
        }
        $('.tbody_more_btn').click(function () {
            $(this).toggleClass('on');
            $(this).parent().next('.toggle-div').toggle();
        });
        getMaxBomNumber();
        var inputIds = ['bomAmt', 'bomNegoAmt', 'exrate', 'cstmMngHp'];

        // 디바운스 함수
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                if (timeout) clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        const alertDebounced = debounce(() => alert("숫자만 입력 가능합니다."), 300);


        // 공통코드 selectBox set
        setCommonSelect($(".popup_area select[data-kind]"));

        function setCurrentDateToDatePicker(selector) {
            var currentDate = new Date();
            currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset()); // 시간대를 고려한 날짜 시간 조정
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth() + 1; // 월은 0부터 시작하므로 1을 더합니다.
            var day = currentDate.getDate();

			// 월과 일이 한 자리수라면 앞에 '0'을 추가합니다.
            if (month < 10) month = '0' + month;
            if (day < 10) day = '0' + day;

            var formattedDate = year + '-' + month + '-' + day;
            $(selector).val(formattedDate);
        }

        // 견적일자 datepicker bind
        $('#bomDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

        $('#pblsDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

        setCurrentDateToDatePicker('#bomDt');

        setCurrentDateToDatePicker('#pblsDt');

        /*    var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0
            var yyyy = today.getFullYear();

            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("bomDt").value = today;*/

        $('#bomBaseDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#issueDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#bomStdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 낙찰일자 datepicker bind
        $('#winbdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 파일 그리드 초기화
        /* 	fileGridView.initView(); */

        $('#bomDiv').on('change', function () {
            var selectedValue = $(this).val();
            if (selectedValue === 'normal') {
                $('#orgnSalesCd').prop('required', false);
            } else {
                $('#orgnSalesCd').prop('required', true);
            }
        }).trigger('change');
    });
	/* end (document).ready */
	
    function fetchCurrencyData() {
		console.log("fetchCurrencyData")
        var paramObjTopLeft = {"coCd": $('#coCd_S_Org').val(), "salesCd": $('#salesCdNm_S_Org').val()};
        var promiseTopLeft = new Promise(function (resolve, reject) {
            postAjax("/user/sm/sm01/selectBomDetailList", paramObjTopLeft, null, function (data) {
                if (data) {
                    resolve(data);
                } else {
                    console.error("topLeftGridData is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        
        var paramObjTopRight = {"coCd": ""};
        var promiseTopRight = new Promise(function (resolve, reject) {
            postAjax("/user/sm/sm01/selectBomList", paramObjTopRight, null, function (data) {
                if (data) {
                    resolve(data);
                } else {
                    console.error("topLeftGridData is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        
        return Promise.all([promiseTopLeft, promiseTopRight]);
    }
    /*  end fetchCurrencyData */
    
    fetchCurrencyData().then(function ([promiseTopLeft, promiseTopRight]) {
    	setTopLeftTableData(promiseTopLeft)
    	initTopRightTableData(promiseTopRight)
    });
    
    var topLeftGrid = new ax5.ui.grid();
    function setTopLeftTableData(data){
    	topLeftGrid.setConfig({
			showLineNumber: true,
            target: $('[data-ax5grid="top-left-grid"]'),

            columns: [

            	{key: "matrDrwNo", label: "대표도번", editor: {type: "text"}, width: 120},
                {key: "partNo", label: "PART", editor: {type: "text"}},
                {key: "unitNo", label: "UNIT", editor: {type: "text"}},
                {key: "revNo", label: "REV", editor: {type: "text"}},
                {key: "matrCd", label: "품번", editor: {type: "text"}},
                {key: "matrNm", label: "품명", editor: {type: "text"}},
                {key: "matrSaftQty", label: "수량", editor: {type: "number"}},
				{key: "upperCd", label: "상위코드", editor: {type: "text"},hidden:true},
				{key: "lowerCd", label: "하위코드", editor: {type: "text"},hidden:true},
            ],
			body: {

				onClick:function(){
					this.self.clearSelect();
					this.self.select(this.dindex);
					selectedRowKey = this.dindex;
					updateTopRightTableData(this.item.matrCd);

				},
				onDataChanged: function(){
					// 상위코드와 하위코드를 업데이트하는 로직을 여기에 작성합니다.
					// this.item에 현재 행의 데이터가 들어있습니다.
					if(this.key == "matrDrwNo" && this.value != ""){
						this.item.upperCd = this.item.matrDrwNo;
					} else if(this.key == "partNo" && this.value != ""){
						this.item.lowerCd = this.item.partNo;
					}
				}
			},
			contextMenu: {
				iconWidth: 20,
				acceleratorWidth: 100,
				itemClickAndClose: false,
				icons: {
					'arrow': '<i class="fa fa-caret-right"></i>'
				},
				items: [
					{type: 1, label: "붙여넣기"},
					{divide: true},
					{
						label: "작업선택",
						items: [
							{type: 1, label: "줄추가"},
							{type: 1, label: "내용 삭제"},
							{type: 2, label: "줄삭제"},
						]
					},
				],
				popupFilter: function (item, param) {
					//console.log(item, param);
					if (param.element) {
						return true;
					} else {
						return item.type == 1;
					}
				},

				onClick: function (item, param) {
					thisGridRow = param.dindex;
					thisGridCol = param.colIndex;

					if (item.label == "붙여넣기") {
						gridPaste(thisGridRow, thisGridCol);
					}else if (item.label == "줄추가") {
						console.log('추가 인덱스 :', param.dindex);

						let lastRow = topLeftGrid.list[param.dindex];
						let newRow = $.extend({}, lastRow, {__index: undefined, upperCd: "", lowerCd: "", partNo: "", unitNo: ""});

						if (lastRow.matrDrwNo && !lastRow.partNo) {
							newRow.upperCd = lastRow.matrDrwNo;
							newRow.matrDrwNo ="";
							newRow.matrCd ="";
							newRow.matrNm ="";
							// find max partNo
							let maxPartNo = Math.max(...topLeftGrid.list.map(row => row.partNo ? parseInt(row.partNo) : 0), 0);
							newRow.partNo = String(maxPartNo + 1000);
							newRow.lowerCd = newRow.partNo;
							topLeftGrid.addRow(newRow, topLeftGrid.list.length);
							topLeftGrid.setValue(param.dindex, 'updcheck', topLeftGrid.list.length);
						}
						// if partNo exists and unitNo doesn't
						else if (lastRow.partNo && !lastRow.unitNo) {
							newRow.upperCd = lastRow.partNo;
							// find max unitNo
							let maxUnitNo = Math.max(
									...topLeftGrid.list
											.filter(row => row.upperCd === lastRow.partNo) // Only consider rows where upperCd matches current row's partNo
											.map(row => row.unitNo ? parseInt(row.unitNo) : 0),
									0
							);
							newRow.unitNo = String(maxUnitNo + 100);
							newRow.lowerCd = newRow.unitNo;
							newRow.matrCd ="";
							newRow.matrNm ="";
							// Find the indices of all rows with this partNo
							let partNoIndices = topLeftGrid.list
									.map((row, index) => row.partNo === lastRow.partNo ? index : -1)
									.filter(index => index !== -1)
									.reverse(); // Reverse the array to get the last index first

							let maxPartNoIndex = partNoIndices.length > 0 ? partNoIndices[0] : -1;
							// Find the max index

							// Check if maxPartNoIndex + 1 is within the range of the list
							if (maxPartNoIndex + 1 <= topLeftGrid.list.length) {
								// Add the new row right after the last row with this partNo
								topLeftGrid.addRow(newRow, maxPartNoIndex + 2);
							} else {
								// If maxPartNoIndex + 1 is out of range, add the new row to the end of the list
								topLeftGrid.addRow(newRow);
							}
								topLeftGrid.setValue(param.dindex, 'updcheck', partNoIndices+1);


						}
						// unitNo가 있는 경우, 아무 작업도 하지 않습니다.
						else if (lastRow.unitNo) {
							alert("UNIT 하위 행추가 불가능합니다.")
							return;
						}


					}else if (item.label == "내용 삭제") {
						console.log('내용삭제 인덱스 :', param.dindex);

						topLeftGrid.config.columns.forEach((column) => {
							topLeftGrid.setValue(param.dindex, column.key, '');
							topLeftGrid.setValue(param.dindex, 'updcheck', 1);
							console.log('내용삭제 :', param.dindex, column.key);
						});

					} else if (item.label == "줄삭제") {
						console.log('삭제 인덱스 :', param.dindex);
						const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(topLeftGrid, param.dindex);
						const realIndex = param.dindex - subtotalRowsBeforeIndex;
						topLeftGrid.removeRow(realIndex);
					}


					topLeftGrid.contextMenu.close();
					//또는 return true;

				}
			}


		});
    	topLeftGrid.setData({
            list: data.bomList,
            page: {
                currentPage: data.paginationInfo.currentPageNo,
                pageSize: data.paginationInfo.pageSize,
                totalElements: data.bomList.length,
                totalPages: data.paginationInfo.totalPageCount
            }
        });
    }


	function setTopLeftInfo(){


		topLeftGrid.setData({
			list: data.bomList,
			page: {
				currentPage: data.paginationInfo.currentPageNo,
				pageSize: data.paginationInfo.pageSize,
				totalElements: data.bomList.length,
				totalPages: data.paginationInfo.totalPageCount
			}
		});

	}
    
    var topRightGrid = new ax5.ui.grid();
    function initTopRightTableData(data){
    	topRightGrid.setConfig({
			showLineNumber: true,
            target: $('[data-ax5grid="top-right-grid"]'),
            columns: [
            	{key: "unitNo", label: "UNIT"},
                {key: "revNo", label: "Rev"},
                {key: "matrCd", label: "품번"},
                {key: "matrNm", label: "품명"},
                {key: "matrMat", label: "소재"},
                {key: "matrMakrNm", label: "MAKER"},
                {key: "matrMno", label: "형번"},
                {key: "matrSpec", label: "규격"},
                {key: "matrSaftQty", label: "수량"}
            ]
        });
    	topRightGrid.setData({
            list: data.resultList,
            page: {
                currentPage: data.paginationInfo.currentPageNo,
                pageSize: data.paginationInfo.pageSize,
                totalElements: data.bomList.length,
                totalPages: data.paginationInfo.totalPageCount
            }
        });
    }

	function setTopRightTableData(data){

	}
	
        
    function updateTopLeftTableData(){
    	var formData = {
                "coCd": $('#coCd_S_Org').val(),
                "salesCd": $('#salesCdNm_S_Org').val()
        }
    	
    	postAjax("/user/sm/sm01/selectBomDetailList", formData, null, function (data) {
    		setTopLeftTableData(data);
    	});
    }
    
    function updateTopRightTableData(matrCd){
    	var formData = {
                "matrCd": matrCd
        }
    	console.log("updateTopRightTableData")
    	console.log(formData)
    	postAjax("/user/bm/bm05/selectBmMstrList", formData, null, function (data) {
			topRightGrid.setData({
				list: data.resultList,
				page: {
					currentPage: data.paginationInfo.currentPageNo,
					pageSize: data.paginationInfo.pageSize,
					totalElements: data.resultList.length,
					totalPages: data.paginationInfo.totalPageCount
				}
			});


		});
    }
    
    /* fetchCurrencyData().then(function ([promiseTopLeft, promiseTopRight, promiseBottomLeft, promiseBottomRight]) {
		var topRightGrid = new ax5.ui.grid();
		topRightGrid.setConfig({
            target: $('[data-ax5grid="top-right-grid"]'),
            columns: [
            	{key: "unitNo", label: "UNIT"},
                {key: "revNo", label: "Rev"},
                {key: "matrCd", label: "품번"},
                {key: "matrNm", label: "품명"},
                {key: "matrMat", label: "소재"},
                {key: "matrMakrNm", label: "MAKER"},
                {key: "matrMno", label: "형번"},
                {key: "matrSpec", label: "규격"},
                {key: "matrSaftQty", label: "수량"}
            ]
        });
		topRightGrid.setData({
            list: promiseTopRight.bomList,
            page: {
                currentPage: promiseTopRight.paginationInfo.currentPageNo,
                pageSize: promiseTopRight.paginationInfo.pageSize,
                totalElements: promiseTopRight.bomList.length,
                totalPages: promiseTopRight.paginationInfo.totalPageCount
            }
        });
    }); */

    let selectedRowKey;
    let previousSelectedRowKey;
    let selectedPrdtCd;
    let selectedPrdtNm;
	const thirdgrid = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2]) {
    	thirdgrid.setConfig({
            target: $('[data-ax5grid="third-grid"]'),
            columns: [
                {
                    key: "bomSeq", label: "번호", width: 40, align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },

                {
                    key: "bomDtlDiv", label: "UNIT", width: 80, align: "center", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options2,


                        }
                    }
                },
                {
                    key: "bomComm", label: "Rev", align: "center", width: 80, editor: {
                        type: "text"
                    }
                },
                {key: "bomSpec", label: "품번", align: "center", width: 80, editor: {type: "text"}},
                {
                    key: "bomUnit", label: "품명", align: "center", width: 80, editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options // 서버에서 가져온 데이터를 사용
                        },
                        event: {
                            'blur': function () {
                                // logic to select the next input field and focus it
                            },
                            'keydown': function (e) {
                                if (e.keyCode == 9) { // tab key
                                    // logic to select the next input field and focus it
                                }
                            }
                        }
                    }
                },
                {key: "bomQty", label: "소재", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {key: "bomUpr", label: "MAKER", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {
                    key: "bomAmt", label: "형번", width: 100, align: "right", formatter: function () {
                        color = '#0000FF';
                        const sumBom = this.item.bomQty * this.item.bomUpr;
                        return '<div style="color: ' + color + '">' + sumBom.toLocaleString('en-US') + '</div>';
                    }
                },
                {key: "bomUpr", label: "규격", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {key: "bomUpr", label: "수량", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
            ],

            footSum: [
                [
                    {label: "총합계", align: "center", colspan: 7},
                    {key: "bomAmtAll", collector: "sum", formatter: "money", align: "right"},
                ]
            ],
            body: {
                grouping: {
                    by: ["bomDtlDiv"],
                    columns: [
                        {label: "소계", colspan: 7, align: "center"},
                        {
                            key: "bomAmtMid",
                            collector: function () {
                                let sum = 0;
                                this.list.forEach(function (n) {
                                    if (!n.__grouping) sum += n.bomQty * n.bomUpr;
                                });
                                return sum;
                                //중간소계
                            },
                            formatter: "money",
                            align: "right",
                        },
                    ],

                },
                onClick: function () {
                    this.self.clearSelect();
                    this.self.select(this.dindex);
                    const subtotalRowsBeforeIndexEs = countSubtotalRowsBeforeIndexBom(this, this.dindex);
                    const realIndex = this.dindex - subtotalRowsBeforeIndexEs;
                    selectedRowKey = realIndex;

                    if (this.column.key == 'bomComm') {
                        var _this = this;

                        // 선택된 행의 "bomDtlDiv"값을 가져옵니다.
                        let bomDtlDivValue = thirdgrid.list[selectedRowKey].bomDtlDiv;

                        // 만약 "bomDtlDiv"값이 "제작품"이라면 openPrdtSearch 함수를 호출합니다.

                    }

                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons: {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter: function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        thirdgrid.addRow($.extend({}, thirdgrid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        thirdgrid.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        grid.config.columns.forEach((column) => {
                        	thirdgrid.setValue(param.dindex, column.key, '');
                        	thirdgrid.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        const subtotalRowsBeforeIndexBom = countSubtotalRowsBeforeIndexBom(thirdgrid, param.dindex);
                        const realIndexBom = param.dindex - subtotalRowsBeforeIndexBom;
                        thirdgrid.removeRow(realIndexBom);
                    }


                    thirdgrid.contextMenu.close();
                    //또는 return true;

                }
            }

        });
    	thirdgrid.setColumnSort({
            "bomSeq": {orderBy: "asc", seq: 0},
        });
        let isUpdating = false;  // isUpdating 플래그 선언
        thirdgrid.onDataChanged = function () {

            if (this.item.bomDtlDiv == undefined || isUpdating) {
                return;
            } else {
                isUpdating = true;  // 업데이트 시작을 표시

                const data = thirdgrid.getList();
                data.forEach((item, index) => {
                    item.bomAmtAll = item.bomQty * item.bomUpr;  // 합계 계산 및 설정
                });
                thirdgrid.setData({
                    list: data,
                    page: {
                        totalElements: data.length
                    }
                });
                isUpdating = false;  // 업데이트 종료를 표시
            }


        };
        let checkDataInterval = null;

        thirdgrid.onLoad = function () {
            checkDataInterval = setInterval(() => {
                const dataBom = thirdgrid.getList();

                // 데이터가 로드되었는지 확인합니다.
                if (dataBom.length > 0) {
                    clearInterval(checkDataInterval);  // 데이터가 로드되었다면 체크를 중단합니다.

                    dataBom.forEach((item, index) => {
                        item.bomAmtAll = item.bomQty * item.bomUpr;  // 합계 계산 및 설정
                    });


                    thirdgrid.setData({
                        list: dataBom,
                        page: {
                            totalElements: dataBom.length
                        }
                    });
                }
            }, 100);  // 1초 간격으로 체크합니다.
        };

    })
    /* end fetchCurrencyData */

    const wstgrid = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2]) {
    	wstgrid.setConfig({
            target: $('[data-ax5grid="second-grid"]'),
            columns: [
                {
                    key: "bomSeq", label: "번호", width: 40, align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },

                {
                    key: "bomDtlDiv", label: "대표도번", width: 120, align: "center", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options2,


                        }
                    }
                },
                {
                    key: "bomComm", label: "PART", align: "center", width: 80, editor: {
                        type: "text"
                    }
                },
                {key: "bomSpec", label: "UNIT", align: "center", width: 80, editor: {type: "text"}},
                {
                    key: "bomUnit", label: "RE", align: "center", width: 80, editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options // 서버에서 가져온 데이터를 사용
                        },
                        event: {
                            'blur': function () {
                                // logic to select the next input field and focus it
                            },
                            'keydown': function (e) {
                                if (e.keyCode == 9) { // tab key
                                    // logic to select the next input field and focus it
                                }
                            }
                        }
                    }
                },
                {key: "bomQty", label: "품번", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {key: "bomUpr", label: "품명", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {
                    key: "bomAmt", label: "수량", width: 100, align: "right", formatter: function () {
                        color = '#0000FF';
                        const sum = this.item.bomQty * this.item.bomUpr;
                        return '<div style="color: ' + color + '">' + sum.toLocaleString('en-US') + '</div>';
                    }
                },
               
            ],

            footSum: [
                [
                    {label: "총합계", align: "center", colspan: 7},
                    {key: "bomAmtAll", collector: "sum", formatter: "money", align: "right"},
                ]
            ],
            body: {
                grouping: {
                    by: ["bomDtlDiv"],
                    columns: [
                        {label: "소계", colspan: 7, align: "center"},
                        {
                            key: "bomAmtMid",
                            collector: function () {
                                let sum = 0;
                                this.list.forEach(function (n) {
                                    if (!n.__grouping) sum += n.bomQty * n.bomUpr;
                                });
                                return sum;
                                //중간소계
                            },
                            formatter: "money",
                            align: "right",
                        },
                    ],

                },
                onClick: function () {
                    this.self.clearSelect();
                    this.self.select(this.dindex);
                    const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(this, this.dindex);
                    const realIndex = this.dindex - subtotalRowsBeforeIndex;
                    selectedRowKey = realIndex;
                    if (this.column.key == 'bomComm') {
                        var _this = this;

                        // 선택된 행의 "bomDtlDiv"값을 가져옵니다.
                        //let bomDtlDivValue = grid.list[selectedRowKey].bomDtlDiv;

                        // 만약 "bomDtlDiv"값이 "제작품"이라면 openPrdtSearch 함수를 호출합니다.

                    }

                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons: {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter: function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        wstgrid.addRow($.extend({}, wstgrid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        wstgrid.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        wstgrid.config.columns.forEach((column) => {
                        	wstgrid.setValue(param.dindex, column.key, '');
                        	wstgrid.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(wstgrid, param.dindex);
                        const realIndex = param.dindex - subtotalRowsBeforeIndex;
                        wstgrid.removeRow(realIndex);
                    }


                    wstgrid.contextMenu.close();
                    //또는 return true;

                }
            }

        });
        wstgrid.setColumnSort({
            "bomSeq": {orderBy: "asc", seq: 0},
        });
        let isUpdating = false;  // isUpdating 플래그 선언
        wstgrid.onDataChanged = function () {

            if (this.item.bomDtlDiv == undefined || isUpdating) {
                return;
            } else {
                isUpdating = true;  // 업데이트 시작을 표시

                const data = wstgrid.getList();
                data.forEach((item, index) => {
                    item.bomAmtAll = item.bomQty * item.bomUpr;  // 합계 계산 및 설정
                });
                wstgrid.setData({
                    list: data,
                    page: {
                        totalElements: data.length
                    }
                });
                isUpdating = false;  // 업데이트 종료를 표시
            }


        };
        let checkDataInterval = null;

        wstgrid.onLoad = function () {
            checkDataInterval = setInterval(() => {
                const data = wstgrid.getList();

                // 데이터가 로드되었는지 확인합니다.
                if (data.length > 0) {
                    clearInterval(checkDataInterval);  // 데이터가 로드되었다면 체크를 중단합니다.

                    data.forEach((item, index) => {
                        item.bomAmtAll = item.bomQty * item.bomUpr;  // 합계 계산 및 설정
                    });


                    wstgrid.setData({
                        list: data,
                        page: {
                            totalElements: data.length
                        }
                    });
                }
            }, 100);  // 1초 간격으로 체크합니다.
        };

    })// end fetchCurrencyData
    
    function countSubtotalRowsBeforeIndex(wstgrid, index) {
        let count = 0;
        for (let i = 0; i < index; i++) {
            if (wstgrid.list[i].__isGrouping) {
                count++;
            }
        }
        return count;
    }
    
    function countSubtotalRowsBeforeIndexBom(grid, index) {
        let count = 0;
        for (let i = 0; i < index; i++) {
            if (grid.list[i].__isGrouping) {
                count++;
            }
        }
        return count;
    }


    function updateRowTotals() {

    }


    function addBomDtlDivData(bomDtlDivData) {
        const data = wstgrid.getList();
        wstgrid.setData([...data, ...bomDtlDivData]);

        updateRowTotals();
    }

    let currentDivCount = 0;


    $("#addProductButton").on("click", function () {
        var row;
        var newRowData = {
            bomDtlDiv: "",
            bomComm: "",
            bomSpec: "",
            bomUnit: "",
            bomQty: "",
            bomUpr: "",
        };

        // 첫 번째 경우: 선택된 행이 있는 경우
        if (selectedRowKey !== undefined) {
            let row = wstgrid.getList("selected")[0];
            let newRowData = $.extend({}, row, {__index: undefined});
            wstgrid.addRow(newRowData, row.__index + 1);
        }
        // 두 번째 경우: 그리드가 비어 있는 경우
        else if (wstgrid.getList().length === 0) {
        	wstgrid.addRow(newRowData, 0);
        }
        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
        else {
        	wstgrid.addRow(newRowData, wstgrid.length);
            return;
        }

        const data = wstgrid.getList();
        wstgrid.setData({
            list: data,
            page: {
                totalElements: data.length
            }
        });
    }); // end addProductButton
    
    $("#deleteProductButton").on("click", function () {
        if (selectedRowKey !== undefined) {
        	wstgrid.removeRow(selectedRowKey);
            const data = wstgrid.getList();
            wstgrid.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                	wstgrid.select(selectedRowKey);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey = selectedRowKey - 1;
                    wstgrid.select(selectedRowKey);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });// end deleteProductButton

    function addBomDtlDivWithPreset() {

        const bomDtlDivData = [
            {
                bomDtlDiv: "제작품",
                bomComm: "",
                bomSpec: "",
                bomUnit: "",
                bomQty: "",
                bomUpr: "",
            },
            {
                bomDtlDiv: "기타경비",
                bomComm: "",
                bomSpec: "",
                bomUnit: "",
                bomQty: "",
                bomUpr: "",
            },



        ];

        addBomDtlDivData(bomDtlDivData);
    }


    var actionType = modalStack.last().paramObj.actionType;
    var paramObj = modalStack.last().paramObj;


    if (actionType == "C") {
        $(document).ready(function () {


            postAjaxSync("/admin/cm/cm06/selectUserInfo", {"userId": jwt.userId}, null, function (data) {
                $("#mngIdVisible").val(data.userInfo.name);
                $("#mngId").val(data.userInfo.id);
            });
            $("#exrate").val(1);
            $('#bomDeg').val(1);
            $('#bomAmt').val(0);
            $('#bomYn').val('N');
            $('#bomNegoAmt').val(0);
        })

        $('#actionBtn').on("click", function () {
            insertBom();
        });
        addBomDtlDivWithPreset();


    } else if (actionType == "U") {


        var parsedDataInfo
        postAjax("/user/sm/sm01/selectBomInfo", paramObj, null, function (data) {
            var parsedData = data;
            Object.keys(parsedData.bomInfo).forEach(function (key) {
                var inputField = document.getElementById(key);
                if (inputField) {
                    if (key == 'mngId') {
                        var mngIdField = document.getElementById('mngId');
                        var mngIdVisibleField = document.getElementById('mngIdVisible');
                        mngIdField.value = parsedData.bomInfo[key];
                        if (mngIdVisibleField) {
                            var paramObj = {
                                "userId": parsedData.bomInfo[key],
                            };
                            postAjaxSync("/admin/cm/cm06/selectUserInfo", paramObj, null, function (data) {
                                mngIdVisibleField.value = data.userInfo.name;
                            });
                        }
                    } else if (key == 'bomClntCd') {
                        var bomClntNmField = document.getElementById('bomClntNm');
                        var bomClntCdField = document.getElementById('bomClntCd');
                        bomClntCdField.value = parsedData.bomInfo[key];
                        if (bomClntNmField) {

                            var paramObj = {
                                "clntCd": parsedData.bomInfo[key],
                            };
                            postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function (data) {
                                bomClntNmField.value = data.clntInfo.clntNm;
                            });

                        }
                    } else {
                        if (key == 'bomAmt' || key == 'bomNegoAmt' || key == 'exrate') {
                            // If the key is one of the specified ones, add commas every three digits.
                            var value = parsedData.bomInfo[key];
                            if (value != null && value != '') {
                                value = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            }
                            inputField.value = value || '';
                        } else {
                            inputField.value = parsedData.bomInfo[key] || '';
                        }

                    }



                }
            });
            var degUpBtn = document.getElementById("degUpBtn");
            var bomBtn = document.getElementById("bomBtn");

            if (document.getElementById('bomYn').value == 'Y') {
                degUpBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                degUpBtn.disabled = true; // 버튼을 비활성화
                bomBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                bomBtn.disabled = true; // 버튼을 비활성화


            } else {
                degUpBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                degUpBtn.disabled = false; // 버튼을 활성화
                bomBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                bomBtn.disabled = false; // 버튼을 활성화
            }


            var list = data.bomInfo.list;

            wstgrid.setData({
                list: list,
                page: {
                    totalElements: list.length
                }
            });

        });


        $('#actionBtn').on("click", function () {
            updateBom();
        });
        document.getElementById("degUpBtn").addEventListener("click", function () {
            event.preventDefault();
            var bomDegInput = document.getElementById("bomDeg");
            var currentValue = parseInt(bomDegInput.value, 10) || 0;
            var tempBomDtValue = $("#bomDt").val();
            var tempIssueDateValue = $("#bomDt").val();
            insertBomNew().then((response) => {
                if (response && response.hasOwnProperty('bomDeg') && !isNaN(parseInt(response.bomDeg))) {
                    alert("차수가 업데이트 되었습니다.");

                    $("#bomDt").val(tempBomDtValue);
                    $("#issueDate").val(tempIssueDateValue);
                    document.getElementById("bomDeg").value = response.bomDeg;
                    loadBomDegrees();
                    document.getElementById("coCd_S").value = document.getElementById("coCd").value
                    document.getElementById("bomNo_S").value = $("#bomNo").val();
                    document.getElementById("bomDeg_S").value = response.bomDeg;
                    document.getElementById("strtDt_S").value="0001-01-01";
                    document.getElementById("endDt_S").value="9999-12-31";
                    gridView.setData(0);


                } else {
                    alert("차수가 업데이트 되지않았습니다.");

                }
            });
            // 차수 증가 버튼이 클릭되었음을 표시합니다.

        });
    }


    function insertBomNew() {
        return new Promise((resolve, reject) => {
            if (validateRequiredFields() && inputValidation($('.popup_area [required]'))) {
                var formData = makeFormDataWithDeg();

                filePostAjax("/user/sm/sm01/insertBomDeg", formData, function (data) {
                    if (data.resultCode == 200) {

                        resolve({bomDeg: data.param.newBom}); //
                        loadBomDegrees()

                    } else {
                        // 실패한 경우 에러 메시지를 반환합니다.
                        reject("차수가 업데이트 되지 않았습니다."); // Prom

                    }
                });

            }
        });
    }

    function insertOrdrsModal() {
        var paramObj = {
            "actionType": "DC",
            "coCd": $("#coCd").val(),
            "bomNo": $("#bomNo").val(),
            "bomClntCd": $("#bomClntCd").val(),
            "bomClntNm": $("#bomClntNm").val(),
            "clntPjt": $("#bomClntNm").val(),
            "mngId": $("#cstmMngNm").val(),
            "exrate": $("#cstmMngHp").val(),
            "clntPjt": $("#clntPjt").val()

        };
        mask = new ax5.ui.mask();
        modal = new ax5.ui.modal();
        modalStack = new ModalStack();

        openModal("/static/html/user/cr/cr02/CR0202P01.html", 1400, 736, "", paramObj);

    }

    document.getElementById("bomBtn").addEventListener("click", function () {
        event.preventDefault();
        modalStack.close();
        insertOrdrsModal();
    });

    function addComma(elem) {
        // elem.value는 숫자가 아닐 수 있으므로, NaN이 리턴되는 경우 원래의 값을 사용
        var value = parseFloat(elem.value.replace(/,/g, ''));
        if (isNaN(value)) value = elem.value;

        // 콤마를 추가
        elem.value = value.toLocaleString();
    }

    function validateRequiredFields() {

        const gridIn = wstgrid.getList();

        for (let i = 0; i < gridIn.length; i++) {
            const row = gridIn[i];
            // 필수 입력 필드 검사
            if (!row.bomComm || !row.bomSpec || !row.bomUnit || !row.bomQty ||
                !row.bomUpr) {
                alert(`견적 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
                return false;
            }

        }

        return true;
    }

    function openPrdtSearch(gridIn) {
        var paramObj = {
            "coCd": $('#coCd').val(),
            "prdtCd": $('#prdtId_S').val(),
            "prdtNm": $('#prdtNm_S').val(),
            "useYn": "Y"
        }
        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid2) {
            var row = grid2.target.getList("selected")[0];
            gridIn.item.bomComm = row.prdtNm;
            gridIn.self.repaint();

        });
    }

	// 거래처 검색 함수
	function opendClntSearch(inputValue) {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: inputValue}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#bomClntCd_S').val(row.clntCd);
			$('#bomClntNm_S').val(row.clntNm);
			gridView.setData(0);
		});
	}

	function addRow() {
		let param = {dindex: selectedRowKey};

		// 행이 없거나 셀렉트키가 없는 경우에는 새로운 행을 추가하고 종료
		if (topLeftGrid.list.length === 0 || typeof selectedRowKey === 'undefined') {
			let newRow = {__index: undefined, upperCd: "", lowerCd: "", partNo: "", unitNo: ""};
			topLeftGrid.addRow(newRow);
			return;
		}

			console.log('추가 인덱스 :', param.dindex);

			let lastRow = topLeftGrid.list[param.dindex];
			let newRow = $.extend({}, lastRow, {__index: undefined, upperCd: "", lowerCd: "", partNo: "", unitNo: ""});

			if (lastRow.matrDrwNo && !lastRow.partNo) {
				newRow.upperCd = lastRow.matrDrwNo;
				newRow.matrDrwNo ="";
				let maxPartNo = Math.max(...topLeftGrid.list.map(row => row.partNo ? parseInt(row.partNo) : 0), 0);
				newRow.partNo = String(maxPartNo + 1000);
				newRow.lowerCd = newRow.partNo;
				topLeftGrid.addRow(newRow, topLeftGrid.list.length);
				topLeftGrid.setValue(param.dindex, 'updcheck', topLeftGrid.list.length);
			}
			else if (lastRow.partNo && !lastRow.unitNo) {
				newRow.upperCd = lastRow.partNo;
				let maxUnitNo = Math.max(
						...topLeftGrid.list
								.filter(row => row.upperCd === lastRow.partNo)
								.map(row => row.unitNo ? parseInt(row.unitNo) : 0),
						0
				);
				newRow.unitNo = String(maxUnitNo + 100);
				newRow.lowerCd = newRow.unitNo;
				let partNoIndices = topLeftGrid.list
						.map((row, index) => row.partNo === lastRow.partNo ? index : -1)
						.filter(index => index !== -1)
						.reverse();

				let maxPartNoIndex = partNoIndices.length > 0 ? partNoIndices[0] : -1;

				if (maxPartNoIndex + 1 <= topLeftGrid.list.length) {
					topLeftGrid.addRow(newRow, maxPartNoIndex + 2);
				} else {
					topLeftGrid.addRow(newRow);
				}
				topLeftGrid.setValue(param.dindex, 'updcheck', partNoIndices+1);
			}



	}
	function addRightGridRow() {
		let newRow = {__index: undefined};
		topRightGrid.addRow(newRow);
	}
	function removeRightGridRow() {

		topRightGrid.removeRow();
	}
</script>
</html>
