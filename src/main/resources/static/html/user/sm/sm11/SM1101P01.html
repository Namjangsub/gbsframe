<style>
    .checkbox-container input[type="checkbox"] {
        vertical-align: text-top;
        margin-left: 10px;/* 선택 박스와 텍스트 사이의 간격 조정 */
    }
</style>
<div id="popDivSM11" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">외주관리 등록</h4>
    </div>

  <form id="popFormSM11" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="SM1101P01">
		<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
		<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->		
 		<table>

        <colgroup>
          <col width="10%">
          <col width="23%">
          <col width="11%">
          <col width="23%">
          <col width="10%">
          <col width="23%">
          <col width="10%">
          <col width="23%">
        </colgroup>

        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
				</select>
			</td>
			<th>계약번호</th>
			<td>
				<input type="text"  id="ctrtNo" name="ctrtNo" readonly="readonly">
			</td>
			<th>고객사</th>
			<td><input type="hidden" id="clntCd" name="clntCd" msg="고객사">
				<input type="text" id="clntNm" name="clntNm" msg="고객사" class="form-control" readonly>
			</td>
			<th>고객사PJT</th>
			<td><input type="hidden" id="clntPjt" name="clntPjt" msg="고객사PJT">
				<input type="text" id="clntPjtNm" name="clntPjtNm" msg="고객사PJT" class="form-control"> 
			</td>

        </tr>

        <tr>
			<th class="hit">수주번호</th>
			<td>
				<div class="search_form" >
					<input type="hidden"  id="ordrsCoCd" name="ordrsCoCd"  readonly="readonly">
					<input type="text"  id="ordrsNo" name="ordrsNo" readonly="readonly" required msg="수주번호">
					<a onclick="popOpendOrdrsSearch($('#ordrsNo').val(), $('#coCd').val());"><i class="i_search_w" ></i></a>
				</div>
			</td>
			<th>발주요청번호</th>
			<td>
				<div class="search_form" >
					<input type="text"  id="reqNo" name="reqNo" readonly="readonly" msg="발주요청번호">
					<a id="reqNoBtn" onclick="openPurchaseSearch();"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th class="hit">프로젝트명</th>
			<td colspan=3>
				<input type="text" id="ctrtNm" name="ctrtNm" msg="프로젝트명" class="form-control" required> 
			</td>

        </tr>
        <tr>
			<th class="hit">사전품의번호</th>
			<td>
				<input id="ctrtApprovalNo" name="ctrtApprovalNo"  class="form-control" required msg="사전품의번호" title="건양아이티티 수주건을 트루넷에서 처리할경우 필수 등록번호입니다. 회계팀에서 채번하여 관리함.">
			</td>
			<th class="hit">관리부서</th>
			<td>
				<select id="mngDeptCd" name="mngDeptCd" class="form-control" data-search="mngDeptCd" required msg="관리부서">
					<option value="TRN30">트루넷직접매출</option>
					<option value="TRN50">트루넷외주구매팀</option>
				</select>
			</td>
			<th></th>
			<td></td>
			<th></th>
			<td></td>
        </tr>
        <tr>
			<th class="hit">계약일자</th>
			<td>
				<input id="ctrtDt" name="ctrtDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date onchange="monthCloseChk(this.value,'', $('#coCd').val());">
			</td>
			<th  class="">외주총금액</th>
			<td>
				<input type="text" id="ctrtTotAmt" name="ctrtTotAmt" class="form-control" onkeyup="chechChange(this);" comma readonly msg="외주총금액">
			</td>
			<th>지급조건</th>
			<td>
	            <select id="ctrtPmntMtdCd" name="ctrtPmntMtdCd" class="form-control" data-kind="PMNTMTD" msg="지급조건">
	            </select>
			</td>
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" class="form-control" required msg="통화단위">
				</select>
			</td>
        </tr>

        <tr>
			<th class="hit">계약업체</th>
			<td>
				<div class="search_form">
				<input type="hidden" id="vendCd" name="vendCd" required msg="계약업체">
					<input type="text" id="vendNm" name="vendNm"  onkeyup="event.keyCode == 8 ? vendCd.value = '' : event.keyCode == 13 ? clntSearch() : ''" required msg="계약업체">
						<a onclick="clntSearch();"><i class="i_search_w"></i></a>
				</div>
			<th  class="">Nego금액</th>
			<td>
				<input type="text" id="ctrtNegoAmt" name="ctrtNegoAmt" class="form-control" onkeyup="chechChange(this);" comma msg="Nego금액">
			</td>
			<th class="hit">결제일자</th>
			<td>
	            <select id="ctrtClmnDay" name="ctrtClmnDay" class="form-control" required msg="결제일자">
	            	<option value="10">10일 결제</option>
	            	<option value="25" selected>25일 결제</option>
	            </select>
			</td>
			<th class="hit">환율</th>
			<td>
				<input type="text" id="exrate" name="exrate" class="form-control" onkeyup="chechChange(this);" comma required msg="환율">
			</td>
        </tr>

        <tr>
            <th class="hit" title="담당자 정보를 확인합니다">담당자</th>
            <td>
                <div class="search_form">
                    <input type="text" id="mngIdNm" name="mngIdNm" onkeydown="if(event.keyCode==13)openUserTree( this.value);" required>
                    <input type="hidden" id="mngId" name="mngId" required msg="담당자">
                    <input type="hidden" id="deptId" name="deptId" msg="부서코드">
					<a onclick="openUserTree( document.getElementById('mngIdNm').value);"><i class="i_search_w"></i></a>
                </div>
            </td>
			<th  class="hit">계약금액</th>
			<td>
				<input type="text" id="ctrtAmt" name="ctrtAmt" class="form-control" onkeyup="chechChange(this);" comma required msg="계약금액">
			</td>
			<th>결제방법</th>
			<td>
	            <select id="ctrtClmnDivCd" name="ctrtClmnDivCd" class="form-control" msg="결제방법">
	            	<option value="CLMNDIV04" data-rprc="MON" data-etc="1" data-desc="수금조건" data-dz-code="undefined">익월</option>
	            </select>
			</td>
			
			<th>부가세</th>
			<td>
				<select class="form-control input-sm" id="ctrtClmnVat" name="ctrtClmnVat" data-kind="VAT">
				</select>
			</td>
			<th></th>
			<td></td>
        </tr>
        
        <tr>
			<th>발주서</th>
			<td>
				<input id="ctrtOrdrsDt" name="ctrtOrdrsDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  date>
			</td>
			<th>계약이행</th>
			<td>
				<input id="ctrtPfmcDt" name="ctrtPfmcDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  date>
			</td>
			<th>선급이행</th>
			<td>
				<input id="ctrtBfPfmcDt" name="ctrtBfPfmcDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  date>
			</td>
			<th>하자이행</th>
			<td>
				<input id="ctrtAfPfmcDt" name="ctrtAfPfmcDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  date>
			</td>
        </tr>

        <tr>
			<th>납기일자</th>
			<td>
				<input id="dudtIntendDt" name="dudtIntendDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" date>
			</td>
			<th>공급사담당자</th>
			<td>
				<input type="text" class="form-control" id="vendMngNm" name="vendMngNm">
			</td>
			<th>전화</th>
			<td>
				<input type="text" class="form-control" id="vendTelNo" name="vendTelNo" onkeyup="telNumberFormatter(this);" maxlength="13">
			</td>
			<th>FAX</th>
			<td>
				<input type="text" class="form-control" id="vendFaxNo" name="vendFaxNo" onkeyup="telNumberFormatter(this);" maxlength="13">
			</td>
        </tr>
        <tr>
			<th>품목</th>
			<td colspan = 3>
			<div class="checkbox-container">
				<input type="checkbox" id="CTRITEM01" name="ctrtItem" value="CTRITEM01" data-label="설계"> 설계 
				<input type="checkbox" id="CTRITEM02" name="ctrtItem" value="CTRITEM02" data-label="제작"> 제작
				<input type="checkbox" id="CTRITEM03" name="ctrtItem" value="CTRITEM03" data-label="공사건"> 공사건
				<input type="checkbox" id="CTRITEM04" name="ctrtItem" value="CTRITEM04" data-label="슈퍼바이저"> 슈퍼바이저
				<input type="checkbox" id="CTRITEM05" name="ctrtItem" value="CTRITEM05" data-label="A/S"> A/S
				<input type="checkbox" id="CTRITEM06" name="ctrtItem" value="CTRITEM06" data-label="단품티칭"> 단품티칭
				<input type="checkbox" id="CTRITEM07" name="ctrtItem" value="CTRITEM07" data-label="외주용역"> 외주용역
				<input type="checkbox" id="CTRITEM99" name="ctrtItem" value="CTRITEM99" data-label="기타"> 기타
			</div>
			</td>
			<th>휴대폰</th>
			<td>
				<input type="text" class="form-control" id="vendHpNo" name="vendHpNo" onkeyup="telNumberFormatter(this);" maxlength="13">
			</td>
			<th>E-Mail</th>
			<td>
				<input type="text" class="form-control" id="vendMngMail" name="vendMngMail">
			</td>
        </tr>
        <tr>
        	<th>비고</th>
			<td colspan="7">
				<textarea class="form-control" id="ctrtRmk" name="ctrtRmk" msg="비고" style="height: 60px;" maxlength="500"></textarea>
			</td>			
        </tr>
      </table>
      
	<div class="contents_tit" style="margin-bottom: 0px; padding-top: 5px;"">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※ 지급 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10">
			<a id="addPaymentButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deletePaymentButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>

		<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"style="height: 180px; width: 100%"></div>
      	<div id="turnKeyGrid" class="ax5_grid" data-ax5grid="turnKey-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
    </form>

	<!-- 공통 파일 영역 -->
	<div id="fileList_area_SM11" style="margin-bottom: 30px;"></div>
	

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
<!-- 		<button type="button" id="mailSendBtn" onclick="sendMailCall();" authChk><i class="fas fa-envelope"></i> 기타발주서메일</a></button> -->
	</div>

</div>
<script type="text/javascript">

	/***********전역변수****************/
	let selectedRowKey;
	let actionType = null;
	let fileTrgtKey = null;
	
	const comboClmnPlanDiv = [...setComboOptionCode('PCHSCOSTDIV20')];
	const comboCtrtPmntMtdCd = [...setComboOptionCode('PMNTMTD')];
	const comboCtrtClmnDay = [{"CD": "10","NM": "10일 결제"},{"CD": "25","NM": "25일 결제"}];
    function setComboOptionCode(selectComobo) {
        var optionCode = [];
        postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : selectComobo} , null, function(data) {
            var codeList = data.childCodeList;
            $.each(codeList, function (index, item) {
                let tempCode = {
                    'CD' : item.codeId,
                    'NM' : item.codeNm
                }
                optionCode.push(tempCode);
            });
        })
        return optionCode;
    }  

    
    //Select 선택 코드값 체크하여 명을 출력
    function getComboName(comboArray, key) {
	    let rtnNm = "";
	    for (const element of comboArray) {
            if (key.value == element.CD) {
                rtnNm = element.NM;
                break;
            }
        }
        return rtnNm;
    }
    
	/* 그리드 관련 함수 */
	// 그리드 생성
	var gridClmnPlan = new ax5.ui.grid();
	gridClmnPlan.setConfig({
	    target : $('[data-ax5grid="first-grid-modal"]'),
	    header: {
	        align: "center",
	        selector: false
	    },
	    columns: [
	        {key: "seq", 			label: "번호", 		width: 40, align: "center", formatter: function () {return this.item.__index + 1;},},
// 	        {key: "ctrtNoSeq", 		label: "수금계획번호", 	width: 40, align: "center", },
            { key: "clmnPlanDiv",   label: "수금구분", align: "center",  width: 70,
                editor: {
                    type: 'select', config: {
                        columnKeys: { optionValue: 'CD', optionText: 'NM' },
                        options : comboClmnPlanDiv
                    }, disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;},
                },
                formatter : function() {
                    return getComboName(comboClmnPlanDiv, this)
                }
            },
	        {key: "clmnDivSeq", 	label: "차수", 		width: 50, align: "center", editor: {type: "text", disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}}},
	        {key: "clmnRate", 		label: "비율", 		width: 50, align: "center", editor: {type: "number", disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}}},
	        {key: "clmnAmt",		label: "결제계획금액", width: 110, align: "right", editor: {type: "number", disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}}, formatter: "money"},
	        {key: "clmnDt", 		label: "결제예정일자", width: 100, align: "center",
	            editor: {type: "date", config: {content: {config: { mode: "day", selectMode: "day" }}}, disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}}},
//  	        {key: "ctrtClmnDay",   label: "지급일자", width: 80, align: "center", editor: {type: "number", disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}}},
            { key: "ctrtClmnDay",   label: "지급일자", align: "center",  width: 70,
                editor: {
                    type: 'select', config: {
                        columnKeys: { optionValue: 'CD', optionText: 'NM' },
                        options : comboCtrtClmnDay
                    }, disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;},
                },
                formatter : function() {
                    return getComboName(comboCtrtClmnDay, this)
                }
            },
            { key: "ctrtPmntMtdCd",   label: "지급조건", align: "center",  width: 70,
                editor: {
                    type: 'select', config: {
                        columnKeys: { optionValue: 'CD', optionText: 'NM' },
                        options : comboCtrtPmntMtdCd
                    }, disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;},
                },
                formatter : function() {
                    return getComboName(comboCtrtPmntMtdCd, this)
                }
            },
// 	        {key: "pmntDtAfterBill", label: "계산서발행후(일)", width: 100, align: "center", editor: {type: "number", disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}}},
// 	        {key: "billPblsDt", 	label: "계산서발행예정일", width: 100, align: "center",
// 	            editor: {type: "date", config: {content: {config: { mode: "day", selectMode: "day" }}}, disabled: function () {return (this.item.매입등록금액 > 0 ) ? true : false;}},
// 	            formatter: function () {
// 	                var clmnDt = new Date(this.item.clmnDt || new Date());
// 	                clmnDt.setDate(clmnDt.getDate() - (this.item.pmntDtAfterBill || 0));
// 	                var month = String(clmnDt.getMonth() + 1).padStart(2, '0');
// 	                var day = String(clmnDt.getDate()).padStart(2, '0');
// 	                var year = clmnDt.getFullYear();
// 	                return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
// 	            }},
	        {key: "매입등록금액", 		label: "매입등록금액", width: 110, align: "right", formatter: "money", styleClass: function () {
	            return (gPasFloatChk(this.item.clmnAmt) < gPasFloatChk(this.item.매입등록금액)) ? "grid-font-red" : "grid-font-blue";}
	        },
	        {key: "매입확정금액", 	label: "매입확정금액", width: 110, align: "right", formatter: "money", styleClass: function () {
	            return (gPasFloatChk(this.item.clmnAmt) < gPasFloatChk(this.item.매입확정금액)) ? "grid-font-red" : "grid-font-blue";}
	        },
	        {key: "결제금액", 			label: "결제금액", width: 110, align: "right", formatter: "money", styleClass: function () {
	            return (gPasFloatChk(this.item.clmnAmt) < gPasFloatChk(this.item.지급금액)) ? "grid-font-red" : "grid-font-blue";}
	        },
	        {key: "미지급잔액", 		label: "미지급잔액", width: 110, align: "right",
	            formatter: function () {return addCommaStr(gPasFloatChk(this.item.clmnAmt) - gPasFloatChk(this.item.지급금액));},
	            styleClass: function () {return "grid-font-blue";}},
	        {key: "clmnMgmtStatus", label: "지급금관리상황", width: "*", align: "left", editor: {type: "text"}},
	    ],
	    footSum: [
	        [
	            {label: "지급합계", align: "center", colspan: 3},
	            {key: "clmnRate", 	collector: "sum", formatter: "money", align: "right"},
	            {key: "clmnAmt", 	collector: "sum", formatter: "money", align: "right"},
	            {colspan: 3},
	            {key: "매입등록금액", 	collector: "sum", formatter: "money", align: "right"},
	            {key: "매입확정금액", collector: "sum", formatter: "money", align: "right"},
	            {key: "결제금액", 		collector: "sum", formatter: "money", align: "right"},
	            {key: "zzzz", 		collector:
	                function () {
	                    var value = 0;
	                    this.list.forEach(function (n) {
	                        if (!n.__isGrouping) value += (gPasFloatChk(n.clmnAmt) - gPasFloatChk(n.지급금액));
	                    });
	                    return addCommaStr(value);
	                },
	                formatter: "money", align: "right"
	            },
	        ]
	    ],
	    page : {display: false,},
	    body: {
	        onClick: function () {
	            this.self.clearSelect();
	            this.self.select(this.dindex);
	            selectedRowKey = this.dindex;
	        },
	        onDataChanged: function () {
	            if( this.key == "clmnAmt" || this.key == "clmnRate" ) {
	                const ctrtAmt = gPasFloatChk($("#ctrtAmt").val());
	                
	                if( this.key == "clmnAmt" ) {
	                    const clmnAmt = gPasFloatChk(this.value);
	                    this.value = clmnAmt;
	                    
	                    if (!isNaN(clmnAmt) && !isNaN(ctrtAmt)) {
	                        this.item.clmnRate = ctrtAmt !== 0 ? gPasFloatChk((clmnAmt / ctrtAmt * 100) ) : 0;
	                    }
	                }
	
	                if( this.key == "clmnRate" ) {
	                    const clmnRate = gPasIntChk(this.value);
	                    this.value = clmnRate;
	                    
	                    if (!isNaN(clmnRate) && !isNaN(ctrtAmt)) {
	                        this.item.clmnAmt = gPasFloatChk(clmnRate * ctrtAmt / 100);
	                    }
	                }
	
	                var data = gridClmnPlan.getList();
	                var totalRate = 0;
	                var totalAmt = 0;
	                
	                for (var i = 0; i < data.length; i++) {
	                    totalRate += gPasIntChk(data[i].clmnRate);
	                    totalAmt += gPasFloatChk(data[i].clmnAmt);
	                }
	                
	                if (totalRate > 100) {
	                    alert('비율의 합계는 100%를 초과할 수 없습니다.');
	                }
	                
	                if (totalAmt > ctrtAmt) {
	                    alert('수금금액의 합계는 주문 금액을 초과할 수 없습니다.');
	                }
	            }
	            gridClmnPlan.repaint();
	            
	        }
	    },
	    contextMenu: {
	        iconWidth: 20,
	        acceleratorWidth: 100,
	        itemClickAndClose: false,
	        icons: {'arrow': '<i class="fa fa-caret-right"></i>'},
	        items: [
	            {type: 1, label: "붙여넣기"},
	            {divide: true},
	            {type: 1, label: "줄추가"},
	            {type: 1, label: "내용 삭제"},
	            {type: 2, label: "줄삭제"},
	        ],
	        popupFilter: function (item, param) {
	            //console.log(item, param);
	            if (param.element) {
	                return true;
	            } else {
	                return item.type == 1;
	            }
	        },
	        onClick: function (item, param) {
	            // console.log(item, param);
	            thisGridRow = param.dindex;
	            thisGridCol = param.colIndex;
	            if (item.label == "붙여넣기") {
	                gridPaste(gridClmnPlan, thisGridRow, thisGridCol, "PLAN");
	            } else if (item.label == "줄추가") {
	                // console.log('추가 인덱스 :', param.dindex);
	                //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
	                let newRow = {...gridClmnPlan.list[param.dindex]};
	                newRow.매입등록금액 = 0;
	                newRow.매입확정금액 = 0;
	                newRow.결제금액 = 0;
	                newRow.미지급잔액 = 0;
	                
	                gridClmnPlan.addRow($.extend({}, newRow, {__index: undefined}), param.dindex + 1,);
	            } else if (item.label == "내용 삭제") {
	                // console.log('내용삭제 인덱스 :', param.dindex);
	        		if (gridClmnPlan.list[param.dindex].매입등록금액 == "" || gPasIntChk(gridClmnPlan.list[param.dindex].매입등록금액) == 0){
		                gridClmnPlan.config.columns.forEach((column) => {
		                    gridClmnPlan.setValue(param.dindex, column.key, '');
		                    // console.log('내용삭제 :', param.dindex, column.key);
		                });
		        	} else {
		        		alert("매입 등록된 자료가 있어서 삭제 불가능합니다.");
		        	}
	            } else if (item.label == "줄삭제") {
	        		if (gridClmnPlan.list[param.dindex].매입등록금액 == "" || gPasIntChk(gridClmnPlan.list[param.dindex].매입등록금액) == 0){
		                // console.log('삭제 인덱스 :', param.dindex);
		                gridClmnPlan.removeRow(param.dindex);
		        	} else {
		        		alert("매입 등록된 자료가 있어서 삭제 불가능합니다.");
		        	}
	            }
	            gridClmnPlan.contextMenu.close();
	        }
	    },
	});


	var turnKeyGridView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                target: $('[data-ax5grid="turnKey-grid"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                    onClick: function () {
//                         this.self.select(this.dindex);
//                         if (gPasIntChk(this.item.ordrsAmt) != 0) {
//                         	this.self.select(this.dindex);
//                         }
                    },
                    onDBLClick: function () {
                    },
                    onDataChanged: function () {
        				var row = this.dindex;
        				var col = this.colIndex;
                    	if (this.key == 'ordrsAmt'){
                    		if (gPasIntChk(this.value) != 0) {
	                    		turnKeyGridView.target.list[this.dindex].chkSaveCd = 'Y';
	                    		if (gPasIntChk(this.item.ordrsQty) == 0) {
	                    			turnKeyGridView.target.list[this.dindex].ordrsQty = this.item.salesOrdrsQty;
	                    		}
	                    	} else {
	                    		turnKeyGridView.target.list[this.dindex].chkSaveCd = 'N';
	                			turnKeyGridView.target.list[this.dindex].ordrsQty = '';
	        				}
                    		let totalChkAmt = 0;
                    		let turnKeyList = turnKeyGridView.target.getList();
                    		if (turnKeyList.length > 0 ) {
                    			$.each(turnKeyList, function (idx, elem) {
                    				// 선택된 정보만 저장
                    				if (idx==0) firstSalesCd = turnKeyList[idx].salesCd; //SalesCd는 상세내역에 있음. 대표 세일즈코드 (선택된것중에 첫번째)
                    				totalChkAmt += gPasIntChk(elem.ordrsAmt);
                    	        });
                    		}

                    		// $('#ctrtTotAmt').val(addCommaStr(totalChkAmt));
							$('#ctrtTotAmt').val(addCommaStr(totalChkAmt)).trigger("change");   // 외주총금액 변경시 change이벤트 강제 트리거
                    		//금액 입력 오류를 위한 자동계산 제외처리함
//                     		calclateTotalClmnAmt(); //금액부분 재계산 하기
							turnKeyGridView.target.repaint()
                    	}
                		
                    },
                },
                page: {
                    navigationItemCount: 9,
                    height: 30,
                    display: true,
                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange: function () {
                        turnKeyGridView.setData(this.page.selectPage);
                    }
                },
				columns : [
					{key : "coCd", 			  label : "회사",          hidden : true},
					{key : "coCdNm", 		  label : "회사명",        align : "center", 	width : 80, hidden : true},
					{key : "ordrsNo", 		  label : "수주번호",      align : "center", 	width : 60, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "ordrsSeq", 		  label : "순번",   		align : "center", 	width : 40, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "salesCd", 		  label : "Sales Code",   align : "left", 	width : 120, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }}, 
					{key : "salesOrdrsQty",   label : "주문대수",   	align : "center", formatter: "money",	width : 60, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }}, 
// 					{key : "eqpNm", 		  label : "설비명",        align : "center", width : 240},
					{key : "eqpNm", 		  label : "설비명",        align : "left", 	width : "*", styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "chkSaveCd" ,	  label : "턴키여부",		align: "center",	width: 60, formatter: function () { return this.value =="Y" ? "대상":""; }},
					{key : "ordrsQty" ,	  	  label : "외주대수",		align: "center",	width: 60, editor: {type: "number"}, formatter: "money", styleClass: function () { return "grid-font-red"; }},
					{key : "ordrsAmt" ,	  	  label : "외주금액",		align: "right",		width: 90, editor: {type: "number" }, formatter: "money", styleClass: function () { return "grid-font-red"; }},
					{key : "ctrtRmk" ,	  	  label : "비고",			align: "left",		width: 150, editor: {type: "text" }, styleClass: function () { return "grid-font-red"; }},
					{key : "ordrsDtlDiv20",   label : "신작구분",      hidden : true},
					{key : "ordrsDtlDiv20Nm", label : "신작구분",      align : "center", width : 60, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "ordrsClntCd", 	  label : "고객사",        hidden : true},
					{key : "ordrsClntNm", 	  label : "고객사명",      align : "left", width : 120, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "clntPjt", 		  label : "고객사 PJT",    align : "center", width : 100, hidden : true},
					{key : "clntPjtNm", 	  label : "프로젝트",    	align : "center", width : 80, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
// 					{key : "prdtCd", 		  label : "제품구분",      hidden : true},
// 					{key : "prdtCdNm", 		  label : "제품",        align : "left", width : 140, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
// 					{key : "itemDiv", 		  label : "아이템구분",    align : "center", width: 100, hidden : true},
// 					{key : "itemDivNm", 	  label : "아이템",    align : "left", width: 120, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "orgnSalesCd", 	  label : "원 Sales Code", align : "left", width : 120, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
				],
        	    footSum: [
        	        [
        	            {label: "외주합계", align: "center", colspan: 6},
        	            {key: "ordrsQty", 	collector: "sum", formatter: "money", align: "center"},
        	            {key: "ordrsAmt", 	collector: "sum", formatter: "money", align: "right"},
        	        ]
        	    ],
            });
            return this;
        },
		setData : function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {};
			paramObj.pageNo = _pageNo + 1;
			paramObj.recordCnt = 999999;

			paramObj.coCd = $("#ordrsCoCd").val();		
			paramObj.ordrsNo = $("#ordrsNo").val();
			paramObj.ctrtNo = $("#ctrtNo").val();
			
			if(_pageNo !== 999) {
				var searchValue = paramObj.searchValue;
				var searchType  = paramObj.searchType;
				postAjaxSync("/user/sm/sm11/selectTurnKeySalesCodeList", paramObj, null, function(data) {
					try {
						var list = data.result;
						$.each(list, function (idx, elem) {
							list[idx].__selected__ = elem.chkSaveCd=="Y" ? true : false;	//저장된 salesCd 이면 선택되게 변경 처리함
						});
						targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							}
						});
						localgridResize(list.length+2); //그리드 높이 조정
					} catch (error) {
						alert("오류 발생!! 전산실 연락 바랍니다", error.message);
						return null; // 오류 발생 시 null 반환
					} finally {
						// console.log("함수 실행 완료.");
					}
				});
			}
		}
    };

	$(document).ready(function() {

		toast.init();
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popFormSM11 #userId").val(jwt.userId);
		
		//계약일자//
		$('#ctrtDt').datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true }).datepicker("setDate", new Date());
		//발주서일자//
		$('#ctrtOrdrsDt').datepicker({ format : "yyyy-mm-dd", language : "ko", autoclose : true });
		//계약이행//
		$('#ctrtPfmcDt').datepicker({ format : "yyyy-mm-dd", language : "ko", autoclose : true });
		//선급이행//
		$('#ctrtBfPfmcDt').datepicker({ format : "yyyy-mm-dd", language : "ko", autoclose : true });
		//하자이행//
		$('#ctrtAfPfmcDt').datepicker({ format : "yyyy-mm-dd", language : "ko", autoclose : true });
		//납기일자//
		$('#dudtIntendDt').datepicker({ format : "yyyy-mm-dd", language : "ko", autoclose : true });
		
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		exrateCal(); //최초 로딩시 환율 적용
	    $('#currCd').on('change', exrateCal);
	    turnKeyGridView.initView();
	    
		let refFileTrgtKey = modalStack.last().paramObj.refFileTrgtKey;
		let refCtrtNo = modalStack.last().paramObj.ctrtNo;
		if (actionType == "C") {
			$("#popDivSM11 #actionBtn").text("등록");
			//참조키값이 있으면 자료를 불러옴.
			if (refFileTrgtKey){
				selectContractInfo(refFileTrgtKey, refCtrtNo);
				turnKeyGridView.setData(0);
			}
			
			$('#popDivSM11 #actionBtn').on("click", function() {
				insertContract();
			});

		} else if (actionType == "U") {
			$('#popDivSM11 .tit').text('외주관리 수정')
			
			selectContractInfo(refFileTrgtKey, refCtrtNo);
			turnKeyGridView.setData(0);
			
			$('#popDivSM11 #actionBtn').text("수정");
			$('#popDivSM11 #actionBtn').on("click", function() {
				updateContract();
			});
		} else if (actionType == "T") {  //"T"는 설비별 매입현황에서  Call 함(SM1501M01.html)
			$('#popDivSM11 .tit').text('외주관리 조회')
			
			selectContractInfo(refFileTrgtKey, refCtrtNo);
			turnKeyGridView.setData(0);
			$('#popDivSM11 #actionBtn').hide();
		}

	    $("#addPaymentButton").on("click", function () {
	        var row;
			var newRowData = {
					clmnPlanDiv: "CLMNPLANDIV1",
					clmnDivSeq : 1,
					clmnRate : 0,
					clmnAmt : 0,
					clmnDt : "",
					pmntDtAfterBill : "",
					billPblsDt : "",
					clmnMgmtStatus : "",
					ctrtClmnDay : $("#ctrtClmnDay").val(),
					ctrtPmntMtdCd : $("#ctrtPmntMtdCd").val(),
			};

	        var ctrtAmtVal = gPasIntChk($("#ctrtAmt").val()); //계약금액에 적힌 값
	        if (ctrtAmtVal == 0 || ctrtAmtVal == ""){
	        	alert("계약금액을 입력바랍니다.");
	        	$("#ctrtAmt").focus();
	        	return false;
	        } else {
			        // 첫 번째 경우: 선택된 행이 있는 경우
			        if (selectedRowKey !== undefined) {
			            let row = gridClmnPlan.getList("selected")[0];
			            let newRowData = $.extend({}, row, {__index: undefined, clmnRate: 0, clmnAmt: 0});
			            gridClmnPlan.addRow(newRowData, row.__index + 1);
			        }
			        // 두 번째 경우: 그리드가 비어 있는 경우
			        else if (gridClmnPlan.getList().length === 0) {
			            gridClmnPlan.addRow(newRowData, 0);
			        }
			        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
			        else {
			            gridClmnPlan.addRow(newRowData, gridClmnPlan.list.length);
			            return;
			        }
			
				        const data = gridClmnPlan.getList();
				        gridClmnPlan.setData({
				            list: data,
				            page: {
				                totalElements: data.length
				            }
				        });
	        }
	        prevData = JSON.parse(JSON.stringify(gridClmnPlan.getList()));
	        // 여기에서 그리드 데이터가 준비된 후 실행하려는 코드를 추가할 수 있습니다.

	    });

	    $("#deletePaymentButton").on("click", function () {
	        if (selectedRowKey !== undefined) {
	        	if (gridClmnPlan.list[selectedRowKey].매입등록금액 == "" || gPasIntChk(gridClmnPlan.list[selectedRowKey].매입등록금액) == 0){
		            gridClmnPlan.removeRow(selectedRowKey);
		            const data = gridClmnPlan.getList();
		            gridClmnPlan.setData({
		                list: data,
		                page: {
		                    totalElements: data.length
		                }
		            });
	
		            // 선택된 행을 업데이트합니다.
		            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
		                if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
		                    gridClmnPlan.select(selectedRowKey);
		                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
		                    selectedRowKey = selectedRowKey - 1;
		                    gridClmnPlan.select(selectedRowKey);
		                }
		            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
		                selectedRowKey = undefined;
		                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
		                // 예: $("#deleteProductButton").prop("disabled", true);
		            }
	        	} else {
	        		alert("매입 등록된 자료가 있어서 삭제 불가능합니다.");
	        	}
	        } else {
	            alert("삭제를 위해 선택된 행이 없습니다.");
	        }
	    });

		//계약금액, Nego금액일 변경되면 재계산한기 위한 부분임
        $("#ctrtAmt, #ctrtNegoAmt").on("keyup", function () {
        	let tempVal = gPasIntChk($("#ctrtTotAmt").val()); 
        	tempVal -=  gPasIntChk(this.value);
        	tempVal = addCommaStr(tempVal);
        	(this.name == "ctrtAmt") ? $("#ctrtNegoAmt").val(tempVal) : $("#ctrtAmt").val(tempVal) ;
        	
            calclateTotalClmnAmt();
        });

		$("#ctrtTotAmt").change(function () {
			let ctrTotVal = $("#ctrtTotAmt").val().replace(/,/g, '');
			let ctrNeogoVal = $("#ctrtNegoAmt").val().replace(/,/g, '');
			ctrNeogoVal = (ctrNeogoVal === "") ? 0 : ctrNeogoVal;
			let ctrtAmtVal = ctrTotVal - ctrNeogoVal;
			ctrtAmtVal = addCommaStr(ctrtAmtVal);
			$("#ctrtAmt").val(ctrtAmtVal);
        });

//         $("#ctrtAmt, #ctrtTotAmt, #ctrtNegoAmt").change(function () {
//             calclateTotalClmnAmt();
//         });
        //계약품목구분에서 "CTRITEM07":외주용역은 인력용역으로 단독으로만 등록되어야함.
        $('input[name="ctrtItem"]').change(function () {
        	if (!ctrtItemCheck()) {
                alert("외주용역은 다른 품목과 함께 사용할수 없습니다.");
                $(this).prop('checked', false); // 선택 해제
        	}
        });


		// 부서가 바뀌면 에 대해 크기 조절 함수 호출
        $('#mngIdNm').on('input paste drop change', function () {
        	//트루넷직접매출에서 바로 수주된건은 사전품의번호 필요없음
        	if ($('#ordrsCoCd').val() == 'TRN') {
//         		$('#ctrtApprovalNo').val('').prop('readonly', true).removeAttr('required').closest('td').prev('th').removeClass('hit');
        		$('#ctrtApprovalNo').val('').removeAttr('required').closest('td').prev('th').removeClass('hit');
        	} else {
	        	const deptId = $('#deptId').val() ?? '';
	        	if (deptId.slice(0, 5) === 'TRN30') {
	        		//직접매출인경우 턴키가 전부이며, 사전품의번호가 필수임
					$(ctrtApprovalNo).attr('required', true).closest('td').prev('th').addClass('hit');
	        	} else {
	        		//구매,가공의 경우 전기가 주로 턴키로 진행되며, 사전품의번호는 없음
	        		$(ctrtApprovalNo).removeAttr('required').closest('td').prev('th').removeClass('hit');
	        	}
        	}
		});
        $('#mngIdNm').trigger('input');
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popFormSM11 #pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdarsSM11', 'file-grid-SM11', 'FILETREE', fileParam, 'fileList_area_SM11');
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		authChk();						// 권한체크

	});

	
	function ctrtItemCheck() {
    	let tempValues = [];
        $('input[name="ctrtItem"]:checked').each(function() {
        	tempValues.push($(this).val());
        });
         
        if (tempValues.includes("CTRITEM07")) {
            const otherValues = tempValues.filter(value => value !== "CTRITEM07");
            if (otherValues.length > 0) {
//                 alert("외주용역은 다른 품목과 함께 사용할수 없습니다.");
                return false;
            }
        }
        return true;
	}
	
	//통화단위 변경
	function exrateCal() {
		var currCd = $('#currCd').val();
		var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
		$('#exrate').val(exrateVal ? exrateVal : '');
	}		
	
	function selectContractInfo(_fileTrgtKey, _ctrtNo) {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" 	: _fileTrgtKey,
			"ctrtNo" 		: _ctrtNo,
		}
		postAjax("/user/sm/sm11/selectContractInfo", formData, null, function(data) {
			if (actionType == "C") {
				data.result.fileTrgtKey = 0;
				data.result.ctrtAmt = 0;
				
				delete data.result.ctrtNo;
				delete data.result.ctrtDt;
				delete data.result.ordrsNo;
				delete data.result.ctrtNm;
				delete data.result.clntNm;
				delete data.result.clntPjt;
				delete data.result.clntPjtNm;
				delete data.result.ordrsCoCd;
				delete data.result.vendCd;
				delete data.result.vendNm;
				delete data.result.creatId;
				delete data.result.creatNm;
				delete data.result.creatPgm;
				delete data.result.creatDttm;
				delete data.result.udtId;
				delete data.result.udtNm;
				delete data.result.udtPgm;
				delete data.result.udtDttm;
				delete data.result.reqNo;
				let deptCd = jwt.deptId.slice(0,5) || '';
		 		if (deptCd == 'TRN30' || deptCd == 'TRN50') {
		 			data.result.mngDeptCd = deptCd;  //부서코드 5자리만 사용
		 		} else {
		 			data.result.mngDeptCd = 'TRN30';	//트루넷 직접매출
		 		}

			}
				$.each(data.result, function(key, value) {
					if ($('#popFormSM11 #' + key)[0]) {
						$('#popFormSM11 #' + key).val(value);
						if ($('#popFormSM11 #' + key).hasClass("input_calendar")) {
							$('#popFormSM11 #' + key).datepicker("update");
						}
						if ($('#popFormSM11 #' + key).is('[comma]')) {
							onlyNumber($('#popFormSM11 #' + key)[0]);
						}
					}
				});
// 				$('#CTRITEM03, #CTRITEM05').prop('checked', true);
				if (data && data.result && data.result.ctrtItems !== undefined) {
					let tempItem = data.result.ctrtItems.split(',').map(function(item) {
					    return item.trim();	//앞뒤공백 제거하기 위함
					});
			        for (var i = 0; i < tempItem.length; i++) {
			        	 $('#'+tempItem[i]).prop("checked", true);
			        }
				}
	            var clmnPlans = data.result.plans;
	            gridClmnPlan.setData({
	                list: clmnPlans,
	                page: {
	                    totalElements: clmnPlans.length
	                }
	            });
	            var contractDetails = data.result.details;
	            turnKeyGridView.setData({
	                list: contractDetails,
	                page: {
	                    totalElements: contractDetails.length
	                }
	            });
// 		        gridResize(ordrsDetails.length+1); //그리드 높이 조정
		        //monthCloseChk($('#ordrsDt').val());  //마감일통제 원래 위치
// 		        gridViewPop7.initView().setData(0);
// 		        gridViewPop7.target.setHeight((gridViewPop7.target.list.length+1) * 27 + 123 );//그리드 높이 조정
		        
				//마감체크
				if (actionType != "T") {
					monthCloseChk($('#ctrtDt').val(), '', $('#coCd').val());
				}
				
				//부서코드에 따라 사전품의번호 필수 기능 적용하기
		        $('#mngIdNm').trigger('input');

				//백엔드에서 해당 거래처의 문제현황을 검색해오기
				//메세지 뿌리기
				if (actionType == "U") toastMsg('O', data.result.vendCd, [{oemDivTxt:"가공품"}]);	// (M:업무구분, $('#pchsClntCd').val():공급사코드, list:자재리스트)
		});
	}



	 // 등록
	function insertContract() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			if (formData) {
				filePostAjax("/user/sm/sm11/insertContract", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);
							modalStack.close();									// 모달을 닫음
						}
					});
			} else {
				dateCommaFormat();
			}
		}
	}

	// 수정
	function updateContract() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			if (formData) {
	      		filePostAjax("/user/sm/sm11/updateContract", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
				dateCommaFormat();
			}
		}
	}
	
	//날자필드 및 숫자 필드에 하이픈 및 콤마 추가하기
	function dateCommaFormat() {
		$('#ctrtDt').val($('#ctrtDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
		$('#ctrtOrdrsDt').val($('#ctrtOrdrsDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
		$('#ctrtPfmcDt').val($('#ctrtPfmcDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
		$('#ctrtBfPfmcDt').val($('#ctrtBfPfmcDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
		$('#ctrtAfPfmcDt').val($('#ctrtAfPfmcDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))
		$('#dudtIntendDt').val($('#dudtIntendDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'))

		$.each($('.popup_area input[comma]'), function(idx, elem) {
			onlyNumber(elem);
		});
	} 
	
	//----------------------------------------------//
	
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popFormSM11")[0]);
		
		//품목정보를 comma로 구분하여 저장
        let tempValues = [];
        $('input[name="ctrtItem"]:checked').each(function() {
        	tempValues.push($(this).val());
        });
        formData.append("ctrtItems", tempValues.join(', '));
		

        let ctrtAmt = gPasIntChk($("#ctrtAmt").val());
        let totalRate = 0;
        let totalAmt = 0;
		let clmnPlanList = gridClmnPlan.getList();
        for (var i = 0; i < clmnPlanList.length; i++) {
            totalRate += gPasIntChk(clmnPlanList[i].clmnRate);
            totalAmt += gPasFloatChk(clmnPlanList[i].clmnAmt);
//             if (clmnPlanList[i].clmnDt == undefined || clmnPlanList[i].clmnDt == "") {
//             	alert('지급예정일자가 없습니다.');
//     			return false;
//             }
//             if (clmnPlanList[i].billPblsDt == undefined || clmnPlanList[i].billPblsDt == "") {
//             	alert('세금계산서 발행예정일자가 없습니다.');
//     			return false;
//             }
            if (clmnPlanList[i].clmnRate == undefined || clmnPlanList[i].clmnRate == "0") {
            	alert('지급 비율은 0이 될수 없습니다.');
    			return false;
            }
            if (clmnPlanList[i].clmnAmt == undefined || clmnPlanList[i].clmnAmt == "0") {
            	alert('지급금액은 0원으로 등록할 수 없습니다.');
    			return false;
            }
			if (clmnPlanList[i].clmnDivSeq == undefined || clmnPlanList[i].clmnDivSeq == "0") { // 지급정보 빈차수 자동 할당 
				clmnPlanList[i].clmnDivSeq = "1";
			}
        }
        
        if (totalRate > 100) {
            alert('비율의 합계는 100%를 초과할 수 없습니다.');
			return false;
        }
        if (totalRate < 100) {
            alert('비율의 합계를 100%로 맞춰 주세요.');
			return false;
        }
        
        if (totalAmt > ctrtAmt) {
            alert('수금금액의 합계는 주문 금액을 초과할 수 없습니다.');
			return false;
        }

    	if (!ctrtItemCheck()) {
            alert("외주용역은 다른 품목과 함께 사용할수 없습니다.");
			return false;
    	}
    	
    
		if (clmnPlanList.length > 0 ) {
			formData.append("clmnPlanArr",   JSON.stringify(clmnPlanList));
		}

        
		let firstSalesCd = ""; //대표 Sales Code 저장용
		//턴키 등록용 그리드 Sales Code 정보 
		let totalChkAmt = 0;
		let ctrtOrdrsQty = 0;
		let turnKeyList = turnKeyGridView.target.getList();
		if (turnKeyList.length > 0 ) {
			$.each(turnKeyList, function (idx, elem) {
				// 선택된 정보만 저장
				if (idx==0) firstSalesCd = turnKeyList[idx].salesCd; //SalesCd는 상세내역에 있음. 대표 세일즈코드 (선택된것중에 첫번째)
				totalChkAmt += gPasIntChk(elem.ordrsAmt);
				ctrtOrdrsQty += gPasIntChk(elem.ordrsQty);
	        });
		}

		$('#ctrtTotAmt').val(totalChkAmt);
		let CtrtCalAmt = totalChkAmt - gPasIntChk($('#ctrtNegoAmt').val());	//총 외주금액 - Nego 금액
		if (CtrtCalAmt !=  gPasIntChk($('#ctrtAmt').val()) ) {	
	        alert('상세 내역금액(외주금액합계=외주총금액) - Nego금액 = 계약금액 확인 바랍니다.');
			return false;
		}
		formData.append("ctrtOrdrsQty", ctrtOrdrsQty);			//외주마스터용 턴키외주대수
		
		formData.append("detailArr", JSON.stringify(turnKeyList));
		formData.append("salesCd", firstSalesCd);	//SalesCd는 상세내역에 있음. 대표 세일즈코드 (선택된것중에 첫번째)
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#vendCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	
    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd').val(),
           "salesCd": $('#salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/SalesCodeTreeSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $('#salesCd').val(row.salesCd);
            $('#clntPjtCd').val(row.clntPjt);
            $('#clntPjt').val(row.clntPjtNm);
            $('#eqpNm').val(row.eqNm);
            $('#vendCd').val(row.ordrsClntCd);
            $('#vendNm').val(row.ordrsClntNm);
            $('#eqpNm').val(row.eqpNm);
            $('#prdtCd').val(row.prdtCd);
			$('#prdtNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
        });
    }
    		
	
	//  업체명 검색 //
	function clntSearch() {
		var paramObj = {
				"searchValue" :  $("#vendNm").val()
				, "clntDivCd" : ""		/*거래처 검색 기본값 고객사로 세팅 */
				, "pchsClntCd" : "CLNTDIV12"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
		}	
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", paramObj, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#vendCd').val(row.clntCd);
					$('#vendNm').val(row.clntNm);
					$('#pchsPmntMtdCd').val(row.pchsPmntMtdCd);
					$('#ctrClmnDivCd').val(row.pchsClmnDivCd);
					$('#ctrClmnVat').val(row.pchsVatCd);
					$('#pchsClmnDay').val(row.pchsClmnDay);
	                var paramObj = {
	                    "userId": $('#mngId').val(),
	                    "clntCd": row.clntCd
	                }
	                setMngInfo(paramObj);
// 	                $("#vendNm").focus();
// 	                $("#vendNm").trigger("click");
					
				//백엔드에서 해당 거래처의 문제현황을 검색해오기
				//메세지 뿌리기
				toastMsg('O', row.clntCd, [{oemDivTxt:"가공품"}]);	// (O:외주업무구분, row.clntCd:공급사코드, list:자재리스트)
		});
	}

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectClntBusinessMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {
            	if ($('#vendMngNm').val()=="") $('#vendMngNm').val(data.mngInfo.mngNm);
            	if ($('#vendTelNo').val()=="") $('#vendTelNo').val(data.mngInfo.mngTelNo);
            	if ($('#vendFaxNo').val()=="") $('#vendFaxNo').val(data.mngInfo.bizFaxNo);
            	if ($('#vendHpNo').val()=="") $('#vendHpNo').val(data.mngInfo.mngMoblphonNo);
            	if ($('#vendMngMail').val()=="") $('#vendMngMail').val(data.mngInfo.mngEmail);
            } 
        });
    }

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"userNm": $('#mngIdNm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			let checkedId = tree.get_checked()[0];
			let checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngIdNm').val(checkedNode.text);

			$('#deptId').val(checkedNode.parent);
	        $('#mngIdNm').trigger('input');
		});
	}
	
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	
	//수주번호 검색
    function popOpendOrdrsSearch(inputValue, coCd) {
        var paramObj = {
            "searchValue" : inputValue,
            "coCd" : coCd
        };
    	
        openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 800, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];

            $('#ordrsCoCd').val(row.coCd);
            $('#ordrsNo').val(row.ordrsNo);
            $('#clntCd').val(row.ordrsClntCd);
            $('#clntNm').val(row.clntNm);
            $('#clntPjt').val(row.clntPjtCd);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#ctrtNm').val(row.ctrtNm);
            
            //트루넷직접매출에서 바로 수주된건은 사전품의번호 필요없음
			$('#mngIdNm').trigger('input');
            
    		turnKeyGridView.initView().setData(0);
        });
    }
	
    
    function localgridResize(size) {
            let tagHeight = (size) * 27 + 25 ;
            tagHeight = tagHeight > 750 ? 750 : tagHeight;
            tagHeight = tagHeight < 300 ? 300 : tagHeight;
            
            turnKeyGridView.target.setHeight(tagHeight);
    }
    
    

	function sendMailCall() {
		try {
			if (approvalConfirmCheck){
		        sendMailExec();
			}
	    } catch (error) {
	    } finally {
	    }
	  
	}
	
	function approvalConfirmCheck (){
		//확인일자 체크
// 		if (editVal.todoYn != "Y") {
// 			alert("결재 승인전 발송 할 수 없습니다.");
// 			return false;
// 		}
	
// 		var todoCfDtChk = gridViewPopApproval.target.list;
// 		todoCfDtChk.forEach(function (item) {
// 	        if (item.gb == "결재" && item.todoCfDt !== undefined) {
// 	        	alert(item.name + "님께서 결재 승인하지 않았습니다.");
// 	    		return false;
// 	        }
// 	    });
		return true;
	}
	
	async function sendMailExec() {
		//파일 첨부 여부(application.yml파일의 spring.fileAttached=YES or NO)
		//****************************************************************
		let fileAttached = false;
		let paramData = {"coCd#":$('#coCd').val()};
		postAjaxSync ("/mail/sendFilefileAttach", paramData, null, function(data) {
			fileAttached = (data.resultCode == "200") ? data.fileAttached : true;
		});
		//****************************************************************
		var fileName = "SM1101R01.jrf";
		var arg =  
			  "coCd#"		+  $('#coCd').val()
	    	+ "#ordrgNo#"	+  $('#costNo').val()
	    	+ "#userId#"	+  jwt.userId
	    	+ "#";         
	
		var tempUrl = "?file="+fileName;
			tempUrl += "&arg="+encodeURIComponent(arg);
			
		//****************************************************************
		// Report 출력물을 PDF 파일로 변환
		//****************************************************************	
		var attachFile="";
		if (fileAttached == "true") { //파일 첨부일 경우 PDF 변환
			let response = "";
			await ubiExportAjaxSync(fileName, arg, function(result) {
				response=result;
			});
			if (response.resultCode === 200) {
				const base64FileData = response.base64FileData;
				fileName = response.exportFileName;
				attachFile = downloadPDFFromBase64(base64FileData, fileName);
			} else {
	// 			console.log('PDF 내보내기 실패: ' + response.resultText);
			}
		}
		//****************************************************************	
	
		const orderCnt = 1;
		var ordetTxt = $('#costRmk').val();
	
		ordetTxt = ordetTxt + ((orderCnt > 1) ? (" 외 " + (orderCnt - 1) + "건") : "");
		var tempDudtDeqDt = $('#costDt').val();
	    var paramObj = {
	       "coCd" : $('#coCd').val(),
	       "clntCd" : $('#pchsClntCd').val(),
	       "clntMngNm" : "",
	       "pgmId" :  "SM1101P01",
	       "sendType" :  "SM1101P01",
	       "sendKey" : $('#fileTrgtKey').val(),
	       "tempUrl" : tempUrl,
	       "mailTitle" : moment().format('YYYY-MM-DD HH:mm') + " 기준  발주번호 (" + $('#costNo').val() + ")의 발주서 발송의 건",
	       "mailCnts" : ordetTxt + "의 발주서를 첨부와 같이 보내 드리오니 업무 참고 바랍니다.\n" +
	       				"        - 아 래 -\n" +
	                    " 1. 발주 번호 : " + $('#costNo').val() + "\n" +            
	                    " 2. 발주 일자 : " + $('#costDt').val() + "\n" + 
	                    " 3. 납기요청일자 : " + tempDudtDeqDt + "\n" + 
	                    " 3. 발주 업체 : " + $('#pchsClntNm').val() + "\n" + 
	                    " 4. 발주 금액 : " + addCommaStr($('#costAmt').val()) + "\n" + 
	                    " 5. 발주 내용 : " + ordetTxt + "\n" + 
	                    " 6. 발주 담당자 : " + jwt.userNm + "(" + jwt.email + ")\n" + 
	                    " 내용 확인 후 처리 해 주시기 바랍니다.\n" +               
	                    " 감사합니다.",                
	    };
	    
	    //카카오 addParam
	    let addParam = {
				"ordrgDt": $("#popFormSM11 #costDt").val()				//발주일자				
				, "clntNm": $("#popFormSM11 #pchsClntNm").val()				//공급사명 - 구매처
				, "ordrgNo": $("#popFormSM11 #costNo").val()				//발주번호
				, "ordrgCoCdNm": $("#popFormSM11 #coCd option:checked").text()				//발주회사명
				, "ordrgMngNm": $("#popFormSM11 #ordrgMngNm").val()				//발주담당자
				, "ordrgMngTelNo": $("#popFormSM11 #ordrgMngTelNo").val()				//발주담당자전화번호
				, "tmplatDiv": "TMPLATDIV01"							//알림톡발송템플릿 종류
	    }
	    Object.assign(paramObj, addParam);
	   	//****************************************************************
	   	// 파일 첨부 여부에 따라 출력물 첨부
	   	//****************************************************************	   
		if (fileAttached == "true") { //파일 첨부 여부
			paramObj["file"]     = attachFile;
			paramObj["fileName"] = fileName;
		}
	   	//****************************************************************
	    
// 	    modalStack.close();  //blind popup close   	
		openSecondModal("/static/html/cmn/modal/mailSend.html", 760, 850, "메일 보내기", paramObj, function() {});
	}	
	

	//카카오 발송 - 발주서
	function commKaKaoSendOrder(param) {
	// 	console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);
	
		//알림톡수신번호 채번
		var paramMax = { "userId" : jwt.userId
						, "tmplatDiv": param.tmplatDiv
						, "fileTrgtKey": param.fileTrgtKey 
						/* , "clntCd" : param.clntCd */ //임시 건양
						, "clntCd" : 1
						};
		var maxMessageId = null;			//message id(unique key)
		var talkMessage = null 				//발송될 내용 template
		var mobile = null					//수신인 휴대전화번호
		let talkParam = {};
		let talkBody = {};			
		let sendCnt = 0;	
		postAjaxSync("/user/bm/bm18/selectMaxMessageId", paramMax, null
					, function(data) {   
						if(data.resultList.length > 0 ) {
							if( data.resultList[0].maxMessageId != "" ) {
								maxMessageId = data.resultList[0].maxMessageId;							
								talkMessage = data.resultList[0].messageDesc;
								mobile =  data.resultList[0].mngMoblphonNo;
								param.nameTo =  data.resultList[0].mngNm; //수신인 이름
							} else {
								alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
								return;
							} 
	
						}
		});     //user search ajax end
		if(mobile == "" || mobile == null) {
// 			alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
			return;
		}
		
		//message 치환
		let message = talkMessage;
		let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);	
		//loop
		$.each(splitStr, function (key, val) {		
			let compKey = val.substring(1, val.length-1);
			if( compKey != "" && compKey != "undefined" ) {
				if( typeof(param[compKey]) != "undefined" ) {
					let val2 = '#'+val;
					message = message.replaceAll(val2, param[compKey]);
				}
			}
		});
	
		talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
		talkParam.serverName = "gyitt2400";		
		talkParam.paymentType = "P";
		talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
		talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);	
		//talkBody.messageType = "AT";			//톡드림 포탈 템플릿 사용하지 않을 경우 사용 (AT: 알림톡, AI: 이미지 알림톡 (messageType 누락시 AT가 기본값으로 사용됨)
		//talkBody.title = "(주)건양아이티티";				//알림톡 타이틀 - 
		if (param.mailTitle.length > 50) {
			param.mailTitle = param.mailTitle.substring(0, 49); // 50자까지만 자르기
		}
		talkBody.title = param.mailTitle;					//알림톡 타이틀 -
		talkBody.message = message;				//알림톡 메시지 (1000 byte) 
		talkBody.mobile = mobile;				//휴대전화번호
		talkBody.template = "10001";			//템플릿관리화면 템플릿ID	- 발주서 V2
		let talkJson = JSON.stringify(talkBody);
		sendCnt = kakaoSendReal(talkJson, talkParam, param);
		//한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
	// 	talkBody.messageId = 'KAKAO'+Number(maxMessageId.substring(5, 20))+1;
	// 	talkBody.mobile = "01063893764"
	// 	talkJson = JSON.stringify(talkBody);
		//kakaoSendReal(talkJson, talkParam, param);
		
		if( sendCnt > 0 ) {
	// 		alert("알림톡 정상 발송되었습니다.");		
		}	
	}

	//계약금액과 지급정보의 금액을 일치하기 위한 자동계산 부분
    function calclateTotalClmnAmt () {
    	let tempVal = gPasIntChk($("#ctrtTotAmt").val()) - gPasIntChk($("#ctrtAmt").val());
    	tempVal = addCommaStr(tempVal);
    	$("#ctrtNegoAmt").val(tempVal);
    	
        var ctrtAmt = gPasIntChk($("#ctrtAmt").val());
        var data = gridClmnPlan.getList();
        var totClmnAmt = 0; 
        for (var i = 0; i < data.length; i++) {
            data[i].clmnAmt = gPasIntChk(ctrtAmt * gPasIntChk(data[i].clmnRate) / 100 + 0.5); 
            totClmnAmt += data[i].clmnAmt; 
        }
        if (data.length > 0){
            data[data.length-1].clmnAmt += ctrtAmt - totClmnAmt; //오더금액과 수금금액 차이는 마지막 수금에 포함 처리
        }

        gridClmnPlan.setData(data);
    } 
    
    function chechChange(elm) {
    	elm.value = addCommaStr(gPasIntChk(elm.value));
    }
    

    function  gridPaste(thisGrid, thisGridRow, thisGridCol, _type = "DETAIL" ) {
        var pasteData = "";

        navigator.clipboard.readText()
        .then(pasteData => {
            // console.log('클립보드에 저장된 값:', pasteData);
            if (pasteData == undefined || pasteData == "" || thisGridRow == undefined) {
                console.error('클립보드에 데이터가 없습니다.');
                return;
            }
            
            // 붙여넣기할 데이터를 배열로 변환한다.
            var pasteRows = pasteData.split("\n").map(function(row) {
                return row.split("\t");
            });
            
            //복사대상의 마지막 배열의 값이 없으면 제외
            if (pasteRows[pasteRows.length - 1] == "") pasteRows.splice(pasteRows.length - 1, 1);
            
            // 붙여넣기를 시작할 셀의 인덱스를 구한다.
            var startRowIndex = thisGridRow;
            var startColIndex = thisGridCol;
            
            // 붙여넣을 데이터의 행과 열 개수를 구한다.
            var numRows = pasteRows.length;
            var numCols = pasteRows[0].length;
            
            //그리드 컬럼정보를 가져와서 붙여넣기할때 위치정보로 사용한다.
            tempColumns = thisGrid.colGroup;
            for (var i = tempColumns.length - 1; i >= 0; i--) {
                if (tempColumns[i].hidden) {
                    tempColumns.splice(i, 1);
                }
            }
            
            var currGridData = thisGrid.list;
            
            //마지막자료와 같은 값으로 추가하고 ordrsSeq는 0으로 설정
            //참조복사를 방지하기 위함
            var tempData = JSON.parse(JSON.stringify(currGridData[thisGridRow]));
            tempData.ordrsSeq = "0";
            
            // 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
            for (var i = 0; i < numRows; i++) {
                for (var j = 0; j < numCols; j++) {
                    //carriage return 문자 삭제
                    var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
                    
                    calRow = startRowIndex + i;
                    calCol = startColIndex + j;
                    
                    if (calRow >= currGridData.length) {
                        //참조복사를 방지하기 위함
                        let tempDataCopy = JSON.parse(JSON.stringify(tempData));
                        tempDataCopy.cudCheck = "C"; //추가 플래그 설정
                        currGridData.push(tempDataCopy);
                    }
                    
                    var tkey = tempColumns[calCol].key;
                    currGridData[calRow][tkey] = cellData;
                }
                if (_type == "DETAIL") {  //설비쪽 붙여넣기인경우  신규추가 레코드가 아니면 수정 Flag로 변경처리
	                if (currGridData[calRow]["cudCheck"] != "C") {  //추가된 레코드가 아니면 수정 함으로 설정
	                	currGridData[calRow]["cudCheck"] = "U"; //수정 플래그 설정
	                }
                }
            }
            
            var currEndRow = currGridEndRow();
            thisGrid.setData(currGridData);
            resetGridFocus(currEndRow, thisGridRow);
        })
        .catch(error => {
        });
    };
    

	
	//요인별요청번호 검색
	function openPurchaseSearch() {
		let searchCheckVal = $("#reqNo").val()
		let searchNameVal = (searchCheckVal == undefined || searchCheckVal == '') ? "T.SALES_CD" : "T.REQ_NO" ;
		var paramObj = {
				"coCd" : $("#coCd").val(),
				"searchValue" : searchCheckVal,
				"searchName" : searchNameVal,
		}		
	
		paramObj.orderFlag = "Y";
		openSecondModal("/static/html/cmn/modal/purchaseSearch.html", 1200, 680, "요인별요청번호 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$("#ordrsCoCd").val(row.coCd);
// 			$("#ordrsCoCdNm").val(row.coCdNm);
			$("#clntPjt").val(row.clntPjtCd);
			$("#clntPjtNm").val(row.clntPjt);
// 			$("#eqpNm").val(row.eqpNm);
			$("#ctrtNm").val(row.ctrtNm);
// 			$("#prdtNm").val(row.prdtNm);
// 			$("#prdtCd").val(row.prdtCd);
			$("#reqNo").val(row.reqNo);
			$("#clntCd").val(row.clntCd);
			$("#clntNm").val(row.clntNm);
			$("#ordrsNo").val(row.ordrsNo);

			$("#salesCd").val(row.salesCd);
			$("#turnKeyGrid").show();
			turnKeyGridView.setData(0);
			let salesRow = turnKeyGridView.target.getList();

			const targetObject = salesRow.find(item => item.salesCd === row.salesCd);
			turnKeyGridView.target.select(targetObject.__index);
		});
	} 

	
</script>