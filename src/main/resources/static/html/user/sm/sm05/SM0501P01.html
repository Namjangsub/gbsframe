<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">폐기 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="SM0501M01">
		
		<table>
			<colgroup>
				<col width="11%">
				<col width="14%">
		        <col width="11%">
		        <col width="14%">
		        <col width="11%">
		        <col width="14%">
		        <col width="11%">
		        <col width="14%">		       
		    </colgroup>
			
			<thead>
				<tr>
				   <td colspan="8" style="height:30px;text-align: left;">기본정보</td>	                                              
				</tr>
			</thead>
			
			<tbody>				
				<!-- 1행 -->
				<tr>
					<th class="hit">회사</th>
					<td>
						<select  id="coCd" name="coCd" data-kind="CO" data-search="coCd" required msg="회사">
                               
                        </select>
					</td>
					<th class="hit">SalesCode</th>
					<td>
						<input type="hidden" id="salesNm" name="salesNm" >
					    <div class="search_form">
					    	<input type="text" id="salesCd" name="salesCd" data-search="salesCd" onkeyup="if(window.event.keyCode == 13){gridView_S3.setData(0)};">
					    	<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
					    </div>				    	
					</td>
				    <th>고객사</th>
				    <td>
				    	<input type="hidden"  id="ordrsClntCd" name="ordrsClntCd">
				    	<input type="text"  id="clntNm" name="clntNm" data-search="clntNm">  
				    </td>
				    <th>고객사PJT</th>
				    <td>
				        <input type="hidden" id="clntPjtCd" name="clntPjtCd" >
						<input type="text" id="clntPjt" name="clntPjt" data-search="clntPjt"> 
				    </td>
				</tr>
				             
				<!-- 2행 -->
				 <tr>
				    <th>제품구분</th>
				<td>
					<input type="hidden" id="prdtCd" name="prdtCd">
					<input type="text" id="prdtNm" name="prdtNm" data-search="prdtNm">
	
				</td>
				<th>아이템구분</th>
				<td>
				
					<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv"  >
						<option value="">전체</option>
					</select>
					<!-- <input type="hidden" id="itemDiv" name="itemDiv">
					<input type="text" id="itemDivNm" name="itemDivNm" data-kind="ITEMLIST"> -->
				</td>
				<th>설비명</th>
				<td>
					<input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm">
				</td>
				<th></th>
				<th></th>
				</tr>
				
				 <!-- 3행 -->
				 <tr>
				 	<thead>
					    <tr>
				        	<td colspan="8" style="height:30px;text-align: left;">불출정보</th>
				        </tr>
			        </thead>					
			        <tr>
						<th>폐기번호</th>
						<td>
							<input type="text"  id="ioNo" name="ioNo" data-search="ioNo">
						</td>
						<th class="hit">폐기일자</th>
						<td>
							<input id="ioDt" name="ioDt" data-search="ioDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date msg="폐기일자">
						</td>
						<th class="hit">폐기창고</th>
						<td>
<!-- 						A.OUT_WH_CD             --출고창고코드 -->
<!--      					, R1.CODE_NM AS OUT_WH_NM --출고창고명      -->
							
							<select id="outWhNm" name="outWhNm"  data-search="outWhNm" data-kind="INOUTDIV_O02" msg="폐기창고">
								<option value="">전체</option>
							</select>
							<!-- <select  id="outWhNm" data-kind="outWhNm" data-search="outWhNm" required="required"> 
                               
                            </select>-->
						</td>
						<th></th>
						<th></th>
					</tr>
				</tr>						
				<!-- 4행 -->
				 <tr>
				    <th>폐기사유</th>
				    <td colspan=3>
				            <input type="text" id="ioResn" name="ioResn" data-search="ioResn">
				    </td>
				    <th>비고</th>
				    <td colspan=3>
				            <input type="text" id="ioRmk" name="ioRmk" data-search="ioRmk">
				    </td>
				</tr>
		    </tbody>  
		</table>
		
		<!-- 콘텐츠 - 폐기상세 -->
<!-- 	    <div class="contents no_bg"> -->
<!-- 	      콘텐츠 타이틀 -->
<!-- 	      <div class="contents_tit"> -->
<!-- 	      	<span  style="height: 30px; line-height: 30px;font-size: 15px;">폐기상세 </span>         -->
	
<!-- 	      </div> -->
<!-- 	    </div> -->
<!-- 		<!-- 콘텐츠 --> 
<!-- 	    <div class="contents"> -->
<!-- 	      리스트 -->
<!-- 	      <div class="ax5_grid"> -->
<!-- 	      		<div id="second-grid" data-ax5grid="second-grid" data-ax5grid-config="{}" style="height: 250px; width: 100%;"></div> -->
<!-- 	      </div> -->
<!-- 	    </div> -->
    	<!-- 콘텐츠 - 폐기상세 -->
    </form>
	</div>
	


	<!-- 공통 파일 영역 -->
        <div class="col-sm-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 400px;padding: 5px">
                    <div id="deptTreeOrdars"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
                <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
            </div>
        </div>
        	
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>

   <!-- 하단 버튼 -->
<div class ="popup_bottom_btn">
	<button type="button" id="actionBtn" authChk>등록</button>
	<button type="button" class="close_btn"
		onclick="modalStack.close();">닫기</button>
</div>

<script type="text/javascript">
  debugger;
	var actionType = null;
	var fileTrgtKey = null;

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(jwt.userId);
		
		//처리일자//
		$('#costDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");

		authChk();						// 권한체크

		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		
	    $("#clntNm").prop("readonly", true);
	    $("#clntPjt").prop("readonly", true);
	    $("#prdtNm").prop("readonly", true);
	    $("#itemDivNm").prop("readonly", true);
	    $("#eqpNm").prop("readonly", true);
	    $("#matrNm").prop("readonly", true);
	    
	    //통화단위 변경
	    //$('#currCd').on('change', exrateCal);
		
		if (actionType == "C") {
		     $("#costNo").prop("readonly", true);
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertPchsCost();
			});

		} else if (actionType == "U") {
			$('.tit').text('구매비용 수정')
			
			selectPchsCostInfo();

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updatePchsCost();
			});
		}
		//gridView_S3.initView().setData();
		
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		
	});
	
	//조회
// 	var gridView_S3 = {
// 		initView : function() {
//   			this.target = new ax5.ui.grid();
//   			this.target.setConfig({
//   				showLineNumber : true,
//   				showRowSelector: true,
//   		    	multipleSelect: false,
//   		    	sortable: true,
//   		        target: $('[data-ax5grid="first-grid"]'),
//   		        header: {
//   		        	align: "center",
//   		        	selector: true
//   		        },
//   		        body: {
//   		        	mergeCells : ["coCdNm","salesCd"],
//   		        	 onClick: function () {
//   		                this.self.select(this.dindex);
  		                
//   		              //클릭시  gridView_S2 호출
//   		              //gridView_S2.initView().setData(0);
//   		            },
//   		            onDBLClick: function () {
//   		            	insertIoCostModal("U");
//   		            },
//   		        },

// 				page : {
// 					navigationItemCount : 10,
// 					height : 30,
// 					display : true,
// 					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
// 					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
// 					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
// 					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
// 					onChange : function() {
// 						gridView_S3.setData(this.page.selectPage);
// 					}
// 				},

// 		    	columns : [	
// 		    			{key: "rn"               , label: "No."          , align: "center", width: 60 , hidden: true}						
// 						,{key: "coCd",	    	label: "회사코드",			width: 70,		align: "center", 	hidden:true}
// 						,{key: "coCdNm",	    	label: "회사",			width: 70,		align: "center" }
// 						,{key: "salesCd", 		label: "Sales Code", 	width: 110,		align: "center",	hidden:false}
// 						,{key: "dsgnNo",		label: "도번",			width: 110,		align: "center" }
// 						,{key: "matrCd",		label: "품번",			width: 110,		align: "center" }
// 						,{key: "matrNm",		label: "품명",			width: 110,		align: "center" }
// 						,{key: "matrSpec",		label: "규격",			width: 110,		align: "center" }
// 						,{key: "matrMat",		label: "소재",			width: 110,		align: "center" }
// 						,{key: "matrMakrNm",		label: "MAKER",			width: 110,		align: "center" }
// 						,{key: "matrMno",		label: "형번",			width: 110,		align: "center" }
// 						,{key: "stockQty",		label: "재고수량",			width: 110,		align: "center" }
// 						{
// 			            	key: "chk", label: "", width: 50, sortable: false, align: "center", editor: {
// 			                type: "checkbox", config: {height: 17, trueValue: "Y", falseValue: "N"}}
// 			            },
// 						,{key: "outQty",		label: "폐기수량",			width: 110,		align: "center" }
// 						,{key: "ioRmk",		label: "비고",			width: 110,		align: "center" }										
				
//     	            ]

// 							});
//         			return this;
//         		},

// 		setData : function(_pageNo) {
// //			if (isFirst) return;
// 			var targetObj = this.target;
// //			if (inputValidation($('input[required]'))) {
// 				var formData = {
						
// 						"coCd" : $("#coCd_S").val(),
// 						"coCdNm" : $("#coCdNm").val(),
// 						"salesCd" : $("#salesCd").val(),
// 						"dsgnNo" : $("#dsgnNo").val(),
// 						"matrCd" : $("#matrCd").val(),
// 						"matrNm" : $("#matrNm").val(),
// 						"matrSpec" : $("#matrSpec").val(),
// 						"matrMat" : $("#matrMat").val(),
// 						"matrMakrNm" : $("#matrMakrNm").val(),						
// 						"matrMno" : $("#matrMno").val(),
// 						"stockQty" : $("#stockQty").val(),
// 						//"outWhNm" : $("#outWhCd_S").val(), 체크여부
// 						"outQty" : $("#outQty").val(),
// 						"ioRmk" : $("ioRmk").val()
						
// 				};
				
// 				postAjax("/user/sm/sm05/selectIoModalList", formData, null, function(data){
// 				var list = data.result;
// 					targetObj.setData({
//   						list : list,
//   						page : {
//   							currentPage   : _pageNo,
//   							pageSize      : data.paginationInfo.pageSize,
//   							totalElements : data.paginationInfo.totalRecordCount,
//   							totalPages    : data.paginationInfo.totalPageCount
//   						}
//   					});
//   				});
//   			}
//   		}
	//조회
	
	//통화단위 변경
// 	function exrateCal() {
// 		var currCd = $('#currCd').val();
// 		var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
// 		$('#exrate').val(exrateVal ? exrateVal : '');

// 	}		
	
	function selectPchsCostInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey
		}
		postAjax("/user/sm/sm05/selectIoInfo", formData, null, function(data) {
				$.each(data.result, function(key, value) {
					debugger;
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				
		});
	}



	 // 등록
	function insertIoInfo() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/user/sm/sm05/insertIoInfo", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView_S3.setData(0);
							modalStack.close();									// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateIoInfo() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
	      	filePostAjax("/user/sm/sm05/updateIoInfo", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView_S3.setData(0);
							modalStack.close();
						}
					});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("ordrsClntCd", $('#ordrsClntCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		
		
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	
    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd').val(),
           "salesCd": $('#salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            
            $('#salesCd').val(row.salesCd);   
            $('#ordrsClntCd').val(row.ordrsClntCd);
            $('#clntNm').val(row.ordrsClntNm);
            $('#clntPjt').val(row.clntPjt);
            $('#prdtCd').val(row.prdtCd);
            $('#prdtNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
            $('#eqpNm').val(row.eqpNm);
           
//             $('#vendCd').val(row.ordrsClntCd);
//             $('#vendNm').val(row.ordrsClntNm);
            
//             $('#prdtCd').val(row.prdtCd);
// 			$('#prdtNm').val(row.prdtCdNm);
            
        });
    }
    		
	
	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
// 					$('#mngId').val(row.salesEmpId);
// 					$('#mngNm').val(row.salesEmpNm);

// 					var paramObj = {
// 						"coCd" : $('#coCd').val(),
// 						"clntCd" : row.clntCd
// 					}
// 					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
// 	function setMngInfo(paramObj) {
// 		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
// 				function(data) {
// 					if (data.mngInfo) {
// 						$('#mngId').val(data.mngInfo.salesEmpId);
// 						$('#mngNm').val(data.mngInfo.salesEmpNm);
// 					} else {
// 						$('#mngId').val("");
// 						$('#mngNm').val("");
// 					}
// 				});
// 	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	
	// 자재 품번 팝업 호출하는 함수
    function openMatListSearch(openType) {
          //debugger;
          var paramObj = {
      			"searchValue" : $("#matrNm").val()
          }
          openSecondModal("/static/html/cmn/modal/matListSearch.html", 600, 420, "자재 품번 검색", paramObj, function(grid) {
                        var row = grid.target.getList("selected")[0];
                        if (openType == "P") {
							$('#matrCd').val(row.matrCd);		// 	품번 값 가져오기
							$('#matrNm').val(row.matrNm);	//	품번 값 가져오기
                        } 
                 });
    }
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

</script>