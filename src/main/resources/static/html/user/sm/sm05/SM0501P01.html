<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">폐기 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="SM0501M01">
		
		<table>
			<colgroup>
				<col width="11%">
				<col width="14%">
		        <col width="11%">
		        <col width="14%">
		        <col width="11%">
		        <col width="14%">
		        <col width="11%">
		        <col width="14%">		       
		    </colgroup>
			
			<thead>
				<tr>
				   <td colspan="8" style="height:30px;text-align: left;">기본정보</td>	                                              
				</tr>
			</thead>
			
			<tbody>				
				<!-- 1행 -->
				<tr>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control input-sm" required msg="회사"></select>
					</td>

					<th class="hit">SalesCode</th>
					<td>
						<div class="search_form">
							<input type="text" id="salesCd" name="salesCd" required onkeyup="event.keyCode == 13 ? SalesCodeSearch() : ''">
							<a onclick="SalesCodeSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>

				    <th>고객사</th>
				    <td>
				    	<input type="hidden"  id="ordrsClntCd" name="ordrsClntCd">
				    	<input type="text"  id="clntNm" name="clntNm" >  
				    </td>
				    <th>고객사PJT</th>
				    <td>
				        <input type="hidden" id="clntPjtCd" name="clntPjtCd" >
						<input type="text" id="clntPjt" name="clntPjt" > 
				    </td>
				</tr>
				             
				<!-- 2행 -->
				 <tr>
				    <th>제품구분</th>
				<td>
					<input type="hidden" id="prdtCd" name="prdtCd">
					<input type="text" id="prdtNm" name="prdtNm" >	
				</td>
				<th>아이템구분</th>
				<td>	
					<input type="hidden" id="itemDiv" name="itemDiv">
					<input type="text" id="itemDivNm" name="itemDivNm" >
<!-- 					<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST"  > -->
<!-- 						<option value="">전체</option> -->
<!-- 					</select> -->
				</td>
				<th>설비명</th>
				<td>
					<input type="text" id="eqpNm" name="eqpNm" >
				</td>
				<th></th>
				<th></th>
				</tr>
				
				 <!-- 3행 -->
				 <tr>
				 	<thead>
					    <tr>
				        	<td colspan="8" style="height:30px;text-align: left;">불출정보</th>
				        </tr>
			        </thead>					
			        <tr>
						<th>폐기번호</th>
						<td>
							<input type="text"  id="ioNo" name="ioNo" >
						</td>
						<th class="hit">폐기일자</th>
						<td>
							<input id="ioDt" name="ioDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date msg="폐기일자">
						</td>
						<th class="hit">폐기창고</th>
						<td>
							<select id="outWhCd" name="outWhCd" class="form-control input-sm" required msg="폐기창고"></select>
						</td>
						<th></th>
						<th></th>
					</tr>
				</tr>						
				<!-- 4행 -->
				 <tr>
				    <th>폐기사유</th>				    
				    <td colspan=3>
		            	<input type="text" id="ioResn" name="ioResn">
				    </td>
				    <th>비고</th>
				    <td colspan=3>
			            <input type="text" id="ioRmk" name="ioRmk">
				    </td>
				</tr>
		    </tbody>  
		</table>
    </form>
	</div>
	
	<!-- 콘텐츠 - 폐기창고 재고정보 -->
    <div class="contents no_bg">
	  <!-- 콘텐츠 타이틀 -->
      <div class="contents_tit" style="text-align: left;">
      	<span  style="height: 30px; line-height: 30px;font-size: 15px;">폐기창고 재고정보 </span>        

      </div>
    </div>
	<!-- 콘텐츠 --> 
    <div class="contents">
		<!-- 리스트 -->
      <div class="ax5_grid">
      		<div id="second-grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 250px; width: 100%;"></div>
      </div>
    </div>
   	<!-- 콘텐츠 - 폐기상세 -->

	<!-- 공통 파일 영역 -->
    <div class="col-sm-2" style="padding-right: 5px;">
        <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
            <h3 class="location">
                <span class="page_tit" style="text-align: left;"> 파일트리</span>
            </h3>
            <div id="treeview" style="height: 400px;padding: 5px">
                <div id="deptTreeOrdars"></div>
            </div>
        </div>
    </div>
    <div class="col-sm-10" style="padding-left: 0;">
        <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
            <h3 class="location">
                <a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
            </h3>

            <button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
            <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
        </div>
    </div>
        	
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>

   <!-- 하단 버튼 -->
<div class ="popup_bottom_btn">
	<button type="button" id="actionBtn" authChk>등록</button>
	<button type="button" class="close_btn"
		onclick="modalStack.close();">닫기</button>
</div>

<script type="text/javascript">
	//debugger;
	var actionType = null;
	var fileTrgtKey = null;
	
	var gridView_S3 = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber : true,
				// 체크박스
				//showRowSelector: true,
				multipleSelect : false,
				sortable : true,
				target : $('[data-ax5grid="first-grid-modal"]'),
				header : {
					align: "center",
					selector: false
				},
				
				body : {
					onClick: function () {
						this.self.select(this.dindex);
						var row = this.dindex;
						var col = this.colIndex;
						var paramObj = {"row" : row};
						//debugger;
						//체크박스일 경우 실행
						if( col == 8 ) {
							setoutQty(gridView_S3, this.item.chk , this.item.stockQty, row);                        		
						}
					},
					onDBLClick: function () {
						//this.self.select(this.dindex);
					}
				},
				
				page : {
					navigationItemCount: 9,
					height: 30,
					display: true,
					firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange: function () {
						ModalgridView.setData(this.page.selectPage);
					}
				},
				
				columns : [
					{key: "fileTrgtKey",      label: "첨부파일키", align: "center",   width: 80, hidden: true},
	        	    {key: "No",      label: "No.", align: "center",   width: 40,hidden: true},
	                {key: "dsgnNo", label: "도번", align: "center", width: 200,},
	                {key: "matrCd", label: "품번", align: "center", width: 110,},
	                {key: "matrNm", label: "품명", align: "center", width: 120 },
	                {key: "matrSpec", label: "규격", align: "center", width: 110 },
	                {key: "matrMat", label: "소재", align: "center", width: 80},
	                {key: "matrMakrNm", label: "maker", align: "center", width: 80},
	                {key: "matrMno", label: "형번", align: "center", width: 80},
	                {key: "stockQty", label: "재고수량",  width: 80, align: "right"},
					{key: "chk", label: "선택", width: 50, sortable: false, align: "center",
						editor:{type: "checkbox", config: {trueValue: "Y", falseValue: "N"}}},
					{key: "outQty", label: "출고수량", align: "right", width: 120, formatter: "money",
						editor:{type: "number",
								// disabled: function () {
								// 	// 폐기번호가 있는 경우만 비활성화 
								// 	if(this.item.ioNo == "undefined" || this.item.ioNo == null || this.item.ioNo == ""){
				        		//         return false;
			        			// 	} else {
			        			// 		return true;
			        			// 	}
			        		    // },
			        		    attributes: {
									'maxlength': 8, 'data-maxlength': 15
								}
						}
	                }
				]
			});
			return this;
		},
		
		setData: function(_pageNo) {
			var targetObj = this.target;
			var formData = new FormData();
			var formData = {
				"whCd": $('#outWhCd').val(),
				"salesCd": $('#salesCd').val()
			}
			
			//console.log("outWhCd : "+$('#outWhCd').val());
			//console.log("salesCd : "+$('#salesCd').val());
			//debugger;
			postAjax("/user/sm/sm05/selectIoModalList", formData, null, function(data) {
				debugger;
				var list = data.resultList;
				
				targetObj.setData({
					list : list,
					page : {
						totalElements: list.length
					}
				});
			});
		}
	}
	
	//조회
	$(document).ready(function() {
		// 공통코드 selectBox set
		setCommonSelect($(".popup_area select[data-kind]"));
		//paramObj.coCd 속성 값을 인자로 사용하여 setByCoCd 함수를 호출
		setByCoCd(modalStack.last().paramObj.coCd);		
		$("#popForm #userId").val(jwt.userId);
		
		//폐기일자//
		$('#ioDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		
		gridView_S3.initView();
		
		authChk();						// 권한체크

		getOutWhNm_P();

		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	    
	    //통화단위 변경
	    //$('#currCd').on('change', exrateCal);
		
	    $("#clntNm").prop("readonly", true); //고객사
	    $("#clntPjt").prop("readonly", true);//고객사PJT
	    $("#prdtNm").prop("readonly", true);//제품구분
	    $("#itemDiv").prop("disabled", true);//아이템구분
	    $("#eqpNm").prop("readonly", true);//설비명
		    
		if (actionType == "C") {
		    //$("#costNo").prop("readonly", true);
			$('#actionBtn').text("등록");
			$('#actionBtn').on("click", function() {
				insert_sm05();
			});

		} else if (actionType == "U") {
			
		  	//수정 모드 데이터 가져오기
		    select_sm05_IoInfo();
			//debugger;
		  	//타이틀명 변경
			$('.tit').text('폐기 수정');	
			
			//회사
			$("#coCd").prop("disabled", true);			
			//Sales Code
			$("#salesCd").prop("readonly", true);
			//고객사
			$("#ordrsClntCd").prop("readonly", true);
			$("#clntNm").prop("readonly", true);
			//고객사 PJT
			$("#clntPjtCd").prop("readonly", true);
			$("#clntPjt").prop("readonly", true);
			//제품구분
			$("#prdtCd").prop("readonly", true);
			$("#prdtNm").prop("readonly", true);
			//아이템구분
			$("#itemDiv").prop("readonly", true);
			$("#itemDivNm").prop("readonly", true);
			//설비명
			$("#eqpNm").prop("readonly", true);
			//불출번호
			$("#ioNo").prop("readonly", true);
			//불출일자
			$("#ioDt").prop("readonly", true);			
			//출고창고
			$("#outWhCd").prop("disabled", true);			
			//비고
			$("#ioRmk").prop("readonly", true);
			
			$('#actionBtn').text("수정");
			
// 			$('#actionBtn').on("click", function() {
// 				updateIoInfo();
// 			});
		}
		
		//gridView_S3.initView().setData(0);
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  		
	});
	
	//그리드에 뿌리는 데이터
	function select_sm05_IoInfo() {						
		var formData = {
			"fileTrgtKey" : fileTrgtKey
		}
		postAjax("/user/sm/sm05/select_sm05_IoInfo", formData, null, function(data) {
				$.each(data.result, function(key, value) {
					//debugger;
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				
		});
	}
	
	//#coCd 셀렉트 박스에서 value와 일치하지 않는 옵션들을 제거하는 역할
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	// 수량지정 - 체크박스
	function setoutQty(gridObj, chkVal, stockQty, row) {
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;
		
		var stockQty = parseInt(stockQty);
		
		if(chkVal == "Y") {
			if( stockQty > 0 ) {
				gridObj.target.setValue(row, "outQty", stockQty);
			} else if( isNaN(stockQty) ) {
				gridObj.target.setValue(row, "outQty", 0);
			}
		} else if(chkVal == "N") {
			gridObj.target.setValue(row, "outQty", 0);
		}
	}
	
	//기본정보 & 불출정보 INSERT (모달) 
	function insert_sm05() {
		
		var outWhCd = $('#outWhCd').val(); //폐기창고		
		
        var formData = makeFormData(); //SM0501M01
        
        //var entries = formData.entries();
        //debugger;
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			//var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/user/sm/sm05/insert_sm05", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView_S3.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							//gridView_S3.setData(0);							
							modalStack.close();									// 모달을 닫음
							StockInfoInsert();
				}
			});
		}
	}
	
	//insert - 폐기창고 재고정보(모달)
	function StockInfoInsert() {		
        var formDataInfo = makeInfoFormData();	
       
	}	

	function makeInfoFormData() {
		
		var formDataInfo = new FormData();
		var row = gridView_S3.target.getList();
		
   	    console.log("ioNo : " + $("#ioNo").val()); 
   	    console.log("salesCd : " + $("#salesCd").val()); 

	    var a = 0;
	    
		for(var i=0; i<row.length; i++) {
	    	console.log("i+1 : " + (i+1)); 
			 if(row[i].chk == "Y" ) {
			 //formDataInfo.append("list["+i+"]", gridView3.target.getList()[i] );	
			 //console.log("list["+i+"]", gridView3.target.getList()[i]);
					
			 var cnt = ++a;
				 
			 console.log(i+" 번 삭제 시작 ");
			 formDataInfo.delete('coCd');
			 formDataInfo.delete('ioNo');
			 formDataInfo.delete('dsgnNo');
			 formDataInfo.delete('matrCd');
			 formDataInfo.delete('ioQty');
			 formDataInfo.delete('ioSeq');
			 formDataInfo.delete('salesCd');
			 formDataInfo.delete('userId');
			 formDataInfo.delete('pgmId'); 
			
   	    	 console.log("i+1 : " + (i+1)); 
			 formDataInfo.append("coCd", row[i].coCd);
			 formDataInfo.append("ioNo", $("#ioNo").val());
			 formDataInfo.append("dsgnNo", row[i].dsgnNo);
			 formDataInfo.append("matrCd", row[i].matrCd);
			 formDataInfo.append("ioQty", row[i].outQty);
			 formDataInfo.append("ioSeq", cnt);
			 formDataInfo.append("salesCd", $("#salesCd").val());
			 formDataInfo.append("userId", jwt.userId);
			 formDataInfo.append("pgmId", $("#pgmId").val());
			
			 var entries = formDataInfo.entries();
			
			 //formData  값 확인
	 	     console.log(i+" 번 조회 시작"); 
	         for (const pair of entries) {
	       	     console.log("Key : " + pair[0]+ " value : " + pair[1]); 
	       	 }
			
	         filePostAjax("/user/sm/sm05/insert_sm05_IoInfo", formDataInfo, function(data) {	
				alert(data.resultMessage);
       			
				if (data.resultCode == 200) {
					if(i == row.length) {
						//S3 그리드 해야 TB_SM05D01와 TB_SM05M01에 저장이 된다
						gridView_S3.setData(0);
						modalStack.close();	
						return alert(data.resultMessage);
						
					}
				} else { 
					alert("등록에 실패하였습니다."); 
				}
			});
		} 
	 };  
	}
	
	function makeFormData() {
		// 금액 콤마 제거
// 		$.each($('.popup_area input[comma]'), function(idx, elem) {
// 			deleteComma(elem);
// 		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("pgmId", $("#pgmId").val());
		formData.append("ioDiv", "INOUTDIV_O02");
		formData.append("ordrsClntCd", $('#ordrsClntCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		
		
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}
	
	//Sales Code
    function SalesCodeSearch() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"salesCd": $('#salesCd').val()
		};
		openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#salesCd').val(row.salesCd);
            $('#clntPjt').val(row.clntPjt);
            $('#eqpNm').val(row.eqNm);
            $('#ordrsClntCd').val(row.ordrsClntCd);
            $('#clntNm').val(row.ordrsClntNm);
//             $('#vendCd').val(row.ordrsClntCd);
//             $('#vendNm').val(row.ordrsClntNm);
            $('#eqpNm').val(row.eqpNm);
            $('#prdtCd').val(row.prdtCd);
			$('#prdtNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);

			gridView_S3.setData(0);
        });
    }
	
	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
// 					$('#mngId').val(row.salesEmpId);
// 					$('#mngNm').val(row.salesEmpNm);

// 					var paramObj = {
// 						"coCd" : $('#coCd').val(),
// 						"clntCd" : row.clntCd
// 					}
// 					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
// 	function setMngInfo(paramObj) {
// 		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
// 				function(data) {
// 					if (data.mngInfo) {
// 						$('#mngId').val(data.mngInfo.salesEmpId);
// 						$('#mngNm').val(data.mngInfo.salesEmpNm);
// 					} else {
// 						$('#mngId').val("");
// 						$('#mngNm').val("");
// 					}
// 				});
// 	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	//폐기창고 값 선택 함수    
	function getOutWhNm_P() {
		var paramObj = {
			"codeKind" : "INOUTDIV_O02",
			"coCd"     : $("#coCd").val()
		};
		
		postAjax("/user/sm/sm05/selectOutWhNm", paramObj, null, function (data) {
   	    var row = data.whList;
   	 	//debugger;
		for(var i=0;  i<row.length; i++) {
		    $('#outWhCd').append($('<option>', { 
		        value: row[i].codeId,
				text : row[i].codeNm
		    }));					
		}
		
       });
	}
	
	// 자재 품번 팝업 호출하는 함수
//     function openMatListSearch(openType) {
//           //debugger;
//           var paramObj = {
//       			"searchValue" : $("#matrNm").val()
//           }
//           openSecondModal("/static/html/cmn/modal/matListSearch.html", 600, 420, "자재 품번 검색", paramObj, function(grid) {
//                         var row = grid.target.getList("selected")[0];
//                         if (openType == "P") {
// 							$('#matrCd').val(row.matrCd);		// 	품번 값 가져오기
// 							$('#matrNm').val(row.matrNm);	//	품번 값 가져오기
//                         } 
//                  });
//     }
		
	

</script>