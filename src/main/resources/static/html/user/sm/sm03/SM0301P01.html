<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
}

/* 크기 조절되지 않아 임시로 */
.date_input .input_calendar2 {
    background-color: #fff;
    width: calc(100%) !important;
}

.input_calendar2 {
    background-color: #fff;
    width: 100% !important;
    background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
    background-size: 13px 13px;
    cursor: pointer
}

* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">입고 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId" value="SM0301M01">
		<input type="hidden" id="today"     	name="pgmId" value="">		
	       	
<!-- 입고정보 입력폼 -->
      <table>
        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
        	<td colspan="8" class="title_m_td">입고 정보</td>
        </tr>
        <tr>
			<th>회사</th>
			<td>
			  <!-- <select id="coCd_I" name="coCd_I" data-kind="CO" data-search="coCd" required="required" msg="회사">
			  </select> -->
			  <input type="hidden" id="coCd_I" name="coCd_I" data-search="coCd">
			  <input type="text" id="coCdNm_I" name="coCdNm_I" data-search="coCdNm" msg="회사" readonly="readonly">
			</td>
			<th>입고번호</th>
			<td>
				<input type="hidden" id="ordrgNo_I" name="ordrgNo_I"><!-- 발주번호 set -->
				<input type="text" id="inNo" name="inNo" msg="입고번호" disabled="disabled">
			</td>
			<th class="hit">수불구분</th>
			<td>
				<select id="ioDiv_I" name="ioDiv_I" data-kind="INOUTDIV" data-search="ioDiv" required="required">
			      <option value="">전체</option>
				</select> 
			</td>
			<th>구매처</th>
			<td>
				<input type="text" id="pchsClntNm_I" name="pchsClntNm_I" data-search="pchsClntNm" readonly="readonly">  
			</td>			
        </tr>
        
        <tr>
			<th>Sales Code</th>
			<td>
				<input type="text" id="salesCd_I" name="salesCd_I" data-search="salesCd" msg="Sales Code">		 
			</td>
			<th>요인별요청번호</th>
			<td>
				<input type="text" id="reqNo_I" name="reqNo_I" data-search="reqNo_I" msg="요인별요청번호">
			</td>
			<!-- 그리드로 이동 
			<th class="hit">입고일자</th>
			<td>
				<div class="date_input">
				  <input id="inDt_I" name="inDt_I"  class="input_calendar2" autocomplete="off"
				     required="required" msg="입고일자" data-search="inDt">
				</div>			
			</td>			
			-->	
			<th class="hit">환율</th>
			<td>
				<input type="text" id="exrate_I" name="exrate_I"  data-search="exrate" required="required" data-ax5formatter="money" maxlength="13"  msg="환율" comma />
			</td>
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd_I" name="currCd_I" data-kind="CURR" data-search="currCd" required="required" msg="통화단위">
			      <option value="">전체</option>
				</select>	
			</td>			
		</tr>
		<tr>		

			<th>입고금액</th>
			<td>
				<input type="text" id="sumInDtlAmt" name="sumInDtlAmt"  data-search="sumInDtlAmt" onkeyup="" data-ax5formatter="money" maxlength="13" comma readonly="readonly" />
			</td>					
			<th><!-- 입고비고 --></th>
			<td colspan="6">
				<!-- <input type="text" id="inRmk" name="inRmk"  data-search="inRmk">  -->
			</td>			
        </tr>        
      </table>
    </form>
    
    <div style="padding-bottom:20px;"></div>    
    
    <!-- 입고상세 그리드 -->
	  <div class="contents2" style="margin-bottom: 50px;">
	      <!-- 리스트 -->
		<div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:250px; width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 1px; margin-bottom: 1px;">입고상세 리스트</h5>
	                </div>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a id="deleteDetailButton" style="" authchk>-</a>
		                </div>	                
	                <div>
	                	<div data-ax5grid="wareHousingDetail-grid-modal" data-ax5grid-config="{}" style="height:250px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
		</div>
	</div>
    <!-- 입고상세 그리드 end -->	    
    
    <div style="padding-bottom:20px;"></div>
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button id="reportRegBtn" type="button" onclick="setReportMain('Report');" authChk>발행</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close(); ">닫기</button>
	</div>

<script type="text/javascript">
  
//전역초기화  
var actionType = null;
var paramPrjctSeq = null;
var firstGrid = null;
var secondGrid = null;
var userId = null;
var userNm = null;
var fileTrgtKeyU = null;
	
var gridViewPop = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,	
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="wareHousingDetail-grid-modal"]'),
				header: {
	              align: "center",
	              selector: false
	            },
	            body: {
	            	mergeCells : ["coNm", "salesCd", "matrCd", "matrNm", "matrSpec","ordrgQty","ordrgAmt"],
					onClick: function() {
					    this.self.select(this.dindex);
					    var row = this.dindex;
                        var paramObj = {"row" : row};
                        //체크박스일 경우 실행 - 등록모드만
                        if( this.column.key == "userChk" && actionType == "C" ) {
                        	//chk, 수량, 기입고수량, row번호 
                            $.setInitGridData(gridViewPop, row, this.item);                        		
                        }
                        //수정시 체크해제 불가
                        if( this.column.key == "userChk" && actionType == "U" ) {
                            gridViewPop.target.setValue(row, "userChk", "Y");
                            alert("수정시는 체크 해제 할 수 없습니다.");       
                            return;
                        }                        
					},
					//그리드값 변경시 실행
		            onDataChanged: function () {
					    var row = this.dindex;
					    var col = this.colIndex;

					    var ordrgPrc = 0;
					    //체크박스 변경 제외
					    if( this.key != "userChk" ) {

	            			var inPrc = (this.item.inPrc=="" || typeof(this.item.inPrc)=="undefined")? 0 : this.item.inPrc;
			            	// 발주단가, 발주수량  변경시
			            	if ( this.key == "inPrc" || this.key == "inQty" || this.key == "badQty" ) {   			            		
			            		if( this.item.inQty != "" && this.item.inQty > 0  ) {
			            			var inDtlAmt = parseInt( deleteCommaStr(this.item.inQty) * deleteCommaStr(inPrc) );
			            			gridViewPop.target.setValue(row, "inDtlAmt", inDtlAmt);		
				            		//입고수량 = 합격수량		검사수량 = 합격+불량수량		
				            		if( this.item.badQty !== "" && Number(this.item.badQty) >= 0  ) {
			            				var sInQty = parseInt( this.item.inQty );
			            				var sInspecQty = parseInt( Number(deleteCommaStr(this.item.inQty)) + Number(deleteCommaStr(this.item.badQty)) );	//검사수량
					            		gridViewPop.target.setValue(row, "sInQty", sInQty);		
					            		gridViewPop.target.setValue(row, "sInspecQty", sInspecQty);
					            		
				            		}
			            		} else {
								    gridViewPop.target.setValue(row, "inDtlAmt", "");		            			
			            		}
			            	}           	
							//발주수량 OVER CHK
			            	if ( this.key == "inQty") {			     
			            		if( this.item.inQty != "" && this.item.inQty > 0  ) {			            			
				            		var calcuOrdrgQty = parseInt( Number(deleteCommaStr(this.item.ordrgQty)) - Number(deleteCommaStr(this.item.preInQty)) );
			            			if( this.item.inQty == 0 ) {
									    alert("합격수량은 0 보다 커야 합니다.");
									    gridViewPop.target.setValue(row, "inQty", "");	
									    return;			        
			            			} else if( calcuOrdrgQty == 0 ) {
									    alert("입고 가능 수량이 0입니다.");
									    gridViewPop.target.setValue(row, "ordrgQty", "");	
									    return;		 			            				
			            			} else if( calcuOrdrgQty < this.item.inQty   ) {
				            			//등록일때만 값 초기화
				            			if( actionType == "C" ) gridViewPop.target.setValue(row, "inQty", "");            			
									    alert("입고 수량은 "+ calcuOrdrgQty+" (와)과 같거나 작아야 합니다");
									    return;
				            		}
			            		}
			            	}	
							
					    }					    
		            	 
		            },					
					onDBLClick: function() {

					},
			   },
			   /*
				footSum: [
  			    	[	
  	                 ]
  			    ],
  			    */	    
				columns: [
			 	 	 {key: "fileTrgtKey", 			label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
						,{key: "ordrgNo",	    	label: "ordrgNo",			width: 70,		align: "center", 	hidden:true}
						,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}
						,{key: "inNo",	    		label: "inNo",				width: 70,		align: "center", 	hidden:true}	/* 입고번호 */
						,{key: "inSeq",	    		label: "inSeq",				width: 70,		align: "center", 	hidden:true}	/* 입고순번 */					
						,{key: "reqNo",	    		label: "reqNo",				width: 70,		align: "center", 	hidden:true}						
						,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
						,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 		hidden:true}
						,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 		hidden:true}						
						,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 		hidden:true}						
						,{key: "dsgnNo", 			label: "dsgnNo", 			width: 100,		align: "left", 		hidden:true}						
						,{key: "matrCd", 			label: "자재코드", 			width: 100,		align: "left"}		/* 품번 */						
						,{key: "matrNm", 			label: "자재명", 				width: 150,		align: "left"}		/* 품명 */
						,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "center"}
						,{key: "ordrgQty", 			label: "발주 수량", 			width: 80,		align: "right", formatter: "money"}			/*발주 수량 */
						,{key: "ordrgAmt", 			label: "발주 금액", 			width: 80,		align: "right", formatter: "money"}			/*발주 금액 */
						,{key: "ordrgPrc", 			label: "발주단가", 			width: 80,		align: "right", 		hidden:true}			/*발주 단가 */						
						,{key: "preInQty", 			label: "기입고<br>수량", 		width: 80,		align: "center"}									
						,{key: "notInQty", 			label: "미입고<br>수량", 		width: 80,		align: "center"}								
						,{key: "matrWhCd", 			label: "입고창고Cd", 			width: 100,		align: "center", 	hidden:true}	/* 자재창고 Cd*/						
						,{key: "matrWhNm", 			label: "입고창고", 			width: 100,		align: "center"}	/* 자재창고 */						
						,{key: "matrTestDiv", 		label: "검사구분", 			width: 100,		align: "center", 	hidden:true}	/* 검사구분 */
						,{key: "matrTestDivNm",		label: "검사구분", 			width: 100,		align: "center"}						
						/* 체크박스없이 무조건 입력 */
						,{key: "userChk", 			label: "□", 				width: 50,		align: "center"
								, editor:{type: "checkbox"
											, config: {trueValue: "Y", falseValue: "N"}
						/*
					    					, disabled: function () {                            							
												return this.item.userChkV == "Y";
									  		}
								*/						
										}
						} 
						/* display & edit */
						,{key: "inQty", 			label: "합격수량", 			width: 80,		align: "center", formatter: "money"
								, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
										   } 
						}
						,{key: "badQty", 			label: "불량수량", 			width: 80,		align: "center", formatter: "money"
							, editor: {type:"number" 
										, attributes: { 'maxlength': 13, 'data-maxlength': 15}
									   } 
						}						
						,{key: "inPrc", 			label: "입고단가", 			width: 110,		align: "right", formatter: "money"
							, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
							   		  } 
						}
						,{key: "inDtlAmt", 			label: "압고금액", 			width: 110,		align: "right", formatter: "money"
							/*
							, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
							          }
							*/
						}			
						,{key: "sInspecQty", 			label: "검사수량", 		width: 110,		align: "right", formatter: "money"}							
						,{key: "sInQty", 				label: "입고수량", 		width: 110,		align: "right", formatter: "money"}												
						,{key: "inDt", 		label: "입고일자", 			width:  80,		align: "center"
							, editor: {type: "date"
										, config: {
													content: {
					                            				config: { mode: "day", selectMode: "day" }
					                        				  }
					                    			}
									  }
						}
						,{key: "inDtlRmk", 			label: "입고비고", 			width: 200,		align: "left", formatter: ""
							, editor: {type:"text" 
										, attributes: { 'maxlength': 3000, 'data-maxlength': 3000}
									   } 
					}						
	
	              ]
	        });
			return this;
    	},
		setData: function(_pageNo) {
			var targetObj = this.target;
        	var formData = new FormData();
        	var coCd = $('#coCd_I').val();
        	var salesCd = $('#salesCd_I').val();
        	var fileTrgtKey = (fileTrgtKeyU) ? fileTrgtKeyU : 0;
        	var ordrgNo = $('#ordrgNo_I').val();				//발주번호
        	var ordrgSeq = modalStack.last().paramObj.ordrgSeq;
        	var formData = {
				"coCd" : coCd,
				"salesCd" : salesCd,
				"ordrgNo" : ordrgNo,
				"actionType" : actionType,				
			}
        	//등록과 수정 URL 다르게
        	var url = "selectWareHousingDetailList";
			postAjax("/user/sm/sm03/" + url, formData, null, function(data){
				var list = data.resultList;
				targetObj.setData({
					list : list,
				    page : {
			    		totalElements : list.length,
				    }
				});
				$.popViewInit();
            });
      	   
		} 
	}	

// 권한체크    
authChk();		
	
gridViewPop.initView();

//등록/수정 버튼
actionType = modalStack.last().paramObj.actionType;
if (actionType == "C") {
	$("#actionBtn").text("등록");
	$('#actionBtn').on("click", function() {
		insertWareHousing();
	});
	//발주서발행 btn hide
	$("#reportRegBtn").remove();
} else if (actionType == "U") {
	$('.tit_contents .tit').text('입고 수정')
	
	$('#actionBtn').text("수정");
	$('#actionBtn').on("click", function() {
		updateWareHousing();
	});
}	

// 등록 - done
function insertWareHousing() {
		
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridInsertArr(gridViewPop);
        if( !makeArr ) {
        	return;
        }
        
		if(makeArr.length<1) {
			alert("입고 항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
			//입고번호가 있을경우 set
			if( typeof(modalStack.last().paramObj.inNo) != "undefined" ) {
				formData.append("inNo", modalStack.last().paramObj.inNo);	
			} else {
				formData.append("inNo", "");	
				formData.append("fileTrgtKey", 0);
			}
			formData.append("makeArr", JSON.stringify(makeArr));
			debugger;
		}          
		filePostAjax("/user/sm/sm03/insertWareHousing", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					modalStack.close();									// 모달을 닫음
				}
		});
	}
}

//수정 
function updateWareHousing() {
		
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridInsertArr(gridViewPop);
        if( !makeArr ) {
        	return;
        }
		if(makeArr.length<1) {
			alert("입고 항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
	        //입고번호 set
	        formData.append("ordrgNo", $("#ordrgNo").val());			
			formData.append("makeArr", JSON.stringify(makeArr));
		}          
		filePostAjax("/user/sm/sm03/updateWareHousingDetail", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					modalStack.close();									// 모달을 닫음
				}
		});
	}
}



function makeFormData() {
	// 금액 콤마 제거
	$.each($('.popup_area input[comma]'), function(idx, elem) {
		deleteComma(elem);
	});
	// 날짜 하이픈 제거
	$.each($('.popup_area input[date]'), function(idx, elem) {
		deleteHyphen(elem);
	});
	// 폼데이터 생성
	var formData = new FormData($("#popForm")[0]);
	// 기본값 set
	formData.append("userId", jwt.userId);
	formData.append("currCd", $("#currCd_I").val());
	formData.append("exrate", $("#exrate_I").val());
	formData.append("ioDiv", $("#ioDiv_I").val());
	formData.append("coCd", $("#coCd_I").val());
	formData.append("salesCd", $("#salesCd_I").val());	
	
	//---------------------------------------------------------------  
	//-------itemarr  --첨부화일 처리를 위한 부분 시작
	//---------------------------------------------------------------  

	formData.append("comonCd", treeModule.getFileNodeId());
	var fileUploadArr = [];
	var tempArr = [];
	
	tempArr = treeModule.getFileArr();
	$.each(tempArr, function(idx, obj) {
		if (obj.fileKey == 0) {
            formData.append("files", obj.file);
            obj.file = '';
            fileUploadArr.push(obj);
		}
	});

	formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
	formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
	//---------------------------------------------------------------  
	//--첨부화일 처리를 위한 부분 끝
	//--------------------------------------------------------------- 
	
	return formData;	
}


var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
//---------------------------------------------------------------  
//첨부 화일 처리 시작 
//---------------------------------------------------------------  
fileParam = {
		fileTrgtTyp	: $("#pgmId").val(),
		fileTrgtKey : param_fileTrgtKey
}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
//---------------------------------------------------------------  
//첨부 화일 처리 끝
//---------------------------------------------------------------



$(document).ready(function() {

	//formatter
	$('[data-ax5formatter]').ax5formatter();
	var today = moment(new Date());
	var yesterday = moment(new Date()).add(-1, 'days');
	
	$.initViewPop = function() {
		//combo set
		setCommonSelect($(".popup_area select[data-kind]"));
		userId = modalStack.last().paramObj.userId;
		fileTrgtKeyU = modalStack.last().paramObj.fileTrgtKey;
		//modal 넘어온값만큼 만큼 루프 
		$.each(modalStack.last().paramObj, function (key, val) {		
			if( $("#popForm").find("#"+key).length > 0 ) {
				$("#popForm").find("#"+key).val(val);
			}
			//입고정보 SET
			if( $("#popForm").find("#"+key+"_I").length > 0 ) {
				$("#popForm").find("#"+key+"_I").val(val);
			}			
			
		});
		$("#popForm #userId").val(userId);	
		//작성자 readonly 등 set
		$("#salesCd").attr("readonly", true);
		
		//등록일때만 set
		if(actionType == "C") {
			// 입고일자
			$('#today').datepicker({
					format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true
				})
			.datepicker("setDate", today.toDate());
			//수불구분 구매입고
			$("#ioDiv_I").val("INOUTDIV_I01");
			
			gridViewPop.initView().setData(0);		
			//그리드 삭제버튼 hide
			$(".add_btn.pdl10").hide();
			
		} else if(actionType == "U") {
			//그리드 load
			gridViewPop.initView().setData(0);
			
			//수불구분 구매입고
			$("#ioDiv_I").val("INOUTDIV_I01");
	
			//sale code readonly
			$("#salesCd").attr("readonly", true);
			$("#salesCdAnchor").removeAttr("onclick");
			//그리드 삭제버튼 hide
			$(".add_btn.pdl10").show();			
		}	
	}

	$.initViewPop();

	$.popViewInit = function() {
		//입력모드 set
		var gridList = gridViewPop.target.getList();
		var gridColumns = gridViewPop.target.columns;
		if( modalStack.last().paramObj.actionType == "C" ) {
			if( gridList.length > 0 ) {			
		        $.each(gridList, function (idx, elem) {
		        	//디폴트 Y set
		        	//무검사일 경우만 셋 발주단가도 수량도 set      	
		        	if( elem.matrTestDivNm == "무검사" && Number(elem.notInQty) > 0 ) {
			        	gridViewPop.target.setValue(idx, "userChk", "Y");
			        	$.setInitGridData(gridViewPop, idx, elem);
		        	}
		        	
		        });
			}		
		} else if( actionType == "U" ) {
			//수정인 경우 환율 단위는 입고디테일 첫번째 항목으로 SET
			var gridList = gridViewPop.target.getList();
			if( gridList.length > 0 ) {
				var exrate = gridViewPop.target.getList()[0].exrate;
				var currCd = gridViewPop.target.getList()[0].currCd;
				$("#exrate_I").val(exrate);
				$("#currCd_I").val(currCd);							
			}			
		}
	}
	
	//수량/단가 금액 set
	$.setInitGridData = function(gridObj, idx, elem) {
    	var ordrgQty = elem.ordrgQty
    	var preInQty = elem.preInQty;
    	var notInQty = elem.notInQty;			//미입고수량
    	var matrTestDivNm = elem.matrTestDivNm;
    	var ordrgPrc = elem.ordrgPrc;			//발주단가
    	var inDtlAmt = parseInt(Number(ordrgPrc)*Number(notInQty));		//입고금액
    	var chkVal = gridObj.target.getList()[idx].userChk;

    	//입고 잔량 쳌
    	if( Number(notInQty) == 0 ) {
    		alert("입고 가능한 잔량이 없습니다.");
			gridObj.target.setValue(idx, "userChk", "N");		//입고수량 view    		
    		return;
    	}
    	if(chkVal == "Y" ) {
            gridObj.target.setValue(idx, "inQty", notInQty);		        		
            gridObj.target.setValue(idx, "badQty", 0);			        	
            gridObj.target.setValue(idx, "inPrc", ordrgPrc);	
            gridObj.target.setValue(idx, "inDtlAmt", inDtlAmt);
            gridObj.target.setValue(idx, "inDt", $("#today").val());
            gridObj.target.setValue(idx, "sInspecQty", notInQty);    //검사수량  view
            gridObj.target.setValue(idx, "sInQty", notInQty);		//입고수량 view    		
    	} else if(chkVal == "N") {
            gridObj.target.setValue(idx, "inQty", "");		        		
            gridObj.target.setValue(idx, "badQty", "");			        	
            gridObj.target.setValue(idx, "inPrc", "");	
            gridObj.target.setValue(idx, "inDtlAmt", "");
            gridObj.target.setValue(idx, "inDt", "");
            gridObj.target.setValue(idx, "sInspecQty", "");    //검사수량  view
            gridObj.target.setValue(idx, "sInQty", "");		//입고수량 view   
    	}    	
    	

	}
		
	//등록시 그리드값 배열 저장
	$.gridInsertArr = function(gridObj, mode) {
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;
		var detailArr = [];    	
		var msgArr = [];    	
		var errCnt = 0;
		if( gridList.length > 0 ) {
        	var msgArr = [];			
	        $.each(gridList, function (idx, elem) {
	            var detailObj = {};	     	        	
	        	//컬럼수 루프 
	        	for(var i=0; i<gridColumns.length; i++) {
					var key = gridColumns[i].key;
					var val = elem[key];
					if( typeof(val) == "undefined") val = "";
					//console.log('key:' + key+'=-====>val:' + val);					
					//type number 시 콤마제거
					if( typeof(gridColumns[i].editor) != "undefined" && gridColumns[i].editor.type == "number" && val != "" ) {
						val = deleteCommaStr(val); 
					}	     
					//입고순번 은 select key로  ORDRG_SEQ  
					detailObj[key] = val;			            			            
	        	}
	            //필수값 체크를 여기서 한다. 입고수량, 납기요청일 - 체크된 항목만	            
	            //if( actionType == "C" && 
	            if( actionType == "C" && detailObj['userChk'] == "Y" ) {
	            	//입고수량
		            if( detailObj['inQty'] ==="" || detailObj['inQty'] =="0" ) {
		            	msgArr.push((idx+1)+" 행의 합격수량을 입력해 주십시오.")	;
		            }	 
	            	//입고단가
		            if( detailObj['badQty'] === "" ) {		            	
		            	msgArr.push((idx+1)+" 행의 불량수량을 입력해 주십시오..")	;
		            }	 		            	
	            	//입고단가
		            if( detailObj['inPrc'] =="" || detailObj['inPrc'] =="0" ) {
		            	msgArr.push((idx+1)+" 행의 입고단가를 입력해 주십시오.")	;
		            }	 	            	
		            //납기요청일
		            if(detailObj['dudtDeqDt'] == "" ) {
		            	msgArr.push((idx+1)+" 행의 납기요청일을 입력해 주십시오.")	;		            	
		            }
		            //입고단가 체크 없음??
		            if( detailObj['inDtlAmt'] =="" || detailObj['inDtlAmt'] =="0" ) {
		            	msgArr.push((idx+1)+" 행의 입고금액을 확인해 주십시오.")	;
		            }
		            //입고수량
		            if( Number(detailObj['ordrgQty']) < Number(detailObj['preInQty']) + Number(detailObj['inQty']) ) {
		            	var calQty = parseInt( Number(detailObj['ordrgQty']) - Number(detailObj['preInQty']) );
		            	msgArr.push((idx+1)+" 행의 합격수량은 " + calQty + "보다 작거나 같아야 합니다.")	;
		            }		
		            //합격수량+불량수량 = 미입고
					var sInQty = parseInt( Number(deleteCommaStr(detailObj['inQty'])) + Number(deleteCommaStr(detailObj['badQty'])) );
					if( sInQty > Number(detailObj['notInQty']) ) {
						var calQty2 = parseInt( Number(detailObj['notInQty']) - Number(detailObj['inQty']) );
		            	msgArr.push((idx+1)+" 행의 불량수량은 " + calQty2 + "보다 작거나 같아야 합니다.")	;						
					}
		            //체크된 항목만 저장		            
		            detailArr.push(detailObj);	
				} else if( actionType == "U" ) {
		            detailArr.push(detailObj);	            	
	            }
	            		
	        });			
	        //error alert 후 종료
	        if( msgArr.length > 0 ) {
	        	alert(msgArr.join("\r\n"));
	        	return false;
	        }
		}
		return detailArr;
	}
	
	$("#deleteDetailButton").on("click", function () {
 		var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
 		if( isNaN(selRow) ) {
 			alert("선택된 행이 없습니다.");
 			return;
 		} else { 			
			if(actionType == "U") { 				
 				if( selRow > -1 ) {
 					//기존값이면 D 처리 아니면 row 삭제
 					var coCd = gridViewPop.target.getList()[selRow].coCd;
 					var inNo = gridViewPop.target.getList()[selRow].inNo;
 					var inSeq = gridViewPop.target.getList()[selRow].inSeq;
 					var paramObj = {
 							"coCd" : coCd
 							, "inNo" : inNo
 							, "inSeq" : inSeq
 						} 					
					if( confirm("선택행을 삭제하시겠습니까?\n\n그리드에 변경중인 내용이 초기화 됩니다.")) {
						deleteAjax("/user/sm/sm03/deleteWareHousingDetail", paramObj, null, function(data) {
							if (data.resultCode == 200) {
								alert(data.resultMessage);

								gridViewPop.setData(0);
								$.initViewPop();
								initSearch();
							}
						}); 						
 					}				 							 				
 				} 				
 			} 			
 		}		
	});	
});

function setReportMain(_type) {
	var fileName = "SM0301R01.jrf";
	var arg =  
		  "coCd#"		+  $('#coCd').val()
	    + "#ordrgNo#"	+  $('#ordrgNo').val()
    	+ "#salesCd#"	+  $('#salesCd').val()
    	+ "#";                 
	
	if (_type == 'Report') {
		callReport(fileName, arg, 1150, 720);
	} else { //Export 작업
		ubiExportAjax(fileName, arg, function(response) {
			if (response.resultCode === 200) {
				var base64FileData = response.base64FileData;
				var fileName = response.exportFileName;
				downloadPDFFromBase64(base64FileData, fileName);
			} else {
				alert('PDF 내보내기 실패: ' + response.resultText);
			}

		});
	}
}

</script>
