<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
}

/* 크기 조절되지 않아 임시로 */
.date_input .input_calendar2 {
    background-color: #fff;
    width: calc(100%) !important;
}

.input_calendar2 {
    background-color: #fff;
    width: 100% !important;
    background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
    background-size: 13px 13px;
    cursor: pointer
}

* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">입고 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<!-- <input type="hidden" id="fileTrgtKey"     	name="fileTrgtKey"> -->
		<input type="hidden" id="pgmId"     	name="pgmId" value="SM0301M01">
		<input type="hidden" id="today"     	name="today" value="">		
		<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
		<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->			
	       	
<!-- 입고정보 입력폼 -->
      <table>
        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
        	<td colspan="8" class="title_m_td">입고 정보</td>
        </tr>
        <tr>
			<th>회사</th>
			<td>
			  <input type="hidden" id="coCd" name="coCd" data-search="coCd">
			  <input type="text" id="coCdNm" name="coCdNm"  class="form-control" data-search="coCdNm" msg="회사" readonly="readonly">
			</td>
			<th>Sales Code</th>
			<td>
				<input type="text" id="salesCd" name="salesCd" class="form-control" data-search="salesCd" msg="Sales Code">		 
			</td>									 
			<th>고객사</th>
			<td>
				<input type="hidden" id="ordrsClntCd" name="ordrsClntCd" data-search="ordrsClntCd">
				<!-- <div class="search_form">  -->
					<input type="text" id="ordrsClntNm" name="ordrsClntNm" data-search="ordrsClntNm" readonly="readonly"> 
					<a onclick="openClntSearchP('P');"><i class="i_search_w"></i></a>
				<!-- </div>  -->			
			</td>			
			
			<th>고객사PJT</th>
			<td>
				<!-- <input type="text" id="clntPjt" name="clntPjt" data-search="clntPjt" msg="고객사PJT" readonly="readonly">  -->
				<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" data-search="clntPjt" readonly="readonly">	
			      <option value="">전체</option>
				</select>				  
			</td>		
        </tr>
        
        <tr>
			<th>구매처</th>
			<td>
				<input type="text" id="pchsClntNm" name="pchsClntNm" class="form-control" data-search="pchsClntNm" readonly="readonly">  
				<input type="hidden" id="pchsClntCd" name="pchsClntCd" class="form-control" data-search="pchsClntCd" readonly="readonly">  
			</td>	        
			<!-- 그리드로 이동 
			<th class="hit">입고일자</th>
			<td>
				<div class="date_input">
				  <input id="inDt_I" name="inDt_I"  class="input_calendar2" autocomplete="off"
				     required="required" msg="입고일자" data-search="inDt">
				</div>			
			</td>			
			-->	
			<th>SalesCde별 별요청번호</th>
			<td>
				<input type="text" id="reqNo" name="reqNo" class="form-control" data-search="reqNo" msg="요인별요청번호" readonly="readonly">  
			</td>			
			<th>입고금액</th>
			<td>
				<input type="text" id="sumInDtlAmt" name="sumInDtlAmt"  class="form-control" data-search="sumInDtlAmt" onkeyup="" comma readonly="readonly" />
			</td>				
			<th>장비명</th>
			<td colspan="0">
				<input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm" msg="설비명" readonly="readonly">
			</td>							
		</tr>
		<tr>		
			<th>발주번호</th>
			<td>
				<input type="text" id="ordrgNo" name="ordrgNo" readonly><!-- 발주번호 set -->
			</td>			
			<th>발주일자</th>
			<td>
				<input type="text" id="ordrgDt" name="ordrgDt" readonly><!-- 발주일자 set -->
			</td>
			<th></th>
			<td>
			</td>
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" class="form-control" data-search="currCd" required="required" msg="통화단위">
			      <option value="">전체</option>
				</select>	
			</td>			
        </tr>        
		<tr>		
			<th>입고번호</th>
			<td>
				<input type="hidden" id="ordrgNo" name="ordrgNo"><!-- 발주번호 set -->
				<input type="hidden" id="ordrgDt" name="ordrgDt"><!-- 발주일자 set -->
				<input type="text" id="inNo" name="inNo" class="form-control" msg="입고번호" disabled="disabled">
			</td>		
			<th>발주담당자</th>
			<td>
				<input type="text" id="ordrgMngNm" name="ordrgMngNm" readonly><!-- 발주담당자 set -->	
			</td>	
			<th class="hit">수불구분</th>
			<td>
				<select id="ioDiv" name="ioDiv" class="form-control" data-kind="INOUTDIV" data-search="ioDiv" required="required" msg="수불구분">
			      <option value="">전체</option>
				</select> 
			</td>
			<th class="hit">환율</th>
			<td>
				<input type="text" id="exrate" name="exrate"  class="form-control" data-search="exrate" required="required" msg="환율" comma readonly="readonly" />
			</td>
				
			<th><!-- 입고비고 --></th>
			<td colspan="0">
				<!-- <input type="text" id="inRmk" name="inRmk"  data-search="inRmk">  -->
			</td>
        </tr>        
      </table>
    </form>
    
    <div style="padding-bottom:20px;"></div>    
    
    <!-- 입고상세 그리드 -->
	  <div class="contents2">
	      <!-- 리스트 -->
		<div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 1px; margin-bottom: 1px;">입고상세 리스트</h5>
	                </div>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a id="inProcessCheck" style="height: 30px; line-height: 28px; width: 80px;" authchk><i class="fas fa-check-double"></i> 전체선택 </a>
		                    <a id="deleteDetailButton" style="height: 30px; line-height: 28px; width: 120px;" authchk><i class="fas fa-backspace"></i> 입고 아이템 삭제 </a>
		                </div>	                
	                <div>
	                	<div data-ax5grid="wareHousingDetail-grid-modal" data-ax5grid-config="{}" style="height:250px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
		</div>
	</div>
    <!-- 입고상세 그리드 end -->	    
    
    <div style="padding-bottom:20px;"></div>
	<!-- 공통 파일 영역 -->
	<div id="fileList_area" style="margin-bottom: 40px;"></div>

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" id="fileUpBtn" form="popForm" authChk>첨부파일저장</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" id="mailSendBtn" onclick="sendMailCall();" authChk><i class="fas fa-envelope"></i> 발주명세서메일</a></button>
	</div>

<script type="text/javascript">
//전역초기화  
var actionType = null;
var fileTrgtKey = null;
var currToday = [];
//제한일자
var limitDate = null;
var limit_list_yn = "N";

var thisGridRow=0; // 선택된 행 정보 저장할 변수
var thisGridCol=0; // 선택된 열 정보 저장할 변수
var beforeGridSize = 0; //수주상세그리드의 갯수용 그리드컨텐츠 높이조절용
var param_fileTrgtKey;

var gridViewPop = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,	
				showRowSelector: false,
				multipleSelect: false,
				sortable: true,
				target: $('[data-ax5grid="wareHousingDetail-grid-modal"]'),
				header: {
	              align: "center",
	              selector: false
	            },
	            body: {
	            	mergeCells : ["salesCd", ],
					onClick: function() {
					    this.self.select(this.dindex);
					    var row = this.dindex;
                        var paramObj = {"row" : row};
                        //체크박스일 경우 실행 - 등록모드만
                        if( this.column.key == "userChk" && actionType == "C" ) {
                        	//chk, 수량, 기입고수량, row번호 
                            $.setInitGridData(gridViewPop, row, this.item);                        		
                        }
                        //수정시 체크해제 불가
                        if( this.column.key == "userChk" && actionType == "U" ) {
                            gridViewPop.target.setValue(row, "userChk", "Y");
                            customAlert("수정시는 체크 해제 할 수 없습니다.");       
                            return;
                        }                        
					},
					//그리드값 변경시 실행
		            onDataChanged: function () {
						var row = this.dindex;
						var col = this.colIndex;
						var ordrgPrc = 0;
						
						//체크박스 변경 제외
						if( this.key != "userChk" ) {
							if (this.item.inPrc == 0) {
								//입고단가가 0
								//발주단가가 있으면 발주단가를 입고단가로 설정, 발주단가가 없으면 최정 거래 단가를 불러옴.
								if (this.item.ordrgPrc > 0) {
									//발주단가가 없으면 최종 거래내역단가를 불러옴
									let inQty = this.item.inQty;
									let inPrc = this.item.ordrgPrc;
									gridViewPop.target.setValue(row, "inPrc", inPrc);
									var inDtlAmt = parseFloat( deleteCommaStr(inQty) * deleteCommaStr(inPrc) );
									gridViewPop.target.setValue(row, "inDtlAmt", inDtlAmt);
								} else {
									//최종단가 set
									var paramObj = {
										"coCd"       : $("#popForm #coCd").val(),
										"matrCd"     : this.item.matrCd,
										"pchsClntCd" : $("#popForm #pchsClntCd").val(),
										"curr"       : $("#popForm #currCd").val()
									};
									let inQty = this.item.inQty;
									postAjax("/user/sm/sm02/selectCurrMatrUpr", paramObj, null, function(data) {
										if (data.resultList != null) {
											let inPrc = data.resultList;
											gridViewPop.target.setValue(row, "inPrc", inPrc);
											var inDtlAmt = parseFloat( deleteCommaStr(inQty) * deleteCommaStr(inPrc) );
											gridViewPop.target.setValue(row, "inDtlAmt", inDtlAmt);
										}
									});
								}
							}
							
							var inPrc = (this.item.inPrc=="" || typeof(this.item.inPrc)=="undefined")? 0 : this.item.inPrc;
							// 발주단가, 발주수량  변경시			-- 불량제거 20230830
							if ( this.key == "inPrc" || this.key == "inQty" /* || this.key == "badQty" */ ) {
								if( this.item.inQty != "" && this.item.inQty > 0  ) {
									var inDtlAmt = parseFloat( deleteCommaStr(this.item.inQty) * deleteCommaStr(inPrc) );
									gridViewPop.target.setValue(row, "inDtlAmt", inDtlAmt);
									//입고수량 = 합격수량		검사수량 = 합격+불량수량
				            		/*
				            		if( this.item.badQty !== "" && Number(this.item.badQty) >= 0   ) {
			            				var sInQty = parseInt( this.item.inQty );
			            				var sInspecQty = parseInt( Number(deleteCommaStr(this.item.inQty)) + Number(deleteCommaStr(this.item.badQty)) );	//검사수량
					            		gridViewPop.target.setValue(row, "sInQty", sInQty);
					            		gridViewPop.target.setValue(row, "sInspecQty", sInspecQty);
				            		}
				            		*/
									var sInQty = parseFloat( this.item.inQty );
									gridViewPop.target.setValue(row, "sInQty", sInQty);
									gridViewPop.target.setValue(row, "sInspecQty", sInQty);
								} else {
									gridViewPop.target.setValue(row, "inDtlAmt", "");
								}
							}
							
							//발주수량(합격수량) OVER CHK
							if ( this.key == "inQty") {
								if( this.item.inQty != "" && this.item.inQty > 0  ) {
									var calcuOrdrgQty = parseFloat( Number(this.item.ordrgQty) - Number(this.item.preInQty) );
									if( this.item.inQty == 0 ) {
										customAlert("합격수량은 0 보다 커야 합니다.");
										gridViewPop.target.setValue(row, "inQty", "");
										return;
									} else if( calcuOrdrgQty == 0 ) {
										customAlert("입고 가능 수량이 0입니다.");
										gridViewPop.target.setValue(row, "inQty", this.item.ordrgQty);
										return;
									} else if( calcuOrdrgQty < this.item.inQty ) {
										//등록일때만 값 초기화
										if( actionType == "C" ) gridViewPop.target.setValue(row, "inQty", "");
										customAlert("입고 수량은 "+ calcuOrdrgQty+" (와)과 같거나 작아야 합니다");
										return;
									}
								}
							}
							
							// 입고확인일장(inDt)
							if ( this.key == "inDt") {
								// console.log(this.item.inDt, this.item.ordrgDt, this.item.arrDttm);
								if( this.item.inDt < this.item.ordrgDt ) {
									customAlert("발주일자 이전날자로 입고 처리 할 수 없습니다.");
									return false;
								}
								if( this.item.inDt < this.item.arrDttm ) {
									customAlert("입고확인일자 이전날자로 입고 처리 할 수 없습니다.");
									return false;
								}
								// 제한일자 체크
								limit_date_chk(this.item.inDt);
							}
						}
					},
					onDBLClick: function() {
						
					},
				},
				footSum: [
  			    	[
  			    		{label: "합계", colspan:5, align:"center"},
  			    		{key: "ordrgQty",			collector: "sum", formatter:"money", align: "right"},  		
  			    		{key: "ordrgAmt",			collector: "sum", formatter:"money", align: "right"},
  			    		{key: "preInQty",			collector: "sum", formatter:"money", align: "center"},  		
  			    		{key: "notInQty",			collector: "sum", formatter:"money", align: "center"},  
  			    		{},
  			    		{},
  			    		{},		
  			    		{key: "inQty",			collector: "sum", formatter:"money", align: "right"},  		
  			    		{key: "badQty",			collector: "sum", formatter:"money", align: "right"},
  			    		{},	 		
  			    		{key: "inDtlAmt",			collector: "sum", formatter:"money", align: "right"},  		
  			    		{key: "sInspecQty",			collector: "sum", formatter:"money", align: "right"},  		
  			    		{key: "sInQty",			collector: "sum", formatter:"money", align: "right"},  		
  	                 ]
  			    ],  
				columns: [
			 	 	 {key: "fileTrgtKey", 			label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
						,{key: "ordrgNo",	    	label: "ordrgNo",			width: 70,		align: "center", 	hidden:true}
						,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}
						,{key: "inNo",	    		label: "inNo",				width: 70,		align: "center", 	hidden:true}	/* 입고번호 */
						,{key: "inSeq",	    		label: "inSeq",				width: 70,		align: "center", 	hidden:true}	/* 입고순번 */					
						,{key: "reqNo",	    		label: "reqNo",				width: 70,		align: "center", 	hidden:true}						
						,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center", 	hidden:true}
						,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 		hidden:true}
						,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 		hidden:true}						
						,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 		hidden:true}						
						,{key: "dsgnNo", 			label: "dsgnNo", 			width: 180,		align: "left", 		hidden:false}			
						,{key: "matrNm", 			label: "자재명", 				width: 150,		align: "left"}		/* 품명 */
						,{key: "matrMat", 			label: "소재/Maker",			width: 150,		align: "left"}		/* 소재 */
						,{key: "matrSpec", 			label: "형번", 				width: 120,		align: "left"}
						,{key: "matrSize", 			label: "크기", 				width: 100,		align: "center"}
						,{key: "ordrgQty", 			label: "발주수량", 			width: 60,		align: "right", formatter: "money"}			/*발주 수량 */
						,{key: "ordrgAmt", 			label: "발주금액", 			width: 100,		align: "right", formatter: "money"}			/*발주 금액 */
						,{key: "ordrgPrc", 			label: "발주단가", 			width: 60,		align: "right", 		hidden:true}			/*발주 단가 */						
						,{key: "preInQty", 			label: "기입고<br>수량", 		width: 60,		align: "center"}									
						,{key: "notInQty", 			label: "미입고<br>수량", 		width: 60,		align: "center"}	             
			            ,{key: "dudtDeqDt",      	label: "납기요청일",      align: "center",   width: 90}													
						/* 체크박스없이 무조건 입력 */
						,{key: "userChk", 			label: "선택", 				width: 50,		align: "center"
								, editor:{type: "checkbox"
											, config: {trueValue: "Y", falseValue: "N"}
					    					, disabled: function () {                            							
												return this.item.notInQty == "0";
									  		}
										}
						} 
						/* display & edit */
						,{key: "inDt", 		label: "입고일자", 			width:  80,		align: "center"
							, editor: {type: "date"
										, config: {
													content: {
					                            				config: { mode: "day", selectMode: "day" }
					                        				  }
					                    			}
									  }
						}					
						,{key: "inQty", 			label: "합격수량", 			width: 60,		align: "right", formatter: "money"
							, editor: {type:"number" 
										, attributes: { 'maxlength': 13, 'data-maxlength': 15}
									   } 
						}		
						,{key: "badQty", 			label: "불량수량", 			width: 60,		align: "right", formatter: "money"
							, editor: {type:"number" 
										, attributes: { 'maxlength': 13, 'data-maxlength': 15}
									   } 
							, hidden:false
						}											
					
						,{key: "inPrc", 			label: "입고단가", 			width: 100,		align: "right", formatter: "money"
							, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
							   		  } 
						}
						,{key: "inDtlAmt", 			label: "입고금액", 			width: 100,		align: "right", formatter: "money"
							/*
							, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
							          }
							*/
						}			
						,{key: "sInspecQty", 			label: "검사수량", 		width: 60,		align: "right", formatter: "money"}							
						,{key: "sInQty", 				label: "입고수량", 		width: 60,		align: "right", formatter: "money"}
						,{key: "ordrgDt", 			label: "발주일자", 			width: 80,		align: "center"}	/* 발주일자 */	
						,{key: "arrDttm", 			label: "입고확인", 			width: 80,		align: "center"}	/* 입고확인일자 */							
						,{key: "matrWhCd", 			label: "입고창고Cd", 			width: 100,		align: "center", 	hidden:true}	/* 자재창고 Cd*/						
						,{key: "matrWhNm", 			label: "입고창고", 			width: 100,		align: "center"}	/* 자재창고 */						
						,{key: "matrTestDiv", 		label: "검사구분", 			width: 100,		align: "center", 	hidden:true}	/* 검사구분 */
						,{key: "matrTestDivNm",		label: "검사구분", 			width: 70,		align: "center"}						
						,{key: "inDtlRmk", 			label: "입고비고", 			width: 200,		align: "left", formatter: ""
							, editor: {type:"text" 
										, attributes: { 'maxlength': 3000, 'data-maxlength': 3000}
									   } 
						}													
						,{key: "matrCd", 			label: "자재코드", 			width: 80,		align: "left"}		/* 품번 */		
	
	              ]
	        });
			return this;
    	},
		setData: function(_pageNo) {
			var targetObj = this.target;
        	var formData = new FormData();
        	var coCd = $('#coCd').val();
        	var salesCd = $('#salesCd').val();
        	var fileTrgtKey = (fileTrgtKey) ? fileTrgtKey : 0;
        	var ordrgNo = $('#ordrgNo').val();				//발주번호
        	var ordrgSeq = modalStack.last().paramObj.ordrgSeq;
        	var inNo = modalStack.last().paramObj.inNo;
        	var formData = {
				"coCd" : coCd,
				"salesCd" : salesCd,
				"ordrgNo" : ordrgNo,
				"ordrgSeq" : ordrgSeq,
				"inNo" : inNo,
				"actionType" : actionType,				
			}
        	//건건이 보여줄 경우 사용. 현재는 입력된 항목 전부
        	if(actionType == "U") {
        		var addParam = {ordrgSeq : ordrgSeq }
        		//Object.assign(formData, addParam);
        	}
        	//등록과 수정 URL 다르게
			postAjax("/user/sm/sm03/selectWareHousingDetailList", formData, null, function(data){
				try {
					var list = data.resultList;
					targetObj.setData({
						list : list,
						page : {
							totalElements : list.length,
						}
					});
					$.popViewInit();

					let mininDt = '99991231';
					$.each(list, function (idx, elem) {
						if (Number(elem.notInQty) != 0) {
							$('#mailSendBtn').hide();
						}
						let tempInDt = elem.inDt==undefined? "" : elem.inDt.replace(/\-/g, '');
						if (Number(tempInDt) != 0 ) {
							if (mininDt > tempInDt) {
								mininDt = tempInDt;	//가장빠른 입고일자 검색
							}
						}
					});
					
					//마감일자 체크
					if (!monthCloseChk( mininDt,"C", $('#coCd').val())) {
						$('#actionBtn').hide();
						$('#fileUpBtn').show();
					} else {
						$('#fileUpBtn').hide();
					}
					
					//그리드 크기 동적 할당
					gridResize(list.length); //그리드 높이 조정
					

					//백엔드에서 해당 거래처의 문제현황을 검색해오기
					//메세지 뿌리기
					toastMsg('M', $('#pchsClntCd').val(), list);	// (M:업무구분, $('#pchsClntCd').val():공급사코드, list:자재리스트)
				} catch (error) {
					customAlert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
            });
      	   
		} 
	}	

// 등록 - done
function insertWareHousing() {
		
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridInsertArr(gridViewPop);
        if( !makeArr ) {
        	return;
        }

    	//마감일자 체크
    	for(i=0; i < makeArr.length; i++) {
	    	if (!monthCloseChk( makeArr[i].inDt,"", $('#coCd').val())) {
	    		return false;
	    	}
    	}
		if(makeArr.length<1) {
			customAlert("입고 항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
			//입고번호가 있을경우 set
			const inNo = modalStack.last()?.paramObj?.inNo;
			if (inNo != null && String(inNo).trim() !== '') {
				formData.append("inNo", inNo);
				formData.append("fileTrgtKey", param_fileTrgtKey);
			} else {
				formData.append("inNo", "");	
				formData.append("fileTrgtKey", 0);
			}
			formData.append("makeArr", JSON.stringify(makeArr));
		}          
		filePostAjax("/user/sm/sm03/insertWareHousing", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					modalStack.close();									// 모달을 닫음
				} else {
					customAlert(data.resultMessage);
				}
		});
	}
}

//수정 
function updateWareHousing() {
		
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridInsertArr(gridViewPop);
        if( !makeArr ) {
        	return;
        }

    	//마감일자 체크
    	for(i=0; i < makeArr.length; i++) {
	    	if (!monthCloseChk( makeArr[i].inDt,"", $('#coCd').val())) {
	    		return false;
	    	}
    	}
        
		if(makeArr.length<1) {
			customAlert("입고 항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
	        //입고번호 set
	        formData.append("ordrgNo", $("#ordrgNo_I").val());			
			formData.append("makeArr", JSON.stringify(makeArr));
		}          
		
		formData.append("fileTrgtKey", param_fileTrgtKey);
		filePostAjax("/user/sm/sm03/updateWareHousingDetail", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					modalStack.close();									// 모달을 닫음
				} else {
					customAlert(data.resultMessage);
				}
		});
		
	}
}



function makeFormData() {

	// 금액 콤마 제거
	$.each($('.popup_area input[comma]'), function(idx, elem) {
		deleteComma(elem);
	});
	// 날짜 하이픈 제거
	$.each($('.popup_area input[date]'), function(idx, elem) {
		deleteHyphen(elem);
	});
	// 폼데이터 생성
	var formData = new FormData($("#popForm")[0]);
	// 기본값 set
	formData.append("userId", jwt.userId);
	formData.append("currCd", $("#popForm #currCd").val());
	formData.append("exrate", $("#popForm #exrate").val());
	formData.append("ioDiv", $("#ioDiv").val());
	formData.append("coCd", $("#coCd").val());
	formData.append("salesCd", $("#salesCd").val());	
	
	//---------------------------------------------------------------  
	//-------itemarr  --첨부화일 처리를 위한 부분 시작
	//---------------------------------------------------------------  

	formData.append("comonCd", treeModule.getFileNodeId());
	var fileUploadArr = [];
	var tempArr = [];
	
	tempArr = treeModule.getFileArr();
	$.each(tempArr, function(idx, obj) {
		if (obj.fileKey == 0) {
            formData.append("files", obj.file);
            obj.file = '';
            fileUploadArr.push(obj);
		}
	});

	formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
	formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
	//---------------------------------------------------------------  
	//--첨부화일 처리를 위한 부분 끝
	//--------------------------------------------------------------- 
	
	return formData;	
}


$(document).ready(function() {
	//권한체크    
	authChk();		
	// 입고관리 프로그램 fileTrgtKey set
	// $("#fileTrgtKey").val(modalStack.last().paramObj.fileTrgtKey);
		
	gridViewPop.initView();

	//제한일자 지정
	limitDate = modalStack.last().paramObj.limitDate;

	//등록/수정 버튼
	actionType = modalStack.last().paramObj.actionType;
	if (actionType == "C") {
		$("#actionBtn").text("등록");
		$('#actionBtn').on("click", function() {
			insertWareHousing();
		});
		//발주서발행 btn hide
		$("#reportRegBtn").remove();
	} else if (actionType == "U") {
		$('.tit_contents .tit').text('입고 수정')
		
		$('#actionBtn').text("수정");
		$('#actionBtn').on("click", function() {
			updateWareHousing();
		});
	}

	toast.init();

	//formatter
	var today = moment(new Date());
	var yesterday = moment(new Date()).add(-1, 'days');

	$.initViewPop = function() {
		//combo set
		setCommonSelect($(".popup_area select[data-kind]"));
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		$("#popForm #userId").val(modalStack.last().paramObj.userId);	
		//작성자 readonly 등 set
		$("#popForm #salesCd").attr("readonly", true);
		$("#popForm #coCd").css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		$("#popForm #clntPjt").css({'background-color':'#e6e6e6', 'pointer-events':'none'});		
		//등록일때만 set
		if(actionType == "C") {
			// 입고일자
			$('#today').datepicker({
					format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true
				})
			.datepicker("setDate", today.toDate());
			
			//modal 넘어온값만큼 만큼 루프 
			$.each(modalStack.last().paramObj, function (key, val) {		
				//입고정보 SET
				if( $("#popForm").find("#"+key).length > 0 ) {
					$("#popForm").find("#"+key).val(val);
				}			
			});
			
        	var paramObj = {
    				"coCd" : $('#coCd').val(),
    				"salesCd" : $('#salesCd').val(),
    				"ordrgNo" : $('#ordrgNo').val(),
    				"actionType" : actionType,				
    			}
			postAjaxSync("/user/sm/sm02/selectOrderDetailView", paramObj, null, function(data){
				var list = data.resultList;
 				if( list.length > 0 ) {
			        $.each(list[0], function (key, val) {	
						//html element overwrite set
						if( val && typeof($("#"+key).attr("name")) != "undefined" ) {
							$("#popForm #"+key).val(val);
							if ($('#popForm #' + key).is('[comma]')) {
								onlyNumber($('#popForm #' + key)[0]);
							}
						}
					});			
				} 
			});				
			

			//수불구분 구매입고
			$("#popForm #ioDiv").val("INOUTDIV_I01");			
			
			gridViewPop.initView().setData(0);			
			//그리드 삭제버튼 hide
			$("#deleteDetailButton").hide();
			$("#inProcessCheck").show();
			
		} else if(actionType == "U") {
			postAjaxSync("/user/sm/sm03/selectWareHousingDetailInfo", modalStack.last().paramObj, null, function(data){
					var list = data.resultList;
	 				if( list.length > 0 ) {
				        $.each(list[0], function (key, val) {	
							//html element overwrite set
							if( val && typeof($("#"+key).attr("name")) != "undefined" ) {
								$("#popForm #"+key).val(val);
								if ($('#popForm #' + key).is('[comma]')) {
									onlyNumber($('#popForm #' + key)[0]);
								}
							}
							// if (key == "fileTrgtKey") {
							// 	$("#popForm #fileTrgtKey").val(modalStack.last().paramObj.fileTrgtKey);
							// }
						});
					} 
			});
			//그리드 load
			gridViewPop.initView().setData(0);
				
			//sale code readonly
			$("#popForm #salesCd").attr("readonly", true);
			$("#popForm #salesCdAnchor").removeAttr("onclick");
			//그리드 삭제버튼 hide
			$("#deleteDetailButton").show();	
			$("#inProcessCheck").hide();		

		}	
		
		//환율 load
		var paramObj = {
						"userId" : jwt.userId
						, "codeKind" : "CURR"
						/* , "codeId" : $("#popForm #currCd").val() */
						};
		postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null
					, function(data) {   
						if(data.resultList.length > 0 ) {
							currToday = data.resultList;
						}
		});     //user search ajax end	

	}

	$.initViewPop();
	
	$.popViewInit = function() {
		//입력모드 set
		var gridList = gridViewPop.target.getList();
		var gridColumns = gridViewPop.target.columns;
		if( modalStack.last().paramObj.actionType == "C" ) {
			if( gridList.length > 0 ) {			
		        $.each(gridList, function (idx, elem) {
		        	//디폴트 Y set
		        	//무검사일 경우만 셋 발주단가도 수량도 set -- 합격수량은 참고용이어서 제거 20231027
		        	/*
		        	if( elem.matrTestDivNm == "무검사" && Number(elem.notInQty) > 0 ) {
			        	gridViewPop.target.setValue(idx, "userChk", "Y");
			        	$.setInitGridData(gridViewPop, idx, elem);
		        	}
		        	*/
		        });
			}		
			//환율 원화 default set
			$("#popForm #currCd").val("CURR01");
			$("#popForm #currCd").val("CURR01").trigger('change');
		} else if( actionType == "U" ) {
			//수정인 경우 환율 단위는 입고디테일 첫번째 항목으로 SET
			var gridList = gridViewPop.target.getList();
			if( gridList.length > 0 ) {
				var exrate = gridViewPop.target.getList()[0].exrate;
				var currCd = gridViewPop.target.getList()[0].currCd;
				$("#popForm #currCd").val(currCd);				
				$("#popForm #exrate").val(exrate);							
			}			
		}
	}
	
	//등록시 통화단위에 따른 환율 SET
	$('#popForm #currCd').on("change", function() {
		if(actionType == "C" && $(this).val() != "" ) {
			var selVal = $(this).val();
			var find = currToday.find(e => e.codeId === selVal);
			if( typeof(find.codeEtc) != "undefined" ) {
				$('#popForm #exrate').val(find.codeEtc);	
			}
		} else if( actionType == "C" && $(this).val() == "" ) {
			$('#popForm #exrate').val('');
		}
	});	
	
	//수량/단가 금액 set
	$.setInitGridData = function(gridObj, idx, elem) {
    	var ordrgQty = elem.ordrgQty
    	var preInQty = elem.preInQty;
    	var notInQty = elem.notInQty;			//미입고수량
    	var matrTestDivNm = elem.matrTestDivNm;
    	var ordrgPrc = elem.ordrgPrc;			//발주단가
    	var inDtlAmt = parseInt(Number(ordrgPrc)*Number(notInQty));		//입고금액
    	var chkVal = gridObj.target.getList()[idx].userChk;

    	//입고 잔량 쳌
    	if( Number(notInQty) == 0 ) {
    		customAlert("입고 가능한 잔량이 없습니다.");
			gridObj.target.setValue(idx, "userChk", "N");		//입고수량 view    		
    		return;
    	}
    	if(chkVal == "Y" ) {
            gridObj.target.setValue(idx, "inQty", notInQty);		        		
            gridObj.target.setValue(idx, "badQty", 0);			        	
            gridObj.target.setValue(idx, "inPrc", ordrgPrc);	
            gridObj.target.setValue(idx, "inDtlAmt", inDtlAmt);
            gridObj.target.setValue(idx, "inDt", $("#today").val());
            gridObj.target.setValue(idx, "sInspecQty", notInQty);    //검사수량  view
            gridObj.target.setValue(idx, "sInQty", notInQty);		//입고수량 view    		
    	} else if(chkVal == "N") {
            gridObj.target.setValue(idx, "inQty", "");		        		
            gridObj.target.setValue(idx, "badQty", "");			        	
            gridObj.target.setValue(idx, "inPrc", "");	
            gridObj.target.setValue(idx, "inDtlAmt", "");
            gridObj.target.setValue(idx, "inDt", "");
            gridObj.target.setValue(idx, "sInspecQty", "");    //검사수량  view
            gridObj.target.setValue(idx, "sInQty", "");		//입고수량 view   
    	}    	
    	

	}
		
	//등록시 그리드값 배열 저장
	$.gridInsertArr = function(gridObj, mode) {
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;
		var detailArr = [];    	
		var msgArr = [];    	
		var errCnt = 0;
		if( gridList.length > 0 ) {
        	var msgArr = [];			
	        $.each(gridList, function (idx, elem) {
	            var detailObj = {};	     	        	
	        	//컬럼수 루프 
	        	for(var i=0; i<gridColumns.length; i++) {
					var key = gridColumns[i].key;
					var val = elem[key];
					if( typeof(val) == "undefined") val = "";
					//console.log('key:' + key+'=-====>val:' + val);					
					//type number 시 콤마제거
					if( typeof(gridColumns[i].editor) != "undefined" && gridColumns[i].editor.type == "number" && val != "" ) {
						val = deleteCommaStr(val); 
					}	     
					//입고순번 은 select key로  ORDRG_SEQ  
					detailObj[key] = val;			            			            
	        	}
	            //필수값 체크를 여기서 한다. 입고수량, 납기요청일 - 체크된 항목만	            
	            //if( actionType == "C" && 
	            if( actionType == "C" && detailObj['userChk'] == "Y" ) {
	            	var tempMatrName = "["+ detailObj['matrNm'] +"]";
	            	//입고수량
		            if( detailObj['inQty'] ==="" || detailObj['inQty'] =="0" ) {
		            	msgArr.push((idx+1)+" 행의 "+tempMatrName+" 합격수량을 입력해 주십시오.")	;
		            }	 
	            	//불량수량 제거 
	            	/*
		            if( detailObj['badQty'] === "" ) {		            	
		            	msgArr.push((idx+1)+" 행의 불량수량을 입력해 주십시오..")	;
		            }
	            	*/
	            	//입고단가
		            if( detailObj['inPrc'] =="" || detailObj['inPrc'] =="0" ) {
		            	msgArr.push((idx+1)+"행 "+tempMatrName+" 입고단가를 입력해 주십시오.")	;
		            }	 	            	
		            //납기요청일
		            if(detailObj['dudtDeqDt'] == "" ) {
		            	msgArr.push((idx+1)+"행 "+tempMatrName+" 납기요청일을 입력해 주십시오.")	;		            	
		            }
		            //입고단가 체크 없음??
		            // if( detailObj['inDtlAmt'] =="" || detailObj['inDtlAmt'] =="0" ) {
		            // 	msgArr.push((idx+1)+" 행의 입고금액을 확인해 주십시오.")	;
		            // }
		            //입고수량
		            if( Number(detailObj['ordrgQty']) < Number(detailObj['preInQty']) + Number(detailObj['inQty']) ) {
		            	var calQty = parseFloat( Number(detailObj['ordrgQty']) - Number(detailObj['preInQty']) );
		            	msgArr.push((idx+1)+"행의 합격수량은 " + calQty + "보다 작거나 같아야 합니다.")	;
		            }		
		            //합격수량+불량수량 = 미입고  == 제거(2023.0930)
		            /*
					var sInQty = parseInt( Number(deleteCommaStr(detailObj['inQty'])) + Number(deleteCommaStr(detailObj['badQty'])) );
					if( sInQty > Number(detailObj['notInQty']) ) {
						var calQty2 = parseInt( Number(detailObj['notInQty']) - Number(detailObj['inQty']) );
		            	msgArr.push((idx+1)+" 행의 불량수량은 " + calQty2 + "보다 작거나 같아야 합니다.")	;						
					}
					*/
		            //체크된 항목만 저장		            
		            detailArr.push(detailObj);	
				} else if( actionType == "U" ) {
		            detailArr.push(detailObj);	            	
	            }
	            		
	        });			
	        //error alert 후 종료
	        if( msgArr.length > 0 ) {
	        	customAlert(msgArr.join("\r\n"));
	        	return false;
	        }
		}
		return detailArr;
	}
	
	$("#deleteDetailButton").on("click", function () {
 		var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
 		if( isNaN(selRow) ) {
 			customAlert("선택된 행이 없습니다.");
 			return;
 		} else { 			
			if(actionType == "U") { 				
 				if( selRow > -1 ) {
 					//기존값이면 D 처리 아니면 row 삭제
 					let getList = gridViewPop.target.getList()[selRow];

 					//마감일자 체크
 			    	if (!monthCloseChk(getList.inDt.replace(/\-/g, ''),"D", $('#coCd').val())) {
 			    		return false;
 			    	}
 					
 					var paramObj = {
 							"coCd" : getList.coCd
 							, "inNo" : getList.inNo
 							, "inSeq" : getList.inSeq
 							, "ordrgNo" : getList.ordrgNo
 						} 					
					if( confirm("선택행을 삭제하시겠습니까?\n\n그리드에 변경중인 내용이 초기화 됩니다.")) {
						deleteAjax("/user/sm/sm03/deleteWareHousingDetail", paramObj, null, function(data) {
							if (data.resultCode == 200) {
								customAlert(data.resultMessage);

								gridViewPop.setData(0);
								$.initViewPop();
								initSearch();
								//전체 다 지울경우 close();
								let getList = gridViewPop.target.getList();
								// console.log('---lenth 0---' + getList.length );							
								if( getList.length == 0 ) {
									//modalStack.close();
								}
							} else {
								//삭제오류 (매입확정 완료된경우 개별 삭제 불가능함)
								customAlert("매입확정 완료된 자료입니다. 삭제 불가능합니다.");
							}
						}); 						
 					}				 							 				
 				} 				
 			} 			
 		}		
	});	
	
	//전체 선택 버튼 기능
    $("#inProcessCheck").on("click", function () {
        // 첫 번째 경우: 선택된 행이 있는 경우
        let rowList = gridViewPop.target.list;
        // 두 번째 경우: 그리드가 비어 있는 경우
        if (rowList.length == 0) {
            return false;
        }

		//단가가 zero인 자료가 있는지체크하기위한 변수
		let zeroPrcRowIndex = 0;
		let zeroPrcCheck = false;
        $.each(rowList, function (idx, elem) {
			if (parseFloat(elem.notInQty) != 0 & (elem.userChk == undefined || elem.userChk == 'N')){
				elem.userChk = 'Y';
				elem.inQty = elem.notInQty;
				elem.badQty = 0;
				elem.inDt = $("#today").val();

				if (elem.inPrc == undefined || elem.inPrc == 0) {  //입고단가가 0
					//발주단가가 있으면 발주단가를 입고단가로 설정, 발주단가가 없으면 최정 거래 단가를 불러옴.
					if (parseFloat(elem.ordrgPrc) > 0) {	//발주단가가 없으면 최종 거래내역단가를 불러옴
							elem.inPrc = elem.ordrgPrc;	
					} else {
    	        		//최종단가 set
        				var paramObj = {
								"coCd" : $("#popForm #coCd").val()
								, "matrCd" : elem.matrCd
								, "pchsClntCd" : $("#popForm #pchsClntCd").val()
								, "curr" : $("#popForm #currCd").val()
								};
	    				postAjaxSync("/user/sm/sm02/selectCurrMatrUpr", paramObj, null, function(data) {   
	    						if (data.resultList == null) {
	    							elem.inPrc = 0;
	    						} else {
	    							elem.inPrc = data.resultList;	
	    						} 
	    				});  
					}
				}
				
    			var inPrc = (elem.inPrc=="" || typeof(elem.inPrc)=="undefined")? 0 : elem.inPrc;
           		if( elem.inQty != "" && elem.inQty > 0  ) {
           			elem.inDtlAmt = parseFloat( deleteCommaStr(elem.inQty) * deleteCommaStr(inPrc) );
           			elem.sInQty = parseFloat( elem.inQty );	
           			elem.sInspecQty = parseFloat( elem.inQty );	;				            		
           		} else {
           			elem.inDtlAmt = "";		            			
           		}
           		//수정된 자료 그리드자료로 Update하기
           		rowList[idx] = elem;
           		
	         	if (parseFloat(elem.inPrc) == 0 && zeroPrcCheck == false) {
	         		zeroPrcRowIndex = idx;
	         		zeroPrcCheck = true;
	           	}
			}            
        }); //$.each(rowList
        		
   		//수정된 자료 그리드자료 화면에 표시하기
        gridViewPop.target.setData(rowList);
        //단가가 0인자료가 존재하면 오류 알림
		if (zeroPrcCheck) {
			gridViewPop.target.focus(zeroPrcRowIndex);
			customAlert("단가가 없는 자료가 있습니다. 확인하세요!")
		}
    });  //$("#inProcessCheck").on("click", function ()

	// 파일첨부저장 버튼
    $("#fileUpBtn").on("click", function (e) {
		e.preventDefault();
		$(this.form).append('<input type="hidden" name="fileTrgtKey" value="'+modalStack.last().paramObj.fileTrgtKey+'">');
		fileUpload($(this.form));
	});

	param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	//---------------------------------------------------------------  
	//첨부 화일 처리 시작 
	//---------------------------------------------------------------  
	fileParam = {
			fileTrgtTyp	: $("#popForm #pgmId").val(),
			fileTrgtKey : param_fileTrgtKey
	}
			treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
	//---------------------------------------------------------------  
	//첨부 화일 처리 끝
	//---------------------------------------------------------------


});


//그리드 높이 동적 크기 조정
function gridResize(size) {
	if (size < 7) return;
    if (beforeGridSize != size) {
        var tagHeight = (size) * 27 + 123 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 450 ? 450 : tagHeight;
     
        gridViewPop.target.setHeight(tagHeight);
        beforeGridSize = size;
    }
}


function sendMailCall() {
	try {
		if (approvalConfirmCheck){
	        sendMailExec();
		}
    } catch (error) {
    } finally {
    }
  
}

	//발주명세서 출력 - report 출력
	function setReportOrderDetail(_type = "") {
		
		let selDataList = gridViewPop.target.list;
		//동일거래처인지 체크
	    let clntValue = selDataList[0].pchsClntCd;
	    for (var i = 0; i < selDataList.length; i++) {
			if (selDataList[i].pchsClntCd !== clntValue) {
				// clnt 값이 다른 경우 오류 처리
				customAlert('동일 거래처만 처리 가능합니다.');
				return false;
			}

			let notInQty = selDataList[i].notInQty;
			//매입 yn	
			if( typeof(notInQty)=="undefiend" || parseFloat(notInQty) != 0  ) {
				customAlert('매입처리가  완료되지 않았습니다.');
				return false;		
			}
	    }
	    
	    let fileName = "SM0301R02.jrf";  //여러 발주서 번호 처리 (in 처리)
	    let arg =  
			  "coCd#"		+  selDataList[0].coCd
		    + "#ordrgNo#"	+  selDataList.map(item => item.ordrgNo).join(",") 
		    + "#inNo#"	+  selDataList.map(item => item.inNo).join(",") 
	    	+ "#";    
		if (_type == '' || _type == undefined ) {
			callReport(fileName, arg, 1150, 720, '발주명세서');
		} else { //Export 작업
			ubiExportAjax(fileName, arg, function(response) {
				if (response.resultCode === 200) {
					var base64FileData = response.base64FileData;
					var fileName = response.exportFileName;
					downloadPDFFromBase64(base64FileData, fileName);
				} else {
					customAlert('PDF 내보내기 실패: ' + response.resultText);
				}

			});
		}
	}

	
function approvalConfirmCheck() {
	// //확인일자 체크
	// if (editVal.todoYn != "Y") {
	// 	customAlert("결재 승인전 발송 할 수 없습니다.");
	// 	return false;
	// }
	
	// var todoCfDtChk = gridViewPopApproval.target.list;
	// todoCfDtChk.forEach(function (item) {
	// 	if (item.gb == "결재" && item.todoCfDt !== undefined) {
	// 		customAlert(item.name + "님께서 결재 승인하지 않았습니다.");
	// 		return false;
	// 	}
	// });
	return true;
}

async function sendMailExec() {
	let selDataList = gridViewPop.target.list;
	//동일거래처인지 체크
    let clntValue = selDataList[0].pchsClntCd;
    for (var i = 0; i < selDataList.length; i++) {
		if (selDataList[i].pchsClntCd !== clntValue) {
			// clnt 값이 다른 경우 오류 처리
			customAlert('동일 거래처만 처리 가능합니다.');
			return false;
		}

		let notInQty = selDataList[i].notInQty;
		//매입 yn	
		if( typeof(notInQty)=="undefiend" || parseFloat(notInQty) != 0  ) {
			customAlert('매입처리가  완료되지 않았습니다.');
			return false;		
		}
    }
    
	//파일 첨부 여부(application.yml파일의 spring.fileAttached=YES or NO)
	//****************************************************************
	let fileAttached = false;
	let paramData = {"coCd#":$('#coCd').val()};
	postAjaxSync ("/mail/sendFilefileAttach", paramData, null, function(data) {
		fileAttached = (data.resultCode == "200") ? data.fileAttached : true;
	});
	//****************************************************************
	let fileName = "SM0301R03.jrf";
    let arg =  
		  "coCd#"		+  $('#coCd').val()
	    + "#ordrgNo#"	+  $('#ordrgNo').val() 
	    + "#inNo#"		+  $('#inNo').val() 
  		+ "#";    

	let tempUrl = "?file="+fileName;
		tempUrl += "&arg="+encodeURIComponent(arg);
		
	//****************************************************************
	// Report 출력물을 PDF 파일로 변환
	//****************************************************************	
	var attachFile="";
	if (fileAttached == "true") { //파일 첨부일 경우 PDF 변환
		let response = "";
		await ubiExportAjaxSync(fileName, arg, function(result) {
			response=result;
		});
		if (response.resultCode === 200) {
			const base64FileData = response.base64FileData;
			fileName = response.exportFileName;
			attachFile = downloadPDFFromBase64(base64FileData, fileName);
		} else {
			// console.log('PDF 내보내기 실패: ' + response.resultText);
		}
	}
	//****************************************************************	

	const orderCnt = selDataList.length;
	var ordetTxt   = selDataList[0].matrNm;

	ordetTxt = ordetTxt + ((orderCnt > 1) ? (" 외 " + (orderCnt - 1) + "건") : "");
	var tempDudtDeqDt = selDataList[0].dudtDeqDt;
    var paramObj = {
       "coCd" : $('#coCd').val(),
       "clntCd" : $('#pchsClntCd').val(),
       "clntMngNm" : "",
       "pgmId" :  "SM0301P01",
       "sendType" :  "SM0301P01",
       "sendKey" : param_fileTrgtKey,
       "tempUrl" : tempUrl,
       "mailTitle" : moment().format('YYYY-MM-DD HH:mm') + " 기준  발주번호 (" + $('#ordrgNo').val() + ")의 발주서 발송의 건",
       "mailCnts" : ordetTxt + "의 발주명세서를 첨부와 같이 보내 드리오니 업무 참고 바랍니다.\n" +
       				"        - 아 래 -\n" +
                    " 1. 발주 번호 : " + $('#ordrgNo').val() + " ( " + $('#inNo').val() + " )\n" +            
                    " 2. 발주 일자 : " + $('#ordrgDt').val() + "\n" + 
                    " 3. 납기요청일자 : " + tempDudtDeqDt + "\n" + 
                    " 3. 발주 업체 : " + $('#pchsClntNm').val() + "\n" + 
                    " 4. 발주 금액 : " + addCommaStr($('#sumInDtlAmt').val()) + "\n" + 
                    " 5. 발주 내용 : " + ordetTxt + "\n" + 
                    " 6. 발주 담당자 : " + jwt.userNm + "(" + jwt.email + ")\n" + 
                    " 내용 확인 후 처리 해 주시기 바랍니다.\n" +               
                    " 감사합니다.",                
    };
    
    //카카오 addParam
    let addParam = {
			"ordrgDt": $("#popForm #ordrgDt").val()				//발주일자				
			, "clntNm": $("#popForm #pchsClntNm").val()				//공급사명 - 구매처
			, "ordrgNo": $("#popForm #ordrgNo").val()				//발주번호
			, "inNo": $("#popForm #inNo").val()				//입고번호
			, "ordrgCoCdNm": $("#popForm #coCdNm").val()				//발주회사명
			, "ordrgMngNm": jwt.userNm				//발주담당자
			, "ordrgMngTelNo": $("#popForm #ordrgMngTelNo").val()				//발주담당자전화번호
			, "tmplatDiv": "TMPLATDIV01"							//알림톡발송템플릿 종류
    }
    Object.assign(paramObj, addParam);
   	//****************************************************************
   	// 파일 첨부 여부에 따라 출력물 첨부
   	//****************************************************************	   
	if (fileAttached == "true") { //파일 첨부 여부
		paramObj["file"]     = attachFile;
		paramObj["fileName"] = fileName;
	}
   	//****************************************************************
    
//	    modalStack.close();  //blind popup close   	
	openSecondModal("/static/html/cmn/modal/mailSend.html", 760, 850, "메일 보내기", paramObj, function() {});
}	


//카카오 발송 - 발주서
function commKaKaoSendOrder(param) {
	// console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

	//알림톡수신번호 채번
	var paramMax = { "userId" : jwt.userId
					, "tmplatDiv": param.tmplatDiv
					, "fileTrgtKey": param.fileTrgtKey 
					/* , "clntCd" : param.clntCd */ //임시 건양
					, "clntCd" : 1
					};
	var maxMessageId = null;			//message id(unique key)
	var talkMessage = null 				//발송될 내용 template
	var mobile = null					//수신인 휴대전화번호
	let talkParam = {};
	let talkBody = {};			
	let sendCnt = 0;	
	postAjaxSync("/user/bm/bm18/selectMaxMessageId", paramMax, null
				, function(data) {   
					if(data.resultList.length > 0 ) {
						if( data.resultList[0].maxMessageId != "" ) {
							maxMessageId = data.resultList[0].maxMessageId;							
							talkMessage = data.resultList[0].messageDesc;
							mobile =  data.resultList[0].mngMoblphonNo;
							param.nameTo =  data.resultList[0].mngNm; //수신인 이름
						} else {
							customAlert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
							return;
						} 

					}
	});     //user search ajax end
	if(mobile == "" || mobile == null) {
		// customAlert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
		return;
	}
	
	//message 치환
	let message = talkMessage;
	let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);	
	//loop
	$.each(splitStr, function (key, val) {		
		let compKey = val.substring(1, val.length-1);
		if( compKey != "" && compKey != "undefined" ) {
			if( typeof(param[compKey]) != "undefined" ) {
				let val2 = '#'+val;
				message = message.replaceAll(val2, param[compKey]);
			}
		}
	});

	talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
	talkParam.serverName = "gyitt2400";		
	talkParam.paymentType = "P";
	talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
	talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);	
	//talkBody.messageType = "AT";			//톡드림 포탈 템플릿 사용하지 않을 경우 사용 (AT: 알림톡, AI: 이미지 알림톡 (messageType 누락시 AT가 기본값으로 사용됨)
	//talkBody.title = "(주)건양아이티티";				//알림톡 타이틀 - 
	if (param.mailTitle.length > 50) {
		param.mailTitle = param.mailTitle.substring(0, 49); // 50자까지만 자르기
	}
	talkBody.title = param.mailTitle;					//알림톡 타이틀 -
	talkBody.message = message;				//알림톡 메시지 (1000 byte) 
	talkBody.mobile = mobile;				//휴대전화번호
	talkBody.template = "10001";			//템플릿관리화면 템플릿ID	- 발주서 V2
	let talkJson = JSON.stringify(talkBody);
	sendCnt = kakaoSendReal(talkJson, talkParam, param);
	//한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
	// talkBody.messageId = 'KAKAO'+Number(maxMessageId.substring(5, 20))+1;
	// talkBody.mobile = "01063893764"
	// talkJson = JSON.stringify(talkBody);
	//kakaoSendReal(talkJson, talkParam, param);
	
	if( sendCnt > 0 ) {
		// customAlert("알림톡 정상 발송되었습니다.");		
	}	
}

//제한일자 체크
function limit_date_chk(chkValue) {
	//debugger;
	if (limitDate != null) {
		if (limitDate > chkValue ) {
			customAlert('제한된 일자입니다. ' + limitDate + '일 이전은 데이터를 등록 및 수정할 수가 없습니다.');
			//$('#actionBtn').remove();
			$("#actionBtn").hide();
			$("#fileUpBtn").show();
		} else {
			$("#actionBtn").show();
			$("#fileUpBtn").hide();
		}
		limit_date_listchk();
	}
}

//제한일자 체크
function limit_date_listchk() {
	if (limitDate != null) {
		limit_list_yn = "N";
		var list = gridViewPop.target.list;
		//신규
		// if (actionType == "C") {
			//리스트 체크
			$.each(list,function(idx, obj) {
				//선택일 경우
				if (obj.userChk == 'Y') {
					// debugger;
					// 입고일자와 비교
					if (limitDate > obj.inDt) {
						//제한일자 위반
						limit_list_yn = "Y";
					}
				}
			});
		// }
		
		if (limit_list_yn == 'Y') {
			// customAlert('제한된 일자입니다. ' + limitDate + '일 이전은 데이터를 등록 및 수정할 수가 없습니다.');
			//$('#actionBtn').remove();
			$("#actionBtn").hide();
			$("#fileUpBtn").show();
		} else {
			$("#actionBtn").show();
			$("#fileUpBtn").hide();
		}
	}
}

</script>
