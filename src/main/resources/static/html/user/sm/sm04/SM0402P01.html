<style>
    .popup_bottom_btn {
        bottom: 30px;
    }

</style>
<div class="popup_area of_a" style=" height: 100%;">
    <div id="first-focus" class="tit_contents">
        <h4 class="tit">자재출고 등록</h4>
    </div>
    
    <form id="popForm">
    <div id="overlay2"
         style="z-index:100;display: none; position: absolute; width: 100%; height: 630px; top: 0; left: 0; background-color: rgba(0,0,0,0); pointer-events: auto;"></div>
    <div style="text-align: right;background:#e6e6e6">
        <a class="tbody_more_btn"></a>
    </div>
    <div class="toggle-div" style="padding-left: 0;">
        <div class="popup_table">
				<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
				<input type="hidden" id="userId"      name="userId">
                <input type="hidden" id="pgmId" name="pgmId" value="SM0401P01">
                <table>
                    <tr>

                        <th class="hit" >회사</th>
                        <td>
							<select id="coCd" name="coCd" data-kind="CO" required msg="회사">
							</select>
                        </td>
                        <th class="" >Sales Code</th>
                        <td>
							<div class="search_form" >
							<input type="text"  id="salesCd" name="salesCd"  data-search="salesCd" required msg="Sales Code">
	                        <a onclick="wbsSalesCodeSearch();"><i class="i_search_w" ></i></a>
							</div>
                        </td>
                        
						<th>고객사</th>
						<td>
							<input type="hidden" id="vendCd" name="vendCd" name="vendCd" >
							<input type="text" id="vendNm" name="vendNm" >			
						</td>
						<th>고객사PJT</th>
						<td>
							<input type="hidden" id="clntPjtCd" name="clntPjtCd" >
							<input type="text" id="clntPjt" name="clntPjt" > 
						</td>
						
						<!-- 빈컬럼 추가 -->
						<th></th>
                    </tr>
                    <tr>
						<th>제품 구분</th>
						<td>
							<input type="hidden" id="prdtCd" name="prdtCd">
							<input type="text" id="prdtNm" name="prdtNm">
		
						</td>					
						
						<th>아이템구분</th>
						<td>
							<input type="hidden" id="itemDiv" name="itemDiv">
							<input type="text" id="itemDivNm" name="itemDivNm">
						</td>
						<th>설비명</th>
						<td>
							<input type="text" id="eqpNm" name="eqpNm">
						</td>
						   
                    </tr>
                </table>
        </div>
    </div>
    <br>
    <div id="overlay2"
         style="z-index:100;display: none; position: absolute; width: 100%; height: 630px; top: 0; left: 0; background-color: rgba(0,0,0,0); pointer-events: auto;"></div>
    <div style="text-align: right;background:#e6e6e6">
        <a class="tbody_more_btn"></a>
    </div>
    <div class="toggle-div" style="padding-left: 0;">
        <div class="popup_table">
               <!--  <input type="hidden" id="pgmId" name="pgmId" value="CR0101M01"> -->
                <table>
                    <tr>

                        <th class="" >불출번호</th>
                        <td>
                            <input type="text" id="ioNo" name="ioNo" data-kind="ioNo" />
                        </td>
                        <th class="hit">불출일자</th>
                        <td>
	                         <input type="text" id="ioDt" name="ioDt"  class="input_calendar" autocomplete="off"  date
	                                   required msg="불출일자">
                        </td>
                        
                        <th class="hit">사급구분</th>
                        <td>
                        	<select  id="socYn" name="socYn" data-kind="YN" style="width: 100%;" required msg="사급구분">
							   <option value="">선택</option> 
							</select>
                        </td>
                        
                        
                    </tr>
                    <tr>
						<th class="hit" >출고창고</th>
						<td>
							<select  id="outWhCd" name="outWhCd" onchange="getGrid();" style="width: 100%;" required msg="출고창고" >
							   <option value="">선택</option>
							</select>
						</td>					
						
						<th class="hit" >입고 창고</th>
						<td>
							<!-- <input id="inWhCd" name="inWhCd" data-kind="inWhCd" /> -->
							<select  id="inWhCd" name="inWhCd" style="width: 100%;" required msg="입고창고">
							   <option value="">선택</option>
							</select>
						</td> 
						
						<th>비고</th>
						<td>
							<input type="text" id="ioRmk" name="ioRmk"  />
						</td> 
						   
                    </tr>
                </table>
        </div>
    </div>
     </form>
    <br>
       
    <div id="est_grid" class="contents"
         style="margin:0px; padding:0px; height: 380px; width: 100%; min-width: 200px;border-radius:0;">
        <div style="float:right" style="" class="add_btn pdl10">
            <a id="addProductButton" style="margin-top:8px">+</a>
            <a id="deleteProductButton" style="margin-top:8px;margin-right:8px;">-</a>
    	</div>                    
	    <div class="ax5_grid">
	        <ul class="ul_list type03-est">
	            <li>
	                <div>
	                    <div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"
	                         style="height: 250px; width: 100%"></div>
	                </div>
	            </li>
	
	        </ul>
	    </div>
    </div>
    <br>
    
    <!-- 공통 파일 영역 -->
	<div class="col-sm-2" style="padding-right: 5px;">
		<div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
			<h3 class="location">
				<span class="page_tit" style="text-align: left;"> 파일트리</span>
			</h3>
			
			<div id="treeview" style="height: 400px;padding: 5px">
				<div id="deptTreeOrdars"></div>
			</div>
		</div>
	</div>
	
	<div class="col-sm-10" style="padding-left: 0;">
		<div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
			<h3 class="location">
				<a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
				<span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
			</h3>
			
			<button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
			<div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
		</div>
	</div>
	
	<br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>	

    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
        <button type="button" id="actionIoBtn" authchk>등록</button>
        <button type="button" class="close_btn" onclick="  modalStack.close();">닫기</button>
		<button class="btn btn-default"  data-grid-control="column-add">열 추가</button>
    </div>

<script type="text/javascript">
	
	var actionType = null;
	var fileTrgtKey = null;
	
	var gridView3 = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber : true,
				// 체크박스
				//showRowSelector: true,
				multipleSelect: false,
				sortable: true,
				target: $('[data-ax5grid="first-grid-modal"]'),
				header: {
	              align: "center",
	              selector: false
	            },
	            body: {
					onClick: function () {
					    this.self.select(this.dindex);
                        
					},
					onDBLClick: function () {
                        this.self.select(this.dindex);
					},
					onDataChanged: function () {
						var index = this.dindex;
						var item = this.item;
						var self = this.self;	
						ckQty(item, index, self);
						
					}
			   },
	           page: {
					navigationItemCount: 9,
					height: 30,
					display: true,
					firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange: function () {
						gridView3.setData(this.page.selectPage); 
					}
	           },
	           columns: [
	        	    {key: "fileTrgtKey",      label: "첨부파일키", align: "center",   width: 80, hidden: true},
	        	    {key: "No",      label: "No.", align: "center",   width: 40,hidden: true},
	                {key: "dsgnNo", label: "도번", align: "center", width: 200,},
	                {key: "matrCd", label: "품번", align: "center", width: 110,},
	                {key: "matrClntDiv", label: "품번", align: "center", width: 110,hidden: true},
	                {key: "matrNm", label: "품명", align: "center", width: 120 },
	                {key: "matrSpec", label: "규격", align: "center", width: 110 },
	                {key: "matrMat", label: "소재", align: "center", width: 80},
	                {key: "matrMakrNm", label: "maker", align: "center", width: 80},
	                {key: "matrMno", label: "형번", align: "center", width: 80},
	                {key: "stockQty", label: "재고수량",  width: 80, align: "right"},   
	                {
	                    key: "chk", label: "ㅁ", width: 50, sortable: false, align: "center", editor: {
	                    type: "checkbox", config: {height: 17, trueValue: "Y", falseValue: "N"}
	                }},       
	                {key: "outQty", label: "출고수량", align: "right", width: 120
	                	 , 
	                	 editor: {type: "number",
	                	      disabled: function () {
	                	        return this.item.outQty == "0";
	                	      }
	                	    }
	                }
	               
	              ]
	        });
	        return this;
		
	      },
           setData: function(_pageNo) {

        	   var targetObj = this.target;
           	   var formData = new FormData();
           	   var formData = {         	    			                    
   	    		   "whCd": $('#outWhCd').val(),
                   "salesCd": $('#salesCd').val()         
       	        }
           	   
//            	   console.log("outWhCd : "+$('#outWhCd').val());
//            	   console.log("salesCd : "+$('#salesCd').val());

                postAjax("/user/sm/sm04/selectStInfo", formData, null,  function(data){
                    var list = data.stList;

					targetObj.setData({
						list : list,
						page: {
		                    totalElements: list.length
		                }
					});
	                
	                if(actionType == "U"){
	                	gridUpgrade();
	                	
	                }
					
					
                });
                
                
                
           }  
     }

	/* document.ready */
	$(document).ready(function () {
	
	    // 공통코드 selectBox set
	    setCommonSelect($(".popup_area select[data-kind]"));
		$("#popForm #userId").val(jwt.userId);
	    $("#coCd").val(jwt.coCd);
		
		authChk(); //권한체크

		getWhNm();
		getinWhNm();		
		
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		
		function setCurrentDateToDatePicker(selector) {
            var currentDate = new Date();
            var year = currentDate.getUTCFullYear();
            var month = currentDate.getUTCMonth() + 1;
            var day = currentDate.getUTCDate();

            if (month < 10) month = '0' + month;
            if (day < 10) day = '0' + day;

            var formattedDate = year + '-' + month + '-' + day;

            $(selector).datepicker('setUTCDate', new Date(formattedDate));
        }
		
	    $('.tbody_more_btn').click(function () {
	        $(this).toggleClass('on');
	        $(this).parent().next('.toggle-div').toggle();
	    }); 
	    
	    if (actionType == "C") {

			$("#socYn").val("N");
			
			$('#ioDt').datepicker({
	            format: "yyyy-mm-dd",
	            language: "ko",
	            autoclose: true
	        });

	        setCurrentDateToDatePicker('#ioDt');
			
	        $('#actionIoBtn').on("click", function () {
	            insertIo();
	        });

		} else if (actionType == "U") {
			
			//수정 모드 데이터 가져오기
			select_sm04_info();

			//타이틀명 변경
			$('.tit').text('자재불출 수정');
			//회사
			$("#coCd").prop("disabled", true);			
			//Sales Code
			$("#salesCd").prop("readonly", true);
			//고객사
			$("#vendCd").prop("readonly", true);
			$("#vendNm").prop("readonly", true);
			//고객사 PJT
			$("#clntPjtCd").prop("readonly", true);
			$("#clntPjt").prop("readonly", true);
			//제품구분
			$("#prdtCd").prop("readonly", true);
			$("#prdtNm").prop("readonly", true);
			//아이템구분
			$("#itemDiv").prop("readonly", true);
			$("#itemDivNm").prop("readonly", true);
			//설비명
			$("#eqpNm").prop("readonly", true);
			//불출번호
			$("#ioNo").prop("readonly", true);
			//불출일자
			$("#ioDt").prop("readonly", true);
			//사급구분
			$("#socYn").prop("disabled", true);
			//출고창고
			$("#outWhCd").prop("disabled", true);
			//입고창고
			$("#inWhCd").prop("disabled", true);
			//비고
			$("#ioRmk").prop("readonly", true);
			//버튼명 변경
			$('#actionBtn').text("수정");

			//버튼 클릭 시
			/* $('#actionBtn').on("click", function() {
				update_sm10();
			});
			 */
		
		}

	    
	  	//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		//debugger;
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

	});



	//체크박스 체크 시 재고수량 -> 출고수량으로 데이터 뿌리기
	function ckQty(item, index, self) {
	//debugger;
		var row = gridView3.target.getList("selected")[index];
// 		debugger;
		//체크박스 유무에 따른 행 update
		if (item.chk == "Y") {
			if(item.outQty != item.stockQty && item.outQty != "0"){
			}
			else {
				self.updateRow($.extend({}, item, 
						{
							/* showLineNumber : true, */
							dsgnNo: item.dsgnNo,
							matrCd: item.matrCd,
							matrNm: item.matrNm,
							matrSpec: item.matrSpec,
							matrMat: item.matrMat,
							matrMakrNm: item.matrMakrNm,
							matrMno: item.matrMno,
							stockQty: item.stockQty,
							chk : item.chk,
							outQty: item.stockQty
						}
					),  index);

				//self.updateColumn({key: "matrMat", label: "소재", align: "center", width: 80}, 6);
			}
	    } else if (item.chk == "N") {
	    	self.updateRow($.extend({}, item, 
					{
						dsgnNo: item.dsgnNo,
						matrCd: item.matrCd,
						matrNm: item.matrNm,
						matrSpec: item.matrSpec,
						matrMat: item.matrMat,
						matrMakrNm: item.matrMakrNm,
						matrMno: item.matrMno,
						stockQty: item.stockQty,
						chk :item.chk,
						outQty: 0
					}
			), index);

			//self.updateColumn({key: "matrMat", label: "소재", align: "center", width: 80}, 6);
	    } 
		
		var stockQty = parseInt(item.stockQty, 10);
		var outQty = parseInt(item.outQty, 10);
		
		if(stockQty < outQty ) {
			
			alert("출고수량이 재고수량 보다 많습니다.");

	    	self.updateRow($.extend({}, item, 
					{
						dsgnNo: item.dsgnNo,
						matrCd: item.matrCd,
						matrNm: item.matrNm,
						matrSpec: item.matrSpec,
						matrMat: item.matrMat,
						matrMakrNm: item.matrMakrNm,
						matrMno: item.matrMno,
						stockQty: item.stockQty,
						chk :'N',
						outQty: 0
					}
			), index); 
			
		} 
	}


	var actionType = modalStack.last().paramObj.actionType;
	
 	function getGrid() {
	
		var salescd = $('#salesCd').val();
		var outWhNm = $('#outWhNm').val();	
	
		if( outWhNm != "" &&  salescd != "" )
		{
			gridView3.initView().setData();
			
		} 
	
	
	}


	function getWhNm() {
		var paramObj = {
				"WhNm" : "INOUTDIV_O03",
				"coCd" : $("#coCd").val()
			};
		
		postAjax("/user/sm/sm04/selectWhCd", paramObj, null, function (data) {
	    	   var row = data.whList;
	    	   
				for(var i=0;  i<row.length; i++) {
				    $('#outWhCd').append($('<option>', { 
				        value: row[i].codeEtc,
				        text : row[i].codeNm 
				    }));					
				}
				
				
	        });
	}
	
	function getinWhNm() {
		var paramObj = {
				"WhNm" : "INOUTDIV_I03",
				"coCd" : $("#coCd").val()
			};
		
		postAjax("/user/sm/sm04/selectWhCd", paramObj, null, function (data) {
	    	   var row = data.whList;
	    	   
				for(var i=0;  i<row.length; i++) {
				    $('#inWhCd').append($('<option>', { 
				        value: row[i].codeEtc,
				        text : row[i].codeNm 
				    }));					
				}
				
	        });
	}
	
	
	
	//그리드에 뿌리는 데이터
	function select_sm04_info() {
		
		var formData = {
			"fileTrgtKey" : fileTrgtKey
		}

		postAjax("/user/sm/sm04/select_sm04_info", formData, null, function(data) {
			
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);					
				}
			});
			
// 			console.log("ioNo : "+$('#ioNo').val());
// 			console.log("SalesCd : "+$('#salesCd').val());

			
			 gridView3.initView().setData();

		});
		

	}
	
	function gridUpgrade() {
		
		var item = gridView3.target.getList();

// 		debugger;
		gridView3.target.removeColumn(11);
		gridView3.target.removeColumn(10);
		gridView3.target.addColumn({key: "creatId", label: "생성자", align: "center", width: 80});
		gridView3.target.addColumn({key: "creatDttm", label: "생성일시", align: "center", width: 80});
		gridView3.target.addColumn({key: "udtId", label: "변경자", align: "center", width: 80});
		gridView3.target.addColumn({key: "udtDttm", label: "변경일시", align: "center", width: 80});
		

	  /*  for(var i=0; i<item.length; i++)
		{ 		    			
   			gridView3.target.addRow($.extend({}, item[i], i));
		}   */
		

	}
	
	
	
	// 기본정보 & 불출정보 INSERT
	function insertIo() {
		
		var outWhCd = $('#outWhCd').val();
		var inWhCd = $('#inWhCd').val();
		
        var formData = makeFormData(); //SM0401M01
		
		if(outWhCd == inWhCd) {
	        alert("출고창고와 입고 창고를 다르게 입력하세요.");
	        return;
		}
		
         if(inputValidation($('.popup_area [required]'))) {
        	 filePostAjax("/user/sm/sm04/insert_sm04", formData, function(data) {	
     			if (data.resultCode == 200) {
     				StockInfoInsert();
     				//gridView.setData(0);
     				//modalStack.close();				
     				}
     			});
         }
       	 
    }
	
	function makeFormData() {
		
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		
        var formData = new FormData($("#popForm")[0]);
        
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("pgmId", $("#pgmId").val());
		formData.append("ioDiv", "INOUTDIV_O03");
		formData.append("clntCd", $('#vendCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용 
		
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------
		
		return formData;
        
	}
	
	// 출고창고 재고정보 INSERT
	function StockInfoInsert() {
		
        var formDataInfo = makeInfoFormData();
		
	}
	
	function makeInfoFormData() {
		
		var formDataInfo = new FormData();
		var row = gridView3.target.getList();
		
//    	    console.log("ioNo : " + $("#ioNo").val()); 
//    	    console.log("salesCd : " + $("#salesCd").val()); 

	    var a = 0;
	    
		for(var i=0; i<row.length; i++) {
// 	    	console.log("i+1 : " + (i+1)); 
			 if(row[i].chk == "Y" ) {
			 //formDataInfo.append("list["+i+"]", gridView3.target.getList()[i] );	
			 //console.log("list["+i+"]", gridView3.target.getList()[i]);
					
			 var cnt = ++a;
				 
// 			 console.log(i+" 번 삭제 시작 ");
			 formDataInfo.delete('coCd');
			 formDataInfo.delete('ioNo');
			 formDataInfo.delete('dsgnNo');
			 formDataInfo.delete('matrCd');
			 formDataInfo.delete('ioQty');
			 formDataInfo.delete("ioSeq");
			 formDataInfo.delete('salesCd');
			 formDataInfo.delete('userId');
			 formDataInfo.delete('pgmId'); 
			
//    	    	 console.log("i+1 : " + (i+1)); 
			 formDataInfo.append("coCd", row[i].coCd);
			 formDataInfo.append("ioNo", $("#ioNo").val());
			 formDataInfo.append("dsgnNo", row[i].dsgnNo);
			 formDataInfo.append("matrCd", row[i].matrCd);
			 formDataInfo.append("ioQty", row[i].outQty);
			 formDataInfo.append("ioSeq", cnt);
			 formDataInfo.append("salesCd", $("#salesCd").val());
			 formDataInfo.append("userId", jwt.userId);
			 formDataInfo.append("pgmId", $("#pgmId").val());
			
			 var entries = formDataInfo.entries();
			
			 //formData  값 확인
// 	 	     console.log(i+" 번 조회 시작"); 
	         for (const pair of entries) {
// 	       	     console.log("Key : " + pair[0]+ " value : " + pair[1]); 
	       	 }
			
	         filePostAjax("/user/sm/sm04/insert_sm04_Info", formDataInfo, function(data) {	
				//alert(data.resultMessage);
//        			debugger;
				if (data.resultCode == 200) {
					if(i == row.length) {
						gridView.setData(0);
						modalStack.close();	
						return alert(data.resultMessage);
					}
				} else { 
					alert("등록에 실패하였습니다."); 
				}
			});
		} 
	 };  
	}
	
	
	
	
	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
	function wbsSalesCodeSearch() {
	    var paramObj = {
	       "coCd" : $('#coCd_S').val(),
	       "salesCd": $('#salesCd').val()
	    };
	    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
	        var row = grid.target.getList("selected")[0];
            $('#salesCd').val(row.salesCd);
            $('#clntPjt').val(row.clntPjt);
            $('#clntPjtCd').val(row.clntPjtCd);
            $('#eqpNm').val(row.eqNm);
            $('#vendCd').val(row.ordrsClntCd);
            $('#vendNm').val(row.ordrsClntNm);
            $('#eqpNm').val(row.clntPjt);
            $('#prdtCd').val(row.prdtCd);
			$('#prdtNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
            
            getGrid();
	    });
	}
	


</script>
</html>
