<style>
	.readonly-checkbox {
	    pointer-events: none;
	}
    .checkbox-container input[type="checkbox"] {
        vertical-align: text-top;
        margin-left: 20px;/* 선택 박스와 텍스트 사이의 간격 조정 */
    }
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">구매비용 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="SM1001P01">
		<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
		<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->		
 		<table>

        <colgroup>
          <col width="10%">
          <col width="23%">
          <col width="10%">
          <col width="23%">
          <col width="10%">
          <col width="24%">
<!--           <col width="11%"> -->
<!--           <col width="14%"> -->
        </colgroup>

        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
				</select>
			</td>
			<th>수주번호</th>
			<td>
				<div class="search_form" >
					<input type="text"  id="ordrsNo" name="ordrsNo" data-search="ordrsNo" readonly="readonly">
					<a onclick="popOpendOrdrsSearch($('#ordrsNo').val(), $('#coCd').val());"><i class="i_search_w" ></i></a>
				</div>
			</td>
			<th>수주번호-회사</th>
			<td>
				<input type="text"  id="ordrsCoCdNm" name="ordrsCoCdNm" readonly="readonly">
				<input type="hidden"  id="ordrsCoCd" name="ordrsCoCd"  data-search="ordrsCoCd"  readonly="readonly">
			</td>
<!-- 			<th class="hit">SalesCode</th> -->
<!-- 			<td> -->
<!-- 				<div class="search_form"> -->
<!-- 				    <input type="text" id="salesCd" name="salesCd" required onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''"> -->
<!-- 				   	<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a> -->
<!-- 			    </div> -->
<!-- 			</td> -->
        </tr>
        <tr>
			<th>고객사PJT</th>
			<td><input type="hidden" id="clntPjtCd" name="clntPjtCd" msg="고객사PJT">
				<input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT" class="form-control"> 
			</td>
			<th>고객사</th>
			<td><input type="hidden" id="vendCd" name="vendCd" msg="고객사">
				<input type="text" id="vendNm" name="vendNm" msg="고객사" class="form-control">
			</td>
			<th>계약명</th>
			<td>
				<input type="text" id="ctrtNm" name="ctrtNm" msg="고객사PJT" class="form-control"> 
			</td>
<!-- 			<th>제품구분</th> -->
<!-- 			<td> -->
<!-- 				<input type="hidden" id="prdtCd" name="prdtCd"> -->
<!-- 				<input type="text" id="prdtNm" name="prdtNm" class="form-control"> -->

<!-- 			</td> -->
        </tr>

<!--         <tr> -->
<!-- 			<th>설비명</th> -->
<!-- 			<td> -->
<!-- 				<input type="text" id="eqpNm" name="eqpNm" class="form-control"> -->
<!-- 			</td> -->
<!-- 			<th>아이템구분</th> -->
<!-- 			<td> -->
<!-- 				<input type="hidden" id="itemDiv" name="itemDiv"> -->
<!-- 				<input type="text" id="itemDivNm" name="itemDivNm" class="form-control"> -->
<!-- 			</td> -->
<!-- 			<td colspan=2> -->
<!-- 			</td> -->
<!--         </tr> -->

        <tr>
        	<th colspan=4 style="height: 50px">비용정보</th>
        	<th>외주계약번호</th>
        	<td>
        		<input type="text" id="ctrtNo" name="ctrtNo" class="form-control">
        	</td>
        </tr>

        <tr>
			<th class="hit">처리일자</th>
			<td>
				<input id="costDt" name="costDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date onchange="monthCloseChk(this.value);">
			</td>
			<th>발주 요청번호</th>
			<td>
				<div class="search_form">
					<input type="text" id="reqNo" name="reqNo" onkeyup="event.keyCode == 8 ? reqNo.value = '' : event.keyCode == 13 ? openPurchaseSearch() : ''" readonly msg="발주 요청번호"> 
					<a id="reqNoBtn" onclick="openPurchaseSearch();"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th>비용번호</th>
			<td>
				<input type="text"  id="costNo" name="costNo" class="form-control" msg="비용번호">
			</td>
        </tr>

        <tr>
			<th class="hit">거래처</th>
			<td>
				<input type="hidden" id="pchsClntCd" name="pchsClntCd"required msg="거래처">
				<div class="search_form">
					<input type="text" id="pchsClntNm" name="pchsClntNm"  onkeyup="event.keyCode == 8 ? pchsClntCd.value = '' : event.keyCode == 13 ? clntSearch() : ''" required msg="거래처">
						<a onclick="clntSearch();"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th>지급조건</th>
			<td>
	            <select id="pchsPmntMtdCd" name="pchsPmntMtdCd" class="form-control" data-kind="PMNTMTD" msg="지급조건">
	            </select>
			</td>
			<th>매입확정번호</th>
			<td>
				<input type="text"  id="pchsNo" name="pchsNo"  msg="매입확정번호" class="form-control" readonly>
			</td>
        </tr>

        <tr>
			<th class="hit">비용구분</th>
			<td>
	            <select id="pchsCostDiv10" name="pchsCostDiv10" class="form-control" data-kind="PCHSCOSTDIV10" required msg="비용구분" onchange="pchsCostDiv10Change(this.value);">
<!-- 	            	<option value="">선택</option> -->
	            </select>
			</td>
			<th>지급방법</th>
			<td>
<!-- 	            <select id="pchsClmnDivCd" name="pchsClmnDivCd" class="form-control"  data-kind="CLMNDIV"  required msg="지급방법"> -->
	            <select id="pchsClmnDivCd" name="pchsClmnDivCd" class="form-control" msg="지급방법">
<!-- 	            	<option value="">선택</option> -->
	            	<option value="CLMNDIV04" data-rprc="MON" data-etc="1" data-desc="수금조건" data-dz-code="undefined">익월</option>
	            </select>
			</td>
			<th class="hit">지급일자</th>
			<td>
	            <select id="pchsClmnDay" name="pchsClmnDay" class="form-control" required msg="지급일자">
	            	<option value="10">10일 결제</option>
	            	<option value="25" selected>25일 결제</option>
	            </select>
			</td>
        </tr>

        <tr>
			<th class="hit">비용상세구분</th>
			<td>
				<select id="pchsCostDiv20" name="pchsCostDiv20" class="form-control" data-kind="PCHSCOSTDIV20" required msg="비용상세구분">
<!-- 					<option value="">선택</option> -->
				</select>
			</td>
			<th  class="hit">청구/영수구분</th>
			<td>
				<select id="payDiv" name="payDiv" class="form-control" data-kind="PAYDIV" required msg="청구/영수구분">
<!-- 					<option value="">선택</option> -->
				</select>
			</td>
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" class="form-control" required msg="통화단위">
<!-- 					<option value="">선택</option> -->
				</select>
			</td>
        </tr>
        <tr>
			<th  class="hit">금액</th>
			<td>
				<input type="text" id="costAmt" name="costAmt" class="form-control" comma required msg="금액" onkeyup="chechChange(this);" >
			</td>
			<th>영수일자</th>
			<td>
				<input id="payDivDt" name="payDivDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" date msg="지급일자">
			</td>
			<th class="hit">환율</th>
			<td>
				<input type="text" id="exrate" name="exrate" class="form-control" comma required msg="환율" onkeyup="chechChange(this);" >
			</td>
<!-- 			<th class="hit">품번</th> -->
<!-- 			<td> -->
<!-- 				<div class="search_form"> -->
<!-- 	            	<input type="text" id="matrCd" name="matrCd" class="form-control" required msg="품번"> -->
<!-- 					<a onclick="openMatListSearch('P');"><i class="i_search_w"></i></a> -->
<!-- 				</div> -->
<!-- 			</td> -->
<!-- 			<th>품명</th> -->
<!-- 			<td> -->
<!-- 				<input type="text" id="matrNm" name="matrNm" class="form-control" msg="품명"> -->
<!-- 			</td> -->
<!-- 			<td colspan=2> -->
			</td>
        </tr>
        <tr class="turnKeyItemDiv" style="display: none;">
			<th>외주품목</th>
			<td colspan = 3>
			<div class="checkbox-container" style="text-align: left;" readonly>
				<input type="checkbox" id="CTRITEM01" name="ctrtItem" value="CTRITEM01" class="readonly-checkbox" data-label="설계"> 설계 
				<input type="checkbox" id="CTRITEM02" name="ctrtItem" value="CTRITEM02" class="readonly-checkbox" data-label="제작"> 제작
				<input type="checkbox" id="CTRITEM03" name="ctrtItem" value="CTRITEM03" class="readonly-checkbox" data-label="공사건"> 공사건
				<input type="checkbox" id="CTRITEM04" name="ctrtItem" value="CTRITEM04" class="readonly-checkbox" data-label="슈퍼바이저"> 슈퍼바이저
				<input type="checkbox" id="CTRITEM05" name="ctrtItem" value="CTRITEM05" class="readonly-checkbox" data-label="A/S"> A/S
				<input type="checkbox" id="CTRITEM06" name="ctrtItem" value="CTRITEM06" class="readonly-checkbox" data-label="단품티칭"> 단품티칭
				<input type="checkbox" id="CTRITEM07" name="ctrtItem" value="CTRITEM07" class="readonly-checkbox" data-label="외주용역"> 외주용역
				<input type="checkbox" id="CTRITEM99" name="ctrtItem" value="CTRITEM99" class="readonly-checkbox" data-label="기타"> 기타
			</div>
			</td>
			<th>외주계약명</th>
			<td><input type="text" id="ctrtCtrtNm" name="ctrtCtrtNm"  readonly></td>
        </tr>
        <tr class="turnKeyItemDiv" style="display: none;">
        	<th>외주내용</th>
			<td colspan="5">
				<textarea id="ctrtCtrtRmk" name="ctrtCtrtRmk"  msg="외주내용" style="height: 50px;" readonly></textarea>
			</td>	
        </tr>
        <tr>
        	<th>비고</th>
			<td colspan="5">
				<textarea class="form-control" id="costRmk" name="costRmk"  msg="비고" style="height: 60px;" maxlength="500"></textarea>
			</td>			
        </tr>
      </table>
      <div id="turnKeyGrid" class="ax5_grid" data-ax5grid="turnKey-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
    </form>
	</div>

	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" id="mailSendBtn" onclick="sendMailCall();" authChk><i class="fas fa-envelope"></i> 기타발주서메일</a></button>
	</div>

<script type="text/javascript">

	var turnKeyGridView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                target: $('[data-ax5grid="turnKey-grid"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    onDataChanged: function () {
        				var row = this.dindex;
        				var col = this.colIndex;
                    	if (this.key == 'ordrsAmt'){
                    		if (gPasIntChk(this.value) != 0) {
	                    		turnKeyGridView.target.list[this.dindex].chkSaveCd = 'Y';
	                    		if (gPasIntChk(this.item.ordrsQty) == 0) {
	                    			turnKeyGridView.target.list[this.dindex].ordrsQty = this.item.salesOrdrsQty == 0 ? 1 : this.item.salesOrdrsQty;
	                    		}
	                    	} else {
	                    		turnKeyGridView.target.list[this.dindex].chkSaveCd = 'N';
	                			turnKeyGridView.target.list[this.dindex].ordrsQty = '';
	        				}

                    		let totalChkAmt = 0;
                    		let turnKeyList = turnKeyGridView.target.getList();
                    		if (turnKeyList.length > 0 ) {
                    			$.each(turnKeyList, function (idx, elem) {
                    				totalChkAmt += gPasIntChk(elem.ordrsAmt);
                    	        });
                    		}

                    		$('#costAmt').val(addCommaStr(totalChkAmt));
                    		
							turnKeyGridView.target.repaint()
                    	}
                		
                    },
                },
                page: {
                    navigationItemCount: 9,
                    height: 30,
                    display: true,
                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange: function () {
                        turnKeyGridView.setData(this.page.selectPage);
                    }
                },
				columns : [
					{key : "coCd", 			  label : "회사",          hidden : true},
					{key : "coCdNm", 		  label : "회사명",        align : "center", 	width : 80, hidden : true},
					{key : "ordrsNo", 		  label : "수주번호",      align : "center", 	width : 60, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "ordrsSeq", 		  label : "순번",   		align : "center", 	width : 40, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "salesCd", 		  label : "Sales Code",   align : "left", 	width : 150, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }}, 
					{key : "salesOrdrsQty",   label : "주문대수",   	align : "center",	width : 60, formatter: "money", styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }}, 
					{key : "eqpNm", 		  label : "설비명",        align : "left", 	width : "*", styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "chkSaveCd" ,	  label : "턴키여부",		align: "center",	width: 60, formatter: function () { return this.value =="Y" ? "대상":""; }},
					{key : "ordrsQty" ,	  	  label : "외주대수",		align: "center",	width: 60, editor: {type: "number"}, formatter: "money", styleClass: function () { return "grid-font-red"; }},
					{key : "ordrsAmt" ,	  	  label : "외주금액",		align: "right",		width: 100, editor: {type: "number"}, formatter: "money", styleClass: function () { return "grid-font-red"; }},
					{key : "ordrsRmk" ,	  	  label : "비고",			align: "left",		width: 150, editor: {type: "text"}, styleClass: function () { return "grid-font-red"; }},
					{key : "ordrsDtlDiv20",   label : "신작구분",      hidden : true},
					{key : "ordrsDtlDiv20Nm", label : "신작구분",      align : "center", width : 60, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "ordrsClntCd", 	  label : "고객사",        hidden : true},
					{key : "ordrsClntNm", 	  label : "고객사명",      align : "left", width : 150, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "clntPjt", 		  label : "고객사 PJT",    align : "center", width : 100, hidden : true},
					{key : "clntPjtNm", 	  label : "프로젝트",    	align : "center", width : 80, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
// 					{key : "prdtCd", 		  label : "제품구분",      hidden : true},
// 					{key : "prdtCdNm", 		  label : "제품",        align : "left", width : 180, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "itemDiv", 		  label : "아이템구분",    align : "center", width: 100, hidden : true},
					{key : "itemDivNm", 	  label : "아이템",    align : "left", width: 120, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
					{key : "orgnSalesCd", 	  label : "원 Sales Code", align : "left", width : 140, styleClass: function () { return (gPasIntChk(this.item.ordrsAmt) != 0)?"grid-no-msg-font-blue-bold":""; }},
				],
        	    footSum: [
        	        [
        	            {label: "외주합계", align: "center", colspan: 6},
        	            {key: "ordrsQty", 	collector: "sum", formatter: "money", align: "center"},
        	            {key: "ordrsAmt", 	collector: "sum", formatter: "money", align: "right"},
        	        ]
        	    ],
            });
            return this;
        },
		setData : function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {};
			paramObj.pageNo = _pageNo + 1;
			paramObj.recordCnt = 999999;

			paramObj.coCd = $("#ordrsCoCd").val();		
			paramObj.ordrsNo = $("#ordrsNo").val();
			paramObj.costNo = $("#costNo").val();
			
			if(_pageNo !== 999) {
				var searchValue = paramObj.searchValue;
				var searchType  = paramObj.searchType;
				postAjaxSync("/user/sm/sm10/selectTurnKeySalesCodeList", paramObj, null, function(data) {
					try {
						var list = data.result;
						$.each(list, function (idx, elem) {
							list[idx].__selected__ = elem.chkSaveCd=="Y" ? true : false;	//저장된 salesCd 이면 선택되게 변경 처리함
						});
						targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							}
						});
						localgridResize(list.length+1); //그리드 높이 조정
					} catch {
						alert("오류 발생!! 전산실 연락 바랍니다", error.message);
						return null; // 오류 발생 시 null 반환
					} finally {
						// console.log("함수 실행 완료.");
					}
				});
			}
		}
    };

	var actionType = null;
	var fileTrgtKey = null;

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(jwt.userId);
		
		//처리일자//
		$('#costDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());

		//지급일자//
		$('#payDivDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
		
		$('#payDiv').change(function () {
        	if ($("#payDiv").val() == "PAYDIV01") {
        		$('#payDivDt').show();
        		$('#payDivDt').parent('td').prev('th').addClass('hit');
        		$('#payDivDt').attr('required', 'true');
        	} else {
        		$('#payDivDt').val("");
        		$('#payDivDt').hide();
        		$('#payDivDt').parent('td').prev('th').removeClass('hit');
        		$('#payDivDt').removeAttr('required', 'true');
        	}

		})
	        
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		exrateCal(); //최초 로딩시 환율 적용
	    $("#vendNm").prop("readonly", true);
	    $("#clntPjt").prop("readonly", true);
	    $("#ctrtNm").prop("readonly", true);
	    $("#prdtNm").prop("readonly", true);
	    $("#itemDivNm").prop("readonly", true);
	    $("#eqpNm").prop("readonly", true);
	    $("#matrNm").prop("readonly", true);
		
	    $("#costNo").prop("readonly", true);
	    $('#currCd').on('change', exrateCal);
	    turnKeyGridView.initView();
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			//참조키값이 있으면 자료를 불러옴.
			let refFileTrgtKey = modalStack.last().paramObj.refFileTrgtKey;
			if (refFileTrgtKey){
				selectPchsCostInfo(refFileTrgtKey);
			}
			
			//지급구분 초기화 설정 --> 청구이면 날자는 공백으로 처리
			$('#payDivDt').val('');
			$('#payDivDt').hide();
			$('#payDiv').val('PAYDIV02');
			
			$('#actionBtn').on("click", function() {
				insertPchsCost();
			});

		} else if (actionType == "U") {
			$('.tit').text('구매비용 수정')
			
			selectPchsCostInfo(fileTrgtKey);
			
			turnKeyGridView.setData(0);
			
			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updatePchsCost();
			});
		} else if (actionType == "T") {
			$('.tit').text('구매비용 확인')
			
			selectPchsCostInfo(fileTrgtKey);
			
			turnKeyGridView.setData(0);
			
			$('#actionBtn').text("확인");
			$('#actionBtn').on("click", function() {
				modalStack.close();
			});
		}
		

		$('#pchsCostDiv10').on("change", function() {
			if ($('#pchsCostDiv10').val() == 'PCHSCOSTDIV1030' && $('#ctrtNo').val() == '' ) {
				alert("턴키는 외주관리에 등록바랍니다.\n (외주제작설비 발주관리대장에 출력 제외됨)\n해당 턴키건은 이력 관리용으로 대금지급내역에 표시되지 않습니다.");
			}
		});
		
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		authChk();						// 권한체크

	});

	//통화단위 변경
	function exrateCal() {
		var currCd = $('#currCd').val();
		var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
		$('#exrate').val(exrateVal ? exrateVal : '');

	}		
	
	function selectPchsCostInfo(_fileTrgtKey) {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : _fileTrgtKey,				//_fileTrgtKey 또는 COST로 시작하는 비용번호 사용가능함.
		}
		postAjax("/user/sm/sm10/selectPchsCostInfo", formData, null, function(data) {
			if (actionType == "C") {
				data.result.fileTrgtKey = 0;
				data.result.costAmt = 0;
				data.result.pchsAmt = 0;
				data.result.pchsVat = 0;
				
				delete data.result.costNo;
				delete data.result.costDt;
				delete data.result.ordrsNo;
				delete data.result.reqNo;
				delete data.result.pchsNo;
				delete data.result.ctrtNm;
				delete data.result.ordrsCoCdNm;
				delete data.result.clntNm;
				delete data.result.clntPjt;
				delete data.result.clntPjtCd;
				delete data.result.clntPjtNm;
				delete data.result.billYn;
				delete data.result.itemDiv;
				delete data.result.itemDivNm;
				delete data.result.ordrsClntCd;
				delete data.result.ordrsCoCd;
				delete data.result.ordrsCoCdNm;
				delete data.result.vendCd;
				delete data.result.vendNm;
				delete data.result.pchsAmt;
				delete data.result.pchsVat;
				delete data.result.prdtCd;
				delete data.result.prdtNm;
				delete data.result.eqpNm;
				delete data.result.salesCd;
				delete data.result.creatId;
				delete data.result.creatNm;
				delete data.result.creatPgm;
				delete data.result.creatDttm;
				delete data.result.udtId;
				delete data.result.udtNm;
				delete data.result.udtPgm;
				delete data.result.udtDttm;
				delete data.result.confYm;
				
				delete data.result.ctrtNo;
				delete data.result.ctrtCtrtNm;
				delete data.result.ctrtItems;
				delete data.result.ctrtCtrtRmk;
				delete data.result.costRmk;

			}
			    	
				$.each(data.result, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				//지급일자가 없는 경우  undefined으로 clear 되지 않음.
				if (data.result.payDivDt == undefined) $('#payDivDt').val('');
	        	if (data.result.payDiv == "PAYDIV01") {	//영수
	        		$('#payDivDt').show();
	        		$('#payDivDt').parent('td').prev('th').addClass('hit');
	        		$('#payDivDt').attr('required', 'true');
	        	} else {	//청구
	        		$('#payDivDt').val("");
	        		$('#payDivDt').hide();
	        		$('#payDivDt').parent('td').prev('th').removeClass('hit');
	        		$('#payDivDt').removeAttr('required', 'true');
	        	}

			    if (data.result.ctrtNo) $('.turnKeyItemDiv').show(); //외주폼목 보이기
// 				$('#CTRITEM03, #CTRITEM05').prop('checked', true);
				if (data && data.result && data.result.ctrtItems !== undefined) {
					let tempItem = data.result.ctrtItems.split(',').map(function(item) {
					    return item.trim();	//앞뒤공백 제거하기 위함
					});
			        for (var i = 0; i < tempItem.length; i++) {
			        	 $('#'+tempItem[i]).prop("checked", true);
			        }
				}
				//턴키인가
				pchsCostDiv10Change();
				//마감체크
				monthCloseChk($('#costDt').val());
				
				//매입확정이면 수정 불가하게 수정
				if (data.result.confYm == "Y") {
					$('#actionBtn').hide();
				} else {
					$('#actionBtn').show();
				}
				//ctrtNo  --> 외주관리에서 넘어온 자료인경우 수정안됨
				if (data.result.ctrtNo != undefined && data.result.ctrtNo != "") {
					//턴키에서 자동생성자료인경우 수정 불가영역 설정함.
// 					$('#popForm input, #popForm textarea, #popForm select').prop('disabled', true);
					$('#popForm input, #popForm textarea, #popForm select').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
					$('#actionBtn').hide();
				}
				
				//계산서 발행완료일경우
// 				if (data.result.BILL_YN == "Y") {
// 					//계산서 발행 완료에 대한 기능
// 				}
		});
	}



	 // 등록
	function insertPchsCost() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성

			if(formData){
				filePostAjax("/user/sm/sm10/insertPchsCost", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							modalStack.last().callback();
							modalStack.close();									// 모달을 닫음
						}
					});
			}
		}
	}

	// 수정
	function updatePchsCost() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성

			if(formData){
	      		filePostAjax("/user/sm/sm10/updatePchsCost", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							modalStack.last().callback('1');
							modalStack.close();
						}
					});
			}
		}
	}

	//----------------------------------------------//
	
	function makeFormData() {

		//마감일자 체크
		if (!monthCloseChk($('#costDt').val(),"", $('#coCd').val())) {
			return false;
		}
		
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		//턴키면 턴키 등록용 그리드
		let firstSalesCd = "";//대표 Sales Code 저장용
		let totalChkAmt = 0;
		let ctrtOrdrsQty = 0;
// 		if($("#pchsCostDiv10").val() == "PCHSCOSTDIV1030"){
			let turnKeyList = turnKeyGridView.target.getList();

			if (turnKeyList.length > 0 ) {
				$.each(turnKeyList, function (idx, elem) {
					// 턴키여부 대상만 저장
					if (elem.chkSaveCd == 'Y' || gPasIntChk(elem.ordrsAmt) != 0) {
						turnKeyList[idx].chkSaveCd = 'Y';
						if (firstSalesCd == '') firstSalesCd = elem.salesCd; //SalesCd는 상세내역에 있음. 대표 세일즈코드 (선택된것중에 첫번째)
						totalChkAmt += gPasIntChk(elem.ordrsAmt);
						ctrtOrdrsQty += gPasIntChk(elem.ordrsQty);
					} else {
						turnKeyList[idx].chkSaveCd = 'N';
					}
		        });
				formData.append("detailArr", JSON.stringify(turnKeyList));
			}
// 		}

		//외주관리에서 넘어온 자료가 아니면 (외주관리에서 자동생성된 자료는 번호가 있음 CTRTxxxxxx)
		if ($('#pchsCostDiv10').val() == 'PCHSCOSTDIV1030' || $('#pchsCostDiv10').val() == 'PCHSCOSTDIV1040') {
			if (totalChkAmt == 0) {	
		        alert('턴키와 일반용역비는 아래 설비별 외주금액 필수 입력입니다.확인 바랍니다.');
				return false;
			}
			if (totalChkAmt != gPasIntChk($('#costAmt').val())) {	
		        alert('턴키와 일반용역비는 아래 설비별 외주금액과 구매금액은 동일해야 합니다. 확인 바랍니다.');
				return false;
			}
		}
		if ($('#ordrsNo').val() != "" ) {
			if (totalChkAmt == 0) {	
		        alert('수주번호 선택시에는 대상설비별 해당금액을 입력하여야 합니다.');
				return false;
			}
		}
			
		formData.append("salesCd", firstSalesCd);	//SalesCd는 상세내역에 있음. 대표 세일즈코드 (선택된것중에 첫번째)
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#vendCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	
    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd').val(),
           "salesCd": $('#salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/SalesCodeTreeSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $('#salesCd').val(row.salesCd);
            $('#clntPjtCd').val(row.clntPjt);
            $('#clntPjt').val(row.clntPjtNm);
            $('#eqpNm').val(row.eqNm);
            $('#vendCd').val(row.ordrsClntCd);
            $('#vendNm').val(row.ordrsClntNm);
            $('#eqpNm').val(row.eqpNm);
            $('#prdtCd').val(row.prdtCd);
			$('#prdtNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
        });
    }
    		
	
	//  업체명 검색 //
	function clntSearch() {
		var paramObj = {
				"searchValue" :  $("#pchsClntNm").val()
				, "clntDivCd" : ""		/*거래처 검색 기본값 고객사로 세팅 */
				, "pchsClntCd" : "CLNTDIV12"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
		}	
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", paramObj, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
					$('#pchsPmntMtdCd').val(row.pchsPmntMtdCd);
					$('#pchsClmnDivCd').val(row.pchsClmnDivCd);
					$('#pchsClmnDay').val(row.pchsClmnDay);
				});
	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"userNm": $('#mngNm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	
	// 자재 품번 팝업 호출하는 함수
    function openMatListSearch(openType) {
          //debugger;
          var paramObj = {
      			"searchValue" : $("#matrNm").val()
          }
          openSecondModal("/static/html/cmn/modal/matListSearch.html", 600, 420, "자재 품번 검색", paramObj, function(grid) {
                        var row = grid.target.getList("selected")[0];
                        if (openType == "P") {
							$('#matrCd').val(row.matrCd);		// 	품번 값 가져오기
							$('#matrNm').val(row.matrNm);	//	품번 값 가져오기
                        } 
                 });
    }
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}
	
	//수주번호 검색
    function popOpendOrdrsSearch(inputValue, coCd) {
        var paramObj = {
            "searchValue" : inputValue,
            "coCd" : coCd
        };
    	
        openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];

            $('#ordrsCoCd').val(row.coCd);
            $('#ordrsCoCdNm').val(row.coNm);
            $('#ordrsNo').val(row.ordrsNo);
            $('#vendCd').val(row.ordrsClntCd);
            $('#vendNm').val(row.clntNm);
            $('#clntPjtCd').val(row.clntPjt);
            $('#clntPjt').val(row.clntPjtNm);
            $('#ctrtNm').val(row.ctrtNm);
            
            var value = $("#pchsCostDiv10").val();
    		//턴키면 턴키 등록용 그리드--> 모든 비용에는 선택 가능하게 수정
//     		if(value == "PCHSCOSTDIV1030"){
    			$("#turnKeyGrid").show();
    			turnKeyGridView.setData(0);
//     		}else{
//     			//아니면 숨김
//     			$("#turnKeyGrid").hide();
//     		}
        });
    }
	
	//요인별요청번호 검색
	function openPurchaseSearch() {
		let searchCheckVal = $("#reqNo").val()
		let searchNameVal = (searchCheckVal == undefined || searchCheckVal == '') ? "T.SALES_CD" : "T.REQ_NO" ;
		var paramObj = {
				"coCd" : $("#coCd").val(),
				"searchValue" : searchCheckVal,
				"searchName" : searchNameVal,
		}		
	
		paramObj.orderFlag = "Y";
		openSecondModal("/static/html/cmn/modal/purchaseSearch.html", 1200, 680, "요인별요청번호 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$("#ordrsCoCd").val(row.coCd);
			$("#ordrsCoCdNm").val(row.coCdNm);
			$("#clntPjtCd").val(row.clntPjtCd);
			$("#clntPjt").val(row.clntPjt);
			$("#eqpNm").val(row.eqpNm);
			$("#ctrtNm").val(row.ctrtNm);
// 			$("#prdtNm").val(row.prdtNm);
// 			$("#prdtCd").val(row.prdtCd);
			$("#reqNo").val(row.reqNo);
			$("#vendCd").val(row.clntCd);
			$("#vendNm").val(row.clntNm);
			$("#ordrsNo").val(row.ordrsNo);

			$("#salesCd").val(row.salesCd);
			$("#turnKeyGrid").show();
			turnKeyGridView.setData(0);
			let salesRow = turnKeyGridView.target.getList();
			const targetObject = salesRow.find(item => item.salesCd === row.salesCd);
			turnKeyGridView.target.select(targetObject.__index);
		});
	} 

	
	//비용구분 변경 이벤트처리
	function pchsCostDiv10Change(){
		var value = $("#pchsCostDiv10").val();
		//턴키면 턴키 등록용 그리드
// 		if(value == "PCHSCOSTDIV1030"){
			$("#turnKeyGrid").show();
			turnKeyGridView.initView().setData(0);
// 		}else{
// 			//아니면 숨김
// 			$("#turnKeyGrid").hide();
// 		}
	}

    
    function localgridResize(size) {
            let tagHeight = (size) * 27 + 25 ;
            tagHeight = tagHeight > 750 ? 750 : tagHeight;
            tagHeight = tagHeight < 300 ? 300 : tagHeight;
            
            turnKeyGridView.target.setHeight(tagHeight);
    }
    
    

	function sendMailCall() {
		try {
			if (approvalConfirmCheck){
		        sendMailExec();
			}
	    } catch (error) {
	    } finally {
	    }
	  
	}
	
	function approvalConfirmCheck (){
		//확인일자 체크
// 		if (editVal.todoYn != "Y") {
// 			alert("결재승인전 발송 할 수 없습니다.");
// 			return false;
// 		}
	
// 		var todoCfDtChk = gridViewPopApproval.target.list;
// 		todoCfDtChk.forEach(function (item) {
// 	        if (item.gb == "결재" && item.todoCfDt !== undefined) {
// 	        	alert(item.name + "님께서 결재 승인하지 않았습니다.");
// 	    		return false;
// 	        }
// 	    });
		return true;
	}
	
	async function sendMailExec() {
		//파일 첨부 여부(application.yml파일의 spring.fileAttached=YES or NO)
		//****************************************************************
		let fileAttached = false;
		let paramData = {"coCd#":$('#coCd').val()};
		postAjaxSync ("/mail/sendFilefileAttach", paramData, null, function(data) {
			fileAttached = (data.resultCode == "200") ? data.fileAttached : true;
		});
		//****************************************************************
		var fileName = "SM1001R01.jrf";
		var arg =  
			  "coCd#"		+  $('#coCd').val()
	    	+ "#ordrgNo#"	+  $('#costNo').val()
	    	+ "#userId#"	+  jwt.userId
	    	+ "#";         
	
		var tempUrl = "?file="+fileName;
			tempUrl += "&arg="+encodeURIComponent(arg);
			
		//****************************************************************
		// Report 출력물을 PDF 파일로 변환
		//****************************************************************	
		var attachFile="";
		if (fileAttached == "true") { //파일 첨부일 경우 PDF 변환
			let response = "";
			await ubiExportAjaxSync(fileName, arg, function(result) {
				response=result;
			});
			if (response.resultCode === 200) {
				const base64FileData = response.base64FileData;
				fileName = response.exportFileName;
				attachFile = downloadPDFFromBase64(base64FileData, fileName);
			} else {
	// 			console.log('PDF 내보내기 실패: ' + response.resultText);
			}
		}
		//****************************************************************	
	
		const orderCnt = 1;
		var ordetTxt = $('#costRmk').val();
	
		ordetTxt = ordetTxt + ((orderCnt > 1) ? (" 외 " + (orderCnt - 1) + "건") : "");
		var tempDudtDeqDt = $('#costDt').val();
	    var paramObj = {
	       "coCd" : $('#coCd').val(),
	       "clntCd" : $('#pchsClntCd').val(),
	       "clntMngNm" : "",
	       "pgmId" :  "SM1001P01",
	       "sendType" :  "SM1001P01",
	       "sendKey" : $('#fileTrgtKey').val(),
	       "tempUrl" : tempUrl,
	       "mailTitle" : moment().format('YYYY-MM-DD HH:mm') + " 기준  발주번호 (" + $('#costNo').val() + ")의 발주서 발송의 건",
	       "mailCnts" : ordetTxt + "의 발주서를 첨부와 같이 보내 드리오니 업무 참고 바랍니다.\n" +
	       				"        - 아 래 -\n" +
	                    " 1. 발주 번호 : " + $('#costNo').val() + "\n" +            
	                    " 2. 발주 일자 : " + $('#costDt').val() + "\n" + 
	                    " 3. 납기요청일자 : " + tempDudtDeqDt + "\n" + 
	                    " 3. 발주 업체 : " + $('#pchsClntNm').val() + "\n" + 
	                    " 4. 발주 금액 : " + addCommaStr($('#costAmt').val()) + "\n" + 
	                    " 5. 발주 내용 : " + ordetTxt + "\n" + 
	                    " 6. 발주 담당자 : " + jwt.userNm + "(" + jwt.email + ")\n" + 
	                    " 내용 확인 후 처리 해 주시기 바랍니다.\n" +               
	                    " 감사합니다.",                
	    };
	    
	    //카카오 addParam
	    let addParam = {
				"ordrgDt": $("#popForm #costDt").val()				//발주일자				
				, "clntNm": $("#popForm #pchsClntNm").val()				//공급사명 - 구매처
				, "ordrgNo": $("#popForm #costNo").val()				//발주번호
				, "ordrgCoCdNm": $("#popForm #coCd option:checked").text()				//발주회사명
				, "ordrgMngNm": $("#popForm #ordrgMngNm").val()				//발주담당자
				, "ordrgMngTelNo": $("#popForm #ordrgMngTelNo").val()				//발주담당자전화번호
				, "tmplatDiv": "TMPLATDIV01"							//알림톡발송템플릿 종류
	    }
	    Object.assign(paramObj, addParam);
	   	//****************************************************************
	   	// 파일 첨부 여부에 따라 출력물 첨부
	   	//****************************************************************	   
		if (fileAttached == "true") { //파일 첨부 여부
			paramObj["file"]     = attachFile;
			paramObj["fileName"] = fileName;
		}
	   	//****************************************************************
	    
// 	    modalStack.close();  //blind popup close   	
		openSecondModal("/static/html/cmn/modal/mailSend.html", 760, 850, "메일 보내기", paramObj, function() {});
	}	
	

	//카카오 발송 - 발주서
	function commKaKaoSendOrder(param) {
	// 	console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);
	
		//알림톡수신번호 채번
		var paramMax = { "userId" : jwt.userId
						, "tmplatDiv": param.tmplatDiv
						, "fileTrgtKey": param.fileTrgtKey 
						/* , "clntCd" : param.clntCd */ //임시 건양
						, "clntCd" : 1
						};
		var maxMessageId = null;			//message id(unique key)
		var talkMessage = null 				//발송될 내용 template
		var mobile = null					//수신인 휴대전화번호
		let talkParam = {};
		let talkBody = {};			
		let sendCnt = 0;	
		postAjaxSync("/user/bm/bm18/selectMaxMessageId", paramMax, null
					, function(data) {   
						if(data.resultList.length > 0 ) {
							if( data.resultList[0].maxMessageId != "" ) {
								maxMessageId = data.resultList[0].maxMessageId;							
								talkMessage = data.resultList[0].messageDesc;
								mobile =  data.resultList[0].mngMoblphonNo;
								param.nameTo =  data.resultList[0].mngNm; //수신인 이름
							} else {
								alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
								return;
							} 
	
						}
		});     //user search ajax end
		if(mobile == "" || mobile == null) {
// 			alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
			return;
		}
		
		//message 치환
		let message = talkMessage;
		let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);	
		//loop
		$.each(splitStr, function (key, val) {		
			let compKey = val.substring(1, val.length-1);
			if( compKey != "" && compKey != "undefined" ) {
				if( typeof(param[compKey]) != "undefined" ) {
					let val2 = '#'+val;
					message = message.replaceAll(val2, param[compKey]);
				}
			}
		});
	
		talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
		talkParam.serverName = "gyitt2400";		
		talkParam.paymentType = "P";
		talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
		talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);	
		//talkBody.messageType = "AT";			//톡드림 포탈 템플릿 사용하지 않을 경우 사용 (AT: 알림톡, AI: 이미지 알림톡 (messageType 누락시 AT가 기본값으로 사용됨)
		//talkBody.title = "(주)건양아이티티";				//알림톡 타이틀 - 
		if (param.mailTitle.length > 50) {
			param.mailTitle = param.mailTitle.substring(0, 49); // 50자까지만 자르기
		}
		talkBody.title = param.mailTitle;					//알림톡 타이틀 -
		talkBody.message = message;				//알림톡 메시지 (1000 byte) 
		talkBody.mobile = mobile;				//휴대전화번호
		talkBody.template = "10001";			//템플릿관리화면 템플릿ID	- 발주서 V2
		let talkJson = JSON.stringify(talkBody);
		sendCnt = kakaoSendReal(talkJson, talkParam, param);
		//한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
	// 	talkBody.messageId = 'KAKAO'+Number(maxMessageId.substring(5, 20))+1;
	// 	talkBody.mobile = "01063893764"
	// 	talkJson = JSON.stringify(talkBody);
		//kakaoSendReal(talkJson, talkParam, param);
		
		if( sendCnt > 0 ) {
	// 		alert("알림톡 정상 발송되었습니다.");		
		}	
	}


    function chechChange(elm) {
    	elm.value = addCommaStr(gPasIntChk(elm.value));
    }
</script>