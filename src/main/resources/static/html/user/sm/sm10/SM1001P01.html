<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">구매비용 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="SM1001M01">
 		<table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>

        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" required msg="회사">
				</select>
			</td>
			<th class="hit">SalesCode</th>
			<td>
				<div class="search_form">
				    <input type="text" id="salesCd" name="salesCd" required onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''">
				   	<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
			    </div>
			</td>
			<th>고객사</th>
			<td><input type="hidden" id="vendCd" name="vendCd" msg="고객사">
				<input type="text" id="vendNm" name="vendNm" msg="고객사">

			</td>
			<th>고객사PJT</th>
			<td><input type="hidden" id="clntPjtCd" name="clntPjtCd" msg="고객사PJT">
				<input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT"> 
			</td>
        </tr>

        <tr>
			<th>제품구분</th>
			<td>
				<input type="hidden" id="prdtCd" name="prdtCd">
				<input type="text" id="prdtNm" name="prdtNm">

			</td>
			<th>아이템구분</th>
			<td>
				<input type="hidden" id="itemDiv" name="itemDiv">
				<input type="text" id="itemDivNm" name="itemDivNm">
			</td>
			<th>설비명</th>
			<td>
				<input type="text" id="eqpNm" name="eqpNm">
			</td>
			<th></th>
        </tr>

        <tr>
        	<th colspan=8 style="height: 50px"">비용정보</th>
        </tr>

        <tr>
			<th>비용번호</th>
			<td>
				<input type="text"  id="costNo" name="costNo" msg="비용번호">
			</td>
			<th class="hit">처리일자</th>
			<td>
				<input id="costDt" name="costDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
			</td>
			<th class="hit">거래처</th>
			<td>
				<input type="hidden" id="pchsClntCd" name="pchsClntCd"required msg="거래처">
				<div class="search_form">
					<input type="text" id="pchsClntNm" name="pchsClntNm" required msg="거래처">
					<a onclick="clntSearch();"><i class="i_search_w"></i></a>
				</div>
			</td>
        </tr>

        <tr>
			<th class="hit">비용구분</th>
			<td>
	            <select id="pchsCostDiv10" name="pchsCostDiv10" data-kind="PCHSCOSTDIV10" required msg="비용구분">
	            	<option value="">선택</option>
	            </select>
			</td>
			<th class="hit">비용상세구분</th>
			<td>
				<select id="pchsCostDiv20" name="pchsCostDiv20" data-kind="PCHSCOSTDIV20" required msg="비용상세구분">
					<option value="">선택</option>
				</select>
			</td>
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" required msg="통화단위">
					<option value="">선택</option>
				</select>
			</td>
			<th  class="hit">금액</th>
			<td>
				<input type="text" id="costAmt" name="costAmt" class="form-control" comma required msg="금액">
			</td>
        </tr>

        <tr>
			<th class="hit">품번</th>
			<td>
				<div class="search_form">
	            	<input type="text" id="matrCd" name="matrCd" class="form-control" required msg="품번">
					<a onclick="openMatListSearch('P');"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th>품명</th>
			<td>
				<input type="text" id="matrNm" name="matrNm" class="form-control" msg="품명">
			</td>
			<th class="hit">환율</th>
			<td>
				<input type="text" id="exrate" name="exrate" class="form-control" comma required msg="환율">
			</td>
			<th>비고</th>
			<td>
				<input type="text" id="costRmk" name="costRmk" class="form-control" msg="비고">
			</td>
        </tr>
        
      </table>

    </form>
	</div>


	<!-- 공통 파일 영역 -->
        <div class="col-sm-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 400px;padding: 5px">
                    <div id="deptTreeOrdars"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
                <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
            </div>
        </div>
        	
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
  debugger;
	var actionType = null;
	var fileTrgtKey = null;

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(jwt.userId);
		
		//처리일자//
		$('#costDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");

		authChk();						// 권한체크

		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		
	    $("#vendNm").prop("readonly", true);
	    $("#clntPjt").prop("readonly", true);
	    $("#prdtNm").prop("readonly", true);
	    $("#itemDivNm").prop("readonly", true);
	    $("#eqpNm").prop("readonly", true);
	    $("#matrNm").prop("readonly", true);
	    
	    $('#currCd').on('change', exrateCal);
		
		if (actionType == "C") {
		     $("#costNo").prop("readonly", true);
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertPchsCost();
			});

		} else if (actionType == "U") {
			$('.tit').text('구매비용 수정')
			
			selectPchsCostInfo();

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updatePchsCost();
			});
		}
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		
	});

	//통화단위 변경
	function exrateCal() {
		var currCd = $('#currCd').val();
		var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
		$('#exrate').val(exrateVal ? exrateVal : '');

	}		
	
	function selectPchsCostInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		postAjax("/user/sm/sm10/selectPchsCostInfo", formData, null, function(data) {
				$.each(data.result, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				
		});
	}



	 // 등록
	function insertPchsCost() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/user/sm/sm10/insertPchsCost", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);
							modalStack.close();									// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updatePchsCost() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
	      	filePostAjax("/user/sm/sm10/updatePchsCost", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#vendCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	
    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd_S').val(),
           "salesCd": $('#salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $('#salesCd').val(row.salesCd);
            $('#clntPjt').val(row.clntPjt);
            $('#eqpNm').val(row.eqNm);
            $('#vendCd').val(row.ordrsClntCd);
            $('#vendNm').val(row.ordrsClntNm);
            $('#eqpNm').val(row.clntPjt);
            $('#prdtCd').val(row.prdtCd);
			$('#prdtNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
        });
    }
    		
	
	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
// 					$('#mngId').val(row.salesEmpId);
// 					$('#mngNm').val(row.salesEmpNm);

// 					var paramObj = {
// 						"coCd" : $('#coCd').val(),
// 						"clntCd" : row.clntCd
// 					}
// 					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
// 	function setMngInfo(paramObj) {
// 		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
// 				function(data) {
// 					if (data.mngInfo) {
// 						$('#mngId').val(data.mngInfo.salesEmpId);
// 						$('#mngNm').val(data.mngInfo.salesEmpNm);
// 					} else {
// 						$('#mngId').val("");
// 						$('#mngNm').val("");
// 					}
// 				});
// 	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	
	// 자재 품번 팝업 호출하는 함수
    function openMatListSearch(openType) {
          //debugger;
          var paramObj = {
      			"searchValue" : $("#matrNm").val()
          }
          openSecondModal("/static/html/cmn/modal/matListSearch.html", 600, 420, "자재 품번 검색", paramObj, function(grid) {
                        var row = grid.target.getList("selected")[0];
                        if (openType == "P") {
							$('#matrCd').val(row.matrCd);		// 	품번 값 가져오기
							$('#matrNm').val(row.matrNm);	//	품번 값 가져오기
                        } 
                 });
    }
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

</script>