<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
}

/* 크기 조절되지 않아 임시로 */
.date_input .input_calendar2 {
    background-color: #fff;
    width: calc(100%) !important;
}

.input_calendar2 {
    background-color: #fff;
    width: 100% !important;
    background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
    background-size: 13px 13px;
    cursor: pointer
}

</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">반품 상세</h4>
	</div>
	
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
			<input type="hidden" id="userId"      name="userId">
			<input type="hidden" id="pgmId"       name="pgmId" value="SM1401M01">
			<input type="hidden" id="pchsNo"	name="pchsNo">
		    <input type="hidden" id="ordrgNo"	name="ordrgNo">
		    <input type="hidden" id="coCd"	    name="coCd">
			<table>
				<colgroup>
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th >회사</th>
					<td>
						<select id="coCd_S" name="coCd_S" data-kind="CO" class="form-control input-sm"  msg="회사" disabled="true"></select>
					</td>
					<th class="inNum">입고번호</th>
					<td>
						<div class="search_form">
							<input type="text" id="inNum" name="inNum" readonly="readonly">
						</div>
					</td>
					<th>SalesCode</th>
					<td>
						<input type="text" id="salesCd" name="salesCd" msg="SALES CODE" readonly="readonly">
					</td>
					<th></th>
					<th></th>

				</tr>
				
				<!-- 2행 -->
				<tr>
					<th>고객사</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd" msg="고객사" readonly="readonly">
						<input type="text" id="clntNm" name="clntNm" msg="고객사" readonly="readonly">
					</td>

					<th>고객사PJT</th>
					<td>
						<input type="hidden" id="clntPjtCd" name="clntPjtCd" msg="고객사PJT" readonly="readonly">
						<input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT" readonly="readonly">
					</td>
					<th>제품구분</th>
					<td>
						<input type="hidden" id="prdtCd" name="prdtCd" readonly="readonly">
						<input type="text" id="prdtNm" name="prdtNm" readonly="readonly">
					</td>

					<th>아이템구분</th>
					<td>
						<input type="hidden" id="itemDiv" name="itemDiv" readonly="readonly">
						<input type="text" id="itemDivNm" name="itemDivNm" readonly="readonly">
					</td>
					
				</tr>
				
				<!-- 3행 -->
				<tr>
					<th>거래처</th>
					<td>
						<input type="hidden" id="pchsClntCd" name="pchsClntCd">
						<input type="text" id="pchsClntNm" name="pchsClntNm" msg="거래처" readonly="readonly">
					</td>
					<!-- 빈값추가 -->
					<th></th>
					<th></th>
					<th>설비명</th>
					<td colspan="3">
						<input type="text" id="eqpNm" name="eqpNm" readonly="readonly">
					</td>			
				</tr>
				
				<!-- 5행 -->
				<tr>
					<th>반품번호</th>
					<td>
						<input type="text" id="retNo" name="retNo" readonly="readonly">
					</td>
					
					<th>반품일자</th>
					<td>
						<input id="ioDt" name="ioDt" class="input_calendar form-control" autocomplete="off" onkeyup=""  date >
					</td>
					
					<th>비고</th>
					<td colspan="3">
						<input type="text" id="ioRmk" name="ioRmk">
					</td>
				</tr>
			</table>
		</div>
	
	 <div class="form-group popup_table">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        
        <tr>
        	<td colspan="8" class="title_m_td" style="">입고정보</td>
        </tr>     
        <tr>
			<th class="hit">매입금액</th>
			<td>
				<input type="text" id="pchsAmt" name="pchsAmt"  data-search="pchsAmt" onkeyup="" placeholder="" maxlength="13" comma data-ax5formatter="money" msg="매입금액" readonly/>
			</td>
			<th class="hit">부가세</th>
			<td>
				<input type="text" id="pchsVat" name="pchsVat"  data-search="pchsVat" onkeyup="" placeholder="" maxlength="13" comma data-ax5formatter="money" required="required" msg="부가세"/>
			</td>
			<th class="hit">확정일자</th>
			<td>
				<input id="pchsDt" name="pchsDt"  class="input_calendar2" autocomplete="off" onkeyup="dateMask(this);"
					required="required" msg="확정일자" data-search="pchsDt"onchange="limit_date_chk(this.value);">
			</td>
			<th></th>
			<td>
			</td>
        </tr>
       
      </table>
    </form>
    
<!-- 하단 디테일그리드 -->
		<!-- 콘텐츠 -->
	  <div class="contents2" style="margin-bottom: 50px; height:150px;">
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:250px; width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">매입상세</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a id="deleteDetailButton" style="" authchk>-</a>&nbsp;
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="in-grid-modal" data-ax5grid-config="{}" style="height:150px; width: 100%" ></div>               	
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>
<!-- 하단 디테일그리드 end -->  

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
	var actionType  = null;
	var fileTrgtKeyU = null;		//list에서 받은값
	var salesCdU = null;			//list에서 받은값
	var ordrgNoU =  null;			//list에서 받은값
	var coCdU = null;
	var limitDate = null;
	var inDt = null;
	var limit_yn = "N";
	
	var gridViewPopIn = {
	    	initView: function(){
				this.target = new ax5.ui.grid();
				this.target.setConfig({
					showLineNumber: true,
					showRowSelector: false,
					multipleSelect: false,
					target: $('[data-ax5grid="in-grid-modal"]'),
					header: {
		              align: "center",
		              selector: false
		            },
		            body: {
						onClick: function() {
						    this.self.select(this.dindex);
	
						},
						//그리드값 변경시 실행
			            onDataChanged: function () {
						    var row = this.dindex;
	
			            },					
						onDBLClick: function() {
	
						},
				   },
					footSum: [
	  			    	[
	   			    		{label: "합계",          colspan:2, align:"center"},
	  			    		{key: "pchsAmt", 		collector: "sum", formatter:"money", align: "right"},
	  			    		{key: "pchsVat",		collector: "sum", formatter:"money", align: "right"}, 
	  	                 ]
	  			    ],
		           columns: [
							 {key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
							,{key: "pchsSeq",	    	label: "pchsSeq",			width: 70,		align: "center", 	hidden:true}						
							,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}						
//							,{key: "salesCd", 			label: "Sales Code", 	    width: 120,		align: "center"}
							,{key: "ordrgNo", 			label: "비용번호", 		    width: 120,		align: "center"}
							,{key: "pchsNo", 			label: "매입번호", 		    width: 120,		align: "center"}
							,{key: "pchsAmt", 			label: "매입금액", 			width: 110,		align: "right", formatter: "money"}
							,{key: "pchsVat", 			label: "부가세", 			    width: 110,		align: "right", formatter: "money"}
							,{key: "pchsDt", 		    label: "확정일자", 			width:  150,	align: "center", editor: {type: "date", config: {}}}
							,{key: "creatNm", 		    label: "생성자", 			    width:  150,	align: "center", editor: {type: "date", config: {}}}
							,{key: "creatDttm", 	    label: "생성일자", 			width:  150,	align: "center", editor: {type: "date", config: {}}}
		              ]
					   ,
				       contextMenu: {
				          iconWidth: 20,
				          acceleratorWidth: 100,
				          itemClickAndClose: false,
				          icons: {
				              'arrow': '<i class="fa fa-caret-right"></i>'
				          },
				          items: [
				              {type: 1, label: "붙여넣기"},
				              {divide: true},
				          ],
				          popupFilter: function (item, param) {
				              //console.log(item, param);
				              if(param.element) {
				                  return true;
				              }else{
				                  return item.type == 1;
				              }
				          },
				          onClick: function (item, param) {
								thisGridRow = param.dindex;
								thisGridCol = param.colIndex;
						   	}
						},        // contextMenu     				   
		        });
				return this;
	    	},
			setData: function(_pageNo) {
				var targetObj = this.target;
	        	var formData = new FormData();
	        	var salesCd = salesCdU ;
	        	var fileTrgtKey = fileTrgtKeyU;
	        	var coCd = coCdU ;
	        	var ordrgNo = ordrgNoU ;
	        	
	        	var formData = {
					"fileTrgtKey" : fileTrgtKey,
					"coCd" : coCd,
					"ordrgNo" : ordrgNo,
				}
				postAjax("/user/sm/sm14/selectPchsDetailListNew", formData, null, function(data){
					try {
						var list = data.result;
						if(list.length == 0) $("#pchsNo").val('');
						$.each($.extend({}, list), function (idx, elem) {
							$("#pchsNo").val(elem.pchsNo);
						});
						targetObj.setData({
							list : list,
							page : {
									totalElements : list.length,
								} 
						});		
					} catch (error) {
						alert("오류 발생!! 전산실 연락 바랍니다", error.message);
						return null; // 오류 발생 시 null 반환
					} finally {
						// console.log("함수 실행 완료.");
					}			
	            });    	   
			} 
	}

	var actionType = null;
	var fileTrgtKey = null;
	var totalpchsAmt = null;
	
	//화면 초기 설정
	$(document).ready(function() {
		actionType = modalStack.last().paramObj.actionType;
		
	  	//확정일자//
		$('#pchsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
	  	
		$.initViewPop = function() {
			
			setCommonSelect($(".popup_area select[data-kind]"));
			//setByCoCd(modalStack.last().paramObj.coCd);
	
			$("#popForm #userId").val(jwt.userId);
			$('#coCd').val( modalStack.last().paramObj.coCd);
			$('#coCd_S').val( modalStack.last().paramObj.coCd);
	
			fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
			$('#pchsAmt').val($('#totalpchsAmt').val());
			setVat();
			$('#ordrgNo').val( modalStack.last().paramObj.ordrgNo);
	
			//전역 set
			salesCdU = modalStack.last().paramObj.salesCd;
			ordrgNoU = modalStack.last().paramObj.ordrgNo;	
			coCdU = modalStack.last().paramObj.coCd;
			
			// 제한일자 지정
			limitDate = modalStack.last().paramObj.limitDate;

			//입고일자 지정
			inDt = modalStack.last().paramObj.inDt;
			
			//반품일자To//
			$('#ioDt').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true
			}).datepicker("setDate", new Date());
			
			actionType = modalStack.last().paramObj.actionType;
			fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
			
			// 정보 가져오기
			select_sm06_Info();
	
			authChk();						// 권한체크
			
			gridViewPopIn.initView().setData(0);
			
			// 제한일자 체크
			limit_date_chk($('#pchsDt').val());
			
			$('#actionBtn').text("등록");
			$('#actionBtn').on("click", function() {
				insertOrder();
			});

			if (actionType == "T") {
				$("#deleteDetailButton").hide();
			}
			$("#deleteDetailButton").on("click", function () {
				if (selectGridValidation(gridViewPopIn.target)) return;
				var row = gridViewPopIn.target.getList("selected")[0];
				var formData = {
					"coCd": row.coCd,
					"pchsNo": row.pchsNo,
					"ordrgSeq": row.ordrgSeq,
					"ordrgNo": row.ordrgNo,
					"userId" : jwt.userId,
				}
				if (confirm("삭제하시겠습니까?")) {
					deleteAjax("/user/sm/sm14/deletePurchaseDetail", formData, null, function (data) {
						alert(data.resultMessage);
						gridView.setData(0);
						gridViewPopIn.setData(0);
					});
				}
			});
		}
		$.initViewPop();
	});	

	
	//입력정보
	function select_sm06_Info() {
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		
		postAjaxSync("/user/sm/sm06/select_sm06_Info", formData, null, function(data) {
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
			});
		});
	}

	// 등록 - done
	function insertOrder() {
			
		if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
			var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성    

			if(formData){
				filePostAjax("/user/sm/sm14/insertPurchaseBillDetailNew", formData, function (data) {
					alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
					gridView.setData(0);
					gridViewPopIn.setData(0);
				});		
			}
		}
	}

	function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#pchsAmt,#pchsVat'), function (idx, elem) {
            deleteComma(elem);
        });

        
        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });
        
        var formData = new FormData($("#popForm")[0]);
        
		if($("#pchsAmt").val() == 0){
			alert('매입금액을 입력하십시요.');
			return false;
		}
 		 var rowListView = gridViewPopIn.target.getList();
		
          var rowpchsAmt = 0;
          $.each(rowListView, function (idx, elem) {
        	  rowpchsAmt += parseFloat(elem.pchsAmt);
          });
        
        // input box 값과 비교
        var inputAmtVal = pasIntChk($("#pchsAmt").val())+rowpchsAmt;

         if (inputAmtVal != $("#totalpchsAmt").val()) {
 	        alert("입고금액 처리되었습니다.");
 	        return false;
         }
        
		return formData;	
	}
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}
	
	function setVat(){
		var pAmt = $("#pchsAmt").val();
		var Amt = pasIntChk(pAmt);
		var vat = Math.floor(Number(Amt / 10));

		$("#pchsVat").val(addCommaStr(vat));
		$("#pchsAmt").val(addCommaStr(pAmt));
	}

	function pasIntChk (value) {
		const cvtValue = parseInt(deleteCommaStr(value));
		return isNaN(cvtValue) ? 0 : cvtValue;
	}

	//제한일자 체크
	function limit_date_chk(chkValue) {
		// monthCloseChk(chkValue);

		//debugger;

		limit_yn = "N";
		
		if (limitDate != null) {
			if (limitDate > chkValue ) {
				limit_yn = "Y";
				alert('제한된 일자입니다. ' + limitDate + '일 이전은 데이터를 등록 및 수정할 수가 없습니다.');
				//$('#actionBtn').remove();
				$("#actionBtn").hide();
			} else {
				limit_yn = "N";
				$("#actionBtn").show();
			}
		}

		// 제한일자 위반이 아닌 경우 입고일자 체크
		if (limit_yn == "N") {
			if (inDt > chkValue ) {
				alert('입고일 ' + inDt + ' 이전은 데이터를 등록 및 수정할 수가 없습니다.');
				//$('#actionBtn').remove();
				$("#actionBtn").hide();
			} else {
				$("#actionBtn").show();
			}
		}

		// actionType === "T" 읽기 조회
		if (actionType === "T") {
			$("#actionBtn").hide();
		} else {
			$("#actionBtn").show();
		}
	}
</script>