<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
}

/* 크기 조절되지 않아 임시로 */
.date_input .input_calendar2 {
    background-color: #fff;
    width: calc(100%) !important;
}

.input_calendar2 {
    background-color: #fff;
    width: 100% !important;
    background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
    background-size: 13px 13px;
    cursor: pointer
}

</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">매입 상세</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId" value="SM1401M01">
		<input type="hidden" id="fileTrgtKey"	name="fileTrgtKey" value="">		<!-- file target key -->		
		<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
		<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->		
		<input type="hidden" id="pchsNo"	name="pchsNo">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
        	<td colspan="8" class="title_m_td">수주정보</td>
        </tr>
        <tr>
			<th>회사</th>
			<td>
				<input type="hidden" id="coCd" name="coCd" data-search="coCd"  msg="coCd" readonly=/>
				<input type="text" id="coCdNm" name="coCdNm"  readonly=/>
			</td>
			<th>Sales Code</th>
			<td>
			     <input type="text" id="salesCd" name="salesCd" data-search="salesCd"  msg="Sales Code" readonly=/>
			</td>
			<th>고객사</th>
			<td>
				<input type="hidden" id="ordrsClntCd" name="ordrsClntCd" data-search="ordrsClntCd">
				<!-- <div class="search_form">  -->
					<input type="text" id="ordrsClntNm" name="ordrsClntNm" data-search="ordrsClntNm" readonly> 
					<a onclick="openClntSearchP('P');"><i class="i_search_w"></i></a>
				<!-- </div>  -->			
			</td>
			<th>고객사PJT</th>
			<td>
				<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" data-search="clntPjt" readonly>	
			      <option value="">전체</option>
				</select>				  
			</td>			
        </tr>
        <tr>
			<th>SalesCode별 요청번호</th>
			<td>
				<div class="search_form">
					<input type="text" id="reqNo" name="reqNo" msg="요인별요청번호"> 
				</div>
			</td>	        
			<th>제품구분</th>
			<td>
				<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" msg="제품구분">
				<input type="text" id="prdtNm" name="prdtNm" data-search="prdtNm" msg="제품구분" readonly>				 
			</td>
			<th>아이템구분</th>
			<td>
				<input type="text" id="itemDivNm" name="itemDivNm" data-search="itemDivNm" msg="아이템구분" readonly>	
			</td>
			<th>설비명</th>
			<td colspan="0">
				<input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm" msg="설비명" readonly>
			</td>		
        </tr>
        
        <tr>
        	<td colspan="8" class="title_m_td" style="">발주정보</td>
        </tr>     
        <tr>
			<th>발주번호</th>
			<td>
			  <input type="text" id="ordrgNo" name="ordrgNo" msg="발주번호" readonly>
			</td>
			<th>구매처</th>
			<td>
				<input type="hidden" id="pchsClntCd" name="pchsClntCd"  data-search="pchsClntCd">
				<div class="search_form">
					<input type="text" id="pchsClntNm" name="pchsClntNm"  data-search="pchsClntNm" readonly  msg="구매처"> 
				</div>
			</td>
			<th>발주일자</th>
			<td>
	                <input id="ordrgDt" name="ordrgDt" data-search="ordrgDt" readonly>			
			</td>
			<th></th>
			<td>	              			
			</td>
        </tr>
        <tr>    
			<th>통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" data-search="currCd" msg="통화단위" disabled="true">
			      <option value="">전체</option>
				</select>	
			</td>
			<th>환율</th>
			<td>
				<input type="text" id="exrate" name="exrate"  data-search="exrate" data-ax5formatter="money"  comma readonly/>
			</td>			
			<th>발주금액</th>
			<td>
				<input type="text" id="ordrgAmt" name="ordrgAmt"  data-search="ordrgAmt" onkeyup="" placeholder="" readonly comma data-ax5formatter="money" />
			</td>
			<th>비고</th>
			<td colspan="1">
				<input type="text" id="ordrgRmk" name="ordrgRmk"  data-search="ordrgRmk" readonly>
			</td>
        </tr>    
       
      </table>

	<div class="" style="height: 10px;">
	</div>	    
        	

<!-- 하단 디테일그리드 -->
		<!-- 콘텐츠 -->
	  <div class="contents2" style="margin-bottom: 10px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:100%; width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">발주 / 입고 상세</h5>
	                </div>
	                <div>
	                	<div data-ax5grid="bom-grid-modal" data-ax5grid-config="{}" style="height:100%; width: 100%" ></div>               	
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>
<!-- 하단 디테일그리드 end -->  

    <div class="form-group popup_table">
      <table>

        <colgroup>
          <col width="10%">
          <col width="14%">
          <col width="10%">
          <col width="14%">
          <col width="10%">
          <col width="14%">
          <col width="10%">
          <col width="14%">
          <col width="10%">
          <col width="14%">
          <col width="10%">
          <col width="14%">
        </colgroup>
        
        <tr>
        	<td colspan="12" class="title_m_td" style="">입고정보</td>
        </tr>     
        <tr>
			<th class="hit">매입금액</th>
			<td>
				<input type="text" id="pchsAmt" name="pchsAmt"  data-search="pchsAmt" onkeyup="javascript:setVat();" comma data-ax5formatter="money" required msg="매입금액"/>
			</td>
			<th class="hit">부가세</th>
			<td>
				<input type="text" id="pchsVat" name="pchsVat"  data-search="pchsVat" comma data-ax5formatter="money" required msg="부가세"/>
			</td>
			<th class="hit">확정일자</th>
			<td>
			     <input id="pchsDt" name="pchsDt"  class="input_calendar2" autocomplete="off" onkeyup="dateMask(this);"
				 	required msg="확정일자" data-search="pchsDt" onchange="limit_date_chk(this.value);">
			</td>
			<th  class="hit">청구/영수구분</th>
			<td>
				<select id="payDiv" name="payDiv" class="form-control" data-kind="PAYDIV" required msg="청구/영수구분">
					<!-- <option value="">선택</option> -->
				</select>
			</td>
			<th>영수일자</th>
			<td>
				<input id="payDivDt" name="payDivDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" date msg="영수일자">
			</td>
			<th>비 고</th>
			<td colspan = 1>
				<input type="text" id="pchsRmk" name="pchsRmk"  data-search="pchsRmk" />
			</td>
			</td>
        </tr>
       
      </table>
    </form>

	<div class="" style="height: 10px;">
	</div>	    
        	
<!-- 하단 디테일그리드 -->
		<!-- 콘텐츠 -->
	  <div class="contents2" style="margin-bottom: 50px; height:150px;">
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:250px; width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">매입상세</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a id="deleteDetailButton" style="height: 28px; line-height: 26px; width: 90px;" authchk>확정삭제</a>&nbsp;
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="in-grid-modal" data-ax5grid-config="{}" style="height:200px; width: 100%" ></div>               	
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>
<!-- 하단 디테일그리드 end -->  

	<!-- 공통 파일 영역 -->
	<div id="fileList_area" style="display:none"></div>
	
	<br><br>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"	onclick="modalStack.close();">닫기</button>
	</div>
	
<script type="text/javascript">
	//전역초기화
	var firstGrid = null;
	var secondGrid = null;
	var currToday = [];
	var remaindAmt = 0; 	//매입미확정금액 계산용
	var totAcceptAmt = 0; 	//총입고금액 계산용
	let maxIndt = '';	//최종 입고일자를 확인하기 위함
	var editVal = {};
	var limitDate = null;
	var inDt = null;
	var limit_yn = "N";
	var actionType = null;

	ax5.ui.grid.formatter["clntChk"] = function () {
		var color = this.value == "Y" ? '<img src="/static/img/color-circle_02.png" style="width: 10px;height: 10px;"></img>' : '';
		if (this.value == "E"){
			return 'E';
		} else {
			return color;
		}
	};
	
	var gridViewPop = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,	
				showRowSelector: true,
				multipleSelect: true,
				target: $('[data-ax5grid="bom-grid-modal"]'),
				header: {
	              align: "center",
	              selector: true
	            },
	            body: {
					onClick: function() {
					    this.self.select(this.dindex);

					},
					//그리드값 변경시 실행
		            onDataChanged: function () {
					    var row = this.dindex;

		            },					
					onDBLClick: function() {
						//this.self.clearSelect();
                        //this.self.select(this.dindex);
                    	//updateBomMatrModal('U');
					},
			   },
				footSum: [
  			    	[
  			    		{label: "합계", colspan:8, align:"center"},	
  			    		{key: "inQty",			    collector: "sum", formatter:"money", align: "center"},  
  			    		{},  
  			    		{key: "inDtlAmt",			collector: "sum", formatter:"money", align: "right"},
  			    		{},
  			    		{},
  			    		{},
  			    		{},
  			    		{key: "bomQty", 			collector: "sum", formatter:"money", align: "center"},
  			    		{key: "preBomQty",		    collector: "sum", formatter:"money", align: "center"},	
  			    		{key: "ordrgQty",			collector: "sum", formatter:"money", align: "center"},  
  			    		{key: "ordrgPrc",			collector: "sum", formatter:"money", align: "right"},
  			    		{key: "ordrgAmt",			collector: "sum", formatter:"money", align: "right"},  				
  	                 ]
  			    ],
	           columns: [
				 	 	 {key: "fileTrgtKey", 		label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
						,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}						
						,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
						,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 	hidden:true}
						,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 	hidden:true}						
						,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 	hidden:true}	
						,{key: "dsgnNo", 			label: "도번", 				width: 170,		align: "left", 	hidden:false}						
						,{key: "matrCd", 			label: "자재코드", 			width: 80,		align: "left"}		/* 품번 */						
						,{key: "matrNm", 			label: "자재명", 				width: 150,		align: "left"}		/* 품명 */
						,{key: "matrMat", 			label: "소재", 				width: 70,		align: "center"}						
						,{key: "matrMakrNm", 		label: "MAKER", 			width: 70,		align: "center"}	/* 제조사 */
						,{key: "bomPchsClntNm", 	label: "BOM거래처", 			width: 80,		align: "center"}
						,{key: "mngNm", 			label: "담당자명", 			width: 80,		align: "center"}	/* 담당자명 */						
						,{key: "inQty", 			label: "입고수량", 			width: 70,		align: "center", formatter: "money"}
						,{key: "inPrc", 			label: "입고단가", 			width: 100,		align: "center", formatter: "money"}
						,{key: "inDtlAmt", 			label: "입고금액", 			width: 110,		align: "right", formatter: "money"}
						,{key: "inDt", 				label: "입고일자", 			width:  80,		align: "center"}												
						,{key: "inNo", 				label: "입고번호", 			width:  75,		align: "center"}												
						,{key: "pchsNo", 			label: "확정번호", 			width:  75,		align: "center"}												
						,{key: "pchsSeq", 			label: "확정순번", 			width:  75,		align: "center"}												
						,{key: "bomQty", 			label: "BOM수량", 			width: 60,		align: "center"}			/*수량 */						
						,{key: "preBomQty", 		label: "기발주수량", 			width: 80,		align: "center"}			/*기발주 수량 */			
						,{key: "userChkV", 			label: "userChkV", 			width: 60,		align: "center", 	hidden:true}	/* 수정시 userChk */						
						,{key: "ordrgQty", 			label: "발주수량", 			width: 80,		align: "center", formatter: "money"}
						,{key: "ordrgPrc", 			label: "발주단가", 			width: 90,		align: "right", formatter: "money"}
						,{key: "ordrgAmt", 			label: "발주금액", 			width: 110,		align: "right", formatter: "money"}	
						,{key: "dudtDeqDt", 		label: "납기요청일", 			width:  75,		align: "center"}												
					
	              ]
	        });
			return this;
    	},
		setData: function(_pageNo, _newReqNo) {
			var targetObj = this.target;
        	var formData = {
				"fileTrgtKey" 	: $("#popForm #fileTrgtKey").val(),
				"coCd" 			: $("#popForm #coCd").val(), 
				"salesCd" 		: $("#popForm #salesCd").val(),
				"ordrgNo" 		: $("#popForm #ordrgNo").val(),
			}
			postAjax("/user/sm/sm14/selectOrderDetailListNew", formData, null, function(data){
				try {
					var list = data.result;
					targetObj.setData({
						list : list,
						page : {
								totalElements : list.length,
							} 
					});	
					gridHeightResize(list.length); //그리드 높이 조정
					remaindAmt = 0;
					$.each($.extend({}, list), function (idx, elem) {
						remaindAmt += pasIntChk(elem.inDtlAmt);
						let lastInDt = deleteHyphenStr(elem.inDt);
						if (maxIndt < lastInDt) maxIndt = lastInDt;	//최종 입고 일자 체크용
					});

					if (remaindAmt < 0) remaindAmt= 0;
					totAcceptAmt = remaindAmt;	//총입고금액 산정 공용변수 저장함
					
					$('#pchsAmt').val(addCommaStr(remaindAmt));  //매입금액입력정보 Clear
					setVat();  						//VAT 계산
				} catch {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
            });    	   
		} 
	}
	// end gridViewPop

	var gridViewPopIn = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,
				showRowSelector: false,
				multipleSelect: false,
				target: $('[data-ax5grid="in-grid-modal"]'),
				header: {
	              align: "center",
	              selector: false
	            },
	            body: {
					onClick: function() {
					    this.self.select(this.dindex);

					},
					//그리드값 변경시 실행
		            onDataChanged: function () {
					    var row = this.dindex;

		            },					
					onDBLClick: function() {

					},
			   },
				footSum: [
  			    	[
   			    		{label: "합계",          colspan:6, align:"center"},
  			    		{key: "pchsAmt", 		collector: "sum", formatter:"money", align: "right"},
  			    		{key: "pchsVat",		collector: "sum", formatter:"money", align: "right"}, 
  			    		{key: "pchsTot",		collector: "sum", formatter:"money", align: "right"}, 
  	                 ]
  			    ],
	           columns: [
						 {key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}					
						,{key: "salesCd", 			label: "Sales Code", 	    width: 180,		align: "center"}
						,{key: "ordrgNo", 			label: "발주번호", 		    width: 100,		align: "center"}
						,{key: "ordrgSeq",	    	label: "발주순번",				width: 60,		align: "center", 	hidden:false}	
						,{key: "pchsNo", 			label: "매입번호", 		    width: 100,		align: "center"}
						,{key: "pchsSeq",	    	label: "매입순번",				width: 60,		align: "center", 	hidden:false}						
						,{key: "pchsDt", 		    label: "확정일자", 			width: 100,	align: "center"}
						,{key: "pchsAmt", 			label: "매입금액", 			width: 120,		align: "right", formatter: "money"}
						,{key: "pchsVat", 			label: "부가세", 			    width: 100,		align: "right", formatter: "money"}
						,{key: "pchsTot", 			label: "합계", 				width: 120,		align: "right", formatter: "money"}
						,{key: "payDiv", 	    	label: "영수", 				width:  80,		align: "center", 	hidden:true}
						,{key: "payDivNm", 	    	label: "영수", 				width:  80,		align: "center"}
						,{key: "payDivDt", 	    	label: "영수일자", 			width:  100,		align: "center"}
						,{key: "pchsRmk", 	    	label: "비고", 				width:  200,	align: "left"}
						,{key: "creatNm", 		    label: "생성자", 			    width:  80,	align: "center"}
						,{key: "creatDttm", 	    label: "생성일자", 			width:  130,	align: "center"}
	              ]
	        });
			return this;
    	},
		setData: function(_pageNo) {
			var targetObj = this.target;
        	
        	var formData = {
				"fileTrgtKey" 	: $("#popForm #fileTrgtKey").val(),
				"coCd" 			: $("#popForm #coCd").val(),
				"ordrgNo" 		: $("#popForm #ordrgNo").val(),
			}
			postAjax("/user/sm/sm14/selectPchsDetailListNew", formData, null, function(data){
				try {
					var list = data.result;
					if(list.length == 0) $("#pchsNo").val('');

					$.each($.extend({}, list), function (idx, elem) {
						$("#pchsNo").val(elem.pchsNo);
						remaindAmt -= parseInt(elem.pchsAmt);
					});
					if (remaindAmt < 0) remaindAmt= 0;
					$('#pchsAmt').val(addCommaStr(remaindAmt));  //매입금액입력정보 Clear
					setVat();  						//VAT 계산
					targetObj.setData({
						list : list,
						page : {
								totalElements : list.length,
							} 
					});	
				} catch {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}				
            });    	   
		} 
	}
	// end gridViewPop
	
	
	$(document).ready(function() {
		actionType = modalStack.last().paramObj.actionType;
		//combo set
		setCommonSelect($(".popup_area select[data-kind]"));
		//setByCoCd(modalStack.last().paramObj.coCd);
		//전역 set
		$('#coCd').val( modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(modalStack.last().paramObj.userId);	
		$("#popForm #fileTrgtKey").val(modalStack.last().paramObj.fileTrgtKey);	
		//formatter
		$('[data-ax5formatter]').ax5formatter();

		// 제한일자 지정
		limitDate = modalStack.last().paramObj.limitDate;

		//입고일자 지정
		inDt = modalStack.last().paramObj.inDt;

		// debugger;
	
	  	//확정일자//
		$('#pchsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
	
		//지급일자//
		$('#payDivDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
		
		$('#payDiv').change(function () {
	    	if ($("#payDiv").val() == "PAYDIV01") {
	    		$('#payDivDt').show();
	    		$('#payDivDt').parent('td').prev('th').addClass('hit');
	    		$('#payDivDt').attr('required', 'true');
	    	} else {
	    		$('#payDivDt').val("");
	    		$('#payDivDt').hide();
	    		$('#payDivDt').parent('td').prev('th').removeClass('hit');
	    		$('#payDivDt').removeAttr('required', 'true');
	    	}
	
		});

		//지급구분 초기화 설정 --> 청구이면 날자는 공백으로 처리
		$('#payDiv').val('PAYDIV02');
		$('#payDivDt').val('');
		$('#payDivDt').hide();
		
		//let editVal = {};
		postAjaxSync("/user/sm/sm02/selectOrderDetailView", modalStack.last().paramObj, null, function(data) {
			var list = data.resultList;
			if( list.length > 0 ) {
				$.each(list[0], function (key, val) {
					//html element overwrite set
					if( val && typeof($("#"+key).attr("name")) != "undefined" ) {
						$("#popForm #"+key).val(val);
					}
					editVal[key] = val;
				});
				
				// 금액 콤마
				$.each($('#popForm input[comma]'), function(idx, elem) {
					onlyNumber(elem);
				});
			}
		});
		
		//그리드 load
		gridViewPop.initView().setData(0);		
		gridViewPopIn.initView().setData(0);		

		$('#actionBtn').text("등록");
		$('#actionBtn').on("click", function() {
			insertOrder();
		});

		if (actionType == "T") {
			$("#deleteDetailButton").hide();
		}
		$("#deleteDetailButton").on("click", function () {
			if (selectGridValidation(gridViewPopIn.target)) return;
			var row = gridViewPopIn.target.getList("selected")[0];
			//마감일자 체크
			if (!monthCloseChk(row.pchsDt,"D", $('#popForm #coCd').val())) {
				return false;
			}
			var formData = {
				"coCd"		: row.coCd,
				"pchsNo"	: row.pchsNo,
				"pchsSeq"	: row.pchsSeq,
				"ordrgSeq"	: row.ordrgSeq,
				"ordrgNo"	: row.ordrgNo,
				"userId" 	: jwt.userId,
			}
			if (confirm("삭제하시겠습니까?")) {
				deleteAjax("/user/sm/sm14/deletePurchaseDetail", formData, null, function (data) {
					// alert(data.resultMessage);
					gridView.setData(0);
					gridViewPopIn.setData(0);
				});
				fnSetting();
			}
		});
		
		// 권한체크    
		authChk();
		
		// 제한일자 체크
		limit_date_chk($('#pchsDt').val());
		
	});
	
	// 등록 - done
	function insertOrder() {
		if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
			var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성    

			if(formData){
				filePostAjax("/user/sm/sm14/insertPurchaseBillDetailNew", formData, function (data) {
					// alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
					gridView.setData(0);
					gridViewPopIn.setData(0);
					fnSetting();
					modalStack.last().callback(modalStack.last().paramObj.__index);
					modalStack.close();
				});		
			}
		}
	}

	function crossCheck(){
		let rowCheck = gridViewPop.target.getList("selected"); //발주/입고 상세내역 선택
		let rowInDtlAmt = 0;
		$.each(rowCheck, function (idx, elem) {
			rowInDtlAmt += pasFloatChk(elem.inDtlAmt);
		});

		if (rowInDtlAmt != pasFloatChk($('#pchsAmt').val())) {
			alert ("입고 금액과 확정금액이 일치하지 않습니다.!")
			return false;
		} else {
			return true;
		}
	}

	function fnSetting(){
		$('#pchsAmt').val("");
		$('#pchsVat').val("");
	}

	function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#pchsAmt,#pchsVat'), function (idx, elem) {
            deleteComma(elem);
        });

        //마감체크 여부 추가
		if (!monthCloseChk($('#pchsDt').val())) return false;
        
		if($("#pchsAmt").val() == 0){
			alert('매입금액을 입력하십시요.');
			return false;
		}
		
		let rowListView = gridViewPopIn.target.getList(); //매입확정 상세내역
		let rowpchsAmt = 0;
		$.each(rowListView, function (idx, elem) {
			rowpchsAmt += pasFloatChk(elem.pchsAmt);
		});
        
        // input box 값과 비교
        var inputAmtVal = pasIntChk($("#pchsAmt").val())+rowpchsAmt;
		if (inputAmtVal > totAcceptAmt) {
 	        alert("입고금액을 초과했습니다.");
 	        return false;
		}

		if (maxIndt > deleteHyphenStr($('#pchsDt').val())) {
 	        alert("최종입고일 이전 매입확정처리 불가합니다.");
 	        return false;
		}
        
        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });
        
        var formData = new FormData($("#popForm")[0]);
        
        //----------------------
        //발주/입고 상세내역 선택  입고내역 선택자료에대한 매입확정번호 설정을 위한 자료담기
        //매입번호 IN24xxxxx에 해당하는 매입확정번호 PC24xxxxx를 연결시키기 위함
        let ipgoArr = [];
		let rowData = gridViewPop.target.getList(); 
		$.each(rowData, function (idx, elem) {
			if ((pasIntChk(rowData[idx].inDtlAmt) != 0 && pasIntChk(rowData[idx].inQty) != 0 && rowData[idx].pchsNo == undefined) ){ 
				ipgoArr.push(rowData[idx]);
			}
		});
		formData.append("ipgoArr", JSON.stringify(ipgoArr));

		//입고번호를 ,로 연결한 스트링만들기  시작
		const getUniqueInNos = new Set();
	    rowData.forEach(item => { getUniqueInNos.add(item.inNo); });
	    let tempInNo = Array.from(getUniqueInNos).join(',');
	    formData.append("inNo", tempInNo);
		//입고번호를 ,로 연결한 스트링만들기  끝
	  
		if (rowListView.length > 0) {
			formData.append("pchsSeq", rowListView[0].pchsSeq);
		} else {
			formData.append("pchsSeq", "");
		}
		//작업담당자 부서코드 추가
		formData.append("deptId", jwt.deptId.slice(0,5));
		
		return formData;	
	}
	
	function setVat(){
		var pAmt = $("#pchsAmt").val();
		var Amt = pasIntChk(pAmt);
		var vat = Math.floor(Number(Amt / 10));
	
		$("#pchsVat").val(addCommaStr(vat));
	}
	
	function pasIntChk (value) {
		const cvtValue = parseInt(deleteCommaStr(value));
		return isNaN(cvtValue) ? 0 : cvtValue;
	}
	
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}
	
	function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}
	
	function gridHeightResize(size) {
	    var tagHeight = (size) * 27 + 90 ;
	    tagHeight = tagHeight > 750 ? 750 : tagHeight;
	    tagHeight = tagHeight < 200 ? 200 : tagHeight;
		
	    gridViewPop.target.setHeight(tagHeight);
	}

	//제한일자 체크
	function limit_date_chk(chkValue) {
		// monthCloseChk(chkValue);

		//debugger;

		limit_yn = "N";
		
		if (limitDate != null) {
			if (limitDate > chkValue ) {
				limit_yn = "Y";
				alert('제한된 일자입니다. ' + limitDate + '일 이전은 데이터를 등록 및 수정할 수가 없습니다.');
				//$('#actionBtn').remove();
				$("#actionBtn").hide();
			} else {
				limit_yn = "N";
				$("#actionBtn").show();
			}
		}

		// 제한일자 위반이 아닌 경우 입고일자 체크
		if (limit_yn == "N") {
			if (inDt > chkValue ) {
				alert('입고일 ' + inDt + ' 이전은 데이터를 등록 및 수정할 수가 없습니다.');
				//$('#actionBtn').remove();
				$("#actionBtn").hide();
			} else {
				$("#actionBtn").show();
			}
		}

		// actionType === "T" 읽기 조회
		if (actionType === "T") {
			$("#actionBtn").hide();
		} else {
			$("#actionBtn").show();
		}
	}
</script>