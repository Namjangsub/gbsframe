<div id ='areaApproval' class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
		<h4 class="tit">[aaaaaaaa] [bbbbbbbbbbbb] 매입대금 지급 결재요청</h4>
    </div>
	<div class="form-group popup_table">
	<form id="popFormApproval" onSubmit="return false;" method="post" enctype="multipart/form-data">
		<input type="hidden" id="userId" name="userId">
		<input type="hidden" id="fileTrgtTyp" name="fileTrgtTyp" value="SM3002P01">
		<input type="hidden" id="pgmId" name="pgmId" value="SM3002P01">

		<table>
			<colgroup>
				<col width="10%">
				<col width="15%">
				<col width="10%">
				<col width="15%">
				<col width="10%">
				<col width="15%">
				<col width="10%">
				<col width="15%">
			</colgroup>
			<!-- 1행 -->
			<tr>
				<th>회사</th>
				<td>
					<select data-search="coCd" id="coCd" name="coCd" class="modal-coCd" style="width: 100%;" data-kind="CO" msg="회사">
					</select>
				</td>

				<th>지급년월</th>
				<td>
					<input type="text" id="closeYm" name="closeYm"  class="form-control" required>
				</td>

				<th>결제일자</th>
				<td>
					<select id="pchsClmnDay" name="pchsClmnDay" data-search="pchsClmnDay">
						<option value="" selected>전체</option>
						<option value="10">10</option>
						<option value="25">25</option>
					</select>
				</td>

				<th>발행여부</th>
				<td>
					<select id="billYn" name="billYn" data-search="billYn" msg="발행여부">
						<option value="" selected="selected">전체</option>
						<option value="Y">발행</option>
						<option value="N">미발행</option>
					</select>
				</td>
			</tr>
			<!-- 2행 -->
			<tr>
				<th>결재요청번호</th>
				<td>
					<input type="text" id="fileTrgtKey" name="fileTrgtKey" readonly>
				</td>
				<th>부서명</th>
				<td>
					<select id="deptId" name="deptId" data-search="deptId">
						<option value="" selected>전체</option>
						<option value="TRN50">구매팀</option>
						<option value="TRN30">직접매출</option>
					</select>
				</td>

				<th>턴키구분</th>
				<td>
					<select id="trunDiv" name="trunDiv" data-search="trunDiv">
						<option value="">전체</option>
						<option value="PCHSCOSTDIV1030" selected>턴키자료만</option>
						<option value="PCHSCOSTDIV" selected>구매및가공</option>
					</select>
				</td>

				<th>청구/영수</th>
				<td>
					<select id="payDiv" name="payDiv" class="form-control" data-kind="PAYDIV" msg="청구/영수구분">
						<!-- <option value="">선택</option> -->
					</select>
				</td>
			</tr>
		</table>

		<div class="contents" style="height: 430px; clear: both; margin-bottom: 20px;">
			<table style="border:0px; width:100%;">
				<tr style="height:30px;">
					<td style="text-align: LEFT; border-right: 0; font-size:13px; font-weight:bold;">
						※ 대금 지급 대상 리스트
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div class="ax5_grid"
							data-ax5grid="first-grid-Approval"
							data-ax5grid-config="{}"
							style="height: 400px; width: 100%; clear: both;">
						</div>
					</td>
				</tr>
			</table>
		</div>

		<!-- 두 번째 그리드(공유 및 결재) -->
		<div class="contents"
			style="height: 200px; clear: both; margin-bottom: 20px;">
			<table style="border:0px; width:100%;">
				<tr style="height:30px;">
					<td style="text-align: LEFT; border-right: 0; font-size:13px; font-weight:bold;">
						※ 공유 및 결재
					</td>
					<td>
						<div class="add_btn_small pdl10" id="plus-minus">
							<a onclick="insertShareUserModal1();" style="height: 30px; line-height: 28px;" authchk>＋</a>
							<a onclick="deleteShareUser1();"   style="height: 30px; line-height: 28px;" authchk>－</a>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div class="ax5_grid"
							data-ax5grid="second-grid-Approval"
							data-ax5grid-config="{}"
							style="height: 150px; width: 100%; clear: both;">
						</div>
					</td>
				</tr>
			</table>
		</div>
	</form>
	<!-- 공통 파일 영역-->
	<div id="fileList_area" style="display: none;"></div>
	</div>

	

	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn" style="margin-bottom:20px;">
		<button type="button" id="actionBtn1" authChk>등록</button>
		<button type="button" class="close_btn" onclick="executeCallback();">닫기</button>
		<button type="button" id="actionBtn2" authChk>삭제</button>
		<button type="button" id="updateApprovalBtn" onclick="updateShareUser()">결재자 수정</button>
	</div>
</div>

<script type="text/javascript">
	var fileTrgtKey = null;
	var actionType = null;
	
	var coCd = null;
	var closeYm = null;
	var pchsClmnDay = null;
	var billYn = null;
	var trunDiv = null;
	var trunDivNm = '턴키';
	var deptId = null;
	var payDiv = null;

	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];
	var todoTitleSt ='';

	var deleteFileArr = [];

	var holdChanged = false;		// 보류 체크박스가 한 번이라도 변경됐는지 표시

	let titleCoCd = null;
	let titltDeptNm = null;

	ax5.ui.grid.formatter["bilgYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E") {
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};

	ax5.ui.grid.formatter["holdYnNm"] = function () {
		return (this.value === "Y") ? "보류" : "";
	};

	var gridApproval1 = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
				showLineNumber: true,
				lineNumberColumnWidth: 40,
				multipleSelect: true,
				sortable: false,
				target: $('[data-ax5grid="first-grid-Approval"]'),
				header: {
						align: "center",
						selector: true
				},
				body: {
					columnHeight: 23,
					mergeCells : ["custId"],//editor 는 merge 안됨

					onClick: function () {
						if (this.column.key === "holdYn") {
							var row = this.list[this.dindex];
							row.holdYn = (row.holdYn === "Y" ? "N" : "Y");
							this.self.repaint();

							holdChanged = true;
							toggleApprovalButtonByHold();
						}
					},
					onDBLClick: function () {
						var row = this.list[this.dindex];
						if (this.column.key == 'ctrtApprovalNo' && this.item.ctrtApprovalNo) {	//수주품의번호이면서 번호가 존재하면 팝업 생성 
							var paramObj = {
					                "coCd" 		 	: row.coCd,
					                "ctrtApprovalNo": row.ctrtApprovalNo,
					                "ordrsNo" 		: row.ordrsNo,
					                "ctrtNo" 		: row.ctrtNo,
					                "clntCd"      	: row.clntCd,
					                "deptId"        : $("#popFormApproval #deptId").val(),
					        };
							openSecondModal("/static/html/user/sm/sm30/SM3001P01.html", 1600, 850, "", paramObj, function(data) {
							});
						} else {
							if (row.ctrtNo) { 
								var paramObj = {
										"actionType"     : 'T',
										"fileTrgtKey" : row.sm11FileTrgtKey,
										"ctrtNo"      : row.ctrtNo,
										"coCd" 	      : row.coCd,
								       	"userId"      : jwt.userId,
								       	"pgmId"       : "SM1101M01"
								}
								openSecondModal("/static/html/user/sm/sm11/SM1101P01.html", 1500, $('body').height()-50, "", paramObj, function(data) {
								});
							}
						}
					},
				},

				footSum: [
					[
						{label: "합계", colspan:5, align:"senter"},
						{key: "pchsAmt", collector: "sum", formatter:"money", align: "center"},
						{key: "pchsVat", collector: "sum", formatter:"money", align: "center"},
						{key: "pchsTot", collector: "sum", formatter:"money", align: "center"},
						{key: "billTot", collector: "sum", formatter:"money", align: "center"},
					]
				],
				columns : [
					{key: "deleteBtn",		label: "삭제", width: 50, align: "center", hidden: true,
						formatter: function() {return '<button type="button" '+   'onclick="delete_sm30_select_list('+ this.dindex + ',' + this.item.seq + ')" '+   'style="margin-left:3px; height:18px;padding:0" authchk>삭제</button>';}
					},
					{key: "holdYn",			label: "보류", width: 40, align: "center", hidden: true,
						formatter: function() {return '<input type="checkbox" style="width:14px; height:14px; margin:0; vertical-align:middle;" '+ (this.value==="Y" ? 'checked' : '') + ' />';}
					},
					{key: "holdYn",			label: "승인",		width: 50,	align: "center", formatter: "holdYnNm", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";}},
					{key: "fileTrgtKey",	label: "파일대상KEY",		width: 50,	align: "center",  hidden: true},
					{key: "seq",			label: "순번",			width: 50,	align: "center",  hidden: true},
					{key: "coCd",			label: "회사",			width: 50,	align: "left", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: "custId",			label: "고객사CD", 		width: 180, align: "left", hidden: true},
					{key: "custNm",			label: "고객사",			width: 180,	align: "left", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: "ctrtApprovalNo",	label: "품의번호", 	    width: 80,	align: "center", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: "clntPjt",		label: "PJTCD",			width: 80,	align: "left", hidden: true},
					{key: "clntPjtNm",		label: "PJT",			width: 80,	align: "left", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: "ordrsNo",		label: "수주번호",			width: 70,	align: "center", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: "ctrtNo",			label: "계약번호",			width: 120,	align: "center", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: "clntCd",			label: "구매처CD",		width: 180,	align: "left", hidden: true},
					{key: "clntNm",			label: "구매처명",			width: 180,	align: "left", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					{key: undefined, 		label: "매입확정" , columns : [
						{key: "pchsAmt", 		label: "확정금액", 	width: 100,	align: "right", formatter: "money", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
						{key: "pchsVat", 		label: "부가세",		width: 100,	align: "right", formatter: "money", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
						{key: "pchsTot", 		label: "확정 합계", 	width: 100,	align: "right", formatter: "money", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					]},
					{key: undefined, 		label: "세금계산서 발행 완료" , columns : [
						{key: "billTot", 		label: "발행 합계", 	width: 100,	align: "right", formatter: "money", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
						{key: "billNo", 		label: "계산서번호", 	width: 100,	align: "center", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
						{key: "billDt",		 	label: "발행일자", 	width: 100,	align: "center", styleClass: function () {return (this.item.holdYn == "Y") ? "grid-font-red" : "";},},
					]},
					{key: undefined, 		label: "결재요청" , columns : [
						{key: "aprReqSts", 		label: "상태", 		width: 40,	align: "center", formatter: "bilgYn"},
						{key: "aprovalDt", 		label: "요청일", 		width: 80,	align: "center"},
						{key: "aprovalNm", 		label: "요청자", 		width: 70,	align: "center"},
					]},
					{key: "sm11FileTrgtKey", label: "sm11파일대상KEY",			width: 180,	align: "left", hidden: true},

				],
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			var paramObj = {
				"fileTrgtKey" : $("#popFormApproval #fileTrgtKey").val(),
				"coCd"		  : $("#popFormApproval #coCd").val()
			}
			postAjax("/user/sm/sm30/sm30_pop_grid1_selectList", paramObj, null, function(data) {
				try {
					let list = data.result;
					if (list.length > 0 ) {
						targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							}
						});
					}
				} catch  (error){
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		}
	}
	
	

	//공유 결재 그리드
	var gridApproval2 = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="second-grid-Approval"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function () {
						this.self.select(this.dindex);
					},
					onDBLClick: function () {
					},
					mergeCells : ["gb"],
				},
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView2.setData(this.page.selectPage);
					}
				},
				columns : [
					{key: "gb",      			label: "구분",      	align: "center",   width: 40},
					{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 50},
					{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
					{key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
					//{key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: false},
					{key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
					{key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
					{key: "name",       		label: "성명",      	align: "center",   width: 80},
					{key: "jik",       			label: "직위",      	align: "center",   width: 60},
					{key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 90},
					{key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 130},
					{key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: 200},
					{key: "telNo",      		label: "H.P",		align: "center",   width: 130},
					{key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
					{key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},
					{key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
					{key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
					]
					});
					return this;
				},

				setData : function(_pageNo) {
					var targetObj = this.target;
					var formData = {
						"fileTrgtKey" 	: $("#popFormApproval #fileTrgtKey").val(),
						"reqNo" 		: $("#popFormApproval #fileTrgtKey").val(),
					}
					postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
						try {
							var list = data.result;
							if( list.length > 0 ) {
								targetObj.setData({
									list : list,
									page : {
										totalElements : list.length
									}
								});
							}
							togglePlusMinusButtons();  // 결재자 추가 및 삭제 버튼 토글함수
						} catch (error){
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					});
				},

				setData2 : function(_list) {
					this.target.setData({
						list : _list,
						page : {
								totalElements :  _list.length,
							   }
					});
				}
				,
				setData3 : function(_pageNo) {
					var targetObj = this.target;
					var paramObj = { 
							      "userId": jwt.userId
								, "appDiv": 'APPDIV20'		//매입대금 결재라인
					};
					postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : { totalElements : list.length }
							});
						} catch(error){
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					
					});
				}
	}
	
	$(document).ready(function() {
		setComboOptions($("#areaApproval select[data-kind]"));
		const param = modalStack.last().paramObj;
		actionType = param.actionType;

		$('#popFormApproval').find('input:not([type="hidden"]), textarea').prop('readonly', true).css({'background-color': '#e9ecef','pointer-events': 'none'});
		$('#popFormApproval').find('select').css({'background-color': '#e9ecef','pointer-events': 'none'});
		
		$('#popFormApproval #clntNm').off('keyup').css('pointer-events', 'none');
		$('#popFormApproval .search_form a').removeAttr('onclick').off('click').css('pointer-events', 'none');

		gridApproval1.initView();
		gridApproval2.initView();

		$('#plus-minus').hide();
		$("#actionBtn2").hide()	//전체 삭제기능 버튼은 수정시만 활성화됨
		$('#updateApprovalBtn').hide();	// 결재자 수정버튼
		// 턴키제외로 들어온 정보는 해당 컬럼 숨김
		if (param.trunDiv == "PCHSCOSTDIV") {
			gridApproval1_columns_hide();
			trunDivNm = '일반';
		}
		
		if (actionType == "C") {
			$("#popFormApproval #coCd").val(param.coCd);
			$("#popFormApproval #closeYm").val(param.closeYm);
			$("#popFormApproval #pchsClmnDay").val(param.pchsClmnDay);
			$("#popFormApproval #billYn").val(param.billYn);
			$("#popFormApproval #payDiv").val(param.payDiv);

			$.each(param, function (key, val) {
				if( $("#popFormApproval").find("#" + key).length > 0 ) {
					$("#popFormApproval").find("#" + key).val(val);
				}
			});
			// 팝업창 제목 처리
			titleCoCd = $("#popFormApproval #coCd").val() == 'GUN' ?  '아이티티' : '트루넷'
			titltDeptNm = $("#popFormApproval #deptId").val() == 'TRN50' ? '구매팀' : '직접매출'
			$('#areaApproval .tit').text(param.closeYm + "월 " + titleCoCd + ' ' + titltDeptNm + " [" + trunDivNm + " 매입대금] 지급 결재 요청");	// 제목처리

			const cols = gridApproval1.target.config.columns.map(col => {
				if (col.key === "holdYn" && col.label === "승인") {
				return { ...col, hidden: true };
				}
				return col;
			});
			gridApproval1.target.setConfig({ columns: cols });

			// 발행합계 매칭 : compTot -> billTot
			const gridData = param.row.map(row => ({
				...row,
				billTot: row.compTot
			}));

			gridApproval1.target.setData({
				list : gridData,
				page : { totalElements: gridData.length}
			})
			

			gridApproval2.setData3();

			$('#plus-minus').show();
			
			$("#areaApproval #actionBtn1").text("등록");
			$('#areaApproval #actionBtn1').on("click", function() {
				insert_sm30();
			});
		} else if (actionType == "U" || actionType == "S" || actionType == "T") {
			fileTrgtKey = param.fileTrgtKey;
			coCd = param.coCd;
			
			//헤더 정보 가져오기
			select_sm30_info()
			if (actionType == "U") {
				$("#areaApproval #actionBtn1").hide();
				$('#areaApproval #actionBtn2').on("click", function() {
					delete_all_sm30();
				});
			} else { // actionType == "S" || actionType == "T"
				// $("#areaApproval #plus-minus").hide();
			}
		} else {
			alert("오류 발생! 전산실에 연락바랍니다.")
		}
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popFormApproval #pgmId").val(),
				fileTrgtKey	: fileTrgtKey
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		authChk();// 권한체크

	});

	// 결재 보류 수정
	function updateApprovalHold(){
		if (jwt.userId != 'EMJ8105') return false;

		// gridApproval1 그리드 정보
		var rawList = gridApproval1.target.getList();
		// 각 행에 대해 holdYn 이 'Y' 인 경우만 'Y', 그렇지 않으면 'N' 으로 명시
		var gridApproval1List = rawList.map(function(row){
			return {
				...row,
				holdYn: row.holdYn === 'Y' ? 'Y' : 'N'
			};
		});

		// gridApproval2 그리드 정보
		var gridApproval2List = gridApproval2.target.getList().filter(item => item.todoId === jwt.userId);

		var formData = new FormData();

		formData.append("userId", jwt.userId);
		formData.append("pgmId", "SM3002P01");
		formData.append("detailArr", JSON.stringify(gridApproval1List));
		formData.append("todoArr", JSON.stringify(gridApproval2List));
		filePostAjax("/user/sm/sm30/updateApprovalHold", formData,function(data) {
			if (data.resultCode == 200) {
				alert("완료되었습니다.");
				if (modalStack.modalArr.length > 0) modalStack.close();
            } else {
				alert("업데이트 실패: " + data.resultMessage);
			}
		});
	}

	function select_sm30_info() {
		var formData = {
			"fileTrgtKey": fileTrgtKey, // fileTrgtKey가 제대로 설정되어 있는지 확인
			"coCd"  	 : coCd
		}
		postAjaxSync("/user/sm/sm30/select_sm30_info", formData, null, function(data) {
			// 응답 데이터를 폼에 채워 넣음
			$.each(data.result, function(key, value) {
				if (key === "payYymm") {
					$("#popFormApproval #closeYm").val(value);
				} else 
				if ($('#popFormApproval #' + key)[0]) {
					$('#popFormApproval #' + key).val(value);
					
					// 숫자 관련 필드일 경우 comma 처리를 하는 부분
					if ($('#popFormApproval #' + key).is('[comma]')) {
						onlyNumber($('#popFormApproval #' + key)[0]);
					}
				} else 
				if (key === "creatId") {
					$("#popFormApproval #userId").val(value)
				}
			});
			
			const chk_sanctnSttus  = data.approval ==null ? 'N' : data.approval.sanctnSttus;
			//전체 삭제 버튼 기능 적용 
			if (actionType == "U" && chk_sanctnSttus == 'N' && jwt.userId == $("#popFormApproval #userId").val()) {
				//결재 진행 여부에 따라 삭제버튼 비활성화 하기	
				$("#areaApproval #actionBtn1").show();
				$("#areaApproval #actionBtn2").show();
				// 그리드 deleteBtn 컬럼 보이기
				var updatedColumns = gridApproval1.target.columns;
				updatedColumns[0].hidden = false;
				gridApproval1.target.setConfig({ columns: updatedColumns });
			} else {
				$("#areaApproval #actionBtn1").hide();
				$("#areaApproval #actionBtn2").hide();

				// $("#areaApproval #plus-minus").hide();
			}

			// 턴키제외 일때 해당 컬럼 숨김
			if (data.result.trunDiv == "PCHSCOSTDIV") {
				gridApproval1_columns_hide();
				trunDivNm = '일반';
			} 
			// 부사장님이 해당 팝업창 오픈 시 결재 보류 체크박스 컬럼 보이게 해놓기
			if ((actionType == 'T' || actionType == 'S') && jwt.userId == 'EMJ8105') {
				var updatedColumns = gridApproval1.target.columns;
				var idx = updatedColumns.findIndex(function(col) {
					return col.key === 'holdYn';
				});

				if (idx !== -1) {
					// 김태호 부사장님 일때만 보이고, 아니면 숨김
					updatedColumns[idx].hidden = (jwt.userId !== 'EMJ8105');

					// 변경된 컬럼 설정을 그리드에 반영
					gridApproval1.target.setConfig({ columns: updatedColumns });
				}
			}

			titleCoCd = $("#popFormApproval #coCd").val() == 'GUN' ?  '아이티티' : '트루넷'
			titltDeptNm = $("#popFormApproval #deptId").val() == 'TRN50' ? '구매팀' : '직접매출'
			$('#areaApproval .tit').text($("#popFormApproval #closeYm").val() + "월 " + titleCoCd + ' ' + titltDeptNm + " [" + trunDivNm +" 매입대금] 지급 결재 요청 조회");

			gridApproval1.setData();
			gridApproval2.setData();

			togglePlusMinusButtons();  // 결재자 추가 및 삭제 버튼 토글함수
			toggleApprovalButtonByHold(); // 등록되어 있는 자료에 대해 결재자 추가버튼 토글함수
		});
	}

	function makeFormData() {
		if (!inputValidation($('#areaApproval [required]'))) {
			return false;
		}

		// 날짜 하이픈 제거
		$.each($('#areaApproval  input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});

		
		selectTeamManagerApprovalAdd();		// 결재라인 자동 생성

		// 폼데이터 생성
		var formData = new FormData($("#popFormApproval")[0]);


		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , '');         //첨부화일용
		formData.append("prdtCd" , '');         //첨부화일용
		formData.append("itemCd" , '');         //첨부화일용
		formData.append("prjctCd", $('#popFormApproval #clntPjt').val());      //첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());   //첨부화일용

		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();

		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
					formData.append("files", obj.file);
					obj.file = '';
					fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		var detailArr = gridApproval1.target.list;
		formData.append("detailArr", JSON.stringify(detailArr));

		// title 지정 코드
// 		var uniqueClntNms = Array.from(new Set(detailArr.map(item => item.clntNm))); 
// 		var clntNmString = uniqueClntNms.join(', ');
// 		var todoTitleStr = "[대금지불] " + clntNmString + " "+ $("#closeYm").val() + "월 " + $("#trunDiv").val() + "일"  결제 대금지불 요청건";
		
		todoTitleStr = `[대금지불]${$("#popFormApproval #deptId option:selected").text()}  ${$("#popFormApproval #closeYm").val()}월 ${$("#popFormApproval #trunDiv option:selected").text()} ${$("#pchsClmnDay").val()}일자 대금 지불`;

		// 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가
		// 공유 : TODODIV10, TODODIV1170  결재 :TODODIV20, TODODIV2170

		/*	결재그리드 insert make start */
		//결재그리드
		var rowSharngList = gridApproval2.target.list;
		var ParamObj = modalStack.last().paramObj;

		if(rowSharngList.length > 0) {
			var rowSharngListArr = []; //공유정보
			var rowApprovalListArr = []; //결재정보

			$.each(rowSharngList, function(idx, elem) {
				var rowSharngListObj = elem;
				var rowApprovalListObj = elem;
				if (elem.gb == '공유') {
					rowSharngListObj["gb"] = elem.gb;
					rowSharngListObj["coCd"] = elem.coCd;
					//rowSharngListObj["salesCd"] = $('#salesCd').val();
					rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
					rowSharngListObj["todoDiv2CodeId"] = "TODODIV1170";
					rowSharngListObj["todoId"] = elem.usrNm;
					rowSharngListObj["todoCoCd"] = elem.coCd;
					rowSharngListObj["empNo"] = elem.empNo;
					rowSharngListObj["name"] = elem.name;
					rowSharngListObj["telNo"] = elem.telNo;
					rowSharngListObj["email"] = elem.eMail;
					rowSharngListObj["pgPath"] = "/user/sm/sm30/SM3002P01.html";
					//TITLE 추가
					rowSharngListObj['todoTitle'] = todoTitleStr + ' 공유';
					rowSharngListArr.push(rowSharngListObj);
				} else if (elem.gb == '결재') {
					rowApprovalListObj["gb"] = elem.gb;
					rowApprovalListObj["coCd"] = elem.coCd;
					//rowApprovalListObj["salesCd"] = $('#salesCd').val();
					rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
					rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2170";
					rowApprovalListObj["todoId"] = elem.usrNm;
					rowApprovalListObj["todoCoCd"] = elem.coCd;
					rowApprovalListObj["empNo"] = elem.empNo;
					rowApprovalListObj["name"] = elem.name;
					rowApprovalListObj["telNo"] = elem.telNo;
					rowApprovalListObj["email"] = elem.eMail;
					rowApprovalListObj["pgPath"] = "/user/sm/sm30/SM3002P01.html";
					//TITLE 추가
					rowApprovalListObj['todoTitle'] = todoTitleStr + ' 결재';
					rowApprovalListArr.push(rowApprovalListObj);
				}
			});
			formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
			formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
		}
		formData.append("S_todoDiv1CodeId", "TODODIV10");
		formData.append("S_todoDiv2CodeId", "TODODIV1170");

		return formData;
	}


	// 등록
	function insert_sm30() {
		if (inputValidation($('#areaApproval [required]'))) {
			var formData = makeFormData();
			if (formData) {
				filePostAjax("/user/sm/sm30/insert_sm30", formData, function(data) {
					if (data.resultCode == 200) {
						$("#popFormApproval #fileTrgtKey").val(data.fileTrgtKey);
						alert("등록되었습니다.")
						kakaoTodo();				//kakaoTodo() 호출
						executeCallback();
					}
				});
			}
		}
	}

	// 전체 삭제
	function delete_all_sm30() {
		var rows = gridApproval1.target.getList();
		if (actionType == 'C') {
			alert("잘못된 접근 입니다. 전산실에 연락바랍니다.")
			return false;
		}
		postAjaxSync("/user/sm/sm30/selectApprovalUserChk", {reqNo:$("#popFormApproval #fileTrgtKey").val()}, null, function(res) {
			const chk_sanctnSttus  = res.result ==null ? 'N' : res.result.sanctnSttus;
			//전체 삭제 버튼 기능 적용 
			// (this.userId) 제외, 누군가 Y 이면 삭제 금지
			if (chk_sanctnSttus == 'Y') {
				alert("결재 진행중인 자료는 삭제할 수 없습니다.\n\n결재 진행 상태 확인 바랍니다.");
				return false;
			}
		});
		
		var formData = {
			"fileTrgtKey" 	: $("#popFormApproval #fileTrgtKey").val(),
			"reqNo" 		: $("#popFormApproval #fileTrgtKey").val(),
			"aprReqNo" 		: $("#popFormApproval #fileTrgtKey").val(),
			"coCd"			: $("#popFormApproval #coCd").val(),
			"userId"		: $("#popFormApproval #userId").val(),
			"fileTrgtTyp"  	: $('#popFormApproval #pgmId').val(),
		}
		if (confirm("매입대금 지급 결재 요청을 삭제하시겠습니까?")) {
			putAjax("/user/sm/sm30/delete_all_sm30", formData, null, function(data) {
				if (data.resultCode == 200) {
					// 상세 리스트 삭제
					executeCallback();
				}
			});
		}
	}

	// 리스트 건별 삭제
	function delete_sm30_select_list(rowIndex, seq) {
		var row = gridApproval1.target.list[rowIndex];
		if (row.holdYn == 'Y') {
			alert("보류건은 삭제할 수 없습니다.");
			return false;
		}
		
		const gridLength = gridApproval1.target.list.length;
		var formData = {
			fileTrgtKey	: $("#popFormApproval #fileTrgtKey").val(),
			aprReqNo	: $("#popFormApproval #fileTrgtKey").val(),
			seq			: seq,
			clntCd 		: row.clntCd,
			ctrtNo		: row.ctrtNo,
			billNo		: row.billNo,
			totCount 	: gridLength
		};

		putAjax("/user/sm/sm30/delete_sm30_detail", formData, null, function(data) {
			if (data.resultCode == 200) {
				alert("삭제되었습니다.");
				
				if (gridLength == 1) {
					executeCallback();
					return false;
				}
				// 그리드에서 해당 인덱스의 행을 삭제
				gridApproval1.target.removeRow(rowIndex);
			} else {
				alert("삭제에 실패했습니다.");
			}
		});
	}

	// 공유대상자 추가
	function insertShareUserModal1() {
		// 현재 그리드에 담긴 리스트(기존 공유+결재) 가져오기
		var appshaList = gridApproval2.target.getList();

		// 팝업에 전달할 파라미터 세팅
		var paramObj = {
			coCd: $('#popFormApproval #coCd').val(),
			useYn: "Y",
			userId: jwt.userId,
			userNm: jwt.userNm,
			// 기존 그리드에 있는 결재 행만 팝업에 전달
			approvalGrid: $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
				return {
					gb: "결재",
					id: item.usrNm,
					coCd: item.coCd,
					text: item.name,
					parent: item.jik,
					deptNm: item.dtNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
					todoId: item.todoId,
					todoKey: item.todoKey,
					sanctnSn: item.sanctnSn,
					sanctnSttus: item.sanctnSttus,
					todoCfDt: item.todoCfDt,
					todoCfOpn: item.todoCfOpn,
					flag: item.flag
				};
			}),
			// 기존 그리드에 있는 공유 행만 팝업에 전달
			shareGrid: $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
				return {
					gb: "공유",
					id: item.usrNm,
					coCd: item.coCd,
					text: item.name,
					parent: item.jik,
					deptNm: item.dtNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
					todoId: item.todoId,
					todoKey: item.todoKey,
					sanctnSn: item.sanctnSn,
					sanctnSttus: item.sanctnSttus,
					todoCfDt: item.todoCfDt,
					todoCfOpn: item.todoCfOpn,
					flag: item.flag
				};
			})
		};

		openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj,
			function (approvalGrid, shareGrid) {
				// 팝업에서 다시 선택된 결재 리스트
				var selectedApproval = approvalGrid.target.list.map(function(item) {
					return {
						gb: "결재",
						usrNm: item.id,
						coCd: item.coCd,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.todoId,
						todoKey: item.todoKey,
						sanctnSn: item.sanctnSn,
						sanctnSttus: item.sanctnSttus,
						todoCfDt: item.todoCfDt,
						todoCfOpn: item.todoCfOpn,
						flag: item.flag
					};
				});

				// 팝업에서 다시 선택된 공유 리스트
				var selectedShare = shareGrid.target.list.map(function(item) {
					return {
						gb: "공유",
						usrNm: item.id,
						coCd: item.coCd,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.todoId,
						todoKey: item.todoKey,
						sanctnSn: item.sanctnSn,
						sanctnSttus: item.sanctnSttus,
						todoCfDt: item.todoCfDt,
						todoCfOpn: item.todoCfOpn,
						flag: item.flag
					};
				});

				// 그리드에 남아 있는 기존 결재/공유 리스트
				var existing = gridApproval2.target.getList();
				var existingApproval = existing.filter(item => item.gb === "결재");
				var existingShare    = existing.filter(item => item.gb === "공유");

				// 중복 검사: usrNm 기준으로, 기존에 없는 항목만 추가
				var toAddApproval = selectedApproval.filter(function(sel) {
					return !existingApproval.some(function(ex) { return ex.usrNm === sel.usrNm; });
				});
				var toAddShare    = selectedShare.filter(function(sel) {
					return !existingShare.some(function(ex) { return ex.usrNm === sel.usrNm; });
				});

				// 병합 후 그리드 갱신
				gridApproval2.setData2(existingApproval.concat(toAddApproval).concat(existingShare.concat(toAddShare)));
				if (actionType != "C") {
					$('#updateApprovalBtn').show();
				}
			}
		);
	}


	//결재 여부
	function approvalYn() {
		var gridList = gridApproval2.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
				var msgArr = [];
				$.each(gridList, function (idx, elem) {
				//결재자가 본인이 아니면서 상태가 Y인 경우
				if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
				})
		}
		return inCnt;
	}

	function deleteShareUser1(){
		var sel = gridApproval2.target.selectedDataIndexs;
		var selRow = parseInt(sel);
		if (isNaN(selRow)) {
			alert("선택된 행이 없습니다.");
			return;
		}
		var item = gridApproval2.target.getList()[selRow];
		// 1) 이미 승인된(Y) 결재자는 삭제 불가
		if (item.sanctnSttus === "Y") {
			alert("이미 승인된 결재자는 삭제할 수 없습니다.");
			return;
		}
		// 2) 신규 등록된 경우 로컬에서만 삭제
		if (typeof item.todoKey === "undefined") {
			gridApproval2.target.removeRow(selRow);
			$.gridNoSet(gridApproval2, "sanctnSn");
			return;
		}
		var paramObj = {
			todoNo:   $("#popFormApproval #fileTrgtKey").val(),
			todoKey:  item.todoKey,
			sanctnSn: item.sanctnSn,
			todoDiv1CodeId: item.todoDiv1CodeId,
			todoDiv2CodeId: item.todoDiv2CodeId
		};
		deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
			if (data.resultCode == 200) {
				alert(data.resultMessage);
				gridApproval2.setData(0);
			} else {
				alert("삭제중 오류가 발생했습니다");
			}
		});
	}

	/*
	#   TODO 알림톡발송 시작
	#
	*/
	// $("#approvalReqTodoBtn").on("click", function () {
	//    kakaoTodo();
	// });

	function kakaoTodo() {
		//message load
		if (kakaoErr.length == 0) {
			var paramObj = {
				"codeId" : jwt.userId,
				"codeKind" : "KAKAOMSG"
			};
			postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
				if(data.resultList.length > 0 ) {
					kakaoErr = data.resultList;
				}
			});
		}

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
		var paramObj1 = {
			"coCd" 	  : jwt.coCd,
			"userId"  : jwt.userId
		};
		postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data) {
			if (data.result[0] == undefined || data.result[0].telNo == "") {
				teleNo = "051-312-2400";
			} else {
				teleNo = data.result[0].telNo;
			}
		});

		let param = {
			"tmplatDiv": "TMPLATDIV02"
			// , "coCd": $("#popFormApproval #coCd").val()            //해당 결재 담당자의 소속 (오류때문에 주석)
			, "todoDiv1CodeId": "TODODIV20"               //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV2170"               //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "결재"                  //공통코드 해당업무 - 결재 - 발주서
			//, "todoDiv2CodeNm": "발주 및 출장 요청"                  //공통코드 해당업무 - 결재 - 발주서
			, "title": todoTitleStr
			//[대금지불]흥진유압 2025년3월 대금지불 요청건
			, "sanctnDiv2": "결재"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo": $("#popFormApproval #fileTrgtKey").val()
			, "clntCd": "1"               //발신회사는 로그인사용자 회사
			, "clntNm": clntNm            //로그의 수신거래처명
			, "ordrgMngNm": jwt.userNm         //작성자(담당자)
			, "ordrgMngTelNo": teleNo      //담당자전화번호
			, "creatPgm"  : "SM3002P01"
		}
		commKaKaoSendTodo(param);

		//공유
		let param2 = {
			"tmplatDiv": "TMPLATDIV02"
			// , "coCd": $("#popFormApproval #coCd").val()            //해당 결재 담당자의 소속 (오류때문에 주석)
			, "todoDiv1CodeId": "TODODIV10"               //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV1170"               //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "공유"                  //공통코드 해당업무 - 결재 - 발주서
			, "title": todoTitleStr
			, "sanctnDiv2": "공유"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo": $("#popFormApproval #fileTrgtKey").val()
			, "clntCd": "1"               //발신회사는 로그인사용자 회사
			, "clntNm": clntNm            //로그의 수신거래처명
			, "ordrgMngNm": jwt.userNm         //작성자(담당자)
			, "ordrgMngTelNo": teleNo      //담당자전화번호
			, "creatPgm"  : "SM3002P01"
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
			kakaoCnt = 0;
			// alert("알림톡이 정상 발송되었습니다.");
		}
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
		// console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);
		//알림톡수신번호 채번
		var maxMessageId = null;         //message id(unique key)
		var talkMessage = null             //발송될 내용 template
		var mobile = null               //수신인 휴대전화번호
		var title = null               //todo title
		var todoDiv2CodeNm = null               //todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null, function(data) {
			if(data.resultList.length > 0 ) {
				if( data.resultList[0].maxMessageId != "" ) {
					sendList = data.resultList;
				} else {
					alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
					return;
				}
			}
		});
		//user search ajax end
		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			//로그용
			param.rcvId = sendObj.todoId;         //todo 수신id
			param.rcvNm = sendObj.name;            //todo 수신자명
			param.nameTo = sendObj.name;            //todo 수신자명
			//title      = sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = '매입대금지불 결제 건';
			//param.title = title;                        //요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}

			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.title = param.title;               //알림톡 타이틀 -
			talkBody.message = message;            //알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;            //휴대전화번호
			talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end

		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}


	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
		// console.log('---gridNoset run ---');
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}

	//조치담당자 팀장 정보 가져오기
	function selectTeamManagerInfo(paramUserId) {
		//결자자 정보 가져오기//결자자 정보 가져오기 gridApproval2
		var appshaList = gridApproval2.target.list.map(function(item) {
							return {
								gb: item.gb,
								coCd: item.coCd,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email,
							};
						});


		var appArray = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
							return {
								gb: item.gb,
								coCd: item.coCd,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email
							};
						});
		var shaArray =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
							return {
								gb: item.gb,
								coCd: item.coCd,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email
							};
						});

		var formData = {
			"userId" : paramUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
									gb: "결재",
									usrNm: list.id,
									coCd: list.coCd,
									name: list.name,
									jik: list.levelNm,
									dtNm: list.deptNm,
									telNo: list.telNo,
									offTelNo: list.offTelNo,
									email: list.email,
									todoNo: $('#popFormApproval #fileTrgtKey').val(),
									sanctnSn: 0,
								});
				}

				gridApproval2.setData2(appArray.concat(shaArray));
			}
		});
	}


	// 결재자 정보 가져오기
	function selectTeamManagerApprovalAdd() {
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
		//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
		//------------------------------------------------
		let appshaList = gridApproval2.target.getList();

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		var tempActId = $("#popFormApproval #userId").val();	// 작성자 Id
		if (tempActId.slice(0,7) == 'gyrsult') return false; //실적관리용 ID는 결제 제외처리함.

		selectTeamManagerInfo(tempActId);

		$.each(appshaList, function(idx, item){
			if (!item.usrNm.includes('gyrsult')) {
				if (item.gb === "결재") {
					appArray.push(item);
	            } else {
	            	//공유일경우 작성자가 공유에 있으면 제외처리함.
	            	if (item.usrNm != tempActId) {
	            		shaArray.push(item);
	            	}
	            }
			}
		});
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------

		appArray = approvalTeamManagerSpecialInfoData('EMJ8105', appArray);	// 부사장님
		appArray = approvalTeamManagerInfoData(tempActId, appArray);		// 작성자 팀장
		appArray = approvalUserInfoData(tempActId, appArray);				// 작성자
	
		gridApproval2.setData2(appArray.concat(shaArray));
	}

	//담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								coCd: list.coCd,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

	// 작성자 정보 가져오기
	function approvalUserInfoData (appUserId, appArray) {
		var formData = {
			"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
			if (data.resultList != '' && data.resultList!=null) {
				//조치결과 결자자 정보 가져오기
				let list = data.resultList[0];
				if (appArray.some(item => item.usrNm === list.usrNm)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",	
								usrNm: list.usrNm,
								coCd: list.coCd,
								name: list.name,
								jik: list.jik,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,
							});
				}
			}
		});
		return appArray;
	}


	//특정담당자 정보 가져오기
	function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								coCd: list.coCd,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

	function executeCallback() {
		//마지막에 모달 콜백가능한지 점검
		const modal = modalStack.last();
	    if (modal && typeof modal.callback === 'function') {
	        modal.callback("200");
	    } 
		modalStack.close();
	}

	// 턴키제외일때 해당 컬럼 숨김
	function gridApproval1_columns_hide() {
		const keysToHide = [
			"custNm",           // 고객사CD
			"ctrtApprovalNo",   // 품의번호
			"clntPjtNm",        // PJTCD
			"ordrsNo",          // 수주번호
			"ctrtNo"            // 계약번호
		];

		// 컬럼 숨김
		const cols = gridApproval1.target.config.columns;
		cols.forEach(col => {
			if (keysToHide.includes(col.key)) {
				col.hidden = true;
			}
		});

		// footSum 부분 다시 설정
		gridApproval1.target.setConfig({
			columns: cols,
			footSum: [
				[
					{ label: "합계", colspan: 3, align: "center" },
					{ key: "pchsAmt", collector: "sum", formatter:"money", align:"center" },
					{ key: "pchsVat", collector: "sum", formatter:"money", align:"center" },
					{ key: "pchsTot", collector: "sum", formatter:"money", align:"center" },
					{ key: "billTot", collector: "sum", formatter:"money", align:"center" }
				]
			]
		});
	}

	// 보류 컬럼의 체크가 하나라도 변경되면 부사장님(EMJ8105)에게만 '결재승인' 버튼을 보이게 하는 함수
	function toggleApprovalButtonByHold() {
		// 부사장님이 아니면 무시
		if (jwt.userId !== 'EMJ8105') return false;

		// 보류 한 번도 안 바뀌었으면 무시
		if (!holdChanged) return false;

		// 결재자가 처음 결재승인 버튼 중복 생성 금지
		if ($('.callApprovalWorking').length > 0) return false;

		if ($('.actionBtn3').length > 0) return false;

		// 버튼 생성
		const btnHtml = `
			<button class="actionBtn3"
					onclick="updateApprovalHold()">
			결재승인
			</button>
		`;
		$('.popup_bottom_btn').append(btnHtml);
	}

	// 결재자 추가
	function updateShareUser() {
		var formData = makeFormData();
		if (formData) {
			filePostAjax("/user/sm/sm30/updateShareUser", formData, function(data) {
				if (data.resultCode == 200) {
					alert("결재자 수정이 완료되었습니다.")
					executeCallback();
				}
			});
		}
	}

	// 결재자 추가 및 삭제 버튼 해당 공유 및 결재자에 추가된 인원만 보이게끔
	function togglePlusMinusButtons() {
		// gridApproval2의 현재 리스트를 가져와서
		const list = gridApproval2.target.getList();
		// 내 todoId가 있으면 true
		const hasMe = list.some(item => item.todoId === jwt.userId);
		// 버튼 보이기/숨기기
		if (hasMe) {
			$('#plus-minus').show();
		} else {
			$('#plus-minus').hide();
		}
	}

</script>