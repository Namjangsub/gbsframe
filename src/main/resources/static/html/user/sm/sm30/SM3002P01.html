<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
		<h4 class="tit">[aaaaaaaa] [bbbbbbbbbbbb] 매입대금 지급 결재요청</h4>
    </div>
	<div class="form-group popup_table">
	<form id="popForm" onSubmit="return false;" method="post" enctype="multipart/form-data">
		<input type="hidden" id="userId" name="userId">
		<input type="hidden" id="fileTrgtTyp" name="fileTrgtTyp" value="SM3002P01">
		<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
		<input type="hidden" id="pgmId" name="pgmId" value="SM3002P01">

		<table>
			<colgroup>
				<col width="10%">
				<col width="15%">
				<col width="10%">
				<col width="15%">
				<col width="10%">
				<col width="15%">
				<col width="10%">
				<col width="15%">
			</colgroup>
			<!-- 1행 -->
			<tr>
				<th>회사</th>
				<td>
					<select data-search="coCd" id="coCd" name="coCd" class="modal-coCd" style="width: 100%;" data-kind="CO" msg="회사">
					</select>
				</td>

				<th>지급년월</th>
				<td>
					<input type="text" class="input_calendar" autocomplete="off" onkeyup="dateMask(this);" id="closeYm" name="closeYm" date class="form-control" required>
				</td>

				<th>결제일자</th>
				<td>
					<select id="pchsClmnDay" name="pchsClmnDay" data-search="pchsClmnDay">
						<option value="" selected>전체</option>
						<option value="10">10</option>
						<option value="25">25</option>
					</select>
				</td>

				<th>발행여부</th>
				<td>
					<select id="billYn" name="billYn" data-search="billYn" msg="발행여부">
						<option value="" selected="selected">전체</option>
						<option value="Y">발행</option>
						<option value="N">미발행</option>
					</select>
				</td>
			</tr>
			<!-- 2행 -->
			<tr>
				<th>구매처</th>
				<td>
					<input type="hidden" id="clntCd" name="clntCd" data-search="clntCd">
					<div class="search_form">
						<input type="text" id="clntNm" name="clntNm"  data-search="clntNm" onkeyup="event.keyCode == 8 ? clntCd_S.value = '' : event.keyCode == 13 ? clntSearch() : ''">
						<a onclick="clntSearch('S');"><i class="i_search_w"></i></a>
					</div>
				</td>
				<th>부서명</th>
				<td>
					<select id="deptId" name="deptId" data-search="deptId">
						<option value="" selected>전체</option>
						<option value="TRN50">트루넷구매팀</option>
						<option value="TRN30">트루넷직접매출</option>
					</select>
				</td>

				<th>턴키제외</th>
				<td>
					<select id="trunDiv" name="trunDiv" data-search="trunDiv">
						<option value="">전체</option>
						<option value="PCHSCOSTDIV1030" selected>턴키자료만</option>
						<option value="PCHSCOSTDIV" selected>턴키제외</option>
					</select>
				</td>

				<th>청구/영수</th>
				<td>
					<select id="payDiv" name="payDiv" class="form-control" data-kind="PAYDIV" msg="청구/영수구분">
						<!-- <option value="">선택</option> -->
					</select>
				</td>
			</tr>
		</table>

		<div class="contents" style="height: 430px; clear: both; margin-bottom: 20px;">
			<table style="border:0px; width:100%;">
				<tr style="height:30px;">
					<td style="text-align: LEFT; border-right: 0; font-size:13px; font-weight:bold;">
						※ 대금 지급 대상 리스트
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div class="ax5_grid"
							data-ax5grid="first-grid-modal"
							data-ax5grid-config="{}"
							style="height: 400px; width: 100%; clear: both;">
						</div>
					</td>
				</tr>
			</table>
		</div>

		<!-- 두 번째 그리드(공유 및 결재) -->
		<div class="contents"
			style="height: 200px; clear: both; margin-bottom: 20px;">
			<table style="border:0px; width:100%;">
				<tr style="height:30px;">
					<td style="text-align: LEFT; border-right: 0; font-size:13px; font-weight:bold;">
						※ 공유 및 결재
					</td>
					<td>
						<div class="add_btn_small pdl10" id="plus-minus">
							<a onclick="insertShareUserModal1();" style="height: 30px; line-height: 28px;" authchk>＋</a>
							<a onclick="deleteShareUser1();"   style="height: 30px; line-height: 28px;" authchk>－</a>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div class="ax5_grid"
							data-ax5grid="second-grid-modal"
							data-ax5grid-config="{}"
							style="height: 150px; width: 100%; clear: both;">
						</div>
					</td>
				</tr>
			</table>
		</div>
	</form>
	<!-- 공통 파일 영역-->
	<div id="fileList_area"></div>
	</div>

	

	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn" style="margin-bottom:20px;">
		<button type="button" id="actionBtn1" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" id="actionBtn2" authChk>삭제</button>
	</div>
</div>

<script type="text/javascript">
	var fileTrgtKey = null;
	var actionType = null;
	
	var coCd = null;
	var closeYm = null;
	var pchsClmnDay = null;
	var billYn = null;
	var trunDiv = null;
	var deptId = null;
	var payDiv = null;

	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];

	var deleteFileArr = [];

	ax5.ui.grid.formatter["bilgYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E") {
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};

	var gridViewPop1 = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
				showLineNumber: false,
				lineNumberColumnWidth: 40,
				multipleSelect: true,
				sortable: false,
				target: $('[data-ax5grid="first-grid-modal"]'),
				header: {
						align: "center",
						selector: true
				},
				body: {
					columnHeight: 23,
					mergeCells : ["custId"],//editor 는 merge 안됨
				},

				footSum: [
					[
						{label: "합계", colspan:5, align:"senter"},
						{key: "pchsAmt", collector: "sum", formatter:"money", align: "center"},
						{key: "pchsVat", collector: "sum", formatter:"money", align: "center"},
						{key: "pchsTot", collector: "sum", formatter:"money", align: "center"},
						{key: "billTot", collector: "sum", formatter:"money", align: "center"},
					]
				],
				columns : [
					{key: "deleteBtn",		label: "삭제", width: 60, align: "center", hidden: true,
						formatter: function() {return '<button type="button" '+   'onclick="delete_sm30_select_list('+ this.dindex + ',' + this.item.seq + ')" '+   'style="margin-left:3px; height:18px;padding:0" authchk>삭제</button>';}
					},
					{key: "fileTrgtKey",	label: "파일대상KEY",		width: 50,	align: "center",  hidden: true},
					{key: "seq",			label: "순번",				width: 50,	align: "center",  hidden: false},
					{key: "coCd",			label: "회사",				width: 50,	align: "left", hidden: true},
					{key: "custId",			label: "고객사CD", 			width: 180, align: "left", hidden: true},
					{key: "custNm",			label: "고객사",			width: 180,	align: "left"},
					{key: "clntPjt",		label: "PJTCD",				width: 80,	align: "left", hidden: true},
					{key: "clntPjtNm",		label: "PJT",				width: 80,	align: "left"},
					{key: "ordrsNo",		label: "수주번호",			width: 70,	align: "center"},
					{key: "ctrtNo",			label: "계약번호",			width: 120,align: "center"},
					{key: "clntCd",			label: "구매처CD",			width: 180,align: "left", hidden: true},
					{key: "clntNm",			label: "구매처명",			width: 180,align: "left"},
					{key: undefined, 		label: "매입확정" , columns : [
						{key: "pchsAmt", 		label: "확정금액", 		width: 110,	align: "right", formatter: "money"},
						{key: "pchsVat", 		label: "부가세",		width: 110,	align: "right", formatter: "money"},
						{key: "pchsTot", 		label: "확정 합계", 	width: 110,	align: "right", formatter: "money"},
					]},
					{key: undefined, 		label: "세금계산서 발행 완료" , columns : [
						{key: "billTot", 		label: "발행 합계", 	width: 110,	align: "right", formatter: "money"},
						{key: "billNo", 		label: "계산서번호", 	width: 110,	align: "center"},
						{key: "billDt",		 	label: "발행일자", 		width: 110,	align: "center"},
					]},
					{key: undefined, 		label: "결재요청" , columns : [
						{key: "aprReqSts", 		label: "상태", 			width: 80,	align: "center", formatter: "bilgYn"},
						{key: "aprovalDt", 		label: "요청일", 		width: 80,	align: "center"},
						{key: "aprovalNm", 		label: "요청자", 		width: 80,	align: "center"},
					]},

				],
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			var paramObj = {
				"fileTrgtKey" : $("#fileTrgtKey").val(),
				"coCd"		  : $("#coCd").val()
			}
			postAjax("/user/sm/sm30/sm30_pop_grid1_selectList", paramObj, null, function(data) {
				try {
					let list = data.result;
					if (list.length > 0 ) {
						targetObj.setData({
							list : list,
							page : {
								totalElements : list.length,
							}
						});
					}
				} catch  (error){
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		}
	}

	//공유 결재 그리드
	var gridViewPop2 = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="second-grid-modal"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function () {
						this.self.select(this.dindex);
					},
					onDBLClick: function () {
					},
					mergeCells : ["gb"],
				},
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView2.setData(this.page.selectPage);
					}
				},
				columns : [
					{key: "gb",      			label: "구분",      	align: "center",   width: 40},
					{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 50},
					{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
					{key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
					//{key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: false},
					{key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
					{key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
					{key: "name",       		label: "성명",      	align: "center",   width: 80},
					{key: "jik",       			label: "직위",      	align: "center",   width: 60},
					{key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 90},
					{key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 130},
					{key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: 200},
					{key: "telNo",      		label: "H.P",		align: "center",   width: 130},
					{key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
					{key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},
					{key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
					{key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
					]
					});
					return this;
				},

				setData : function(_pageNo) {
					var targetObj = this.target;
					var formData = {
						"fileTrgtKey" : $("#fileTrgtKey").val(),
						"reqNo" : $("#fileTrgtKey").val(),
						"pageNo" : _pageNo + 1
					}
					postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
						try {
							var list = data.result;
							if( list.length > 0 ) {
								var inCnt = 0;
								var inGb = 0; //해당 결재개수 변수
								let processChk = false;	//결재 진행여부 체크 (결재가 하나라도  진행되면 true)
								list.forEach(elem => {
									if (elem.gb === "결재") {  // 결재와 공유 중 결재 갯수 파악
										if (elem.todoId !== jwt.userId) {	//결재자가 동일하면 제외
											//상태가 'Y'인 경우
											if (elem.sanctnSttus === "Y") {
												processChk = true;
												inCnt++;
											}

											inGb++;
										}
									}
								});
								// 작성자랑 결재자 같은지 check
								postAjax("/user/sm/sm30/selectApprovalUserChk", formData, null, function(res) {
									var list = res.result;
									var myId = $("#userId").val();

									// 나 빼고(Y) 가 있는지
									var othersHaveY = list.some(item =>
										item.todoId !== myId && item.sanctnSttus === 'Y'
									);
									// 나만(Y) 인지
									var meHasY = list.some(item =>
										item.todoId === myId && item.sanctnSttus === 'Y'
									);

									// 하단 삭제 버튼
									if (meHasY && !othersHaveY && ((actionType != "S") && actionType !="T")) {
										$("#actionBtn2").show();
									} else {
										$("#actionBtn2").hide();
									}

									// 그리드 deleteBtn 컬럼
									var cfg = gridViewPop1.target.config;
									cfg.columns.forEach(function(col) {
										if (col.key === 'deleteBtn' && ((actionType != "S") && actionType !="T")) {
										// 다른 사람 승인 중일 때만 숨기기
										col.hidden = othersHaveY;
										}
									});
									gridViewPop1.target.setConfig(cfg);
									gridViewPop1.target.repaint();
								});
							}
							targetObj.setData({
								list : list,
								page : {
									totalElements : list.length
								}
							});
							// 모든 sanctnSttus 가 'Y' 인지 검사
							var allY = list.length > 0 && list.every(function(row){
								return row.sanctnSttus === 'Y';
							});

							// gridViewPop1 그리드의 aprReqSts 칼럼을 Y/N 으로 세팅
							var mainList = gridViewPop1.target.list;
							mainList.forEach(function(item, idx){
								gridViewPop1.target.setValue(idx, 'aprReqSts', allY ? 'Y' : 'N');
							});

							// gridViewPop1 그리드 다시 그림
							gridViewPop1.target.repaint();

						} catch {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					});
				},

				setData2 : function(_list) {
					this.target.setData({
								list : _list,
								page : {
										totalElements :  _list.length,
							}
							});
				}
				,
				setData3 : function(_pageNo) {
					var targetObj = this.target;
					var paramObj = { "userId": jwt.userId
								, "appDiv": 'APPDIV09'		//수주원가관리 결재라인
					};
					postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : { totalElements : list.length }
							});
						} catch {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					
					});
				}
	}
	
	$(document).ready(function() {
		setComboOptions($(".popup_area select[data-kind]"));
		const param = modalStack.last().paramObj;
		actionType = param.actionType;

		$('#popForm').find('input:not([type="hidden"]), textarea').prop('readonly', true).css({'background-color': '#e9ecef','pointer-events': 'none'});
		$('#popForm').find('select').css({'background-color': '#e9ecef','pointer-events': 'none'});
		
		$('#clntNm').off('keyup').css('pointer-events', 'none');
		$('.search_form a').removeAttr('onclick').off('click').css('pointer-events', 'none');

		// 지급년월
		$('#closeYm').datepicker({
			format : "yyyy-mm",
			language : "ko",
			autoclose : true,
			minViewMode: "months"
		}).datepicker("setDate", new Date());

		gridViewPop1.initView();
		gridViewPop2.initView();

		if (actionType == "C") {
			$("#coCd").val(param.coCd);
			$("#closeYm").val(param.closeYm);
			$("#pchsClmnDay").val(param.pchsClmnDay);
			$("#billYn").val(param.billYn);
			$("#payDiv").val(param.payDiv);
			const gridData = param.row;

			$('.tit').text(param.closeYm + "월 " + param.deptNm +" 매입대금 지급 결재 요청");	// 제목처리
			$.each(param, function (key, val) {
				if( $("#popForm").find("#" + key).length > 0 ) {
					$("#popForm").find("#" + key).val(val);
				}
				if (key === "closeYm") {
					$('#popForm #' + key).datepicker("update");
				}
			});

			gridViewPop1.target.setData({
				list : gridData,
				page : { totalElements: gridData.length}
			})
			$("#actionBtn2").hide();
			$("#actionBtn1").text("등록");
			$('#actionBtn1').on("click", function() {
				insert_sm30();
			});
		} else if (actionType == "U" || actionType == "S" || actionType == "T") {
			$('#closeYm').off('click focus');
			fileTrgtKey = param.fileTrgtKey;
			coCd = param.coCd;
			select_sm30_info()
			$("#actionBtn1").hide();
			$("#actionBtn2").hide();

			if (actionType == "U") {
				
				$('#actionBtn2').on("click", function() {
					delete_all_sm30_info();
				});
			} else {
				$("#plus-minus").hide();
			}
		} else {
			alert("오류 발생! 전산실에 연락바랍니다.")
		}

		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey		: fileTrgtKey
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		authChk();// 권한체크

	});

	function select_sm30_info() {
		var formData = {
			"fileTrgtKey": fileTrgtKey, // fileTrgtKey가 제대로 설정되어 있는지 확인
			"coCd"  : coCd
		}
		postAjaxSync("/user/sm/sm30/select_sm30_info", formData, null, function(data) {
			// 응답 데이터를 폼에 채워 넣음
			$.each(data.result, function(key, value) {
				if (key === "payYymm") {
					var formatted = value.substr(0,4) + "-" + value.substr(4,2);
					$("#closeYm").val(formatted).datepicker("update", new Date(value.substr(0,4), parseInt(value.substr(4,2),10)-1));
					return; // 다음 key 로
				}
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					
					// 숫자 관련 필드일 경우 comma 처리를 하는 부분
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
				if (key === "creatId") {
					$("#userId").val(value)
				}
			});
			gridViewPop1.setData();
			gridViewPop2.setData();
			$('.tit').text($("#closeYm").val() + "월 " + $("#deptId option:selected").text()  +" 매입대금 지급 결재 조회");

		});
	}

	function makeFormData() {
		if (!inputValidation($('.popup_area [required]'))) {
			return false;
		}

		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});

		selectTeamManagerApprovalAdd();		// 결재라인 자동 생성

		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);


		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , '');         //첨부화일용
		formData.append("prdtCd" , '');         //첨부화일용
		formData.append("itemCd" , '');         //첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());      //첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());   //첨부화일용

		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();

		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
					formData.append("files", obj.file);
					obj.file = '';
					fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		var detailArr = gridViewPop1.target.list;
		formData.append("detailArr", JSON.stringify(detailArr));

		// title 지정 코드
		var uniqueClntNms = Array.from(new Set(detailArr.map(item => item.clntNm))); 
		var clntNmString = uniqueClntNms.join(', ');
		var todoTitleStr = "[대금지불] " + clntNmString + " "+ $("#closeYm").val().slice(0, 4) + "년 " + $("#closeYm").val().slice(-2)+ "월"+ " 대금지불 요청건";


		// 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가
		// 공유 : TODODIV10, TODODIV1170  결재 :TODODIV20, TODODIV2170

		/*	결재그리드 insert make start */

		//결재그리드
		var rowSharngList = gridViewPop2.target.list;
		var ParamObj = modalStack.last().paramObj;

		if(rowSharngList.length > 0) {
			var rowSharngListArr = []; //공유정보
			var rowApprovalListArr = []; //결재정보

			$.each(rowSharngList, function(idx, elem) {
				var rowSharngListObj = elem;
				var rowApprovalListObj = elem;

				if (elem.gb == '공유') {
					rowSharngListObj["gb"] = elem.gb;
					rowSharngListObj["coCd"] = $('#coCd').val();
					//rowSharngListObj["salesCd"] = $('#salesCd').val();
					rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
					rowSharngListObj["todoDiv2CodeId"] = "TODODIV1170";
					rowSharngListObj["todoId"] = elem.usrNm;
					rowSharngListObj["todoCoCd"] = elem.coCd;
					rowSharngListObj["empNo"] = elem.empNo;
					rowSharngListObj["name"] = elem.name;
					rowSharngListObj["telNo"] = elem.telNo;
					rowSharngListObj["email"] = elem.eMail;
					rowSharngListObj["pgPath"] = "/user/sm/sm30/SM3002P01.html";
					//TITLE 추가
					rowSharngListObj['todoTitle'] = todoTitleStr + ' 공유';
					rowSharngListArr.push(rowSharngListObj);
				} else if (elem.gb == '결재') {
					rowApprovalListObj["gb"] = elem.gb;
					rowApprovalListObj["coCd"] = $('#coCd').val();
					//rowApprovalListObj["salesCd"] = $('#salesCd').val();
					rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
					rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2170";
					rowApprovalListObj["todoId"] = elem.usrNm;
					rowApprovalListObj["todoCoCd"] = elem.coCd;
					rowApprovalListObj["empNo"] = elem.empNo;
					rowApprovalListObj["name"] = elem.name;
					rowApprovalListObj["telNo"] = elem.telNo;
					rowApprovalListObj["email"] = elem.eMail;
					rowApprovalListObj["pgPath"] = "/user/sm/sm30/SM3002P01.html";
					//TITLE 추가
					rowApprovalListObj['todoTitle'] = todoTitleStr + ' 결재';
					rowApprovalListArr.push(rowApprovalListObj);
				}
			});
			formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
			formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
		}
		formData.append("S_todoDiv1CodeId", "TODODIV10");
		formData.append("S_todoDiv2CodeId", "TODODIV1170");

		return formData;
	}


	// 등록
	function insert_sm30() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			if (formData) {
				filePostAjax("/user/sm/sm30/insert_sm30", formData, function(data) {
					if (data.resultCode == 200) {
						alert("등록되었습니다.")
						$("#fileTrgtKey").val(data.fileTrgtKey);
						kakaoTodo();				//kakaoTodo() 호출
						modalStack.close();
					}
				});
			}
		}
	}

	// 전체 삭제
	function delete_all_sm30_info() {
		var rows = gridViewPop1.target.getList();
		if (actionType == 'C') {
			alert("잘못된 접근 입니다. 전산실에 연락바랍니다.")
			return;
		}
		var formData = {
			"fileTrgtKey" 	: $("#fileTrgtKey").val(),
			"reqNo" 		: $("#fileTrgtKey").val(),
			"salesCd" 		: $("#fileTrgtKey").val(),
			"coCd"			: $("#coCd").val(),
			"userId"		: $("#userId").val(),
			"fileTrgtTyp"  	: $('#pgmId').val(),
		}

		if (confirm("매입대금 지급 결재 요청을 삭제하시겠습니까?")) {
			postAjaxSync("/user/sm/sm30/selectApprovalUserChk", formData, null, function(res) {
				var list = res.result; 
					// (this.userId) 제외, 누군가 Y 이면 삭제 금지
					var othersApproved = list.some(function(item) {
					return item.todoId !== formData.userId && item.sanctnSttus === 'Y';
				});
				if (othersApproved) {
					alert("결재 진행중인 자료는 삭제할 수 없습니다.\n\n결재 진행 상태 확인 바랍니다.");
					return;
				}
				else { //안되었으면 삭제 진행[TB_WB20M03] 테이블도 삭제 처리
					putAjax("/user/sm/sm30/delete_all_sm30_info", formData, null, function(data) {
						if (data.resultCode == 200) {
							// 상세 리스트 삭제
							formData ["rows"] = rows
							putAjax("/user/sm/sm30/delete_sm30_list", formData, null, function(data) {
								alert("삭제되었습니다.");
								modalStack.close();
							});
						}
					});
				}
			});
		}
	}

	// 리스트 건별 삭제
	function delete_sm30_select_list(rowIndex, seq) {

		var formData = {
			"fileTrgtKey" 	: $("#fileTrgtKey").val(),
			rows: [{ seq: seq }]
		}
		putAjax("/user/sm/sm30/delete_sm30_list", formData, null, function(data) {
			if (data && data.result && data.result.length > 0) {
				// 그리드에서 해당 인덱스 지우기
				gridViewPop1.target.removeRow(rowIndex);
				alert("삭제되었습니다.");
			} else {
				alert("삭제에 실패했습니다.");
			}
		});
	}



	// 업체명 검색
	function clntSearch() {
		var paramObj = {
				"searchValue" :  $("#vendNm").val()
				, "clntDivCd" : ""		/*거래처 검색 기본값 고객사로 세팅 */
				, "pchsClntCd" : "CLNTDIV12"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
		}	
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", paramObj, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#vendCd').val(row.clntCd);
					$('#vendNm').val(row.clntNm);
					$('#pchsPmntMtdCd').val(row.pchsPmntMtdCd);
					$('#ctrClmnDivCd').val(row.pchsClmnDivCd);
					$('#ctrClmnVat').val(row.pchsVatCd);
					$('#pchsClmnDay').val(row.pchsClmnDay);
	                var paramObj = {
	                    "userId": $('#mngId').val(),
	                    "clntCd": row.clntCd
	                }
	                setMngInfo(paramObj);
					
				//백엔드에서 해당 거래처의 문제현황을 검색해오기
				//메세지 뿌리기
				toastMsg('O', row.clntCd, [{oemDivTxt:"가공품"}]);	// (O:외주업무구분, row.clntCd:공급사코드, list:자재리스트)
		});
	}

	// 공유대상자 추가//
	function insertShareUserModal1() {

	if( approvalYn() ) {
		alert("결재가 이미 진행중입니다.");
		return;
	}

	var paramObj = {};
	var appshaList = gridViewPop2.target.list;
	paramObj["coCd"] = $('#coCd').val();
	paramObj["useYn"] =  "Y";
	// paramObj["userId"] =  $('#ordrgId').val();
	// paramObj["userNm"] =  $('#ordrgNm').val();
	paramObj["userId"] =  jwt.userId;
	paramObj["userNm"] =  jwt.userNm;
	paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
			}).map(function(item) {
					return {
						gb: "결재",
						id: item.usrNm,
						text: item.name,
						parent: item.jik,
						deptNm: item.dtNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id
						, todoKey: item.todoKey
						, sanctnSn: item.sanctnSn
						, sanctnSttus: item.sanctnSttus
						, todoCfDt: item.todoCfDt
						, todoCfOpn: item.todoCfOpn
						, flag: item.flag
					};
			});
	paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
			}).map(function(item) {
					return {
						gb: "공유",
						id: item.usrNm,
						text: item.name,
						parent: item.jik,
						deptNm: item.dtNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id
						, todoKey: item.todoKey
						, sanctnSn: item.sanctnSn
						, sanctnSttus: item.sanctnSttus
						, todoCfDt: item.todoCfDt
						, todoCfOpn: item.todoCfOpn
						, flag: item.flag
					};
			});

	openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
		// console.log('결재라인 : ', approvalGrid.target.list);
		// console.log('공유라인 : ', shareGrid.target.list);

		var appArray = approvalGrid.target.list.map(function(item) {
			return {
					gb: "결재",
					usrNm: item.id,
					name: item.text,
					jik: item.parent,
					dtNm: item.deptNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
					todoId: item.id
					, todoKey: item.todoKey
					, sanctnSn: item.sanctnSn
					, sanctnSttus: item.sanctnSttus
					, todoCfDt: item.todoCfDt
					, todoCfOpn: item.todoCfOpn
					, flag: item.flag
				};
		});
		var shaArray = shareGrid.target.list.map(function(item) {
			return {
						gb: "공유",
					usrNm: item.id,
					name: item.text,
					jik: item.parent,
					dtNm: item.deptNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
					todoId: item.id
					, todoKey: item.todoKey
					, sanctnSn: item.sanctnSn
					, sanctnSttus: item.sanctnSttus
					, todoCfDt: item.todoCfDt
					, todoCfOpn: item.todoCfOpn
					, flag: item.flag
				};
		});
		gridViewPop2.setData2(appArray.concat(shaArray));

	});

	}

	//결재 여부
	function approvalYn() {
		var gridList = gridViewPop2.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
				var msgArr = [];
				$.each(gridList, function (idx, elem) {
				//결재자가 본인이 아니면서 상태가 Y인 경우
				if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
				})
		}
		return inCnt;
	}

	function deleteShareUser1(){
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

		var selRow = parseInt(gridViewPop2.target.selectedDataIndexs);
		if( isNaN(selRow) ) {
			alert("선택된 행이 없습니다.");
			return;
		} else {
			if( selRow > -1 ) {
				var todoKey = gridViewPop2.target.getList()[selRow].todoKey;
				var gridList = gridViewPop2.target.getList("selected")[0];
				if( typeof(todoKey) == "undefined" ) {
					gridViewPop2.target.removeRow(selRow);
					$.gridNoSet(gridViewPop2, "sanctnSn");
				} else {
					var paramObj = {
						todoNo: $("#popForm #fileTrgtKey").val(),
						todoKey: gridList.todoKey,
						sanctnSn: gridList.sanctnSn,
						todoDiv1CodeId: gridList.todoDiv1CodeId,
						todoDiv2CodeId: gridList.todoDiv2CodeId
					}
					deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
						if (data.resultCode == 200) {
							alert(data.resultMessage);
							gridViewPop2.setData(0);
						} else {
							alert("삭제중 오류가 발생했습니다");
						}
					});

				}
			}
		}
	}
	/*
	#   TODO 알림톡발송 시작
	#
	*/
	// $("#approvalReqTodoBtn").on("click", function () {
	//    kakaoTodo();
	// });

	function kakaoTodo() {
		//message load
		if (kakaoErr.length == 0) {
			var paramObj = {
				"codeId" : jwt.userId,
				"codeKind" : "KAKAOMSG"
			};
			postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
				if(data.resultList.length > 0 ) {
					kakaoErr = data.resultList;
				}
			});
		}

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
		var paramObj1 = {
			"coCd" : $("#coCd").val(),
			"userId" : jwt.userId
		};
		postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data) {
			if (data.result[0] == undefined || data.result[0].telNo == "") {
				teleNo = "051-312-2400";
			} else {
				teleNo = data.result[0].telNo;
			}
		});

		// // 2024.05.16 김성욱 추가 수정 대분류 알림메세지에 추가
		// var paramObj2 = {
		// 	"ordrsNo" : $("#ordrsNo").val(),
		// 	"histNo" : $("#histNo").val()
		// };
		// postAjaxSync("/user/cr/cr02/selectOrderChangeTitle", paramObj2, null, function(data) {
		// 	if (data.result[0] == undefined || data.result[0].chgNm == "") {
		// 		chgNm = "수주관리";
		// 	} else {
		// 		chgNm = "수주관리 " + data.result[0].chgNm;
		// 	}
		// });
		// // 2024.05.16 김성욱 추가 수정 대분류 알림메세지에 추가 끝
		//---------------------------------------
		let param = {
			"tmplatDiv": "TMPLATDIV02"
			, "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
			, "todoDiv1CodeId": "TODODIV20"               //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV2170"               //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "결재"                  //공통코드 해당업무 - 결재 - 발주서
			//, "todoDiv2CodeNm": "발주 및 출장 요청"                  //공통코드 해당업무 - 결재 - 발주서
			, "title": "매입대금 지급"
			//[대금지불]흥진유압 2025년3월 대금지불 요청건
			, "sanctnDiv2": "결재"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			// , "histNo": $("#popForm #histNo").val()   //수주차수
			, "todoNo": $("#fileTrgtKey").val()
			, "clntCd": "1"               //발신회사는 로그인사용자 회사
			, "clntNm": clntNm            //로그의 수신거래처명
			, "ordrgMngNm": jwt.userNm         //작성자(담당자)
			, "ordrgMngTelNo": teleNo      //담당자전화번호
			, "creatPgm"  : "SM3002P01"
		}
		commKaKaoSendTodo(param);

		//공유
		let param2 = {
			"tmplatDiv": "TMPLATDIV02"
			, "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
			, "todoDiv1CodeId": "TODODIV10"               //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV1170"               //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "공유"                  //공통코드 해당업무 - 결재 - 발주서
			, "title": "매입대금 지급"
			, "sanctnDiv2": "공유"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			// , "histNo": $("#popForm #histNo").val()   //수주차수
			, "todoNo": $("#fileTrgtKey").val()
			, "clntCd": "1"               //발신회사는 로그인사용자 회사
			, "clntNm": clntNm            //로그의 수신거래처명
			, "ordrgMngNm": jwt.userNm         //작성자(담당자)
			, "ordrgMngTelNo": teleNo      //담당자전화번호
			, "creatPgm"  : "SM3002P01"
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
			kakaoCnt = 0;
			// alert("알림톡이 정상 발송되었습니다.");
		}
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
		// console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);
		//알림톡수신번호 채번
		var maxMessageId = null;         //message id(unique key)
		var talkMessage = null             //발송될 내용 template
		var mobile = null               //수신인 휴대전화번호
		var title = null               //todo title
		var todoDiv2CodeNm = null               //todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null, function(data) {
			if(data.resultList.length > 0 ) {
				if( data.resultList[0].maxMessageId != "" ) {
					sendList = data.resultList;
				} else {
					alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
					return;
				}
			}
		});
		//user search ajax end

		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			//로그용
			param.rcvId = sendObj.todoId;         //todo 수신id
			param.rcvNm = sendObj.name;            //todo 수신자명
			param.nameTo = sendObj.name;            //todo 수신자명
			//title      = sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = todoDiv2CodeNm;
			//param.title = title;                        //요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}

			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.title = param.title;               //알림톡 타이틀 -
			talkBody.message = message;            //알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;            //휴대전화번호
			talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			// sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end

		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}


	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
		// console.log('---gridNoset run ---');
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}

	//조치담당자 팀장 정보 가져오기
	function selectTeamManagerInfo(paramUserId) {
		//결자자 정보 가져오기//결자자 정보 가져오기 gridViewPop2
		var appshaList = gridViewPop2.target.list.map(function(item) {
							return {
								gb: item.gb,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email,
							};
						});


		var appArray = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
							return {
								gb: item.gb,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email
							};
						});
		var shaArray =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
							return {
								gb: item.gb,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email
							};
						});

		var formData = {
			"userId" : paramUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
									gb: "결재",
									usrNm: list.id,
									name: list.name,
									jik: list.levelNm,
									dtNm: list.deptNm,
									telNo: list.telNo,
									offTelNo: list.offTelNo,
									email: list.email,
									todoNo: $('#rsltNo').val(),
									sanctnSn: 0,
								});
				}

				gridViewPop2.setData2(appArray.concat(shaArray));
			}
		});
	}


	// 결재자 정보 가져오기
	function selectTeamManagerApprovalAdd() {
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
		//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
		//------------------------------------------------
		let appshaList = gridViewPop2.target.getList();

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		var tempActId = $("#userId").val();	// 작성자 Id
		if (tempActId.slice(0,7) == 'gyrsult') return false; //실적관리용 ID는 결제 제외처리함.

		selectTeamManagerInfo(tempActId);

		$.each(appshaList, function(idx, item){
			if (!item.usrNm.includes('gyrsult')) {
				if (item.gb === "결재") {
					appArray.push(item);
				}
			}
		});
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------

		appArray = approvalTeamManagerInfoData(tempActId, appArray);		// 작성자 팀장
		appArray = approvalUserInfoData(tempActId, appArray);				// 작성자
		appArray = approvalTeamManagerSpecialInfoData('EMJ8105', appArray);	// 부사장님
	
		gridViewPop2.setData2(appArray.concat(shaArray));
	}

	//담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

	// 작성자 정보 가져오기
	function approvalUserInfoData (appUserId, appArray) {
		var formData = {
			"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
			if (data.resultList != '' && data.resultList!=null) {
				//조치결과 결자자 정보 가져오기
				let list = data.resultList[0];
				if (appArray.some(item => item.usrNm === list.usrNm)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",	
								usrNm: list.usrNm,
								name: list.name,
								jik: list.jik,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,
							});
				}
			}
		});
		return appArray;
	}


	//특정담당자 정보 가져오기
	function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

</script>