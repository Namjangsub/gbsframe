<!-- 검색 조건 내 Sales Code, 관리번호, 차수 컨트롤 관련 팝업창 구현  -->
<!DOCTYPE html>
<html lang="ko">
<style>
/* 	.add_btn_small { */
/* 		display : inline-block; */
/* 		padding : 0px; */
/* 	} */
	
/* 	.add_btn_small a { */
/* 		display     : inline-block; */
/* 		width       : 33px; */
/* 		height      : 20px; */
/* 		line-height : 20px; */
/* 		text-align  : center; */
/* 		color       : #444; */
/* 		background  : #ffffff; */
/* 		box-shadow  : 1px 1px rgba(0, 0, 0, 0.15); */
/* 	} */
.contents_tit {
    display: flex;
    justify-content: space-between; /* 좌우 정렬 */
    align-items: center;
    height: 40px;
    padding: 5px 10px;
}

.right_controls {
    display: flex;
    align-items: center;
    gap: 10px; /* 버튼과 입력 사이 여백 */
}

.add_btn_small1 {
    display: flex;
    gap: 5px;
}

.table_list_tit1 {
    display: flex;
    align-items: center;
    gap: 5px;
}
.add_btn_small1 {display: inline-block;padding: 0px;}
.add_btn_small1 a {display: inline-block;width: 33px;height: 20px; line-height: 20px;text-align: center;color: #444;background: #ffffff;box-shadow: 1px 1px rgba(0, 0, 0, 0.15);}

</style>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5grid-inline-editor.js"></script>
	<script src="/static/js/ax5/ax5combobox.min.js"></script>
	<script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
	<script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>
	<!-- 도움말 팝업 -->
	<script src="/static/js/manualPopup.js"></script>
</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="DataSearch();"><button class="bg_gray">검 색</button></a>
				</li>
			</ul>
		</div>
		
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 4분할 -->
				<table class="table_input type05">
					<!-- 1행 -->
					<tr>
						<th class= "hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required="required" msg="회사">
							</select>
						</td>
						
						<th class="hit">지급년월</th>
						<td>
							<!-- 월 나타내는 달력 -->
							<input type="text" class="input_calendar" autocomplete="off" id="closeYm_S" onkeyup="dateMask(this);" name="closeYm_S" data-search="closeYm" date> 
							<!-- 일자를 조회하기 위해 사용 -->
							<div class="date_input">
								<input type="hidden" id="pchsDtfrom_S" name="pchsDtfrom_S"  class="input_calendar" autocomplete="off" msg="매입 시작일자" data-search="pchsDtfrom" date> 
								<input type="hidden" id="pchsDtto_S" name="pchsDtto_S"  class="input_calendar" autocomplete="off" msg="매입 종료일자" data-search="pchsDtto" date> 
							</div>
						</td>

						<th>결제일자</th>
						<td>
							<select id="pchsClmnDay_S" name="pchsClmnDay_S" data-search="pchsClmnDay">
								<option value="">전체</option>
								<option value="10" selected>10</option>
								<option value="25">25</option>
							</select>
						</td>	
						
						<th>발행여부</th>
						<td>
							<select id="billYn" name="billYn" data-search="billYn" msg="발행여부">
								<option value="" selected="selected">전체</option>
								<option value="Y">발행</option>
								<option value="N">미발행</option>
							</select>
						</td>
						<th>청구/영수</th>
						<td>
							<select id="payDiv" name="payDiv" data-kind="PAYDIV"  data-search="payDiv">
								<option value="">전체</option>
							</select>
						</td>
					</tr>
					
					<!-- 2행 -->
					<tr>
						<th>수주회사</th>
						<td>
							<select id="ordrsCoCd_S" name="ordrsCoCd_S" data-kind="CO" data-search="ordrsCoCd">
								<option value="" selected>전체</option>
							</select>
						</td>
						<th>구매처</th>
						<td>
							<input type="hidden" id="clntCd_S" name="clntCd_S" data-search="clntCd">
							<div class="search_form">
								<input type="text" id="clntNm_S" name="clntNm_S"  data-search="clntNm"
								onkeyup="event.keyCode == 8 ? clntCd_S.value = '' : event.keyCode == 13 ? DataSearch() : ''">
								<a onclick="openClntSearch('S');"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>부서명</th>
						<td>
							<select id="deptId_S" name="deptId_S" data-search="deptId">
								<option value="">전체</option>
								<option value="TRN50" selected>트루넷외주구매팀</option>
								<option value="TRN30">트루넷직접매출</option>
							</select>
						</td>
						<th>턴키구분</th>
						<td>
							<select id="trunDiv_S" name="trunDiv_S" data-search="trunDiv">
								<option value="">전체</option>
								<option value="PCHSCOSTDIV1030" selected>턴키자료만</option>
								<option value="PCHSCOSTDIV" selected>구매및가공</option>
							</select>
						</td>
						<th></th>
						<td></td>
					</tr>
				</table>
				<!-- 검색조건 END -->
				<form id="mainForm" onSubmit="return false;">
					<input type="hidden" id="userId" name="userId">
					<input type="hidden" id="pgmId"  name="pgmId" value="SM2001M01">
				</form>
			</div>
		</div>

		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<div class="contents_tit" style="display: flex; flex-wrap: nowrap;">
				<span  style="font-size: 15px;">대금 지급 대상 리스트  (검토, 승인:
					<span style="font-size:11px;color:red">●:결재전</span>,
					<span style="font-size:11px;color:blue">●:결재완료</span>
					<span style="font-size:11px;color:silver">●:부사장님 보류건</span>,
					<span style="font-size:13px;"> ※붉은색 글씨는 부사장님 보류건임)</span>
				 </span>
	    		<!-- 버튼 그룹 -->
			    <div class="right_controls">
			        <!-- 버튼 영역 -->
			        <div class="add_btn_small1">
			            <a onclick="projectApproval('C');" style="height: 30px; line-height: 28px; width: 120px;" authchk=""><i class="far fa-calendar-check"></i>공급사대금결재요청</a>
			            <a onclick="projectReport();" style="height: 30px; line-height: 28px; width: 100px;" authchk=""><i class="fas fa-print"></i>PJT별외주관리</a>
			            <a onclick="firstExcelDownload();" style="height: 30px; line-height: 28px; width: 110px;" authchk=""><i class="fas fa-file-download"></i>대금지불대상엑셀</a>
			            <a onclick="firstExcelUpload();" style="height: 30px; line-height: 28px; width: 100px;" authchk=""><i class="fas fa-upload"></i>지불현황업로드</a>
			            <a onclick="firstReport();" style="height: 30px; line-height: 28px; width: 100px;" authchk=""><i class="fas fa-print"></i>결제내역서출력</a>
			        </div>
		
		    	</div>
			</div>
		</div>
		<!-- 콘텐츠 -->
		<div class="contents">
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 335px; width: 100%" ></div>
			<div data-ax5grid="firstExcel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>
		
		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<div class="contents_tit" style="display: flex; flex-wrap: nowrap;">
				<span  style="height: 30px; line-height: 30px;font-size: 15px;">계산서 발행 리스트 </span>
				
				
    <!-- 오른쪽: 버튼 + 검색 필드 그룹 -->
    <div class="right_controls">
        <!-- 검색 필드 영역 -->
        <div class="table_list_tit1">
            <div class="table_list_tit1">
            <label>지급구분</label>
            <select id="payPmntmtd_S"  data-kind="PMNTMTD" >
                <option value="">선택</option>
            </select>
            <select id="payInterval_S"  style="width: 90px;">
                <option value="" selected>선택</option>
                <option value="30">30일</option>
                <option value="60">60일</option>
                <option value="90">90일</option>
            </select>
            </div>
            <div class="date_input">
                <label>지급일자</label>
                <input type="text" id="payDt_S" name="payDt_S" class="input_calendar" autocomplete="off" msg="지급일자">
            </div>
            <div class="date_input">
                <label>지급대상금액</label>
                <input type="text" id="payTot_S" name="payTot_S" msg="지급대상금액" comma>
            </div>
        </div>
        
        <!-- 버튼 영역 -->
        <div class="add_btn_small1">
            <a onclick="insert_update_sm20_Modal('C');" style="height: 30px; line-height: 28px; width: 70px;" authchk=""><i class="fas fa-file-invoice"></i>계산서발행</a>
            <a onclick="delete_sm20();" style="height: 30px; line-height: 28px; width: 70px;" authchk=""><i class="fas fa-window-close"></i>계산서취소</a>
            <a onclick="PayYnUpdate('Y')" style="height: 30px; line-height: 28px; width: 70px;" authchk="">
                <i class="fas fa-money-bill"></i> 지급등록
            </a>
            <a onclick="PayYnUpdate('U')" style="height: 30px; line-height: 28px; width: 70px;" authchk="">
                <i class="fas fa-money-bill"></i> 대금연결
            </a>
            <a onclick="PayYnUpdate('N')" style="height: 30px; line-height: 28px; width: 70px;" authchk="">
                <i class="fas fa-minus-square"></i> 연결취소
            </a>
            <a onclick="PayYnUpdate('D')" style="height: 30px; line-height: 28px; width: 70px;" authchk="">
                <i class="fas fa-eraser"></i> 대금삭제
            </a>
<!--             <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"> -->
<!--                 <i class="fas fa-file-excel"></i> 엑셀다운로드 -->
<!--             </a> -->
        </div>

    </div>
			</div>
			<!-- 리스트 -->
			<div style="display: flex; gap: 2px;">
				<div class="ax5_grid" data-ax5grid="second-grid" data-ax5grid-config="{}" style="height: 300px; width: 60%" ></div>
				<div class="ax5_grid" data-ax5grid="third-grid" data-ax5grid-config="{}" style="height: 300px; width: 40%" ></div>
			
			</div>
		</div>
	</div>
</body>
</html>

<script type="text/javascript">
	var today = moment(new Date()).format("YYYY-MM-DD");
	var yesterday = moment(new Date()).add(-1, 'days');
	var Select_row = 0;
	
	ax5.ui.grid.formatter["circleYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "H") {
			return '<img src="/static/img/silver_circle.png" style="width: 10px;height: 10px;"></img>';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};
	function scrollToRow(rowIndex) {
	    var $bodyScroll = $('[data-ax5grid="first-grid"] .ax5grid-body-scroll');
	    var rowHeight = grid.config.body.rowHeight || 28; // 기본 row 높이
	    var scrollTop = rowIndex * rowHeight;

	    $bodyScroll.scrollTop(scrollTop);
	}
	var gridView1 = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: true,
				sortable: true,
				showLineNumber: true,
				lineNumberColumnWidth: 40,
				target: $('[data-ax5grid="first-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					mergeCells : ["ctrtApprovalNo", "custNm", "clntPjtNm", "ordrsNo", "ctrtNo", "clntCd", "clntNm"],
					onClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
						Select_row = this.dindex;
						gridView2.setData();
					},
					onDBLClick: function () {
						var row = this.item;
						
						if (this.column.key == 'ctrtApprovalNo' && this.item.ctrtApprovalNo) {	//수주품의번호이면서 번호가 존재하면 팝업 생성 
							var paramObj = {
					                "coCd" 		 	: row.coCd,
					                "ctrtApprovalNo": row.ctrtApprovalNo,
					                "ordrsNo" 		: row.ordrsNo,
					                "ctrtNo" 		: row.ctrtNo,
					                "clntCd"      	: row.clntCd,
					                "deptId"        : $("#deptId_S").val(),
					        };
							openModal("/static/html/user/sm/sm30/SM3001P01.html", 1600, 850, "", paramObj, function(data) {
							});
						} else if (this.column.key == 'ctrtNo' && row.ctrtNo) { 
								var paramObj = {
										"actionType"     : 'T',
										"fileTrgtKey" : row.sm11FileTrgtKey,
										"ctrtNo"      : row.ctrtNo,
										"coCd" 	      : row.coCd,
								       	"userId"      : jwt.userId,
								       	"pgmId"       : "SM1101M01"
								}
								openModal("/static/html/user/sm/sm11/SM1101P01.html", 1500, $('body').height()-50, "", paramObj, function(data) {
								});
						} else if (this.column.key == 'aprReqNo' || this.item.aprReqNo) {	//결재요청번호이면서 번호가 존재하면 팝업 생성
							//결재요청 내역 조회 또는 수정화면 실행
							projectApproval('U');
						}
					},
					//그리드값 변경시 실행
					onDataChanged: function () {
						
					},
				},
				page: {
					navigationItemCount: 9,
					height: 30,
					display: false,
					firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange: function () {
						gridView2.setData(this.page.selectPage); 
					}
				},
				footSum: [
					[
						{label: "합계", colspan:1, align:"center"},
						{key: "pchsAmt"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "pchsVat"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "pchsTot"  , collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "uncompAmt", collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "uncompVat", collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "uncompTot", collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "compAmt"  , collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "compVat"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "compTot"  , collector: "sum", formatter:"money", align: "right"},
					]
				],
				columns: [
					{key: "coCd"  , label: "회사"    , hidden: true},
					{key: "coCdNm", label: "회사명"  , hidden: true},
					{key: "custId", label: "고객사"  , align: "center", width: 120, hidden: true},
					{key: "custNm", label: "고객사", align: "left"  , width: 140, hidden: true},
					{key: "clntPjtNm", label: "PJT", align: "left"  , width: 100, hidden: true},
					{key: "ordrsNo", label: "수주번호", align: "center"  , width: 70, hidden: true},
					{key: "ctrtApprovalNo",label: "품의번호", 	    width: 80,		align: "center",hidden: true, styleClass: function () {return "grid-font-blue-bold";}},
					{key: "ctrtNo", label: "계약번호", align: "center"  , width: 90, hidden: true, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
					{key: "clntCd", label: "구매처"  , align: "center", width: 120, hidden: true, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
					{key: "clntNm", label: "구매처명", align: "left"  , width: 180, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
					{key: undefined, label: "매입확정", columns: [
						{key: "pchsAmt", label: "확정금액" , align: "right" , width: 100, formatter: "money", styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
						{key: "pchsVat", label: "부가세"   , align: "right" , width: 90, formatter: "money", styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
						{key: "pchsTot", label: "확정 합계", align: "right" , width: 100, formatter: "money", styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
					]},
					{key: undefined, label: "세금계산서 발행", columns: [
// 						{key: "compAmt", label: "발행 금액" , align: "right", width: 100, formatter: "money"},
// 						{key: "compVat", label: "부가세"    , align: "right", width: 90, formatter: "money"},
						{key: "compTot", label: "발행 합계" , align: "right", width: 100, formatter: "money", styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
						{key: "billNo" , label: "계산서번호", align: "center", width: 90, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
						{key: "billDt" , label: "발행일자"  , align: "center", width: 80, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
					]},
					{key: undefined, 		label: "결제요청", columns: [
						{key: "aprReqSts", 	label: "상태" , align: "center", width: 50,		formatter: "circleYn"},
						{key: "aprReqDt", 	label: "요청일" , align: "center", width: 80, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
						{key: "aprReqIdNm", label: "요청자" , align: "center", width: 60, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
						{key: "aprYn2", 	label: "검토" , align: "center", width: 50, formatter: "circleYn"},
						{key: "aprYn3", 	label: "승인" , align: "center", width: 50, formatter: "circleYn"},
						{key: "aprReqNo", 	label: "요청번호" , align: "center", width: 90, styleClass: function () {return (this.item.aprYn3 == "H") ? "grid-font-red" : "";},},
					]},
					{key: undefined, label: "대금 결제현황", columns: [
						{key: "payYn", 		label: "지급" , align: "center", width: 60,		formatter: "circleYn"},
						{key: "payDt", 		label: "지급일자" , align: "center", width: 80},
						{key: "payPmntmtd", label: "결제유형" , align: "center", width: 110, hidden: true},
						{key: "payPmntmtdNm", label: "결제유형" , align: "center", width: 110},
						{key: "payInterval", label: "만기일"  , align: "center", width: 80},
					]},
				]
			});
			return this;
		},
		setData: function(_pageNo) {
			gridView2.initView();
			gridView3.initView();
			
			var targetObj = this.target;
			var paramObj = {};

			$.each($('#main_area [data-search]'), function(idx, elem) {
				paramObj[$(elem).data("search")] = $(elem).val();
			});
			
			//날짜하이픈 제거
			$.each($('[data-search]'), function(idx, elem) {
				if( $(elem).attr("class") == "input_calendar" ) {
					paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
				}
			});
			
			paramObj["pageNo"] = _pageNo + 1;
			paramObj["userId"] = jwt.userId;

			postAjax("/user/sm/sm20/sm20_main_grid1_selectList", paramObj, null, function(data) {
				try {
					let list = data.result;
					if (!list.length) list = [];
					for (let i = 0; i < list.length; i++) {
						list[i].pchsAmt = gPasFloatChk(list[i].pchsAmt);
						list[i].pchsVat = gPasFloatChk(list[i].pchsVat);
						list[i].pchsTot = gPasFloatChk(list[i].pchsTot);
						list[i].compAmt = gPasFloatChk(list[i].compAmt);
						list[i].compVat = gPasFloatChk(list[i].compVat);
						list[i].compTot = gPasFloatChk(list[i].compTot);
						list[i].uncompAmt = gPasFloatChk(list[i].uncompAmt);
						list[i].uncompVat = gPasFloatChk(list[i].uncompVat);
						list[i].uncompTot = gPasFloatChk(list[i].uncompTot);
					}
					targetObj.setData({
						list : list,
						page : {
							totalElements : list.length,
						}
					});
// 					targetObj.select(0);
// 					targetObj.select(Select_row);

			        targetObj.select(Select_row);  // row 다시 선택
			
			        // 스크롤 이동
			        targetObj.focusedIndex = {rowIndex: Select_row};
// 			        targetObj.scrollTo(Select_row);
					targetObj.select(Select_row);
					targetObj.focus(Select_row);
					gridView2.setData();
				} catch  (error){
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		}
	}
	
	var gridView2 = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect  : false,
				sortable        : false,
				showLineNumber  : true,
				lineNumberColumnWidth : 40,
				target : $('[data-ax5grid="second-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				body : {
					mergeCells : ["clntCd", "clntNm"],
					onClick : function() {
												var list = gridView2.target.getList("selected");
                        $.each(list, function(idx, obj){
                            gridView2.target.select(obj.__index, {selected: false});
                        });
						this.self.select(this.dindex);
						list = gridView2.target.getList("selected")[0];
						
						const compTot = list.compTot;	//세금계산서 발행금액
						const payYn = list.payYn;		//지급완료 여부
						const remTot = list.remTot;		//미지급금액
						
						if (compTot != 0 || remTot != 0) {
							$("#payTot_S").val(addCommaStr(list.remTot));	//세금계산서 발행금액
						}
					},
					onDBLClick : function() {
						insert_update_sm20_Modal("U");
					},
					onDataChanged : function() {
						let row = this.dindex;
						let col = this.colIndex;
					},
				},
				page : {
					navigationItemCount : 10,
// 					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView2.setData(this.page.selectPage);
					}
				},
				footSum: [
					[
						{label: "합계", colspan:1, align:"center"},
						{key: "pchsAmt"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "pchsVat"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "pchsTot"  , collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "uncompAmt", collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "uncompVat", collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "uncompTot", collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "compAmt"  , collector: "sum", formatter:"money", align: "right"},
// 			    		{key: "compVat"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "compTot"  , collector: "sum", formatter:"money", align: "right"},
						{},
						{},
			    		{key: "remTot"  , collector: "sum", formatter:"money", align: "right"},
						{},
					]
				],
				columns: [
					{key: "coCd"  , label: "회사"    , hidden: true},
					{key: "coCdNm", label: "회사명"  , hidden: true},
					{key: "clntCd", label: "구매처"  , align: "center", width: 110, hidden: true},
					{key: "clntNm", label: "구매처명", align: "left"  , width: 180},
					{key: undefined, label: "매입확정", columns: [
						{key: "pchsAmt", label: "확정금액" , align: "right" , width: 100, formatter: "money"},
						{key: "pchsVat", label: "부가세"   , align: "right" , width: 90, formatter: "money"},
						{key: "pchsTot", label: "확정 합계", align: "right" , width: 100, formatter: "money"},
					]},
// 					{key: undefined, label: "세금계산서 미 발행", columns: [
// 						{key: "uncompAmt"  , label: "미발행 금액" , align: "right", width: 100, formatter: "money"},
// 						{key: "uncompVat"  , label: "부가세"      , align: "right", width: 90, formatter: "money"},
// 						{key: "uncompTot"  , label: "미발행 합계" , align: "right", width: 100, formatter: "money"},
// 						{key: "fileTrgtKey", label: "fileTrgtKey", align: "center", width: 110, hidden: true},
// 					]},
					{key: undefined, label: "세금계산서 발행 완료", columns: [
// 						{key: "compAmt", label: "발행 금액" , align: "right", width: 100, formatter: "money"},
// 						{key: "compVat", label: "부가세"    , align: "right", width: 90, formatter: "money"},
						{key: "compTot", label: "발행 합계" , align: "right", width: 100, formatter: "money"},
						{key: "billNo" , label: "계산서번호", align: "center", width: 90},
						{key: "billDt" , label: "발행일자"  , align: "center", width: 80},
						{key: "billYn" , label: "발행여부"  , align: "center", width: 60, hidden: true},
						{key: "payYn"  , label: "지급여부"  , align: "center", width: 60, formatter: "circleYn", hidden: true},
					]},
// 					{key: undefined, label: "대금 결제현황", columns: [
// 						{key: "payYn", label: "지급" , align: "center", width: 60,		formatter: "circleYn"},
// 						{key: "payDt", label: "지급일자" , align: "center", width: 80},
// 						{key: "payPmntmtd", label: "결제유형" , align: "center", width: 110, hidden: true},
// 						{key: "payPmntmtdNm", label: "결제유형" , align: "center", width: 110},
// 						{key: "payInterval", label: "만기일"  , align: "center", width: 80},
// 					]},
					{key: "remTot", label: "미지급금"  , align: "right", width: 100, formatter: "money", styleClass: function () {return "grid-font-blue-bold";}},
					{key: "deptId" , label: "발행부서"  , align: "center", width: 60, hidden: true},
					{key: "deptNm" , label: "발행부서명"  , align: "center", width: 60, hidden: true},
					{key: "ctrtNo" , label: "계약번호"  , align: "center", width: 90, hidden: false},
				]
			});
			return this;
		},
		setData : function(_pageNo) {
			let sltClnt = gridView1.target.getList("selected")[0];
			if (sltClnt) {
			} else {
				return false;
			}
			var targetObj = this.target;
			var paramObj = {};
			
			$.each($('#main_area [data-search]'), function(idx, elem) {
				paramObj[$(elem).data("search")] = $(elem).val();
			});
			
			//날짜하이픈 제거
			$.each($('[data-search]'), function(idx, elem) {
				if( $(elem).attr("class") == "input_calendar" ) {
					paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
				}
			});
			paramObj["pageNo"] = 1;
			paramObj["userId"] = jwt.userId;
			//그리드에 선택된 거래처 정보를 파라메터에 저장함. (화면 검색조건에 있는 내용은 무시됨)
			paramObj["pchsClntCd"] = sltClnt.clntCd;
			paramObj["pchsClntNm"] = sltClnt.clntNm;
			paramObj["ctrtNo"] = sltClnt.ctrtNo;
			paramObj["ctrtApprovalNo"] = sltClnt.ctrtApprovalNo;
			paramObj["billNo"] = sltClnt.billNo;
			paramObj["ctrtNo"] = sltClnt.ctrtNo;
			postAjax("/user/sm/sm20/sm20_main_grid2_selectList", paramObj, null, function(data){
				try {
	                var list = data.result;
					if (!list.length) list = [];
					for (let i = 0; i < list.length; i++) {
						list[i].pchsAmt = gPasFloatChk(list[i].pchsAmt);
						list[i].pchsVat = gPasFloatChk(list[i].pchsVat);
						list[i].pchsTot = gPasFloatChk(list[i].pchsTot);
						list[i].compAmt = gPasFloatChk(list[i].compAmt);
						list[i].compVat = gPasFloatChk(list[i].compVat);
						list[i].compTot = gPasFloatChk(list[i].compTot);
						list[i].uncompAmt = gPasFloatChk(list[i].uncompAmt);
						list[i].uncompVat = gPasFloatChk(list[i].uncompVat);
						list[i].uncompTot = gPasFloatChk(list[i].uncompTot);
					}
	               	targetObj.setData({
					    list : list,
					    page : {
			                   totalElements : list.length,
					    } 
			        });
					

	    	        gridResize(list.length+1); //그리드 높이 조정
	    	        
					if (!list.length) {
						data.grid3 = [];
					} else {
						targetObj.select(0);
						$('#payTot_S').val(addCommaStr(list[0].remTot));
					}
	    	        
	    	      	//입금데이터 조회내역처리 --> gridView3.setData 처리함
	    	        var list3 = data.grid3;	
					for (let i = 0; i < list3.length; i++) {
						list3[i].payAmt = gPasFloatChk(list3[i].payAmt);
						list3[i].payVat = gPasFloatChk(list3[i].payVat);
						list3[i].payTot = gPasFloatChk(list3[i].payTot);
					}
					gridView3.target.setData({
					    list : list3,
					    page : {
			                   totalElements : list3.length,
					    } 
			        });
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		}
	}

	var gridView3 = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect  : true,
				sortable        : false,
				showLineNumber  : true,
				lineNumberColumnWidth : 20,
				target : $('[data-ax5grid="third-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				body : {
					mergeCells : ["payDt"],
					onClick : function() {
						var list = gridView3.target.getList("selected");
                        $.each(list, function(idx, obj){
                            gridView3.target.select(obj.__index, {selected: false});
                        });
						this.self.select(this.dindex);
					},
					onDBLClick : function() {
					},
					onDataChanged : function() {
						let row = this.dindex;
						let col = this.colIndex;
					},
				},
				page : {
				},
				footSum: [
					[
						{label: "합계", colspan:1, align:"center"},
			    		{key: "payTot", collector: "sum", formatter:"money", align: "right"},
					]
				],
				columns: [
					{key: undefined, label: "대금 결제현황", columns: [
// 						{key: "payYn", label: "지급" , align: "center", width: 60,		formatter: "circleYn"},
						{key: "payDt", label: "지급일자" , align: "center", width: 80, styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "payTot", label: "지급금액" , align: "right", width: 110, formatter: "money", styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "payPmntmtd", label: "결제유형" , align: "center", width: 100, hidden: true, styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "payPmntmtdNm", label: "결제유형" , align: "center", width: 100, styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "payInterval", label: "기간"  , align: "center", width: 40, styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "payExpDt", label: "만기일"  , align: "center", width: 80, styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "billNo" , label: "대상계산서번호", align: "center", width: 90, styleClass: function () {return (this.item.billNo) ? "" : "grid-font-red";},},
						{key: "fileTrgtKey" , label: "등록번호", align: "center", width: 90, hidden: true},
						{key: "ctrtNo" , label: "계약번호"  , align: "center", width: 90},
					]},
				]
			});
			return this;
		},
	}
	
	var excelView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target : $('[data-ax5grid="excel-grid"]'),
				footSum: [
					[
						{label: "합계", colspan:3, align:"center"},
						{key: "pchsAmt"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "pchsVat"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "pchsTot"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "uncompAmt", collector: "sum", formatter:"money", align: "right"},
			    		{key: "uncompVat", collector: "sum", formatter:"money", align: "right"},
			    		{key: "uncompTot", collector: "sum", formatter:"money", align: "right"},
			    		{key: "compAmt"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "compVat"  , collector: "sum", formatter:"money", align: "right"},
			    		{key: "compVat"  , collector: "sum", formatter:"money", align: "right"},
					]
				],
				columns: [
					{key: "coCd"  , label: "회사"    , hidden: false},
					{key: "coCdNm", label: "회사명"  , hidden: true},
					{key: "clntCd", label: "구매처"  , align: "center", width: 120},
					{key: "clntNm", label: "구매처명", align: "left"  , width: 180},
					{key: undefined, label: "매입확정", columns: [
						{key: "pchsAmt", label: "확정금액" , align: "right" , width: 100, formatter: "money"},
						{key: "pchsVat", label: "부가세"   , align: "right" , width: 90, formatter: "money"},
						{key: "pchsTot", label: "확정 합계", align: "right" , width: 100, formatter: "money"},
					]},
					{key: undefined, label: "세금계산서 미 발행", columns: [
						{key: "uncompAmt"  , label: "미발행 금액" , align: "right", width: 100, formatter: "money"},
						{key: "uncompVat"  , label: "부가세"      , align: "right", width: 90, formatter: "money"},
						{key: "uncompTot"  , label: "미발행 합계" , align: "right", width: 100, formatter: "money"},
					]},
					{key: undefined, label: "세금계산서 발행 완료", columns: [
						{key: "compAmt", label: "발행 금액" , align: "right", width: 100, formatter: "money"},
						{key: "compVat", label: "부가세"    , align: "right", width: 90, formatter: "money"},
						{key: "compTot", label: "발행 합계" , align: "right", width: 100, formatter: "money"},
						{key: "billNo" , label: "계산서번호", align: "center", width: 90},
						{key: "billDt" , label: "발행일자"  , align: "center", width: 80},
					]},
					{key: undefined, label: "대금 결제현황", columns: [
						{key: "payYn", label: "지급" , align: "center", width: 60},
						{key: "payDt", label: "지급일자" , align: "center", width: 80},
						{key: "payPmntmtd", label: "결제유형" , align: "center", width: 110},
						{key: "payPmntmtdNm", label: "결제유형" , align: "center", width: 110},
						{key: "payInterval", label: "만기일"  , align: "center", width: 80},
					]},
				]
			});
			return this;
		}
	}

	
	var firstExcelDown = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target : $('[data-ax5grid="firstExcel-grid"]'),
				footSum: [
					[
						{label: "합계", colspan:5, align:"center"},
			    		{key: "pchsTot"  , collector: "sum", formatter:"money", align: "right"},
					]
				],
				columns: [
					{key: "coCd"  , label: "회사"    , hidden: true},
					{key: "coCdNm", label: "회사명"  , hidden: true},
					{key: "clntCd", label: "구매처"  , align: "center", width: 120, hidden: false},
					{key: "clntNm", label: "구매처명", align: "left"  , width: 180},
					{key: "repstNm", label: "대표자", align: "left"  , width: 80},
					{key: "crn", 	label: "사업자번호", align: "left"  , width: 110},
					{key: "", 		label: "공백1", align: "left"  , width: 100},
					{key: "pchsTot", label: "금액(VAT포함)" , align: "right" , width: 120, formatter: "money"},

					{key: "pchsPmntMtdNm", label: "결제방식" , align: "center", width: 120},
					{key: "payDt1", label: "전자어음(만기일)" , align: "center", width: 120,},
					{key: "payDt2", label: "전자외담대(만기일)" , align: "center", width: 120,},
					{key: "billDt", label: "세금계산서발행일자" , align: "center", width: 110},
					{key: "billNo", label: "세금계산서발행번호" , align: "center", width: 110},
					{key: "", label: "실지급일" , align: "center", width: 100},
					{key: "pchsPmntMtdCd", label: "결제방식CD" , align: "center", width: 120},
					{key: "ctrtNo" , label: "계약번호"  , align: "center", width: 100},
				]
			});
			return this;
		}
	}
	$(document).ready(function() {
		$.dayInit = function() {
			var pre1Month = moment(new Date()).date(26).subtract(1, "M").format("YYYY-MM-DD");
			var pre2Month = moment(new Date()).date(25).format("YYYY-MM-DD");
			// 시작일 (현재날짜의 월 첫일)
			
			// 마감년월 set
			$('#closeYm_S').datepicker({format : "yyyy-mm", minViewMode: 1, language : "ko", autoclose : true})
						   .datepicker("setDate", new Date());
			// 마감년월 set  		
			
			$('#payDt_S').datepicker({format : "yyyy-mm-dd",language : "ko",autoclose : true})
						 .datepicker("setDate", moment(new Date()).toDate());
		
			$('#pchsDtfrom_S').datepicker({format : "yyyy-mm-dd",language : "ko",autoclose : true})
							.datepicker("setDate", pre1Month)
							.on("changeDate", function() {
								var fromDate = $(this).val();
						        if (fromDate) {
						            // moment 객체로 변환
						            var nextMonth25 = moment(fromDate, "YYYY-MM-DD").add(1, 'month').date(25).format("YYYY-MM-DD");
						            $('#pchsDtto_S').val(nextMonth25);
						        }
							});
		
			// 종료일 (현재날짜의 월 말일)
			$('#pchsDtto_S').datepicker({format : "yyyy-mm-dd",language : "ko",autoclose : true})
							.datepicker("setDate", pre2Month)
							.on("changeDate", function() {
						        var toDate = $(this).val();
						        if (toDate) {
						            var prevMonth26 = moment(toDate, "YYYY-MM-DD").subtract(1, 'month').date(26).format("YYYY-MM-DD");
						            $('#pchsDtfrom_S').val(prevMonth26);
						        }
							});
		}
		
		//초기설정들
		mainDefaultLoad("매입관리", "매입계산서발행");
		setCommonSelect($("#main_area select[data-kind]"));
		
		$("#payDiv").val('PAYDIV02'); //청구/영수구분 기본 청구로 시작 (PAYDIV01:영수,  PAYDIV02:청구)
		// 접속자 회사 set
		$("#coCd_S").val('TRN');
		$("#userId").val(jwt.userId);
		$.dayInit();

		gridView1.initView().setData(0);

		// 검색조건 이벤트 bind (지급년월 data-search는 아래 change 이벤트에서 대신 처리)
		$('[data-search]').not('#closeYm_S').on("change", function() {
			DataSearch();
		});
		

		//월이 바뀌면 자료 검색 시작일 종료일 설정
		$('#closeYm_S').on("change", function() {
            var prevMonth26 = moment(this.value+"-26", "YYYY-MM-DD").subtract(1, 'month').format("YYYY-MM-DD");
            var nowMonth25 = this.value+"-25";	
            $('#pchsDtfrom_S').val(prevMonth26);	//이전달 26일부터
            $('#pchsDtto_S').val(nowMonth25);		//해당월 25일까지 매입금액
			DataSearch();
		});
		
		$('#payTot_S').on("input", function() {
			this.value = this.value.replace(/[^0-9]/g, "");
			onlyNumber(this); 
		});

		//턴키제외, 턴키자료만 변경 선택시 그리드 컬럼 변경에 대한 처리를 위한 코드임
		$('#trunDiv_S').on("input", function() {
			const chkValue = $('#trunDiv_S').val() == 'PCHSCOSTDIV1030';
			//*************************************************************************
			//gridView1 컬럼 설정 변경하기 시작
			//*************************************************************************
			var updatedColumns = gridView1.target.columns.map(function (col) {
				if (col.key === "ctrtApprovalNo" || col.key === "custNm" || col.key === "clntPjtNm" || col.key === "ordrsNo" || col.key === "ctrtNo") {
		            col.hidden = (!chkValue);  // 'PCHSCOSTDIV1030'면 보이고 아니면 숨김
		        }
		        return col;
		    });
			var updatedfootSumColumns = gridView1.target.footSumColumns;
			updatedfootSumColumns[0][0].colspan = (chkValue) ? 6:1;
			var oldList = gridView1.target.list; // 기존 데이터 유지
			gridView1.target.setConfig({
				footSum: updatedfootSumColumns,
		        columns: updatedColumns,
		        body: {
		            rows: oldList
		        }
		    });
			//*************************************************************************
			//gridView1 컬럼 설정 변경하기 종료
			//*************************************************************************
		});
		
		
		$('#payPmntmtd_S').on("change", function() {
			if (this.value == 'PMNTMTD01') {
				$('#payInterval_S').val('');
			} else {
				if ($('#payInterval_S').val() == '') {
					$('#payInterval_S').val('90');
				};
			}
		});
		//권한체크
		authChk();
	});
	//ready end

	// 검색 버튼
    function DataSearch() {
        gridView1.setData(0);
    }

	//수정 or 등록 버튼 클릭 시
	function insert_update_sm20_Modal(type) {
		if ($("#pchsClmnDay_S").val() == '') {
			alert("결제일자를 선택하고 작업하세요!")
			return false;
		}
		var paramObj = {};
		if (type == 'U') {
			var row = gridView2.target.getList("selected")[0];
			if (!row) {
				alert("작업할 Row를 선택하고 작업버튼을 클릭하세요!");
				return false;
			}
			var fileTrgtKey = row.fileTrgtKey;
			
			if (fileTrgtKey == '0' || undefined) {
				type = 'C';
			} else {
				type = 'U';
			}
			
			paramObj = {
                "actionType"  : type,
                "fileTrgtKey" : row.fileTrgtKey,
                "coCd"        : row.coCd,
                "clntCd"      : row.clntCd,
                "clntNm"      : row.clntNm,
                "deptId"      : row.deptId,
                "deptNm"      : row.deptNm,
				"currCd"      : "CURR01",
                "userId"      : jwt.userId,
                "pgmId"       : "SM2001P01",
        		"pchsClmnDay" : $("#pchsClmnDay_S").val(),
        		"trunDiv"	  : $("#trunDiv_S").val(),
				"ordrsCoCd"	  : $("#ordrsCoCd_S").val()
            };
        } else {
        	var row = gridView1.target.getList("selected")[0];
        	if (row != undefined) {
        		// 그리드 클릭 후 신규 등록 버튼 클릭 시 고객사 코드 및 명칭 넘김
        		paramObj = {
	                "actionType"  : type,
	                "fileTrgtKey" : 0,
	                "coCd"        : row.coCd,
	                "clntCd"      : row.clntCd,
	                "clntNm"      : row.clntNm,
	                "deptId"      : row.deptId,
	                "deptNm"      : row.deptNm,
					"currCd"      : "CURR01",
	                "userId"      : jwt.userId,
	                "pgmId"       : "SM2001P01",
	        		"pchsClmnDay" : $("#pchsClmnDay_S").val(),
	        		"trunDiv"	: $("#trunDiv_S").val(),
					"ordrsCoCd"	  : $("#ordrsCoCd_S").val()
				};
        	}
        	else {
        		paramObj = {
    	                "actionType"  : type,
    	                "fileTrgtKey" : 0,
    	                "coCd"        : $("#coCd_S").val(),
    	                "userId"      : jwt.userId,
    	                "pgmId"       : "SM2001P01",
    	        		"pchsClmnDay" : $("#pchsClmnDay_S").val(),
    	        		"trunDiv"	: $("#trunDiv_S").val(),
						"ordrsCoCd"	  : $("#ordrsCoCd_S").val()
    				};
        	}        	
        }
		openModal("/static/html/user/sm/sm20/SM2001P01.html", 1600, 850, "", paramObj, function(data) {
			DataSearch();
		});
	}

	// 삭제 버튼 클릭 시
	function delete_sm20() {
		var ctrtrow = gridView1.target.getList("selected")[0];
		var row = gridView2.target.getList("selected")[0];
		if (!row) {
			alert("작업할 Row를 선택하고 작업버튼을 클릭하세요!");
			return false;
		}
		var billNo = row.billNo;
		if (billNo == undefined) {
			alert("계산서 등록 되지 않았습니다. \n +를 눌러 계산서 등록을 해주십시오.");
  			return;
  		}
		
		if (ctrtrow.aprReqSts == 'Y' || ctrtrow.aprYn2=='Y' || ctrtrow.aprYn3 == 'Y'){
			alert("결재된 자료는 삭제나 수정할 수 없읍니다.");
 			return;
		}

		var payYn = row.payYn;
		if (payYn == 'Y') {
			alert("지급된 계산서는 취소할 수 없습니다.");
  			return;
  		}
		var formData = {
			"fileTrgtKey" : row.fileTrgtKey,
			"coCd"        : row.coCd,
			"billNo"      : row.billNo,
			"userId"      : jwt.userId,
			"fileTrgtTyp" : "SM2001P01"
		}
		if(!monthCloseChk(row.billDt, 'D', row.coCd)) return;  //마감일통제
		if (confirm("삭제하시겠습니까?")) {
			putAjax("/user/sm/sm20/delete_sm20", formData, null, function(data) {
				alert(data.resultMessage);
				
				if (data.resultCode == 200) {
					gridView1.setData();
				}
			});
		}
	}
	
	//부가세 set
	function vatSet(row, prc) {
		if (prc) {
			//부가세
			var vat = Math.floor(Number(prc / 10));
			gridView2.target.setValue(row, "pchsVat", vat);
			//합계
			var sumAmt = parseInt(vat + Number(prc));
			gridView2.target.setValue(row, "pchsSumAmt", sumAmt);
		}
	}

	function initSearch() {
		// datepicker를 제외한 select, input 값 모두 초기화
		$(".contents.search select").val("");
		$(".contents.search input").val("");
		// 회사 초기화
		$("#coCd_S").val(jwt.coCd);

		$.dayInit();

		if ($("#clntNm_S").val() == "") {
			$("#clntCd_S").val("");
		}
		// 재검색
		DataSearch();
	}

	// 거래처(구매처) 검색
	function openClntSearch(openType) {
		var searchValueM = null;
		// P:고객사, S:구매처
		searchValueM = $("#clntNm_S").val();
		
		var paramObj = {
			"searchValue" : searchValueM,
			"clntDivCd"   : "CLNTDIV12",  /*거래처 검색 기본값 고객사로 세팅 */
			"pchsClntCd"  : "CLNTDIV12" /*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */
		}
		
		if (openType == "S") {
			paramObj.clntDivCd = null;
		}
		//매입관리에서 호출 플래그 추가
		paramObj.PurchaseFlag = "Y";

		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			//고객사 콤보 세팅
			$('#clntCd_S').val(row.clntCd);
			$('#clntNm_S').val(row.clntNm);
		});
	}

	//엑셀다운로드
	function excelDown() {
		excelView.initView();
		var paramObj = {};

		$.each($('#main_area [data-search]'), function(idx, elem) {
			paramObj[$(elem).data("search")] = $(elem).val();
		});
		
		//날짜하이픈 제거
		$.each($('[data-search]'), function(idx, elem) {
			if( $(elem).attr("class") == "input_calendar" ) {
				paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
			}
		});
		paramObj["pageNo"] =  1;
		paramObj["userId"] = jwt.userId;

		postAjax("/user/sm/sm20/sm20_main_grid1_selectList", paramObj, null, function(data) {
			var list = data.result;
			excelView.target.setData({
				list : list,
				page : {
					totalElements : list.length
				}
			});
			
			var todayDate = new Date().format('yyyyMMddHHmmss');
			excelView.target.exportExcel("매입계산서발행현황_" + todayDate + ".xls");
		});
	}

	//매입계산서 지급
	function PayYnUpdate(jobYn) {

		var gridList = gridView2.target.getList("selected");
		let elemBill = gridList[0];
		if (gridList == undefined || gridList?.length < 1) {
			if (jobYn == 'N' || jobYn == 'D') {
				//취소나 삭제는 굳이 계산서를 선택하지 않더라도 처리 간능함.
			} else {
				alert("처리할 자료를 선택해 주세요.");
				return false;
			}
		} 

		if (jobYn != 'D') {
			if (elemBill.billYn == 'N' || !elemBill.billNo) {
				//발행완료 처리건이면 패스
				alert("계산서가 발행 되지 않았습니다.");
				return false;
			}
		}

		//단일 지급처리시 jobYn == 'Y' 
		var calcDateDay = {YMD :''};		//
		if (jobYn =='Y') {
			if ($('#payPmntmtd_S').val() == '') {
				alert("지급구분과, 지급일자를 선택하세요!");
				return false;
			}
			if (gPasIntChk($('#payTot_S').val()) == 0) {
				alert("지급대상금액을 일력하세요!");
				return false;
			}
			
			if ($('#payPmntmtd_S').val() != 'PMNTMTD01') {
				if (gPasIntChk($('#payInterval_S').val()) == 0) {
					alert("만기일을 선택하세요!");
					return false;
				}
				var calcDate = moment($('#payDt_S').val()).add(87, "days").format("YYYY-MM-DD");
				var calcDateDay = calculateHoliday(calcDate, 1);
				// calcDateDay = {"YMD": "2025-04-18", "year": 2025, "month": 4, "date": 18, "day": "금", "workingDays": 2, "holiDays": 2}
			}
		}


		

		//대량입금처리 연결작업 jobYn == 'U' 
		var gridList3 = gridView3.target.getList("selected");
		if (gridList3 == undefined || gridList3?.length < 1) {
			if (jobYn != 'Y') {
				alert("대금 결재현황 자료를 선택해 주세요.");
				return false;
			}
		}

		if (jobYn == 'N' || jobYn == 'D') {
		    for (let i = 0; i < gridList3.length; i++) {
		        const elem = gridList3[i];
		        if (elem.billNo && elemBill.billNo !== elem.billNo) {
		          alert("해당 계산서의 입금 내역이 아닙니다.");
		          return false; // ✅ 외부 함수 종료!
		    	}
			}
		}
		
		var formData = new FormData($("#mainForm")[0]);

		let payPmntmtd = $('#payPmntmtd_S').val();
		let payInterval = $('#payInterval_S').val();
		let payDt = $('#payDt_S').val().replace(/\-/g, '');
		let payTot = $('#payTot_S').val().replace(/\,/g, '');
		if (jobYn =='Y') {  //신규등록
			formData.append("clntCd", elemBill.clntCd);
			formData.append("clntNm", elemBill.clntNm);
			formData.append("PayRmk", elemBill.PayRmk);
		} else if (jobYn =='N') {
			payPmntmtd = '';
			payInterval = '';
			payDt = '';
			payTot = '';
		}

		formData.append("jobYn", jobYn);						//작업구분
		formData.append("payPmntmtd", payPmntmtd);
		formData.append("payInterval", payInterval);
		formData.append("payExpDt", calcDateDay.YMD);		//지급일자기준 만기일까지에서 워킹데이 -2일 기준을 지급일자로 계산
		formData.append("payDt", payDt);
		formData.append("billNo", elemBill.billNo);				//계산서 발행번호
		formData.append("ctrtNo", elemBill.ctrtNo || '');				//계약번호 (계약번호가 있는건은 해당 번호가 그대로 가고 없으면 빈값으로)
		formData.append("payTot", payTot);
		formData.append("payAmt", payTot);
		formData.append("coCd", $("#coCd_S").val());
		formData.append("closeYm", $("#closeYm_S").val());
		formData.append("pchsDtfrom", $("#pchsDtfrom_S").val());
		formData.append("pchsDtto", $("#pchsDtto_S").val());
		formData.append("pchsClmnDay", $("#pchsClmnDay_S").val());
		formData.append("billYn", $("#billYn").val());
		formData.append("clntCd", $("#clntCd_S").val());
		formData.append("clntNm", $("#clntNm_S").val());
		formData.append("payDiv", $("#payDiv").val());
		formData.append("deptId", $("#deptId_S").val());
		formData.append("payDt", $("#payDt_S").val());
		
		
		formData.append("makeArr", JSON.stringify(gridList3));	//대금 지불현황

		var row = gridView1.target.getList("selected")[0];
		Select_row = row.__index;

		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
		filePostAjax("/user/sm/sm20/update_sm20_payYn", formData, function(data) {
			if (data.resultCode == 200) {
				alert("처리 되었습니다.");
				gridView1.setData();
			} else {
				alert("등록중 오류가 발생 되었습니다.");
			}
		});
	}
	
	

	//firstExcelDown 엑셀다운로드
	function firstExcelDownload() {
		firstExcelDown.initView();
		var paramObj = {};

		$.each($('#main_area [data-search]'), function(idx, elem) {
			paramObj[$(elem).data("search")] = $(elem).val();
		});
		
		//날짜하이픈 제거
		$.each($('[data-search]'), function(idx, elem) {
			if( $(elem).attr("class") == "input_calendar" ) {
				paramObj[$(elem).data("search")] = deleteHyphenStr($(elem).val());
			}
		});
		paramObj["pageNo"] =  1;
		paramObj["userId"] = jwt.userId;

		postAjax("/user/sm/sm20/sm20_main_grid1_selectList", paramObj, null, function(data) {
			var list = data.result;
			if (list) {
				//매입대금 지급 기준일자 설정 ex) 2025-03월 지불이면 25-04-10, 25-04-25 pchsClmnDay_S
				let payDay = $('#pchsClmnDay_S').val() == '25' ? 22 : 7;
				let payStartDt = moment($('#closeYm_S').val()+"-" + payDay, "YYYY-MM-DD").add(1, 'month').add(90, "days").format("YYYY-MM-DD");
				for (let i = 0; i < list.length; i++) {
					const paymtCd = list[i].pchsPmntMtdCd;
					if (paymtCd != 'PMNTMTD01') {
						var calcDateDay = calculateHoliday(payStartDt, 1);	//최종 지급일 기준 2일전 workingDay
						// calcDateDay = {"YMD": "2025-04-18", "year": 2025, "month": 4, "date": 18, "day": "금", "workingDays": 2, "holiDays": 2}
						if (paymtCd == 'PMNTMTD02' || paymtCd == 'PMNTMTD03') {
							list[i].payDt1 = calcDateDay.YMD;	//전자어음
						} else if (paymtCd == 'PMNTMTD04') {
							list[i].payDt2 = calcDateDay.YMD;
						}
					}
				}
			} else {
				list =[];
			}
			
			firstExcelDown.target.setData({
				list : list,
				page : {
					totalElements : list.length
				}
			});
			
			var todayDate = new Date().format('yyyyMMddHHmmss');
			firstExcelDown.target.exportExcel("구매_매입대금지불대상_"+ $('#closeYm_S').val()+"월분_" + todayDate + ".xls");
		});
	}

	

	//firstExcelUpload 엑셀업로드
	function firstExcelUpload() {
		var paramObj = {
                "coCd" 		 	: $("#coCd_S").val(),
        };
		openModal("/static/html/user/sm/sm30/SM3001P02.html", 1600, 850, "", paramObj, function(data) {
// 			DataSearch();
		});
	}

	
	function gridResize(size) {
        let tagHeight = (size) * 27 + 50 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 320 ? 320 : tagHeight;
        
        gridView2.target.setHeight(tagHeight);
        gridView3.target.setHeight(tagHeight);
    }
	
	//공급사 대금 지급 결재 요청 작업
	function projectApproval(type) {
		const targetRow = gridView1.target.getList("selected");	//선택행
		// 계산서 발행 누락 여부 확인
		const hasMissingBillNo = targetRow.some(item =>
		    item.billNo === undefined || item.billNo === null || item.billNo === ''
		);

		if (hasMissingBillNo) {
			alert("세금계산서 발행 확인후 결재요청하세요. 계산서 번호가 없는자료가 있습니다.");
			return false;
		}

		// 계산서만 배열생성
		const billNoValues = targetRow.map(item => item.billNo).filter(val => val);// 선택행중 계산서번호 비교 대상 배열(null, undefined, '', 0) 제거
		
		//전체 대상리스트 목록 가져오기
		const totalList = gridView1.target.list;
		//전체 목록대상에서 계산서번호가 같은것은 모두 가져오기
		let row =[];
		if (billNoValues) {
			row = totalList.filter(item => billNoValues.includes(item.billNo));
		} else {
			row = targetRow
		} 
			
		if (row.length == 0) {
			alert("결제요청자료를 선택한 후 작업가능합니다.");
			return false;
		}

		const hasValue = row.some(item => item.aprReqNo != null && item.aprReqNo !== '');
		if (type == 'C' && hasValue != '') {
			alert("이전에 결제요청한 자료가 포함되어 있습니다. 확인 바랍니다.");
			return false;
		}
		if (type == "C") {
			// 1) 모든 항목이 신규(요청번호 없음)
			actionType = "C";
			paramObj = {
				actionType,
				coCd: $("#coCd_S").val(),
				closeYm: $("#closeYm_S").val(),
				pchsDtfrom: $("#pchsDtfrom_S").val(),
				pchsDtto: $("#pchsDtto_S").val(),
				pchsClmnDay: $("#pchsClmnDay_S").val(),
				billYn: $("#billYn").val(),
				deptId: $("#deptId_S").val(),
				deptNm: $("#deptId_S option:selected").text(),
				trunDiv: $("#trunDiv_S").val(),
				payDiv: $("#payDiv").val(),
				userId: $("#userId").val(),
				row  // 선택된 모든 행 전달
			};
		} else {
			var paramObj = {
				"actionType" 	: type,		// "U"
				"coCd"			: $("#coCd_S").val(),
				"fileTrgtKey"	: row[0].aprReqNo
			}
		}
		openModal("/static/html/user/sm/sm30/SM3002P01.html", 1600, 850, "", paramObj, function(data) {
			DataSearch();
		});
	}

	
	//PJT별 외주 대금 지급 현황 출력
	function projectReport(_type = "") {
		var row = gridView1.target.getList("selected")[0];
	  	var arg =  
	  		  "coCd#"			+ row.coCd
	  	    + "#ordrsNo#"		+ row.ordrsNo
	  	    + "#ctrtApprovalNo#"+ row.ctrtApprovalNo
	  	    + "#deptId#"		+ $("#deptId_S").val()
	  	    + "#userId#"		+ jwt.userId
	      	+ "#";                 
	  	var fileName = "SM1103R01.jrf";
	  	if (_type == '' || _type == 'S' || _type == undefined ) {
	  		var todayDate = new Date().format('yyyyMMddHHmmss')
	  		callReport(fileName, arg, 1150, 720, row.ordrsNo+'수주 PJT별 외주관리'+ todayDate);
	  	} else { //Export 작업
	  		ubiExportAjax(fileName, arg, function(response) {
	  			if (response.resultCode === 200) {
	  				var base64FileData = response.base64FileData;
	  				var fileName = response.exportFileName;
	  				downloadPDFFromBase64(base64FileData, fileName);
	  			} else {
	  				alert('PDF 내보내기 실패: ' + response.resultText);
	  			}

	  		});
	  	}
	  }    

	
	//List 출력
	function firstReport(_type = "") {
		if ($("#pchsClmnDay_S").val() == '') {
			alert('결제일자를 선택하세요! 결제내역서는 결제일 필수입니다.');
			return false;
		}
	  	var arg =  
	  		  "coCd#"			+  $('#coCd_S').val()
	  	    + "#closeYm#"		+  $("#closeYm_S").val().replace(/\-/g, '')
	  	    + "#closeYmFrom#"	+  $("#pchsDtfrom_S").val().replace(/\-/g, '')
	  	    + "#closeYmTo#"		+  $("#pchsDtto_S").val().replace(/\-/g, '')
	  	    + "#pchsClmnDay#"	+  $("#pchsClmnDay_S").val()
	  	    + "#deptId#"		+  $("#deptId_S").val()
	  	    + "#deptNm#"		+  $('#deptId_S option:selected').text()
	  	    + "#payDiv#"		+  $("#payDiv").val()
	  	    + "#payDivNm#"		+  $('#payDiv option:selected').text()
	      	+ "#userId#"		+  jwt.userId
	      	+ "#pchsCostDiv#"	+  $("#trunDiv_S").val()
	      	+ "#pchsCostDivNm#"	+  $('#trunDiv_S option:selected').text()
	      	+ "#";                 
		//턴키자료만이면 턴키지급양식(SM2001R02.jrf)으로, 일반구매가공인경우 SM2001R01.jrf
	  	const rtpType = $("#trunDiv_S").val();
	  	var fileName = (rtpType == 'PCHSCOSTDIV1030') ? "SM2001R02.jrf" : "SM2001R01.jrf";
	  	if (_type == '' || _type == 'S' || _type == undefined ) {
	  		var todayDate = new Date().format('yyyyMMddHHmmss')
	  		callReport(fileName, arg, 1150, 720, $('#closeYm_S').val()+'월분_결재내역서'+ todayDate);
	  	} else { //Export 작업
	  		ubiExportAjax(fileName, arg, function(response) {
	  			if (response.resultCode === 200) {
	  				var base64FileData = response.base64FileData;
	  				var fileName = response.exportFileName;
	  				downloadPDFFromBase64(base64FileData, fileName);
	  			} else {
	  				alert('PDF 내보내기 실패: ' + response.resultText);
	  			}

	  		});
	  	}
	  }    

	
</script>