<style>
	* input[comma] {
	  text-align: right;
	 }
	/* 인풋 테이블 2분할 */
	.table_input.type08 tr td:nth-of-type(1) {
		width: 39%;
	}
	
	.table_input.type08 tr td:nth-of-type(2) {
		width: 59%;
	}
	.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
	}
	
	/* 크기 조절되지 않아 임시로 */
	.date_input .input_calendar2 {
		background-color: #fff;
		width: calc(100%) !important;
	}
	
	.input_calendar2 {
		background-color: #fff;
		width: 100% !important;
		background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
		background-size: 13px 13px;
		cursor: pointer
	}
	
	* input[comma] {
	  text-align: right;
	 }
	</style>
	
	<div class="popup_area of_a" style="width: 100%; height: 100%;">
		<div class="tit_contents">
		  <h4 class="tit">발주 등록</h4>
		</div>
	
	  <form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="userId"     	name="userId">
			<input type="hidden" id="pgmId"     	name="pgmId" value="SM701M01">
			<input type="hidden" id="fileTrgtKey"	name="fileTrgtKey" value="">		<!-- file target key -->
		
		  <table>
	
			<colgroup>
			  <col width="11%">
			  <col width="14%">
			  <col width="11%">
			  <col width="14%">
			  <col width="11%">
			  <col width="14%">
			  <col width="11%">
			  <col width="14%">
			</colgroup>
			<tr>
				<td colspan="8" class="title_m_td" style="">발주정보</td>
			</tr>     
			<tr>
				
				<th>발주번호</th>
				<td>
				  <input type="text" id="ordrgNo" name="ordrgNo" msg="발주번호" disabled="disabled">
				</td>
				<th class="hit">구매처</th>
				<td>
					<input type="hidden" id="pchsClntCd" name="pchsClntCd"  data-search="pchsClntCd">
					<div class="search_form">
						<input type="text" id="pchsClntNm" name="pchsClntNm"  data-search="pchsClntNm" onkeyup=""  required="required" msg="구매처"> 
						<a onclick="openClntSearchP('S');"><i class="i_search_w"></i></a>
					</div>
				</td>
				<th class="hit">발주일자</th>
				<td>
							  <div class="date_input">
								<input id="ordrgDt" name="ordrgDt"  class="input_calendar2" autocomplete="off"
								   required="required" msg="발주 시작일자" data-search="ordrgDt">
							  </div>			
				</td>
				<th class="hit">납기요청일자</th>
				<td>
							  <div class="date_input">
								<input id="dudtDeqDt" name="dudtDeqDt"  class="input_calendar2" autocomplete="off"
								 required="required"  msg="납기요청일자" data-search="ordrgDt">
							  </div>			
				</td>
			</tr>            
			<tr>
				<th class="hit">발주구분</th>
				<td>
					<select id="ordrgDiv10" name="ordrgDiv10" data-kind="ORDRGDIV10" data-search="ordrgDiv10"  required="required" msg="발주구분">
					  <option value="">전체</option>
					</select>									  
				</td>
				<th class="hit">용도구분</th>
				<td>
					<select id="ordrgDiv20" name="ordrgDiv20" data-kind="ORDRGDIV20" data-search="ordrgDiv20" required="required" msg="용도구분">
					  <option value="">전체</option>
					</select>	
				</td>
				<th class="hit">특성구분</th>
				<td>
					<select id="ordrgDiv30" name="ordrgDiv30" data-kind="ORDRGDIV30" data-search="ordrgDiv30" required="required" msg="특성구분">
					  <option value="">전체</option>
					</select>				
				</td>
				<th>환율</th>
				<td>
					<input type="text" id="exrate" name="exrate"  data-search="exrate" data-ax5formatter="money" maxlength="13" comma />
				</td>
			</tr>
			<tr>    
				<th class="hit">통화단위</th>
				<td>
					<select id="currCd" name="currCd" data-kind="CURR" data-search="currCd" required="required" msg="통화단위">
					  <option value="">전체</option>
					</select>	
				</td>
				<th>발주금액</th>
				<td>
					<input type="text" id="ordrgAmt" name="ordrgAmt"  data-search="ordrgAmt" onkeyup="" data-ax5formatter="money" maxlength="13" comma readonly="readonly"/>
					<!-- 발주금액은 계산(bom 의 sum) -->
				</td>
				<th>비고</th>
				<td colspan="3">
					<input type="text" id="ordrgRmk" name="ordrgRmk"  data-search="ordrgRmk" onkeyup="">
				</td>
			</tr>    
		   
		  </table>
		</form>
	
		<div class="" style="height: 10px;">
		</div>	    
				
	
	<!-- 하단 디테일그리드 -->
			<!-- 콘텐츠 -->
		  <div class="contents2" style="margin-bottom: 50px;">
			  <!-- 리스트 -->
			  <div class="ax5_grid" style="width: 100%">
				<ul class="ul_list" style="height:250px; width: 100%">
					<li style="width: 100%;">
						<div class="table_list_tit" style="width: 100%;">
							<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
							<div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
								<!--  <a onclick="addRowBom()" style="" authchk>+</a> -->
								<!--<a id="deleteDetailButton" style="" authchk>-</a>-->
							</div>
						</div>
						<div>
							<div data-ax5grid="bom-grid-modal" data-ax5grid-config="{}" style="height:500px; width: 100%" ></div>
						</div>
					</li>
				</ul>	
			</div>
		  </div>
		</div>
	<!-- 하단 디테일그리드 end -->
	
		<!-- 공통 파일 영역 -->
		<div id="fileList_area"></div>
	
		<!-- 하단 버튼 -->
		<div class ="popup_bottom_btn">
			<button type="button" id="actionBtn" authChk>등록</button>
			<button type="button" class="close_btn"
				onclick="modalStack.close();">닫기</button>
		</div>
	
	<script type="text/javascript">
	  
	//전역초기화  
	var actionType = null;
	var paramPrjctSeq = null;
	var firstGrid = null;
	var secondGrid = null;
	var userId = null;
	var userNm = null;
	var fileTrgtKeyU = null;
	
	var gridViewPop = {
			initView: function(){
				this.target = new ax5.ui.grid();
				this.target.setConfig({
					showLineNumber: true,	
					showRowSelector: false,
					multipleSelect: false,
					sortable: false,
					target: $('[data-ax5grid="bom-grid-modal"]'),
					header: {
					  align: "center",
					  selector: false
					},
					body: {
						mergeCells : ["salesCd"],
						onClick: function() {
							this.self.select(this.dindex);
							var row = this.dindex;
							var paramObj = {"row" : row};
							//체크박스일 경우 실행 - 등록모드만
							if( this.column.key == "userChk" && actionType == "C" ) {
								//chk, 수량, 기발주수량, row번호 
								$.setOrdrgQty(gridViewPop, this.item.userChk , this.item.bomQty, this.item.preBomQty, row);                        		
							}
						},
						//그리드값 변경시 실행
						onDataChanged: function () {
							var row = this.dindex;
							var col = this.colIndex;
							var ordrgPrc = 0;
							//체크박스 변경 제외
							if( this.key != "userChk" ) {
	
								var ordrgPrc = (this.item.ordrgPrc=="" || typeof(this.item.ordrgPrc)=="undefined")? 0 : this.item.ordrgPrc;
								// 발주단가, 발주수량  변경시
								if ( this.key == "ordrgPrc" || this.key == "ordrgQty" ) {   			            		
									if( this.item.ordrgQty != "" && this.item.ordrgQty > 0  ) {
										var ordrgAmt = parseInt( deleteCommaStr(this.item.ordrgQty) * deleteCommaStr(ordrgPrc) );
										gridViewPop.target.setValue(row, "ordrgAmt", ordrgAmt);		            			
									} else {
										gridViewPop.target.setValue(row, "ordrgAmt", "");		            			
									}
								}           	
								//발주수량 OVER CHK
								if ( this.key == "ordrgQty") {			            		
									if( this.item.ordrgQty != "" && this.item.ordrgQty > 0  ) {			            			
										var calcuOrdrgQty = parseInt( deleteCommaStr(this.item.bomQty) - deleteCommaStr(this.item.preBomQty) );
										if( this.item.ordrgQty == 0 ) {
											alert("발주수량은 0 보다 커야 합니다.");
											gridViewPop.target.setValue(row, "ordrgQty", "");	
											return;			        
										} else if( calcuOrdrgQty == 0 ) {
											alert("발주 가능 수량이 0입니다.");
											gridViewPop.target.setValue(row, "ordrgQty", "");	
											return;		 			            				
										} else if( calcuOrdrgQty < this.item.ordrgQty   ) {
											//등록일때만 값 초기화
											if( actionType == "C" ) gridViewPop.target.setValue(row, "ordrgQty", "");            			
											alert("발주수량은 "+ calcuOrdrgQty+" (와)과 같거나 작아야 합니다");
											return;
										}
									}
								}	
							}
							
							 
						},					
						onDBLClick: function() {
							//this.self.clearSelect();
							//this.self.select(this.dindex);
							//updateBomMatrModal('U');
						},
				   },
				   footSum: [
						  [
							  {label: "합계", colspan:9, align:"center"},
							  //{key: "bomQty", 			collector: "sum", formatter:"money", align: "center", hidden:true},
							  //{key: "preBomQty",		collector: "sum", formatter:"money", align: "center", hidden:true},
							  //{},
							  {key: "ordrgQty",			collector: "sum", formatter:"money", align: "center"},  		
							  {key: "ordrgPrc",			collector: "sum", formatter:"money", align: "right"},
							  {key: "ordrgAmt",			collector: "sum", formatter:"money", align: "right"},  		
						   ]
					  ],
				   columns: [
							   {key: "fileTrgtKey", 		label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
							,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
							,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
							,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}						
							,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
							,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 	hidden:true}
							,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 	hidden:true}						
							,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 	hidden:true}						
							,{key: "dsgnNo", 			label: "dsgnNo", 			width: 100,		align: "left", 	hidden:true}						
							,{key: "matrCd", 			label: "자재코드", 			width: 100,		align: "left"}		/* 품번 */						
							,{key: "matrNm", 			label: "자재명", 				width: 120,		align: "left"}		/* 품명 */
							,{key: "matrMat", 			label: "소재", 				width: 100,		align: "left"}						
							,{key: "matrMakrNm", 		label: "MAKER", 			width: 100,		align: "left"}	/* 제조사 */					
							,{key: "matrMno", 			label: "형번(Model No)", 		width: 100,		align: "left"}
							,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "left"}
							,{key: "matrTestDiv", 		label: "검사구분", 			width: 100,		align: "center"}	/* 검사구분 */
							,{key: "matrWhCd", 			label: "입고창고Cd", 			width: 100,		align: "center", 	hidden:true}	/* 자재창고 Cd*/						
							,{key: "matrWhNm", 			label: "입고창고", 			width: 100,		align: "center"}	/* 자재창고 */	
							,{key: "bomQty", 			label: "수량", 				width: 80,		align: "center"}			/*수량 */						
							,{key: "preBomQty", 		label: "기발주 수량", 			width: 80,		align: "center"}			/*기발주 수량 */			
							,{key: "userChkV", 			label: "userChkV", 			width: 100,		align: "center", 	hidden:true}	/* 수정시 userChk */
							,{key: "userChk", 			label: "□", 				width: 50,		align: "center"
									, editor:{type: "checkbox"
												, config: {trueValue: "Y", falseValue: "N"}
												, disabled: function () {                            							
													return this.item.userChkV == "Y";
												  }
											}
							}			/*선택 */
							/* display & edit */
							
							,{key: "ordrgQty", 		label: "발주수량", 			width: 80,		align: "right", formatter: "money"
									/* , editor: {type:"number" 
												, attributes: { 'maxlength': 13, 'data-maxlength': 15}
											   }  */
							}
							,{key: "ordrgPrc", 			label: "발주단가", 			width: 110,		align: "right", formatter: "money"
								/* , editor: {type:"number" 
												, attributes: { 'maxlength': 13, 'data-maxlength': 15}
											 }  */
							}
							,{key: "ordrgAmt", 			label: "발주금액", 			width: 110,		align: "right", formatter: "money"
								/*
								, editor: {type:"number" 
												, attributes: { 'maxlength': 13, 'data-maxlength': 15}
										  }
								*/
							}							
							,{key: "dudtDeqDt", 		label: "납기요청일", 			width:  80,		align: "center"
								/* , editor: {type: "date"
											, config: {
														content: {
																	config: { mode: "day", selectMode: "day" }
																  }
														}
										  } */
							}
							,{key: "dudtIntendDt", 		label: "납기예정일", 			width:  80,		align: "center", editor: {type: "date"},	}	
					  ]
				});
				return this;
			},
			setData: function(_pageNo) {
				//debugger;
				var targetObj = this.target;
				var formData = new FormData();
				var row = gridView.target.getList("selected")[0];
				//var salesCd = $('#salesCd').val();
				//var fileTrgtKey = (fileTrgtKeyU) ? fileTrgtKeyU : 0;
				//var ordrgNo = $('#ordrgNo').val();
				var formData = {
					//"fileTrgtKey" : fileTrgtKey,
					"coCd"        : row.coCd,
					"salesCd"     : row.salesCd,
					"ordrgNo" 	  : row.ordrgNo,
					"ordrgSeq"	  : row.ordrgSeq
					/* "ordrgSeq" : ordrgSeq		단독수정은 없음*/
				}
				//debugger;
				//등록과 수정 URL 다르게  
				//postAjax("/user/sm/sm07/selectOrderDetailList" , formData, null, function(data){
				postAjax("/user/sm/sm02/selectOrderDetailList" , formData, null, function(data){	
				var list = data.resultList;
				
				targetObj.setData({
					list : list,
					page : {
							totalElements : list.length
						} 
					});
				});
			} 
		}
	
	// 권한체크    
	authChk();		
		
	//구매 BOM
	gridViewPop.initView();	 	
	
	//등록/수정 버튼
	actionType = modalStack.last().paramObj.actionType;
	if (actionType == "C") {
			
	} else if (actionType == "U") {
		//debugger;
		$('.tit_contents .tit').text('발주 수정')
		
		$('#actionBtn').text("수정");
		$('#actionBtn').on("click", function() {
			updateOrder();
		});
	}
	
	
	$(document).ready(function() {
		$.initViewPop = function() {
			
			//combo set
			setCommonSelect($(".popup_area select[data-kind]"));
			userId = modalStack.last().paramObj.userId;
			fileTrgtKeyU = modalStack.last().paramObj.fileTrgtKey;
			
			//modal 넘어온값만큼 만큼 루프 
			$.each(modalStack.last().paramObj, function (key, val) {		
				if( $("#popForm").find("#"+key).length > 0 ) {
					//$("#popForm").find("#"+key).val(val);
				}
			});
			
			$("#popForm #userId").val(userId);	
			//작성자 readonly 등 set
			$("#salesCd").attr("readonly", true);
			
			//formatter
			$('[data-ax5formatter]').ax5formatter();

			actionType = modalStack.last().paramObj.actionType;
			
			if(actionType == "U") {
				//그리드 load
				gridViewPop.initView().setData(0);
				
				
				let editVal = {};
				postAjaxSync("/user/sm/sm02/selectOrderDetailView", modalStack.last().paramObj, null
					, function(data){
					
					var list = data.resultList;
		 				if( list.length > 0 ) {
					        $.each(list[0], function (key, val) {	
					        	debugger;
					        	//html element overwrite set								
								if( val && typeof($("#popForm #"+key).attr("name")) != "undefined" ) {
									$("#popForm #"+key).val(val);
									editVal[key] = val;									

								}
							});			
						} 
				});	
				
				
				//chkbox 삭제 - 합계 틀어짐
				//gridViewPop.target.removeColumn(18);	
				//sale code readonly
				$("#salesCd").attr("readonly", true);
				//wbsSalesCodeSearchP();
				$("#salesCdAnchor").removeAttr("onclick");
				
				//발주번호
				$("#ordrgNo").prop("readonly", true);

				//구매처 pchsClntCd
				$("#pchsClntCd").prop("disabled", true);
				$("#pchsClntNm").prop("disabled", true);

				//발주일자 ordrgDt
				$("#ordrgDt").prop("disabled", true);

				//납기요청일자 
				$("#dudtDeqDt").prop("disabled", true);

				//발주구분 
				$("#ordrgDiv10").prop("disabled", true);

				//용도구분 ordrgDiv20
				$("#ordrgDiv20").prop("disabled", true);

				//특성구분 ordrgDiv30
				$("#ordrgDiv30").prop("disabled", true);

				//환율 exrate
				$("#exrate").prop("disabled", true);

				//통화단위 currCd
				$("#currCd").prop("disabled", true);

				//발주금액 ordrgAmt
				//$("#ordrgAmt").prop("disabled", true);

				//비고 ordrgRmk
				$("#ordrgRmk").prop("disabled", true);

				//checkbox
				gridViewPop.target.removeColumn(21);
				//userChk
				gridViewPop.target.removeColumn(20);
				//기발주 수량
				gridViewPop.target.removeColumn(19);
				//수량
				gridViewPop.target.removeColumn(18);
				
				//debugger;


				/* $('.tit_contents .tit').text('발주 수정')
		
				$('#actionBtn').text("수정");
				$('#actionBtn').on("click", function() {
					updateOrder();
				}); */
				
			}
			
		}
	
		$.initViewPop();
		
	});

	//수정 
	function updateOrder() {
		//debugger;
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			
			filePostAjax("/user/sm/sm07/updateOrderDetail", formData, 
					function(data) {
					//debugger;
					alert(data.resultMessage);
	
					if (data.resultCode == 200) {
						gridView.setData(0);
						modalStack.close();
					}
				});
		}
	}

	/* function updateOrder() {
			
		if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
			var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			var makeArr = {};
			//저장용 배열 push
			makeArr = $.gridInsertArr(gridViewPop);
			if( !makeArr ) {
				return;
			}
			if(makeArr.length<1) {
				alert("구매 BOM 항목은 최소 1개 이상이어야 합니다.");
				return;
			} else {
				//발주번호 set
				formData.append("ordrgNo", $("#ordrgNo").val());			
				formData.append("makeArr", JSON.stringify(makeArr));
			}          
			filePostAjax("/user/sm/sm07/updateOrder", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
				function(data) {
					alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
					if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
						gridView.setData(0);
						modalStack.close();									// 모달을 닫음
					}
			});
		}
	} */

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		// 기본값 set
		formData.append("userId", jwt.userId);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
	
		/* formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
	
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr())); */
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 
		
		//상세자료 준비
        detailArr = [];

		var list = gridViewPop.target.list;
		//debugger;
		$.each(list,function(idx, obj) {
			//신규
			
			if (obj.dudtIntendDt != null && obj.userChkV == 'Y') {
				obj.dataChk = 'U';
				detailArr.push(obj);
			}
			
			//수정			
 			 if (obj.dataChk == 'U') {				
				detailArr.push(obj);
 			  } 
		});
		//debugger;
		formData.append("detailArr", JSON.stringify(detailArr));//선택된 ROW 만 formData에 저장
		//상세자료 끝

		return formData;	
	}
	
	/* 
	var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	//---------------------------------------------------------------  
	//첨부 화일 처리 시작 
	//---------------------------------------------------------------  
	fileParam = {
			fileTrgtTyp	: $("#pgmId").val(),
			fileTrgtKey : param_fileTrgtKey
	}
			treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
	//---------------------------------------------------------------  
	//첨부 화일 처리 끝
	//--------------------------------------------------------------- */


	// 거래처 검색
	function openClntSearchP(openType) {
			var searchValueM = null;
			// P:고객사, S:구매처
			if(openType == "P") {
				searchValueM = $("#clntNm").val();
			} else if(openType == "S") {
				searchValueM = $("#pchsClntNm").val();
			}	
			var paramObj = {
					"searchValue" :  searchValueM
					, "clntDivCd" : "CLNTDIV12"		/*거래처 검색 기본값 고객사로 세팅 */
					, "pchsClntCd" : "CLNTDIV12"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
			}		
			if(openType == "S") {
				paramObj.clntDivCd = null;
			}
			//발주관리에서 호출 플래그 추가
			paramObj.orderFlag = "Y";		
			openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];
				//고객사 콤보 세팅
				if(openType == "P"){
					$('#clntCd').val(row.clntCd);
					$('#clntNm').val(row.clntNm);
				//구매처 콤보세팅
				} else if(openType == "S"){
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
				}
			});
		} 
	</script>