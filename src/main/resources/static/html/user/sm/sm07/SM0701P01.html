<style>
	.title_m_td {
		text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
	}
	
	/* 크기 조절되지 않아 임시로 */
	.date_input .input_calendar2 {
		background-color: #fff;
		width: calc(100%) !important;
	}
	
	.input_calendar2 {
		background-color: #fff;
		width: 100% !important;
		background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
		background-size: 13px 13px;
		cursor: pointer
	}
	
	* input[comma] {
		text-align: right;
	}
</style>

<!-- div의 popup_area 클래스 하위인 form popForm ID에서 모든 html이 이루어진다. -->
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">공급업체 확인</h4>
	</div>
	
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="userId"      name="userId">
			<input type="hidden" id="pgmId"       name="pgmId" value="SM701M01">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">		<!-- file target key -->
			
			<table>
				<colgroup>
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
				</colgroup>
				
				<tr>
					<td colspan="8" class="title_m_td">발주정보</td>
				</tr>
				
				<tr class="vendInquery">
					<th>발주번호</th>
					<td>
						<input type="hidden"	id="coCd" name = "coCd" readonly="readonly">
						<input type="text" id="ordrgNo" name="ordrgNo" msg="발주번호" disabled="disabled">
					</td>
					
					<th class="">구매처</th>
					<td>
						<input type="hidden" id="pchsClntCd" name="pchsClntCd"  data-search="pchsClntCd">
						<div class="search_form">
							<input type="text" id="pchsClntNm" name="pchsClntNm"  data-search="pchsClntNm" onkeyup=""  required="required" msg="구매처">
							<a onclick="openClntSearchP('S');"><i class="i_search_w"></i></a>
						</div>
					</td>
					
					<th class="">발주일자</th>
					<td>
						<div class="date_input">
							<input id="ordrgDt" name="ordrgDt"  class="input_calendar2" autocomplete="off"
							required="required" msg="발주 시작일자" data-search="ordrgDt">
						</div>
					</td>
					
					<th class="">납기요청일자</th>
					<td>
						<div class="date_input">
							<input id="dudtDeqDt" name="dudtDeqDt"  class="input_calendar2" autocomplete="off" data-search="ordrgDt">
						</div>
					</td>
				</tr>
				
				<tr class="vendInquery">
					<th class="">발주구분</th>
					<td>
						<select id="ordrgDiv10" name="ordrgDiv10" data-kind="ORDRGDIV10" data-search="ordrgDiv10" >
							<!-- <option value="">전체</option> -->
						</select>
					</td>
					
					<th class="">용도구분</th>
					<td>
						<select id="ordrgDiv20" name="ordrgDiv20" data-kind="ORDRGDIV20" data-search="ordrgDiv20" >
							<!-- <option value="">전체</option> -->
						</select>
					</td>
					
					<th class="">특성구분</th>
					<td>
						<select id="ordrgDiv30" name="ordrgDiv30" data-kind="ORDRGDIV30" data-search="ordrgDiv30" >
							<!-- <option value="">전체</option> -->
						</select>
					</td>
					
					<th>환율</th>
					<td>
						<input type="text" id="exrate" name="exrate"  data-search="exrate" data-ax5formatter="money" maxlength="13" comma >
					</td>
				</tr>
				
				<tr class="vendInquery">
					<th>발주금액</th>
					<td>
						<input type="text" id="ordrgAmt" name="ordrgAmt"  data-search="ordrgAmt" onkeyup="" data-ax5formatter="money" maxlength="13" comma readonly="readonly" >
						<!-- 발주금액은 계산(bom 의 sum) -->
					</td>
					
					<th>비고</th>
					<td colspan="3">
						<input type="text" id="ordrgRmk" name="ordrgRmk"  data-search="ordrgRmk" onkeyup="">
					</td>
					
					<th class="">통화단위</th>
					<td>
						<select id="currCd" name="currCd" data-kind="CURR" data-search="currCd" comma>
							<!-- <option value="">전체</option> -->
						</select>
					</td>
				</tr>
			</table>
		</div>
	</form>
	
	<div class="" style="height: 10px;"></div>
	
	<!-- 하단 디테일그리드 -->
	<!-- 콘텐츠 -->
	<div class="contents2" style="margin-bottom: 50px;">
		<!-- 리스트 -->
		<div class="ax5_grid" style="width: 100%">
			<ul class="ul_list" style="height:250px; width: 100%">
				<li style="width: 100%;">
					<div class="table_list_tit" style="width: 100%;">
						<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
						<div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
							<!--  <a onclick="addRowBom()" style="" authchk>+</a> -->
							<!--<a id="deleteDetailButton" style="" authchk>-</a>-->
						</div>
					</div>
					
					<div>
						<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height:300px; width: 100%" ></div>
					</div>
				</li>
			</ul>
		</div>
	</div>
	
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>수정</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>
<!-- 하단 디테일그리드 end -->

<script type="text/javascript">
	/*전역 변수들은  상단에 작성*/
	//전역초기화
	var actionType = null;
	var userId = null;
	var userNm = null;
	var fileTrgtKeyU = null;
	
	var gridViewPop = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="first-grid-modal"]'),
				header: {
					align: "center",
					selector: false
				},
				body: {
					mergeCells : ["salesCd"],
					onClick: function() {
						
					},
					onDataChanged: function () {
						
					},
					onDBLClick: function() {
						
					},
				},
				footSum: [
					[
						{label: "합계", colspan:9, align:"center"},
						{key: "ordrgQty",			collector: "sum", formatter:"money", align: "center"},
						{key: "ordrgPrc",			collector: "sum", formatter:"money", align: "right"},
						{key: "ordrgAmt",			collector: "sum", formatter:"money", align: "right"},
					]
				],
				columns: [
					{key: "fileTrgtKey", 		label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
					,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
					,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
					,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}
					,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
					,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 	hidden:true}
					,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 	hidden:true}
					,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 	hidden:true}
					,{key: "dsgnNo", 			label: "dsgnNo", 			width: 100,		align: "left", 	hidden:true}
					,{key: "matrCd", 			label: "자재코드", 			width: 90,		align: "center"}    /* 품번 */
					,{key: "matrNm", 			label: "자재명", 				width: 120,		align: "left"}    /* 품명 */
					,{key: "matrMat", 			label: "소재/MAKER", 			width: 140,		align: "left"}
// 					,{key: "matrMakrNm", 		label: "MAKER", 			width: 100,		align: "left"}    /* 제조사 */
// 					,{key: "matrMno", 			label: "형번(Model No)", 		width: 100,		align: "left"}
					,{key: "matrSpec", 			label: "규격", 				width: 120,		align: "left"}	
					,{key: "matrSize", 			label: "크기",		 		width: 100,		align: "left"}
					,{key: "matrTestDiv", 		label: "검사구분", 			width: 100,		align: "center"}    /* 검사구분 */
					,{key: "matrWhCd", 			label: "입고창고Cd", 			width: 100,		align: "center", 	hidden:true}    /* 자재창고 Cd*/
					,{key: "matrWhNm", 			label: "입고창고", 			width: 100,		align: "center"}    /* 자재창고 */
					,{key: "ordrgQty", 			label: "발주수량", 			width: 80,		align: "right", formatter: "money"}
					,{key: "ordrgPrc", 			label: "발주단가", 			width: 110,		align: "right", formatter: "money"}
					,{key: "ordrgAmt", 			label: "발주금액", 			width: 110,		align: "right", formatter: "money"}
					,{key: "dudtDeqDt", 		label: "납기요청일", 			width:  80,		align: "center"}
					,{key: "dudtIntendDt", 		label: "납기예정일", 			width:  100,		align: "center", editor: {type: "date"} }
				]
			});
			return this;
		},
		setData: function(_pageNo) {
			var targetObj = this.target;
			
			//row ~ 이 작업은 해당 마스터 페이지에서 클릭한 값 이라 다른 페이지에서 값을 가지고 와야하므로 파라미터로 수정
			//var row = gridView.target.getList("selected")[0];  //파라미터 수정
			var formData = modalStack.last().paramObj;
			
			//등록과 수정 URL 다르게
			postAjax("/user/sm/sm02/selectOrderDetailList" , formData, null, function(data) {
				var list = data.resultList;
				gridResize(list.length); //그리드 높이 조정
				targetObj.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
			});
		}
	}
	
	/*	body가 끝나고 나서  jquery의 실행스크립트를 시작*/
	$(document).ready(function() {
		//combo set
		setCommonSelect($(".popup_area select[data-kind]"));
		$("#coCd").val(modalStack.last().paramObj.coCd);
		
		userId = modalStack.last().paramObj.userId;
		$("#popForm #userId").val(userId);
		
		fileTrgtKeyU = modalStack.last().paramObj.fileTrgtKey;
		actionType = modalStack.last().paramObj.actionType;
		
		//구매 BOM
		gridViewPop.initView();
		
		//등록/수정 버튼
		if (actionType == "C") {
			
		} else if (actionType == "U") {
			$('.tit_contents .tit').text('공급업체 확인')
			
			$('#actionBtn').on("click", function() {
				updateOrder();
			});
			
			initViewPop(actionType); //initViewPop호출
		}
		
		//TR 아래 모든 자식 input 태그 입력 금지 처리
		$('.vendInquery').find('input').prop('disabled', true);
		//TR 아래 모든 자식 combox 태그 입력 금지 처리
		$('.vendInquery').find('select').prop('disabled', true);
		
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp : $("#pgmId").val(),
			fileTrgtKey : fileTrgtKeyU
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		// 권한체크
		authChk();
	});
	
	function initViewPop(actionType) {
		if(actionType == "U") {
			// debugger;
			postAjaxSync("/user/sm/sm02/selectOrderDetailView", modalStack.last().paramObj, null, function(data) {
				var list = data.resultList;
				
				if( list.length > 0 ) {
					$.each(list[0], function (key, val) {
						//html element overwrite set
						if( val && typeof($("#popForm #"+key).attr("name")) != "undefined" ) {
							$("#popForm #"+key).val(val);
							
							//양수, 음수, 소수점 포함 원단위 포맷 적용
							if ($('#popForm #' + key).is('[comma]')) {
								onlyNumber($('#popForm #' + key)[0]);
							}
						}
					});
				}
			});
			gridViewPop.setData();
		}
	}
	
	//수정
	function updateOrder() {
		// 필수 필드의 유효성 검사
		if (inputValidation($('.popup_area [required]'))) {
			// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			var formData = makeFormData();
			filePostAjax("/user/sm/sm07/updateOrderDetail", formData, function(data) {
				alert(data.resultMessage);
				if (data.resultCode == 200) {
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});

		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});

		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
// 		console.log(formData);

		// 기본값 set
		//formData.append("userId", jwt.userId);
		 
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#clntCd').val());			//첨부화일용
		formData.append("prdtCd" , $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd" , $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------
		   
		//상세자료 준비
        detailArr = [];

		var list = gridViewPop.target.list;
		
		$.each(list,function(idx, obj) {
			//신규			
			if (obj.dudtIntendDt != null && obj.userChkV == 'Y') {
				obj.dataChk = 'U';
				detailArr.push(obj);
			}
			
			//수정
			if (obj.dataChk == 'U') {
				detailArr.push(obj);
			}
		});
		// debugger;
		formData.append("detailArr", JSON.stringify(detailArr)); //선택된 ROW 만 formData에 저장
		//상세자료 끝

		return formData;	
	}

	function gridResize(size) {
		// debugger;
	    var tagHeight = ((size + 1) * 27) + 50 ;
		tagHeight = tagHeight > 300 ? tagHeight : 300;
		
		$('[data-ax5grid="first-grid-modal"]').height(tagHeight);
		$('[data-ax5grid="first-grid-modal"] [data-ax5grid-container="root"]').height(tagHeight);
	}
	
	</script>