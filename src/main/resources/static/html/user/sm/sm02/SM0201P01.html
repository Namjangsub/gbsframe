<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
}

/* 크기 조절되지 않아 임시로 */
.date_input .input_calendar2 {
    background-color: #fff;
    width: calc(100%) !important;
}

.input_calendar2 {
    background-color: #fff;
    width: 100% !important;
    background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
    background-size: 13px 13px;
    cursor: pointer
}
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">발주 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
      <input type="hidden" id="ordrgNo"  name="ordrgNo">
      <input type="hidden" id="pgmId"     name="pgmId" value="SM0201M01">
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
        	<td colspan="8" class="title_m_td">기본정보</td>
        </tr>
        <tr>
			<th class="hit">회사</th>
			<td>
			  <select id="coCd" name="coCd" data-kind="CO" data-search="coCd" required="required" msg="회사">
			  </select>
			</td>
			<th class="hit">Sales Code</th>
			<td>
				<div class="search_form">
				    <input type="text" id="salesCd" name="salesCd" data-search="salesCd" required="required" msg="Sales Code">
				   	<a onclick="wbsSalesCodeSearchP();"><i class="i_search_w"></i></a>
			    </div>
			</td>
			<th>고객사</th>
			<td>
				<input type="hidden" id="clntCd" name="clntCd" data-search="clntCd">
				<div class="search_form">
					<input type="text" id="clntNm" name="clntNm" data-search="clntNm"> 
					<a onclick="openClntSearchP('P');"><i class="i_search_w"></i></a>
				</div>			
			</td>
			<th>고객사PJT</th>
			<td>
				<input type="text" id="clntPjt" name="clntPjt" data-search="clntPjt" msg="고객사PJT"> 
			</td>			
        </tr>
        <tr>
			<th>제품구분</th>
			<td>
				<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" msg="제품구분">
				<div class="search_form">				
				<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtCdNm" msg="제품구분">
				<a onclick="openPrdtSearchP();"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th>아이템구분</th>
			<td>
				<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv">
			      <option value="">전체</option>
				</select>	
			</td>
			<th>설비명</th>
			<td colspan="0">
				<input type="text" id="eqpNm" name="eqpNm" data-search="reqNo" msg="설비명">
			</td>
			<th>요인별요청번호</th>
			<td>
				<input type="text" id="reqNo" name="reqNo" data-search="reqNo" msg="설비명">
			</td>			
        </tr>
        
        <tr>
        	<td colspan="8" class="title_m_td" style="">발주정보</td>
        </tr>     
        <tr>
			<th>발주번호</th>
			<td>
			  <input type="text" id="ordrgNo" name="ordrgNo_P" msg="" disabled="disabled">
			</td>
			<th class="hit">구매처</th>
			<td>
				<input type="hidden" id="pchsClntCd" name="pchsClntCd"  data-search="pchsClntCd">
				<div class="search_form">
					<input type="text" id="pchsClntNm" name="pchsClntNm"  data-search="pchsClntNm" onkeyup=""  required="required" msg="구매처"> 
					<a onclick="openClntSearchP('S');"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th class="hit">발주일자</th>
			<td>
			              <div class="date_input">
			                <input id="ordrgDt" name="ordrgDt"  class="input_calendar2" autocomplete="off"
			                   required="required" msg="발주 시작일자" data-search="ordrgDt">
			              </div>			
			</td>
			<th class="hit">납기요청일자</th>
			<td>
			              <div class="date_input">
			                <input id="dudtDeqDt" name="dudtDeqDt"  class="input_calendar2" autocomplete="off"
			                 required="required"  msg="납기요청일자" data-search="ordrgDt">
			              </div>			
			</td>
        </tr>            
        <tr>
			<th class="hit">발주구분</th>
			<td>
				<select id="ordrgdiv10" name="ordrgdiv10" data-kind="ORDRGDIV10" data-search="ordrgdiv10"  required="required" msg="발주구분">
			      <option value="">전체</option>
				</select>									  
			</td>
			<th class="hit">용도구분</th>
			<td>
				<select id="ordrgdiv20" name="ordrgdiv20" data-kind="ORDRGDIV20" data-search="ordrgdiv20" required="required" msg="용도구분">
			      <option value="">전체</option>
				</select>	
			</td>
			<th class="hit">특성구분</th>
			<td>
				<select id="ordrgdiv30" name="ordrgdiv30" data-kind="ORDRGDIV30" data-search="ordrgdiv30" required="required" msg="특성구분">
			      <option value="">전체</option>
				</select>				
			</td>
			<th>환율</th>
			<td>
				<input type="text" id="exrate" name="exrate"  data-search="exrate" onkeyup="">
			</td>
        </tr>
        <tr>    
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" data-search="currCd" required="required" msg="통화단위">
			      <option value="">전체</option>
				</select>	
			</td>
			<th>발주금액</th>
			<td>
				<input type="text" id="ordrgAmt" name="ordrgAmt"  data-search="ordrgAmt" onkeyup="">
			</td>
			<th>비고</th>
			<td colspan="3">
				<input type="text" id="ordrgRmk" name="ordrgRmk"  data-search="ordrgRmk" onkeyup="">
			</td>
        </tr>    
       
      </table>
    </form>

	<div class="" style="height: 10px;">
	</div>	    
  

	<!-- 공통 파일 영역 -->
        <div class="col-sm-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 250px;padding: 5px">
                    <div id="deptTreeOrdars"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
                <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 250px; width: 100%"></div>
            </div>
        </div>
        	

<!-- 하단 디테일그리드 -->
		<!-- 콘텐츠 -->
	  <div class="contents2" style="margin-top: 10px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:250px; width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <a onclick="addRowBom()" style="" authchk>+</a>
		                    <a onclick="delRowBom()" style="" authchk>-</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="bom-grid-modal" data-ax5grid-config="{}" style="height:250px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>
<!-- 하단 디테일그리드 end -->

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
  
//전역초기화  
var actionType = null;
var paramPrjctSeq = null;

var firstGrid = null;
var secondGrid = null;


var gridViewPop = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,	
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="bom-grid-modal"]'),
				header: {
	              align: "center",
	              selector: false
	            },
	            body: {
	            	mergeCells : ["coNm", "salesCd", "partNo", "unitNo", "revNo","dsgnNo"],
					onClick: function() {
					    this.self.select(this.dindex);
					    var row = this.dindex;
                        var paramObj = {"row" : row};                        
					},
					onDBLClick: function() {
						//this.self.clearSelect();
                        //this.self.select(this.dindex);
                    	//updateBomMatrModal('U');
					},
			   },

	           columns: [
				 	 	 {key: "fileTrgtKey", 		label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
						,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
						,{key: "partNo", 			label: "파트번호", 			width:  70,		align: "center"}
						,{key: "unitNo", 			label: "유닛번호", 			width:  70,		align: "center"}
						,{key: "revNo", 			label: "리버전", 				width:  70,		align: "center"}
						,{key: "dsgnNo", 			label: "도번", 				width: 180,		align: "left"}
						,{key: "lvl", 				label: "레벨", 				width:  50,		align: "center",	hidden:true}
						,{key: "matrSeq", 			label: "자재순번", 			width:  70,		align: "center"}
						,{key: "upperCd", 			label: "상위코드", 			width: 180,		align: "left",		hidden:true}
						,{key: "lowerCd", 			label: "하위코드", 			width: 180,		align: "left",		hidden:true}
						,{key: "ordrgDiv10", 		label: "발주용도", 			width: 100,		align: "center"}
						,{key: "ordrgDiv20", 		label: "발주유형", 			width: 100,		align: "center"}
						,{key: "nextPrcsnNm", 		label: "후행업체", 			width: 100,		align: "center"}
						,{key: "dlvplcNm", 			label: "배송처", 				width: 100,		align: "center"}
						,{key: "matrCd", 			label: "자재코드", 			width: 100,		align: "left"}
						,{key: "matrNm", 			label: "자재명", 				width: 120,		align: "left"}
						,{key: "goodsDiv", 			label: "제품/자재구분", 			width: 100,		align: "center"}
						,{key: "matrClntDiv", 		label: "거래처구분", 			width: 100,		align: "center"}
						,{key: "matrDiv", 			label: "자재유형", 			width: 100,		align: "center"}
						,{key: "matrGrp", 			label: "자재분류-자재그룹", 		width: 100,		align: "center"}
						,{key: "matrMat", 			label: "소재", 				width: 100,		align: "center"}
						,{key: "matrSize", 			label: "크기", 				width: 100,		align: "center"}
						,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "left"}
						,{key: "matrMakrNm", 		label: "제조사", 				width: 100,		align: "center"}
						,{key: "matrMno", 			label: "형번(Model No)", 		width: 100,		align: "center"}
						,{key: "matrWt", 			label: "중량", 				width: 100,		align: "center"}
						,{key: "matrUnit", 			label: "단위", 				width: 100,		align: "center"}
						,{key: "originNm", 			label: "원산지", 				width: 100,		align: "center"}
						,{key: "matrDrwNo", 		label: "대표도면", 			width: 100,		align: "center"}
						,{key: "matrTestDiv", 		label: "입고검사구분", 			width: 100,		align: "center"}
						,{key: "dlvrRqmDay", 		label: "납품소요일자", 			width: 100,		align: "center"}
						,{key: "matrPurcDiv", 		label: "구매/외주구분", 			width: 100,		align: "center"}
						,{key: "minOrdrgQty", 		label: "최소발주량", 			width: 100,		align: "center"}
						,{key: "matrSaftQty", 		label: "안전재고", 			width: 100,		align: "center"}
						,{key: "matrStockCd", 		label: "재고관리여부", 			width: 100,		align: "center"}
						,{key: "dsgn2DMd", 			label: "2D설계소요일", 			width: 100,		align: "center"}
						,{key: "avrg2DMd", 			label: "2D평균소요일", 			width: 100,		align: "center"}
						,{key: "dsgn3DMd", 			label: "3D설계소요일", 			width: 100,		align: "center"}
						,{key: "avrg3DMd", 			label: "3D평균소요일", 			width: 100,		align: "center"}
						,{key: "prdctnRqmMd", 		label: "생산소요일", 			width: 100,		align: "center"}
						,{key: "prdctnAvrgMd", 		label: "생산평균소요일", 			width: 100,		align: "center"}
						,{key: "useYn", 			label: "사용여부", 			width: 100,		align: "center"}
						,{key: "matrPartNo", 		label: "파트번호", 			width: 100,		align: "center"}
						,{key: "pchsClntCd1", 		label: "구매업체1", 			width: 100,		align: "center"}
						,{key: "pchsClntPct1", 		label: "구매업체1%", 			width: 100,		align: "center"}
						,{key: "pchsClntCd2", 		label: "구매업체2", 			width: 100,		align: "center"}
						,{key: "pchsClntPct2", 		label: "구매업체2%", 			width: 100,		align: "center"}
						,{key: "pchsClntCd3", 		label: "구매업체3", 			width: 100,		align: "center"}
						,{key: "pchsClntPct3", 		label: "구매업체3%", 			width: 100,		align: "center"}
						,{key: "matrUpr", 			label: "최종구매단가", 			width: 100,		align: "center"}
						,{key: "matrAvrgUpr", 		label: "평균구매단가", 			width: 100,		align: "center"}
						,{key: "matrRmk", 			label: "비고", 				width: 100,		align: "center"}
						,{key: "matrLastTrstDt", 	label: "최종거래일자", 			width: 100,		align: "center"}
						,{key: "matrAtntCd", 		label: "대체자재코드", 			width: 100,		align: "center"}
						,{key: "matrNo", 			label: "자재번호", 			width: 100,		align: "center"}
	              ]
	        });
			return this;
    	},
		setData: function(_pageNo) {
		var targetObj = this.target;
        	var formData = new FormData();
        	var salesCd = $('#salesCd').val();
        	var formData = {
				"fileTrgtKey" : 0,
				"salesCd" : salesCd,
			}
			postAjax("/user/sm/sm01/selectBomDetailList", formData, null, function(data){
			var list = data.resultList;
			targetObj.setData({
				list : list,
			    page : {
                	//currentPage : _pageNo,
                    //pageSize : data.paginationInfo.pageSize,
                    //totalElements : data.paginationInfo.totalRecordCount,
                    //totalPages : data.paginationInfo.totalPageCount
			    		totalElements : list.length,
			    	} 
				});
			
            });
      	   
		} 
	}

// 권한체크    
authChk();		
	
//구매 BOM
gridViewPop.initView();	 	

//등록/수정 버튼
actionType = modalStack.last().paramObj.actionType;
if (actionType == "C") {
	$("#actionBtn").text("등록");
	$('#actionBtn').on("click", function() {
		insertOrder();
	});

} else if (actionType == "U") {
	$('.tit').text('발주 수정')
	
	//그리드 load
	gridViewPop.initView().setData(0);

	$('#actionBtn').text("수정");
	$('#actionBtn').on("click", function() {
		updateOrder();
	});
}	

// 등록 - done
function insertOrder() {
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		//makeArr = $.gridInsertArr(gridViewPop);	
        
		filePostAjax("/user/sm/sm02/insertOrderMaster", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					modalStack.close();									// 모달을 닫음
				}
		});
	}
}

//Sales Code (수주마스터, 수주상세테이블 조인) 검색
function wbsSalesCodeSearchP() {
    var paramObj = {
       "coCd" : $('#coCd').val(),
       "salesCd": $('#salesCd').val()
    };
    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        $('#salesCd').val(row.salesCd);
        //임시 set
        alert('임시데이터용 set');
        $('#salesCd').val('23001-01HTFUP');
        
    	gridViewPop.initView().setData(0);
    });
}
 
//제품구분 검색 
function openPrdtSearchP(){
	var paramObj = {	
			"searchValue" : $("#prdtCdNm").val()
	}
	openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];
		$("#prdtCd").val(row.prdtCd);
		$("#prdtCdNm").val(row.prdtNm);
	});
}	


// 거래처 검색
function openClntSearchP(openType) {
	var searchValueM = null;
	// P:고객사, S:구매처
	if(openType == "P") {
		searchValueM = $("#clntNm").val();
	} else if(openType == "S") {
		searchValueM = $("#pchsClntNm").val();
	}	
	var paramObj = {
			"searchValue" :  searchValueM
			, "clntDivCd" : "CLNTDIV12"		/*거래처 검색 기본값 고객사로 세팅 */
			, "pchsClntCd" : "CLNTDIV12"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
	}		
	if(openType == "S") {
		paramObj.clntDivCd = null;
	}
	//발주관리에서 호출 플래그 추가
	paramObj.orderFlag = "Y";		
	openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];
		//고객사 콤보 세팅
		if(openType == "P"){
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);
		//구매처 콤보세팅
		} else if(openType == "S"){
			$('#pchsClntCd').val(row.clntCd);
			$('#pchsClntNm').val(row.clntNm);
		}
	});
} 

function makeFormData() {
	// 금액 콤마 제거
	$.each($('.popup_area input[comma]'), function(idx, elem) {
		deleteComma(elem);
	});
	// 날짜 하이픈 제거
	$.each($('.popup_area input[date]'), function(idx, elem) {
		deleteHyphen(elem);
	});
	// 폼데이터 생성
	var formData = new FormData($("#popForm")[0]);
	// 기본값 set
	formData.append("userId", jwt.userId);
	return formData;	
}

$(document).ready(function() {
	setCommonSelect($(".popup_area select[data-kind]"));

	let today = moment(new Date());
	let yesterday = moment(new Date()).add(-1, 'days');	
	// 발주일자
	$('#ordrgDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
	.datepicker("setDate", today.toDate());
			
	// 납기요청일자
	$('#dudtDeqDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
	.datepicker("setDate", yesterday.toDate())	
	
	var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	//---------------------------------------------------------------  
	//첨부 화일 처리 시작 
	//---------------------------------------------------------------  
	fileParam = {
			fileTrgtTyp	: $("#pgmId").val(),
			fileTrgtKey : param_fileTrgtKey
	}
			treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
	//---------------------------------------------------------------  
	//첨부 화일 처리 끝
	//---------------------------------------------------------------
	
	
	//sale Code keyup 이벤트
	$("#salesCd").on("keyup", function () {
		if(event.keyCode == 8) {
			$("#salesCd").val('');
		} else if(event.keyCode == 13) { 
			gridViewPop.setData(0); 
		}		
	});	
	
});
</script>