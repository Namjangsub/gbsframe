<style>
* input[comma] {
  text-align: right;
 }
/* 인풋 테이블 2분할 */
.table_input.type08 tr td:nth-of-type(1) {
    width: 39%;
}

.table_input.type08 tr td:nth-of-type(2) {
    width: 59%;
}
.title_m_td {text-align:left; height:25px; background:#fff; font-weight:bold; color:blue; padding:5px;
}

/* 크기 조절되지 않아 임시로 */
.date_input .input_calendar2 {
    background-color: #fff;
    width: calc(100%) !important;
}

.input_calendar2 {
    background-color: #fff;
    width: 100% !important;
    background: url("../../../../img/svg/calendar-alt-regular.svg") no-repeat 95% 50%;
    background-size: 13px 13px;
    cursor: pointer
}

</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">발주 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId" value="SM0201P01">
		<input type="hidden" id="fileTrgtKey"	name="fileTrgtKey" value="">		<!-- file target key -->		
		<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
		<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->		
<!-- 		<input type="hidden" id="dudtDeqDt"	name="dudtDeqDt" value="">		납기요청일	 -->
      <table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
        	<td colspan="8" class="title_m_td">수주정보</td>
        </tr>
        <tr>
			<th class="hit">회사</th>
			<td>
			  <select id="coCd" name="coCd" data-kind="CO" data-search="coCd" required="required" msg="회사">
			  </select>
			</td>
			<th>Sales Code</th>
			<td>
				<!-- 요인별요청번호 사용으로 강제함 20230921 -->
				<!-- 
				<div class="search_form">
				    <input type="text" id="salesCd" name="salesCd" data-search="salesCd" required="required" msg="Sales Code">
				   	<a onclick="wbsSalesCodeSearchP();" id="salesCdAnchor"><i class="i_search_w"></i></a>
			    </div>
			     -->
			     <input type="text" id="salesCd" name="salesCd" data-search="salesCd" required="required" msg="Sales Code" readonly="readonly" />
			</td>
			<th>고객사</th>
			<td>
				<input type="hidden" id="ordrsClntCd" name="ordrsClntCd" data-search="ordrsClntCd">
				<!-- <div class="search_form">  -->
					<input type="text" id="ordrsClntNm" name="ordrsClntNm" data-search="ordrsClntNm" readonly="readonly"> 
					<a onclick="openClntSearchP('P');"><i class="i_search_w"></i></a>
				<!-- </div>  -->			
			</td>
			<th>고객사PJT</th>
			<td>
				<!-- <input type="text" id="clntPjt" name="clntPjt" data-search="clntPjt" msg="고객사PJT" readonly="readonly">  -->
				<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" data-search="clntPjt" readonly="readonly">	
			      <option value="">전체</option>
				</select>				  
			</td>			
        </tr>
        <tr>
			<th class="hit">SalesCode별 요청번호</th>
			<td>
				<div class="search_form">
					<input type="text" id="reqNo" name="reqNo" onkeyup="event.keyCode == 8 ? reqNo1.value = '' : event.keyCode == 13 ? openPurchaseSearch() : ''" required="required" msg="요인별요청번호"> 
					<a id="reqNoBtn" onclick="openPurchaseSearch();"><i class="i_search_w"></i></a>
				</div>
			</td>	        
			<th>제품구분</th>
			<td>
				<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" msg="제품구분">
				<!-- 
				<div class="search_form">				
				<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtCdNm" msg="제품구분" readonly="readonly">  
				<a onclick="openPrdtSearchP();"><i class="i_search_w"></i></a>
				</div>
				 -->
				<input type="text" id="prdtNm" name="prdtNm" data-search="prdtNm" msg="제품구분" readonly="readonly">				 
			</td>
			<th>아이템구분</th>
			<td>
				<!-- 
				<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv" readonly="readonly">	>
			      <option value="">전체</option>
				</select>
				-->
				<input type="text" id="itemDivNm" name="itemDivNm" data-search="itemDivNm" msg="아이템구분" readonly="readonly">	
			</td>
			<th>설비명</th>
			<td colspan="0">
				<input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm" msg="설비명" readonly="readonly">
			</td>		
        </tr>
        
        <tr>
        	<td colspan="8" class="title_m_td" style="">발주정보</td>
        </tr>     
        <tr>
			<th class="hit">구매처</th>
			<td>
				<input type="hidden" id="pchsClntCd" name="pchsClntCd"  data-search="pchsClntCd">
				<div class="search_form">
					<input type="text" id="pchsClntNm" name="pchsClntNm"  data-search="pchsClntNm" onkeyup=""  required="required" msg="구매처"> 
					<a onclick="openClntSearchP('S');"><i class="i_search_w"></i></a>
				</div>
			</td>   
			<th>통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR" data-search="currCd" class="form-control" required="required" msg="통화단위">
<!-- 			      <option value="">전체</option> -->
				</select>	
			</td>
			<th>환율</th>
			<td>
				<input type="text" id="exrate" name="exrate"  data-search="exrate"  class="form-control" data-ax5formatter="money" maxlength="13" comma />
			</td>	
			<th>발주번호</th>
			<td>
			  <input type="text" id="ordrgNo" name="ordrgNo" msg="발주번호" disabled="disabled">
			</td>
        </tr>
        <!-- remove 20231005             
        <tr>
			<th class="hit">발주구분</th>
			<td>
			</td>
			<th class="hit">용도구분</th>
			<td>
			</td>
			<th class="hit">특성구분 </th>
			<td>
        </tr>
        -->
        <tr> 
			<th class="hit">발주일자</th>
			<td>
	              <div class="date_input">
	                <input id="ordrgDt" name="ordrgDt"  class="input_calendar2 form-control" autocomplete="off" onkeyup="dateMask(this);"
	                   required="required" msg="발주 시작일자" data-search="ordrgDt"  onchange="monthCloseChk(this.value);">
	              </div>			
			</td>
			<th>납기요청일자</th>
			<td>
	              <div class="date_input">
	                <input id="dudtDeqDt" name="dudtDeqDt"  class="input_calendar2 form-control" autocomplete="off" class="form-control"
	                 required="required"  msg="납기요청일자" data-search="ordrgDt">
	              </div>
			</td>		
			<th>발주금액</th>
			<td>
				<input type="text" id="ordrgAmt" name="ordrgAmt"  data-search="ordrgAmt" onkeyup="" placeholder="" maxlength="13" readonly="readonly" comma data-ax5formatter="money" />
				<!-- 발주금액은 계산(bom 의 sum) -->
			</td>
			<td></td>
			<td></td>
        </tr>    
        <tr>  
			<th>적요</th>
			<td colspan="7">
				<textarea class="form-control" id="ordrgRmk" name="ordrgRmk" data-search="ordrgRmk"  msg="적요" style="height: 60px;" maxlength="2000"></textarea>
			</td>
        </tr>    
       
      </table>
    </form>

	<div class="" style="height: 10px;">
	</div>	    
        	

<!-- 하단 디테일그리드 -->
		<!-- 콘텐츠 -->
	  <div class="contents2" style="margin-bottom: 50px; height:450px;">
	      <!-- 리스트 -->
	      <div class="ax5_grid" style="width: 100%">
	        <ul class="ul_list" style="height:250px; width: 100%">
	            <li style="width: 100%;">
	                <div class="table_list_tit" style="width: 100%;">
	                	<h5 class="tit" style="float:left; margin-left: 8px; margin-top: 8px; margin-bottom: 8px;">구매 BOM</h5>
		                <div class="add_btn pdl10" style="margin-right:8px; margin-top: 8px;">
		                    <!--  <a onclick="addRowBom()" style="" authchk>+</a> -->
		                    <a id="deleteDetailButton" style="" authchk>-</a>&nbsp;
		                    <a onclick="excelDownP();" style="height: 30px; line-height: 28px; width: 90px;" authChk><i class="fas fa-file-excel"></i>엑셀다운로드</a>
		                </div>
	                </div>
	                <div>
	                	<div data-ax5grid="bom-grid-modal" data-ax5grid-config="{}" style="height:450px; width: 100%" ></div>
						<!-- excel -->
						<div data-ax5grid="excel-grid-pop" data-ax5grid-config="{}" style="display: none;"></div>	                	
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>
<!-- 하단 디테일그리드 end -->
	
	<!-- 결재 및 공유대상자 V2 -->
	<div id="approval_trgt" style="display:none;">       
		        <table style="border:0px; width:50%; margin-bottom:20px; height:200px;">
		            <tr style="height:30px;">
		              <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
		              <td>
			              <div class="add_btn_small pdl10">       
					          <a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;" authchk>+</a>
					          <!-- <a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;" authchk>-</a> -->    	<!-- row만 삭제 -->
					          <a onclick="deleteSignUser();" style="height: 30px; line-height: 28px;" authchk>-</a>    	<!-- 바로 삭제 -->
					      </div>
		              </td>
		            </tr>
		            <tr>
		              <td colspan="2" style="vertical-align:top; width:100%; height:100%;">
		               <div>
						 <div class="ax5_grid" data-ax5grid="first-grid-modal-app" data-ax5grid-config="{}" style="height: 200px; width: 100%" ></div>						 
					   </div>
					  </td> 
					</tr>  
		        </table>
	</div>	        
	<!-- 결재 및 공유대상자 V2 END -->       

	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
	<br><br>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" id="approvalReqBtn" authChk>결재요청</button>
		<button type="button" id="approvalReqTodoBtn" authChk style="display:none;">결재요청알림톡</button>
		<button type="button" id="reportRegBtn" onclick="setReportMain('Report');" authChk>발주서발행</button>
		<button type="button" id="mailSendBtn" onclick="sendMailCall();" authChk><i class="fas fa-envelope"></i> 메일</a></button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>
<script type="text/javascript">
  
//전역초기화  
var actionType = null;
var paramPrjctSeq = null;
var firstGrid = null;
var secondGrid = null;
var userId = null;
var userNm = null;
var fileTrgtKeyU = null;		//list에서 받은값
var salesCdU = null;			//list에서 받은값
var ordrgNoU =  null;			//list에서 받은값

ax5.ui.grid.formatter["clntChk"] = function () {
	var color = this.value == "Y" ? '<img src="/static/img/color-circle_02.png" style="width: 10px;height: 10px;"></img>' : '';
	if (this.value == "E"){
		return 'E';
	} else {
		return color;
	}
};

var thisGridRow=0; // 선택된 행 정보 저장할 변수
var thisGridCol=0; // 선택된 열 정보 저장할 변수
var beforeGridSize = 0; //수주상세그리드의 갯수용 그리드컨텐츠 높이조절용

var gridViewPop = {
    	initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,	
				showRowSelector: false,
				multipleSelect: false,
				sortable: true,
				frozenColumnIndex : 4,
				target: $('[data-ax5grid="bom-grid-modal"]'),
				header: {
	              align: "center",
	              selector: false
	            },
	            body: {
	            	mergeCells : ["coNm", "salesCd", "partNo", "unitNo", "revNo","dsgnNo"],
					onClick: function() {
					    this.self.select(this.dindex);
		                prdtIdx = this.dindex;
		                thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
		                thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
		                
		                var clickedRowIndex = this.dindex;					    
					    
					    var row = this.dindex;
                        var paramObj = {"row" : row};
                        //체크박스일 경우 실행 - 등록모드만
                        if( this.column.key == "userChk" && actionType == "C" ) {
                        	//chk, 수량, 기발주수량, row번호 
                            $.setOrdrgQty(gridViewPop, this.item.userChk , this.item.bomQty, this.item.preBomQty, row);   
                        	//구매단가 set
                            $.setMatrUpr(this.item, row);
                        }
					},
					//그리드값 변경시 실행
		            onDataChanged: function () {
					    var row = this.dindex;
					    var col = this.colIndex;
					    var ordrgPrc = 0;
					    //체크박스 변경 제외
					    if( this.key != "userChk" ) {

	            			var ordrgPrc = (this.item.ordrgPrc=="" || typeof(this.item.ordrgPrc)=="undefined")? 0 : this.item.ordrgPrc;
			            	// 발주단가, 발주수량  변경시
			            	if ( this.key == "ordrgPrc" || this.key == "ordrgQty" ) {   			            		
			            		if( this.item.ordrgQty != "" && this.item.ordrgQty > 0  ) {
			            			var ordrgAmt = parseInt( deleteCommaStr(this.item.ordrgQty) * deleteCommaStr(ordrgPrc) );
			            			gridViewPop.target.setValue(row, "ordrgAmt", ordrgAmt);		            			
			            		} else {
								    gridViewPop.target.setValue(row, "ordrgAmt", "");		            			
			            		}
			            	}           	
							//발주수량 OVER CHK
			            	if ( this.key == "ordrgQty") {			            		
			            		if( this.item.ordrgQty != "" && this.item.ordrgQty > 0  ) {			            			
				            		var calcuOrdrgQty = parseInt( deleteCommaStr(this.item.bomQty) - deleteCommaStr(this.item.preBomQty) );
			            			if( this.item.ordrgQty == 0 ) {
									    alert("발주수량은 0 보다 커야 합니다.");
									    gridViewPop.target.setValue(row, "ordrgQty", "");	
									    return;			        
			            			} else if( calcuOrdrgQty == 0 ) {
									    alert("발주 가능 수량이 0입니다.");
									    gridViewPop.target.setValue(row, "ordrgQty", "");	
									    return;		 			            				
			            			} else if( calcuOrdrgQty < this.item.ordrgQty   ) {
				            			//등록일때만 값 초기화
				            			if( actionType == "C" ) gridViewPop.target.setValue(row, "ordrgQty", "");            			
									    alert("발주수량은 "+ calcuOrdrgQty+" (와)과 같거나 작아야 합니다");
									    return;
				            		}
			            		}
			            	}
			            	//수정내용 적용하기
			            	gridViewPop.target.repaint();   
					    }
		            	
		            	 
		            },					
					onDBLClick: function() {
						//this.self.clearSelect();
                        //this.self.select(this.dindex);
                    	//updateBomMatrModal('U');
					},
			   },
				footSum: [
  			    	[
  			    		{label: "합계", colspan:8, align:"center"},
  			    		{key: "bomQty", 			collector: "sum", formatter:"money", align: "center"},
  			    		{key: "preBomQty",		collector: "sum", formatter:"money", align: "center"},
  			    		{},
  			    		{key: "ordrgQty",			collector: "sum", formatter:"money", align: "center"},  		
  			    		{key: "ordrgPrc",			collector: "sum", formatter:"money", align: "right"},
  			    		{key: "ordrgAmt",			collector: "sum", formatter:"money", align: "right"},  		
  	                 ]
  			    ],
	           columns: [
				 	 	 {key: "fileTrgtKey", 		label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
				 	 	/* ,{key: "gb", 				label: "구분", 			width: 100,		align: "center"} */
						,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
						,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
						,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}						
						,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
						,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 	hidden:true}
						,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 	hidden:true}						
						,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 	hidden:true}	
						,{key: "dsgnNo", 			label: "도번", 				width: 170,		align: "left", 	hidden:false}						
						,{key: "matrCd", 			label: "자재코드", 			width: 80,		align: "left"}		/* 품번 */						
						,{key: "matrNm", 			label: "자재명", 				width: 120,		align: "left"}		/* 품명 */
						,{key: "matrMat", 			label: "소재/MAKER", 			width: 100,		align: "center"}						
// 						,{key: "matrMakrNm", 		label: "MAKER", 			width: 70,		align: "center"}	/* 제조사 */
						,{key: "bomPchsClntNm", 		label: "거래처", 				width: 80,		align: "center"}	/* 제조사 */	
						,{key: "mngNm", 		label: "담당자명", 				width: 80,		align: "center"}	/* 담당자명 */
						,{key: "nextPrcsnNm", 			label: "후행업체", 			width: 80,		align: "left"
							, editor : {type: "text",
								attributes: {'maxlength': 100,'data-maxlength': 300}
							}
						}	/* 후행업체 */							
						,{key: "bomQty", 			label: "수량", 				width: 50,		align: "center"}			/*수량 */						
						,{key: "preBomQty", 		label: "기발주<br>수량", 			width: 60,		align: "center"}			/*기발주 수량 */			
						,{key: "userChkV", 			label: "userChkV", 			width: 60,		align: "center", 	hidden:true}	/* 수정시 userChk */
						,{key: "userChk", 			label: "선택", 				width: 50,		align: "center"
								, editor:{type: "checkbox"
											, config: {trueValue: "Y", falseValue: "N"}
					    					, disabled: function () {                            							
												return this.item.userChkV == "Y";
									  		}
										}
						}			/*선택 */
						/* display & edit */
						,{key: "ordrgQty", 		label: "발주<br>수량", 			width: 60,		align: "center", formatter: "money"
								, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
										   } 
						}
						,{key: "ordrgPrc", 			label: "발주단가", 			width: 110,		align: "right", formatter: "money"
							, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
							   		  } 
						}
						,{key: "ordrgAmt", 			label: "발주금액", 			width: 110,		align: "right", formatter: "money"
							/*
							, editor: {type:"number" 
											, attributes: { 'maxlength': 13, 'data-maxlength': 15}
							          }
							*/
						}							
						,{key: "dudtDeqDt", 		label: "납기요청일", 			width:  80,		align: "center"
							, editor: {type: "date"
										, config: {
													content: {
					                            				config: { mode: "day", selectMode: "day" }
					                        				  }
					                    			}
									  }
						}												
						,{key: "dudtIntendDt", 		label: "납기예정일", 			width:  80,		align: "center", editor: {type: "date", config: {}}}
						, {key: "clntChk",			label: "구매처"     , align: "center", width: 60 , hidden: false,		formatter: "clntChk"}
						,{key: "pchsClntCd1", 		label: "pchsClntCd1", 		width: 50,		align: "center", 	hidden:true}	/* pchsClntCd1 */						
						,{key: "pchsClntNm1", 		label: "구매처1", 		width: 90,		align: "center", 	hidden:false}	/* 구매처1 */
						,{key: "matrMno", 			label: "형번(Model No)", 		width: 100,		align: "center"}
						,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "center"}
						,{key: "pchsClntCd2", 		label: "pchsClntCd2", 		width: 50,		align: "center", 	hidden:true}	/* pchsClntCd2 */
						,{key: "pchsClntNm2", 		label: "구매처2", 		width: 90,		align: "center", 	hidden:false}	/* 구매처1 */
						,{key: "pchsClntCd3", 		label: "pchsClntCd3", 		width: 50,		align: "center", 	hidden:true}	/* pchsClntCd3 */
						,{key: "pchsClntNm3", 		label: "구매처3", 		width: 90,		align: "center", 	hidden:false}	/* 구매처3 */	
						,{key: "matrSize", 			label: "크기",		 		width: 100,		align: "center"}	/* 크기 */										
						,{key: "matrWt", 			label: "중량",		 		width: 80,		align: "center"}	/* 중량 */
						,{key: "ordrgDiv10", 		label: "발주구분", 			width: 80,		align: "center", 	hidden:true}			 /* 발주구분 */
						,{key: "ordrgDiv10Nm", 		label: "발주구분", 			width: 80,		align: "center"}		 /* 발주구분 */
						,{key: "ordrgDiv20", 		label: "용도구분", 			width: 80,		align: "center", 	hidden:true}			 /* 용도구분 */
						,{key: "ordrgDiv20Nm", 		label: "용도구분", 			width: 80,		align: "center"}		 /* 용도구분 */																		
						,{key: "matrTestDiv", 		label: "검사구분", 			width: 100,		align: "center"}	/* 검사구분 */
						,{key: "matrWhCd", 			label: "입고창고Cd", 			width: 100,		align: "center", 	hidden:true}	/* 자재창고 Cd*/						
						,{key: "matrWhNm", 			label: "입고창고", 			width: 100,		align: "center", 	hidden:true}	/* 입고창고 X - 입력으로변경 */						
	              ]
				   ,
			       contextMenu: {
			          iconWidth: 20,
			          acceleratorWidth: 100,
			          itemClickAndClose: false,
			          icons: {
			              'arrow': '<i class="fa fa-caret-right"></i>'
			          },
			          items: [
			              {type: 1, label: "붙여넣기"},
			              {divide: true},
			          ],
			          popupFilter: function (item, param) {
			              //console.log(item, param);
			              if(param.element) {
			                  return true;
			              }else{
			                  return item.type == 1;
			              }
			          },
			          onClick: function (item, param) {
// 							console.log(item, param);
							thisGridRow = param.dindex;
							thisGridCol = param.colIndex;
							if (item.label == "붙여넣기") {
								gridPaste(gridViewPop.target, thisGridRow, thisGridCol);
							} 
							gridViewPop.target.contextMenu.close();
					       //또는 return true;
					   	}
					},        // contextMenu     				   
	        });
			return this;
    	},
		setData: function(_pageNo, _newReqNo) {
			var targetObj = this.target;
        	var formData = new FormData();
        	var salesCd = ( actionType == "U" ) ? salesCdU : $('#popForm #salesCd').val();
        	var fileTrgtKey = (fileTrgtKeyU) ? fileTrgtKeyU : 0;
        	var ordrgNo = ( actionType == "U" ) ? ordrgNoU : $('#popForm #ordrgNo').val();
        	var formData = {
				"fileTrgtKey" : fileTrgtKey,
				"coCd" : $("#popForm #coCd").val(), 
				"salesCd" : salesCd,
				"ordrgNo" : ordrgNo,
				/* "ordrgSeq" : ordrgSeq		단독수정은 없음*/
			}
        	//등록과 수정 URL 다르게
        	let url = "";
        	//수정모드시
        	if( actionType == "U" && typeof(_newReqNo)== "undefined" ) {
        		url = "selectOrderDetailList";
        	//수정모드에서 요인별요청번호 새로 검색시
        	} else if( actionType == "U" && typeof(_newReqNo)!= "undefined" ) {
        		url = "selectBomDetailList";        		
        	} else {
        		url = "selectBomDetailList";
        	}
//         	console.log('---url:' + url);
			postAjax("/user/sm/sm02/" + url, formData, null, function(data){
				var list = data.resultList;
				targetObj.setData({
					list : list,
				    page : {
				    		totalElements : list.length,
				    	} 
					});
				//환율 원화 default set
				$("#popForm #currCd").val("CURR01");
				$("#popForm #currCd").val("CURR01").trigger('change');						
            });    	   
		} 
}
// end gridViewPop

var excelViewPop = {
		initView: function(){
		this.target = new ax5.ui.grid();
		this.target.setConfig({
		target: $('[data-ax5grid="excel-grid-pop"]'),
		columns: [
	 	 	 {key: "fileTrgtKey", 		label: "파일대상KEY", 			width: 100,		align: "center", 	hidden:true}
		 	 	/* ,{key: "gb", 				label: "구분", 			width: 100,		align: "center"} */
				,{key: "coCd", 				label: "회사코드", 			width: 100,		align: "center", 	hidden:true}
				,{key: "coNm",	    		label: "회사",				width: 70,		align: "center", 	hidden:true}
				,{key: "ordrgSeq",	    	label: "ordrgSeq",			width: 70,		align: "center", 	hidden:true}						
				,{key: "salesCd", 			label: "Sales Code", 		width: 120,		align: "center"}
				,{key: "matrSeq", 			label: "matrSeq", 			width: 100,		align: "left", 	hidden:true}
				,{key: "upperCd", 			label: "upperCd", 			width: 100,		align: "left", 	hidden:true}						
				,{key: "lowerCd", 			label: "lowerCd", 			width: 100,		align: "left", 	hidden:true}	
				,{key: "dsgnNo", 			label: "도번", 				width: 170,		align: "left", 	hidden:false}						
				,{key: "matrCd", 			label: "자재코드", 			width: 80,		align: "left"}		/* 품번 */						
				,{key: "matrNm", 			label: "자재명", 				width: 120,		align: "left"}		/* 품명 */
				,{key: "matrMat", 			label: "소재", 				width: 70,		align: "center"}						
				,{key: "matrMakrNm", 		label: "MAKER", 			width: 70,		align: "center"}	/* 제조사 */
				,{key: "bomPchsClntNm", 		label: "거래처", 				width: 80,		align: "center"}	/* 제조사 */						
				,{key: "nextPrcsnNm", 			label: "후행업체", 			width: 80,		align: "left"
					, editor : {type: "text",
						attributes: {'maxlength': 100,'data-maxlength': 300}
					}
				}	/* 후행업체 */							
				,{key: "bomQty", 			label: "수량", 				width: 50,		align: "center"}			/*수량 */						
				,{key: "preBomQty", 		label: "기발주<br>수량", 			width: 60,		align: "center"}			/*기발주 수량 */			
				,{key: "userChkV", 			label: "userChkV", 			width: 60,		align: "center", 	hidden:true}	/* 수정시 userChk */
				,{key: "pchsClntCd1", 		label: "pchsClntCd1", 		width: 50,		align: "center", 	hidden:true}	/* pchsClntCd1 */
				,{key: "userChk", 			label: "□", 				width: 50,		align: "center", 	hidden:true
						, editor:{type: "checkbox"
									, config: {trueValue: "Y", falseValue: "N"}
			    					, disabled: function () {                            							
										return this.item.userChkV == "Y";
							  		}
								}
				}			/*선택 */
				/* display & edit */
				,{key: "ordrgQty", 		label: "발주<br>수량", 			width: 60,		align: "center", formatter: "money"
						, editor: {type:"number" 
									, attributes: { 'maxlength': 13, 'data-maxlength': 15}
								   } 
				}
				,{key: "ordrgPrc", 			label: "발주단가", 			width: 110,		align: "right", formatter: "money"
					, editor: {type:"number" 
									, attributes: { 'maxlength': 13, 'data-maxlength': 15}
					   		  } 
				}
				,{key: "ordrgAmt", 			label: "발주금액", 			width: 110,		align: "right", formatter: "money"
					/*
					, editor: {type:"number" 
									, attributes: { 'maxlength': 13, 'data-maxlength': 15}
					          }
					*/
				}							
				,{key: "dudtDeqDt", 		label: "납기요청일", 			width:  80,		align: "center"
					, editor: {type: "date"
								, config: {
											content: {
			                            				config: { mode: "day", selectMode: "day" }
			                        				  }
			                    			}
							  }
				}												
				,{key: "dudtIntendDt", 		label: "납기예정일", 			width:  80,		align: "center", editor: {type: "date", config: {}}}
				, {key: "clntChk",			label: "구매처"     , align: "center", width: 60 , hidden: false,		formatter: "clntChk"}						
				,{key: "pchsClntNm1", 		label: "구매처1", 		width: 90,		align: "center", 	hidden:false}	/* 구매처1 */
				,{key: "pchsClntCd2", 		label: "pchsClntCd2", 		width: 50,		align: "center", 	hidden:true}	/* pchsClntCd2 */
				,{key: "pchsClntNm2", 		label: "구매처2", 		width: 90,		align: "center", 	hidden:false}	/* 구매처1 */
				,{key: "pchsClntCd3", 		label: "pchsClntCd3", 		width: 50,		align: "center", 	hidden:true}	/* pchsClntCd3 */
				,{key: "pchsClntNm3", 		label: "구매처3", 		width: 90,		align: "center", 	hidden:false}	/* 구매처3 */											
				,{key: "matrMno", 			label: "형번(Model No)", 		width: 100,		align: "center"}
				,{key: "matrSize", 			label: "크기",		 		width: 100,		align: "center"}	/* 크기 */
				,{key: "matrWt", 			label: "중량",		 		width: 60,		align: "center"}	/* 중량 */
				,{key: "ordrgDiv10", 		label: "발주구분", 			width: 80,		align: "center", 	hidden:true}			 /* 발주구분 */
				,{key: "ordrgDiv10Nm", 		label: "발주구분", 			width: 80,		align: "center"}		 /* 발주구분 */
				,{key: "ordrgDiv20", 		label: "용도구분", 			width: 80,		align: "center", 	hidden:true}			 /* 용도구분 */
				,{key: "ordrgDiv20Nm", 		label: "용도구분", 			width: 80,		align: "center"}		 /* 용도구분 */																		
				,{key: "matrSpec", 			label: "규격", 				width: 100,		align: "center"}
				,{key: "matrTestDiv", 		label: "검사구분", 			width: 100,		align: "center"}	/* 검사구분 */
				,{key: "matrWhCd", 			label: "입고창고Cd", 			width: 100,		align: "center", 	hidden:true}	/* 자재창고 Cd*/						
				,{key: "matrWhNm", 			label: "입고창고", 			width: 100,		align: "center", 	hidden:true}	/* 입고창고 X - 입력으로변경 */		         
			     ]
		});
		   return this;
    }
}
// end excelViewPop

// 권한체크    
authChk();		
	
//구매 BOM
gridViewPop.initView();	 	
//등록/수정 버튼
actionType = modalStack.last().paramObj.actionType;
if (actionType == "C") {
	$("#actionBtn").text("등록");
	$('#actionBtn').on("click", function() {
		insertOrder();				
	});
	//발주서발행 btn hide
	$("#reportRegBtn").remove();
	//결재상시 btn hide
	$("#approvalReqBtn").remove();
	
	if(actionType == "C") {
		//환율 원화 default set
		$("#popForm #currCd").val("CURR01");
		$("#popForm #currCd").val("CURR01").trigger('change');
	}	
	
} else if (actionType == "U") {
	$('.tit_contents .tit').text('발주 수정')
	
	$('#actionBtn').text("수정");
	$('#actionBtn').on("click", function() {
		updateOrder();
	});
}	

// 등록 - done
function insertOrder() {
		
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridInsertArr(gridViewPop);
        if( !makeArr ) {
        	return;
        }
         
		if(makeArr.length<1) {
			alert("구매 BOM 선택항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
			formData.append("makeArr", JSON.stringify(makeArr));
		}          
        
		filePostAjax("/user/sm/sm02/insertOrderMaster", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					//modalStack.close();									// 모달을 닫음
					gridViewPop.setData(0);
				}
		});		
		let gridList = gridViewPop.target.getList();
// 		console.log('----grdlist--' + gridList[0].userChkV);		
	}
}


//수정 
function updateOrder() {
		
	if (inputValidation($('.popup_area [required]'))) {					// 필수 필드의 유효성 검사
		var formData = makeFormData();									// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridInsertArr(gridViewPop);		
        if( !makeArr ) {
        	return;
        }
		if(makeArr.length<1) {
			alert("구매 BOM 항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
	        //발주번호 set			
	        formData.append("ordrgNo", $("#ordrgNo").val());	        
			formData.append("makeArr", JSON.stringify(makeArr));
		}        
		
        /*
        *	결재그리드 insert make start
        */	
        //각업무에 맞는 param insert - 하드코딩값
		var addParam = {
					todoDiv2CodeId: "TODODIV2050"
					, pgmId: "SM0201P01"
					, pgPath: "/user/sm/sm02/SM0201P02.html"
					, sanctnSttus: "N"
					, salesCd: $("#popForm #salesCd").val()
					, todoCoCd: $("#popForm #coCd").val()
					, todoNo: $("#popForm #ordrgNo").val()
					, todoFileTrgtKey: modalStack.last().paramObj.fileTrgtKey
					, userId: jwt.userId
					};
		//부모창에서 넘어온값 - pgp
		var modalParam = {}; 
		$.each(modalStack.last().paramObj, function (key, val) {		
			modalParam[key] = val;
		});		
		if( Object.keys(modalParam).length > 0 ) {
			var pgParam = {pgParam: JSON.stringify(modalParam)}
			Object.assign(addParam, pgParam);
		}
        approvalArr = $.approvalInsertArr(gridViewPopApproval, addParam);
		//결재그리드
		if(approvalArr.length > 0) {
			if( approvalYn() > 0 ) {
				//결재진행중일때
			} else {
				formData.append("approvalArr", JSON.stringify(approvalArr));				
			}			
		}

        /* 결재그리드 insert make end */		
		filePostAjax("/user/sm/sm02/updateOrder", formData,		// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					if(approvalArr.length > 0) {
						if( approvalYn() == 0 ) {
							//todo실행
							kakaoTodo();							
						}
					}				
					modalStack.close();									// 모달을 닫음
				}
		});
	}
}

//엑셀다운로드
function excelDownP() {
	let paramObj = {};	
	
	var targetObj = this.target;
	var formData = new FormData();
	var salesCd = ( actionType == "U" ) ? salesCdU : $('#popForm #salesCd').val();
	var fileTrgtKey = (fileTrgtKeyU) ? fileTrgtKeyU : 0;
	var ordrgNo = ( actionType == "U" ) ? ordrgNoU : $('#popForm #ordrgNo').val();
	paramObj = {
		"fileTrgtKey" : fileTrgtKey,
		"coCd" : $("#popForm #coCd").val(), 
		"salesCd" : salesCd,
		"ordrgNo" : ordrgNo,
		"excelDown" : 1
	}
    postAjax("/user/sm/sm02/selectOrderDetailList", paramObj, null, function(data){
    	var list = data.resultList;
		excelViewPop.target.setData({
    		list : list,
    		page : {
                    totalElements : list.length
          			}
    	});
   		var todayDate = new Date().format('yyyyMMddHHmmss');
		excelViewPop.target.exportExcel("발주_구매BOM_"+todayDate+".xls");
	});       
}

//Sales Code (수주마스터, 수주상세테이블 조인) 검색
function wbsSalesCodeSearchP() {
    var paramObj = {
            "coCd" : $('#coCd_S').val(),
            "searchValue": $('#salesCd').val() 
         };
    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        $('#salesCd').val(row.salesCd);
		$("#ordrsClntNm").val(row.ordrsClntNm)		
		$("#clntPjt").val(row.clntPjt)
		$("#ordrsClntNm").val(row.ordrsClntNm)
		$("#prdtNm").val(row.prdtCdNm);
		$("#itemDivNm").val(row.itemDivNm);		
		$("#eqpNm").val(row.eqpNm);			
    	gridViewPop.initView().setData(0);
    });
}
 
//제품구분 검색 
function openPrdtSearchP(){
	var paramObj = {	
			"searchValue" : $("#prdtCdNm").val()
	}
	openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];
		$("#prdtCd").val(row.prdtCd);
		$("#prdtCdNm").val(row.prdtNm);
	});
}	


// 거래처 검색
function openClntSearchP(openType) {
	//그리드 검색이 우선
	var gridList = gridViewPop.target.getList();
	if( gridList.length < 1 ) {
		alert("구매BOM을 먼저 검색해 주십시오.");
		return;
	}
	
	var searchValueM = null;
	// P:고객사, S:구매처
	if(openType == "P") {
		searchValueM = $("#clntNm").val();
	} else if(openType == "S") {
		searchValueM = $("#pchsClntNm").val();
	}	
	var paramObj = {
			"searchValue" :  searchValueM
			, "clntDivCd" : "CLNTDIV12"		/*거래처 검색 기본값 고객사로 세팅 */
			, "pchsClntCd" : "CLNTDIV12"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
	}		
	if(openType == "S") {
		paramObj.clntDivCd = null;
	}
	//발주관리에서 호출 플래그 추가
	paramObj.orderFlag = "Y";		
	openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];
		//고객사 콤보 세팅
		if(openType == "P"){
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);
		//구매처 콤보세팅
		} else if(openType == "S"){
			$('#pchsClntCd').val(row.clntCd);
			$('#pchsClntNm').val(row.clntNm);
        	let clntCd = row.clntCd
			//구매처 표시
			var gridList = gridViewPop.target.getList();
			var inCnt = 0;
			if( gridList.length > 0 ) {			
		        $.each(gridList, function (idx, elem) {	
		        	
		        	//구매업체명cd가 일치
		        	if(elem.pchsClntCd1 == clntCd || elem.pchsClntCd2 == clntCd || elem.pchsClntCd3 == clntCd) {
		        		gridViewPop.target.setValue(idx, "clntChk", "Y");
// 		        		console.log('---set--');
		        	} else {
		        		gridViewPop.target.setValue(idx, "clntChk", "N");
// 		        		console.log('--- unset -');
		        	}
		        })
			}			
		}
	});
} 

function makeFormData() {
	// 금액 콤마 제거
	$.each($('.popup_area input[comma]'), function(idx, elem) {
		deleteComma(elem);
	});
	// 날짜 하이픈 제거
	$.each($('.popup_area input[date]'), function(idx, elem) {
		deleteHyphen(elem);
	});
	// 폼데이터 생성
	var formData = new FormData($("#popForm")[0]);
	// 기본값 set
	formData.append("userId", jwt.userId);
	
	//---------------------------------------------------------------  
	//-------itemarr  --첨부화일 처리를 위한 부분 시작
	//---------------------------------------------------------------  

	formData.append("comonCd", treeModule.getFileNodeId());
	var fileUploadArr = [];
	var tempArr = [];
	
	tempArr = treeModule.getFileArr();
	$.each(tempArr, function(idx, obj) {
		if (obj.fileKey == 0) {
            formData.append("files", obj.file);
            obj.file = '';
            fileUploadArr.push(obj);
		}
	});

	formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
	formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
	//---------------------------------------------------------------  
	//--첨부화일 처리를 위한 부분 끝
	//--------------------------------------------------------------- 
	
	return formData;	
}


var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
//---------------------------------------------------------------  
//첨부 화일 처리 시작 
//---------------------------------------------------------------  
fileParam = {
		fileTrgtTyp	: $("#pgmId").val(),
		fileTrgtKey : param_fileTrgtKey
}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
//---------------------------------------------------------------  
//첨부 화일 처리 끝
//---------------------------------------------------------------


/* ######################### 
 * 결재라인 추가 start
 ######################### */
	//결재라인 그리드 	//new 결재라인
	var gridViewPopApproval = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $('[data-ax5grid="first-grid-modal-app"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridViewPopApproval.setData(this.page.selectPage);
					}
				},
		    	columns : [
			    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
	                    {key: "sanctnSn",      		label: "순번",		align: "center",   width: 50},			    		
	                    {key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
	                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
	                    {key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: true},
	                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
	                    {key: "name",       		label: "성명",      	align: "center",   width: 80},
	                    {key: "jik",       			label: "직위",      	align: "center",   width: 60},
	                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 80},
	                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 80},
	                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: 220},
	                    {key: "telNo",      		label: "H.P",		align: "center",   width: 130},
	                    {key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
	                    {key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},                   
	                    {key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
	                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true},
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			var targetObj = this.target;
        			var formData = {
     	        			"fileTrgtKey" : fileTrgtKeyU,
     	        			"reqNo" : $('#popForm #ordrgNo').val(), 
     	        			"pageNo" : _pageNo + 1
     	    		}
   					postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
   						var list = data.result;
   						targetObj.setData({
   	  						list : list,
	   	  					page : { totalElements : list.length } 
   	  					});
   						var approvalCheck = list[0].sanctnSttus;
						if (approvalCheck == "Y") {
	   						//출력, 메일 버튼숨기기 --> 첫번째 결재자가 결재되면 활성화 함.  20231214 남장섭
	   						$('#reportRegBtn').show();
	   						$('#mailSendBtn').show();
						}
   	  				});
          		},
        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    } 
   	  					});
          		}
        		,
        		setData3 : function(_pageNo) {
        			var targetObj = this.target;
        			var paramObj = { "userId": jwt.userId
        							, "appDiv": 'APPDIV08'
        			};
   					postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
   						var list = data.result;
   						targetObj.setData({
   	  						list : list,
	   	  					page : { totalElements : list.length } 
   	  					});
   						var approvalCheck = list[0].sanctnSttus;
						if (approvalCheck == "Y") {
	   						//출력, 메일 버튼숨기기 --> 첫번째 결재자가 결재되면 활성화 함.  20231214 남장섭
	   						$('#reportRegBtn').show();
	   						$('#mailSendBtn').show();
						}
   	  				});
          		}        		          		
  	}
	gridViewPopApproval.initView();
	
	// 공유대상자 추가//  
    function insertShareUserModal() {    
		
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}
		
        var paramObj = {};
        var appshaList = gridViewPopApproval.target.list;
        paramObj["coCd"] = $('#popForm #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] = "";
        paramObj["userNm"] = "";
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";   
        		}).map(function(item) {
	        		  	return {
	        			    gb: "결재",
	        			    id: item.usrNm,
	        			    text: item.name,
	        			    parent: item.jik,
	        			    deptNm: item.dtNm,
	        			    telNo: item.telNo,
	        			    offTelNo: item.offTelNo,
	        			    email: item.email
	        			    , id: item.todoId
	        			    , todoKey: item.todoKey
	        			    , sanctnSn: item.sanctnSn
	        			    , sanctnSttus: item.sanctnSttus
	        		        , todoCfDt: item.todoCfDt
	        		        , todoCfOpn: item.todoCfOpn   
	        			    , flag: item.flag
	        			    , coCd: item.coCd
	        			};
        		});
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
        		}).map(function(item) {
				  		return {
						    gb: "공유",
						    id: item.usrNm,
						    text: item.name,
						    parent: item.jik,
						    deptNm: item.dtNm,
						    telNo: item.telNo,
						    offTelNo: item.offTelNo,
						    email: item.email
	        			    , id: item.todoId
	        			    , todoKey: item.todoKey	        			    
	        			    , sanctnSn: item.sanctnSn
	        			    , sanctnSttus: item.sanctnSttus	       
	        		        , todoCfDt: item.todoCfDt
	        		        , todoCfOpn: item.todoCfOpn	        			    
	        			    , flag: item.flag
	        			    , coCd: item.coCd	        			    
						};
				});
        
        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//     		console.log('결재라인 : ', approvalGrid.target.list);
//     		console.log('공유라인 : ', shareGrid.target.list);
    		
    		var appArray = approvalGrid.target.list.map(function(item) {
    			  return {
    				  	gb: "결재",
    				  	id: item.id,
    				  	name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
        			    todoId: item.id
        			    , todoKey: item.todoKey        			    
        			    , sanctnSn: item.sanctnSn
        			    , sanctnSttus: item.sanctnSttus
        		        , todoCfDt: item.todoCfDt
        		        , todoCfOpn: item.todoCfOpn        			    
        			    , flag: item.flag	
        			    , coCd: item.coCd
					};
			});
    		var shaArray = shareGrid.target.list.map(function(item) {
  			  return {
	  				  	gb: "공유",
						id: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
        			    todoId: item.id
        			    , todoKey: item.todoKey        			    
        			    , sanctnSn: item.sanctnSn
        			    , sanctnSttus: item.sanctnSttus    
        		        , todoCfDt: item.todoCfDt
        		        , todoCfOpn: item.todoCfOpn
        			    , flag: item.flag
        			    , coCd: item.coCd
					};
			});
    		gridViewPopApproval.setData2(appArray.concat(shaArray));
  			
        });
		
    }   
	
    function deleteShareUser(){

		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}    	
    	
    	var selRow = parseInt(gridViewPopApproval.target.selectedDataIndexs);    
 		if( isNaN(selRow) ) {
 			alert("선택된 행이 없습니다.");
 			return;
 		} else {			
 				if( selRow > -1 ) {
 					gridViewPopApproval.target.removeRow(selRow); 					
 				}
 		}
    }
		
	
	//결재 여부
	function approvalYn() {
		var gridList = gridViewPopApproval.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
        	var msgArr = [];			
	        $.each(gridList, function (idx, elem) {	
	        	//결재자가 본인이 아니면서 상태가 Y인 경우
	        	if( /*elem.todoId != jwt.userId  &&*/ elem.sanctnSttus == "Y" ) {
	        		inCnt++;	        		
	        	}
	        })
		}
		return inCnt;
	}
  	
	// 결재대상자 추가(+버튼 수동)
	function insertSignUserResModal() {   
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}
		
		var paramObj = {"coCd" : $('#coCd').val()	};	    
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj
			, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					var paramObj = {"coCd" : $(".popup_area #coCd").val(), "userId" : checkedId};
					//사용자 id로 ajax 
					 postAjax("/user/wb/wb20/selectShareUserInfo", paramObj, null
						, function(data) {   						 
							if(data.resultList.length > 0 ) {
								var result = data.resultList[0];
								gridViewPopApproval.target.addRow($.extend({}, "last", false));
								var row = gridViewPopApproval.target.getList().length -1 ;
								gridViewPopApproval.target.setValue(row, "sanctnSn", row+1);
								$.each(result, function (key, val) {
									if( key != "" && key != "undefined" ) {
										gridViewPopApproval.target.setValue(row, key, val);
									}
									//todoId set
									if( key == "id") {
										gridViewPopApproval.target.setValue(row, "todoId", val);
									}
								});							
							}
					});     //user search ajax end 
		});	//tree modal end
	}       
	
	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
// 		console.log('---gridNoset run ---');		
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};	 
				gridObj.target.setValue(idx, key, idx+1);
			});	
			gridObj.target.repaint();
		}		
	}	
	
    function deleteSignUser(){
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}    	
    	var selRow = parseInt(gridViewPopApproval.target.selectedDataIndexs);    	
 		if( isNaN(selRow) ) {
 			alert("선택된 행이 없습니다.");
 			return;
 		} else {			
 			//결재라인이 없을 경우 
			if( selRow > -1 ) {
				var todoKey = gridViewPopApproval.target.getList()[selRow].todoKey;
				if( typeof(todoKey) == "undefined" ) {
					gridViewPopApproval.target.removeRow(selRow);
					$.gridNoSet(gridViewPopApproval, "sanctnSn");
				} else {
					var paramObj = {
							todoNo: $("#popForm #ordrgNo").val()
					}
					var gridList = gridViewPopApproval.target.getList("selected")[0];	
	 		        $.each(gridList, function (key, val) {			     	        	
	 					if( typeof(val) == "undefined") val = "";
	 					paramObj[key] = val; 						    			            		
	 		        });		
	 		        if(paramObj.todoKey && paramObj.sanctnSn && paramObj.coCd && paramObj.todoDiv1CodeId && paramObj.todoDiv2CodeId ) {
 	 					if( confirm("선택행을 삭제하시겠습니까?")) {
 	 						deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
 	 							if (data.resultCode == 200) {
 	 								alert(data.resultMessage);
 	 								gridViewPopApproval.setData(0);
 	 								gridView.setData(0);
 	 							} else {
 	 								alert("삭제중 오류가 발생했습니다");	 	 								
 	 							}
 	 						}); 						
 	 					}		 		        			 		        	
	 		        } else {
	 		        	alert("삭제중 오류가 발생했습니다.")
	 		        }		
				}
 					
			}
 		}
		//행선택 if end
    }	//func end 

	//등록시 그리드값 배열 저장
	$.approvalInsertArr = function(gridObj, addParam) {
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;
		var detailArr = [];    	
		var msgArr = [];    	
		var errCnt = 0;		
		if( gridList.length > 0 ) {
        	var msgArr = [];			
	        $.each(gridList, function (idx, elem) {
	            var detailObj = {};	     	        	
	        	//컬럼수 루프 
	        	for(var i=0; i<gridColumns.length; i++) {
					var key = gridColumns[i].key;
					var val = elem[key];
					if( typeof(val) == "undefined") val = "";					
					detailObj["idx"] = i + 1;
					//발주순번 은 select key로  ORDRG_SEQ  
					detailObj[key] = val;			            			            
	        	}
	            //필수값 체크를 여기서 한다.
	            if( detailObj['todoId'] != ""  ) {		            
		            detailArr.push(detailObj);	        	
	            }
	            //공유/결재구분
	            if( detailObj['gb'] == "결재" ) {	
	            	detailObj['todoDiv1CodeId'] = "TODODIV20";
	            } else if( detailObj['gb'] == "공유" ) {
	            	detailObj['todoDiv1CodeId'] = "TODODIV10";	            	
	            }
	            //추가할 param
				$.each(addParam, function(key, val){
					detailObj[key] = val;						
				});		
	            //TITLE 추가
				detailObj['todoTitl'] = "["+$("#popForm #salesCd").val()+"] " +$("#popForm #pchsClntNm").val() + " " + $("#popForm #eqpNm").val();
	        });	
	        //error alert 후 종료
	        if( msgArr.length > 0 ) {
	        	alert(msgArr.join("\r\n"));
	        	return false;
	        }
		}
		return detailArr;
	}	    
/* ######################### 
 * 결재라인 추가 script end 
 ######################### */
 
 
	// Ctrl + V 단축키 이벤트 처리
	gridViewPop.target.$target.on("paste", function (e, a) {
// 		console.log('1.--row-' + thisGridRow + '>>>col-' + thisGridCol);
		gridPaste(gridViewPop, thisGridRow, thisGridCol);
	});
 
    
    function gridResize(size) {
	    if (beforeGridSize != size) {
		    var tagHeight = (size) * 27 + 123 ;
		    tagHeight = tagHeight > 750 ? 750 : tagHeight;
		    tagHeight = tagHeight < 300 ? 300 : tagHeight;
		    
		    gridViewPop.target.setHeight(tagHeight)
		    beforeGridSize = size;
	    }
    }    
    
    //그리드 수정후 현재 위치로 이동하기 위한 함수
    //상태바에서 시작 또는 마지막 표시 row를 산정함
    // resetGridFocus()와 분리한 이유는 화면에 기존 데이터 Refresh하기전 위치 위치 저장하기 위함
    function currGridEndRow() {
        var gridDisplayEndRow = gridViewPop.target.xvar.virtualPaintRowCount //화면출력 row수
                              + gridViewPop.target.xvar.virtualPaintStartRowIndex; //화면 출력 시작 Row index
        return gridDisplayEndRow < 4 ? 0 : gridDisplayEndRow - 3;
    }    
    
    function resetGridFocus(endRow, row) {
    	gridViewPop.target.focus(endRow);  
         
        //gridResize(gridViewPop.target.list.length); //그리드 높이 조정
        beforeGridSize = gridViewPop.target.list.length;
        gridViewPop.target.focus(row);  
    } 
   
    
 //그리드 붙여넣기
     function  gridPaste(thisGrid, thisGridRow, thisGridCol ) {
     	var pasteData = "";

    	navigator.clipboard.readText()
    		.then(pasteData => {
//             console.log('클립보드에 저장된 값:', pasteData);
            if (pasteData == undefined || pasteData == "" || thisGridRow == undefined) {
                console.error('클립보드에 데이터가 없습니다.');
                return;
            }

    		// 붙여넣기할 데이터를 배열로 변환한다.
    		var pasteRows = pasteData.split("\n").map(function(row) {
    			return row.split("\t");
    		});
    		//복사대상의 마지막 배열의 값이 없으면 제외
    		if (pasteRows[pasteRows.length - 1] == "") pasteRows.splice(pasteRows.length - 1, 1);
    		
    		// 붙여넣기를 시작할 셀의 인덱스를 구한다.
    		var startRowIndex = thisGridRow;
    		var startColIndex = thisGridCol;
    		
    		// 붙여넣을 데이터의 행과 열 개수를 구한다.
    		var numRows = pasteRows.length;
    		var numCols = pasteRows[0].length;
    		
    		//그리드 컬럼정보를 가져와서 붙여넣기할때 위치정보로 사용한다.
    		tempColumns = thisGrid.colGroup;
    		for (var i = tempColumns.length - 1; i >= 0; i--) {
    		    if (tempColumns[i].hidden) {
    		        tempColumns.splice(i, 1); 
    		    }
    		}
    		var currGridData = thisGrid.list;
    		
            //붙여넣기할 줄이 일치하지 않을경우 리턴
            if( currGridData.length < numRows ) {
            	alert("붙여넣기 할 행수는 같거나 작아야 합니다.");
            	return;
            }    		
    		
    		//마지막자료와 같은 값으로 추가하고 ordrsSeq는 0으로 설정
    		//참조복사를 방지하기 위함
    		var tempData = JSON.parse(JSON.stringify(currGridData[thisGridRow]));
    		tempData.ordrsSeq = "0";
    		
    		// 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
    		for (var i = 0; i < numRows; i++) {
    			for (var j = 0; j < numCols; j++) {
    			  	//carriage return 문자 삭제
    			    var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
    			
    			    calRow = startRowIndex + i;
    				calCol = startColIndex + j;
    				if (calRow >= currGridData.length) {
						//참조복사를 방지하기 위함
    					let tempDataCopy = JSON.parse(JSON.stringify(tempData));
    					currGridData.push(tempDataCopy);
    		        } 
    		        var tkey = tempColumns[calCol].key;
    		        currGridData[calRow][tkey] = cellData;
    
    		    }
    		}
            var currEndRow = currGridEndRow();
    		thisGrid.setData(currGridData);
    		// gridResize(currGridData.length);
    		// thisGrid.focus(thisGridRow);
            resetGridFocus(currEndRow, thisGridRow);
      
    		})
    	    .catch(error => {
//     	        console.log('클립보드 읽기 오류 발생:', error);
    	    });	
    };        
 


var editVal = {}; 
$(document).ready(function() {
	//출력, 메일 버튼숨기기 --> 첫번째 결재자가 결재되면 활성화 함.  20231214 남장섭
	$('#reportRegBtn').hide();
	$('#mailSendBtn').hide();
	
	$.initViewPop = function() {
		//combo set
		setCommonSelect($(".popup_area select[data-kind]"));
		userId = modalStack.last().paramObj.userId;
		fileTrgtKeyU = modalStack.last().paramObj.fileTrgtKey;
		//modal 넘어온값만큼 만큼 루프 
		$.each(modalStack.last().paramObj, function (key, val) {		
			if( $("#popForm").find("#"+key).length > 0 ) {
				//$("#popForm").find("#"+key).val(val);
			}
		});
		$("#popForm #userId").val(userId);	
		//작성자 readonly 등 set
		$("#salesCd").attr("readonly", true);
		
		//formatter
		$('[data-ax5formatter]').ax5formatter();
			
		let today = moment(new Date());
		let yesterday = moment(new Date()).add(-1, 'days');	
		//등록일때만 set
		if(actionType == "C") {
			// 발주일자
			$('#ordrgDt').datepicker({
					format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true
				})
			.datepicker("setDate", today.toDate());
			
			//납기요청일 : 발주일자 +1일이 1108
			$('#dudtDeqDt').datepicker({
				 	format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true				 
			 	})
			 .datepicker("setDate", '+1D');
			
			// -버튼 hide
			$("#deleteDetailButton").hide();
			//회사 set
			if( typeof(modalStack.last().paramObj.coCd) != undefined ) {
				$("#popForm #coCd").val(modalStack.last().paramObj.coCd);	
			} 		
			
// 			$("#popForm #coCd").css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$("#popForm #clntPjt").css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//요인별요청번호 있을경우 자동 set
			var modalParam = modalStack.last().paramObj;
			if( typeof(modalParam.reqNo) != "undefined" ) {
				$("#popForm #reqNo").val(modalParam.reqNo);
				
				//발주 read
				postAjax("/user/sm/sm02/selectOrderDetailView", modalStack.last().paramObj, null
					, function(data){
						var list = data.resultList;
		 				if( list.length > 0 ) {
		 					$("#popForm #salesCd").val(list[0].salesCd);
		 					$("#popForm #clntPjt").val(list[0].clntPjt);
		 					$("#eqpNm").val(list[0].eqpNm);
		 					$("#itemDivNm").val(list[0].itemDivNm);
		 					$("#prdtNm").val(list[0].prdtNm);
		 					$("#prdtCd").val(list[0].prdtCd);
		 					$("#reqNo").val(list[0].reqNo);
		 					$("#ordrsClntCd").val(list[0].clntCd);
		 					$("#ordrsClntNm").val(list[0].clntNm);
		 					gridViewPop.initView().setData(0);							
						} 
				});							
				
			}			
			
		} else if(actionType == "U") {
			//전역 set
			salesCdU = modalStack.last().paramObj.salesCd;
			ordrgNoU = modalStack.last().paramObj.ordrgNo;
			$("#popForm #coCd").css({'background-color':'#e6e6e6', 'pointer-events':'none'});			
			
			//chkbox 삭제 - 합계 틀어짐
			//gridViewPop.target.removeColumn(18);	
			//sale code readonly
			//let editVal = {};
			postAjaxSync("/user/sm/sm02/selectOrderDetailView", modalStack.last().paramObj, null
				, function(data){
					var list = data.resultList;
	 				if( list.length > 0 ) {
				        $.each(list[0], function (key, val) {			     	        	
							//html element overwrite set
							if( val && typeof($("#"+key).attr("name")) != "undefined" ) {
								$("#popForm #"+key).val(val);
							}
							editVal[key] = val;
						});			
					} 
	 				monthCloseChk($('#ordrgDt').val());
			});		
			
			
			$("#salesCd").attr("readonly", true);
			//wbsSalesCodeSearchP();
			$("#salesCdAnchor").removeAttr("onclick");

			//고객사PJT disabled 처리
			$("#clntPjt").attr("disabled", true);
			
			// 금액 콤마
			$.each($('#popForm input[comma]'), function(idx, elem) {
				onlyNumber(elem);
			});								
			//요인별요청번호 hide
			$("#reqNoBtn").removeAttr("onclick");
			$("#reqNoBtn").hide();
			$("#reqNo").attr("readonly", true);	
			
			//그리드 load
			gridViewPop.initView().setData(0);			
			
			//수정시 bom은 수동으로 추가
			//toDo 등록여부 Y일 경우 결재대상자 창
			if( editVal.todoYn == "Y" ) {
				$("#approval_trgt").show();
				$("#approvalReqBtn").hide();
				$("#approvalReqBtn").removeAttr("onclick");
				//결재대상자 load
				gridViewPopApproval.initView().setData(0);		
				
				//temp
				$("#approvalReqTodoBtn").show()
			}
			if( modalStack.last().paramObj.reOpen ) {
				$("#approval_trgt").show();
				gridViewPopApproval.initView();
				opendModalApprovalListList();
				reOpen = false;
			}
		}	
		//actionType end
		excelViewPop.initView();
	}

	$.initViewPop();
		
	//등록시 통화단위에 따른 환율 SET
	exrateCal(); //최초 로딩시 환율 적용
	$('#popForm #currCd').on('change', exrateCal);
	
	//bom row 클릭시 구매단가 set
	$.setMatrUpr = function(item, row) {
		//등록시 구매단가 발주단가로 set 
		if( item.userChk == "Y" ) {
			var paramObj = {
							"coCd" : $("#popForm #coCd").val()
							, "matrCd" : item.matrCd
							, "pchsClntCd" : $("#popForm #pchsClntCd").val()
							, "curr" : $("#popForm #currCd").val()
							};
			postAjax("/user/sm/sm02/selectCurrMatrUpr", paramObj, null
						, function(data) {   
							if(data.resultList != null) {
								var ordrgPrc = data.resultList;
// 								console.log('해당자재구매단가---' + data.resultList);
								gridViewPop.target.setValue(row, "ordrgPrc", ordrgPrc);
							} else {
															
							}
			});     //user search ajax end					
		} else {
			return;
		}

	}
	
	//sale Code keyup 이벤트
	$("#salesCd").on("keyup", function () {
		if(event.keyCode == 8) {
			$("#salesCd").val('');
		} else if(event.keyCode == 13) { 
			gridViewPop.setData(0); 
		}		
	});	
	
	//등록시 그리드값 배열 저장
	$.gridInsertArr = function(gridObj, mode) {
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;
		var detailArr = [];    	
		var msgArr = [];    	
		var errCnt = 0;
		debugger;
		if( gridList.length > 0 ) {
        	var msgArr = [];			
	        $.each(gridList, function (idx, elem) {
	            var detailObj = {};	     	        	
	        	//컬럼수 루프 
	        	for(var i=0; i<gridColumns.length; i++) {
					var key = gridColumns[i].key;
					var val = elem[key];
					if( typeof(val) == "undefined") val = "";
					//console.log('key:' + key+'=-====>val:' + val);					
					//type number 시 콤마제거
					if( typeof(gridColumns[i].editor) != "undefined" && gridColumns[i].editor.type == "number" && val != "" ) {
						val = deleteCommaStr(val); 
					}	     
					
					detailObj["idx"] = i + 1;
					//발주순번 은 select key로  ORDRG_SEQ  
					detailObj[key] = val;			            			            
	        	}
	            //필수값 체크를 여기서 한다. 발주수량, 납기요청일 - 체크된 항목만	    
	            if( detailObj['userChk'] == "Y" || ( /* detailObj['userChk'] != "" && */ detailObj['userChkV'] == "Y") ) {
	            	//등록모드시는 skip
	            	if( actionType == "C" && detailObj['userChk'] != "" || actionType == "U" && detailObj['userChkV'] == "Y" ) {
		            	//발주수량
			            if( detailObj['ordrgQty'] =="" || detailObj['ordrgQty'] =="0" ) {
			            	msgArr.push((idx+1)+" 행의 발주수량을 입력해 주십시오.")	;
			            }	 
			            //납기요청일
			            if(detailObj['dudtDeqDt'] == "" ) {
			            	msgArr.push((idx+1)+" 행의 납기요청일을 입력해 주십시오.")	;		            	
			            }
			            //발주수량
			            if( Number(detailObj['bomQty']) < Number(detailObj['preBomQty']) + Number(detailObj['ordrgQty']) ) {
			            	var calQty = parseInt( Number(detailObj['bomQty']) - Number(detailObj['preBomQty']) );
			            	msgArr.push((idx+1)+" 행의 발주수량은 " + calQty + "보다 작거나 같아야 합니다.")	;
			            }
			            //체크된 항목만 저장		            
			            detailArr.push(detailObj);			            
	            	} 
			
	            //} else if( actionType == "U" ) {
		            //detailArr.push(detailObj);	            	
	            }
	            		
	        });			
	        //error alert 후 종료
	        if( msgArr.length > 0 ) {
	        	alert(msgArr.join("\r\n"));
	        	return false;
	        }
		}
		return detailArr;
	}
			
	// bom 그리드 삭제
	$("#deleteDetailButton").on("click", function () {
 		var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
 		if( isNaN(selRow) ) {
 			alert("선택된 행이 없습니다.");
 			return;
 		} else {
 			//전체를 지울수는 없다
 			if( gridViewPop.target.getList().length < 2 ) {
 	 			alert("구매 BOM 은 최소 1개 이상이어야 합니다.");
 	 			return; 				
 			}
 			var actFlag = gridViewPop.target.getList()[selRow].actFlag;	
 	    	//등록상태
 			if( actionType == "C" ) {		
				//신규 추가한 행일 경우만 삭제 				
 				if( selRow > -1 && actFlag == "I") {
 					gridViewPop.target.removeRow(selRow);				 				
 				}
			//수정시 FLAG D 처리
 			} else if(actionType == "U") { 				
 				if( selRow > -1 ) {
 					//기존값이면 D 처리 아니면 row 삭제
 					var coCd = gridViewPop.target.getList()[selRow].coCd;
 					var ordrgNo = gridViewPop.target.getList()[selRow].ordrgNo;
 					var ordrgSeq = gridViewPop.target.getList()[selRow].ordrgSeq;
 					var paramObj = {
 							"coCd" : coCd
 							, "ordrgNo" : ordrgNo
 							, "ordrgSeq" : ordrgSeq
 						} 					

					if( confirm("선택행을 삭제하시겠습니까?\n\n그리드에 변경중인 내용이 초기화 됩니다.")) {
						deleteAjax("/user/sm/sm02/deleteOrderDetail", paramObj, null, function(data) {
							if (data.resultCode == 200) {
								alert(data.resultMessage);
								
								//modalStack.close();
								//inserOrderModal('U');
								gridViewPop.setData(0);
								$.initViewPop();
							}
						});
 	 					//gridViewPop.target.removeRow(selRow); 						
 					}				 							 				
 				} 				
 			} 			
 		}		
	});
	
	//bom 발주수량 set
	$.setOrdrgQty = function(gridObj, chkVal, bomQty, preBomQty, row ) {
		//수량 - 기발주수량 = 발주수량 //수량 - 기발주수량 = 발주수량 
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;	
		
			var bomQty = parseInt(bomQty);
			var preBomQty = parseInt(preBomQty);
			var ordrgQty = parseInt(bomQty - preBomQty);			
		    //발주금액 없을경우 0 셋
		    if( gridList[row].ordrgPrc == "" || typeof(gridList[row].ordrgPrc) == "undefined" ) {
		    	gridObj.target.setValue(row, "ordrgPrc", 0);  
		    }			
        	//수량
        	if(chkVal == "Y") {
        		if( ordrgQty > 0 ) {
        			gridObj.target.setValue(row, "ordrgQty", ordrgQty); 
        			gridObj.target.setValue(row, "dudtDeqDt", $('#dudtDeqDt').val());
        		} else if( isNaN(ordrgQty) || ordrgQty == 0 ) {
        			gridObj.target.setValue(row, "ordrgQty", 0);        			
        		}
        	} else if(chkVal == "N") {
    			gridObj.target.setValue(row, "ordrgQty", "");
    			gridObj.target.setValue(row, "ordrgPrc", ""); 
    			gridObj.target.setValue(row, "dudtDeqDt", "")
    			gridObj.target.setValue(row, "ordrgAmt", "");     
        	}
	}
	
});



//결재요청
$("#approvalReqBtn").on("click", function() {
	//결재  show
	$("#approval_trgt").show();
	if( approvalYn() ) {
		alert("결재가 이미 진행중입니다.");
		return;
	} else {
		gridViewPopApproval.initView().setData3(0);		
	}	
	$("#approvalReqBtn").hide();
})	
	
function setReportMain(_type) {
	var selDataList = gridViewPopApproval.target.getList("");
	if(selDataList.length > 0){
		
		var chkAllY = true; //sanctnSttus 값이 Y인지 체크여부
		
		for(var i = 0; i < selDataList.length; i++){	
			//Y인지 하나씩 확인
			if(selDataList[i].sanctnSttus != "Y"){
				chkAllY = false;
				break;
			}		
		}
		
		if(chkAllY){ //전부 Y이면
			var fileName = "SM0201R03.jrf";
			var arg =  
				  "coCd#"		+  $('#coCd').val()
			    + "#ordrgNo#"	+  $('#ordrgNo').val()
		    	+ "#userId#"	+  jwt.userId
		    	+ "#";                 
			
			if (_type == 'Report') {
				callReport(fileName, arg, 1150, 720, '발주서');
			} else { //Export 작업
				ubiExportAjax(fileName, arg, function(response) {
					if (response.resultCode === 200) {
						var base64FileData = response.base64FileData;
						var fileName = response.exportFileName;
						downloadPDFFromBase64(base64FileData, fileName);
					} else {
						alert('PDF 내보내기 실패: ' + response.resultText);
					}
	
				});
			}
		}else{//Y가 아니면
			alert('결재처리가 완료되지 않았습니다.');
			return false;
		}
	}
	else{
		alert('결재처리가 완료되지 않았습니다.');
		return false;
	}
	
}	

function sendMailCall() {
	var selDataList = gridViewPopApproval.target.getList("");
	if(selDataList.length > 0){
		
		var chkAllY = true; //sanctnSttus 값이 Y인지 체크여부
		
		for(var i = 0; i < selDataList.length; i++){	
			//Y인지 하나씩 확인
			if(selDataList[i].sanctnSttus != "Y"){
				chkAllY = false;
				break;
			}		
		}
		
		if(chkAllY){ //전부 Y이면
			//작업중 표시 하려고 하는데 안됨
			//sendMailExec 함수안에 있는 modalStack.close();는 openBlindModal을 닫는 역할임
		    openBlindModal("/static/html/cmn/modal/screenBlind.html", 1600, 850, "", "");
			try {
				if (approvalConfirmCheck){
			        sendMailExec();
				}
		    } catch (error) {
// 		    	console.log(error);
		    } finally {
		    	blindModal.close();
		    }
		}else{//Y가 아니면
			alert('결재처리가 완료되지 않았습니다.');
			return false;
		}
	}
	else{
		alert('결재처리가 완료되지 않았습니다.');
		return false;
	}
  
}

function approvalConfirmCheck (){
	//확인일자 체크
	if (editVal.todoYn != "Y") {
		alert("결재 승인전 발송 할 수 없습니다.");
		return false;
	}

	var todoCfDtChk = gridViewPopApproval.target.list;
	todoCfDtChk.forEach(function (item) {
        if (item.gb == "결재" && item.todoCfDt !== undefined) {
        	alert(item.name + "님께서 결재 승인하지 않았습니다.");
    		return false;
        }
    });
	
	return true;
}

async function sendMailExec() {

	//파일 첨부 여부(application.yml파일의 spring.fileAttached=YES or NO)
	//****************************************************************
	let fileAttached = false;
	let paramData = {"coCd#":$('#coCd').val()};
	postAjaxSync ("/mail/sendFilefileAttach", paramData, null, function(data) {
		fileAttached = (data.resultCode == "200") ? data.fileAttached : true;
	});
	//****************************************************************
	var fileName = "SM0201R03.jrf";
	var arg =  
		  "coCd#"		+  $('#coCd').val()
    	+ "#ordrgNo#"	+  $('#ordrgNo').val()
    	+ "#userId#"	+  jwt.userId
    	+ "#";         

	var tempUrl = "?file="+fileName;
		tempUrl += "&arg="+encodeURIComponent(arg);
		
	//****************************************************************
	// Report 출력물을 PDF 파일로 변환
	//****************************************************************	
	var attachFile="";
	if (fileAttached == "true") { //파일 첨부일 경우 PDF 변환
		let response = "";
		await ubiExportAjaxSync(fileName, arg, function(result) {
			response=result;
		});
		if (response.resultCode === 200) {
			const base64FileData = response.base64FileData;
			fileName = response.exportFileName;
			attachFile = downloadPDFFromBase64(base64FileData, fileName);
		} else {
// 			console.log('PDF 내보내기 실패: ' + response.resultText);
		}
	}
	//****************************************************************	

	const orderCnt = gridViewPop.target.getList().length;
	var ordetTxt = gridViewPop.target.getList()[0].matrNm;

	ordetTxt = ordetTxt + ((orderCnt > 1) ? (" 외 " + (orderCnt - 1) + "건") : "");
	var tempDudtDeqDt = gridViewPop.target.getList()[0].dudtDeqDt;
    var paramObj = {
       "coCd" : $('#coCd').val(),
       "clntCd" : $('#pchsClntCd').val(),
       "clntMngNm" : "",
       "pgmId" :  "SM0201P01",
       "sendType" :  "SM0201P01",
       "sendKey" : $('#fileTrgtKey').val(),
       "tempUrl" : tempUrl,
       "mailTitle" : moment().format('YYYY-MM-DD HH:mm') + " 기준  발주번호 (" + $('#ordrgNo').val() + ")의 발주서 발송의 건",
       "mailCnts" : ordetTxt + "의 발주서를 첨부와 같이 보내 드리오니 업무 참고 바랍니다.\n" +
       				"        - 아 래 -\n" +
                    " 1. 발주 번호 : " + $('#ordrgNo').val() + "\n" +            
                    " 2. 발주 일자 : " + $('#ordrgDt').val() + "\n" + 
                    " 3. 납기요청일자 : " + tempDudtDeqDt + "\n" + 
                    " 3. 발주 업체 : " + $('#pchsClntNm').val() + "\n" + 
                    " 4. 발주 금액 : " + addCommaStr($('#ordrgAmt').val()) + "\n" + 
                    " 5. 발주 내용 : " + ordetTxt + "\n" + 
                    " 6. 발주 담당자 : " + jwt.userNm + "(" + jwt.email + ")\n" + 
                    " 내용 확인 후 처리 해 주시기 바랍니다.\n" +               
                    " 감사합니다.",                
    };
    
    //카카오 addParam
    let addParam = {
			"ordrgDt": $("#popForm #ordrgDt").val()				//발주일자				
			, "clntNm": $("#popForm #pchsClntNm").val()				//공급사명 - 구매처
			, "ordrgNo": $("#popForm #ordrgNo").val()				//발주번호
			, "ordrgCoCdNm": $("#popForm #coCd option:checked").text()				//발주회사명
			, "ordrgMngNm": $("#popForm #ordrgMngNm").val()				//발주담당자
			, "ordrgMngTelNo": $("#popForm #ordrgMngTelNo").val()				//발주담당자전화번호
			, "tmplatDiv": "TMPLATDIV01"							//알림톡발송템플릿 종류
    }
    Object.assign(paramObj, addParam);
   	//****************************************************************
   	// 파일 첨부 여부에 따라 출력물 첨부
   	//****************************************************************	   
	if (fileAttached == "true") { //파일 첨부 여부
		paramObj["file"]     = attachFile;
		paramObj["fileName"] = fileName;
	}
   	//****************************************************************
    
    modalStack.close();  //blind popup close   	
	openSecondModal("/static/html/cmn/modal/mailSend.html", 640, 850, "메일 보내기", paramObj, function() {});
}	

//요인별요청번호 검색
function openPurchaseSearch() {
	var paramObj = {
			"coCd" : $("#coCd").val(),
			"searchValue" : $("#salesCd").val()
	}		

	paramObj.orderFlag = "Y";
	openSecondModal("/static/html/cmn/modal/purchaseSearch.html", 1200, 420, "요인별요청번호 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];

		$("#salesCd").val(row.salesCd);
		$("#clntPjt").val(row.clntPjtCd);
		$("#eqpNm").val(row.eqpNm);
		$("#itemDivNm").val(row.itemDivNm);
		$("#prdtNm").val(row.prdtNm);
		$("#prdtCd").val(row.prdtCd);
		$("#reqNo").val(row.reqNo);
		$("#ordrsClntCd").val(row.clntCd);
		$("#ordrsClntNm").val(row.clntNm);
		if( row.salesCd != "" ) {
			//수정모드시 update 
			if( actionType == "U" ) var _newReqNo = "U"
			gridViewPop.initView().setData(0, _newReqNo);
		}
	});
} 



//카카오 발송 - 발주서
function commKaKaoSendOrder(param) {
// 	console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

	//알림톡수신번호 채번
	var paramMax = { "userId" : jwt.userId
					, "tmplatDiv": param.tmplatDiv
					, "fileTrgtKey": param.fileTrgtKey 
					/* , "clntCd" : param.clntCd */ //임시 건양
					, "clntCd" : 1
					};
	var maxMessageId = null;			//message id(unique key)
	var talkMessage = null 				//발송될 내용 template
	var mobile = null					//수신인 휴대전화번호
	let talkParam = {};
	let talkBody = {};			
	let sendCnt = 0;	
	postAjaxSync("/user/bm/bm18/selectMaxMessageId", paramMax, null
				, function(data) {   
					if(data.resultList.length > 0 ) {
						if( data.resultList[0].maxMessageId != "" ) {
							maxMessageId = data.resultList[0].maxMessageId;							
							talkMessage = data.resultList[0].messageDesc;
							mobile =  data.resultList[0].mngMoblphonNo;
							param.nameTo =  data.resultList[0].mngNm; //수신인 이름
						} else {
							alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
							return;
						} 

					}
	});     //user search ajax end
	if(mobile == "" || mobile == null) {
		alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
		return;
	}
	
	//message 치환
	let message = talkMessage;
	let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);	
	//loop
	$.each(splitStr, function (key, val) {		
		let compKey = val.substring(1, val.length-1);
		if( compKey != "" && compKey != "undefined" ) {
			if( typeof(param[compKey]) != "undefined" ) {
				let val2 = '#'+val;
				message = message.replaceAll(val2, param[compKey]);
			}
		}
	});

	talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
	talkParam.serverName = "gyitt2400";		
	talkParam.paymentType = "P";
	talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
	talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);	
	//talkBody.messageType = "AT";			//톡드림 포탈 템플릿 사용하지 않을 경우 사용 (AT: 알림톡, AI: 이미지 알림톡 (messageType 누락시 AT가 기본값으로 사용됨)
	//talkBody.title = "(주)건양아이티티";				//알림톡 타이틀 -
	talkBody.title = param.mailTitle;					//알림톡 타이틀 -
	talkBody.message = message;				//알림톡 메시지 (1000 byte) 
	talkBody.mobile = mobile;				//휴대전화번호
	talkBody.template = "10001";			//템플릿관리화면 템플릿ID	- 발주서 V2
	let talkJson = JSON.stringify(talkBody);
	sendCnt = kakaoSendReal(talkJson, talkParam, param);
	//한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
	talkBody.messageId = 'KAKAO'+Number(maxMessageId.substring(5, 20))+1;
	talkBody.mobile = "01063893764"
	talkJson = JSON.stringify(talkBody);
	//kakaoSendReal(talkJson, talkParam, param);
	
	if( sendCnt > 0 ) {
// 		alert("알림톡 정상 발송되었습니다.");		
	}	
}

		
/*
#	TODO 알림톡발송 시작
#
*/
$("#approvalReqTodoBtn").on("click", function () {
	kakaoTodo('reConfirm');
});

function kakaoTodo(reConfirmYn) {
	let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
	let reConfirm = (typeof(reConfirmYn) != "undefined") ? "Y" : "N"; 
	let param = {
			"tmplatDiv": "TMPLATDIV02"
			, "coCd": $("#popForm #coCd").val()				//해당업무의 coCd(트르넷발주 TRN )
			, "todoDiv1CodeId": "TODODIV20"					//공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV2050"					//공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "결재"						//공통코드 해당업무 - 결재 - 발주서
			, "todoDiv2CodeNm": "발주요청"						//공통코드 해당업무 - 결재 - 발주서
			, "sanctnDiv2": "결재"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo": $("#popForm #ordrgNo").val()
			, "clntCd": "1"					//발신회사는 로그인사용자 회사
			, "clntNm": clntNm				//로그의 수신거래처명
			, "ordrgMngNm": $("#popForm #ordrgMngNm").val()			//발주작성자(담당자)
			, "ordrgMngTelNo": $("#popForm #ordrgMngTelNo").val()		//담당자전화번호		
			, "creatPgm": "SM0201P01"
			, "reConfirm": reConfirm
	}
	commKaKaoSendTodo(param);	
}

//to-do결재요청 알림톡
function commKaKaoSendTodo(param) {
// 	console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

	//알림톡수신번호 채번
	var maxMessageId = null;			//message id(unique key)
	var talkMessage = null 				//발송될 내용 template
	var mobile = null					//수신인 휴대전화번호
	var title = null					//todo title
	var sendList = [];
	let talkParam = {};
	let talkBody = {};		
	let sendCnt = 0;
	postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
				, function(data) {   
					if(data.resultList.length > 0 ) {
						if( data.resultList[0].maxMessageId != "" ) {
							sendList = data.resultList; 
						} else {
							alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
							return;
						} 

					}
	});     	
	//user search ajax end
	if( sendList.length == 0 ) {
		alert("발송대상이 없습니다.");
		return;
	}
	
	//대상 loop
	$.each(sendList, function (key, sendObj) {
		maxMessageId = sendObj.maxMessageId;							
		talkMessage = sendObj.messageDesc;
		mobile =  sendObj.telNo;
		//로그용
		param.rcvId = sendObj.todoId;			//todo 수신id
		param.rcvNm = sendObj.name;				//todo 수신자명
		param.nameTo = sendObj.name;				//todo 수신자명
		title =   sendObj.todoTitl;
		param.title = title;								//요청내용제목
		param.sendDt = sendObj.sendDt;
		
		if(mobile == "" || mobile == null) {
			alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
			return;
		}
		if(talkMessage == "" || talkMessage == null) {
			alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
			return;
		}	
		//message 치환
		let message = talkMessage;
		let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);	
		//loop
		$.each(splitStr, function (key, val) {		
			let compKey = val.substring(1, val.length-1);
			if( compKey != "" && compKey != "undefined" ) {
				if( typeof(param[compKey]) != "undefined" ) {
					let val2 = '#'+val;
					message = message.replaceAll(val2, param[compKey]);
				}
			}
		});

		talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
		talkParam.serverName = "gyitt2400";		
		talkParam.paymentType = "P";
		talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
		talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);	
		talkBody.title = title;					//알림톡 타이틀 -
		talkBody.message = message;				//알림톡 메시지 (1000 byte) 
		talkBody.mobile = mobile;				//휴대전화번호
		talkBody.template = "10003";			//템플릿관리화면 템플릿ID	- 발주서 V2
		let talkJson = JSON.stringify(talkBody);		
		sendCnt = kakaoSendReal(talkJson, talkParam, param);		
	});
	//대상 loop end
	if( sendCnt > 0 ) {
// 		alert("알림톡 정상 발송되었습니다.");		
	}
	
	//한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
//	talkBody.messageId = 'KKO'+Number(talkBody.messageId.substring(3, 20))+1;
//	talkBody.mobile = "01063893764"
//	talkJson = JSON.stringify(talkBody);
	//kakaoSendReal(talkJson, talkParam, param);
}


//통화단위 변경
function exrateCal() {
	var currCd = $('#currCd').val();
	var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
	$('#exrate').val(exrateVal ? exrateVal : '');

}		


</script>