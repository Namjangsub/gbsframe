<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">매출계산서 등록</h4>

  <form id="popForm" onSubmit="return false;"> 
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="CR0801M01">		
 		<table>
        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>
        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCdS1" name="coCdS1" data-kind="CO"   msg="회사" required>
				</select>
			</td>
			<th >계산서번호</th>
			<td>
				<input type="text" id="sellBillNo" name="sellBillNo" msg="계산서번호" >
			</td>
			<th class="hit">고객사</th>
            <td>
            <input type="hidden" id="ordrsClntCdS1" name="ordrsClntCdS1" msg="고객사코드" required>
			<div class="search_form">
			  <input type="text" id="ordrsClntNmS1" name="ordrsClntNmS1" msg="고객사" required>
				<a onclick="clntSearch();">
                   <i class="i_search_w"></i>
             </div>
            </td>
			<th class="hit">발행일자</th>
			<td>
			  <input id="sellBillDt" name="sellBillDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"   msg="발행일자"  date required>
			</td>
        </tr>

        <tr>
			<th class="hit">통화단위</th>
			<td>
				<select id="currCd" name="currCd" data-kind="CURR"  msg="통화단위" required>
				  <option value="">선택</option>
				</select>
			</td>			
			<th>환율</th>
			<td>
				<input type="text" id="exrate" name="exrate" comma msg="환율">
			</td>
			<th class="hit">발행금액</th>
			<td>
				<input type="text" id="sellBillDtlAmt" name="sellBillDtlAmt"  msg="발행금액"  >
			</td>
			<th colspan="2">
			    <input type="hidden" id="ordrsNo" name="ordrsNo" ><!-- 수주번호 -->
			    <input type="hidden" id="sellDcsnNo" name="sellDcsnNo" ><!--매출확정번호  -->
				<input type="hidden" id="clmnPlanSeq" name="clmnPlanSeq" ><!--수금계획순번 -->
				<input type="hidden" id="creatPgm" name="creatPgm" ><!--생성프로그램id -->
				<input type="hidden" id="creatId" name="creatId" ><!--생성자 -->
				<input type="hidden" id="udtId" name="udtId" ><!--최종변경자 -->
			    <input type="hidden" id="udtPgm" name="udtPgm" ><!--최종수정프로그램ID -->
			</th>
        </tr>
        <tr>
			<th>적요</th>
			<td colspan="3">
				<input type="text" id="sellBillSumrmk" name="sellBillSumrmk" msg="적요">
			</td>
			<th>비고</th>
			 <td colspan="2">
			    <input type="text" id="sellBillDtlRmk" name="sellBillDtlRmk" msg="비고">
			 </td>
		    <th></th>	 
        </tr>        
      </table>
    </form>
	</div>
	 
	
	 <div class="popup_table">               
        <table style="border:0px;">
            <tr>
              <td style="text-align: LEFT; border-right: 0px;">※ 발행정보(계산서번호 없이 고객사 지정시 해당 거래처 내 계산서 미발행 매출확정 리스트를 입력대상으로 조회)</td>
            </tr>
            <tr>
              <td>
               <div class="contents">
				 <div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 300px; width: 100%" ></div>
			   </div>
			  </td> 
			</tr>  
        </table>
    </div> 

	<!-- 공통 파일 영역 -->
        <div class="col-sm-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 400px;padding: 5px">
                    <div id="deptTreeOrdars"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
                <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
            </div>
        </div>
        	
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	
	var gridView = {
			initView : function() {
	  			this.target = new ax5.ui.grid();
	  			this.target.setConfig({
	  		    	showRowSelector: true,
	  		    	multipleSelect: false,
	  		    	sortable: true,
	  		        target: $('[data-ax5grid="first-grid-modal"]'),
	  		        header: {
	  		        	align: "center",
	  		        	selector: true
	  		        },
	  		        body: {  		        	
	  		        	 onClick: function () {
	  		                this.self.select(this.dindex);
	  		                var index = this.dindex;
		  	           	 	var item = this.item;
		  	                var self = this.self;
	  		                gridSetDataIn(item, index, self); 
		  	                 //gridSetDataIn_(item, index, self); 
	  		            },
	  		            onDBLClick: function () {
	  		            	this.self.clearSelect();
	  		                this.self.select(this.dindex);
	  		            }
	  		        },				
	  		        columns : [
	  		        	 {key: "rnum",      	 label: "No",			width: 50,      align: "center",	hidden:false}
						,{key: "fileTrgtKey",	 label: "파일대상KEY",	    width: 50,		align: "center", 	hidden:true}
						,{key: "coCd",	    	 label: "회사코드",		width: 50,		align: "center", 	hidden:true}
						,{key: "codeNm",	   	 label: "회사명",			width: 50,		align: "center", 	hidden:true}
						,{key: "ordrsDt",		 label: "수주일자", 		width: 50,	    align: "center",	hidden:true}
						,{key: "ordrsClntCd",	 label: "고객사", 		width: 50,		align: "center",	hidden:true}
						,{key: "ordrsExrate",	 label: "환율",		    width: 50,		align: "center",	hidden:true}
						,{key: "ordrsCurrCd",	 label: "통화단위",		width: 50,		align: "center", 	hidden:true}	
						,{key: "clmnPlanSeq",	 label: "수금계획순번",	    width: 50,		align: "center", 	hidden:true}
						,{key: "clmnCurrCd",	 label: "통화단위2",	    width: 50,		align: "center", 	hidden:true}
						,{key: "clmnCurrNm",	 label: "통화단위명2",	    width: 50,		align: "center", 	hidden:true}
						,{key: "clmnExrate",	 label: "환율2",	        width: 50,		align: "right",  	hidden:true}
						,{key: "clmnPlanDiv",	 label: "수금구분",		width: 50,		align: "center", 	hidden:true}								
						,{key: "ordrsNo", 		 label: "수주번호", 	    width: 80,		align: "center",	hidden:false}
						,{key: "ordrsClntNm",	 label: "고객사명",		width: 80,		align: "center", 	hidden:false}
						,{key: "clntPjt",	   	 label: "고객사pjt",		width: 80,		align: "center", 	hidden:false}
						,{key: "ctrtNm",	   	 label: "계약명",		    width: 80,		align: "center", 	hidden:false}
						,{key: "ordrsCurrNm",	 label: "통화단위명",		width: 80,		align: "center", 	hidden:false}
						,{key: "clmnPlanDivNm",	 label: "수금구분명",		width: 80,		align: "center", 	hidden:false}
						,{key: "clmnDivSeq",	 label: "차수",	        width: 70,		align: "center",	hidden:false}	
						,{key: "clmnRate",	   	 label: "비율",	        width: 70,		align: "center", 	hidden:false}
						,{key: "clmnAmt",	     label: "수금금액",	    width: 100,		align: "center",	formatter: "money"}
						,{key: "clmnBillPblsDt", label: "계산서발행일자",	width: 100,		align: "center", 	hidden:false}
						,{key: "clmnDt",	   	 label: "수금일자",	    width: 100,		align: "center", 	hidden:false}
						,{key: "befBillAmt",	 label: "기 계산서발행금액",  width: 120,	    align: "right", 	formatter: "money"}
						,{key: "sellDcsnNo",	 label: "매출확정번호",	    width: 100,	    align: "center",	hidden:false}
						,{key: "trgtBillAmt",	 label: "계산서 미발행확정금액", width: 120,	align: "right",     formatter: "money"}						
						,{key: "chk",            label: "",             width: 50,      sortable: false,    align: "center",
							editor: { type: "checkbox", config: {height: 17, trueValue: "Y", falseValue: "N"}}				            	
				         }	
						,{key: "billAmt",	     label: "계산서발행금액",	width: 100,	    align: "right", 	hidden:false}
						<!--,{key: "billAmt", label: "계산서발행금액",  width: 100,	align: "right", formatter: "money", editor: {type: "money", updateWith: ['trgtBillAmt']}}  -->
						]			        
	  			      });
       			return this;
       		   },   
	        		

			setData : function() {
				if (isFirst) return;
				var targetObj = this.target;
				
				if (inputValidation($('input[required]'))) {
					var formData = {};
					$.each($('[data-search]'), function(idx, elem){
						formData[$(elem).data("search")] = $(elem).val();
					});	
					    formData["searchType"]   = $("#searchType_S").val();
						formData["searchValue"]   = $("#searchValue_S").val();
						formData["coCd"] = $("#coCdS1").val();  
						formData["ordrsClntCd"] = $("#ordrsClntCdS1").val();
						
					postAjax("/user/cr/cr08/selectSalesStmtConList", formData, null, function(data){		
					var list = data.result;
						targetObj.setData({
	  						list : list,
	  						page : {
	  							totalElements : data.paginationInfo.totalRecordCount
	  						}
	  					});
	  				});
	  			}
	  		}
	  	}
	

	 $(document).ready(function() {
		 setCommonSelect($(".popup_area select[data-kind]"));
		 setByCoCd(modalStack.last().paramObj.coCd);
		 
		 $("#coCdS1").val(jwt.coCd);
		 $("#popForm #userId").val(jwt.userId);
	
		 authChk();						// 권한체크
	
		 actionType = modalStack.last().paramObj.actionType;
	     fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	     var ordrsNo = modalStack.last().paramObj.ordrsNo;
	     
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//--------------------------------------------------------------- 
		
		if (actionType == "C") {
			
			var today = new Date();
			var year = today.getFullYear();
			var month = today.getMonth()+1;
			var day = today.getDate();

			sellBillDt = year+"-"+(("00"+month.toString()).slice(-2))+"-"+(("00"+day.toString()).slice(-2));						
			$("#sellBillDt").val(sellBillDt); 
			
			$("#coCdS1").prop("readonly", true);
	    	$("#sellBillNo").prop("readonly", true);
	    	$("#sellBillDtlAmt").prop("readonly", true);
	 	    
	    	 gridView.initView();
	    	
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				  insertSalesStmt();
			});
			
		} else if (actionType == "U") {
			
			$('.tit').text('매출계산서 수정')
			$("#coCdS1").prop("disabled", true);
	    	$("#ordrsClntCdS1").prop("disabled", true);
	    	$("#ordrsClntNmS1").prop("disabled", true);
	    	$("#sellBillDt").prop("disabled", true);
	    	$("#currCd").prop('disabled',true);
	    	$("#sellBillNo").prop("readonly", true);
	    	$("#sellBillDtlAmt").prop("readonly", true);
	    	
			$("#fileTrgtKey").val(fileTrgtKey);
			$("#sellBillNo").val(modalStack.last().paramObj.sellBillNo);
		 	$("#sellBillDt").val(modalStack.last().paramObj.sellBillDt);    //발행일자
	       	$("#sellBillDtlAmt").val(modalStack.last().paramObj.sellBillAmt);  //발행금액
	    	$("#sellBillSumrmk").val(modalStack.last().paramObj.sellBillSumrmk);  
	    	$("#sellBillDtlRmk").val(modalStack.last().paramObj.sellBillRmk); 
	    	$("#ordrsClntCdS1").val(modalStack.last().paramObj.ordrsClntCd); 
	    	$("#currCd").val(modalStack.last().paramObj.currCd);
	    	$("#ordrsClntNmS1").val(modalStack.last().paramObj.ordrsClntNm);
	    	$("#ordrsNo").val(modalStack.last().paramObj.ordrsNo);
	    	$("#sellDcsnNo").val(modalStack.last().paramObj.sellDcsnNo);
	    	$("#clmnPlanSeq").val(modalStack.last().paramObj.clmnPlanSeq);
	    	$("#creatPgm").val(  modalStack.last().paramObj.creatPgm);
	    	$("#creatId").val(modalStack.last().paramObj.creatId);
	    	$("#udtId").val(modalStack.last().paramObj.udtId);
	    	$("#udtPgm").val(modalStack.last().paramObj.udtPgm);
	    	$("#exrate").val(modalStack.last().paramObj.exrate);
	    	//selectSalesStmtInfo();
	    	  gridView.initView().setData(0);
	    	
			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {				
				$("#coCdS1").prop("disabled", false);
		    	$("#ordrsClntCdS1").prop("disabled", false);
		    	$("#ordrsClntNmS1").prop("disabled", false);
		    	$("#sellBillDt").prop("disabled", false);
		    	$("#currCd").prop('disabled',false);
				updateSalesStmt();
			});
		}
	
		 $('#currCd').on('change', exrateCal);		
	     
	     // 검색조건 이벤트 bind
	  	 $('[data-search]').on("change", function(){
	  			gridView.setData(0);
	  	 });
		
	});
	 
		
	 $('#sellBillDt').datepicker({
			format: "yyyy-mm-dd",
	        language: "ko",
	        autoclose: true
		   });
	
	  setCurrentDateToDatePicker('#sellBillDt');
	
	function gridSetDataIn_(item, index, self){
		
		var row = gridView.target.getList("selected"); 
			console.log(row);
			console.log(typeof row.length + ": " + row.length);
			var sum = 0;
			sum = Number(item.trgtBillAmt);
			$("#sellBillDtlAmt").val(sum);
			
			for(let i = 0; i < row.length; i++) {
				var trgtBillAmt = Number(row[i].trgtBillAmt);
				//sum += trgtBillAmt;
				
				if (item.chk == "Y") {	
					sum += trgtBillAmt;	
					$("#sellBillDtlAmt").val(sum);
				}else if(item.chk == "N") {	
					alert(sum);
					alert(trgtBillAmt);
					sum = sum - Number(trgtBillAmt)
					$("#sellBillDtlAmt").val(sum);
				}
			}
			
			  
	}
	
    function gridSetDataIn(item, index, self){
    	
    	 var targetObj = this.target;
    	  var row = gridView.target.getList()[index];
    	  $("#ordrsNo").val(row.ordrsNo);
          $("#sellDcsnNo").val(row.sellDcsnNo);
          $("#clmnPlanSeq").val(row.clmnPlanSeq);
          $("#creatPgm").val("CR0801M"); 
          $("#creatId").val(jwt.userId);
          $("#udtId").val(jwt.userId);
          $("#udtPgm").val("CR0801M"); 
        
          if(item.trgtBillAmt !== undefined) {
        	if (item.chk == "Y") {	        		 
        		 self.updateRow($.extend({}, item, { 					
 					ordrsNo : item.ordrsNo,
        			ordrsClntNm : item.ordrsClntNm,
        			clntPjt : item.clntPjt,
        			ctrtNm : item.ctrtNm,
        			ordrsCurrNm : item.ordrsCurrNm,
        			clmnPlanDivNm : item.clmnPlanDivNm,
        			clmnDivSeq : item.clmnDivSeq,
        			clmnRate : item.clmnRate,
        			clmnAmt : item.clmnAmt,
        			clmnBillPblsDt : item.clmnBillPblsDt,
        			clmnDt : item.clmnDt,
        			befBillAmt : item.befBillAmt,
        			sellDcsnNo : item.sellDcsnNo,
        			chk : item.chk,
        			trgtBillAmt : item.trgtBillAmt,
        			billAmt : item.trgtBillAmt 
 				}), index);	 
        		 self.updateColumn({
 					key : "",
 					label : "",
 					align : "",
 					width : ""	
 				}, 0); 
        		var row = gridView.target.getList("selected"); 
 				console.log(row);
 				console.log(typeof row.length + ": " + row.length);
 				var sum = 0;
				sum = Number(item.trgtBillAmt);
				$("#sellBillDtlAmt").val(sum);
 				for(let i = 0; i < row.length; i++) {
 					var	trgtBillAmt = Number(row[i].trgtBillAmt);
 					 sum = sum + trgtBillAmt;
 				} 				
 				$("#sellBillDtlAmt").val(sum);
 				
        	} else if (item.chk == "N") {  
        		
        		self.updateRow($.extend({}, item, {
        			
					ordrsNo : item.ordrsNo,
        			ordrsClntNm : item.ordrsClntNm,
        			clntPjt : item.clntPjt,
        			ctrtNm : item.ctrtNm,
        			ordrsCurrNm : item.ordrsCurrNm,
        			clmnPlanDivNm : item.clmnPlanDivNm,
        			clmnDivSeq : item.clmnDivSeq,
        			clmnRate : item.clmnRate,
        			clmnAmt : item.clmnAmt,
        			clmnBillPblsDt : item.clmnBillPblsDt,
        			clmnDt : item.clmnDt,
        			befBillAmt : item.befBillAmt,
        			sellDcsnNo : item.sellDcsnNo,
        			chk : item.chk,
        			trgtBillAmt : item.trgtBillAmt,
        			billAmt : 0
        			
				}), index);
        		self.updateColumn({
					key : "",
					label : "",
					align : "",
					width : ""	
				}, 0);
       	} 
      }
    }
    	
	function clntSearch() {			
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색",  {}, function (grid) {
			var row = grid.target.getList("selected")[0];
				$('#ordrsClntCdS1').val(row.clntCd);
				$('#ordrsClntNmS1').val(row.clntNm);
				gridView.initView().setData(0);
		});
	}
	
	// 현재 날짜 넣기
	function setCurrentDateToDatePicker(selector) {
        var currentDate = new Date();
        //alert(currentDate);
        currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset()); // 시간대를 고려한 날짜 시간 조정
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1; // 월은 0부터 시작하므로 1을 더합니다.
        var day = currentDate.getDate();

        //console.log(year+ " " + month + " " + day);
        
		// 월과 일이 한 자리수라면 앞에 '0'을 추가합니다.
        if (month < 10) month = '0' + month;
        if (day < 10) day = '0' + day;

        var formattedDate = year + '-' + month + '-' + day;
        $(selector).val(formattedDate);

    }

	//통화단위 변경
	function exrateCal() {
		var currCd = $('#currCd').val();
		var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
		$('#exrate').val(exrateVal ? exrateVal : '');

	}
	
	function insertSalesStmt() {
		if (inputValidation($('.popup_area [required]'))) {						
		if($("#sellBillDtlAmt").val() == ""){	
			alert("발행금액을 발행정보 리스트에서 선택해주세요");			
		}else{	
			var formData = makeFormData();											
			filePostAjax("/user/cr/cr08/insertSalesStmt", formData,		
					function(data) {
						alert(data.resultMessage);								
						if (data.resultCode == 200) {							
						    parent.gridView_S2.initView().setData(0);
							modalStack.close();									
						}
					});
		  }
	   }	
	}

	// 수정
	function updateSalesStmt() {
		if (inputValidation($('.popup_area [required]'))) {					
			var formData = makeFormData();										
	      	filePostAjax("/user/cr/cr08/updateSalesStmt", formData,function(data) {
	      		         alert(data.resultMessage);
	      		        if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		alert(jwt.userId);
		alert($('#ordrsClntCdS1').val());
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#ordrsClntCdS1').val());			//첨부화일용
		//formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		//formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		//formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}		
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}
	
	
</script>