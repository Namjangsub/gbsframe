    <div class="popup_area of_a" style="height: 100%;">
        <div id="first-focus" class="tit_contents">
            <h4 class="tit">견적 등록</h4>
        </div>

        <div id="overlay2" style="z-index: 100; display: none; position: absolute; width: 100%; height: 670px; top: 0; left: 0; background-color: rgba(0, 0, 0, 0); pointer-events: auto;"></div>
        <div style="text-align: right; background: #e6e6e6">
            <a class="tbody_more_btn"></a>
        </div>

        <div class="toggle-div" style="padding-left: 0;">
            <div class="popup_table">
                <form id="popForm" onSubmit="return false;">
                    <input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
                    <input type="hidden" id="userId"      name="userId">
                    <input type="hidden" id="pgmId"       name="pgmId" value="CR0101M01">
                    <table>
                        <tr>
                            <th class="hit coCd" title="회사를 선택합니다">회사</th>
                            <td><select id="coCd" name="coCd" data-kind="CO" onchange="setByCoCd(this.value)" required class="form-control input-sm"></select></td>
                            <th  title="견적번호를 확인하거나,입력합니다">견적번호</th>
                            <td><input style="background-color: #e6e6e6 !important" type="text" id="estNo" name="estNo" readonly></td>
                            <th  title="견적차수를 확인합니다">견적차수</th>
                            <td><input style="background-color: #e6e6e6 !important" type="text" id="estDeg" name="estDeg" readonly required></td>
                            <td colspan="2">
                                <div style="text-align: left">
                                    <button type="button" title="차수를 증가시키는 버튼입니다" style="display: none" id="degUpBtn" authchk="">차수 증가</button>
                                </div>
                            </td>
                        </tr> 
                        <tr>
                            <th class="hit pblsDt" title="발행일자를 확인합니다">발행일자</th>
                            <td><input type="text" class="input_calendar" autocomplete="off" id="pblsDt" name="pblsDt" class="form-control input-sm" onkeyup="dateMask(this);" date required></td>
                            <th class="estDt" title="작성일자를 선택합니다">작성일자</th>
                            <td><input type="text" id="estDt" name="estDt" class="form-control input-sm" date readonly></td>
                            
                            <th class="hit estClntNm" title="고객사를 선택합니다">고객사</th>
                            <td><input type="hidden" id="estClntCd" name="estClntCd">
                                <div class="search_form estClntNm">
                                    <input onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);" type="text" class="form-control input-sm" id="estClntNm" name="estClntNm" required> <a
                                        onclick="openSecondClntSearch(document.getElementById('estClntNm').value);"> <i class="i_search_w"></i>
                                    </a>
                                </div></td>
                            <th>고객사PJT</th>
                            <td>
                                <div class="search_form">
                                    <select id="clntPjt" name="clntPjt" data-kind="PRJCTCD"></select>
<!--                                     <input onclick="" type="text" id="clntPjt" name="clntPjt" value=""> -->
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th  title="고객담당자 정보를 입력합니다">고객담당자</th>
                            <td><input type="text" id="cstmMngNm" name="cstmMngNm" class="form-control input-sm"></td>
                            <th  title="담당자 연락처 정보를 입력합니다">담당자 연락처</th>
                            <td><input type="text" id="cstmMngHp" name="cstmMngHp" class="form-control input-sm"></td>
                            <th class="hit mngIdVisible" title="견적제출자 정보를 확인합니다">견적제출자</th>
                            <td>
                                <div class="search_form mngIdVisible">
                                    <input onkeydown="if(event.keyCode==13)openSecondUserSearch( this.value);" type="text" id="mngIdVisible" name="mngIdVisible" class="form-control input-sm" required> <input type="hidden" id="mngId" name="mngId">
                                    <a onclick="openSecondUserSearch( document.getElementById('mngIdVisible').value);"> <i class="i_search_w"></i>
                                    </a>
                                </div>
                            </td>
                            <th class="hit exrate">환율</th>
                            <td><input type="text" id="exrate" name="exrate" class="form-control input-sm"></td>
                        </tr>
                        <tr>
                            <th class="hit estNm" title="공사명을 입력합니다">공사명</th>
                            <td colspan="3"><input type="text" id="estNm" name="estNm" class="form-control input-sm" required></td>
                            <th class="hit currCd" title="통화단위를 선택합니다">통화단위</th>
                            <td><select id="currCd" name="currCd" data-kind="CURR" onchange="setByCoCd(this.value)" class="form-control input-sm" required></select></td>
                            <th title="견적금액을 입력합니다">견적금액</th>
                            <td><input type="text" id="estAmt" name="estAmt" comma readonly="readonly"></td>
                        </tr>
                        <tr>
                            <th  title="견적제외사항을 입력합니다">견적제외사항</th>
                            <td colspan="3"><textarea id="estExcept" name="estExcept" style="width: 100%; height: 95px" class="form-control input-sm"></textarea></td>
                            <th  title="견적기준을 입력합니다">견적기준</th>
                            <td colspan="3"><textarea id="estStd" name="estStd" style="width: 100%; height: 95px;" class="form-control input-sm"></textarea></td>
                        </tr>
                        <tr>
                            <th  title="납품조건을 입력합니다">납품조건</th>
                            <td><input type="text" id="estDlvrCndt" name="estDlvrCndt" class="form-control input-sm"></td>
                            <th  title="결재조건을 입력합니다">결재조건</th>
                            <td><input type="text" id="estPmntCndt" name="estPmntCndt" class="form-control input-sm"></td>
                            <th  title="납기 정보를 입력합니다">납기</th>
                            <td><input type="text" id="estDudt" name="estDudt" class="form-control input-sm"></td>
                        </tr>
                        <tr>
                            <th  title="수주확정여부를 확인합니다">수주확정여부</th>
                            <td><input style="background-color: #e6e6e6 !important" type="text" id="ordrsYn" name="ordrsYn" readonly></td>
                            <th  title="수주확정일자를 확인합니다">수주확정일자</th>
                            <td><input style="background-color: #e6e6e6 !important" type="text" id="ordrsDt" name="ordrsDt" readonly></td>
                            <th  title="견적NEGO금액을 입력합니다">견적NEGO금액</th>
                            <td><input type="text"  id="estNegoAmt" name="estNegoAmt" onkeydown="if (event.keyCode == 9) {event.preventDefault(); focusOnGrid();}" class="form-control input-sm"></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
        
        <br>
        <div class="popup_table">
            <div class="tbody_more" style="text-align: right; background: #e6e6e6">
                <a class="tbody_more_btn"></a>
            </div>
            <div class="toggle-div" style="padding-left: 0;">
                <div  style="padding-left: 0;">
                    <div id="est_grid" class="contents" style="margin: 0px; padding: 0px; height: 380px; width: 100%; min-width: 200px; border-radius: 0;">
                        <div class="contents_tit">
                            <div style="float: right" class="add_btn_small pdl10">
                                <a id="addProductButton" style="height: 20px; line-height: 18px; margin-top:8px; margin-bottom: 8px;">+</a>
                                <a id="deleteProductButton" style="height: 20px; line-height: 18px; margin-top:8px; margin-bottom: 8px;">-</a>
                            </div>
                        </div>
                        <div class="contents" style="margin: 0px; padding: 0 5px; height: 80%; width: 100%; min-width: 300px">
                            <div data-ax5grid="est-grid-modal" data-ax5grid-config="{}" style="height: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 공통 파일 영역 -->
        <div id="fileList_area" style="margin-bottom: 30px;"></div>

        <!-- 하단 버튼 -->
        <div class="popup_bottom_btn">
            <button id="actionBtn" authchk>등록</button>
            <button class="close_btn" onclick="  modalStack.close();">닫기</button>
        </div>
    </div>

    <script type="text/javascript">
        var actionType  = modalStack.last().paramObj.actionType;
        var fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
        var paramObj = modalStack.last().paramObj;
        var detailArr   = []; // 상세 그리드내용
    
            
        /* 리스너 */
//         $(document).on("change", "input[name='estQty'], input[name='estWt'], input[name='estAmt'], input[name='expAmt']", function () {
//         });
    
//         $(document).on("click", "#fileBtn", function () {
//             $("#file").click();
//         });

        /* document.ready */
        $(document).ready(function () {
            // 공통코드 selectBox set
            setCommonSelect($(".popup_area select[data-kind]"));

            $("#coCd").val(modalStack.last().paramObj.coCd);
            $("#popForm #userId, #mngId").val(jwt.userId);
            $("#popForm #mngIdVisible").val(jwt.userNm);

            $('.tbody_more_btn').click(function () {
                $(this).toggleClass('on');
                $(this).parent().next('.toggle-div').toggle();
            });

            $('#estExcept').val("1.기계기초\n2.1차 UTILITY 인입공사(AIR, 전기)\n3.SPARE PART");
            
            var inputIds = ['estAmt', 'estNegoAmt', 'exrate', 'cstmMngHp'];
            const alertDebounced = debounce(() => alert("숫자만 입력 가능합니다."), 300);
            
            // 디바운스 함수
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    const context = this;
                    if (timeout) clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(context, args);
                    }, wait);
                };
            }
    
            inputIds.forEach(function (id) {
                document.getElementById(id).addEventListener('input', function (e) {
                    let input = e.target.value;
                    let pureNumber = input.replace(/[^0-9,]/g, ''); // 숫자와 콤마가 아닌 문자 제거
    
                    // 한글을 포함하는 경우 경고 메시지 출력하고 함수 종료
                    if (/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(input)) {
                        alertDebounced();
                        e.target.value = pureNumber;
                        return;
                    }
                    if (id === 'cstmMngHp') {
                        if (pureNumber.length > 11) { // 입력값의 길이가 11자리를 초과하면 초과하는 부분 제거
                            pureNumber = pureNumber.slice(0, 11);
                        }
    
                        let formatted = '';
    
                        if (pureNumber.length < 4) {
                            return e.target.value = pureNumber;
                        } else if (pureNumber.length < 7) {
                            formatted += pureNumber.substr(0, 3);
                            formatted += '-';
                            formatted += pureNumber.substr(3);
                        } else if (pureNumber.length < 11) {
                            formatted += pureNumber.substr(0, 3);
                            formatted += '-';
                            formatted += pureNumber.substr(3, 3);
                            formatted += '-';
                            formatted += pureNumber.substr(6);
                        } else { // input.length === 11
                            formatted += pureNumber.substr(0, 3);
                            formatted += '-';
                            formatted += pureNumber.substr(3, 4);
                            formatted += '-';
                            formatted += pureNumber.substr(7);
                        }
    
                        e.target.value = formatted;
                    } else {
                        // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
                        e.target.value = e.target.value.replace(/[^0-9,]/g, '');
                        // 세 자리마다 콤마를 삽입합니다.
                        e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        // 0으로 시작하는 부분을 제거합니다.
                        e.target.value = e.target.value.replace(/^0+/, '');
                    }
                });
                
            });
    
            // 견적일자 datepicker bind
            $('#pblsDt, #estDt, #winbdDt').datepicker('destroy').datepicker({
                format: "yyyy-mm-dd",
                language: "ko",
                autoclose: true
            });
            
			var dateValue = moment(new Date()).format("YYYY-MM-DD");
            $('#pblsDt, #estDt').datepicker("setDate", dateValue)
    
    
            $('#ordrsDiv').on('change', function () {
                var selectedValue = $(this).val();
                if (selectedValue === 'normal') {
                    $('#orgnSalesCd').prop('required', false);
                } else {
                    $('#orgnSalesCd').prop('required', true);
                }
            }).trigger('change');

            authChk(); //권한체크

    		// 회사구분 변경에 따른 적용
    		$('#coCd').on('change', function () {
	            //---------------------------------------------------------------
	            //첨부 화일 처리 시작
	            //---------------------------------------------------------------
				$('#fileList_area').empty();
	            fileParam = {
	                fileTrgtTyp    : $("#pgmId").val(),
	                fileTrgtKey : fileTrgtKey
	            }
	            
	            treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
	            //---------------------------------------------------------------
	            //첨부 화일 처리 끝
	            //---------------------------------------------------------------
            });

            $('#coCd').change();
            //초기 자료 로드 이후 등록 수정작업에 따른 작업 구분
            firstJobRetrive();
            
        });
    
        
        // 견적 정보 삽입 함수
        function insertEst() {
            if (validateRequiredFields() && inputValidation($('.popup_area [required]'))) {
                var formData = makeFormData();
                filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
                    if (data.resultCode == 200) {
                        modalStack.close();
                        gridView.setData(0);
                    } else {
                    	alert(data.resultMessage);
                    }
                });
            }
        }
    
        // 견적 정보 업데이트 함수
        function updateEst() {
            //비고 문자열 길이 필드길이로 byte 자르기
            if (validateRequiredFields() && inputValidation($('.popup_area input[required]'))) {
                var formData = makeFormData();
                filePutAjax("/user/cr/cr01/updateEst", formData, function (data) {
                    if (data.resultCode == 0) {
                        alert("수주가 등록된 견적은 업데이트할 수 없습니다.");
                    } else if (data.resultCode == 200) {
                        modalStack.close();
                        gridView.setData(0);
                    } else {
                    	alert(data.resultMessage);
                    }
                });
            }
        }
    
        // 폼 데이터 생성 함수
        function makeFormData() {
            $('#coCd').prop('disabled', false);
            var elementsToReformat = $('.popup_area input[comma], #estAmt, #estNegoAmt, #exrate');
            // 금액 콤마 제거
            $.each($('.popup_area input[comma], #estAmt, #estNegoAmt,#exrate'), function (idx, elem) {
                deleteComma(elem);
            });
            
            // 날짜 하이픈 제거
            $.each($('.popup_area input[date]'), function (idx, elem) {
                deleteHyphen(elem);
            });
            
            // 폼데이터 생성
            var formData = new FormData($("#popForm")[0]);
            //---------------------------------------------------------------
            //-------itemarr  --첨부화일 처리를 위한 부분 시작
            //---------------------------------------------------------------
            // 유저아이디 추가
            formData.append("userId" , jwt.userId);
            formData.append("clntCd" , $('#estClntCd').val());            //첨부화일용
            //formData.append("prdtCd" , $('#prdtCd').val());            //첨부화일용
            //formData.append("itemCd" , $('#itemDiv').val());            //첨부화일용
            formData.append("prjctCd", $('#clntPjt').val());        //첨부화일용
            formData.append("comonCd", treeModule.getFileNodeId());    //첨부화일용
            
            var fileUploadArr = [];
            var tempArr = [];
            
            tempArr = treeModule.getFileArr();
            
            $.each(tempArr, function(idx, obj) {
                if (obj.fileKey == 0) {
                    formData.append("files", obj.file);
                    obj.file = '';
                    fileUploadArr.push(obj);
                }
            });
            
            formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
            formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
            //---------------------------------------------------------------
            //--첨부화일 처리를 위한 부분 끝\
            //---------------------------------------------------------------
    
            // 상세내역 추가
            var detailArr = [];
            $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
                var detailObj = {};
                $.each($(elem).find('[name]'), function (idx, elem) {
                    alert(elem);
                    formData.append(elem, JSON.elem.value);
                });
    
            });
    
            var rowList = grid.getList();
            if (rowList.length == 0) {
                alert("추가할 항목을 선택해주세요_");
                return;
            }
            var detailArr = [];

            $.each(rowList, function (idx, elem) {
                var detailObj = {};
                detailObj["estSeq"] = idx + 1;
                detailObj["estDtlDiv"] = elem.estDtlDiv;
                detailObj["estComm"] = elem.estComm;
                detailObj["estSpec"] = elem.estSpec;
                detailObj["estUnit"] = elem.estUnit;
                detailObj["estQty"] = elem.estQty;
                detailObj["estUpr"] = pasIntChk(elem.estUpr);
                var estRmk = elem.estRmk || "";
                detailObj["estRmk"] = estRmk;
    
                detailArr.push(detailObj);
    
            });
            
            formData.append("detailArr", JSON.stringify(detailArr));
            return formData;
        }
    
        function makeFormDataWithDeg() {
            $('#coCd').prop('disabled', false);
    
            // 금액 콤마 제거
            $.each($('.popup_area input[comma],#estAmt, #estNegoAmt,#exrate'), function (idx, elem) {
                deleteComma(elem);
            });
    
            // 날짜 하이픈 제거
            $.each($('.popup_area input[date]'), function (idx, elem) {
                deleteHyphen(elem);
            });
    
            // 폼데이터 생성
            var formData = new FormData($("#popForm")[0]);
    
            // 유저아이디 추가
            formData.append("userId", jwt.userId);
            formData.append("fileTrgtKey", paramObj.fileTrgtKey);
    
            // 상세내역 추가
            var detailArr = [];
            $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
                var detailObj = {};
                $.each($(elem).find('[name]'), function (idx, elem) {
                    alert(elem);
                    formData.append(elem, JSON.elem.value);
                });
    
            });
    
            var rowList = grid.getList();
            if (rowList.length == 0) {
                alert("추가할 항목을 선택해주세요_");
                return;
            }
            var detailArr = [];
    
            $.each(rowList, function (idx, elem) {
                var detailObj = {};
                detailObj["estSeq"] = idx + 1;
                detailObj["estDtlDiv"] = elem.estDtlDiv;
                detailObj["estComm"] = elem.estComm;
                detailObj["estSpec"] = elem.estSpec;
                detailObj["estUnit"] = elem.estUnit;
                detailObj["estQty"] = elem.estQty;
                detailObj["estUpr"] = elem.estUpr;
                detailObj["estRmk"] = elem.estRmk;
    
                detailArr.push(detailObj);
    
            });
            
            formData.append("detailArr", JSON.stringify(detailArr));
            
            return formData;
        }
    
    
        // 판매법인 설정 함수
        function setByCoCd(value) {
            // 판매법인 set
            $('#estCoprt').data("rprc", value);
            $('#estCoprt option:not([value=""])').remove()
            setCommonSelect($('#estCoprt'));
        }
    
    
        //견적서 출력 선택 팝업 설정 함수
        function setReportPopup() {
            var paramObj = modalStack.last().paramObj;
            var iChk;
            var rptName;
    
            openSecondModal("/static/html/user/cr/cr01/SD0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
                var arg = "i_est_no#" + paramObj.estNo + "#"
                    + "iChk#" + iChk + "#"
                    + "imgPrt#" + imgPrt + "#";
                callReport(rptName, arg, 750, 900);
            });
    
    
        }
    
        //Select 선택 코드값 체크하여 명을 출력
        function baseOptionChk(key, option) {
            rtnNm = "";
            for (var element of option) {
                if (key.value == element.CD) {
                    rtnNm = element.NM;
                    break;
                }
            }
            return rtnNm;
        }
    
        function fetchCurrencyData() {
            var paramObj = {"codeKind": "ESTDIV", "useYn": "Y"};
            var paramObj2 = {"codeKind": "UNITDIV", "useYn": "Y"};
    
            var promise1 = new Promise(function (resolve, reject) {
                postAjax("/admin/cm/cm05/selectCodeList", paramObj, null, function (data) {
                    if (data && data.codeList) {
                        var codeList = data.codeList;
                        var options = codeList.map(function (code) {
                            return {
                                CD: code.codeId,
                                NM: code.codeNm
                            };
                        });
                        resolve(options);
                    } else {
                        console.error("codeList is undefined. Check the AJAX response:", data);
                        reject(data);
                    }
                });
            });
    
            var promise2 = new Promise(function (resolve, reject) {
                postAjax("/admin/cm/cm05/selectCodeList", paramObj2, null, function (data) {
                    if (data && data.codeList) {
                        var codeList = data.codeList;
                        var options2 = codeList.map(function (code) {
                            return {
                                CD: code.codeId,
                                NM: code.codeNm
                            };
                        });
                        resolve(options2);
                    } else {
                        console.error("codeList is undefined. Check the AJAX response:", data);
                        reject(data);
                    }
                });
            });
    
            return Promise.all([promise1, promise2]);
        }
    
        let selectedRowKey;
        const grid = new ax5.ui.grid();
        fetchCurrencyData().then(function ([options, options2]) {
            grid.setConfig({
                multipleSelect: false,
                target: $('[data-ax5grid="est-grid-modal"]'),
                header: {
                    align: "center",
                    selector: false
                },
                columns: [
                    {key: "estSeq", 	label: "번호", width: 40, align: "center", formatter: function () {return this.item.__index + 1;},},
                    {key: "estDtlDiv", 	label: "구분", width: 200, align: "center", editor: {type: "select", disabled: function () {return $("#ordrsYn").val() == "Y";},
                    	config: { columnKeys: { optionValue: 'CD', optionText: 'NM'}, options: options, },
                        }, formatter: function () { return baseOptionChk(this, options); }},
                    {key: "estComm", 	label: "품명", align: "left", width: 360, editor: {type: "text", disabled: function () {return $("#ordrsYn").val() == "Y";}}},
                    {key: "estSpec", 	label: "사양", align: "left", width: 360, editor: {type: "text",  disabled: function () { return $("#ordrsYn").val() == "Y"; }}},
                    {key: "estUnit", 	label: "단위", align: "center", width: 50, editor: {type: "select", disabled: function () { return $("#ordrsYn").val() == "Y"; },
                            config: { columnKeys: { optionValue: 'CD', optionText: 'NM'}, options: options2, },
                            event: { 'blur': function () { }, 'keydown': function (e) { if (e.keyCode == 9) { } } }
                        }, formatter: function () { return baseOptionChk(this, options2); },
                    },
                    {key: "estQty", 	label: "수량", align: "right", width: 100, editor: {type: "number", disabled: function () { return $("#ordrsYn").val() == "Y"; }}, formatter: "money"},
                    {key: "estUpr", 	label: "단가", align: "right", width: 100, editor: {type: "number",disabled: function () { return $("#ordrsYn").val() == "Y"; }}, formatter: "money"},
                    {key: "estAmt", 	label: "합계", width: 100, align: "right", formatter: function () { color = '#0000FF';
                            const sum = pasIntChk(this.item.estQty) * pasIntChk(this.item.estUpr); return '<div style="color: ' + color + '">' + sum.toLocaleString('en-US') + '</div>'; }},
                    {key: "estRmk", 	label: "비고", align: "center", width: 50, editor: {type: "text",  disabled: function () { return $("#ordrsYn").val() == "Y";}}},
                ],
    
                footSum: [
                    [
                        {label: "총합계", align: "center", colspan: 7},
                        {key: "estAmtAll", collector: "sum", formatter: "money", align: "right"},
                    ]
                ],
                body: {
                    grouping: {
                        by: ["estDtlDiv"],
                        columns: [
                            {label: "소계", colspan: 7, align: "center"},
                            {key: "estAmtMid", collector: function () { let sum = 0; this.list.forEach(function (n) { if (!n.__grouping) sum += pasIntChk(n.estQty) * pasIntChk(n.estUpr); });  return sum; },
                                formatter: "money", align: "right",},
                        ],
                    },
                    onClick: function (item, param) {
//                         console.log("body onClick");
                        thisGridRow = param.dindex;
                        thisGridCol = param.colIndex;
                        
                        this.self.clearSelect();
                        this.self.select(this.dindex);
                        const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(this, this.dindex);
                        const realIndex = this.dindex - subtotalRowsBeforeIndex;
                        selectedRowKey = realIndex;
                        if (this.column.key == 'estComm') {
                            var _this = this;
                            // 선택된 행의 "estDtlDiv"값을 가져옵니다.
                            let estDtlDivValue = grid.list[selectedRowKey].estDtlDiv;
                            // 만약 "estDtlDiv"값이 "제작품"이라면 openPrdtSearch 함수를 호출합니다.
                        }
                    }
                },
                contextMenu: {
                    iconWidth: 20,
                    acceleratorWidth: 100,
                    itemClickAndClose: false,
                    icons: {
                        'arrow': '<i class="fa fa-caret-right"></i>'
                    },
                    items: [
                        {type: 1, label: "붙여넣기"},
                        {divide: true},
                        {
                            label: "작업선택",
                            items: [
                                {type: 1, label: "줄추가"},
                                {type: 1, label: "내용 삭제"},
                                {type: 2, label: "줄삭제"},
                            ]
                        },
                    ],
                    popupFilter: function (item, param) {
                        //console.log(item, param);
                        if (param.element) {
                            return true;
                        } else {
                            return item.type == 1;
                        }
                    },
    
                    onClick: function (item, param) {
                        thisGridRow = param.dindex;
                        thisGridCol = param.colIndex;
    
                        if (item.label == "붙여넣기") {
                            gridPaste(thisGridRow, thisGridCol);
                        } else if (item.label == "줄추가") {
                            //console.log('추가 인덱스 :', param.dindex);
                            //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                            grid.addRow($.extend({}, grid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                            grid.setValue(param.dindex, 'updcheck', 1);
    
                        } else if (item.label == "내용 삭제") {
                            //console.log('내용삭제 인덱스 :', param.dindex);
    
                            grid.config.columns.forEach((column) => {
                                grid.setValue(param.dindex, column.key, '');
                                grid.setValue(param.dindex, 'updcheck', 1);
//                                 console.log('내용삭제 :', param.dindex, column.key);
                            });
    
                        } else if (item.label == "줄삭제") {
                            //console.log('삭제 인덱스 :', param.dindex);
                            const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(grid, param.dindex);
                            const realIndex = param.dindex - subtotalRowsBeforeIndex;
                            grid.removeRow(realIndex);
                        }
                        grid.contextMenu.close();
                    }
                }
            });
            
            let isUpdating = false;  // isUpdating 플래그 선언
            grid.onDataChanged = function () {
                if (this.item.estDtlDiv == undefined || isUpdating) {
    
                } else {
    
                    isUpdating = true;  // mark the beginning of an update
                    const data = grid.getList();
    
                    data.forEach((item, index) => {
                        item.estAmtAll = pasIntChk(item.estQty) * pasIntChk(item.estUpr);  // calculate and set the total
                    });
//                     grid.repaint()
                    var estAmtAllArray = data.map(item => item.estAmtAll);
                    var sum = estAmtAllArray.reduce((a, b) => a + b, 0);
                    
                    // 견적금액을 총합계로 세팅
                    $("#estAmt").val(addCommaStr(sum));
                    
                    this.item.estAmtAll = sum; // Assign the sum to estAmtAll
                    isUpdating = false;  // mark the end of an update
                    grid.setData({
                        list: data,
                        page: {
                            totalElements: data.length
                        }
                    });
                    grid.repaint()
    
                }
            };
    
            let checkDataInterval = null;
    
            grid.onLoad = function () {
                if(actionType == "C") {
                    addEstDtlDivWithPreset();
                }
                checkDataInterval = setInterval(() => {
                    const data = grid.getList();
    
                    // 데이터가 로드되었는지 확인합니다.
                    if (data.length > 0) {
                        clearInterval(checkDataInterval);  // 데이터가 로드되었다면 체크를 중단합니다.
    
                        data.forEach((item, index) => {
                            item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                        });
    
                        grid.setData({
                            list: data,
                            page: {
                                totalElements: data.length
                            }
                        });
                    }
                }, 100);
            };
    
        })
    
        function countSubtotalRowsBeforeIndex(grid, index) {
            let count = 0;
            for (let i = 0; i < index; i++) {
                if (grid.list[i].__isGrouping) {
                    count++;
                }
            }
            return count;
        }
        
        $("#addProductButton").on("click", function () {
            var newRowData = {
                estDtlDiv: "",
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            };
    
            // 첫 번째 경우: 선택된 행이 있는 경우
            if (selectedRowKey !== undefined) {
                let row = grid.getList("selected")[0];
                let newRowData = $.extend({}, row, {__index: undefined});
                grid.addRow(newRowData, row.__index + 1);
            }
            // 두 번째 경우: 그리드가 비어 있는 경우
            else if (grid.getList().length === 0) {
                grid.addRow(newRowData, 0);
            }
            // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
            else {
                grid.addRow(newRowData, grid.length);
                return;
            }
    
            const data = grid.getList();
            grid.setData({
                list: list,
                page: {
                    totalElements: list.length
                }
            });
    
        });
        
        $("#deleteProductButton").on("click", function () {
            if (selectedRowKey !== undefined) {
                grid.removeRow(selectedRowKey);
                const data = grid.getList();
                grid.setData({
                    list: data,
                    page: {
                        totalElements: data.length
                    }
                });
    
                // 선택된 행을 업데이트합니다.
                if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                    if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                        grid.select(selectedRowKey);
                    } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                        selectedRowKey = selectedRowKey - 1;
                        grid.select(selectedRowKey);
                    }
                } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                    selectedRowKey = undefined;
                    // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                    // 예: $("#deleteProductButton").prop("disabled", true);
                }
            } else {
                alert("삭제를 위해 선택된 행이 없습니다.");
            }
        });
    
        function addEstDtlDivWithPreset() {
            const estDtlDivData = [
                {
                    estDtlDiv: "ESTDIV1",
                    estComm: "",
                    estSpec: "",
                    estUnit: "",
                    estQty: "",
                    estUpr: "",
                },
                {
                    estDtlDiv: "ESTDIV2",
                    estComm: "",
                    estSpec: "",
                    estUnit: "",
                    estQty: "",
                    estUpr: "",
                },
            ];

            grid.setData({
                list: estDtlDivData,
                page: {
                    totalElements: estDtlDivData.length
                }
            });
            
        }
        
        //초기 화면 로드 이후 등록 수정작업에 따른 작업 구분 
        function firstJobRetrive() {
	        var degUpBtn = document.getElementById("degUpBtn");
	        if (actionType == "C") {
	            degUpBtn.style.display = "none";
                $('#overlay,#overlay2').css('display', 'none');
                $("#exrate").val(1);
                $('#estDeg').val(1);
                $('#estAmt').val(0);
                $('#ordrsYn').val('N');
                $('#estNegoAmt').val(0);
	                
	            
	            $('#actionBtn').on("click", function () {
	                insertEst();
	            });
	
				$('#coCd').trigger('change'); //파일트리 새로 그리기
	        } else if (actionType == "U") {
	            degUpBtn.style.display = "inline-block";
	            
	            $('#popForm .coCd, .estDt, .pblsDt').removeClass('hit');
	            $("#coCd").prop("disabled", true);
	            
	            //발행일자 비활성화
	            $('#pblsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

	            //타이틀명 변경
	            $('.tit').text('견적 수정')
	            //버튼명 변경
	            $('#actionBtn').text("수정");
	              
	            postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
	                var parsedData = data;
	                    // Object.keys를 통해 parsedData.estInfo의 모든 키에 대해 반복
	                Object.keys(parsedData.estInfo).forEach(function (key) {
	    
	                    // 현재 키와 일치하는 id를 가진 요소를 찾음
	                    var inputField = document.getElementById(key);
	    
	                    // 요소가 존재하지 않으면 다음 반복으로 이동
	                    if (!inputField) return;
	    
	                    // 현재 키에 대응하는 값을 얻음
	                    var value = parsedData.estInfo[key];
	    
	                    // 키의 값에 따라 다른 작업을 수행
	                    switch (key) {
	                        case 'estAmt':
	                        case 'estNegoAmt':
	                        case 'exrate':
	                            // 키가 'estAmt', 'estNegoAmt', 또는 'exrate'일 때
	                            // 값이 존재하면 세 자리수 마다 쉼표를 추가함
	                            inputField.value = (value != null && value != '') ? value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '';
	                            break;
	                        default:
	                            // 그 외의 키일 때
	                            inputField.value = value || '';
	                            break;
	                    }
	                });;
	                var degUpBtn = document.getElementById("degUpBtn");
	                // var ordrsBtn = document.getElementById("ordrsBtn");
	    
	                if (document.getElementById('ordrsYn').value == 'Y') {
	                    degUpBtn.style.backgroundColor = "gray"; // 차수증가버튼 색상을 회색으로 변경
	                    degUpBtn.disabled = true; // 차수증가버튼을 비활성화
	                    
	                    $('#actionBtn').hide();
	                    
	                       //$('#overlay,#overlay2').css('display', 'block');
	                    $("#deleteProductButton").off('click');
	                    $("#addProductButton").off('click');
	                    
	                    
	                    
	                    //견적제출자
	                    $('#popForm .mngIdVisible').removeClass('hit');
	                    $("#popForm .mngIdVisible").removeClass('search_form');
	                    //고객사
	                    $('#popForm .estClntNm').removeClass('hit');
	                    $("#popForm .estClntNm").removeClass('search_form');
	                    //환율
	                    $('#popForm .exrate').removeClass('hit');
	                      //공사명
	                    $('#popForm .estNm').removeClass('hit');
	                    //통화단위
	                    $('#popForm .currCd').removeClass('hit');
	                    //견적금액
	                    $('#popForm .estAmt').removeClass('hit');
	                    
	                    //통화단위 select list는 아래 태그들에서 못찾아서
	                    $('#currCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	                    // 모든 input 태그를 선택합니다.
	                    let inputs = document.querySelectorAll('input:not(.search input)');
	
	                    // 선택된 모든 input 태그에 대해 순환하며 속성과 스타일을 적용합니다.
	                    for (let i = 0; i < inputs.length; i++) {
	                        inputs[i].style.backgroundColor = '#e6e6e6';
	                        inputs[i].setAttribute('readonly', 'readonly');
	                        
	                    }
	    
	                    // 모든 textarea 태그를 선택합니다.
	                    let textareas = document.querySelectorAll('textarea:not(.search textarea)');
	                    // 선택된 모든 textarea 태그에 대해 순환하며 속성과 스타일을 적용합니다.
	                    for (let i = 0; i < textareas.length; i++) {
	                        textareas[i].setAttribute('readonly', 'readonly');
	                    }
	    
	                } else {
	                    degUpBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
	                    degUpBtn.disabled = false; // 버튼을 활성화
	                    
	                    $('#actionBtn').show();
	                    
	                    // ordrsBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
	                    // ordrsBtn.disabled = false; // 버튼을 활성화
	                }
	                
	                var list = data.estInfo.list;
	                grid.setData({
	                    list: list.map(item => ({...item, estDtlDiv: item.estDtlDiv})),
	                    // estDtlDiv 값을 CD 값으로 설정
	                    page: {
	                        totalElements: list.length
	                    }
	                });
	
	
					$('#coCd').trigger('change'); //파일트리 새로 그리기
	            });
	            
	            $('#actionBtn').on("click", function () {
	                //debugger;
	                updateEst();
	            });
	
	            document.getElementById("degUpBtn").addEventListener("click", function () {
	                event.preventDefault();
	                var estDegInput = document.getElementById("estDeg");
	                var currentValue = parseInt(estDegInput.value, 10) || 0;
	                var tempEstDtValue = $("#estDt").val();
	                var tempIssueDateValue = $("#pblsDt").val();
	                insertEstNew().then((response) => {
	                    if (response && response.hasOwnProperty('estDeg') && !isNaN(parseInt(response.estDeg))) {
	                        alert("차수가 업데이트 되었습니다.");
	//                         treeModule.initFileArrays();
	                        estDegInput.value = response.estDeg;
	                        $("#estDt").val(tempEstDtValue);
	                        $("#pblsDt").val(tempIssueDateValue);
	                        loadEstDegrees();
	                        gridView.setData(0);    
	    
	                    } else {
	                        alert("차수가 업데이트 되지않았습니다.");    
	                    }
	                });
	                // 차수 증가 버튼이 클릭되었음을 표시합니다.
	    
	                var keys = ['estAmt', 'estNegoAmt', 'exrate'];
	                $.each(keys, function (index, key) {
	                    var value = $('#' + key).val();
	                    if (value != null && value != '') {
	                        value = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	                    }
	                    $('#' + key).val(value || '');
	                });
	            });
	            
	        }
        }
        
        function insertEstNew() {
            return new Promise((resolve, reject) => {
                if (validateRequiredFields() && inputValidation($('.popup_area [required]'))) {
                    var formData = makeFormDataWithDeg();
    
                    filePostAjax("/user/cr/cr01/insertEstDeg", formData, function (data) {
                        if (data.resultCode == 200) {
    
                            resolve({estDeg: data.param.newEst}); //
    
                        } else {
                            // 실패한 경우 에러 메시지를 반환합니다.
                            reject("차수가 업데이트 되지 않았습니다."); // Prom
    
                        }
                    });
    
                }
            });
        }
    
        // function insertOrdrsModal() {
        //     var paramObj = {
        //         "actionType": "DC",
        //         "coCd": $("#coCd").val(),
        //         "estNo": $("#estNo").val(),
        //         "ordrsClntCd": $("#estClntCd").val(),
        //         "ordrsClntNm": $("#estClntNm").val(),
        //         "clntPjt": $("#estClntNm").val(),
        //         "mngId": $("#cstmMngNm").val(),
        //         "exrate": $("#cstmMngHp").val(),
        //         "clntPjt": $("#clntPjt").val()
    
        //     };
        //     mask = new ax5.ui.mask();
        //     modal = new ax5.ui.modal();
        //     modalStack = new ModalStack();
    
        //     openModal("/static/html/user/cr/cr02/CR0202P01.html", 1400, 736, "", paramObj);    
        // }
    
        // document.getElementById("ordrsBtn").addEventListener("click", function () {
        //     event.preventDefault();
        //     modalStack.close();
        //     insertOrdrsModal();
        // });
        
        function validateRequiredFields() {    
            const gridIn = grid.getList();    
            for (let i = 0; i < gridIn.length; i++) {
                const row = gridIn[i];
                // 필수 입력 필드 검사
                if (!row.estComm || !row.estQty || !row.estUpr) {
                    alert(`견적 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
                    return false;
                }    
            }
            return true;
        }
        
        function focusOnGrid() {
            grid.focus(0, 'estSeq');
            // 'yourFirstColumnKey'를 그리드의 첫 번째 column key로 변경
        }

        function gridPaste(thisGridRow,thisGridCol ) {
            
            var pasteData = "";
            
            navigator.clipboard.readText().then(pasteData => {
//                console.log('클립보드에 저장된 값:', pasteData);
                  if (pasteData==undefined ||pasteData=="" || thisGridRow===undefined) {
                  	  return;
                  }
        
                  // 붙여넣기할 데이터를 배열로 변환한다.
                  pasteData = (pasteData.charAt(pasteData.length - 1) === "\n") ? pasteData : pasteData + "\n";
                  var pasteRows = pasteData.split("\n").map(function(row) {
                        return row.split("\t");
                  });
                
                  // 붙여넣기를 시작할 셀의 인덱스를 구한다.
                  var startRowIndex = thisGridRow;
                  var startColIndex = thisGridCol;
                  
                  // 구분 별로 동작해야하니 구분별 길이를 구한다.
                  // 선택 된 구분
                  var estDtlDiv = grid.list[startRowIndex].estDtlDiv;
                  if (estDtlDiv==undefined ||estDtlDiv=="") {
//                       console.log("구분 값 없음");
                      return;
                  }
                  // 현재 데이터 가져오기
                  var dataList = grid.getList();
                  
                  // 데이터 필터링 (estDtlDiv 값이 estDtlDiv인 것만 추려냄)
                  var filteredData = dataList.filter(item => item.estDtlDiv === estDtlDiv);
                  
                  // 붙여넣을 데이터의 행과 열 개수를 구한다.
                  var numRows = pasteRows.length;
                  var numCols = pasteRows[0].length;
                
                  // 기존 그리드 정보
                  var gridLength = filteredData.length;
//                   console.log("filteredData.length : " + filteredData.length);
                  var gridColumns = grid.config.columns;
                  
                  // 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
                  for (var i = 0; i < numRows-1; i++) {
                    
                    if (i >= gridLength) {
//                         grid.addRow($.extend({}, grid.list[thisGridRow], {__index: undefined}+i));
                        grid.addRow($.extend({}, grid.list[thisGridRow], {__index: undefined}), thisGridRow + 1,);
                        dataList = grid.getList();
                        filteredData = dataList.filter(item => item.estDtlDiv === estDtlDiv);
                        gridLength = filteredData.length;
                    }
    
                  }
                  for (var i = 0; i < numRows-1; i++) {
                    for (var j = 0; j < numCols; j++) {
                      var calRow = startRowIndex + i;
                        var calCol = startColIndex + j;
                        //carriage return 문자 삭제
                        var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
//                        console.log(" calRow : " + calRow + " i : " + i + " j : " + j + " cellData : " + cellData);
                        if (calCol >= gridColumns.length) {
                            grid.addColumn();
                        }
                    	//단위 기본
                    	if(gridColumns[calCol].key == "estUnit"){
                    		//구분값이 제작품이면 대 아니면 식
                    		if(estDtlDiv == "ESTDIV1"){
                    			cellData = "UNITDIV003";
                    		}else{
                    			cellData = "UNITDIV004";
                    		}
                    	}
                        grid.setValue(calRow, gridColumns[calCol].key, cellData);
                    }
                  }
                  grid.repaint();
        
            });      
        };
        // Ctrl + V 단축키 이벤트 처리
//         grid.$target.on("paste", function (e, a) {
//             gridPaste(thisGridRow, thisGridCol);
//         });
        
    	function pasIntChk (value) {
    		const cvtValue = parseInt(deleteCommaStr(value));
    		return isNaN(cvtValue) ? 0 : cvtValue;
    	}
    
        // 거래처 검색 함수
        function openSecondClntSearch(searchValue) {
            if (event && event.keyCode === 13) {
                event.preventDefault();  // prevent form from submitting
            }
    		var paramObj = {
    	            "searchValue" : searchValue,
    	            "clntDivCd"   : "CLNTDIV12"
    	        };
            openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
                var row = grid.target.getList("selected")[0];
                $('#estClntCd').val(row.clntCd);
                $('#estClntNm').val(row.clntNm);
    
                var paramObj = {
                    "coCd": $('#coCd').val(),
                    "clntCd": row.clntCd
                }
                setMngInfo(paramObj);
                $("#estClntNm").focus();
                $("#estClntNm").trigger("click");
            });
        }
    
        // 담당자 정보 설정 함수
        function setMngInfo(paramObj) {
            postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
                if (data.mngInfo) {
                    $('#salesEmpId').val(data.mngInfo.salesEmpId);
                    $('#salesEmpNm').val(data.mngInfo.salesEmpNm);
                } else {
                    $('#salesEmpId').val("");
                    $('#salesEmpNm').val("");
                }
            });
        }
    
        // 사용자 검색 함수
        function openSecondUserSearch(searchValue) {
            if (event && event.keyCode === 13) {
                event.preventDefault();  // prevent form from submitting
            }
            var paramObj = {
                "coCd": $('#coCd').val(),
                "userId": $('#salesEmpId').val(),
                "userNm": $('#mngIdVisible').val(),
                "useYn": "Y",
                "searchValue": searchValue
            };
    
            openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree) {
                var checkedId = tree.get_checked()[0];
                var checkedNode = tree.get_node(checkedId);
                $("#mngId").val(checkedNode.id);
                $("#mngIdVisible").val(checkedNode.text);
                // $("#salesEmpNm").val(checkedNode.text);
                $("#mngId").focus();
                $("#mngId").trigger("click");
            });
        }
    
    
    </script>
    </html>
    