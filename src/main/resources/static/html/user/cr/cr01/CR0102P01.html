<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">견적 등록</h4>
    </div>
    <div class="popup_table">
        <div style="float:right;margin-bottom:10px;">
            <button style="display:none" id="degUpBtn" authchk="">차수 증가</button>
            <button style="display:none" id="ordrsBtn" authchk="">수주 등록</button>
        </div>
        <form id="popForm">
            <input type="hidden" id="pgmId" name="pgmId" value="CR0101M01">
            <table>
                <tr>
                    <th class="hit">회사</th>
                    <td>
                        <select id="coCd" name="coCd" data-kind="CO" onchange="setByCoCd(this.value)" required></select>
                    </td>
                    <th class="hit">견적번호</th>
                    <td>
                        <input style="background-color:#ddd!important" type="text" id="estNo" name="estNo" readonly
                        >
                    </td>
                    <th class="hit">견적차수</th>
                    <td>
                        <input style="background-color:#ddd!important" type="text" id="estDeg" name="estDeg" readonly
                               required>
                    </td>
                </tr>
                <tr>

                    <th class="hit">작성일자</th>
                    <td>
                        <input type="text" class="input_calendar" autocomplete="off" id="estDt" name="estDt" date
                               required readonly>
                    </td>

                    <th class="hit">발행일자</th>
                    <td>
                        <input type="text" class="input_calendar" autocomplete="off" id="issueDate" name="issueDate" value="2022-05-04"
                               date required>
                    </td>
                    <th class="hit">고객사</th>
                    <td>
                        <input type="hidden" id="estClntCd" name="estClntCd">
                        <div class="search_form">
                            <input onclick="openSecondClntSearch();" type="text" id="estClntNm" name="estClntNm"
                                   readonly required>
                            <a onclick="openSecondClntSearch();">
                                <i class="i_search_w"></i>
                            </a>
                        </div>
                    </td>
                    <th class="hit">고객사PLJ</th>
                    <td>
                        <input type="hidden" id="_" name="_">
                        <div class="search_form">
                            <input onclick="" type="text" id="_" name="_"
                                     value="DB 칼럼 존재하지 않음">

                        </div>
                    </td>

                </tr>
                <tr>
                    <th class="">고객담당자</th>
                    <td>
                        <input type="text" id="cstmMngNm" name="cstmMngNm" >
                    </td>
                    <th class="">담당자 연락처</th>
                    <td>
                        <input type="text" id="cstmMngHp" name="cstmMngHp" >
                    </td>
                    <th class="">견적제출자</th>
                    <td>
                        <input type="text" id="mngId" name="mngId" readonly>
                    </td>
                    <th class="">환율</th>
                    <td>
                        <input type="text" id="exrate" name="exrate" >
                    </td>

<!--                    <th class="hit">견적기준일자</th>-->
<!--                    <td>-->
<!--                        <input type="text" class="input_calendar" autocomplete="off" id="estStdDt" name="estStdDt" date-->
<!--                               required>-->
<!--                    </td>-->
                </tr>
                <tr>
                    <th  class="hit">공사명</th>
                    <td colspan="3">
                        <input type="text" id="estNm" name="estNm" required>
                    </td>
                    <th class="hit">통화단위</th>
                    <td>
                        <select id="currCd" name="currCd" data-kind="CURR" onchange="setByCoCd(this.value)" required></select>
                    </td>
                    <th class="hit">견적금액</th>
                    <td>
                        <input type="text" id="estAmt" name="estAmt" required>
                    </td>


                </tr>
                <tr>
                    <th class="">견적제외사항</th>
                    <td colspan="3">
                        <textarea id="estExcept" name="estExcept" style="width:100%;height:100%;"></textarea>
                    </td>
                    <th class="">견적기준</th>
                    <td colspan="3">

                        <textarea id="estStd" name="estStd" style="width:100%;height:100%;"></textarea>
                    </td>

                </tr>
                <tr>
                    <th class="">납품조건</th>
                    <td>
                        <input type="text" id="estDlvrCndt" name="estDlvrCndt" >
                    </td>

                    <th class="">결재조건</th>
                    <td>
                        <input type="text" id="estPmntCndt" name="estPmntCndt" >
                    </td>
                    <th class="">납기</th>
                    <td>
                        <input type="text" class="" id="estDudt" name="estDudt" >
                    </td>
                </tr>
                <tr>
                    <th class="">수주확정여부</th>
                    <td>
                        <input type="text" id="ordrsYn" name="ordrsYn" readonly>
                    </td>

                    <th class="">수주확정일자</th>
                    <td>
                        <input type="text" id="ordrsDt" name="ordrsDt" readonly>
                    </td>
                    <th class="">견적NEGO금액</th>
                    <td>
                        <input type="text" class="" id="estNegoAmt" name="estNegoAmt" >
                    </td>
                </tr>
            </table>


        </form>
    </div>
    <br>
    <div class="popup_table" style="margin-top: 15px;">

        <div class="" style="padding-left: 0;">
            <div class="contents" style="margin:0px; padding:0px; height: 480px; width: 100%; min-width: 200px">
                <div style="float:right" style="" class="add_btn_small pdl10">
                    <a id="addProductButton" style="margin-top:8px;">+</a>
                    <a id="deleteProductButton" style="margin-top:8px;margin-right:8px">-</a>
                </div>
                <h3 class="location">
                    <a class="file_tag" id="file_tag"
                       style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                    <span class="page_tit" style="text-align: right;"></span>
                </h3>
                <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                    <div data-ax5grid="est-grid" data-ax5grid-config="{}" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" style="margin-top: 15px;margin-bottom:40px;">
        <div class="col-xs-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 400px;padding: 5px">
                    <div id="deptTree"></div>
                </div>
            </div>
        </div>
        <div class="col-xs-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag"
                       style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file" class=""
                        style="  background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();"
                        authchk>
                    첨부파일
                </button>
                <!--           <button  type="button" id="zip_down" class=""
                                   style="display:none;height: 25px; line-height: 15px;"
                                   authchk>
                               파일 전체 다운로드
                           </button>-->
                <div class="ax5_grid" data-ax5grid="file-grid-popup" data-ax5grid-config="{}"
                     style="height: 400px; width: 100%"></div>
            </div>
        </div>
    </div>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
        <button id="actionBtn" authchk>등록</button>
        <button class="close_btn" onclick="  modalStack.close();">닫기</button>
    </div>
</div>

<script type="text/javascript">

    /* 견적서함수 */
    //견적 번호 조회 함수
    function getMaxEstNumber() {
        let paramObj = {}; // Add any parameters needed for the request
        // postAjax("/user/cr/cr01/maxEst", paramObj, null, function (data) {
        // 	// Set the received maximum estimation number to the input field
        // 	$("#estNo").val(data.maxEstNo);
        // });
    }

    // 견적 정보 조회 함수
    function selectEstInfo() {
        var paramObj = modalStack.last().paramObj;
        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            setEstInfo(data.estInfo);
        });
    }

    // 견적 정보 설정 함수
    function setEstInfo(estInfo) {
        //메인정보 세팅
        $.each(estInfo, function (key, value) {
            if ($('#' + key)[0]) {
                if ($('#' + key).is('[date]')) {
                    $('#' + key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
                } else {
                    if ($('#' + key).is('[comma]')) {
                        value = addCommaStr(value);
                    }
                    if (key == "coCd") {
                        setByCoCd(value)
                    }
                    $('#' + key).val(value);
                }
            }
        });


        $.each(estInfo.estDetailList, function (idx, obj) {
            if (idx != 0) addRow();
            $addedRow = $("tr[name='detailRow']:last");

            $.each($addedRow.find('[name]'), function (idx, elem) {
                var itemValue = obj[elem.name];
                if (itemValue) {
                    if ($(elem).is("[comma]")) {
                        itemValue = addCommaStr(itemValue);
                    }
                    $(elem).val(itemValue);
                }
            });
        });
        countTot();


        $.each(estInfo.estFileList, function (idx, obj) {
            fileArr.push({
                'fileKey': obj.fileKey,
                'fileName': obj.fileName,
                'fileType': obj.fileType,
                'fileSize': obj.fileSize,
                'file': obj
            });
        });


    }

    // 거래처 검색 함수
    function openSecondClntSearch() {
        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#estClntCd').val(row.clntCd);
            $('#estClntNm').val(row.clntNm);

            var paramObj = {
                "coCd": $('#coCd').val(),
                "clntCd": row.clntCd
            }
            setMngInfo(paramObj);
        });
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {
                $('#salesEmpId').val(data.mngInfo.salesEmpId);
                $('#salesEmpNm').val(data.mngInfo.salesEmpNm);
            } else {
                $('#salesEmpId').val("");
                $('#salesEmpNm').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch() {
        var paramObj = {
            "coCd": "GUN", //$('#coCd').val(),
            "userId": $('#salesEmpId').val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#salesEmpId").val(checkedNode.id);
            $("#salesEmpNm").val(checkedNode.text);
        });
    }


    // 제품 검색 함수
    function openSecondPrdtSearch(elem) {
        $targetRow = $(elem).closest('tr[name="detailRow"]');
        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#estClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            // 값 초기화
            $targetRow.find('input[name]').val("");
            // input 제어
            if (row.prdtStockCd == "Y") {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", false);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", false);
                $targetRow.find('input[name="estQty"]').attr("readonly", false);
                $targetRow.find('input[name="estWt"]').attr("readonly", false);
            } else {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", true);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", true);
            }
            $.each(row, function (key, value) {
                if ($targetRow.find('[name="' + key + '"]')[0]) {
                    $targetRow.find('[name="' + key + '"]').val(value);
                }
            });
            $targetRow.find('input[name="estUpr"]').val(row.ordrgUpr);

            countTot();
        });
    }

    // 현장 검색 함수
    function openSecondSiteSearch() {
        var paramObj = {
            "coCd": $('#popForm #coCd').val(),
            "clntCd": $('#popForm #estClntCd').val(),
            "clntNm": $('#popForm #estClntNm').val(),
            "insertYn": "Y",
            "isClntReq": "Y"
        }

        openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#prjctCd').val(row.siteCd);
            $('#prjctNm').val(row.siteNm);
        });
    }


    /* 기타함수 */

    // 문자열을 주어진 바이트 길이로 자르는 함수
    function cutStr(str, maxByte) {

        for (b = i = 0; c = str.charCodeAt(i);) {
            b += c >> 7 ? 2 : 1;
            if (b > maxByte)
                break;
            i++;
        }
        return str.substring(0, i);
    }

    // 견적 정보 삽입 함수
    function insertEst() {
        if (inputValidation($('.popup_area [required]'))) {
            var formData = makeFormData();

            filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
                modalStack.close();
                gridView.setData(0);
                alert(data.resultMessage);
                if (data.resultCode == 200) {

                    //location.href="/static/html/user/cr/cr01/CR0102P01.html";
                }
            });
        }
    }

    // 견적 정보 업데이트 함수
    function updateEst() {
        //비고 문자열 길이 필드길이로 byte 자르기
        if (validateRequiredFields() &&inputValidation($('.popup_area input[required]'))) {
            var formData = makeFormData();
            filePutAjax("/user/cr/cr01/updateEst", formData, function (data) {
                if (data.resultCode == 0) {
                    alert("수주가 등록된 견적은 업데이트할 수 없습니다.");
                } else if(data.resultCode) {
                    alert(data.resultMessage);
                    gridView.setData(0);
                    modalStack.close();
                }

            });
        }
    }

    // 폼 데이터 생성 함수
    function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma], #estAmt, #estNegoAmt,#exrate'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });

        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);
        formData.append("fileTrgtKey", paramObj.fileTrgtKey);
        // 첨부파일 추가

        var newFiles = treeModule.getFileArr().filter(function (obj) {
            return obj.fileKey == 0;
        });

        $.each(newFiles, function (idx, obj) {
            formData.append("comonCd_" + idx, obj.nodeId);
            formData.append("files", obj.file);
        });

        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));


        treeModule.initFileArrays();

        // 상세내역 추가
        var detailArr = [];
        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                alert(elem);
                formData.append(elem, JSON.elem.value);
            });

        });

        var rowList = grid.getList();
        if (rowList.length == 0) {
            alert("추가할 항목을 선택해주세요_");
            return;
        }
        var detailArr = [];

        $.each(rowList, function (idx, elem) {
            var detailObj = {};
            detailObj["estSeq"] = idx + 1;
            detailObj["estDtlDiv"] = elem.estDtlDiv;
            detailObj["estComm"] = elem.estComm;
            detailObj["estSpec"] = elem.estSpec;
            detailObj["estUnit"] = elem.estUnit;
            detailObj["estQty"] = elem.estQty;
            detailObj["estUpr"] = elem.estUpr;
            detailObj["estRmk"] = elem.estRmk;

            detailArr.push(detailObj);

        });


        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    function makeFormDataWithDeg() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#estAmt, #estNegoAmt,#exrate'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });

        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);
        formData.append("fileTrgtKey", paramObj.fileTrgtKey);
        // 첨부파일 추가
        console.log("현재위치"+JSON.stringify(treeModule.getFileArr()));


        var newFiles = treeModule.getFileArr().filter(function (obj) {
            return obj.fileKey == 0;
        });


        $.each(newFiles, function (idx, obj) {
            // 신규파일만 추가
            formData.append("comonCd_" + idx, obj.comonCd);
            formData.append("filePath_" + idx, obj.filePath);
            formData.append("fileName_" + idx, obj.fileName);
            formData.append("fileKey_" + idx, obj.fileKey);




        });

        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));


        treeModule.initFileArrays();

        // 상세내역 추가
        var detailArr = [];
        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                alert(elem);
                formData.append(elem, JSON.elem.value);
            });

        });

        var rowList = grid.getList();
        if (rowList.length == 0) {
            alert("추가할 항목을 선택해주세요_");
            return;
        }
        var detailArr = [];

        $.each(rowList, function (idx, elem) {
            var detailObj = {};
            detailObj["estSeq"] = idx + 1;
            detailObj["estDtlDiv"] = elem.estDtlDiv;
            detailObj["estComm"] = elem.estComm;
            detailObj["estSpec"] = elem.estSpec;
            detailObj["estUnit"] = elem.estUnit;
            detailObj["estQty"] = elem.estQty;
            detailObj["estUpr"] = elem.estUpr;
            detailObj["estRmk"] = elem.estRmk;

            detailArr.push(detailObj);

        });


        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    // 체크박스 전체 선택/해제 함수
    function allChk(elem) {
        if ($(elem).prop("checked")) {
            $("[name='detailChkBox']").prop("checked", true);
        } else {
            $("[name='detailChkBox']").prop("checked", false);
        }
    }

    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#estCoprt').data("rprc", value);
        $('#estCoprt option:not([value=""])').remove()
        setCommonSelect($('#estCoprt'));
    }


    //견적서 출력 선택 팝업 설정 함수
    function setReportPopup() {
        var paramObj = modalStack.last().paramObj;
        var iChk;
        var rptName;

        openSecondModal("/static/html/user/cr/cr01/SD0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
            var arg = "i_est_no#" + paramObj.estNo + "#"
                + "iChk#" + iChk + "#"
                + "imgPrt#" + imgPrt + "#";
            callReport(rptName, arg, 750, 900);
        });


    }


    /* 파일관련함수 */


    /* 리스너 */
    $(document).on("change", "input[name='estQty'], input[name='estWt'], input[name='estAmt'], input[name='expAmt']", function () {

    });

    $(document).on("click", "#fileBtn", function () {
        $("#file").click();
    });





    /* document.ready */
    $(document).ready(function () {
        getMaxEstNumber();
        document.getElementById('estAmt').addEventListener('input', function (e) {
            // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
e.target.value = e.target.value.replace(/[^0-9,]/g, '');
// 세 자리마다 콤마를 삽입합니다.
e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
// 0으로 시작하는 부분을 제거합니다.
e.target.value = e.target.value.replace(/^0+/, '');
        });
        document.getElementById('estNegoAmt').addEventListener('input', function (e) {
            // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
e.target.value = e.target.value.replace(/[^0-9,]/g, '');
// 세 자리마다 콤마를 삽입합니다.
e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
// 0으로 시작하는 부분을 제거합니다.
e.target.value = e.target.value.replace(/^0+/, '');
        });
        document.getElementById('exrate').addEventListener('input', function (e) {
            // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
e.target.value = e.target.value.replace(/[^0-9,]/g, '');
// 세 자리마다 콤마를 삽입합니다.
e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
// 0으로 시작하는 부분을 제거합니다.
e.target.value = e.target.value.replace(/^0+/, '');
        });

        /*     fileGridView.init(); */
        /*    fileGridView.setData(); */
        // 공통코드 selectBox set
        setCommonSelect($(".popup_area select[data-kind]"));
        function setCurrentDateToDatePicker(selector) {
            var currentDate = new Date();
            var formattedDate = currentDate.toISOString().slice(0, 10);
            $(selector).datepicker('update', formattedDate);
        }
        // 견적일자 datepicker bind
        $('#estDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true


        });

        setCurrentDateToDatePicker('#estDt');

        $('#estBaseDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#issueDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#estStdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 낙찰일자 datepicker bind
        $('#winbdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 파일 그리드 초기화
        /* 	fileGridView.initView(); */

        $('#ordrsDiv').on('change', function () {
            var selectedValue = $(this).val();
            if (selectedValue === 'normal') {
                $('#orgnSalesCd').prop('required', false);
            } else {
                $('#orgnSalesCd').prop('required', true);
            }
        }).trigger('change');
    });

    function fetchCurrencyData() {
        var paramObj = {"codeKind":"UNITDIV","useYn":"Y"};
        var paramObj2 = {"codeKind":"ESTDIV","useYn":"Y"};

        var promise1 = new Promise(function(resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj, null, function(data) {
                if(data && data.codeList) {
                    var codeList = data.codeList;
                    var options = codeList.map(function(code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        var promise2 = new Promise(function(resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj2, null, function(data) {
                if(data && data.codeList) {
                    var codeList = data.codeList;
                    var options2 = codeList.map(function(code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options2);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        return Promise.all([promise1, promise2]);
    }
    let selectedRowKey;

    const grid = new ax5.ui.grid();
    fetchCurrencyData().then(function([options, options2]) {
        grid.setConfig({
            target: $('[data-ax5grid="est-grid"]'),
            columns: [
                {
                    key: "estSeq", label: "번호", width: "5%", align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },
                {
                    key: "estDtlDiv", label: "구분", width: "12.5%", align: "center", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options:options2


                        }
                    }
                },
                {key: "estComm", label: "품명", align: "center", width: "12.5%", editor: {type: "text"}},
                {key: "estSpec", label: "사양", align: "left", width: "12.5%", editor: {type: "text"}},
                {
                    key: "estUnit", label: "단위", align: "center", width: "12.5%", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options // 서버에서 가져온 데이터를 사용
                        }
                    }
                },


                {key: "estQty", label: "수량", align: "right", width: "12.5%", editor: {type: "number",}},
                {key: "estUpr", label: "단가", align: "right", width: "12.5%", editor: {type: "number"}},
                {
                    key: "estAmt", label: "합계", width: "12.5%", align: "right", formatter: function () {
                        color = '#0000FF';
                        const sum = this.item.estQty * this.item.estUpr;
                        return '<div style="color: ' + color + '">'+sum.toLocaleString('en-US')+'</div>';

                    }
                },
                {key: "estRmk", label: "비고", align: "center", width: "12.5%", editor: {type: "text"}},
            ],

            footSum: [
                [
                    {label: "총합계", align: "center", colspan: 7},
                    {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
                ]
            ],
            body: {
                grouping: {
                    by: ["estDtlDiv"],
                    columns: [
                        {label: "소계", colspan: 7, align: "center"},
                        {
                            key: "estAmtMid",
                            collector: function () {
                                let sum = 0;
                                this.list.forEach(function (n) {
                                    if (!n.__grouping) sum += n.estQty * n.estUpr;
                                });
                                return sum;
                                //중간소계
                            },
                            formatter: "money",
                            align: "right",
                        },
                        {label: "", colspan: 2, align: "center"},
                    ],

                },
                onClick: function () {
                    this.self.clearSelect();
                    this.self.select(this.dindex);
                    const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(this, this.dindex);
                    const realIndex = this.dindex - subtotalRowsBeforeIndex;
                    selectedRowKey = realIndex;

                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons: {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter: function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        grid.addRow($.extend({}, grid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        grid.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        grid.config.columns.forEach((column) => {
                            grid.setValue(param.dindex, column.key, '');
                            grid.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(grid, param.dindex);
                        const realIndex = param.dindex - subtotalRowsBeforeIndex;
                        grid.removeRow(realIndex);
                    }


                    grid.contextMenu.close();
                    //또는 return true;
                }
            }
        });
        grid.setColumnSort({
            "estSeq": {orderBy: "asc", seq: 0},
        });
        let isUpdating = false;  // isUpdating 플래그 선언
        grid.onDataChanged = function () {
            if(this.item.estDtlDiv == undefined || isUpdating) {
                return;
            } else {
                isUpdating = true;  // 업데이트 시작을 표시

                const data = grid.getList();
                data.forEach((item, index) => {
                    item.estAmt = item.estQty * item.estUpr;  // 합계 계산 및 설정
                });
                grid.setData(data);
                isUpdating = false;  // 업데이트 종료를 표시
            }


        };


    })
    function countSubtotalRowsBeforeIndex(grid, index) {
        let count = 0;
        for (let i = 0; i < index; i++) {
            if (grid.list[i].__isGrouping) {
                count++;
            }
        }
        return count;
    }




    function updateRowTotals() {

    }


    function addEstDtlDivData(estDtlDivData) {
        const data = grid.getList();
        grid.setData([...data, ...estDtlDivData]);

        updateRowTotals();
    }
    let currentDivCount = 0;


    $("#addProductButton").on("click", function () {
        if (selectedRowKey !== undefined) {
            var row = grid.getList("selected")[0];
            var newRowData = {
                estDtlDiv: row.estDtlDiv,
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            };
            grid.addRow(newRowData,selectedRowKey);
        } else {
            alert("추가를 위해 선택된 행이 없습니다.");
        }
    });
    $("#deleteProductButton").on("click", function () {
        if (selectedRowKey !== undefined) {
            grid.removeRow(selectedRowKey);
            selectedRowKey = undefined;  // 선택된 키를 초기화합니다.
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });

    function addEstDtlDivWithPreset() {

        const estDtlDivData = [
            {
                estDtlDiv: "제작품",
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            },
            {
                estDtlDiv: "운송비",
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            },
            {
                estDtlDiv: "포장비",
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            },



        ];

        addEstDtlDivData(estDtlDivData);
    }


    function insertEstimateDetail() {


        // 변경된 부분: makeFormData() 함수를 호출하여 생성된 formData 객체를 사용합니다.
        var formData = makeFormData();
        for (var pair of formData.entries()) {
            console.log(pair[0] + "실데이터: " + pair[1]);
        }

        filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
            if (data.resultCode == 200) {
                alert(data.resultMessage);
                grid.setData(0);
            }
        });
    }

    var actionType = modalStack.last().paramObj.actionType;
    var paramObj = modalStack.last().paramObj;

    treeModule.initAll('deptTree', 'file-grid-popup', 'FITR01', paramObj);

    function updateButtonVisibility(actionType) {

        var degUpBtn = document.getElementById("degUpBtn");

        var ordrsBtn = document.getElementById("ordrsBtn");

        if (actionType === "U") {
            degUpBtn.style.display = "inline-block";
            ordrsBtn.style.display = "inline-block";
        } else {

            degUpBtn.style.display = "none";
            ordrsBtn.style.display = "none";

        }
    }

    updateButtonVisibility(actionType);

    if (actionType == "C") {
        $(document).ready(function(){
            $("#mngId").val(jwt.userId);
            $("#exrate").val(1);
            $('#estDeg').val(1);
            $('#estAmt').val(0);
            $('#ordrsYn').val('N');
            $('#estNegoAmt').val(0);

        })

        $('#actionBtn').on("click", function () {
            insertEst();
        });
        addEstDtlDivWithPreset();


    } else if (actionType == "U") {
        var parsedDataInfo
        postAjax("/user/cr/cr02/selectOrdrsWithEst", paramObj, null, function (data) {
            parsedDataInfo = data.info;
            // // Set the input field values with the received data
            // ordrsDt = document.getElementById('ordrsDt');
            // ordrsDt.value=parsedDataInfo.ordrsDt;
            // ordrsYn = document.getElementById('ordrsYn');
            // if(ordrsDt){
            // ordrsYn.value='확정'
            // }else{
            //     ordrsYn.value=''
            // }
            var myButton = document.getElementById("degUpBtn");
            var myButton2 = document.getElementById("ordrsBtn");
            if (parsedDataInfo) {
                myButton.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                myButton.disabled = true; // 버튼을 비활성화
                myButton2.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                myButton2.disabled = true; // 버튼을 비활성화


            } else {
                myButton.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                myButton.disabled = false; // 버튼을 활성화
                myButton2.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                myButton2.disabled = false; // 버튼을 활성화
            }
        });



        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            var parsedData = data;
            // Set the input field values with the received data
            Object.keys(parsedData.estInfo).forEach(function (key) {
                var inputField = document.getElementById(key);
                if (inputField) {
                    if (key == 'estClntCd') {
                        var estClntNmField = document.getElementById('estClntNm');
                        var estClntCdField = document.getElementById('estClntCd');
                        estClntCdField.value=parsedData.estInfo[key];
                        if (estClntNmField) {

                            var paramObj = {
                                "clntCd": parsedData.estInfo[key],

                            };
                            postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function (data) {
                                estClntNmField.value = data.clntInfo.clntNm;
                            });

                        }
                    } else {
                        if (key == 'estAmt' || key == 'estNegoAmt' || key == 'exrate') {
                            // If the key is one of the specified ones, add commas every three digits.
                            var value = parsedData.estInfo[key];
                            if (value != null && value != '') {
                                value = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            }
                            inputField.value = value || '';
                        } else {
                            inputField.value = parsedData.estInfo[key] || '';
                        }

                    }




                    if (parsedData.estInfo.estDeg == parsedData.estInfo.maxEstDeg) {
                        if (!parsedDataInfo) {
                            // degUpBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                            // degUpBtn.disabled = false; // 버튼을 활성화
                        }
                    } else {
                        // degUpBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                        // degUpBtn.disabled = true; // 버튼을 비활성화
                    }
                }
            });
            var degUpBtn = document.getElementById("degUpBtn");
            var ordrsBtn = document.getElementById("ordrsBtn");

            if( document.getElementById('ordrsYn').value=='Y'){
                degUpBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                degUpBtn.disabled = true; // 버튼을 비활성화
                ordrsBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                ordrsBtn.disabled = true; // 버튼을 비활성화


            }else{
                degUpBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                degUpBtn.disabled = false; // 버튼을 활성화
                ordrsBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                ordrsBtn.disabled = false; // 버튼을 활성화
            }


            var list = data.estInfo.list;

            grid.setData({
                list: list,
                page: {
                    totalElements: list.length
                }
            });


        });






        $('#actionBtn').on("click", function () {
            updateEst();
        });

    }
    var clicked = false;
    document.getElementById("degUpBtn").addEventListener("click", function () {
        var estDegInput = document.getElementById("estDeg");
        var currentValue = parseInt(estDegInput.value, 10) || 0;

        if (!clicked) {
            estDegInput.value = currentValue + 1;
            var tempEstDtValue = $("#estDt").val();
            insertEstNew().then((response) => {
                $("#estDt").val(tempEstDtValue);
                // 새로운 견적 번호와 차수를 입력 칸에 설정합니다.
                document.getElementById("estNo").value = response.estNo;
                document.getElementById("estDeg").value = response.estDeg;
            });
            alert("차수가 업데이트 되었습니다.");
            // 차수 증가 버튼이 클릭되었음을 표시합니다.
            clicked = true;
        } else {
            alert("차수는 1차씩만 올릴 수 있습니다.");
        }
    });

    function insertEstNew() {
        return new Promise((resolve, reject) => {
            if (validateRequiredFields() &&inputValidation($('.popup_area [required]'))) {
                var formData = makeFormDataWithDeg();

                filePostAjax("/user/cr/cr01/insertEstDeg", formData, function (data) {
                    if (data.resultCode == 200) {
                        // 새로 생성된 견적 번호를 반환합니다.
                        // 결과 데이터에 따라 newEstNo 변수를 적절하게 설정해야 합니다.
                        const newEstNo = data.newEst.estNo;
                        const newEstDeg = data.newEst.estDeg;
                        resolve({estNo: newEstNo, estDeg: newEstDeg});
                    } else {
                        // 실패한 경우 에러 메시지를 반환합니다.
                        reject(new Error(data.resultMessage));
                    }
                });

            }
        });
    }

    function insertOrdrsModal() {
        var paramObj = {
            "actionType": "DC",
            "coCd": $("#coCd").val(),
            "estNo": $("#estNo").val(),
            "ordrsClntCd": $("#estClntCd").val(),
            "ordrsClntNm": $("#estClntNm").val(),
            "clntPjt": $("#estClntNm").val(),
            "mngId": $("#cstmMngNm").val(),
            "exrate": $("#cstmMngHp").val(),

        };
        mask = new ax5.ui.mask();
        modal = new ax5.ui.modal();
        modalStack = new ModalStack();

        openModal("/static/html/user/cr/cr02/CR0202P01.html", 1400, 736, "", paramObj);

    }

    document.getElementById("ordrsBtn").addEventListener("click", function () {
        modalStack.close();
        insertOrdrsModal();
    });
    function recreateMask() {
        // Create mask element and set properties
        var mask = document.createElement('div');
        mask.id = 'ax-mask-19';
        mask.className = 'ax-mask';

        var maskBg = document.createElement('div');
        maskBg.className = 'ax-mask-bg';

        var maskContent = document.createElement('div');
        maskContent.className = 'ax-mask-content';

        var maskBody = document.createElement('div');
        maskBody.className = 'ax-mask-body';

        // Append children to mask
        maskContent.appendChild(maskBody);
        mask.appendChild(maskBg);
        mask.appendChild(maskContent);

        // Append mask to body
        document.body.appendChild(mask);
    }


    function validateRequiredFields() {

        const gridIn = grid.getList();

        for (let i = 0; i < gridIn.length; i++) {
            const row = gridIn[i];

            // 필수 입력 필드 검사
            if (!row.estComm || !row.estSpec || !row.estUnit || !row.estQty ||
                !row.estUpr  ) {
                alert(`견적 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
                return false;
            }

        }


        // for (let i = 0; i < dataOrdrsDetail.length; i++) {
        //     const row = dataOrdrsDetail[i];
        //
        //     // 필수 입력 필드 검사
        //     if (!row.ordrsDtlDiv10 || !row.prdtCd || !row.itemDiv || !row.eqpNm ||
        //         !row.ordrsPrcMach || !row.ordrsPrcElcty || !row.ordrsPrc || !row.ordrsQty ||
        //         !row.estEpctMatPrc || !row.trgtPchsPcostMach || !row.trgtPchsPcostElcty ||
        //         !row.trgtPchsPcostInHousePrcsn || !row.laborCostMfgCost || !row.dtlRmk) {
        //         alert(`수주 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
        //         return false;
        //     }
        // }


        return true;
    }



</script>
</html>
