<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">

	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5calendar.min.js"></script>
	<script src="/static/js/ax5/ax5picker.min.js"></script>
	<script src="/static/js/ax5/ax5menu.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5combobox.min.js"></script>

	<script src="/static/js/global.js"></script>
	<style>
		input[comma] {text-align: right;}
		.popup_table input {
			border:none;
		}
	</style>
</head>
<body>

<div id="head_area"></div>
<div id="top_area"></div>

<div id="main_area">
	<div class="popup_area of_a" style="width: 100%; height: 100%;">
		<div class="tit_contents">
			<h4 class="tit"></h4>
		</div>
		<div class="popup_table">
			<input type="file" id="file" style="display: none" multiple="multiple" onchange="setFile(this);" />
			<form id="popForm">
				<input type="hidden" id="pgmId" name="pgmId" value="CR0101M01">

				<table>
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd" name="coCd" data-kind="CO" onchange="setByCoCd(this.value)" required></select>
						</td>
						<th class="hit">작성일자</th>
						<td>
							<input type="text" class="input_calendar" autocomplete="off" id="estDt" name="estDt" date required>
						</td>
						<th class="hit">발행일자</th>
						<td>
							<input type="text" class="input_calendar" autocomplete="off" id="issueDate" name="issueDate" date required>
						</td>
						<th class="hit">견적번호</th>
						<td>
							<input style="background-color:#ddd!important"type="text" id="estNo" name="estNo"  readonly required>
						</td>
					</tr>
					<tr>
						<th class="hit">거래처</th>
						<td>
							<input type="hidden" id="estClntCd" name="estClntCd">
							<div class="search_form">
								<input type="text" id="estClntNm" name="estClntNm" readonly required>
								<a onclick="openSecondClntSearch();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<th class="hit">고객담당자</th>
						<td>
							<input type="text" id="custMngr" name="custMngr" required>
						</td>
						<th class="hit">연락처</th>
						<td>
							<input type="text" id="contact" name="contact" required>
						</td>
						<th class="hit">견적금액</th>
						<td>
							<input type="text" id="estAmount" name="estAmount"  required>
						</td>
					</tr>
					<tr>
						<th class="hit">공사명</th>
						<td>
							<input type="text" id="prjctNm" name="prjctNm" required>
						</td>
						<th class="hit">견적기준일자</th>
						<td>
							<input type="text" class="input_calendar" autocomplete="off" id="estBaseDate" name="estBaseDate" date required>
						</td>
					</tr>
					<tr>
						<th class="hit">납품조건</th>
						<td>
							<input type="text" id="dlvrCndt" name="dlvrCndt" required>
						</td>
						<th class="hit">견적제외사항</th>
						<td>
							<input type="text" id="estExclusions" name="estExclusions" required>
						</td>


					</tr>
					<tr>
						<th class="hit">결제조건</th>
						<td>
							<input type="text" id="pmntCndt" name="pmntCndt" required>
						</td>
					</tr>
					<tr>
						<th class="hit">납기</th>
						<td>
							<input type="text" class="" id="dueDate" name="dueDate" required>
						</td>
					</tr>
				</table>
			</form>
		</div>
		<br>
		<div class="popup_table" style="margin-top: 15px;">

			<div class="" style="padding-left: 0;">
				<div class="contents" style="margin:0px; padding:0px; height: 480px; width: 100%; min-width: 200px">
					<div style="float:right">

						<button id="estDtlDivButton" style="margin-right:8px;margin-top:8px;">섹션 추가</button>
					</div>
					<h3 class="location">
						<a class="file_tag" id="file_tag" style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
						<span class="page_tit" style="text-align: right;"></span>
					</h3>
					<div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
						<div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 100%;"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="popup_table">
			<table>
				<colgroup>
					<col width="12%">
					<col width="">
				</colgroup>
				<tr>
					<th>
						<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="file.click();" authchk>첨부파일</button>
					</th>
					<td>
						<div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 130px; width: 100%"></div>
					</td>
				</tr>
			</table>
		</div>
		<!-- 하단 버튼 -->
		<div class="popup_bottom_btn">
			<button id="actionBtn" authchk>등록</button>
			<button onclick="setReportPopup();">견적서출력</button>
			<button class="close_btn" onclick="modalStack.close();">닫기</button>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
	var fileArr = [];
	var deleteFileArr= [];
	var fileGridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target : $('[data-ax5grid="file-grid"]'),
				showLineNumber : true,
				showRowSelector : false,
				multipleSelect : false,
				header : {
					selector : false
				},
				body : {
					onDBLClick: function () {
						if(this.item.fileKey){
							downloadFile(this.item.fileKey);
						}
					}
				},
				columns : [
					{key: "fileName", label: "파일명", align: "center", width: 580},
					{key: "fileType", label: "파일타입", align: "center", width: 80},
					{key: "fileSize", label: "파일크기", align: "center", width: 80},
					{
						key:"fileDelete", label: "삭제", align: "center", width: 80,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
				]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}
	/* 견적서함수 */
	//견적 번호 조회 함수
	function getMaxEstNumber() {
		let paramObj = {}; // Add any parameters needed for the request
		// postAjax("/user/cr/cr01/maxEst", paramObj, null, function (data) {
		// 	// Set the received maximum estimation number to the input field
		// 	$("#estNo").val(data.maxEstNo);
		// });
	}
	// 견적 정보 조회 함수
	function selectEstInfo(){
		var paramObj = modalStack.last().paramObj;
		postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function(data){
			setEstInfo(data.estInfo);
		});
	}
	// 견적 정보 설정 함수
	function setEstInfo(estInfo){
		//메인정보 세팅
		$.each(estInfo, function(key, value){
			if($('#'+key)[0]){
				if($('#'+key).is('[date]')){
					$('#'+key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
				}else{
					if($('#'+key).is('[comma]')){
						value = addCommaStr(value);
					}
					if(key=="coCd"){
						setByCoCd(value)
					}
					$('#'+key).val(value);
				}
			}
		});


		$.each(estInfo.estDetailList, function(idx, obj){
			if(idx != 0) addRow();
			$addedRow = $("tr[name='detailRow']:last");

			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
					}
					$(elem).val(itemValue);
				}
			});
		});
		countTot();


		$.each(estInfo.estFileList, function(idx, obj){
			fileArr.push({
				'fileKey' : obj.fileKey,
				'fileName' : obj.fileName,
				'fileType' : obj.fileType,
				'fileSize' : obj.fileSize,
				'file' : obj
			});
		});


	
	}

	// 거래처 검색 함수
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#estClntCd').val(row.clntCd);
			$('#estClntNm').val(row.clntNm);

			var paramObj = {
				"coCd": $('#coCd').val(),
				"clntCd": row.clntCd
			}
			setMngInfo(paramObj);
		});
	}

	// 담당자 정보 설정 함수
	function setMngInfo(paramObj){
		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function(data) {
			if(data.mngInfo){
				$('#salesEmpId').val(data.mngInfo.salesEmpId);
				$('#salesEmpNm').val(data.mngInfo.salesEmpNm);
			}else{
				$('#salesEmpId').val("");
				$('#salesEmpNm').val("");
			}
		});
	}

	// 사용자 검색 함수
	function openSecondUserSearch() {
		var paramObj = {
			"coCd" : "GUN", //$('#coCd').val(),
			"userId": $('#salesEmpId').val(),
			"useYn": "Y"
		};

		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$("#salesEmpId").val(checkedNode.id);
			$("#salesEmpNm").val(checkedNode.text);
		});
	}


	// 제품 검색 함수
	function openSecondPrdtSearch(elem) {
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd" : $("#coCd").val(),
			"selpchCd": "SELPCH2",
			"impYn": "N",
			"clntCd" : $("#estClntCd").val(),
			"prjctCd" : $("#prjctCd").val(),
			"useYn": "Y"
		};

		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			// 값 초기화
			$targetRow.find('input[name]').val("");
			// input 제어
			if(row.prdtStockCd == "Y"){
				$targetRow.find('input[name="prdtSize"]').attr("readonly", false);
				$targetRow.find('input[name="prdtSpec"]').attr("readonly", false);
				$targetRow.find('input[name="estQty"]').attr("readonly", false);
				$targetRow.find('input[name="estWt"]').attr("readonly", false);
			}else{
				$targetRow.find('input[name="prdtSize"]').attr("readonly", true);
				$targetRow.find('input[name="prdtSpec"]').attr("readonly", true);
			}
			$.each(row, function(key, value){
				if($targetRow.find('[name="'+key+'"]')[0]){
					$targetRow.find('[name="'+key+'"]').val(value);
				}
			});
			$targetRow.find('input[name="estUpr"]').val(row.ordrgUpr);

			countTot();
		});
	}
	// 현장 검색 함수
	function openSecondSiteSearch(){
		var paramObj = {
			"coCd": $('#popForm #coCd').val(),
			"clntCd": $('#popForm #estClntCd').val(),
			"clntNm": $('#popForm #estClntNm').val(),
			"insertYn": "Y",
			"isClntReq": "Y"
		}

		openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (grid){
			var row = grid.target.getList("selected")[0];
			$('#prjctCd').val(row.siteCd);
			$('#prjctNm').val(row.siteNm);
		});
	}


	/*
	let selectedTable = "A";
	function addRowWithSubtotal() {
		  const itemType = document.getElementById('itemType').value;
		  const tableA = document.getElementById('detailTableA');
		  const subtotalRowIndex = Array.from(tableA.rows).findIndex(
		    row => row.classList.contains('subtotal-row') && row.dataset.itemType === itemType
		  );

		  if (subtotalRowIndex === -1) {
		    createSubtotalRow(itemType);
		  } else {
		    addRow(itemType, subtotalRowIndex);
		  }

		  document.getElementById('itemType').value = ''; // 셀렉트 박스를 초기 상태로 되돌립니다.
		}

		function createSubtotalRow(itemType) {
		  const tableA = document.getElementById('detailTableA');
		  const newRow = tableA.insertRow(-1);

		  newRow.classList.add('subtotal-row');
		  newRow.dataset.itemType = itemType;
		  newRow.innerHTML = `
		    <td  colspan="6" style="text-align:center;background-color:#eee">${itemType} 소계</td>
		    <td></td>
		  `;

		  addRow(itemType);
		}

		function addRow(itemType) {
			  if (!itemType) return;

			  const tableA = document.getElementById('detailTableA');
			  const subtotalRowIndex = Array.from(tableA.rows).findIndex(
			    row => row.dataset.itemType === itemType
			  );

			  if (subtotalRowIndex === -1) {
			    createSubtotalRow(itemType);
			  } else {
			    const newRow = tableA.insertRow(subtotalRowIndex);
			    const uniqueId = generateUniqueId(itemType);
			    newRow.setAttribute('id', uniqueId);

			    newRow.innerHTML = `
			        <td><input type="text" name="division" class="division-input" value="${itemType}" readonly></td>
			        <td><input type="text" name="productName"></td>
			        <td><input type="text" name="specification"></td>
			        <td><input type="text" name="unit"></td>
			        <td><input type="number" name="quantity" onchange="updateSubtotal('${itemType}')"></td>
			        <td><input type="number" name="unitPrice" onchange="updateSubtotal('${itemType}')"></td>
			        <td><input type="number" name="totalPrice" onchange="updateSubtotalOnTotalPriceChange(this)" readonly></td>
			        <td><input type="text" name="remark"></td>
			      `;
			  }
			}

			function removeRow(itemType) {
			  if (!itemType) return;

			  const tableA = document.getElementById('detailTableA');
			  const subtotalRowIndex = Array.from(tableA.rows).findIndex(
			    row => row.dataset.itemType === itemType
			  );

			  if (subtotalRowIndex > 0) {
			    tableA.deleteRow(subtotalRowIndex - 1);

			    if (tableA.rows[subtotalRowIndex - 1]?.classList.contains('subtotal-row')) {
			      tableA.deleteRow(subtotalRowIndex - 1);
			      selectedValues = selectedValues.filter(value => value !== itemType);
			    }
			  }
			}




			document.addEventListener('DOMContentLoaded', function () {
				  const addButton = document.getElementById('addButton');
				  let selectedItemType = null;

				  // Add click event listener to the table for selecting the subtotal row
				  document.getElementById('detailTableA').addEventListener('click', (event) => {
				    const target = event.target.closest('tr');
				    if (!target) return;

				    if (target.dataset.itemType) {
				      selectedItemType = target.dataset.itemType;

				    }
				  });

				  addButton.addEventListener('click', function () {
				    if (selectedItemType) {
				      addRow(selectedItemType);
				    }
				  });
				});
			document.addEventListener('DOMContentLoaded', function () {
				  const addButton = document.getElementById('addButton');
				  let selectedItemType = null;

				  // Add click event listener to the table for selecting the subtotal row
				  document.getElementById('detailTableA').addEventListener('click', (event) => {
				    const target = event.target.closest('tr');
				    if (!target) return;

				    if (target.dataset.itemType) {
				      if (selectedItemType) {
				        // Reset background color of previously selected subtotal row
				        const selectedSubtotalRows = document.querySelectorAll(`[data-item-type="${selectedItemType}"]`);
				        for (let i = 0; i < selectedSubtotalRows.length; i++) {
				          selectedSubtotalRows[i].style.color = "white";
				        }
				      }

				   //   selectedItemType = target.dataset.itemType;

				    }
				  });


				});




			function generateUniqueId(itemType) {
				  return itemType + '-' + new Date().getTime() + '-' + Math.random().toString(36).substr(2, 9);
				}


			function calculateRowTotal(inputs) {
				  const quantity = parseFloat(inputs[4].value);
				  const unitPrice = parseFloat(inputs[5].value);

				  if (quantity && unitPrice) {
				    const totalPrice = quantity * unitPrice;
				    inputs[6].value = totalPrice.toFixed(2);
				    return totalPrice;
				  } else {
				    return 0;
				  }
				}

			function calculateTotal(input, tableId) {
			  const row = input.parentNode.parentNode;
			  const inputs = Array.from(row.querySelectorAll('input'));
			  const rowTotal = calculateRowTotal(inputs);
			  inputs[6].value = rowTotal.toFixed(2);

			  const allRows = Array.from(document.querySelectorAll(`${tableId} tbody tr`));
			  const total = allRows.reduce((sum, row) => {
			    const rowTotalInput = row.querySelector('input[name="totalPrice"]');
			    const rowTotal = rowTotalInput ? parseFloat(rowTotalInput.value) || 0 : 0;
			    return sum + rowTotal;
			  }, 0);

			  const subtotalEl = document.getElementById(tableId === '#detailTableA' ? 'subtotal' : 'subtotalB');
			  if (isNaN(total)) {
			    subtotalEl.textContent = 0;
			  } else {
			    subtotalEl.textContent = total.toFixed(2);
			  }
			}



			function handleInput(event, tableId) {
			  const input = event.target;
			  if (input.name === 'quantity' || input.name === 'unitPrice') {
				  calculateTotal(input, tableId);
			  }
		  	}

			  // input 엘리먼트의 수정 이벤트를 모두 핸들링하여 합계를 계산하도록 함
			  const tableA = document.querySelector('#detailTableA');
			  tableA.addEventListener('input', event => {
			  handleInput(event, '#detailTableA');
			  });

			  const tableB = document.querySelector('#detailTableB');
			  tableB.addEventListener('input', event => {
			  handleInput(event, '#detailTableB');
			  });

			  function calculateTotalExpenses(tableIdA, tableIdB, totalId) {
				  const calculateTableExpenses = (tableId) => {
				    const allRows = Array.from(document.querySelectorAll(`${tableId} tbody tr`));
				    return allRows.reduce((sum, row) => {
				      const rowTotalInput = row.querySelector('input[name="totalPrice"]');
				      const rowTotal = rowTotalInput ? parseFloat(rowTotalInput.value) || 0 : 0;
				      return sum + rowTotal;
				    }, 0);
				  };

				  const tableAExpenses = calculateTableExpenses(tableIdA);
				  const tableBExpenses = calculateTableExpenses(tableIdB);

				  const totalExpenses = tableAExpenses + tableBExpenses;
				  const formattedTotalExpenses = totalExpenses.toFixed(2);

				  const totalElement = document.getElementById(totalId);
				  totalElement.textContent = formattedTotalExpenses;

				  return formattedTotalExpenses;
				}



			  function onInputChange() {
			    calculateTotalExpenses('#detailTableA', '#detailTableB', 'alltotal');

			  }

			  if (tableA) {
			    tableA.addEventListener('input', onInputChange);
			  }

			  if (tableB) {
			    tableB.addEventListener('input', onInputChange);
			  }


































			function updateSubtotalOnTotalPriceChange(inputElem) {
				  const row = inputElem.closest('tr');
				  const itemType = row.querySelector('input[name="division"]').value;

				  let currentRow = row.previousElementSibling;
				  let subtotalRow;

				  while (currentRow) {
				    if (currentRow.classList.contains('subtotal-row') && currentRow.dataset.itemType === itemType) {
				      subtotalRow = currentRow;
				      break;
				    }
				    currentRow = currentRow.previousElementSibling;
				  }

				  if (!subtotalRow) return;

				  let subtotal = 0;
				  currentRow = subtotalRow.nextElementSibling;

				  while (currentRow && !currentRow.classList.contains('subtotal-row')) {
				    const totalPriceInput = currentRow.querySelector('input[name="totalPrice"]');
				    if (totalPriceInput) {
				      const totalPriceValue = parseFloat(totalPriceInput.value) || 0;
				      subtotal += totalPriceValue;
				    }
				    currentRow = currentRow.nextElementSibling;
				  }

				  subtotalRow.getElementsByTagName('td')[1].textContent = subtotal.toFixed(2);
				}






	// 중량계산
	function calEstWt(elem){
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		var estQty = Number(deleteCommaStr($targetRow.find('input[name="estQty"]').val())) || 0;
		var prdtCnvrsnWt = Number($targetRow.find('input[name="prdtCnvrsnWt"]').val()) || 0;
		var estWt = estQty * prdtCnvrsnWt;
		$targetRow.find('input[name="estWt"]').val(addCommaStr(estWt));
	}
	// 금액계산
	function countAmt(elem){
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		var prdtStockCd = $targetRow.find('input[name="prdtStockCd"]').val();
		var prdtUnitNm = $targetRow.find('input[name="prdtUnitNm"]').val();
		var estQty   = Number(deleteCommaStr($targetRow.find('input[name="estQty"]').val()));
		var estWt   = Number(deleteCommaStr($targetRow.find('input[name="estWt"]').val()));
		var estUpr   = Number(deleteCommaStr($targetRow.find('input[name="estUpr"]').val()));
		var stockUpr = $targetRow.find('input[name="stockUpr"]').val();
		var prdtDiv = $targetRow.find('input[name="prdtDiv"]').val();

		var totEstAmt = 0;
		var totExpAmt = 0;
		if( (prdtDiv != "PRDTDIV20") && ((prdtUnitNm == "KG") || (prdtUnitNm == "TON"))){
			totEstAmt = estWt * estUpr;
			totExpAmt = (estWt * estUpr) - (estWt * stockUpr);
			$targetRow.find('input[name="estAmt"]').val(addCommaStr(totEstAmt.toFixed(0)));
			$targetRow.find('input[name="expAmt"]').val(addCommaStr(totExpAmt.toFixed(0)));
		}else{
			$targetRow.find('input[name="estAmt"]').val(addCommaStr(estQty * estUpr));
			$targetRow.find('input[name="expAmt"]').val(addCommaStr((estQty * estUpr) - (estQty * stockUpr)));
		}
		countTot();
	}

	function countTot() {
		var totEstQty = 0;
		var totEstWt  = 0;
		var totEstAmt = 0;
		var totExpAmt = 0;

		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
			var estQty = $(elem).find("input[name='estQty']").val();
			var estWt  = $(elem).find("input[name='estWt']").val();
			var estAmt = $(elem).find("input[name='estAmt']").val();
			var expAmt = $(elem).find("input[name='expAmt']").val();
			var stockCd = $(elem).find("input[name='prdtStockCd']").val();

			if (stockCd == "Y"){
				totEstQty  += Number(deleteCommaStr(estQty));
				totEstWt   += Number(deleteCommaStr(estWt));
			}
			totEstAmt  += Number(deleteCommaStr(estAmt));
			totExpAmt  += Number(deleteCommaStr(expAmt));
		});


		if ((totEstQty % 1)== 0) {
			$("#totEstQty").html(addCommaStr(totEstQty.toFixed(0)));
		} else {
			$("#totEstQty").html(addCommaStr(totEstQty.toFixed(3)));
		}
		if  ((totEstWt % 1)== 0) {
			$("#totEstWt").html(addCommaStr(totEstWt.toFixed(0)));
		} else {
			$("#totEstWt").html(addCommaStr(totEstWt.toFixed(3)));
		}
		$("#totEstAmt").html(addCommaStr(totEstAmt.toFixed(0)));
		$("#totExpAmt").html(addCommaStr(totExpAmt.toFixed(0)));
	} */






	/* 기타함수 */

	// 문자열을 주어진 바이트 길이로 자르는 함수
	function cutStr(str, maxByte) {

		for(b=i=0;c=str.charCodeAt(i);) {
			b+=c>>7?2:1;
			if (b > maxByte)
				break;
			i++;
		}
		return str.substring(0,i);
	}

	// 견적 정보 삽입 함수
	function insertEst() {

		var formData = makeFormData();

		filePostAjax("/user/cr/cr01/insertEst", formData, function(data){
			alert(data.resultMessage);
			if(data.resultCode == 200){

				//location.href="/static/html/user/cr/cr01/CR0102P01.html";
			}
		});
	}

	// 견적 정보 업데이트 함수
	function updateEst() {
		//비고 문자열 길이 필드길이로 byte 자르기
		$("#estRprc").val(cutStr($("#estRprc").val(),100));
		$("#prjctNm").val(cutStr($("#prjctNm").val(),100));
		$("#rmk").val(cutStr($("#rmk").val(),1000));
		if(inputValidation($('.popup_area input[required]'))) {
			var formData = makeFormData();
			filePutAjax("/user/cr/cr01/updateEst", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	// 폼 데이터 생성 함수
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem){
			deleteComma(elem);
		});

		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem){
			deleteHyphen(elem);
		});

		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);

		// 유저아이디 추가
		formData.append("userId", jwt.userId);

		// 첨부파일 추가
		$.each(fileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));




		// 상세내역 추가
		var detailArr = [];
		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
			var detailObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				alert(elem);
				formData.append(elem, JSON.elem.value);
			});

		});

		var rowList = grid.getList();
		if (rowList.length == 0) {
			alert("추가할 항목을 선택해주세요_");
			return;
		}
		var detailArr = [];

		$.each(rowList, function (idx, elem) {
			var detailObj = {};
			detailObj["estSeq"] = idx+1;
			detailObj["estDtlDiv"] = elem.estDtlDiv;
			detailObj["estComm"] = elem.estComm;
			detailObj["estSpec"] = elem.estSpec;
			detailObj["estUnit"] = elem.estUnit;
			detailObj["estQty"] = elem.estQty;
			detailObj["estUpr"] = elem.estUpr;
			detailObj["estRmk"] = elem.estRmk;

			detailArr.push(detailObj);

		});




		formData.append("detailArr", JSON.stringify(detailArr));





		return formData;
	}
	// 체크박스 전체 선택/해제 함수
	function allChk(elem){
		if($(elem).prop("checked")){
			$("[name='detailChkBox']").prop("checked", true);
		} else {
			$("[name='detailChkBox']").prop("checked", false);
		}
	}
	// 판매법인 설정 함수
	function setByCoCd(value){
		// 판매법인 set
		$('#estCoprt').data("rprc", value);
		$('#estCoprt option:not([value=""])').remove()
		setCommonSelect($('#estCoprt'));
	}


	//견적서 출력 선택 팝업 설정 함수
	function setReportPopup() {
		var paramObj = modalStack.last().paramObj;
		var iChk;
		var rptName;

		openSecondModal("/static/html/user/cr/cr01/SD0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
			var arg = "i_est_no#" + paramObj.estNo + "#"
					+ "iChk#" + iChk + "#"
					+ "imgPrt#" + imgPrt + "#";
			callReport(rptName, arg, 750, 900);
		});


	}








	/* 파일관련함수 */


	function setFile(elem) {
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj) {
			var testArr = obj.name.split(".");
			fileArr.push({
				'fileKey' : 0,
				'fileName' : obj.name,
				'fileType' : testArr[testArr.length - 1],
				'fileSize' : obj.size,
				'file' : obj
			});
		});
		fileGridView.setData();
		$(elem).val("");
	}

	function deleteFile(rowIndex) {
		/* 			fileGridView.target.removeRow(rowIndex);

                    if (fileArr[rowIndex].fileKey) {
                        // 기 등록되어 있는 파일 삭제시
                        deleteFileArr.push(fileArr[rowIndex].fileKey);
                    }

                    fileArr.splice(rowIndex, 1);
                    fileGridView.setData(); */
	}

	function downloadFile(fileKey) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}


	/* 리스너 */
	$(document).on("change", "input[name='estQty'], input[name='estWt'], input[name='estAmt'], input[name='expAmt']", function () {

	});

	$(document).on("click", "#fileBtn", function () {
		$("#file").click();
	});

	$(document).on("change", "#file", function () {
		setFile(this);
	});

	/* 		$(document).on("click", "#fileGridView .file_delete", function () {
              var rowIndex = $(this).closest("tr").index();
              deleteFile(rowIndex);
            }); */

	/* 		$(document).on("click", "#fileGridView .file_download", function () {
              var rowIndex = $(this).closest("tr").index();
              downloadFile(fileArr[rowIndex].fileKey);
            }); */

	/* document.ready */
	$(document).ready(function () {
		mainDefaultLoad("영업관리", "견적서 등록(TOBE)");
		getMaxEstNumber();
		fileGridView.initView();


		/*     fileGridView.init(); */
		/*    fileGridView.setData(); */
		// 공통코드 selectBox set
		setCommonSelect($(".popup_area select[data-kind]"));
		// 견적일자 datepicker bind
		$('#estDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});

		$('#estBaseDate').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		$('#issueDate').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		// 낙찰일자 datepicker bind
		$('#winbdDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		// 파일 그리드 초기화
		/* 	fileGridView.initView(); */
		$('#actionBtn').on("click", function(){insertEstimateDetail();});



	});


	// 그리드 생성
	const grid = new ax5.ui.grid();
	grid.setConfig({
		target: $('[data-ax5grid="first-grid"]'),
		columns: [
			{ key: "estSeq", label: "번호", width: "5%", align: "center",  formatter: function () {
					return this.item.__index + 1;
				}, },
			{ key: "estDtlDiv", label: "구분", width: "12.5%", align: "center" },
			{ key: "estComm", label: "품명", align: "center", width: "12.5%", editor: { type: "text" } },
			{ key: "estSpec", label: "사양", align: "left", width: "12.5%", editor: { type: "text" } },
			{ key: "estUnit", label: "단위", align: "center", width: "12.5%", editor: { type: "text" } },
			{key: "estQty", label: "수량", align: "left", width: "12.5%", editor: { type: "number" }},
			{key: "estUpr", label: "단가", align: "right", width: "12.5%", editor: { type: "number" }},
			{ key: "estAmt", label: "합계", width: "12.5%", align: "right", formatter: function () { return this.item.estQty * this.item.estUpr; } },
			{ key: "estRmk", label: "비고", align: "center", width: "12.5%", editor: { type: "text" } },
		],
		footSum: [
			[
				{label: "총합계", align:"center", colspan:6},
				{key: "estAmt", collector: "sum", formatter:"money", align: "right"},
			]
		],
		body: {
			grouping: {
				by: ["estDtlDiv"],
				columns: [
					{ label: "소계", colspan: 6, align: "center" },
					{
						key: "estAmt",
						collector: function () {
							let sum = 0;
							this.list.forEach(function (n) {
								if (!n.__grouping) sum += n.estQty * n.estUpr;
							});
							return sum;
						},
						formatter: "money",
						align: "right",
					},
					{ label: "", colspan: 2, align: "center" },
				]
			},
			onClick: function () {
				this.self.clearSelect();
				this.self.select(this.dindex);
			}
		},
	});


	grid.onDataChanged = function () {
		updateRowTotals();

		// 이벤트 처리 및 기존 코드

		// 소계 업데이트

	};

	function updateRowTotals() {
		const data = grid.getList();

		data.forEach((item, index) => {
			if (!item.__grouping) {
				const estAmt = item.estQty * item.estUpr;
				grid.setValue(index, "estAmt", estAmt);
			}
		});
		grid.repaint();
	}

	$("#estDtlDivButton").on("click", function () {
		addEstDtlDiv();
	});
	function addEstDtlDivData(estDtlDivData) {
		const data = grid.getList();
		grid.setData([...data, ...estDtlDivData]);
		updateRowTotals();
	}

	// 동적으로 estDtlDiv를 추가하는 함수
	function addEstDtlDiv() {
		const estDtlDivLetter = prompt("섹션 이름을 입력하세요").toUpperCase();
		const itemCount = parseInt(prompt("estDtlDiv에 추가할 품목 수를 입력하세요 (예: 2)"));

		if (!estDtlDivLetter || isNaN(itemCount)) {
			alert("잘못된 입력입니다. 다시 시도해 주세요.");
			return;
		}

		const estDtlDivData = [];

		for (let i = 1; i <= itemCount; i++) {
			estDtlDivData.push({
				estDtlDiv: estDtlDivLetter,
				estComm: `Item ${estDtlDivLetter}${i}`,
				estSpec: "10x20",
				estUnit: "EA",
				estQty: "",
				estUpr: "",
			});
		}
		addEstDtlDivData(estDtlDivData);



		$("#estDtlDivInput").val(""); // 입력 필드를 초기화합니다.
	}


	function insertEstimateDetail() {


		// 변경된 부분: makeFormData() 함수를 호출하여 생성된 formData 객체를 사용합니다.
		var formData = makeFormData();
		for (var pair of formData.entries()) {
			console.log(pair[0] + "실데이터: " + pair[1]);
		}

		filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
			if (data.resultCode == 200) {
				alert(data.resultMessage);
				grid.setData(0);
			}
		});
	}





</script>
</html>
