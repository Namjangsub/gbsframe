
<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">년간 사업계획 등록</h4>
    </div>
    
    <div class="popup_table">
        <div class="form-group">
            <form id="popForm">
            <input type="hidden" id="fileTrgtKey"    name="fileTrgtKey">
            <input type="hidden" id="userId"        name="userId">
            <input type="hidden" id="pgmId"         name="pgmId"    value="CR1601P01">
                <table class="popup_table">
                    <colgroup>
                         <col width="6%">
                         <col width="11%">
                         <col width="6%">
                         <col width="11%">
                         <col width="6%">
                         <col width="11%">
                         <col width="8%">
                         <col width="11%">
                         <col width="6%">
                         <col width="11%">
                    </colgroup>
                    
                    <thead>
                        <tr>
                           <td colspan="10" style="height:30px;text-align: left;">기본정보</td>                                                
                        </tr>
                    </thead>
                    
                    <tbody>
                        <!-- 1행 -->
                        <tr>
                            <th class="hit">회사</th>
                            <td>
                                <select id="coCd" name="coCd" data-kind="CO" data-search="coCd" required="required">
                                 <option value="">전체</option>
                                </select>
                            </td>
                            <th class="hit">계획년도</th>
                            <td>
                            <input type="text" class="input_calendar" id="salesPlanYy" name="salesPlanYy" data-search="salesPlanYy"  autocomplete="off" date required="required">                   
                            </td>
                            <th class="hit">고객사</th>
                            <td> 
                            <input type="hidden" id="salesPlanClntCd" name="salesPlanClntCd"  data-search="salesPlanClntCd" required="required" >
                            <div class="search_form" style="width: 100%;">
                                <input type="text" id="salesPlanClntNm" name="salesPlanClntNm"  data-search="salesPlanClntNm" onkeyup="if(window.event.keyCode == 8){salesPlanClntCd.value = ''};"> 
                                <a onclick="openClntSearchP('P');"><i class="i_search_w"></i></a>
                            </div>
                            </td>
                            <th class="hit">영업 담당자</th>
                            <td>
                            <input type="hidden" id="salesPlanId" name="salesPlanId" data-search="salesPlanId" style="width: 100%;" required="required">
                                    <div class="search_form">
                                     <input type="text" id="salesPlanNm" name="salesPlanNm" data-search="salesPlanNm" onkeyUp="if(window.event.keyCode == 8){salesPlanId.value = ''};">
                                        <a onclick="openUserTreeP();"><i class="i_search_w"></i></a>
                                    </div>
                            </td>
                            <th class="hit">계획구분</th>
                            <td>
                            <select id="salesPlanDiv" name="salesPlanDiv" data-kind="SALESPLANDIV" required="required">
                              <option value="">선택</option>
                              </select>
                            </td>
                        </tr>
                    </tbody>
                </table>    
            </form>
        </div>
    </div>
    <div class="popup_table">               
        <table style="border:0px;">
            <tr>
                <td style="text-align: LEFT; border-right: 0px;width:10%;">※상세내역</td>
                <td style="text-align:right;width:45%;">                    
                </td>
                <td style="text-align: LEFT; border-right: 0px;width:10%;">※예상장비</td>
                <td style="text-align:right;width:35%;">
<!--                     <div id="addrow" class="add_btn_small pdl10">
                        <a onclick="" data-grid-control="row-add" style="height: 30px; line-height: 28px;">+</a>
                        <a onclick="" data-grid-control="row-remove" style="height: 30px; line-height: 28px;">-</a>
                    </div> -->
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: LEFT; border-right: 0px;">
                   <div data-ax5grid="second-grid1" data-ax5grid-config="{}" style="height: 410px; width: 100%"></div>
                </td>
                 <td colspan="2" style="text-align: LEFT; border-right: 0px;">
                 <div data-ax5grid="second-grid2" data-ax5grid-config="{}" style="height: 410px; width: 100%"></div>
                </td>                
            </tr>            
        </table>      
    </div>
    <div class="contents">
         <!-- 공통 파일 영역 -->
         <div id="fileList_area"></div>   
    </div>
    <br>
    <div class="col-xs-2" style="height: 70px;">
    </div>

    <!-- 하단 버튼 -->
    <div class ="popup_bottom_btn">
        <button type="button" id="actionBtn" >등록</button>
        <button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
 </div>   
<script type="text/javascript">
var actionType = null;
var fileTrgtKey = null;
var coCd = null;
var salesPlanYy = null;
var salesPlanClntCd = null;
var salesPlanClntNm = null;
var salesPlanId = null;
var salesPlanNm = null;
var salesPlanDiv = null;

var sGridView1 = {
        initView: function(){
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $('[data-ax5grid="second-grid1"]'),
                header: {
                  align: "center",
                  selector: false
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex); 
                        if (actionType == "U") {
                        	sGridView2.setData(0);
                        }
                        fileTree();
                    },
                    onDBLClick: function () {
                        this.self.clearSelect();
                        this.self.select(this.dindex);
                    },
               },
               columns: [
            	   {key: "fileTrgtKey",      label: "FILE TRGT KEY",  hidden:true},
                   {key: "salesPlanYm",      label: "계획년월",      align: "center",   width: 70},
                   {key: "salesPlanAmt",      label: "계획금액",      align: "right",   width: 100, editor: {type: "money"}, formatter: "money"},
                   {key: "ordrsPlanTotAmt",      label: "수주목표금액",      align: "right",   width: 100, formatter: "money"},
                   {key: "ordrsTotAmt",      label: "수주금액",     align: "right",   width: 100, formatter: "money"}, 
                   {key: "epctTotAmt",      label: "예상물량금액",     align: "right",   width: 100, formatter: "money"},                   
                   {key: "salesPlanRmk",      label: "비고",      align: "left",   width: 200, editor: {type: "text"}},
                   {key: "user0",      label: "1월",     align: "right",   width: 100},
                   {key: "user1",      label: "2월",     align: "right",   width: 100},
                   {key: "user2",      label: "3월",     align: "right",   width: 100},
                   {key: "user3",      label: "4월",     align: "right",   width: 100},
                   {key: "user4",      label: "5월",     align: "right",   width: 100},
                   {key: "user5",      label: "6월",     align: "right",   width: 100}
                   
                     ],
                   footSum: [
                       [
                           {label: "총합계", align: "center"},
                           {key: "salesPlanAmt", collector: "sum", formatter: "money", align: "right"},
                           {key: "ordrsPlanTotAmt", collector: "sum", formatter: "money", align: "right"},
                           {key: "ordrsTotAmt", collector: "sum", formatter: "money", align: "right"},
                           {key: "epctTotAmt", collector: "sum", formatter: "money", align: "right"}
                       ]]
            });
            return this;
          },
          setData: function() {
              var targetObj = this.target; 
              if (actionType == "C") {
            	  var formData = {
                          "actionType" : actionType,
                          "coCd" : $('#coCd').val(),
                          "salesPlanYy" : $('#salesPlanYy').val(),
                          "salesPlanClntCd" : $('#salesPlanClntCd').val(),
                          "salesPlanId" : "",
                          "salesPlanDiv" : ""                      
                  }
            	  postAjax("/user/cr/cr16/selectSalesYearPlanMC", formData, null, function(data){            		                        
            		  var list = data.fileList;
            		  let tasks = [];
            		  
            		  
            		  var colCnt = 5;
            		  $.each(list, function(idx, elem){
            			  let task = {
            					  clntCd: elem.clntCd,
            					  salesPlanYm: elem.salesPlanYm,
            					  salesPlanAmt: elem.salesPlanAmt,
            					  epctTotAmt: elem.epctTotAmt,
            					  ordrsTotAmt: elem.ordrsTotAmt,
            					  salesPlanAmt: elem.salesPlanAmt,
            					  salesPlanYm: elem.salesPlanYm,          					  
                          }
            			  for (var i=0; i < colCnt; i++) {
            				  task["user"+i] = elem.clntCd;
            				  alert(task["user"+i]);
            				  //var colName = "month"+i;
            				  //task.colName = elem.clntCd;
            			  }
            			  tasks.push(task);
                      });
                      targetObj.setData({
                            list : tasks,
                            page : {
                                totalElements : list.length
                            }
                      });                       
                   }); 
              }
              else {
            	  var formData = {
                          "actionType" : actionType,
                          "coCd" : coCd,
                          "salesPlanYy" : salesPlanYy,
                          "salesPlanClntCd" : salesPlanClntCd,
                          "salesPlanId" : salesPlanId,
                          "salesPlanDiv" : salesPlanDiv                      
                  }
            	  postAjax("/user/cr/cr16/selectSalesYearPlanMU", formData, null, function(data){
                      var list = data.fileList;
                       targetObj.setData({
                            list : list,
                            page : {
                                totalElements : list.length
                            }
                        });
                       
                   }); 
              }
         } 
     }  
     
var sGridView2 = {
        initView: function(){
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                sortable: false,
                target: $('[data-ax5grid="second-grid2"]'),
                header: {
                  align: "center",
                  selector: false
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex); 
                    },
                    onDBLClick: function () {
                        this.self.clearSelect();
                        this.self.select(this.dindex);
                    },
               },
               columns: [
            	   {key: "salesPlanYm",      label: "계획년월",      align: "center",   width: 90},
                   {key: "clntPjt",      label: "프로젝트명",      align: "left",   width: 160, editor: {type: "text"}},
                   {key: "ctrtNm",      label: "주요내용",      align: "left",   width: 200, editor: {type: "text"}},
                   {key: "eqNm",      label: "예상장비",      align: "left",   width: 160, editor: {type: "text"}},
                   {key: "salesPlanDtlRmk",      label: "비고",      align: "left",   width: 230, editor: {type: "text"}}
                     ]
            });
            return this;
          },
          setData: function() {
        	  var targetObj = this.target;              
        	  var row = sGridView1.target.getList("selected")[0];
        	  if (row != undefined) {
        		  var formData = {
                          "actionType" : actionType,
                          "coCd" : $('#coCd').val(),
                          "salesPlanYm" : row.salesPlanYm,
                          "salesPlanClntCd" : $('#salesPlanClntCd').val(),
                          "salesPlanId" : $('#salesPlanId').val(),
                          "salesPlanDiv" : $('#salesPlanDiv').val()                     
                  }
                  postAjax("/user/cr/cr16/selectSalesYearPlanD", formData, null, function(data){
                      var list = data.fileList;
                       targetObj.setData({
                            list : list,
                            page : {
                                totalElements : list.length
                            }
                        });
                       
                 });     
        	  }    
         } 
     } 

$(document).ready(function() {
	actionType = modalStack.last().paramObj.actionType;
	coCd = modalStack.last().paramObj.coCd;
	salesPlanYy = modalStack.last().paramObj.salesPlanYy;
	salesPlanClntCd = modalStack.last().paramObj.salesPlanClntCd;
	salesPlanClntNm = modalStack.last().paramObj.salesPlanClntNm;
	salesPlanId = modalStack.last().paramObj.salesPlanId;
	salesPlanNm = modalStack.last().paramObj.salesPlanNm;
	salesPlanDiv = modalStack.last().paramObj.salesPlanDiv;
	
	setCommonSelect($("#wbsPopup select[data-kind]"));     // 공통코드 set
	$('#salesPlanYy').datepicker({
        format : "yyyy",
        language : "ko",
        autoclose : true,
        minViewMode : "years"
      })
     .datepicker("setDate", "today")    
    sGridView1.initView();
    sGridView2.initView();
   
   
    if (actionType == "C") {
    	$("#coCd").val(jwt.coCd);
        setByCoCd(jwt.coCd);
		var initialYear = new Date().getFullYear();
        $('#salesPlanYy').val(initialYear);
        $('#actionBtn').on("click", function() {
            insertSalesYearPlan();
        });
        if ($('#salesPlanClntCd').val() != "") {
        	sGridView1.setData(0);
        }
    }
    else {
    	$('.tit').text('WBS 실적 수정')
        $('#actionBtn').text("수정");
    	$('#actionBtn').on("click", function() {
            updateSalesYearPlan();
        });
    	$("#coCd").val(coCd);
        setByCoCd(coCd);
        $('#salesPlanYy').val(salesPlanYy);
        $("#salesPlanYy").prop('disabled',true); 
        $("#salesPlanClntCd").val(salesPlanClntCd);
        $("#salesPlanClntNm").val(salesPlanClntNm);
        $("#salesPlanClntNm").prop('disabled',true);        
        $("#salesPlanId").val(salesPlanId);         
        $("#salesPlanNm").val(salesPlanNm);
        $("#salesPlanNm").prop('disabled',true);
        $("#salesPlanDiv").val(salesPlanDiv);
        $('#salesPlanDiv option:not([value="'+salesPlanDiv+'"])').remove();
    }
    
   
   authChk();
   
   
})

function fileTree() {
	//---------------------------------------------------------------  
	   //첨부 화일 처리 시작 
	   //---------------------------------------------------------------
	   //debugger;
	   $("#fileList_area").empty();
	   fileParam = {
	           fileTrgtTyp : $("#popForm #pgmId").val(),
	           fileTrgtKey     :fileTrgtKey
	   }
	   treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
	   //---------------------------------------------------------------  
	   //첨부 화일 처리 끝
	   //---------------------------------------------------------------  
}

function openClntSearchP(openType) {
	if (actionType == "U") {
		alert("수정모드에서는 변경할 수 없습니다.");
		return;
	}
    var paramObj = {
            "searchValue" :  $("#salesPlanClntNm").val()
    }       
    openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
        var row = grid.target.getList("selected")[0];
        if(openType == "P" && actionType=="C"){
            $('#salesPlanClntCd').val(row.clntCd);
            $('#salesPlanClntNm').val(row.clntNm);
            sGridView1.setData(0);
        }
    });
}  

function openUserTreeP() {
	if (actionType == "U") {
        alert("수정모드에서는 변경할 수 없습니다.");
        return;
    }
    var paramObj = {
        "coCd" : $('#coCd').val(),
        "userId": $('#salesPlanNm').val(),
        "useYn": "Y"
    };
    openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "영업 담당자 검색", paramObj, function (tree){
        var checkedId = tree.get_checked()[0];
        var checkedNode = tree.get_node(checkedId);
        $('#salesPlanId').val(checkedNode.id);
        $('#salesPlanNm').val(checkedNode.text);
    });
}

function setByCoCd(value) {
    $('#coCd option:not([value="'+value+'"])').remove();
}


/* $('[data-grid-control]').click(function () {
    switch (this.getAttribute("data-grid-control")) {    
        case "row-add":
        	var row = sGridView1.target.getList("selected")[0];
        	if (row == undefined) {
        		alert("해당월을 선택하세요");
        		return;
        	}
        	sGridView2.target.addRow($.extend({}, "last", false));                             
            var row1 = sGridView2.target.getList().length - 1;
            sGridView2.target.setValue(row1, "salesPlanYm", row.salesPlanYm);
            
          break;
        case "row-remove":
        	sGridView2.target.deleteRow("selected");       
          break;
    }
}); */




</script>
