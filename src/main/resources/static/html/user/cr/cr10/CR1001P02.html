<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">물류진행요청 결재</h4>
    </div>
 <div class="popup_table" id="appViewArea">
 </div>
 <div class="form-group popup_table">
  <form id="popForm" onSubmit="return false;">
	<input type="hidden" id="userId" name="userId">
	<input type="hidden" id="pgmId" name="pgmId" value="CR1001M01">
  	<input type="hidden" id="coCd" name="coCd">
  	<input type="hidden" id="todoDiv1CodeId" name="todoDiv1CodeId">
  	<input type="hidden" id="todoDiv2CodeId" name="todoDiv2CodeId">
  	<input type="hidden" id="todoId" name="todoId">
 		<table>
        <colgroup>
          <col width="12%">
          <col width="13%">
          <col width="12%">
          <col width="13%">
          <col width="12%">
          <col width="13%">
          <col width="12%">
          <col width="13%">
        </colgroup>

        <tr>
			<th>회사</th>
			<td>
				<input type="text" id="coNm" name="coNm">
			</td>
			<th>수주번호</th>
			<td>
				<input type="text" id="ordrsNo" name="ordrsNo">
			</td>
			<th>고객사</th>
			<td>
				<input type="text" id="ordrsClntNm" name="ordrsClntNm">
			</td>
			<th>고객사PJT</th>
			<td>
				<input type="text" id="clntPjt" name="clntPjt">
			</td>
        </tr>

        <tr>
			<th>요청자</th>
			<td>
	             <input type="text" id="reqIdNm" name="reqIdNm">
			</td>
			<th>PART NO</th>
			<td>
				<input type="text" id="partNo" name="partNo">
			</td>
			<th>발행일자</th>
			<td>
				<input id="pblicteDt" name="pblicteDt" date>
			</td>
			<th>요구일정일자</th>
			<td>
				<input id="reqFxDt" name="reqFxDt" date>
			</td>
        </tr>

        <tr>
			<th>Sales Code</th>
			<td colspan="7" valign="top">
				<div style="width: 100%; height: 240px;margin-left:5px;" id="salescd-grid-height">
					<div class="add_btn pdl10" style="width: 100%;">
					</div>
	                <div data-ax5grid="salescd-grid" data-ax5grid-config="{}" style="height:230px; width: 99%;">
	                </div>
				</div>
			</td>
        </tr>

        <tr>
			<th>분류구분</th>
			<td colspan="7">
				<input type="text" id="clasDivNm" name="clasDivNm">
			</td>
        </tr>

        <tr>
			<th>운송구분</th>
			<td>
				<input type="text" id="trnsDivNm" name="trnsDivNm">
			</td>
			<th>운송지역</th>
			<td>
				<input type="text" id="trnsAreaDivNm" name="trnsAreaDivNm">
			</td>
			<th>발송조건</th>
			<td>
				<input type="text" id="sendCndDivNm" name="sendCndDivNm">
			</td>
			<th>포장종류</th>
			<td>
				<input type="text" id="packKindDivNm" name="packKindDivNm">
			</td>
        </tr>

        <tr>
			<th colspan="4" style="text-align:center;height:30px">출발지 정보</th>
			<th colspan="4" style="text-align:center;height:30px">도착지 정보</th>
        </tr>
        <tr>
			<th>업체명</th>
			<td colspan="3">
				<input type="text" id="staPlace" name="staPlace">
			</td>
			<th>업체명</th>
			<td colspan="3">
				<input type="text" id="arvlPlace" name="arvlPlace">
			</td>
        </tr>
        <tr>
			<th>담당자/연락처</th>
			<td colspan="3">
                 <input type="text" id="staChrgIdNm" name="staChrgIdNm" style="width:50px;float:left;">
	             <span style="width:30px;float:left;margin-top:3px;">/</span>
	             <input type="text" id="staChrgIdTelNo" name="staChrgIdTelNo" style="width:100px;float:left;" readonly="readonly">
			</td>
			<th>담당자/연락처</th>
			<td colspan="3">
	             <input type="text" id="arvlChrgCont" name="arvlChrgCont">
			</td>
        </tr>
        <tr>
			<th>주소</th>
			<td colspan="3">
				<textarea rows="2" id="staAddr" name="staAddr" class="form-control"></textarea>
			</td>
			<th>주소</th>
			<td colspan="3">
	             <textarea rows="2" id="arvlAddr" name="arvlAddr" class="form-control"></textarea>
			</td>
        </tr>
        <tr>
			<th>품목내용</th>
			<td colspan="7">
				<textarea rows="2" id="prdlstCont" name="prdlstCont" class="form-control"></textarea>
			</td>
        </tr>
        <tr>
			<th>제품금액</th>
			<td>
				<input money type="text" id="prdAmt" name="prdAmt">
			</td>
			<th>가로사이즈</th>
			<td>
				<input data-positive type="text" id="widthSize" name="widthSize" maxlength="10" msg="가로사이즈"
				 style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">mm</span>
			</td>
			<th>세로사이즈</th>
			<td>
				<input data-positive type="text" id="vrticlSize" name="vrticlSize" maxlength="10" msg="세로사이즈"
				 style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">mm</span>
			</td>
			<th>높이사이즈</th>
			<td>
				<input data-positive type="text" id="heightSize" name="heightSize" maxlength="10" msg="높이사이즈"
				 style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">mm</span>
			</td>
        </tr>
        <tr>
			<th>포장전무게</th>
			<td>
				<input data-positive type="text" id="frmlcBeforeWt" name="frmlcBeforeWt" msg="포장전무게"
				style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">kg</span>
			</td>
			<th>포장후무게</th>
			<td>
				<input data-positive type="text" id="frmlcAfterWt" name="frmlcAfterWt" msg="포장후무게"
				style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">kg</span>
			</td>
			<th>출하일정일</th>
			<td>
				<input id="shipmntDt" name="shipmntDt" msg="출하일정일" date>
			</td>
			<th>희망도착일</th>
			<td>
				<input id="hopeArvlDt" name="hopeArvlDt" msg="희망도착일" date>
			</td>
        </tr>

        <tr>
			<th>비고</th>
			<td colspan="7">
				<textarea rows="3" id="lgistRmk" name="lgistRmk" msg="비고" class="form-control"></textarea>
			</td>
        </tr>

      </table>

    </form>
	</div>

	<div style="height:50px" class="fileList_height">
	</div>
	<!-- 공통 파일 영역
	<div id="fileList_area"></div>
	 -->

</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>결재</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>
<script type="text/javascript">
	var fileTrgtKey = null;
	var realStepAppUserInfo = null;

	var salescdGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		        showLineNumber: true,
				showRowSelector : false,
				multipleSelect : false,
				sortable : false,
	            target: $('[data-ax5grid="salescd-grid"]'),
	            header : {
	                align : "center",
	                selector : true
	            },
		        body: {
		        	  //mergeCells : ["coCd","salesCd", "dsgnNo", "upperCd","lowerCd","ordrgDiv10"],
		              onClick: function () {
			          },
			          onDBLClick: function () {
			          },
			          onDataChanged: function () {
			          },
		        },
		        columns : [
						{key: "salesCd", 			label: "Sales Code", 	width: 110,		align: "center"},
						{key: "prdtCd", 			label: "제품구분", 		width: 90,		align: "center"},
						{key: "ordrsDtlDiv20Nm", 	label: "신작구분", 		width: 90,		align: "center"},
						{key: "ordrsDtlDiv30Nm", 	label: "자체구분", 		width: 90,		align: "center"},
						{key: "dudtIntendDt", 		label: "납기예정일", 		width: 100,		align: "center"},
						{key: "prdtCdNm", 			label: "제품명", 			width: 180,		align: "left"},
						{key: "itemDivNm", 			label: "아이템구분", 		width: 150,		align: "left"},
						{key: "eqpNm", 				label: "설비명", 			width: 240,		align: "left"},
		         	]
		    });
			return this;
		},

		setData: function(_page){
			var target = this.target;
			var formData = {
				"fileTrgtKey" : fileTrgtKey,
			};
    		postAjax("/user/cr/cr10/selectSelesCdViewList", formData, null, function(data) {
				var list = data.resultList;
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			});

				if(list.length > 0) {
					var gridHeight = 66+(list.length * 26);
					salescdGridView.target.setHeight(gridHeight);
					//width: 100%; height: 240px;margin-left:5px;
					var _height = (gridHeight+20)+"px";
					$("#salescd-grid-height").css({"width":"100%", "height": _height, "margin-left": "5px"});
				}
				else {
					salescdGridView.target.setHeight(100);
					$("#salescd-grid-height").css({"width":"100%", "height": 120, "margin-left": "5px"});
				}
    	 	});
		}
	}

	$(document).ready(function() {
		//setCommonSelect($(".popup_area select[data-kind]"));
		$("#popForm #userId").val(jwt.userId);

		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		/**
		 * grid 초기화
		*/
		salescdGridView.initView().setData(0);
		selectLgistMastInfo();
		$('#actionBtn').on("click", function() {
			updateTodoAppConfirm();
		});
	});

	function selectLgistMastInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		postAjax("/user/cr/cr10/selectLgistMastInfo", formData, null, function(data) {
			loadFormData("#popForm", data.result, function(data){
				setDisabledInput("#popForm" , true);
			});
			//현재 스텝의 결재자 정보를 realStepAppUserInfo 에 할당한다.
			realStepAppUserInfo = getRealStepAppUserInfo(data.resultAppList);
			if(data.resultAppList){
				createHtmlAppView(data.resultAppList);
			}
		});
	}

	function createHtmlAppView(appDataList){
		var isAppView = false;
		try {
			isAppView = approvalAppInfoView;
		} catch (e){
		}
		if(isAppView==false) return;
		if(appDataList.length == 0) return;
		var cHtml = '';
		cHtml += ' 	<table style="width:500px;margin-bottom:10px;float:right;">\n';
		cHtml += '		<tr>\n';
		cHtml += '			<th rowspan="2" style="width:50px;margin-left:0px">결재</th>\n';
		$.each(appDataList, function (idx, elem) {
			cHtml += '			<th style="text-align:center;margin-left:0px;">'+elem.levelNm+'</th>\n';
		});
		cHtml += '		</tr>\n';
		cHtml += '		<tr>\n';
		$.each(appDataList, function (idx, elem) {
			var span_text =  '<span style="font-size:10px;color:gray;">(대기)</span>';
			if(elem.todoCfYn=="Y") {
				span_text =  '<span style="font-size:10px;color:blue;">(결재)</span>';
			}
			cHtml += '			<td>'+elem.todoIdNm+''+span_text+'</td>\n';
		});
		cHtml += '		</tr>\n';
		cHtml += ' 	</table>\n';

		$("#appViewArea")[0].innerHTML = cHtml;
	}

	function setDisabledInput(_form , _status){
		$.each($(_form+" input"), function (idx, elem) {
			$(elem).prop("readonly", _status);
		});
		$.each($(_form+" textarea"), function (idx, elem) {
			$(elem).prop("readonly", _status);
			$(elem).addClass("form-control");
		});
		$.each($(_form+" select"), function (idx, elem) {
			$(elem).prop("readonly", _status);
			$(elem).prop("disabled", _status);
		});
	}

	// 결재 확정 처리
	function updateTodoAppConfirm() {
		if(realStepAppUserInfo == null){
			alert("잘못된 결재 내역입니다.");
			return;
		}
		var isIgnore = false;
		try {
			isIgnore = approvalAuthorityIgnore;
		} catch (e){
		}

		var realStepAppUserId = realStepAppUserInfo.todoId;
		if(realStepAppUserId != jwt.userId && isIgnore == false){
			alert("결재 권한을 가진 사용자가 아닙니다. 결재 [순번:"+realStepAppUserInfo.appSeq+" 결재자:"+realStepAppUserInfo.todoIdNm+"]");
			return;
		}

		if(isIgnore == true && !isEmpty(realStepAppUserId)) {
			$("#popForm #userId").val(realStepAppUserId);
			$("#popForm #todoId").val(realStepAppUserId);
		}

		var formData = makeFormData();
		//var _formData = getSearchParam("#popForm");

		filePostAjax("/user/cr/cr10/updateTodoAppConfirm", formData,function(data) {
			if (data.resultCode == 200) {
				alert("결재처리 되었습니다.");
				try {
					gridView.setData(0);
				} catch (err){
				}
				modalStack.close();
			}
			else {
				alert(data.resultMessage);
			}
		});
	}

	//----------------------------------------------//

	function makeFormData() {
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		return formData;
	}
</script>