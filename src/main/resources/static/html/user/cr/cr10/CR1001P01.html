<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">물류진행요청 등록</h4>
    </div>

 <div class="form-group popup_table">
  <form id="popForm" onSubmit="return false;">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="CR1001M01">
		<input type="hidden" id="deptId"     	name="deptId">
 		<table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>

        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" required msg="회사">
				</select>
			</td>
			<th class="hit">수주번호</th>
			<td>
				<input type="text" id="ordrsNo" name="ordrsNo" class="form-control" msg="수주번호" readonly="readonly" required>
			</td>
			<th class="hit">고객사</th>
			<td>
				<input type="text" id="clntNm" name="clntNm" msg="고객사" readonly="readonly" required>
			</td>
			<th class="hit">고객사PJT</th>
			<td>
				<input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT" readonly="readonly" required> 
			</td>
        </tr>

        <tr>
			<th class="hit">요청자</th>
			<td>
	             <input type="hidden" id="reqId" name="reqId" msg="요청자">
	             <div class="search_form">
	                 <input type="text" id="reqIdNm" name="reqIdNm" class="form-control" required msg="작성자">
	                 <a onclick="openUserTree();">
	                <i class="i_search_w"></i>
	              </a></div>
			</td>
			<th>PART NO</th>
			<td>
				<input type="text" id="partNo" name="partNo" msg="PART NO">
			</td>
			<th class="hit">발행일자</th>
			<td>
				<input id="pblicteDt" name="pblicteDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  required msg="발행일자" date>
			</td>
			<th class="hit">요구일정일자</th>
			<td>
				<input id="reqFxDt" name="reqFxDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  required msg="요구일정일자" date>
			</td>
        </tr>

        <tr>
			<th class="hit">Sales Code 목록</th>
			<td colspan="7" style="height:130px">
			</td>
        </tr>

        <tr>
			<th class="hit">운송구분</th>
			<td>
				<select id="trnsDiv" name="trnsDiv" data-kind="LGISTDIV03" onchange="" msg="운송구분" required>
				   <option value="">선택</option>
				</select>
			</td>
			<th class="hit">분류구분</th>
			<td>
				<select id="clasDiv" name="clasDiv" data-kind="LGISTDIV01" onchange="" msg="운송구분" required>
				   <option value="">선택</option>
				</select>
			</td>
 			<th></th>
			<th></th>
			<th></th>
			<th></th>
        </tr>

        <tr>
			<th>국내운송지역</th>
			<td>
				<select id="dmsTrnsAreaDiv" name="dmsTrnsAreaDiv" data-kind="LGISTDIV0201" onchange="" msg="국내운송지역" required>
				   <option value="">선택</option>
				</select>
			</td>
			<th>국내발송조건</th>
			<td colspan="3">
				<select style="width:35%" id="dmsSendCndDiv" name="dmsSendCndDiv" data-kind="LGISTDIV0202" onchange="" msg="국내발송조건" required>
				   <option value="">선택</option>
				</select>
				<input style="width:64%" type="text" id="dmsSendCndDivEtc" name="dmsSendCndDivEtc" msg="기타">
			</td>
			<th>국내포장종류</th>
			<td>
				<select id="dmsPackKindDiv" name="dmsPackKindDiv" data-kind="LGISTDIV0203" onchange="" msg="국내포장종류" required>
				   <option value="">선택</option>
				</select>
			</td>
        </tr>

        <tr>
			<th>해외운송지역</th>
			<td>
				<select id="ovsTrnsAreaDiv" name="ovsTrnsAreaDiv" data-kind="LGISTDIV0204" onchange="" msg="해외운송지역" required>
				   <option value="">선택</option>
				</select>
			</td>
			<th>해외발송조건</th>
			<td colspan="3">
				<select style="width:35%" id="ovsSendCndDiv" name="ovsSendCndDiv" data-kind="LGISTDIV0205" onchange="" msg="해외발송조건" required>
				   <option value="">선택</option>
				</select>
				<input style="width:64%" type="text" id="ovsSendCndDivEtc" name="ovsSendCndDivEtc" msg="PART NO">
			</td>
			<th>해외포장종류</th>
			<td>
				<select id="ovsPackKindDiv" name="ovsPackKindDiv" data-kind="LGISTDIV0206" onchange="" msg="해외포장종류" required>
				   <option value="">선택</option>
				</select>
			</td>
        </tr>

        <tr>
			<th colspan="4" style="text-align:center;height:30px">출발지 정보</th>
			<th colspan="4" style="text-align:center;height:30px">도착지 정보</th>
        </tr>
        <tr>
			<th>출발 장소/업체명</th>
			<td colspan="3">
				<input type="text" id="staPlace" name="staPlace" msg="출발 장소/업체명">
			</td>
			<th>도착 장소/업체명</th>
			<td colspan="3">
				<input type="text" id="arvlPlace" name="arvlPlace" msg="도착 장소/업체명">
			</td>
        </tr>
        <tr>
			<th>출발 담당자</th>
			<td colspan="3">
	             <input type="hidden" id="staChrgId" name="staChrgId" msg="출발 담당자">
	             <div class="search_form">
	                 <input type="text" id="staChrgIdNm" name="staChrgIdNm" class="form-control" required msg="출발 담당자">
	                 <a onclick="openUserTree();">
	                <i class="i_search_w"></i>
	              </a></div>
			</td>
			<th>도착 담당자</th>
			<td colspan="3">
	             <input type="text" id="arvlChrgCont" name="arvlChrgCont" msg="도착 담당자">
			</td>
        </tr>
        <tr>
			<th>출발주소</th>
			<td colspan="3">
				<textarea rows="2" id="staAddr" name="staAddr" class="form-control"  msg="출발주소"></textarea>
			</td>
			<th>도착주소</th>
			<td colspan="3">
	             <textarea rows="2" id="arvlAddr" name="arvlAddr" class="form-control"  msg="도착주소"></textarea>
			</td>
        </tr>
        <tr>
			<th>품목내용</th>
			<td colspan="7">
				<textarea rows="2" id="prdlstCont" name="prdlstCont" class="form-control"  msg="비고"></textarea>
			</td>
        </tr>
        <tr>
			<th>제품금액</th>
			<td>
				<input type="text" id="prdAmt" name="prdAmt" style="text-align:right" maxlength="12" required="required" class="form-control" msg="제품금액"
            	comma oninput="this.value=this.value.replace(/[^0-9]/g,'')" onblur="this.value=this.value.replace(/\B(?=(\d{3})+(?!\d))/g, ',')" onfocus="this.value=this.value.replace(/[^0-9]/g,'')">
            	<!-- onkeyup="onlyDecimal(this);" -->
			</td>
			<th>가로사이즈</th>
			<td>
				<input type="text" id="widthSize" name="widthSize" style="text-align:right" maxlength="10" required="required" class="form-control" msg="가로사이즈"
            	oninput="this.value=this.value.replace(/[^0-9]/g,'')">
			</td>
			<th>세로사이즈</th>
			<td>
				<input type="text" id="vrticlSize" name="vrticlSize" style="text-align:right" maxlength="10" required="required" class="form-control" msg="세로사이즈"
            	oninput="this.value=this.value.replace(/[^0-9]/g,'')">
			</td>
			<th>높이사이즈</th>
			<td>
				<input type="text" id="heightSize" name="heightSize" style="text-align:right" maxlength="10" required="required" class="form-control" msg="높이사이즈"
            	oninput="this.value=this.value.replace(/[^0-9]/g,'')">
			</td>
        </tr>
        <tr>
			<th>포장전무게</th>
			<td>
				<input type="text" id="prdAmt" name="prdAmt"  style="text-align:right" maxlength="10" required="required" class="form-control" msg="포장전무게"
            	oninput="this.value=this.value.replace(/[^0-9]/g,'')">
			</td>
			<th>포장후무게</th>
			<td>
				<input type="text" id="widthSize" name="widthSize"  style="text-align:right" maxlength="10" required="required" class="form-control" msg="포장후무게"
            	oninput="this.value=this.value.replace(/[^0-9]/g,'')">
			</td>
			<th>출하일정일</th>
			<td>
				<input id="reqFxDt" name="shipmntDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  required msg="출하일정일" date>
			</td>
			<th>높이사이즈</th>
			<td>
				<input id="reqFxDt" name="hopeArvlDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  required msg="출하일정일" date>
			</td>
        </tr>

        <tr>
			<th>비고</th>
			<td colspan="7">
				<textarea rows="3" id="lgistRmk" name="lgistRmk" class="form-control"  msg="비고"></textarea>
			</td>
        </tr>

      </table>

    </form>
	</div>


	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>

</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
//     debugger;
	var actionType = null;
	var fileTrgtKey = null;

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(jwt.userId);
		//$("#popForm #reqId").val(jwt.userId);
		//$("#popForm #reqIdNm").val(jwt.userNm);
		//$("#popForm #deptId").val(jwt.deptId);
				
		//작성일자//
		$('#pblicteDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		
		authChk();						// 권한체크

		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		
		//$("#clntNm").prop("readonly", true);
	    //$("#clntPjt").prop("readonly", true);
	    //$("#prdtCdNm").prop("readonly", true);
	    //$("#itemDivNm").prop("readonly", true);
	    //$("#eqpNm").prop("readonly", true);
	    //$("#matrNm").prop("readonly", true);

	    $('#currCd').on('change', exrateCal);
		
		if (actionType == "C") {
		    //$("#coCd").prop("readonly", true);
		    //$("#workRptNo").prop("disabled", true);
		    
		    //신규일때 임시 작업일련번호 DW230523-0001
			//$('#workRptNo').val("DW"+new Date().format('yyyyMMdd')+"-****");
		    
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertDailyWork();
			});

		} else if (actionType == "U") {
		    //$("#coCd").prop("disabled", true);
		    //$("#workRptNo").prop("disabled", true);
			//$("#reqIdNm").prop("disabled", true);
		    //$("#pblicteDt").prop("disabled", true);
		    
			$('.tit').text('물류진행요청 수정')
			
			selectDailyWorkInfo();

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateDailyWork();
			});
		}
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		
	});
	
	
	//통화단위 변경
	function exrateCal() {
		var currCd = $('#currCd').val();
		var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
		$('#exrate').val(exrateVal ? exrateVal : '');

	}		
	

	//Sales Code 필수 변경
	function selectSalesCodeSet() {
		if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
			$('#popForm .Sales_Code').addClass('hit');
			$('#popForm input#salesCd').attr('required', 'required');			
		} else {
			$('#popForm .Sales_Code').removeClass('hit');
			$('#popForm input#salesCd').removeAttr('required');
		}
	}		
	
	function selectDailyWorkInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		postAjax("/user/pm/pm01/selectDailyWorkInfo", formData, null, function(data) {
				$.each(data.result, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});				
		});
	}



	 // 등록
	function insertDailyWork() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/user/pm/pm01/insertDailyWork", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);
							modalStack.close();									// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateDailyWork() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성\
			for (let key of formData.keys()) {
				//console.log(key, ":", formData.get(key));
			}
	      	filePostAjax("/user/pm/pm01/updateDailyWork", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		//---------------------------------------------------------------  
		//  disabled 처리시 값 전송안됨 아래에서 폼데이터 추가
		//---------------------------------------------------------------
		formData.append("coCd", $('#coCd').val());
		//formData.append("workRptNo", $('#workRptNo').val());
		//formData.append("reqIdNm", $('#reqIdNm').val());
		//formData.append("pblicteDt", $('#pblicteDt').val());
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#vendCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}
	
	
	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
// 					$('#mngId').val(row.salesEmpId);
// 					$('#mngNm').val(row.salesEmpNm);

// 					var paramObj = {
// 						"coCd" : $('#coCd').val(),
// 						"clntCd" : row.clntCd
// 					}
// 					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
// 	function setMngInfo(paramObj) {
// 		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
// 				function(data) {
// 					if (data.mngInfo) {
// 						$('#mngId').val(data.mngInfo.salesEmpId);
// 						$('#mngNm').val(data.mngInfo.salesEmpNm);
// 					} else {
// 						$('#mngId').val("");
// 						$('#mngNm').val("");
// 					}
// 				});
// 	}

	//작성자 검색 //
	function openUserTree(gbn) {
		if($('#reqIdNm').prop("disabled")) return false;
		
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#reqId').val(checkedNode.id);
			$('#reqIdNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	function setWorkRptHour(_value) {
		var value = _value.replace(/[^0-9]/g,'');
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return "";
		}
		return value;
	}
	
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

</script>