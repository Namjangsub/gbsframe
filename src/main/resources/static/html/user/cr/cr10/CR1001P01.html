<script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
<style>
/* 테이블 */
.tripTable{
  width:100%;
  table-layout:fixed;
  border-collapse:collapse;
  font-size:12px;
}
.tripTable th, .tripTable td{
  border:1px solid #d7d7d7;
  padding:6px;
  vertical-align:middle;
}
.tripTable thead tr th{
  font-size:12px;
  font-weight:600;
  background:#e9e9e9;
  border-color:#cfcfcf;
  text-align:center;
  vertical-align: middle;
}
.tripTable .form-control{
  width:100%;
  box-sizing:border-box;
  font-size:12px;
  height:26px;
  padding:2px 6px;
}

/* 사진 셀 */
.tripTable td.photoCell{ padding:4px; }

/* 파일 input 숨김: 화면에 “파일 선택”이 보이면 이게 적용 안 된 것 */
.file-input{ display:none; }

/* 사진대지(틀) */
.tripTable .profile-box{
  width:150px;
  height:100px;
  border:2px dashed #bbb;
  box-sizing:border-box;
  background:#f9f9f9;
  position:relative;
  overflow:hidden;
  cursor:pointer;
}
.tripTable .profile-box.dragover{ background:#e0e0e0; }

/* 안내문구 */
.tripTable .profile-box > span{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#666;
  user-select:none;
}

/* 미리보기 이미지: 틀에 맞춰 꽉 */
.tripTable .profilePreview{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:none;              /* JS에서 show() */
  object-fit: contain;       /* 늘이거나 줄여서 “틀 안에 맞추기” */
  /* object-fit: cover; */   /* 박스를 꽉 채우기(일부 잘림 허용) */
}
.file-input { display:none; }
.file-name-row { margin-top:2px; font-size:10px; }
.file-name { color:#333; }

.drop-area:focus{
  outline: 2px solid #4d90fe;
  outline-offset: 2px;
}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">물류진행요청 등록</h4>
    </div>

 <div class="form-group popup_table">
  <form id="popForm" onSubmit="return false;">
		<input type="hidden" id="userId" name="userId">
		<input type="hidden" id="pgmId" name="pgmId" value="CR1001P01">
		<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
		<input type="hidden" id="ordrsClntCd" name="ordrsClntCd">
	  	<input type="hidden" id="todoDiv1CodeId" name="todoDiv1CodeId">
	  	<input type="hidden" id="todoDiv2CodeId" name="todoDiv2CodeId">
	  	<input type="hidden" id="telNo"   name="telNo">
		<input type="hidden" id="coCd_hidden" 	name="coCd">
 		<table>

        <colgroup>
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
          <col width="11%">
          <col width="14%">
        </colgroup>

        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCd" data-kind="CO" required msg="회사" class="form-control" readonly="readonly" required>
				</select>
			</td>
			<th class="hit">수주번호</th>
			<td>
				<input type="text" id="ordrsNo" name="ordrsNo" msg="수주번호" class="form-control" readonly="readonly" required>
			</td>
			<th>PART NO</th>
			<td>
				<input data-positive comma type="text" id="partNo" name="partNo" msg="PART NO">
			</td>
			<th>물류번호</th>
			<td>
				<input type="text" id="lgistNo" name="lgistNo" msg="물류번호" class="form-control" readonly="readonly">
			</td>
        </tr>

        <tr>
			<th class="hit">요청자</th>
			<td>
	             <input type="hidden" id="reqId" name="reqId" msg="요청자">
	             <div class="search_form">
	                 <input type="text" id="reqIdNm" name="reqIdNm" msg="요청자" class="form-control" required>
	                 <a onclick="openUserTree('reqId');">
	                 <i class="i_search_w"></i></a>
	              </div>
			</td>
			<th class="hit">고객사</th>
			<td>
				<input type="text" id="ordrsClntNm" name="ordrsClntNm" msg="고객사" class="form-control" readonly="readonly" required>
			</td>
			<th class="hit">발행일자</th>
			<td>
				<input id="pblicteDt" name="pblicteDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="발행일자" date="today" onchange="monthCloseChk(this.value);">
			</td>
        </tr>
        <tr>
			<th class="hit">분류구분</th>
			<td>
				<select id="clasDiv" name="clasDiv" onchange="salescdGridView.setData(0);" data-kind="LGISTDIV01" msg="분류구분" class="form-control" required>
				   <option value="">선택</option>
				</select>
			</td>
			<th class="hit">고객사PJT</th>
			<td>
				<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" msg="고객사PJT" class="form-control" readonly="readonly" required></select>
				<!-- <input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT" class="form-control" readonly="readonly" required> -->
			</td>
			<th class="hit">요구일정일자</th>
			<td>
				<input id="reqFxDt" name="reqFxDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="요구일정일자" date="today">
			</td>
 			<td colspan="2">
 				<div style="float:left;margin-top:5px;">
 				</div>
				<div class="add_btn pdl10" style="float:right">
<!-- 				    <a onclick="initSalesCode();" style="width: 60px;">초기화</a> -->
				</div>
 			</td>
        </tr>

        <tr>
			<th>Sales Code 선택</th>
			<td colspan="7" valign="top">
				<div style="margin-left:1px;margin-top:1px;">
	                <div data-ax5grid="salescd-grid" data-ax5grid-config="{}" style="height:290px; width: 100%;">
	                </div>
				</div>
			</td>
        </tr>

        <tr>
			<th class="hit">국내/해외 구분</th>
			<td>
				<select id="trnsDiv" name="trnsDiv" data-kind="LGISTDIV03" onchange="changeTrnsDiv(this.value)" msg="운송구분" class="form-control" required>
				   <option value="">선택</option>
				</select>
			</td>
 			<th colspan="6"></th>
        </tr>

        <tr id="dmsTran">
			<th class="dmsClass">국내운송구분</th>
			<td>
				<select id="dmsTrnsAreaDiv" name="dmsTrnsAreaDiv" data-kind="LGISTDIV0201" msg="국내운송지역" class="form-control">
				   <option value="">선택</option>
				</select>
			</td>
			<th class="dmsClass">국내발송조건</th>
			<td>
				<select id="dmsSendCndDiv" name="dmsSendCndDiv" data-kind="LGISTDIV0202" onchange="changeSetEtc(this.value,this.name)" msg="국내발송조건">
				   <option value="">선택</option>
				</select>
			</td>
			<td colspan="2">
				<input data-maxlength="300" type="text" id="dmsSendCndDivEtc" name="dmsSendCndDivEtc" msg="국내발송조건 -기타" readonly="readonly">
			</td>
        </tr>

        <tr id="ovsTran">
			<th class="ovsClass">해외운송구분</th>
			<td>
				<select id="ovsTrnsAreaDiv" name="ovsTrnsAreaDiv" data-kind="LGISTDIV0204" msg="해외운송지역" class="form-control">
				   <option value="">선택</option>
				</select>
			</td>
			<th class="ovsClass">해외발송조건</th>
			<td>
				<select id="ovsSendCndDiv" name="ovsSendCndDiv" data-kind="LGISTDIV0205" onchange="changeSetEtc(this.value,this.name)" msg="해외발송조건">
				   <option value="">선택</option>
				</select>
			</td>
			<td colspan="2">
				<input data-maxlength="300" type="text" id="ovsSendCndDivEtc" name="ovsSendCndDivEtc" msg="해외발송조건 -기타" readonly="readonly">
			</td>
			<th class="ovsClass">해외포장종류</th>
			<td>
				<select id="ovsPackKindDiv" name="ovsPackKindDiv" data-kind="LGISTDIV0206" msg="해외포장종류" class="form-control">
				   <option value="">선택</option>
				</select>
			</td>
        </tr>

        <tr>
			<th colspan="3" style="text-align:center;height:30px">출발지 정보</th>
			<th>
				<div class="add_btn pdl10" style="float:right">
				    <a onclick="swichInfo();" style="width: 60px;">스위치</a>
				</div>
			</th>
			<th colspan="4" style="text-align:center;height:30px">도착지 정보</th>
        </tr>
        <tr>
			<th>업체명</th>
			<td colspan="3">
				<input data-maxlength="300" type="text" id="staPlace" name="staPlace" msg="업체명" class="form-control">
			</td>
			<th>업체명</th>
			<td colspan="3">
				<input data-maxlength="300" type="text" id="arvlPlace" name="arvlPlace" msg="업체명" class="form-control">
			</td>
        </tr>
        <tr>
			<th>담당자/연락처</th>
			<td colspan="3">
				  <input data-maxlength="300" type="text" id="staChrgCont" name="staChrgCont" msg="담당자/연락처" class="form-control">
			</td>

			<th>담당자/연락처</th>
			<td colspan="3">
	             <input data-maxlength="300" type="text" id="arvlChrgCont" name="arvlChrgCont" msg="담당자/연락처" class="form-control">
			</td>
        </tr>
        <tr>
			<th>주소</th>
			<td colspan="3">
				<textarea data-maxlength="300" rows="2" id="staAddr" name="staAddr" class="form-control" msg="주소"></textarea>
			</td>
			<th>주소</th>
			<td colspan="3">
	             <textarea data-maxlength="300" rows="2" id="arvlAddr" name="arvlAddr" class="form-control"  msg="주소"></textarea>
			</td>
        </tr>
        <tr>
			<th>품목내용</th>
			<td colspan="7">
				<textarea data-maxlength="300" rows="2" id="prdlstCont" name="prdlstCont" class="form-control"  msg="비고"></textarea>
			</td>
        </tr>
        <tr>
			<th>제품금액</th>
			<td>
				<input data-money type="text" id="prdAmt" name="prdAmt" maxlength="16" class="form-control" msg="제품금액">
			</td>
			<th>가로사이즈</th>
			<td>
				<input data-positive comma type="text" id="widthSize" name="widthSize" maxlength="10" class="form-control" msg="가로사이즈"
				 style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">mm</span>
			</td>
			<th>세로사이즈</th>
			<td>
				<input data-positive comma type="text" id="vrticlSize" name="vrticlSize" maxlength="10" class="form-control" msg="세로사이즈"
				 style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">mm</span>
			</td>
			<th>높이사이즈</th>
			<td>
				<input data-positive comma type="text" id="heightSize" name="heightSize" maxlength="10" class="form-control" msg="높이사이즈"
				 style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">mm</span>
			</td>
        </tr>
        <tr>
			<th>포장전무게</th>
			<td>
				<input data-positive comma type="text" id="frmlcBeforeWt" name="frmlcBeforeWt" maxlength="10" class="form-control" msg="포장전무게"
				style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">kg</span>
			</td>
			<th>포장후무게</th>
			<td>
				<input data-positive comma type="text" id="frmlcAfterWt" name="frmlcAfterWt" maxlength="10" class="form-control" msg="포장후무게"
				style="float:left;width:80%;"><span style="float:right;width:20%;margin-top:3px;">kg</span>
			</td>
			<th>출하계획일</th>
			<td>
				<!-- <input id="shipmntDt" name="shipmntDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" msg="출하계획일" date> -->
				<input type="text" class="input_calendar" id="shipmntDt" name="shipmntDt" autocomplete="off" date>
			</td>
			<th>희망도착일</th>
			<td>
				<!-- <input id="hopeArvlDt" name="hopeArvlDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" msg="희망도착일" date> -->
				<input type="text" class="input_calendar" id="hopeArvlDt" name="hopeArvlDt" autocomplete="off" date>
			</td>
        </tr>

        <tr>
			<th>비고</th>
			<td colspan="7">
				<textarea data-maxlength="500" rows="3" id="lgistRmk" name="lgistRmk" class="form-control"  msg="비고"></textarea>
			</td>
        </tr>

      </table>

	<table style="border: 0px;">
		<tr style="height: 30px;">
			<td style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold;">※ 공유 및 결재</td>
			<td>
				<div class="add_btn_small pdl10">
					<a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;">+</a>
				    <a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;">-</a>
				</div>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<div>
					<div class="ax5_grid" data-ax5grid="first-grid-modal"
						data-ax5grid-config="{}" style="height: 150px; width: 100%;"></div>
				</div>
			</td>
		</tr>
	</table>
</form>
	</div>

      
		<div style="background-color:#304a8a; height:40px; color:#fff; display:flex; align-items:center; padding:0 10px; white-space:nowrap;">
			<span style="font-size:17px; font-weight: bold; flex:1; text-align:center;">출하 설비 LIST 관리</span>
			<button type="button" id="listSaveButton" class="btn btn-success btn-sm" style="height:28px; padding-top:0; padding-bottom:0; margin-left:auto;" onclick="updateLgistlistImage();">LIST저장</button> 
			<button type="button" id="addDayileRptTrpButton" class="btn btn-success btn-sm" style="height:28px; padding-top:0; padding-bottom:0; margin-left:4px;">LIST추가</button>
		</div>
		
		<textarea id="bulkPasteBox" rows="3" placeholder="여기에 여러 줄을 붙여넣으면(CTRL+V) 행이 자동 추가됩니다." 
		   					style="width:100%; border:1px dashed #aaa; padding:8px; font-size:12px; resize:vertical;"></textarea>
		<table id="tripTable" class="tripTable" style="margin-top:10px; width:100%;">
			<colgroup>
			  <col style="width: 3%;">    <!-- Item No -->
			  <col style="width: 15%;">   <!-- 제작 Item Code -->
			  <col style="width: 25%;">   <!-- 제작 Item 명 -->
			  <col style="width: 7%;">   <!-- 구분 -->
			  <col style="width: 5%;">    <!-- 수량 -->
			  <col style="width: 10%;">   <!-- 사진대지(1) -->
			  <col style="width: 15%;">   <!-- 삭제 -->
			  <col style="width: 5%;">   <!-- 삭제 -->
			</colgroup>
			
			<thead>
			  <tr>
			    <th>No</th>
			    <th>출고NO</th>
			    <th>설비명</th>
			    <th>단위</th>
			    <th>수량</th>
			    <th>사진대지</th>
			    <th>파일명</th>
			    <th>삭제</th>
			  </tr>
			</thead>
			
			<tbody>
<!-- 			자동생성 처리영역 -->
			</tbody>
		</table>
	  
	  
	<div style="height:15px" class="fileList_height">
	</div>
	<!-- 공통 파일 영역 -->
	<div id="fileList_area" style="margin-bottom: 50px;"></div>

</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<!-- <button type="button" id="fileUpBtn" form="popForm" onclick="fileUpload($(this.form));" authChk>첨부파일저장</button> -->
		<button type="button" id="fileUpBtn" onclick="$('#coCd_hidden').val($('#coCd').val()); fileUpload($('#popForm'));" authChk>첨부파일저장</button>
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	var lgistNo = null;
	var tLgistNo = null;

	var appStatus = "APP0";// 결재상태
	var grid_onDataChanged = true;
	
	// key: workRptNoSeq(또는 data-idx), value: { file: File, meta: {...} }
	window.tripImageStore = window.tripImageStore || new Map();
	// 신규 행에만 쓰는 증가 seq (중복 방지)
	let nextTripSeq = 0;

	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];

	//formatter 공통 함수
	function valueFormatter() {
		return (this.value) ? '<span style="display: block; white-space: pre;">' + this.value + '</span>' : '';
	}

	var salescdGridView = {
			initView: function(){
				this.target = new ax5.ui.grid();
				this.target.setConfig({
			        showLineNumber: false,
					showRowSelector : true,
					multipleSelect : true,
					sortable : false,
		            target: $('[data-ax5grid="salescd-grid"]'),
		            header : {
		                align : "center",
		                selector : true
		            },
			        body: {
			        	  //mergeCells : ["coCd","salesCd", "dsgnNo", "upperCd","lowerCd","ordrgDiv10"],
			              onClick: function () {
			            	  if(appStatus == "APP0"){
	  			              	this.self.select(this.dindex);
	  			              	//useYn: 현재물류의 선택유무  , oldUseYn: 데이타사용유무
	  			              	grid_onDataChanged = false;
	  			              	if(this.item.chkYn == "Y" || this.item.oldUseYn == "N") {
		  			              	if(this.item.useYn == "N") {
		  			              		salescdGridView.target.setValue(this.dindex, "useYn", "Y");
		  			              	}
		  			              	else if(this.item.anoUseYn == "N") {
		  			              		salescdGridView.target.setValue(this.dindex, "useYn", "N");
		  			              	}
	  			              	}
	  			              	grid_onDataChanged = true;
			            	  }
				          },
				          onDBLClick: function () {
				          },
				          onDataChanged: function () {
				        	  if(grid_onDataChanged == false) return;
			            	  if(appStatus == "APP0"){
				        	  	  grid_onDataChanged = false;
			            		  if(this.item.chkYn == "Y" || this.item.oldUseYn == "N") {
			  			              	if(this.item.useYn == "N") {
			  			              		salescdGridView.target.setValue(this.dindex, "useYn", "Y");
			  			              	}
			  			              	else if(this.item.anoUseYn == "N") {
			  			              		salescdGridView.target.setValue(this.dindex, "useYn", "N");
			  			              	}
			            		  }
				        	  	  grid_onDataChanged = true;
				              }
				          },
			        },
			        columns : [
							{key: "dtaChk",				label: " ", 			width: 30, 	styleClass: "grid-font-blue-bold" ,hidden:true},
				 	 	 	{key: "coCd", 				label: "CO", 			width: 50,	align: "center",hidden:true},
				 	 	 	{key: "ordrsNo", 			label: "ORDRS_NO", 		width: 50,	align: "center",hidden:true},
				 	 	 	{key: "ordrsSeq", 			label: "ORDRS_SEQ", 	width: 50,	align: "center",hidden:true},
							{key: "chkYn",         		label: "chk", 			width: 50 , align: "center", sortable: false  ,hidden:true
								,editor: {
									type   : "checkbox", config : { trueValue: "Y", falseValue: "N" }
								}
							},
							{key: "salesCd", 			label: "Sales Code", 	width: 120,		align: "center"},
							{key: "eqpNm", 				label: "설비명", 		width: 300,		align: "left"},
							{key: "mctypeNm", 			label: "기계구분", 		width: 70,		align: "center"},
							{key: "ordrsDtlDiv20Nm", 	label: "신작구분", 		width: 70,		align: "center"},
							{key: "ordrsDtlDiv30Nm", 	label: "자체구분", 		width: 70,		align: "center"},
							{key: "useYn", 				label: "출하유무", 		width: 60,		align: "center", formatter: "chkYn"},
							{key: "dudtIntendDt", 		label: "납기예정일", 	width: 80,		align: "center"},
							{key: "ordrsQty", 			label: "수주대수", 		width: 60,		align: "center", formatter: "money"},
							{key: "lgistQty", 			label: "물류요청대수", 	width: 80,		align: "center", editor: {type: "number"}, formatter: "money"},
							{key: "lgistRemark", 		label: "비고", 			width: 260,		align: "left", editor: {type: "textarea"}},
// 							{key: "prdtCd", 			label: "제품구분", 		width: 90,		align: "center"},
// 							{key: "prdtCdNm", 			label: "제품명", 		width: 180,		align: "left"},
// 							{key: "itemDivNm", 			label: "아이템구분", 	width: 130,		align: "left"},
			         	]
			    });
				return this;
			},

			setData: function(_page){
				var target = this.target;
				/*
				var formData = {
					"coCd" 		 : $("#coCd").val(),
					"ordrsNo" 	 : $("#ordrsNo").val(),
					"fileTrgtKey": $("#fileTrgtKey").val(),
				}
				*/

				var formData = getSearchParam("#popForm");
	    		postAjax("/user/cr/cr10/selectSelesCdList", formData, null, function(data) {
					try {
						var list = data.resultList;
						target.setData({
							list : list,
							page : {
								totalElements : list.length
							}
						});
						gridResize(list.length); //그리드 높이 조정
						$.each($.extend({}, list), function (idx, elem) {
							if(elem.chkYn == "Y" && elem.useYn == "Y") {
								var select_idx = Number(idx);
								salescdGridView.target.select(select_idx);
							}
						});
					} catch (error) {
						customAlert("오류 발생!! 전산실 연락 바랍니다", error.message);
						return null; // 오류 발생 시 null 반환
					} finally {
						// console.log("함수 실행 완료.");
					}
	    	 	});
			}
		};

	var gridViewPop2 = {
	        initView : function() {
	            this.target = new ax5.ui.grid();
	            this.target.setConfig({
	                showRowSelector: true,
	                multipleSelect: false,
	                sortable: false,
	                target: $('[data-ax5grid="first-grid-modal"]'),
	                header: {
	                    align: "center",
	                    selector: true
	                },
	                body: {
	                     onClick: function () {
	                        this.self.select(this.dindex);
	                    },
	                    onDBLClick: function () {
	                    },
	                    mergeCells : ["gb"],
	                },
	                page : {
	                    navigationItemCount : 10,
	                    height : 30,
	                    display : true,
	                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
	                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
	                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
	                    onChange : function() {
	                        gridView.setData(this.page.selectPage);
	                    }
	                },
	                columns : [
	                        {key: "gb",                 label: "구분",        align: "center",   width: 40},
	                        {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
	                        //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
	                        {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
	                        {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
	                        {key: "name",               label: "성명",        align: "center",   width: 80},
	                        {key: "jik",                label: "직위",        align: "center",   width: 60},
	                        {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
	                        {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
	                        {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
	                        {key: "telNo",              label: "H.P",       align: "center",   width: 130},
	                        {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
	                      ]
	                    });
	                    return this;
	                },

	                setData : function(_pageNo) {

	                    var targetObj = this.target;
	                    var formData = {
	                            "fileTrgtKey" : fileTrgtKey,
	                            "reqNo" :  lgistNo,
	                            "flag" :  "Y3",
	                            "pageNo" : _pageNo + 1
	                    }
	                    postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data){
							try {
								if (data.result.length > 0) {
									var list = data.result;
									targetObj.setData({
										list : list,
										page : {
											totalElements :  data.paginationInfo.totalRecordCount,
										}
									});
									if (list.some(item => item.sanctnSttus === "Y")) { //결재자중에 한명이라도 결재, 공유가 되었으면 수정 불가로 수정버튼 숨김
										$('#actionBtn').hide();
										$('#fileUpBtn').show();
									}
								}
							} catch (error) {
								customAlert("오류 발생!! 전산실 연락 바랍니다", error.message);
								return null; // 오류 발생 시 null 반환
							} finally {
								// console.log("함수 실행 완료.");
							}
	                    });
	                },
	                setData2 : function(_list) {
	                    this.target.setData({
	                            list : _list,
	                            page : {
	                                        totalElements :  _list.length,
	                            }
	                    });
	                }

	    };

	function gridAllCheck(){
		if(appStatus != "APP0"){return;}
		var header_col0_check_box = $('[data-ax5grid="salescd-grid"] [data-ax5grid-container="header"] table tr td[data-ax5grid-column-attr="rowSelector"][data-ax5grid-column-row="0"][data-ax5grid-column-col="0"][data-ax5grid-column-key="__checkbox_header__"]');
		var is_selected = header_col0_check_box.attr("data-ax5grid-selected");
		var grid_all_check = true;
		if(is_selected == "true"){
			grid_all_check = false;
		}

		if(grid_all_check) {
			grid_onDataChanged = false;
			$.each($.extend({}, salescdGridView.target.list), function (idx, elem) {
				if(elem.useYn == "N"||elem.anoUseYn == "N") {
					salescdGridView.target.setValue(Number(idx), "useYn", "Y");
				}
			});
			grid_onDataChanged = true;
		} else {
			salescdGridView.setData(0);
		}

	};

	$(document).ready(function() {
		setComboOptions($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(jwt.userId);
		$("#fileUpBtn").hide();

		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		ordrsNo =  modalStack.last().paramObj.ordrsNo;
		lgistNo = modalStack.last().paramObj.lgistNo;
		//loadFormData("#popForm", modalStack.last().paramObj);

		 //출하계획일
		$('#shipmntDt').datepicker({
		          format : "yyyy-mm-dd",
		          language : "ko",
		          autoclose : true
		})
		.on("changeDate", function(){
			if($('#hopeArvlDt').val() != ""){
				if($('#shipmntDt').val() > $('#hopeArvlDt').val()){ //출하계획일(2023.10.10) > 희망도착일(2023.10.12)
                    customAlert("날짜를 확인해주세요");
                    $('#shipmntDt').datepicker("setDate", new Date($('#hopeArvlDt').val()));
          		}
			}
		});

		 //희망도착일
		$('#hopeArvlDt').datepicker({
		          format : "yyyy-mm-dd",
		          language : "ko",
		          autoclose : true
		})
		.on("changeDate", function(){//출하계획일(2023.10.10) > 희망도착일(2023.10.12)
		          if($('#shipmntDt').val() > $('#hopeArvlDt').val()){
		                    customAlert("날짜를 확인해주세요");
		                    $('#hopeArvlDt').datepicker("setDate", new Date($('#shipmntDt').val()));
		          }
		});


		// 회사구분 변경에 따른 적용
		$('#coCd').on('change', function () {
			//---------------------------------------------------------------
			//첨부 화일 처리 시작
			//---------------------------------------------------------------
			$('#fileList_area').empty();
			fileParam = {
					fileTrgtTyp	: $("#popForm #pgmId").val(),
					fileTrgtKey	: fileTrgtKey,
					todoNo 		: modalStack.last().paramObj.lgistNo,	//수주번호
			}
	  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
			//---------------------------------------------------------------
			//첨부 화일 처리 끝
			//---------------------------------------------------------------
// 			$(".fileList_height").hide();//없으면 버튼 안나옴.
		});
		
// 		console.log(actionType);
		if (actionType == "C") {
			$("#staPlace").val(modalStack.last().paramObj.staPlace);
			$("#arvlPlace").val(modalStack.last().paramObj.ordrsClntNm);
			$("#staAddr").val(modalStack.last().paramObj.coAddr);
			$("#arvlAddr").val(modalStack.last().paramObj.clntAddr);

			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertLgistMast();
			});

			$('#trnsDiv').trigger('change');

			//initLoadForm("#popForm");
			//initLoadForm(".popup_area");//input,select,textarea 기능활성화

			let loadData = {
					"fileTrgtKey" : modalStack.last().paramObj.fileTrgtKey,
					"coCd" : modalStack.last().paramObj.coCd,
					"ordrsNo" : modalStack.last().paramObj.ordrsNo,
					"clntPjt" : modalStack.last().paramObj.clntPjt,
					"reqId" : modalStack.last().paramObj.reqId,
					"reqIdNm" : modalStack.last().paramObj.reqIdNm,
					"ordrsClntNm" : modalStack.last().paramObj.ordrsClntNm,
					"ordrsClntCd" : modalStack.last().paramObj.ordrsClntCd,
					"clasDiv" : "LGISTDIV0101", //출고를 기본으로 한다. 출고(LGISTDIV0101),입고(LGISTDIV0102)
			};
			loadFormData("#popForm", loadData , function(){
				/**
				 * grid 초기화
				*/

				salescdGridView.initView().setData(0);
				gridViewPop2.initView();
			});
			$('#coCd').trigger('change'); //파일트리 새로 그리기
		} else if (actionType == "U") {
			if(isEmpty($("#staAddr").val())) $("#staAddr").val(modalStack.last().paramObj.coAddr);
			if(isEmpty($("#arvlAddr").val())) $("#arvlAddr").val(modalStack.last().paramObj.clntAddr);

			$('.tit').text('물류진행요청 수정');

			selectLgistMastInfo();

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateLgistMast();
			});
			salescdGridView.initView();
			gridViewPop2.initView().setData(0);
		}



		//고객사PJT 비활성화
		$('#popForm .clntPjt').removeClass('hit');
		$('#clntPjt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		var header_col0_check_box = $('[data-ax5grid="salescd-grid"] [data-ax5grid-container="header"] table tr td[data-ax5grid-column-attr="rowSelector"][data-ax5grid-column-row="0"][data-ax5grid-column-col="0"][data-ax5grid-column-key="__checkbox_header__"]');
		header_col0_check_box.on("click", function() {
			gridAllCheck();
		});

	   	// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
	   	var paramObj1 = {
	           "coCd" : $("#popForm_S #coCd").val(),
	           "userId" : jwt.userId
	    };
	    postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
	        if (data.result[0] == undefined
	      	    || data.result[0].telNo == "") {
	      	  $("#popForm_S #telNo").val("051-312-2400");
	        }
	        else {
	      	  $("#popForm_S #telNo").val(data.result[0].telNo);
	        }
	        //customAlert($("#popForm_S #telNo").val());
	    });

		/* ITEM LIST 및 이미지 처리를 위한 함수 바인딩 처리 모음 */
		initTripTableHandlersOnce();   // 여기에서 1회만
		
		authChk();						// 권한체크
		
	});

	function changeTrnsDivSetValue(){
		var trnsDiv_value = $("#trnsDiv").val();
		if(trnsDiv_value == "LGISTDIV0301"){
			$("select[name=ovsTrnsAreaDiv]").val("");
			$("select[name=ovsSendCndDiv]").val("");
			$("input[name=ovsSendCndDivEtc]").val("");
			$("select[name=ovsPackKindDiv]").val("");
		}
		else {
			$("select[name=dmsTrnsAreaDiv]").val("");
			$("select[name=dmsSendCndDiv]").val("");
			$("input[name=dmsSendCndDivEtc]").val("");
			$("select[name=dmsPackKindDiv]").val("");
		}
	}

	//운송구분이 바뀔때 값셋팅
	function changeTrnsDiv(_value) {
		if(_value == "LGISTDIV0301") { //국내
			$('#dmsTran').show();
			$('#ovsTran').hide();

			$(".dmsClass").addClass('hit');
			$("select[name=dmsTrnsAreaDiv]").attr('required', 'required');
			$("select[name=dmsSendCndDiv]").attr('required', 'required');
			$("select[name=dmsPackKindDiv]").attr('required', 'required');

			$(".ovsClass").removeClass('hit');
			$("select[name=ovsTrnsAreaDiv]").removeAttr('required');
			$("select[name=ovsSendCndDiv]").removeAttr('required');
			$("select[name=ovsPackKindDiv]").removeAttr('required');
		}
		else if(_value == "LGISTDIV0302") { //해외
			$('#dmsTran').hide();
			$('#ovsTran').show();

			$(".dmsClass").removeClass('hit');
			$("select[name=dmsTrnsAreaDiv]").removeAttr('required');
			$("select[name=dmsSendCndDiv]").removeAttr('required');
			$("select[name=dmsPackKindDiv]").removeAttr('required');
			$(".ovsClass").addClass('hit');
			$("select[name=ovsTrnsAreaDiv]").attr('required', 'required');
			$("select[name=ovsSendCndDiv]").attr('required', 'required');
			$("select[name=ovsPackKindDiv]").attr('required', 'required');
		}
		else {
			$('#dmsTran').hide();
			$('#ovsTran').hide();
			changeSetEtc("x","dmsSendCndDiv");
			changeSetEtc("x","ovsSendCndDiv");

			$(".dmsClass").removeClass('hit');
			$("select[name=dmsTrnsAreaDiv]").removeAttr('required');
			$("select[name=dmsSendCndDiv]").removeAttr('required');
			$("select[name=dmsPackKindDiv]").removeAttr('required');
			$(".ovsClass").removeClass('hit');
			$("select[name=ovsTrnsAreaDiv]").removeAttr('required');
			$("select[name=ovsSendCndDiv]").removeAttr('required');
			$("select[name=ovsPackKindDiv]").removeAttr('required');
		}
	}

	//기타입력
	function changeSetEtc(_value,_name){
		if(!isEmpty(_value) && _value.indexOf("99") != -1){//기타
			$("input[name="+_name+"Etc"+"]").attr('required', 'required');
			$("input[name="+_name+"Etc"+"]").prop("readonly", false);
			//$('#popForm .'+_name).addClass('hit');
		}
		else {//기타아닐때
			$("input[name="+_name+"Etc"+"]").val("");
			$("input[name="+_name+"Etc"+"]").removeAttr('required');
			$("input[name="+_name+"Etc"+"]").prop("readonly", true);
			//$('#popForm .'+_name).removeClass('hit');
		}
	}

	//Sales Code 필수 변경
	function selectSalesCodeSet() {
		if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
			$('#popForm .Sales_Code').addClass('hit');
			$('#popForm input#salesCd').attr('required', 'required');
		} else {
			$('#popForm .Sales_Code').removeClass('hit');
			$('#popForm input#salesCd').removeAttr('required');
		}
	}

	function selectLgistMastInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		postAjax("/user/cr/cr10/selectLgistMastInfo", formData, null, function(data) {
			loadFormData("#popForm", data.result, function(data){
				salescdGridView.setData(0);//입고,출고 에 따라 그리드 데이타 변경

				$('#trnsDiv').trigger('change');
				//발송조건구분기타 활성/비활성
				changeSetEtc(data.dmsSendCndDiv,"dmsSendCndDiv");
				changeSetEtc(data.ovsSendCndDiv,"ovsSendCndDiv");

				appStatus = data.appStatus;
// 				if(isEmpty(appStatus)) appStatus = "APP0";
// 				if(appStatus != "APP0"){
					if(approvalYn()) {
						//결재중 일때 화면잠금.
						setDisplayLock();
				    }
// 				}
			});
// 			monthCloseChk($('#pblicteDt').val());

			$('#coCd').trigger('change'); //파일트리 새로 그리기
			
		    // res가 list라고 가정
		    $('#tripTable tbody').empty();
			
		    data.lgistItemList.forEach(function(row){
		    	appendTripRow(row, "SERVER");
		    });
		
		});
	}
	
	
	function setFileNameText($tr, name) {
		  const $label = $tr.find(".file-name").first();
		  if ($label.length === 0) return;
		  $label.text(name || "").toggle(!!name);
		}
	
	async function loadImgToBoxAndStore($tr, url, fileNameOpt) {
		  try {
		    const res = await fetch(url, {
		      method: "GET",
		      credentials: "include",
		      headers: { "Authorization": authorizationToken }
		    });
		    if (!res.ok) return;

		    const blob = await res.blob();
		    const ct = res.headers.get("content-type") || blob.type || "";
		    if (!ct.startsWith("image/")) return;

		    const seq = String($tr.find('[name=workRptNoSeq]').val());

		    const fileName = fileNameOpt || ("LGIST_" + seq + ".jpg");
		    const file = new File([blob], fileName, { type: ct });

		    // store 저장
		    window.tripImageStore.set(seq, {
		      file,
		      meta: { originalName: file.name, mime: file.type, convertedYn: "N" }
		    });

		    // 파일명 표시(추가)
		    setFileNameText($tr, file.name);

		    // 미리보기
		    const $box = $tr.find(".drop-area").first();
		    const $img = $box.find("img.profilePreview").first();
		    const old = $img.data("objUrl");
		    if (old) URL.revokeObjectURL(old);

		    const objUrl = URL.createObjectURL(file);
		    $img.data("objUrl", objUrl);
		    $img.attr("src", objUrl).css("display", "block");
		    $box.find("span").hide();

		  } catch (e) {
		    console.log(e);
		  }
		}
	
	// 등록
	function insertLgistMast() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
// 			setFormLock(".popup_area");
			filePostAjax("/user/cr/cr10/insertLgistMast", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						customAlert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,

							tLgistNo = data.lgistNo;  	//lgistNo 가지고 오기
							kakaoTodo();     			//kakaoTodo 호출

							gridView.setData(0);
							modalStack.close();									// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateLgistMast() {
// 		if(appStatus != "APP0"){
// 			customAlert("결재진행중 입니다. 결재진행중인 내역은 수정 할 수 없습니다.");
// 			return;
// 		}
		if( approvalYn() ) {
	        customAlert("결재가 이미 진행중입니다.");
	        return;
	    }

		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			setFormLock(".popup_area");
	      	filePostAjax("/user/cr/cr10/updateLgistMast", formData,function(data) {
						customAlert(data.resultMessage);
						if (data.resultCode == 200) {

							kakaoTodo();     //kakaoTodo 호출

							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}


	// 사진 저장하기
	function updateLgistlistImage() {
		var formData = makeFormData();
		setFormLock(".popup_area");
      	filePostAjax("/user/cr/cr10/updateLgistlistImage", formData,function(data) {
			if (data.resultCode == 200) {
			} else {
				customAlert(data.resultMessage);
				setFormUnLock(".popup_area");
			}
		});
	}
	
	//----------------------------------------------//

	function makeFormData() {
		// 날짜 하이픈 제거
		/*
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		*/

		//formData 생성전 운송구분에 따라 필요없는값제거
		changeTrnsDivSetValue();

		// 폼데이터 생성
		var formData = getFormData("#popForm");
		//var formData = new FormData($("#popForm")[0]);
		//---------------------------------------------------------------
		//  disabled 처리시 값 전송안됨 아래에서 폼데이터 추가
		//---------------------------------------------------------------
		formData.append("coCd", $('#coCd').val());
		formData.append("clntPjtNm", $("#clntPjt :selected").text())
		//formData.append("workRptNo", $('#workRptNo').val());
		//formData.append("reqIdNm", $('#reqIdNm').val());
		//formData.append("pblicteDt", $('#pblicteDt').val());
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
// 		var ordrsClntCd = $("input[name=ordrsClntCd]").val();
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#ordrsClntCd').val());	//첨부화일용
		formData.append("prdtCd", "");			//첨부화일용
		formData.append("itemCd", "");			//첨부화일용
		formData.append("ordrsNo", $('#ordrsNo').val());
		formData.append("prjctCd", $('#clntPjt').val());
		formData.append("pgmId",   'CR1001P01');

		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용

		//---------------------------------------------------------------

        //---------------------------------------------------------------
		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		let selected_list = salescdGridView.target.getList("selected"); //선택항목을 가져온다.
		//let selected_list = JSON.parse(JSON.stringify(salescdGridView.target.list));

		//체크 항목을 chkYn = Y 로 셋팅
 		$.each($.extend({}, selected_list), function (idx, elem) {
			elem.chkYn = "Y";
			elem.dtaChk = "I";
		});

		formData.append("salesCdArr", JSON.stringify(selected_list));


		//---------------------------------------------------------------
		//--납품list 처리를 위한 부분 시작
		//---------------------------------------------------------------
		const tripRptS = [];

		$('#tripTable tbody tr.tripArea').each(function(idx){
			const $tr = $(this);
			const seq = String($tr.find('[name=workRptNoSeq]').val());
	
			// 금액/수량 검증
			const tripRptAmt = gPasFloatChk($tr.find('[name=tripRptAmt]').val());
			if (!tripRptAmt || tripRptAmt === 0) {
				alert("수량을 입력하세요!");
				$tr.find('[name=tripRptAmt]').focus();
				throw new Error('validation');
			}
	
			// 행 데이터
			const row = {
				lgistNo:	  	$('#lgistNo').val(),
				lgistNoSeq:   	seq,
				updCheck:  		$tr.find('[name=updCheck]').val(),
				lgistItemNo:    $tr.find('[name=itemNo]').val(),
				lgistItemCode:  $tr.find('[name=itemCode]').val(),
				lgistItemNm:    $tr.find('[name=itemNm]').val(),
				lgistItemDiv:   $tr.find('[name=itemDiv]').val(),
				lgistItemQty:   gPasFloatChk($tr.find('[name=tripRptAmt]').val()),
				workRptNoSeq:   $tr.find('[name=workRptNoSeq]').val(),
				fileTrgtKey:  	$tr.find('[name=fileTrgtKey]').val(),
				
				// 이미지 메타만
				hasImg: "N",
				lgistItemImgNm: "",
				lgistItemImgMime: ""
			};


			const stored = window.tripImageStore.get(seq);
			if (stored && stored.file) {
				row.hasImg = "Y";
				row.lgistItemImgNm = stored.meta.originalName;
				row.lgistItemImgMime = stored.meta.mime;
		
				// 실제 파일은 FormData에 별도 append
				formData.append("lgistFiles", stored.file, stored.file.name);
				formData.append("lgistFilesSeq", seq); // 파일-행 매핑키
			}
	
			tripRptS.push(row);
		  
		  
		});

		// FormData에 배열(JSON)로 담기
		formData.append("tripRptS", JSON.stringify(tripRptS));
		//---------------------------------------------------------------
		//--납품list 처리를 위한 부분 시작
		//---------------------------------------------------------------
		
		//---------------------------------------------------------------
		//--결재 처리를 위한 부분 시작
		//---------------------------------------------------------------
		let popData = getSearchParam("#popForm");
		let paramData = {
				"fileTrgtKey" : popData.fileTrgtKey,
				"coCd" : popData.coCd,
				"ordrsNo" : popData.ordrsNo,
				"clntPjt" : popData.clntPjt,
				"reqId" : popData.reqId,
				"reqIdNm" : popData.reqIdNm,
				"ordrsClntNm" : popData.ordrsClntNm,
				"ordrsClntCd" : popData.ordrsClntCd,
				"clasDiv" : popData.clasDiv,
		};
		formData.append("appDiv", "APPDIV03");
		formData.append("pgPath", "/user/cr/cr10/CR1001P02.html");
		formData.append("pgParam", JSON.stringify(paramData));
		//---------------------------------------------------------------
		//--결재 처리를 위한 부분 끝
		//---------------------------------------------------------------

	    //신결재
	    // 이슈정보 공유 결재
	    var rowSharngList = gridViewPop2.target.list;
	    if(rowSharngList.length > 0) {
	        var rowSharngListArr = []; //공유정보
	        var rowApprovalListArr = []; //결재정보

	        $.each(rowSharngList, function(idx, elem){
	            var rowSharngListObj = elem;
	            var rowApprovalListObj = elem;

	            if (elem.gb == '공유'){
	                rowSharngListObj["gb"] = elem.gb;
	                rowSharngListObj["coCd"] = popData.coCd;
	                rowSharngListObj["salesCd"] = popData.ordrsNo;
	                rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
	                rowSharngListObj["todoDiv2CodeId"] = "TODODIV1080";
	                rowSharngListObj["todoId"] = elem.usrNm;
	                rowSharngListObj["todoCoCd"] = elem.coCd;
	                rowSharngListObj["empNo"] = elem.empNo;
	                rowSharngListObj["name"] = elem.name;
	                rowSharngListObj["telNo"] = elem.telNo;
	                rowSharngListObj["email"] = elem.eMail;
	                rowSharngListObj["pgPath"] = "/user/cr/cr10/CR1001P03.html";
	                rowSharngListArr.push(rowSharngListObj);
	            }
	            else if (elem.gb == '결재'){
	                rowApprovalListObj["gb"] = elem.gb;
	                rowApprovalListObj["coCd"] = popData.coCd;
	                rowApprovalListObj["salesCd"] = popData.ordrsNo;
	                rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
	                rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2040";
	                rowApprovalListObj["todoId"] = elem.usrNm;
	                rowApprovalListObj["todoCoCd"] = elem.coCd;
	                rowApprovalListObj["empNo"] = elem.empNo;
	                rowApprovalListObj["name"] = elem.name;
	                rowApprovalListObj["telNo"] = elem.telNo;
	                rowApprovalListObj["email"] = elem.eMail;
	                rowApprovalListObj["pgPath"] = "/user/cr/cr10/CR1001P03.html";
	                rowApprovalListArr.push(rowApprovalListObj);
	            }
	        });
	        formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
	        formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
	    }
	    //신결재 끝
	    return formData;
	}


	function setDisplayLock(){
		setDisabledInput("#popForm" , true);
		$('.tit').text('물류진행요청 수정 (결재진행중)');

		//$("#actionBtn").prop("disabled", true);
	}

	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#pchsClntCd').val(row.clntCd);
					$('#pchsClntNm').val(row.clntNm);
// 					$('#mngId').val(row.salesEmpId);
// 					$('#mngNm').val(row.salesEmpNm);

// 					var paramObj = {
// 						"coCd" : $('#coCd').val(),
// 						"clntCd" : row.clntCd
// 					}
// 					setMngInfo(paramObj);
				});
	}

	function openUserTree(_id) {
		if($('#reqIdNm').prop("disabled")) return false;

		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#'+_id).val(),
			"userNm": $('#'+_id+'Nm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#'+_id).val(checkedNode.id);
			$('#'+_id+'Nm').val(checkedNode.text);
			$("#staChrgIdTelNo").val(checkedNode.original.telNo)
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	function swichInfo() {
		var staPlace = $("#staPlace").val(); //출발지 업체명
		var arvlPlace = $("#arvlPlace").val(); //도착지 업체명
		var staChrgCont = $("#staChrgCont").val(); //출발 담당자/연락처
		var arvlChrgCont = $("#arvlChrgCont").val(); //도착 담당자/연락처
		var staAddr = $("#staAddr").val(); //출발지 주소
		var arvlAddr = $("#arvlAddr").val(); //도착지 주소

		$("#staPlace").val(arvlPlace);
		$("#arvlPlace").val(staPlace);
		$("#staChrgCont").val(arvlChrgCont);
		$("#arvlChrgCont").val(staChrgCont);
		$("#staAddr").val(arvlAddr);
		$("#arvlAddr").val(staAddr);
	}

	//공유대상자 추가
	function insertShareUserModal() {
		if( approvalYn() ) {
			customAlert("결재가 이미 진행중입니다.");
			return;
		}

		var paramObj = {};
		var appshaList = gridViewPop2.target.list;
		paramObj["coCd"]   = $('#coCd').val();
		paramObj["useYn"]  = "Y";
		// paramObj["userId"] = $('#ordrgId').val();
		// paramObj["userNm"] = $('#ordrgNm').val();
		paramObj["userId"] = $('#reqId').val();
		paramObj["userNm"] = $('#reqIdNm').val();
		paramObj["approvalGrid"] = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
			return {
				gb: "결재",
				id: item.usrNm,
				text: item.name,
				parent: item.jik,
				deptNm: item.dtNm,
				telNo: item.telNo,
				offTelNo: item.offTelNo,
				email: item.email
			};
		});
		paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
			return {
				gb: "공유",
				id: item.usrNm,
				text: item.name,
				parent: item.jik,
				deptNm: item.dtNm,
				telNo: item.telNo,
				offTelNo: item.offTelNo,
				email: item.email
			};
		});

		openThirdModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid) {
// 			console.log('결재라인 : ', approvalGrid.target.list);
// 			console.log('공유라인 : ', shareGrid.target.list);

			var appArray = approvalGrid.target.list.map(function(item) {
				return {
					gb: "결재",
					usrNm: item.id,
					name: item.text,
					jik: item.parent,
					dtNm: item.deptNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
				};
			});
			var shaArray = shareGrid.target.list.map(function(item) {
				return {
					gb: "공유",
					usrNm: item.id,
					name: item.text,
					jik: item.parent,
					dtNm: item.deptNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
				};
			});
			gridViewPop2.setData2(appArray.concat(shaArray));
		});
	}

	function deleteShareUser(){
		if( approvalYn() ) {
	        customAlert("결재가 이미 진행중입니다.");
	        return;
	    }
	    var selRow = parseInt(gridViewPop2.target.selectedDataIndexs);
	    if( isNaN(selRow) ) {
	        customAlert("선택된 행이 없습니다.");
	        return;
	    } else {
	            if( selRow > -1 ) {
	                gridViewPop2.target.removeRow(selRow);
	            }
	    }
	}


	//공유대상자 추가
	function insertShareUserModal2() {
		if( approvalYn2() ) {
			customAlert("결재가 이미 진행중입니다.");
			return;
		}

		var paramObj = {};
		var appshaList = gridViewPop2.target.list;
		paramObj["coCd"]   = $('#coCd').val();
		paramObj["useYn"]  = "Y";
		// paramObj["userId"] = $('#ordrgId').val();
		// paramObj["userNm"] = $('#ordrgNm').val();
		paramObj["userId"] = $('#reqId').val();
		paramObj["userNm"] = $('#reqIdNm').val();
		paramObj["approvalGrid"] = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
			return {
				gb: "결재",
				id: item.usrNm,
				text: item.name,
				parent: item.jik,
				deptNm: item.dtNm,
				telNo: item.telNo,
				offTelNo: item.offTelNo,
				email: item.email
			};
		});
		paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
			return {
				gb: "공유",
				id: item.usrNm,
				text: item.name,
				parent: item.jik,
				deptNm: item.dtNm,
				telNo: item.telNo,
				offTelNo: item.offTelNo,
				email: item.email
			};
		});
		openModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid) {
// 			console.log('결재라인 : ', approvalGrid.target.list);
// 			console.log('공유라인 : ', shareGrid.target.list);

			var appArray = approvalGrid.target.list.map(function(item) {
				return {
					gb: "결재",
					usrNm: item.id,
					name: item.text,
					jik: item.parent,
					dtNm: item.deptNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
				};
			});
			var shaArray = shareGrid.target.list.map(function(item) {
				return {
					gb: "공유",
					usrNm: item.id,
					name: item.text,
					jik: item.parent,
					dtNm: item.deptNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email,
				};
			});
			gridViewPop2.setData2(appArray.concat(shaArray));
		});
	}

	function deleteShareUser2() {
		if( approvalYn2() ) {
			customAlert("결재가 이미 진행중입니다.");
			return;
		}

		var selRow = parseInt(gridViewPop2.target.selectedDataIndexs);
		if( isNaN(selRow) ) {
			customAlert("선택된 행이 없습니다.");
			return;
		} else {
			if( selRow > -1 ) {
				gridViewPop2.target.removeRow(selRow);
			}
		}
	}

	function approvalYn() {
	    var gridList = gridViewPop2.target.getList();
	    var inCnt = 0;
	    if( gridList.length > 0 ) {
	        var msgArr = [];
	        $.each(gridList, function (idx, elem) {
	            //결재자가 본인이 아니면서 상태가 Y인 경우
	            if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
	        })
	    }
	    return inCnt;
	}

	function approvalYn2() {
	    var gridList = gridViewPop2.target.getList();
	    var inCnt = 0;
	    if( gridList.length > 0 ) {
	        var msgArr = [];
	        $.each(gridList, function (idx, elem) {
	            //결재자가 본인이 아니면서 상태가 Y인 경우
	            if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
	        })
	    }
	    return inCnt;
	}

	function gridResize(size) {
	    var tagHeight = (size) * 28 + 45 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 120 ? 120 : tagHeight;

        salescdGridView.target.setHeight(tagHeight);
	}

	// KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
	 function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
		var toastNo = "";

	     // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
	     var teleNo = ""; //update& insert시 물류번호 가지고 오기위함
	     var paramObj1 = {
	             "coCd" : $("#popForm #coCd").val(),
	             "userId" : $("#popForm #reqId").val()
	         };
	      postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
	          if (data.result[0] == undefined
	        	    || data.result[0].telNo == "") {
	        	  teleNo = "051-312-2400";
	          }
	          else {
	        	  teleNo = data.result[0].telNo;
	          }
	          //customAlert($("#popForm_S #telNo").val());
	      });
	     //---------------------------------------

		if (actionType == 'U'){
			toastNo = $("#lgistNo").val();
		}else{
			toastNo = tLgistNo
		}
		let param = {
	             "tmplatDiv": "TMPLATDIV02"
	             , "coCd": $("#popForm #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
	             , "todoDiv1CodeId": todoDiv1CodeId //"TODODIV10"                 //공통코드 해당업무 - 결재
	             , "todoDiv2CodeId": todoDiv2CodeId // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
	             , "todoDiv1CodeNm": todoDiv1CodeNm // "WBS이슈"                        //공통코드 해당업무 - 결재 - 발주서
	             , "todoDiv2CodeNm": todoDiv2CodeNm // "WBS계획이슈"                       //공통코드 해당업무 - 결재 - 발주서
	             , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
	             , "todoNo": toastNo              //물류번호
	             , "clntCd": "1"                 //발신회사는 로그인사용자 회사
	             , "clntNm": $("#popForm #ordrsClntNm").val()              //로그의 수신거래처명
	             , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
	             , "ordrgMngTelNo": teleNo       //담당자전화번호
	             , "creatPgm": "CR1001P01"
	     }

	     commKaKaoSendTodo(param);
	 }

	 function kakaoTodo() {
        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	            "userId" : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });
        }

	    let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";


	    // 1. 이슈 공유, 결재 프로세스
	    var rowList = gridViewPop2.target.getList();
	    var sharChk = 0;
	    var appChk = 0;
	    $.each(rowList, function(idx, elem){
	        if (elem.gb == "공유") {
	        	sharChk++;
	        }
	        else if (elem.gb == "결재") {
	        	appChk++;
	        }
	    });
	    // 1-1. WBS 계획 이슈 공유 알림톡 처리
	    if (sharChk > 0) {
	    	kakaoSendBody('TODODIV10','TODODIV1080', '영업관리','물류진행요청관리','공유');

	    }

	    // 1-2. WBS 계획 이슈 결재 알림톡 처리
	    if (appChk > 0) {
	        kakaoSendBody('TODODIV20','TODODIV2040', '영업관리','물류진행요청관리','결재');
	    }

	    if (kakaoCnt > 0) {
	    	kakaoCnt = 0;
// 	    	customAlert("알림톡이 정상 발송되었습니다.");
	    }
	}



	/* function kakaoTodo() {
	    let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

	    let param = {
	            "tmplatDiv": "TMPLATDIV02"
	            , "coCd": $("#popForm #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
	            , "todoDiv1CodeId": "TODODIV20"                 //공통코드 해당업무 - 결재
	            , "todoDiv2CodeId": "TODODIV2050"                   //공통코드 해당업무 - 결재 - 발주서
	            , "todoDiv1CodeNm": "결재"                        //공통코드 해당업무 - 결재 - 발주서
	            , "todoDiv2CodeNm": "발주서"                       //공통코드 해당업무 - 결재 - 발주서
	            , "sanctnDiv2": "결재"                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
	            , "todoNo": $("#popForm #ordrgNo").val()
	            , "clntCd": "1"                 //발신회사는 로그인사용자 회사
	            , "clntNm": clntNm              //로그의 수신거래처명
	            , "ordrgMngNm": $("#popForm #ordrgMngNm").val()         //발주작성자(담당자)
	            , "ordrgMngTelNo": $("#popForm #ordrgMngTelNo").val()       //담당자전화번호
	    }
	    commKaKaoSendTodo(param);
	} */


	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
// 	    console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

	    //알림톡수신번호 채번
	    var maxMessageId = null;            //message id(unique key)
	    var talkMessage = null              //발송될 내용 template
	    var mobile = null                   //수신인 휴대전화번호
	    var title = null                    //todo title
	    var sendList = [];
	    let talkParam = {};
	    let talkBody = {};
	    let sendCnt = 0;
	    postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
	                , function(data) {
	                    if(data.resultList.length > 0 ) {
	                        if( data.resultList[0].maxMessageId != "" ) {
	                            sendList = data.resultList;
	                        } else {
	                            customAlert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
	                            return;
	                        }

	                    }
	    });
	    //user search ajax end

	    //대상 loop
	    $.each(sendList, function (key, sendObj) {
	        maxMessageId = sendObj.maxMessageId;
	        talkMessage = sendObj.messageDesc;
	        mobile =  sendObj.telNo;
	        //로그용
	        param.rcvId = sendObj.todoId;           //todo 수신id
	        param.rcvNm = sendObj.name;             //todo 수신자명
	        param.nameTo = sendObj.name;                //todo 수신자명

	        // 알림톡 Title 자리수 제한 문자열 자르기
	        if (sendObj.todoTitl.length > 30) {
	            title = sendObj.todoTitl.substring(0,25);
	        }
	        else {
	            title = sendObj.todoTitl;
	        }

	        param.title = title;                                //요청내용제목
	        param.sendDt = sendObj.sendDt;

	        if(mobile == "" || mobile == null) {
	            alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
	            return;
	        }
	        if(talkMessage == "" || talkMessage == null) {
	            alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
	            return;
	        }
	        //message 치환
	        let message = talkMessage;
	        let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
	        //loop
	        $.each(splitStr, function (key, val) {
	            let compKey = val.substring(1, val.length-1);
	            if( compKey != "" && compKey != "undefined" ) {
	                if( typeof(param[compKey]) != "undefined" ) {
	                    let val2 = '#'+val;
	                    message = message.replaceAll(val2, param[compKey]);
	                }
	            }
	        });
	        talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
	        talkParam.serverName = "gyitt2400";
	        talkParam.paymentType = "P";
	        talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
	        talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값);
			if (title.length > 50) {
				title = title.substring(0, 49); // 50자까지만 자르기
			}
	        talkBody.title = title;                 //알림톡 타이틀 -
	        talkBody.message = message;             //알림톡 메시지 (1000 byte)
	        talkBody.mobile = mobile;               //휴대전화번호
	        talkBody.template = "10003";            //템플릿관리화면 템플릿ID - 발주서 V2
	        let talkJson = JSON.stringify(talkBody);
	        sendCnt = kakaoSendReal(talkJson, talkParam, param);
	    });
	    //대상 loop end
	    if( sendCnt > 0 ) {
	        //customAlert("알림톡 정상 발송되었습니다.");
	        kakaoCnt++;
	    }

	    //한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄
	   /*  talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
	    talkBody.mobile = "01063893764"
	    talkJson = JSON.stringify(talkBody); */
	    //kakaoSendReal(talkJson, talkParam, param);
	}


    //경비추가 버튼
	$('#addDayileRptTrpButton').click(function() {
		appendTripRow(null, "NEW");
	});


	//경비추가 버튼 기능  수행
	function appendTripRow(row, mode) {
		const $tbl = $('#tripTable');
		let $tbody = $tbl.find('tbody');
		if ($tbody.length === 0) $tbody = $('<tbody/>').appendTo($tbl);
	
		// mode: "SERVER" | "NEW"
		let seq, updCheck;
	
		if (mode === "SERVER") {
			updCheck = "U";
			seq = parseInt(row.lgistNoSeq, 10);  // 서버 seq 그대로
		    // 서버 seq가 더 크면 nextTripSeq도 끌어올림(중복 방지)
		    if (!isNaN(seq) && seq > nextTripSeq) nextTripSeq = seq;

		} else { // "NEW"
			nextTripSeq += 1;
			seq = nextTripSeq;
			
			updCheck = "C";
			row = row || {};
			row.tripRptAmt = row.tripRptAmt || 0;
		}
	
		const $tr = makeTripRow(seq, updCheck, row);
		$tbody.append($tr);
		return $tr;
	}
	
	//경비추가 버튼 기능  수행
	function makeTripRow(seq, updCheck, row) {
		const $tr = $(`
			<tr class="tripArea" data-idx="${seq}">
				<td><input type="text" name="itemNo"   class="form-control" required></td>
				<td><input type="text" name="itemCode" class="form-control" required></td>
				<td><input type="text" name="itemNm"   class="form-control" required></td>
				<td><input type="text" name="itemDiv"  class="form-control" required></td>
				<td><input type="text" name="tripRptAmt" class="form-control" onkeyup="onlyNumber(this);" required></td>
				
				<td class="photoCell">
					<div class="profile-box drop-area" tabindex="0" data-idx="${seq}">
						<span>파일 드래그 또는 더블클릭\n이미지복사후 Ctrl+V</span>
						<img class="profilePreview" alt="">
					</div>

					<input type="file" class="file-input" accept="image/*,.heic,.heif" style="display:none;">
					
				</td>
				<td>
					<div class="file-name-row" style="align-items:center; gap:8px;">
						<span class="file-name" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>

					<div>
						<button type="button" class="btn btn-secondary btn-sm btnClearImg" style="height:22px; padding:0 8px; display:none;">이미지 삭제</button>
						<button type="button" class="btn btn-primary btn-sm btnCopyImg" style="height:22px; padding:0 8px; margin-left:auto; display:none;">이미지 복사</button>
						</div>
					</div>

					<input type="hidden" name="fileTrgtKey" value="">
					<input type="hidden" name="updCheck" value="${updCheck}">
					<input type="hidden" name="workRptNoSeq" value="${seq}">
				</td>
				
				<td class="actionCell" style="text-align:center; width:70px;">
					<a type="button" class="btn btn-danger btn-sm btnRowDel">삭제</button>
				</td>
			</tr>
		`);
		
		// 값 세팅(서버 row가 있으면, 없으면 신규)
		row = row || {};
		$tr.find('[name=itemNo]').val(row.lgistItemNo   || row.itemNo   || '');
		$tr.find('[name=itemCode]').val(row.lgistItemCode || row.itemCode || '');
		$tr.find('[name=itemNm]').val(row.lgistItemNm  || row.itemNm  || '');
		$tr.find('[name=itemDiv]').val(row.lgistItemDiv || row.itemDiv || '');
		$tr.find('[name=tripRptAmt]').val(row.lgistItemQty || row.tripRptAmt || 0);
		
		// 서버 이미지 있으면 로딩
		if (row.imgurl) {
			const url = row.imgurl + (row.imgurl.indexOf("?") >= 0 ? "&" : "?") + "t=" + Date.now();
			const fileName = row.lgistItemImgNm || "";
			loadImgToBoxAndStore($tr, url, fileName);
			$tr.find('.btnClearImg').first().show();
			$tr.find('.btnCopyImg').first().show();
		}
		
		return $tr;
	}

	// ======================================이미지 함수 로직 start======================================
	// 미리보기 공통 함수
	async function handleTripImage(file, $tr) {
		if (!file) return;
		
		const seq = String($tr.find('[name=workRptNoSeq]').val() || $tr.data('idx'));
		const $box = $tr.find('.drop-area').first();
		const $img = $box.find('img.profilePreview').first();
		
		const isHeic =
			(file.type && /heic|heif/i.test(file.type)) ||
			(file.name && /\.(heic|heif)$/i.test(file.name));
		
		let uploadBlob = file;
		let uploadName = file.name;
		let uploadType = file.type || 'application/octet-stream';
		let convertedYn = 'N';
		
		// HEIC/HEIF -> JPEG 변환(업로드도 JPEG로)
		if (isHeic) {
			try {
				let converted = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.9 });
				if (Array.isArray(converted)) converted = converted[0];
				uploadBlob = converted;
				uploadType = "image/jpeg";
				uploadName = file.name.replace(/\.(heic|heif)$/i, ".jpg");
				convertedYn = 'Y';
			} catch (e) {
				alert("HEIC 변환 실패: JPG/PNG로 변환 후 업로드 권장");
				return;
			}
		} else {
			if (file.type && !file.type.startsWith("image/")) return;
		}
		
		// 업로드용 File 생성
		const uploadFile = new File([uploadBlob], uploadName, { type: uploadType });
		
		// 미리보기(업로드 파일 기준)
		const oldUrl = $img.data("objUrl");
		if (oldUrl) URL.revokeObjectURL(oldUrl);
		const url = URL.createObjectURL(uploadFile);
		$img.data("objUrl", url);
		
		$img.attr("src", url).show();
		$box.find("span").hide();
		
		// 메타 저장
		window.tripImageStore.set(seq, {
			file: uploadFile,
			meta: {
				seq,
				originalName: file.name,
				uploadName: uploadName,
				mime: uploadType,
				size: uploadFile.size,
				convertedYn
			}
		});
	
		// 파일명 표시
		setFileNameText($tr, file.name);

		$tr.find('.btnCopyImg').first().show();
		$tr.find('.btnClearImg').first().show();
	}
	
	function parseLine(line) {
		  if (!line) return null;

		  // 앞뒤 공백 제거 후 비면 skip
		  const trimmed = line.replace(/\r/g, '').trim();
		  if (!trimmed) return null;

		  // 탭 기준 분리 (연속 탭도 빈 필드로 유지)
		  // "A\t\tC" => ["A", "", "C"]
		  const cols = trimmed.split('\t').map(v => (v == null ? '' : String(v).trim()));

		  // 전부 빈 값이면 skip
		  if (cols.every(v => v === '')) return null;

		  // 최소 5필드 보장(없으면 공백 채움)
		  while (cols.length < 5) cols.push('');

		  // cols가 5개 초과면 버림
		  // [No, 출고NO, 설비명, 단위, 수량]
		  let no    = cols[0] || '';
		  let outNo = cols[1] || '';
		  let eqNm  = cols[2] || '';;
		  let unit  = cols[3] || '';
		  let qty   = cols[4] || '';

		  // 수량 숫자 정리(쉼표 제거). 비어있으면 0 또는 ''로 둘지 선택 가능
		  qty = String(qty).replace(/,/g, '').trim();

		  // 수량이 비어있으면 빈값 허용("없는 필드 공백"이므로 통과)
		  // 숫자 검증
		  // if (qty && !/^\d+(\.\d+)?$/.test(qty)) return null;

		  return { no, outNo, eqNm, unit, qty };
		}

	
	function initTripTableHandlersOnce() {
		if (window.__tripHandlersInited) return;   // 2중 방지
		window.__tripHandlersInited = true;

		// 버튼 클릭 시 해당 행의 이미지 복사
		$(document).off('click.copyimg').on('click.copyimg', '.btnCopyImg', async function(e){
		  e.preventDefault();
		  e.stopPropagation();
		  if (this.dataset.busy === "1") return;
		  this.dataset.busy = "1";

		  try {
		    const $tr = $(this).closest('tr.tripArea');
		    await copyPreviewImageToClipboard($tr);
		  } finally {
		    this.dataset.busy = "0";
		  }
		});

		/* 이미지 삭제(행 유지) */
		$(document).off('click.clearimg', '.btnClearImg').on('click.clearimg', '.btnClearImg', function(e){
		  e.preventDefault();
		  e.stopPropagation();

		  const $tr   = $(this).closest('tr.tripArea');
		  const $box  = $tr.find('.drop-area').first();
		  const $img  = $box.find('img.profilePreview').first();
		  const $file = $tr.find('input.file-input').first();

		  // 1) 미리보기 제거
		  const oldUrl = $img.data('objUrl');
		  if (oldUrl) URL.revokeObjectURL(oldUrl);
		  $img.removeData('objUrl');

		  $img.removeAttr('src').hide();
		  $box.find('span').show();              // "파일을 드래그..." 문구 다시 표시

		  // 2) 파일 input 초기화
		  if ($file.length) $file.val('');

		  // 3) 파일명 표시 제거
		  $tr.find('.file-name').text('');

		  // 4) 저장용 store에서 제거
		  const seq = String($tr.find('[name=workRptNoSeq]').val() || $tr.data('idx') || '');
		  if (seq) window.tripImageStore.delete(seq);

		  // 5) 기존 서버 이미지 삭제 의사 표시(중요)
		  //    서버에 "이미지 비움"을 전달하려면 플래그가 필요합니다.
		  $tr.find('[name=hasImg]').val('N');          // 있으면 사용
		  $tr.find('[name=imgDelYn]').val('Y');        // 없으면 hidden 추가 권장
		});


		/* 해당 TR 삭제(전체 삭제) */
		$(document).off('click.rowdel', '.btnRowDel').on('click.rowdel', '.btnRowDel', function(e){

			const $tr = $(this).closest('tr.tripArea');
			const upd = $tr.find('[name=updCheck]').val();
			
			// 이미지 store도 정리(사용 중이면)
			const seq = String($tr.find('[name=workRptNoSeq]').val() || '');
			if (seq) window.tripImageStore && window.tripImageStore.delete && window.tripImageStore.delete(seq);
		
			if (upd === 'C') {
			  $tr.remove(); // 신규행은 그냥 제거
			} else {
			  $tr.find('[name=updCheck]').val('D');
			  $tr.hide(); // 서버에는 D로 보내고 화면은 숨김
			}
		});


		/* 엑셀자료 TR 붙여넣기 */
		$(document).off('paste', '#bulkPasteBox').on('paste', '#bulkPasteBox', function(e){
			const cd = e.originalEvent.clipboardData;
			const text = cd ? cd.getData('text/plain') : '';
			if (!text) return;
			
			e.preventDefault(); // textarea에 실제로 입력되는 건 막고, 파싱만
			
			const lines = text.split(/\r?\n/);
			lines.forEach(line => {
			  const data = parseLine(line); // 기존 parseLine 그대로 사용
			  if (!data) return;			// 빈줄/무효줄 패스
			
			  // 신규 행 추가
			  const $tr = appendTripRow(null, "NEW");
			  $tr.find('[name=itemNo]').val(data.no);
			  $tr.find('[name=itemCode]').val(data.outNo);
			  $tr.find('[name=itemNm]').val(data.eqNm);
			  $tr.find('[name=itemDiv]').val(data.unit);
			  $tr.find('[name=tripRptAmt]').val(data.qty);
			});
			
			// UX: 붙여넣기 박스 내용 비우기
			$(this).val('');
		});

		/* 클릭 -> 파일선택 (중복 바인딩 방지) */
		$(document).off("click", ".drop-area").on("click", ".drop-area", function(e) {
			  e.preventDefault();
			  e.stopPropagation();

			  $lastImgTargetTr = $(this).closest("tr.tripArea");

			  // 붙여넣기 받는 textarea로 포커스 이동(권장)
			  this.focus();
		});

		$(document).off("dblclick", ".drop-area").on("dblclick", ".drop-area", function(e){
			e.preventDefault();
			e.stopPropagation();
			$(this).closest("td").find("input.file-input").first().trigger("click");
		});
		
		/* 파일선택(change) -> 미리보기 */
		$(document).off("change", "input.file-input").on("change", "input.file-input", async function(e) {
			const file = this.files && this.files[0];
			if (!file) return;
			const $tr = $(this).closest("tr.tripArea");
			await handleTripImage(file, $tr);
		});

		/* drag UI */
		$(document).off("dragover", ".drop-area").on("dragover", ".drop-area", function(e) {
			e.preventDefault();
			e.originalEvent.dataTransfer.dropEffect = "copy";
			$(this).addClass("dragover");
		});

		$(document).off("dragleave", ".drop-area").on("dragleave", ".drop-area", function(e) {
			$(this).removeClass("dragover");
		});

		/* drop -> input 주입 + 미리보기 */
		$(document).off("drop", ".drop-area").on("drop", ".drop-area", async function(e) {
			e.preventDefault();
			$(this).removeClass("dragover");
			
			const file = e.originalEvent.dataTransfer.files && e.originalEvent.dataTransfer.files[0];
			if (!file) return;
			
			const $tr = $(this).closest("tr.tripArea");
			await handleTripImage(file, $tr);
		});
		
		/* 붙여넣기(paste) 받아서 해당 행에 미리보기+저장 */
		$(document).off('paste.pasteimg', '.drop-area').on('paste.pasteimg', '.drop-area', async function(e){

		    const cd = e.originalEvent.clipboardData;
		    const file = pickImageFileFromClipboard(cd);

		    
		    if (!file) {
		      alert("붙여넣기에서 이미지가 감지되지 않습니다. (PPT/정책/형식 제한 가능)");
		      return;
		    }

		    e.preventDefault();

		    const $tr = $(this).closest('tr.tripArea');
		    const $input = $tr.find('input.file-input').first();

		    // 기존 로직(HEIC 변환 + 미리보기 + store 저장)
		    await handleTripImage(file, $tr);
		  });
	}
	
	
	/* 클립보드에서 이미지가 있는지 확인해서 추출 보관 처리 */
	function pickImageFileFromClipboard(cd) {
		  if (!cd) return null;

		  // 1) cd.files 가 있으면(가장 확실) 여기서 먼저 가져옴
		  if (cd.files && cd.files.length > 0) {
		    for (let i = 0; i < cd.files.length; i++) {
		      const f = cd.files[i];
		      if (f && f.type && f.type.startsWith("image/")) return f;
		    }
		  }

		  // 2) items에서 "file" kind만, getAsFile()이 실제로 나오는 것만 선택
		  if (cd.items && cd.items.length > 0) {
		    // PNG/JPEG 우선
		    let fallback = null;

		    for (let i = 0; i < cd.items.length; i++) {
		      const it = cd.items[i];
		      if (!it) continue;

		      // 중요: kind가 file이 아닌 svg(text)류는 제외
		      if (it.kind !== "file") continue;
		      if (!it.type || !it.type.startsWith("image/")) continue;

		      const f = it.getAsFile && it.getAsFile();
		      if (!f) continue;

		      // png/jpeg 우선
		      if (it.type === "image/png" || it.type === "image/jpeg") return f;

		      // 나중에라도 쓸 수 있게 fallback 저장(예: image/svg+xml)
		      fallback = f;
		    }
		    return fallback;
		  }

		  return null;
		}

	/* 이미지 복사 버튼(클립보드에 PNG로 복사 → PPT에 Ctrl+V 가능) */
	// JS: profilePreview → PNG Blob → Clipboard로 쓰기
	async function imgToPngBlob(imgEl) {
		// imgEl.src 가 blob: / data: / https: 모두 대응
		const res = await fetch(imgEl.src);
		const blob = await res.blob();
		
		// 이미 PNG면 그대로
		if ((blob.type || "").toLowerCase() === "image/png") return blob;
		
		// PNG가 아니면 canvas로 PNG로 변환(권장: PPT 호환성)
		const bitmap = await createImageBitmap(blob);
		const canvas = document.createElement("canvas");
		canvas.width = bitmap.width;
		canvas.height = bitmap.height;
		const ctx = canvas.getContext("2d");
		ctx.drawImage(bitmap, 0, 0);
		
		return await new Promise(resolve => canvas.toBlob(resolve, "image/png", 1.0));
	}
		
	/* 이미지 복사 (클립보드에 저장하기) */
	async function copyPreviewImageToClipboard($tr) {
		const img = $tr.find("img.profilePreview")[0];
		if (!img || !img.src) {
		  alert("복사할 이미지가 없습니다.");
		  return;
		}
		
		// 보이는 상태 체크(선택)
		if (img.style.display === "none") {
		  alert("이미지가 표시된 상태에서 복사하세요.");
		  return;
		}
		
		try {
		  // 반드시 “사용자 클릭” 이벤트 안에서 실행되어야 함
		  const pngBlob = await imgToPngBlob(img);
		
		  await navigator.clipboard.write([
		    new ClipboardItem({ "image/png": pngBlob })
		  ]);
		
		  alert("이미지를 클립보드에 복사했습니다. Ctrl+V 하세요.");
		} catch (e) {
		  console.log(e);
		  alert("이미지 복사 실패: 브라우저 권한/정책 제한일 수 있습니다. (HTTPS/권한 허용 필요)");
		}
	}

	// ======================================이미지 함수 로직 End======================================
		
	// tbody 기준으로 현재 최대 seq를 스캔해서 초기화
	function initTripSeqFromTable() {
	  let maxSeq = 0;
	  $('#tripTable tbody tr.tripArea').each(function() {
	    const v = $(this).find('[name=workRptNoSeq]').val();
	    const n = parseInt(v, 10);
	    if (!isNaN(n) && n > maxSeq) maxSeq = n;
	  });
	  nextTripSeq = maxSeq;
	}
	
</script>