<!DOCTYPE html>
<html lang="ko">
<style>



    #ax5ui-detail td[data-ax5grid-column-colindex="12"][data-ax5grid-column-row="1"],
    div[data-ax5grid="ordrs-detail"] td[data-ax5grid-column-colindex="12"][data-ax5grid-column-row="1"],

    #ax5ui-detail td[data-ax5grid-column-colindex="17"][data-ax5grid-column-row="1"],
    div[data-ax5grid="ordrs-detail"] td[data-ax5grid-column-colindex="17"][data-ax5grid-column-row="1"]
    {
        background-color: #FFB16D!important;
        background-image: none !important;

    }

    #ax5ui-detail td[data-ax5grid-column-colindex="15"][data-ax5grid-column-row="1"],

    div[data-ax5grid="ordrs-detail"] td[data-ax5grid-column-colindex="15"][data-ax5grid-column-row="1"]
    {
        background-color: #98FB98!important;
        background-image: none !important;


    }

    td[data-ax5grid-column-key="estEpctMatPrc"] {
        background-color: #D8BFD8!important;
        background-image:none!important;

    }


    .ordar, .file {
        background-color: white;
        visibility: hidden;
    }

    .grid-cell-blue {
        background: #dcf0f8;
    }

    .file, .ordar {

        min-height: 800px;
        float: left;
    }


    ul.ul_list.type03-est li {
        width: calc(100% - 6px);
        float: left;
    }

    ul.ul_list.type03-est li:nth-child(odd) {
        clear: left;
    }

    ul.ul_list.type03-est li + li {
    }

    @media only screen and (max-width: 767px) {
        .file, .ordar {
            width: 100%;
        }
    }

    @media only screen and (min-width: 768px) {
        .file, .ordar {
            width: 50%;
        }

    }
</style>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">

<script src="/static/js/jquery-latest.min.js"></script>
<script src="/static/js/jquery.serializeObject.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script src="/static/js/moment/moment-with-locales.js"></script>
<script src="/static/js/jstree/jstree.min.js"></script>
<script src="/static/js/ax5/ax5core.min.js"></script>
<script src="/static/js/ax5/ax5grid.min.js"></script>
<script src="/static/js/ax5/ax5mask.min.js"></script>
<script src="/static/js/ax5/ax5modal.min.js"></script>
<script src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5calendar.min.js"></script>
<script src="/static/js/ax5/ax5picker.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script src="/static/js/ax5/ax5formatter.min.js"></script>
<script src="/static/js/ax5/ax5combobox.min.js"></script>
<script src="/static/js/ax5/ax5select.min.js"></script>

<script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="/static/js/global.js"></script>
<script src="/static/js/fileTree.js"></script>
</head>

<body>
<div id="head_area"></div>
<div id="top_area"></div>

<div id="main_area">
    <!-- 페이지 상단 -->
    <div class="contents no_bg">
        <ul class="btn_ul">
            <li class="btn_r">
                <a onclick="initSearch();">
                    <button class="bg_gray">초기화</button>
                </a>
                <a onclick="gridView.setData(0);">
                    <button class="bg_gray">검 색</button>
                </a>
            </li>
        </ul>
    </div>
    <!-- 검색 콘텐츠 -->
    <div class="contents search">
        <div class="">
            <!-- 테이블 인풋 3분할 -->
            <table class="table_input type04">
                <tr>
                    <th class="hit">회사</th>
                    <td>
                        <select id="coCd_S" style="width:100%;" data-kind="CO" onchange="gridView.setData(0);"
                                required="required">
                            <option value="">전체</option>
                        </select>
                    </td>
                    <th class="hit">수주일자</th>
                    <td>
                        <div class="date_input">
                            <input type="text" id="strtDt_S" class="input_calendar" autocomplete="off"
                                   required="required" data-search="strtDt_S">
                            <span>~</span>
                            <input type="text" id="endDt_S" class="input_calendar" autocomplete="off"
                                   required="required" data-search="endDt_S">
                        </div>
                    </td>
                    <th class="">고객사</th>
                    <td>
                        <input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S">
                        <div class="search_form">
                            <input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S"
                            >
                            <a onclick="opendClntSearch($('#ordrsClntNm_S').val());">
                                <i class="i_search_w"></i>
                            </a>
                        </div>
                    </td>


                </tr>


                <tr>
                    <th class="">수주번호</th>
                    <td>
                        <div class="search_form">
                            <input type="text" id="ordrsNo_S" name="ordrsNo_S"
                            >
                            <a onclick="opendOrdrsSearch($('#ordrsNo_S').val(), $('#coCd_S').val());">
                                <i class="i_search_w"></i>
                            </a>

                        </div>


                    </td>
                    <th class="">고객사PJT</th>
                    <td>
                        <div class="search_form">
                            <input onclick="" type="text" id="clntPjt_S" name="" class=""
                            >

                        </div>

                    </td>
                    <th class="">계약명</th>
                    <td>
                        <div class="search_form">
                            <input type="text" id="ctrtNm_S" name="ctrtNm" class="modal-ctrtNm"
                            >

                        </div>

                    </td>
                    <th class="" style="position:relative;left:-70px;padding:0px">수주구분</th>
                    <td style="position:relative;left:-50px;">
                        <select id="ordrsDiv_S" style="width:90px" data-kind="ORDRSDIV" onchange="gridView.setData(0);">
                            <option value="">전체</option>
                        </select>
                    </td>
                </tr>
                <tr>

                </tr>
            </table>
        </div>
    </div>
    <div class="contents no_bg">
        <!-- 콘텐츠 타이틀 -->
        <div class="contents_tit">

            <div class="add_btn_small pdl10">
                <a onclick="insertProjectModal('C')" style="height: 30px; line-height: 28px;" authchk>+</a>
                <a onclick="deleteEst()" style="height: 30px; line-height: 28px;" authchk>-</a>
            </div>
            <select class="prae_select" onchange="gridView.setData(0);" id="recordCnt" style="height:100%;">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="9999999">전체</option>
            </select>


            <div class="add_btn_small pdr10">

                <!--				<a onclick="setReportMain();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-print"></i>견적서출력</a>-->
            </div>
            <!-- <input type="hidden" id="recordCnt"> -->
            <input type="hidden" id="basisPriceSeq">
        </div>
    </div>
    <div class="contents">
        <div class="ax5_grid">
            <ul class="ul_list type03-est">
                <li>

                    <div>
                        <div data-ax5grid="first-grid" data-ax5grid-config="{}"
                             style="height: 680px; width: 100%"></div>
                    </div>

                </li>
            </ul>


        </div>
    </div>

</div>

</body>


<script type="text/javascript">


    var authId = null;
    var authRole = null;
    var actionType = null;
    var firstGrid = null;


    function downloadFile(fileKey) {
        postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function (data) {
            var fileInfo = data.fileInfo;
            var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName, "UTF-8");
            location.href = "/admin/cm/cm08/fileDownload?filePath=" + filePath;
        });
    }


    var originalData = [
        // 데이터를 여기에 넣습니다.
    ];

    function filterData() {
        var searchInput = document.getElementById("search-input");
        var searchTerm = searchInput.value;
        var filteredData = originalData.filter(function (item) {
            // 여기에서는 'estNo' 필드를 필터링 기준으로 사용했습니다.
            // 필요한 경우 다른 필드를 사용하거나 여러 필드를 동시에 검색할 수 있습니다.
            return item.estNo && item.estNo.toLowerCase().includes(searchTerm.toLowerCase());
        });
        firstGrid.setData(filteredData);
    }

    var gridView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                showLineNumber    : true,
				showRowSelector   : false,
				multipleSelect    : true,
				sortable          : false,
                target: $('[data-ax5grid="first-grid"]'),
                header: {
                    align: "center",
                    selector: false
                },
                body: {
                	mergeCells : ["fileTrgtKey", "coCd", "coNm", "ordrsNo", "ioDt", "clntCd", "clntNm"],
                    onClick: function () {
    						var list = gridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                                gridView.target.select(obj.__index, {selected: false});
                            });
    	                    this.self.select(this.dindex);
//                         $("#ax5ui-plan,#ax5ui-detail").show();

//                         handleClickMainEvent(this.item);

                    },
                    onDBLClick: function () {

//                         this.self.select(this.dindex);
//                         var item = this.item; // 선택된 행의 데이터
//                         var coCd = item.coCd;
//                         var ordrsNo = item.ordrsNo;
//                         var estNo = item.estNo; // 선택된 행의 coCd 값

//                         // selectEstInfo 함수 호출
//                         var paramObj = {
//                             "coCd": coCd,
//                             "estNo": estNo,
//                             "ordrsNo": ordrsNo
//                         };
//                         handleClickEvent(this.item);
//                         $(".ordar").css("visibility", "visible");
                    	insertProjectModal("U");

                    },
                },
                page: {
                    navigationItemCount: 10,
                    height: 30,
                    display: true,
                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    
                    onChange: function () {
                        gridView.setData(this.page.selectPage);
                    }
                },

                /*
                * TB_CR02M01
                *
                *
                * */
                columns: [

                	{key: "fileTrgtKey", label: "파일대상KEY"  , align: "center", width: 50 , hidden: true},
                    {key: "coCd", label: "회사코드", align: "center", width: 100, enableFilter: true, hidden: true},
                    {key: "coNm", label: "회사명", align: "center", width: 100, enableFilter: true,},
                    {key: "ordrsNo", label: "수주번호", align: "center", width: 100},
                    {key: "ioDt", label: "수주일자", align: "center", width: 100},
                    {key: "clntCd", label: "고객사코드", align: "center", width: 100, hidden: true},
                    //{key: "ordrsClntNm", label: "고객사명", align: "center", width: 100},
                    {key: "clntNm", label: "고객사명", align: "center", width: 100},
                    {key: "clntPjt", label: "고객사PJT", align: "center", width: 100},
                    {key: "ctrtNm", label: "계약명", align: "center", width: 100},
                    //{key: "currNm", label: "통화단위", align: "center", width: 100},f
                    {key: "ordrsAmt", label: "수주금액", align: "right", width: 100, formatter: "money"},
                    {key: "estNo", label: "견적서번호", align: "center", width: 100, enableFilter: true},
                    //{key: "fwdExchJoinDt", label: "선물환가입일", align: "center", width: 100},
                    //{key: "fwdExchChkList", label: "선물환 Check List", align: "center", width: 100},
//                    {key: "ordrger", label: "발주자", align: "center", width: 100},
//                    {key: "mngId", label: "담당자", align: "center", width: 100},
//                    {key: "ctrtDoc", label: "계약문서", align: "center", width: 100},
//                    {key: "pmntMtdNm", label: "결재방법", align: "center", width: 100},
                    {key: "pid"        , label: "PID"      , align: "center", width: 150, hidden: true},
					{key: "id"         , label: "ID"       , align: "center", width: 150, hidden: true},
					{key: "treeId"     , label: "순번"       , align: "left"  , width: 100 , hidden: false, treeControl: true},
					{key: "lvl"        , label: "lvl"     , align: "center", width: 80 , hidden: true},
                    //TB_CR02D02테이블 컬럼
                    {key: "ioSeq", label: "수주seq", align: "right", width: 60, hidden: true},
                    {key: "ordrsDtlDiv10Nm", label: "입력구분", align: "center", width: 80},
                    {key: "prdtCd", label: "제품구분코드", align: "center", width: 80, hidden: true},
                    {key: "prdtNm", label: "제품구분", align: "center", width: 80},
                    {key: "itemDiv", label: "아이템구분코드", align: "center", width: 80, hidden: true},
                    {key: "itemDivNm", label: "아이템구분", align: "center", width: 80},
                    {key: "ordrsDtlDiv20Nm", label: "작업구분", align: "center", width: 80},
                    {key: "ordrsDtlDiv30Nm", label: "자체구분", align: "center", width: 80},
                    {key: "eqpNm", label: "설비명", align: "center", width: 80},
                    {key: "ordrsPrcMach", label: "기계Part", align: "right", formatter: "money", width: 80},
                    {key: "ordrsPrcElcty", label: "전기Part", align: "right", formatter: "money", width: 80},
                    {
                        key: "ordrsPrc", label: "합계", align: "right", width: 80,
                        formatter: function () {
                            color = '#0000FF';
                            const ordrsPrcMach = isNaN(parseFloat(this.item.ordrsPrcMach)) ? 0 : parseFloat(this.item.ordrsPrcMach);
                            const ordrsPrcElcty = isNaN(parseFloat(this.item.ordrsPrcElcty)) ? 0 : parseFloat(this.item.ordrsPrcElcty);
                            const sum = ordrsPrcMach + ordrsPrcElcty;
                            return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
                        }
                    },
                    {key: "ordrsQty", label: "수량", align: "right", width: 60},
                    {key: "estEpctMatPrc", label: "견적 예상 재료비",  formatter: "money", align: "right", width: 80},
                    {key: "trgtPchsPcostMach", label: "기계",  formatter: "money", align: "right", width: 80},
                    {key: "trgtPchsPcostElcty", label: "전기", formatter: "money", align: "right", width: 80},
                    {
                        key: "sum",
                        label: "합계",
                        align: "right",
                        width: 80,
                        formatter: function () {
                            color = '#0000FF';
                            const trgtPchsPcostMach = isNaN(parseFloat(this.item.trgtPchsPcostMach)) ? 0 : parseFloat(this.item.trgtPchsPcostMach);
                            const trgtPchsPcostElcty = isNaN(parseFloat(this.item.trgtPchsPcostElcty)) ? 0 : parseFloat(this.item.trgtPchsPcostElcty);
                            const sum = trgtPchsPcostMach + trgtPchsPcostElcty;
                            return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
                        }
                    },
                    {key: "trgtPchsPcostInHousePrcsn", label: "자체가공",  formatter: "money", align: "right", width: 80},
                    {
                        key: "machineValueAfterDeduction",
                        label: "차감 후 기계값",
                        align: "right",
                        width: 120,
                        formatter: function () {
                            color = '#0000FF';
                            const trgtPchsPcostMach = isNaN(parseFloat(this.item.trgtPchsPcostMach)) ? 0 : parseFloat(this.item.trgtPchsPcostMach);
                            const trgtPchsPcostInHousePrcsn = isNaN(parseFloat(this.item.trgtPchsPcostInHousePrcsn)) ? 0 : parseFloat(this.item.trgtPchsPcostInHousePrcsn);
                            const sum = trgtPchsPcostMach - trgtPchsPcostInHousePrcsn;
                            return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
                        }
                    },
                    {key: "laborCostMfgCost", label: "금액",  formatter: "money", align: "right", width: 80},
                    
                    {key: "creatId", label: "생성자", align: "left", width: 80,},
                    {key: "creatDttm", label: "생성일시", align: "left", width: 80,},
                    {key: "udtId", label: "수정자", align: "left", width: 80,},
                    {key: "udtDttm", label: "수정일시", align: "left", width: 80,},

                ],
                tree : {
					use         : true,
					indentWidth : 15,
					arrowWidth  : 15,
					iconWidth   : 18,
					icons: {
						openedArrow        : '<i class="fa fa-caret-down"  aria-hidden="true"></i>',
						collapsedArrow     : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
						groupIcon          : '<i class="fa fa-folder-open" aria-hidden="true"></i>',
						collapsedGroupIcon : '<i class="fa fa-folder"      aria-hidden="true"></i>',
						itemIcon           : '<i class="fa fa-file"        aria-hidden="true"></i>'
					},
					columnKeys : {
						parentKey : "pid",
						selfKey   : "id"
					}
				}

            });
            return this;
        },
        setData: function (_pageNo) {
        	
        	var formData = {};
            var gridViewIn = this.target;
            if (inputValidation($('input[required]'))) {	
				formData["coCd"] = $("#coCd_S").val();
				formData["strtDt"] = $("#strtDt_S").val().replace(/\-/g, '');
				formData["endDt"] = $("#endDt_S").val().replace(/\-/g, '');
				formData["prdtCd"] = $("#prdtCd").val();
				formData["taxivcCoprt"] = $("#taxivcCoprt").val();
				formData["prdtGrp"] = $("#prdtGrp_S").val();
				formData["searchValue"] = $("#searchValue_S").val();
				formData["searchName"] = $("#searchName_S").val();
				formData["winbdYn"] = $("#winbdYn_S").val();
				formData["pageNo"] = _pageNo + 1;
				formData["recordCnt"] = $("#recordCnt").val();
				formData["clntCd"] = $("#ordrsClntCd_S").val();
				formData["clntNm"] = $("#ordrsClntNm_S").val();
				formData["ctrtNm"] = $("#ctrtNm_S").val();
				formData["ordrsNo"] = $("#ordrsNo_S").val();
				formData["clntPjt"] = $("#clntPjt_S").val();
				formData["ordrsDiv"] = $("#ordrsDiv_S").val();

                postAjax("/user/cr/cr02/selectOrdrsList", formData, null, function (data) {
                    console.log(_pageNo);
                    var list = data.ordrsList;
  
                    originalData = list;

                    gridViewIn.setData({
   	                 list: list,
   	                 page: {
   	                     currentPage: _pageNo,
   	                     pageSize: data.paginationInfo.pageSize,
   	                     totalElements: data.paginationInfo.totalRecordCount,
   	                     totalPages: data.paginationInfo.totalPageCount
   	
   	                 }
   	             });
                    
                    function getClientNameByCode(ordrsClntCd, callback) {
                        var paramObj = {
                            "clntCd": ordrsClntCd
                        };

                        postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function (data) {
                            if (data && data.clntInfo) {
                                callback(data.clntInfo.clntNm);
                            } else {
                                callback('');
                            }
                        });
                    }
                   

//                     if (list.length === 0) {
//                         gridViewIn.setData({
//                             list: [],
//                             page: {
//                                 currentPage: _pageNo,
//                                 pageSize: data.paginationInfo.pageSize,
//                                 totalElements: data.paginationInfo.totalRecordCount,
//                                 totalPages: data.paginationInfo.totalPageCount
//                             }
//                         });

//                     } else {

//                         var completedRequests = 0;

//                         for (var i = 0; i < list.length; i++) {
//                             (function (index) {
//                                 getClientNameByCode(list[index].ordrsClntCd, function (clientName) {
//                                     list[index].ordrsClntNm = clientName;
//                                     completedRequests++;

//                                     if (completedRequests === list.length) {
//                                         gridViewIn.setData({
//                                             list: list,
//                                             page: {
//                                                 currentPage: _pageNo,
//                                                 pageSize: data.paginationInfo.pageSize,
//                                                 totalElements: data.paginationInfo.totalRecordCount,
//                                                 totalPages: data.paginationInfo.totalPageCount

//                                             }
//                                         });
//                                     }
//                                 });
//                             })(i);
//                         }

//                     }


                });
            }
        }
    }


    var thisGridRow = "";
    var thisGridCol = "";
    /* 그리드 관련 함수 */
    // 그리드 생성
//     const gridOrdrsMainPlan = new ax5.ui.grid();
//     gridOrdrsMainPlan.setConfig({
//         target: $('[data-ax5grid="ordrs-main-plan"]'),
//         header: {
//             align: "center",
//             selector: false
//         },
//         columns: [
//             {
//                 key: "seq", label: "번호", width: 60, align: "center", formatter: function () {
//                     return this.item.__index + 1;
//                 },
//             },

//             {
//                 key: "clmnPlanDiv",
//                 label: "수금구분",
//                 width: 60,
//                 align: "center",
//                 editor: false
//             },
//             {key: "clmnDivSeq", label: "차수", width: 60, align: "center", editor: false},
//             {
//                 key: "clmnRate",
//                 label: "비율",
//                 width: 60,
//                 align: "center",
//                 editor: false,
//                 formatter: function () {
//                     // 셀 값 뒤에 '%'를 추가합니다.
//                     return '<div style="">' + this.item.clmnRate + '%</div>';
//                 }
//             },
//             {
//                 key: "clmnAmt",
//                 label: "수금금액",
//                 width: 95,
//                 align: "right",
//                 editor: false,

//             },
//             {
//                 key: "billPblsDt",
//                 label: "계산서발행일자",
//                 width: 120,
//                 align: "center",
//                 editor: false,
//                 formatter: function () {
//                     var clmnDt = new Date(this.item.clmnDt || new Date());
//                     clmnDt.setDate(clmnDt.getDate() - (this.item.pmntDtAfterBill || 0));
//                     var month = String(clmnDt.getMonth() + 1).padStart(2, '0');
//                     var day = String(clmnDt.getDate()).padStart(2, '0');
//                     var year = clmnDt.getFullYear();
//                     return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
//                 }
//             },
//             {key: "clmnDt", label: "수주수금일자", width: 120, align: "center", editor: false},
//             {
//                 key: "pmntDtAfterBill",
//                 label: "계산서 발행 후 지급시기(단위: 일)",
//                 width: 240,
//                 align: "center",
//                 editor: false
//             },

//             {key: "clmnPlanRmk", label: "수금관리상황", width: 460, align: "left", editor: false},

//         ],
//         footSum: [
//             /*     [
//                      {label: "총합계", align: "center", colspan: 7},
//                      {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
//                  ]*/
//         ],
//         body: {

//             onClick: function () {
//                 this.self.clearSelect();
//                 this.self.select(this.dindex);
//                 selectedRowKey = this.dindex;
//             }
//         },
//         contextMenu: {
//             iconWidth: 20,
//             acceleratorWidth: 100,
//             itemClickAndClose: false,
//             icons: {
//                 'arrow': '<i class="fa fa-caret-right"></i>'
//             },
//             items: [
//                 {type: 1, label: "붙여넣기"},
//                 {divide: true},
//                 {
//                     label: "작업선택",
//                     items: [
//                         {type: 1, label: "줄추가"},
//                         {type: 1, label: "내용 삭제"},
//                         {type: 2, label: "줄삭제"},
//                     ]
//                 },
//             ],
//             popupFilter: function (item, param) {
//                 //console.log(item, param);
//                 if (param.element) {
//                     return true;
//                 } else {
//                     return item.type == 1;
//                 }
//             },
//             onClick: function (item, param) {
//                 console.log(item, param);
//                 thisGridRow = param.dindex;
//                 thisGridCol = param.colIndex;

//                 if (item.label == "붙여넣기") {
//                     gridPaste(thisGridRow, thisGridCol);
//                 } else if (item.label == "줄추가") {
//                     console.log('추가 인덱스 :', param.dindex);
//                     //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
//                     gridOrdrsMainPlan.addRow($.extend({}, gridOrdrsMainPlan.list[param.dindex], {__index: undefined}), param.dindex + 1,);
//                     gridOrdrsMainPlan.setValue(param.dindex, 'updcheck', 1);

//                 } else if (item.label == "내용 삭제") {
//                     console.log('내용삭제 인덱스 :', param.dindex);

//                     gridOrdrsMainPlan.config.columns.forEach((column) => {
//                         gridOrdrsMainPlan.setValue(param.dindex, column.key, '');
//                         gridOrdrsMainPlan.setValue(param.dindex, 'updcheck', 1);
//                         console.log('내용삭제 :', param.dindex, column.key);
//                     });

//                 } else if (item.label == "줄삭제") {
//                     console.log('삭제 인덱스 :', param.dindex);
//                     gridOrdrsMainPlan.removeRow(param.dindex);
//                     //삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
// // 		                		gridOrdrsMainPlan.setValue(param.dindex, 'delcheck', 1);
//                 }


//                 gridOrdrsMainPlan.contextMenu.close();
//                 //또는 return true;
//             }
//         },


//     });
//     gridOrdrsMainPlan.onDataChanged = function () {

//         const data = gridOrdrsMainPlan.getList();
//         gridOrdrsMainPlan.setData(data);

//     };


    function fetchCurrencyData() {
        var paramObj = {"codeKind": "ORDRSDTLDIV10", "useYn": "Y"};
        var paramObj2 = {"codeKind": "ITEMLIST", "useYn": "Y"};
        var paramObj3 = {"codeKind": "ORDRSDTLDIV20", "useYn": "Y"};
        var paramObj4 = {"codeKind": "ORDRSDTLDIV30", "useYn": "Y"};

        var promise1 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options = codeList.map(function (code) {
                        return {
                            value: code.codeId,
                            text: code.codeNm
                        };
                    });
                    resolve(options);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        var promise2 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj2, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options2 = codeList.map(function (code) {
                        return {
                            value: code.codeId,
                            text: code.codeNm
                        };
                    });
                    resolve(options2);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        var promise3 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj3, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options3 = codeList.map(function (code) {
                        return {
                            value: code.codeId,
                            text: code.codeNm
                        };
                    });
                    resolve(options3);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        var promise4 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj4, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options4 = codeList.map(function (code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options4);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        return Promise.all([promise1, promise2, promise3, promise4]);
    }

//     const gridOrdrsMainDetail = new ax5.ui.grid();
//     fetchCurrencyData().then(function ([options, options2, options3, options4]) {
        // 그리드 생성

//         gridOrdrsMainDetail.setConfig({
//             target: $('[data-ax5grid="ordrs-main-detail"]'),
//             header: {
//                 align: "center",
//                 selector: false
//             },
//             columns: [
//                 {
//                     key: "seq", label: "No", width: 40, align: "center", formatter: function () {
//                         return this.item.__index + 1;
//                     },
//                 },

//                 {
//                     key: "ordrsDtlDiv10",
//                     label: "입력구분",
//                     width: 80,
//                     align: "center",
//                     editor: {
//                         type: "select",
//                         config: {
//                             columnKeys: {
//                                 optionValue: 'value',
//                                 optionText: 'text'
//                             },
//                             options: options
//                         }
//                     }
//                 },


//                 {key: "prdtCd", label: "제품구분", align: "center", width: 60, editor: {type: "text"}},
//                 {
//                     key: "itemDiv", label: "아이템구분", align: "center", width: 80,
//                     editor: {
//                         type: "select",
//                         config: {
//                             columnKeys: {
//                                 optionValue: 'value',
//                                 optionText: 'text'
//                             },
//                             options: options2
//                         }
//                     }
//                 },

//                 {
//                     key: "ordrsDtlDiv20", label: "작업구분", align: "center", width: 80,
//                     editor: {
//                         type: "select",
//                         config: {
//                             columnKeys: {
//                                 optionValue: 'value',
//                                 optionText: 'text'
//                             },
//                             options: options3
//                         }
//                     }
//                 },
//                 {
//                     key: "ordrsDtlDiv80", label: "자체구분", align: "center", width: 60,
//                     editor: {
//                         type: "select",
//                         config: {
//                             columnKeys: {
//                                 optionValue: 'value',
//                                 optionText: 'text'
//                             },
//                             options: options4
//                         }
//                     }
//                 },


//                 // {key: "salesCd", label: "영업코드", align: "center", width: 80, editor: {type: "text"}},
//                 {key: "eqpNm", label: "설비명", align: "center", width: 295, editor: {type: "text"}},

//                 {
//                     key: undefined, label: "수주가(단위:천원)", columns: [

//                         {
//                             key: "ordrsPrcMach",
//                             label: "기계PART",
//                             align: "right",
//                             width: 80,
//                             editor: {type: "number"},
//                             formatter: "money"
//                         },
//                         {
//                             key: "ordrsPrcElcty",
//                             label: "전기PART",
//                             align: "right",
//                             width: 80,
//                             editor: {type: "number"},
//                             formatter: "money"
//                         },
//                         {
//                             key: "ordrsPrc", label: "합계", align: "right", width: 80,
//                             formatter: function () {
//                                 color = '#0000FF';
//                                 const ordrsPrcMach = isNaN(parseFloat(this.item.ordrsPrcMach)) ? 0 : parseFloat(this.item.ordrsPrcMach);
//                                 const ordrsPrcElcty = isNaN(parseFloat(this.item.ordrsPrcElcty)) ? 0 : parseFloat(this.item.ordrsPrcElcty);
//                                 const sum = ordrsPrcMach + ordrsPrcElcty;
//                                 return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
//                             }
//                         },

//                     ]
//                 },


//                 {key: "ordrsQty", label: "수량", align: "right", width: 40, editor: {type: "number"}},
//                 {
//                     key: "estEpctMatPrc",
//                     label: "견적 예상 재료비(단위:천원)",
//                     align: "right",
//                     width: 180,
//                     editor: {type: "number"},
//                     formatter: "money"
//                 },

//                 {
//                     key: undefined, label: "목표구매원가(단위:천원)", columns: [

//                         {
//                             key: undefined, label: "목표구매원가", columns: [{
//                                 key: "trgtPchsPcostMach",
//                                 label: "기계",
//                                 align: "right",
//                                 width: 140,
//                                 editor: {type: "number"},
//                                 formatter: "money"
//                             },
//                                 {
//                                     key: "trgtPchsPcostElcty",
//                                     label: "전기",
//                                     align: "right",
//                                     width: 120,
//                                     editor: {type: "number"},
//                                     formatter: "money"
//                                 },
//                                 {
//                                     key: "sum",
//                                     label: "합계",
//                                     align: "right",
//                                     width: 80,
//                                     formatter: function () {
//                                         color = '#0000FF';
//                                         const trgtPchsPcostMach = isNaN(parseFloat(this.item.trgtPchsPcostMach)) ? 0 : parseFloat(this.item.trgtPchsPcostMach);
//                                         const trgtPchsPcostElcty = isNaN(parseFloat(this.item.trgtPchsPcostElcty)) ? 0 : parseFloat(this.item.trgtPchsPcostElcty);
//                                         const sum = trgtPchsPcostMach + trgtPchsPcostElcty;
//                                         return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
//                                     }
//                                 }

//                             ]
//                         },
//                         {
//                             key: undefined, label: "자체가공 투입시 기계부문 목표원가", columns: [

//                                 {
//                                     key: "trgtPchsPcostInHousePrcsn",
//                                     label: "자체 가공",
//                                     align: "right",
//                                     width: 200,
//                                     editor: {type: "number"},
//                                     formatter: "money"
//                                 },
//                                 {
//                                     key: "machineValueAfterDeduction",
//                                     label: "차감 후 기계값",
//                                     align: "right",
//                                     width: 120,
//                                     formatter: function () {
//                                         color = '#0000FF';
//                                         const trgtPchsPcostMach = isNaN(parseFloat(this.item.trgtPchsPcostMach)) ? 0 : parseFloat(this.item.trgtPchsPcostMach);
//                                         const trgtPchsPcostInHousePrcsn = isNaN(parseFloat(this.item.trgtPchsPcostInHousePrcsn)) ? 0 : parseFloat(this.item.trgtPchsPcostInHousePrcsn);
//                                         const sum = trgtPchsPcostMach - trgtPchsPcostInHousePrcsn;
//                                         return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
//                                     }
//                                 },
//                             ]
//                         }
//                     ]
//                 },

//                 {
//                     key: undefined, label: "실집행 원가", columns: [
//                         {
//                             key: undefined, label: "노무비 및 제조경비(판관비 제외)", columns: [
//                                 {
//                                     key: "laborCostMfgCost",
//                                     label: "금액",
//                                     align: "right",
//                                     width: 180,
//                                     editor: {type: "number"},
//                                     formatter: "money"
//                                 },
//                             ]
//                         }
//                     ]
//                 }
//             ],
//             footSum: [
//                 /*      [
//                           {label: "총합계", align: "center", colspan: 7},
//                           {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
//                       ]*/
//             ],
//             body: {
//                 onClick: function () {
//                     this.self.select(this.dindex);
//                     thisGridRow = this.dindex;
//                     thisGridCol = this.colIndex;
//                     selectedRowKey = this.dindex;
//                 },
//                 columnHeight: 26,
//                 onDataChanged: function () {
//                     gridOrdrsMainDetail.repaint();
//                     const data = gridOrdrsMainDetail.getList();
//                     gridOrdrsMainDetail.setData(data);
//                     if (this.key == 'isChecked') {
//                         this.self.updateChildRows(this.dindex, {isChecked: this.item.isChecked});
//                     } else if (this.key == '__selected__') {
//                         this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
//                     }

//                 }
//             },
//             contextMenu: {
//                 iconWidth: 20,
//                 acceleratorWidth: 100,
//                 itemClickAndClose: false,
//                 icons: {
//                     'arrow': '<i class="fa fa-caret-right"></i>'
//                 },
//                 items: [
//                     {type: 1, label: "붙여넣기"},
//                     {divide: true},
//                     {
//                         label: "작업선택",
//                         items: [
//                             {type: 1, label: "줄추가"},
//                             {type: 1, label: "내용 삭제"},
//                             {type: 2, label: "줄삭제"},
//                         ]
//                     },
//                 ],
//                 popupFilter: function (item, param) {
//                     //console.log(item, param);
//                     if (param.element) {
//                         return true;
//                     } else {
//                         return item.type == 1;
//                     }
//                 },
//                 onClick: function (item, param) {
//                     console.log(item, param);
//                     thisGridRow = param.dindex;
//                     thisGridCol = param.colIndex;

//                     if (item.label == "붙여넣기") {
//                         gridPaste(thisGridRow, thisGridCol);
//                     } else if (item.label == "줄추가") {
//                         console.log('추가 인덱스 :', param.dindex);
//                         //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
//                         gridOrdrsMainDetail.addRow($.extend({}, gridOrdrsMainDetail.list[param.dindex], {__index: undefined}), param.dindex + 1,);
//                         gridOrdrsMainDetail.setValue(param.dindex, 'updcheck', 1);

//                     } else if (item.label == "내용 삭제") {
//                         console.log('내용삭제 인덱스 :', param.dindex);

//                         gridOrdrsMainDetail.config.columns.forEach((column) => {
//                             gridOrdrsMainDetail.setValue(param.dindex, column.key, '');
//                             gridOrdrsMainDetail.setValue(param.dindex, 'updcheck', 1);
//                             console.log('내용삭제 :', param.dindex, column.key);
//                         });

//                     } else if (item.label == "줄삭제") {
//                         console.log('삭제 인덱스 :', param.dindex);
//                         gridOrdrsMainDetail.removeRow(param.dindex);
//                         //삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
// // 		                		gridOrdrsMainDetail.setValue(param.dindex, 'delcheck', 1);
//                     }


//                     gridOrdrsMainDetail.contextMenu.close();
//                     //또는 return true;
//                 }
//             }

//         });
//     })


    //화면로드시
    $(document).ready(function () {
        $("td").off("mouseover");
        mainDefaultLoad("영업관리", "수주 관리");
        setCommonSelect($("select[data-kind]"));

        $("#coCd_S").val(jwt.coCd);
        setByCoCd($("#coCd_S").val());
        // 시작일 (현재날짜의 월 첫일)
        $('#strtDt_S').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        })
            .datepicker("setDate", moment(new Date()).startOf("month").toDate())
            .on("changeDate", function () {
                gridView.setData(0);
                if ($('#strtDt_S').val() > $('#endDt_S').val()) {
                    alert("날짜를 확인해주세요");
                    $('#strtDt_S').datepicker("setDate", new Date($('#endDt_S').val()));
                }
            });

        // 종료일 (현재날짜의 월 말일)
        $('#endDt_S').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        })
            .datepicker("setDate", moment(new Date()).endOf("month").toDate())
            .on("changeDate", function () {
                gridView.setData(0);
                if ($('#strtDt_S').val() > $('#endDt_S').val()) {
                    alert("날짜를 확인해주세요");
                    $('#endDt_S').datepicker("setDate", new Date($('#strtDt_S').val()));
                }
            });

        gridView.initView().setData(0);


//         let intervalId = setInterval(function () {
//             // 선택자에 해당하는 요소를 가져옵니다.
//             let element = $('[data-ax5grid-data-o-index="0"]');

//             // 요소가 존재하면 클릭 이벤트를 트리거합니다.
//             if (element.length) {
//                 element.trigger('click');
//                 console.log('Click event triggered successfully');

//                 // 클릭 이벤트가 성공적으로 트리거되면 인터벌을 중지합니다.
//                 clearInterval(intervalId);
//             } else {
//                 console.log('Element not found, trying again...');
//             }
//         }, 1000);
    })

    function initSearch() {

        $(".contents.search input[type='text']").val("");
        $("#searchValue_S option").eq(0).prop("selected", true);
        $("#coCd_S").val(jwt.coCd);
        //$("#strtDt_S").val(lastMonth());
        $("#strtDt_S").val(dateToStr(moment(new Date()).startOf("month").toDate()));
        $("#endDt_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
        gridView.initView().setData(0);
    }

    function deleteEst() {
        var row = gridView.target.getList("selected")[0];
        var formData = {
        	"fileTrgtKey" : row.fileTrgtKey,
        	"estNo" : row.estNo,
            "coCd": row.coCd,
            "lvl" : row.lvl,
            "ordrsNo": row.ordrsNo,
            "ordrsSeq": row.ioSeq,
            "userId" : jwt.userId,
            "fileTrgtTyp" : "CR0201M01"
        }

        if (confirm("삭제하시겠습니까?")) {
            deleteAjax("/user/cr/cr02/deleteOrdrs", formData, null, function (data) {
                if (data.resultCode == 200) {
                    alert(data.resultMessage);

                }
                gridView.setData(0);
            });
        }
    }

    function setReportMain() {
        var row = gridView.target.getList("selected")[0];
        var iChk;
        var rptName;
        if (row == undefined) {
            alert("출력할 견적자료를 선택하세요!");
            return;
        }


        var paramObj = {
            "iChk": iChk
        }
        openSecondModal("/static/html/user/cr/cr01/CR0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
            var arg = "i_est_no#" + row.estNo + "#"
                + "iChk#" + iChk + "#"
                + "imgPrt#" + imgPrt + "#";
            callReport(rptName, arg, 750, 900);
        });
    }

    // 판매법인 set
    function setByCoCd(value) {
        $('#main_area #taxivcCoprt').data("rprc", value);
        $('#main_area #taxivcCoprt option:not([value=""])').remove()
        setCommonSelect($('#main_area #taxivcCoprt'));
    }


    async function handleClickEvent(item) {
        updateProjectModal(item)

    }


    function insertProjectModal(type) {
    	if (type == 'U'){ //수정일때
    		var row = gridView.target.getList("selected")[0];

    		var paramObj = {
    			"actionType"  : type,
    			"fileTrgtKey" : row.fileTrgtKey,
    			"coCd"        : row.coCd,
    			"userId"      : jwt.userId,
    			"pgmId"       : "CR0201M01"
    		};
    	}
    	else {//신규등록일때
    		var paramObj = {
        			"actionType"  : type,
        			"fileTrgtKey" : 0,
        			"coCd"        : jwt.coCd,
        			"userId"      : jwt.userId,
        			"pgmId"       : "CR0201M01"
        		};
    	}

        openModal("/static/html/user/cr/cr02/CR0202P01.html", 1800, 835, "", paramObj,  function(data) {
        	DataSearch();
        });
    }

    function updateProjectModal(item) {
        var paramObj = {"actionType": "U", "coCd": item.coCd, "ordrsNo": item.ordrsNo, "fileTrgtKey": item.fileTrgtKey};
        openModal("/static/html/user/cr/cr02/CR0202P01.html", 1450, 736, "", paramObj);
    }

    function opendClntSearch(inputValue) {
        openModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: inputValue}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#ordrsClntCd_S').val(row.clntCd);
            $('#ordrsClntNm_S').val(row.clntNm);
            gridView.setData(0);
        });
    }

    function opendOrdrsSearch(inputValue, coCd) {
    	var paramObj = {
    			"searchValue" : inputValue,
    			"coCd" : coCd
    		};
    	
        openModal("/static/html/cmn/modal/ordrsSearch.html", 800, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#ordrsNo_S').val(row.ordrsNo);
            gridView.setData(0);
        });
    }

    function handleClickMainEvent(item) {
        //updateDetailGrid(item)

    }


    function updateDetailGrid(item) {
        var paramObj = {
            "actionType": "U",
            "coCd": item.coCd,
            "estNo": item.estNo,
            "fileTrgtKey": item.fileTrgtKey,
            "ordrsNo": item.ordrsNo
        };
        postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {


            var pmntPlans = data.ordrsInfo.plans;


            gridOrdrsMainPlan.setData({
                list: pmntPlans,
                page: {
                    totalElements: pmntPlans.length
                }
            });

            var ordrsDetails = data.ordrsInfo.details;

            gridOrdrsMainDetail.setData({
                list: ordrsDetails,
                page: {
                    totalElements: ordrsDetails.length
                }
            });


        });

    }

    $("#ordrsClntNm_S,#ordrsNo_S,#clntPjt_S,#ctrtNm_S").keypress(function (event) {
        if (event.keyCode == 13) {  // Enter 키의 키 코드는 13입니다.
            gridView.setData(0);
            event.preventDefault();  // 폼 제출 등의 기본 동작을 방지합니다.
        }
    });
    $("#ordrsDiv_S").change(function () {
        gridView.setData(0);
        event.preventDefault();  // 폼 제출 등의 기본 동작을 방지합니다.
    })

    function lastMonth() {
        var date = new Date();
        date.setMonth(date.getMonth() - 1);
        return date.toISOString().split('T')[0];
    }
</script>
</html>
