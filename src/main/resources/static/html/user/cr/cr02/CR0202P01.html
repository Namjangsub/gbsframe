
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="modal_tit_contents">
        <h4 id="modalTopSubMenu" class=""></h4>
    </div>
    <div class="popup_table">
        <input type="file" id="file" style="display: none" multiple="multiple" onchange="addFileToTree(this);"/>
        <form id="popForm">
            <input type="hidden" id="pgmId" name="pgmId" value="CR0101M01">

            <table>
                <tr>
                    <th class="hit">회사</th>
                    <td>
                        <select data-search="coCd" id="coCd" name="coCd" style="width:100%;" data-kind="CO"
                                required="required">
                            <option value="">전체</option>
                        </select>
                    </td>
                    <th class="hit">견적서번호</th>
                    <td>
                        <div class="search_form">
                            <input onclick="openSecondEstSearch();" type="text" id="estNo" name="estNo" readonly
                                   required>
                            <a onclick="openSecondEstSearch();">
                                <i class="i_search_w"></i>
                            </a>
                        </div>

                    </td>
                    <th class="hit">수주번호</th>
                    <td><input style="background-color:#ddd!important" data-search="ordrsNo" id="ordrsNo" type="text"
                               id="ordrsNo" name="ordrsNo" readonly ></td>
                    <th class="hit">수주일자</th>
                    <td><input type="text" class="input_calendar" autocomplete="off" id="ordrsDt" name="ordrsDt" date
                               required></td>
                </tr>
                <tr>
                    <th class="hit">수주구분</th>
                    <td>
                        <select id="ordrsDiv" name="ordrsDiv" required>
                            <option value="">선택하세요</option>
                            <option value="normal">정상</option>
                            <option value="paidAS">유상AS</option>
                            <option value="freeAS">무상AS</option>
                        </select>
                    </td>
                    <th class="hit">고객사</th>


                    <td>
                        <input type="hidden" id="ordrsClntCd" name="ordrsClntCd">
                        <div class="search_form">
                            <input onclick="openSecondClntSearch();" type="text" id="ordrsClntNm" name="ordrsClntNm"
                                   readonly required>
                            <a onclick="openSecondClntSearch();">
                                <i class="i_search_w"></i>
                            </a>
                        </div>
                    </td>

                    <th class="hit">고객사PJT</th>
                    <td><input type="text" id="clntPjt" name="clntPjt" required></td>
                    <th class="hit">통화단위</th>
                    <td><input type="text" id="currUnit" name="currUnit" required></td>
                </tr>
                <tr>
                    <th class="hit">계약명</th>
                    <td><input type="text" id="ctrtNm" name="ctrtNm" required></td>
                    <th class="hit">결제방법</th>
                    <td><input type="text" id="pmntMtd" name="pmntMtd" required></td>
                    <th class="hit">수주금액</th>
                    <td><input type="text" id="ordrsAmt" name="ordrsAmt" required></td>
                </tr>
                <tr>
                    <th class="hit">선물환가입일</th>
                    <td><input type="text" class="input_calendar" autocomplete="off" id="fwdExchJoinDt"
                               name="fwdExchJoinDt" date required></td>
                    <th class="hit">선물환CheckList</th>
                    <td><input type="text" id="fwdExchChkList" name="fwdExchChkList" required></td>
                    <th class="hit">발주자</th>
                    <td><input type="text" id="ordrger" name="ordrger" required></td>
                    <th class="hit">환율</th>
                    <td><input type="text" id="exchangeRate" name="exchangeRate" required></td>
                </tr>
                <tr>
                    <th class="hit">담당자</th>
                    <td><input type="text" id="mgr" name="mgr" required></td>
                    <th class="hit">계약문서</th>
                    <td><input type="text" id="ctrtDoc" name="ctrtDoc" required></td>
                    <th class="hit">수주비고</th>
                    <td><input type="text" id="ordrsRmk" name="ordrsRmk" required></td>
                    <th class="hit" ID="orgnSalesCdTh">원천SalesCode</th>
                    <td id="orgnSalesCdTd"><input type="text" id="orgnSalesCd" name="orgnSalesCd" required></td>

                </tr>

            </table>
        </form>
    </div>

    <br>
    <div class="popup_table" style="margin-top: 15px;">

        <div class="" style="padding-left: 0;">
            <div class="contents" style="margin:0px; padding:0px; height: 300px; width: 100%; min-width: 200px">
                <div style="float:right;">
                    <button data-value="계약금" data-target="gridOrdrsPlan" id="depositButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">계약금</button>
                    <button data-value="중도금" data-target="gridOrdrsPlan" id="installmentButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">중도금</button>
                    <button data-value="잔금" data-target="gridOrdrsPlan" id="balanceButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">잔금</button>
                    <button data-value="선급금" data-target="gridOrdrsPlan" id="advanceButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">선급금</button>
                    <button id="ordrsPlanDivButton" style="margin-right:8px;margin-top:8px;">섹션 추가</button>
                </div>
                <h3 class="location">
                    <a class="file_tag" id="file_tag"
                       style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                    <span class="page_tit" style="text-align: right;"></span>
                </h3>
                <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                    <div data-ax5grid="ordrs-plan" data-ax5grid-config="{}" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup_table" style="margin-top: 15px;">

        <div class="" style="padding-left: 0;">
            <div class="contents" style="margin:0px; padding:0px; height: 300px; width: 100%; min-width: 200px">
                <div style="float:right">

                    <button data-value="설비" data-target="gridOrdrsDetail" id="equipmentButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">설비</button>
                    <button data-value="부대비용" data-target="gridOrdrsDetail" id="additionalCostButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">부대비용</button>
                    <button data-value="추가비용" data-target="gridOrdrsDetail" id="extraCostButton" class="custom-btn" style="margin-right:8px;margin-top:8px;">추가비용</button>
                </div>
                <h3 class="location">
                    <a class="file_tag" id="file_tag"
                       style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                    <span class="page_tit" style="text-align: right;"></span>
                </h3>
                <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                    <div data-ax5grid="ordrs-detail" data-ax5grid-config="{}" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" style="margin-top: 15px;margin-bottom:40px;">
        <div class="col-xs-2" style="padding-right: 5px;">
            <div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
                <h3 class="location">
                    <span class="page_tit" style="text-align: left;"> 파일트리</span>
                </h3>
                <div id="treeview" style="height: 400px;padding: 5px">
                    <div id="deptTree"></div>
                </div>
            </div>
        </div>
        <div class="col-xs-10" style="padding-left: 0;">
            <div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
                <h3 class="location">
                    <a class="file_tag" id="file_tag"
                       style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
                    <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
                </h3>

                <button disabled type="button" id="button_file"class="" style="  background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk>
                    첨부파일
                </button>
                <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}"
                     style="height: 400px; width: 100%"></div>
            </div>
        </div>
    </div>
    <!-- 하단 버튼 -->
    <div class="fixed-bottom-btn">
        <div class="popup_bottom_btn">
            <button id="actionBtn" authchk>등록</button>
            <button class="close_btn" onclick="modalStack.close();">닫기</button>
        </div>
    </div>
</div>

<script type="text/javascript">

    /* 견적서함수 */
    //수주 번호 조회 함수
    function getMaxOrdrsNumber() {
        let coCd = $("#coCd").val();
        let paramObj = {
            coCd: coCd
        };
        /*      // Add any parameters needed for the request
              postAjax("/user/cr/cr02/maxOrdrsNo", paramObj, null, function (data) {
                  // Set the received maximum estimation number to the input field
                  $("#ordrsNo").val(data.maxOrdrsNo);
              });*/
    }

    $("#coCd").on("change", function () {
        getMaxOrdrsNumber();

    });

    // 견적 정보 조회 함수
    function selectEstInfo() {
        var paramObj = modalStack.last().paramObj;
        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            setEstInfo(data.estInfo);
        });
    }

    // 견적 정보 설정 함수
    function setEstInfo(estInfo) {
        //메인정보 세팅
        $.each(estInfo, function (key, value) {
            if ($('#' + key)[0]) {
                if ($('#' + key).is('[date]')) {
                    $('#' + key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
                } else {
                    if ($('#' + key).is('[comma]')) {
                        value = addCommaStr(value);
                    }
                    if (key == "coCd") {
                        setByCoCd(value)
                    }
                    $('#' + key).val(value);
                }
            }
        });


        $.each(estInfo.estDetailList, function (idx, obj) {
            if (idx != 0) addRow();
            $addedRow = $("tr[name='detailRow']:last");

            $.each($addedRow.find('[name]'), function (idx, elem) {
                var itemValue = obj[elem.name];
                if (itemValue) {
                    if ($(elem).is("[comma]")) {
                        itemValue = addCommaStr(itemValue);
                    }
                    $(elem).val(itemValue);
                }
            });
        });
        countTot();


        $.each(estInfo.estFileList, function (idx, obj) {
            fileArr.push({
                'fileKey': obj.fileKey,
                'fileName': obj.fileName,
                'fileType': obj.fileType,
                'fileSize': obj.fileSize,
                'file': obj
            });
        });


        /* 	fileGridView.setData(); */
    }

    // 거래처 검색 함수
    function openSecondClntSearch() {
        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#ordrsClntCd').val(row.clntCd);
            $('#ordrsClntNm').val(row.clntNm);

            var paramObj = {
                "coCd": $('#coCd').val(),
                "clntCd": row.clntCd
            }
            setMngInfo(paramObj);
        });
    }


    function openSecondEstSearch() {
        openSecondModal("/static/html/cmn/modal/estSearch.html", 600, 420, "견적서 검색", {}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#estNo').val(row.estNo);

            var paramObj = {
                "coCd": $('#coCd').val(),
                "clntCd": row.clntCd
            }
            setMngInfo(paramObj);
        });
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {

                $('#mgr').val(data.mngInfo.salesEmpNm);
            } else {

                $('#mgr').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch() {
        var paramObj = {
            "coCd": "GUN", //$('#coCd').val(),
            "userId": $('#salesEmpId').val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#salesEmpId").val(checkedNode.id);
            $("#salesEmpNm").val(checkedNode.text);
        });
    }


    // 제품 검색 함수
    function openSecondPrdtSearch(elem) {
        $targetRow = $(elem).closest('tr[name="detailRow"]');
        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#estClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            // 값 초기화
            $targetRow.find('input[name]').val("");
            // input 제어
            if (row.prdtStockCd == "Y") {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", false);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", false);
                $targetRow.find('input[name="estQty"]').attr("readonly", false);
                $targetRow.find('input[name="estWt"]').attr("readonly", false);
            } else {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", true);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", true);
            }
            $.each(row, function (key, value) {
                if ($targetRow.find('[name="' + key + '"]')[0]) {
                    $targetRow.find('[name="' + key + '"]').val(value);
                }
            });
            $targetRow.find('input[name="estUpr"]').val(row.ordrgUpr);

            countTot();
        });
    }

    // 현장 검색 함수
    function openSecondSiteSearch() {
        var paramObj = {
            "coCd": $('#popForm #coCd').val(),
            "clntCd": $('#popForm #estClntCd').val(),
            "clntNm": $('#popForm #estClntNm').val(),
            "insertYn": "Y",
            "isClntReq": "Y"
        }

        openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#prjctCd').val(row.siteCd);
            $('#prjctNm').val(row.siteNm);
        });
    }


    /* 기타함수 */

    // 문자열을 주어진 바이트 길이로 자르는 함수
    function cutStr(str, maxByte) {

        for (b = i = 0; c = str.charCodeAt(i);) {
            b += c >> 7 ? 2 : 1;
            if (b > maxByte)
                break;
            i++;
        }
        return str.substring(0, i);
    }

    // 견적 정보 삽입 함수
    function insertEst() {

        var formData = makeFormData();

        filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
            alert(data.resultMessage);
            if (data.resultCode == 200) {

                //location.href="/static/html/user/cr/cr01/CR0102P01.html";
            }
        });
    }

    // 견적 정보 업데이트 함수
    function updateEst() {
        //비고 문자열 길이 필드길이로 byte 자르기
        $("#estRprc").val(cutStr($("#estRprc").val(), 100));
        $("#prjctNm").val(cutStr($("#prjctNm").val(), 100));
        $("#rmk").val(cutStr($("#rmk").val(), 1000));
        if (inputValidation($('.popup_area input[required]'))) {
            var formData = makeFormData();
            filePutAjax("/user/cr/cr01/updateEst", formData, function (data) {
                alert(data.resultMessage);
                if (data.resultCode == 200) {
                    gridView.setData(0);
                    modalStack.close();
                }
            });
        }
    }

    // 폼 데이터 생성 함수
    function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma]'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });

        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);

        // 첨부파일 추가
        $.each(fileArr, function (idx, obj) {
            // 신규파일만 추가
            if (obj.fileKey == 0) {
                formData.append("nodeId_" + idx, obj.nodeId);
                formData.append("files", obj.file);
            }
        });


        formData.append("deleteFileArr", JSON.stringify(deleteFileArr));


        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                formData.append(elem, JSON.elem.value);
            });

        });
        var rowListPlan = gridOrdrsPlan.getList();
        var rowListDetail = gridOrdrsDetail.getList();


        if (rowListPlan.length == 0 || rowListDetail.length == 0) {
            alert("추가할 항목을 선택해주세요");
            return;
        }
        var planArr = [];
        var detailArr = [];

        $.each(rowListPlan, function (idx, elem) {
            var planObj = {};


            planObj["clmnPlanSeq"] = idx;
            planObj["clmnPlanDiv"] = elem.clmnPlanDiv;
            planObj["clmnDivSeq"] = elem.clmnDivSeq;
            planObj["clmnRate"] = elem.clmnRate;
            planObj["clmnAmt"] = elem.clmnAmt;
            planObj["billPblsDt"] = elem.billPblsDt;
            planObj["clmnDt"] = elem.clmnDt;
            planObj["pmntDtAfterBill"] = elem.pmntDtAfterBill;
            planObj["rmk"] = elem.rmk;

            planArr.push(planObj);

        });

        $.each(rowListDetail, function (idx, elem) {
            var detailObj = {};

            detailObj["ordrsSeq"] = idx;
            detailObj["ordrsDtlDiv"] = elem.ordrsDtlDiv;
            detailObj["prdtDiv"] = elem.prdtDiv;
            detailObj["itemDiv"] = elem.itemDiv;
            detailObj["salesCd"] = elem.salesCd;
            detailObj["eqNm"] = elem.eqNm;
            detailObj["ordrsPrcMach"] = elem.ordrsPrcMach;
            detailObj["ordrsPrcElcty"] = elem.ordrsPrcElcty;
            detailObj["ordrsPrc"] = elem.ordrsPrc;
            detailObj["ordrsQty"] = elem.ordrsQty;
            detailObj["estEpctMatPrc"] = elem.estEpctMatPrc;
            detailObj["trgtPchsPcostMach"] = elem.trgtPchsPcostMach;
            detailObj["trgtPchsPcostElcty"] = elem.trgtPchsPcostElcty;
            detailObj["trgtPchsPcostInHousePrcsn"] = elem.trgtPchsPcostInHousePrcsn;
            detailObj["laborCostMfgCost"] = elem.laborCostMfgCost;
            detailObj["dtlRmk"] = elem.dtlRmk;

            detailArr.push(detailObj);

        });

        formData.append("planArr", JSON.stringify(planArr));
        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    // 체크박스 전체 선택/해제 함수
    function allChk(elem) {
        if ($(elem).prop("checked")) {
            $("[name='detailChkBox']").prop("checked", true);
        } else {
            $("[name='detailChkBox']").prop("checked", false);
        }
    }

    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#estCoprt').data("rprc", value);
        $('#estCoprt option:not([value=""])').remove()
        setCommonSelect($('#estCoprt'));
    }

    //견적서 출력 선택 팝업 설정 함수
    function setReportPopup() {
        var paramObj = modalStack.last().paramObj;
        var iChk;
        var rptName;

        openSecondModal("/static/html/user/cr/cr01/SD0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
            var arg = "i_est_no#" + paramObj.estNo + "#"
                + "iChk#" + iChk + "#"
                + "imgPrt#" + imgPrt + "#";
            callReport(rptName, arg, 750, 900);
        });


    }


    /* 파일관련함수 */
    var selectedNodeId="";
    function addFileToTree(elem) {

        var tempFiles = elem.files;
        $.each(tempFiles, function (idx, obj) {
            var testArr = obj.name.split(".");
            fileArr.push({
                'fileKey': 0,
                'fileName': obj.name,
                'fileType': testArr[testArr.length - 1],
                'fileSize': obj.size,
                'nodeId': selectedNodeId,
                'file': obj
            });
        });

        var relatedFiles = fileArr.filter(function (file) {
            return file.nodeId === selectedNodeId;
        });
        fileGridView.reqSetData(relatedFiles);

    }




    $("#deptTree").on("select_node.jstree", function (e, data) {
        const buttonFile = document.getElementById("button_file");
        if (data.node.id.length >= 7) {
            buttonFile.disabled = false; // 활성화
            buttonFile.style.backgroundColor = ""; // 기본 배경색으로 변경 (옵션)
        } else {
            buttonFile.disabled = true; // 비활성화
            buttonFile.style.backgroundColor = "gray"; // 회색 배경색으로 변경 (옵션)
        }
        selectedNodeId = data.node.id;
        var relatedFiles = fileArr.filter(function (file) {
            return file.nodeId === selectedNodeId;
        });
        $("#file_tit").html($('#deptTree').jstree('get_selected', true)[0].text);
        fileGridView.reqSetData(relatedFiles);

    });















    function deleteFile(rowIndex) {
        fileGridView.target.removeRow(rowIndex);

        if (fileArr[rowIndex].fileKey) {

            deleteFileArr.push(fileArr[rowIndex].fileKey);
        }

        fileArr.splice(rowIndex, 1);
        fileGridView.setData();
    }

    function downloadFile(fileKey) {
        postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function (data) {
            var fileInfo = data.fileInfo;
            var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName, "UTF-8");
            location.href = "/admin/cm/cm08/fileDownload?filePath=" + filePath;
        });
    }


    /* document.ready */

    $(document).ready(function () {
        mainDefaultLoad("영업관리", "수주 등록");
        getMaxOrdrsNumber();
        $('#fwdExchJoinDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

        $('#ordrsDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        //왼쪽영역
        initDeptTree();
        //오른쪽영역

        document.querySelectorAll(".custom-btn").forEach((button) => {

            button.addEventListener("click", handleButtonClick);
        });




        const ordrsDiv = document.getElementById('ordrsDiv');
        const orgnSalesCdTh = document.getElementById('orgnSalesCdTh');
        const orgnSalesCdTd = document.getElementById('orgnSalesCdTd');


        function toggleOrgnSalesCd() {

            if (ordrsDiv.value === 'normal') {
                orgnSalesCdTd.style.display = 'none';
                orgnSalesCdTh.style.display = 'none';

            } else {
                orgnSalesCdTd.style.display = '';
                orgnSalesCdTh.style.display = '';
            }
        }

        ordrsDiv.addEventListener('change', toggleOrgnSalesCd);
        // 페이지 로드 시 초기 상태 설정
        toggleOrgnSalesCd();


        /*     fileGridView.init(); */
        /*    fileGridView.setData(); */
        // 공통코드 selectBox set
        setCommonSelect($(".popup_area select[data-kind]"));
        // 견적일자 datepicker bind
        $('#estDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

        $('#estBaseDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#issueDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 낙찰일자 datepicker bind
        $('#winbdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 파일 그리드 초기화
        /* 	fileGridView.initView(); */


    });

    /* 그리드 관련 함수 */
    // 그리드 생성
    const gridOrdrsPlan = new ax5.ui.grid();
    gridOrdrsPlan.setConfig({
        target: $('[data-ax5grid="ordrs-plan"]'),

        columns: [
            {
                key: "seq", label: "번호", width: "6%", align: "center", formatter: function () {
                    return this.item.__index + 1;
                },
            },

            {key: "clmnPlanDiv", label: "수금구분", width: "12%", align: "center", editor: {type: "text"}},
            {key: "clmnDivSeq", label: "수금구분차수", width: "12%", align: "center", editor: {type: "text"}},
            {key: "clmnRate", label: "수금비율", width: "12%", align: "center", editor: {type: "text"}},
            {key: "clmnAmt", label: "수금금액", width: "12%", align: "center", editor: {type: "text"}},
            {key: "billPblsDt", label: "계산서발행일자", width: "12%", align: "center", editor: {type: "date"}},
            {key: "clmnDt", label: "수금일자", width: "12%", align: "center", editor: {type: "date"}},
            {key: "pmntDtAfterBill", label: "계산서 발행 후 지급시기", width: "12%", align: "center", editor: {type: "text"}},
            {key: "rmk", label: "수금관리상황", width: "12%", align: "center", editor: {type: "text"}},

        ],
        footSum: [
            /*     [
                     {label: "총합계", align: "center", colspan: 7},
                     {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
                 ]*/
        ],
        body: {

            onClick: function () {
                this.self.clearSelect();
                this.self.select(this.dindex);
            }
        },
        contextMenu: {
            iconWidth: 20,
            acceleratorWidth: 100,
            itemClickAndClose: false,
            icons: {
                'arrow': '<i class="fa fa-caret-right"></i>'
            },
            items: [
                {type: 1, label: "붙여넣기"},
                {divide: true},
                {
                    label: "작업선택",
                    items: [
                        {type: 1, label: "줄추가"},
                        {type: 1, label: "내용 삭제"},
                        {type: 2, label: "줄삭제"},
                    ]
                },
            ],
            popupFilter: function (item, param) {
                //console.log(item, param);
                if (param.element) {
                    return true;
                } else {
                    return item.type == 1;
                }
            },
            onClick: function (item, param) {
                console.log(item, param);
                thisGridRow = param.dindex;
                thisGridCol = param.colIndex;

                if (item.label == "붙여넣기") {
                    gridPaste(thisGridRow, thisGridCol);
                } else if (item.label == "줄추가") {
                    console.log('추가 인덱스 :', param.dindex);
                    //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                    gridOrdrsPlan.addRow($.extend({}, gridOrdrsPlan.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                } else if (item.label == "내용 삭제") {
                    console.log('내용삭제 인덱스 :', param.dindex);

                    gridOrdrsPlan.config.columns.forEach((column) => {
                        gridOrdrsPlan.setValue(param.dindex, column.key, '');
                        console.log('내용삭제 :', param.dindex, column.key);
                    });

                } else if (item.label == "줄삭제") {
                    console.log('삭제 인덱스 :', param.dindex);
                    gridOrdrsPlan.removeRow(param.dindex);
                }


                return true;
                //또는 return true;
            }
        }
    });

    // 그리드 생성
    const gridOrdrsDetail = new ax5.ui.grid();
    gridOrdrsDetail.setConfig({
        target: $('[data-ax5grid="ordrs-detail"]'),
        columns: [
            {
                key: "seq", label: "번호", width: "5%", align: "center", formatter: function () {
                    return this.item.__index + 1;
                },
            },
            {key: "ordrsDtlDiv", label: "구분", width: "12.5%", align: "center"},
            {key: "prdtDiv", label: "제품구분", align: "center", width: "12.5%", editor: {type: "text"}},
            {key: "itemDiv", label: "품목구분", align: "center", width: "12.5%", editor: {type: "text"}},
            {key: "salesCd", label: "영업코드", align: "center", width: "12.5%", editor: {type: "text"}},
            {key: "eqNm", label: "품명", align: "center", width: "12.5%", editor: {type: "text"}},
            {key: "ordrsPrcMach", label: "기계 가격", align: "right", width: "12.5%", editor: {type: "text"}},
            {key: "ordrsPrcElcty", label: "전기 가격", align: "right", width: "12.5%", editor: {type: "text"}},
            {key: "ordrsPrc", label: "단가", align: "right", width: "12.5%", editor: {type: "text"}},
            {key: "ordrsQty", label: "수량", align: "left", width: "12.5%", editor: {type: "text"}},
            {key: "estEpctMatPrc", label: "예상자재가격", align: "right", width: "12.5%", editor: {type: "text"}},
            {key: "trgtPchsPcostMach", label: "목표매입가격 기계", align: "right", width: "12.5%", editor: {type: "text"}},
            {key: "trgtPchsPcostElcty", label: "목표매입가격 전기", align: "right", width: "12.5%", editor: {type: "text"}},
            {
                key: "trgtPchsPcostInHousePrcsn",
                label: "목표매입가격 내공정",
                align: "right",
                width: "12.5%",
                editor: {type: "text"}
            },
            {key: "laborCostMfgCost", label: "노무비 제조원가", align: "right", width: "12.5%", editor: {type: "text"}},
            {key: "dtlRmk", label: "비고", align: "center", width: "12.5%", editor: {type: "text"}},

        ],
        footSum: [
            /*      [
                      {label: "총합계", align: "center", colspan: 7},
                      {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
                  ]*/
        ],

    });

    var fileArr = [];
    var deleteFileArr = [];
    var fileGridView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                target: $('[data-ax5grid="file-grid"]'),
                showLineNumber: true,
                showRowSelector: false,
                multipleSelect: false,
                header: {
                    selector: false
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                        downloadFile(this.dindex);
                    },
                },
                columns: [
                    {key: "fileKey", label: "파일키", hidden: true},
                    {key: "fileName", label: "파일명", width: 260, align: "left"},
                    {key: "fileType", label: "파일타입", width: 60, align: "center"},
                    {key: "fileSize", label: "파일크기", width: 100, align: "right", formatter: "money"},
                    {key: "creatDttm", label: "생성일자", width: 130, align: "center",},
                    {key: "creatId", label: "생성자", width: 100, align: "center"},
                    {key: "clntCd", label: "거래처", width: 50, align: "center", hidden: true},
                    {key: "clntNm", label: "거래처명", width: 110, align: "center"},
                    {key: "prdtCd", label: "제품코드", width: 50, align: "center", hidden: true},
                    {key: "prdtNm", label: "제품명", width: 100, align: "center"},
                    {key: "itemCd", label: "아이템", width: 50, align: "center"},
                    {key: "salesCd", label: "Sales코드", width: 110, align: "center"},
                    {key: "prjctCd", label: "프로젝트", width: 50, align: "center", hidden: true},
                    {key: "prjctNm", label: "프로젝트명", width: 110, align: "center"},
                    {
                        key: "fileDelete", label: "삭제", width: 80, align: "center",
                        formatter: function () {
                            return '<button style="height: 18px; padding:0px;" type="button" onclick="deleteFile('
                                + this.dindex
                                + ');">삭제</button>';
                        }
                    }],
                page: {
                    display: false
                }
            });
            return this;
        },
        reqSetData: function (list) {

            var targetObj = this.target;
            targetObj.setData({
                list: list,
                page: {
                    totalElements: fileArr.length
                }
            });
        }
    }
    fileGridView.initView()


    //총합계 함수
    function updateRowTotalsCallback(grid) {
        const data = grid.getList();

        data.forEach((item, index) => {
            if (!item.__grouping) {
                const estAmt = item.estQty * item.estUpr;
                grid.setValue(index, "estAmt", parseFloat(estAmt));
            }
        });
        grid.repaint();
    }

    // 기존 addDtlDiv 함수를 아래와 같이 수정하세요.
    function addDtlDiv(gridInstance, estDtlDivLetter, itemCount) {


        const columns = gridInstance.config.columns; // 컬럼 설정 가져오기
        const divData = [];

        for (let i = 1; i <= itemCount; i++) {
            const newRow = {};

            columns.forEach((column) => {
                const key = column.key;
                if (key) {
                    newRow[key] = column.defaultValue || null;
                }
            });


            if (gridInstance === gridOrdrsPlan) {
                newRow.clmnPlanDiv = estDtlDivLetter; // gridOrdrsPlan의 경우
            } else if (gridInstance === gridOrdrsDetail) {
                newRow.ordrsDtlDiv = estDtlDivLetter; // gridOrdrsDetail의 경우
            }
            divData.push(newRow);
        }

        const data = gridInstance.getList();
        gridInstance.setData([...data, ...divData]);
    }





    // 각 버튼에 대한 클릭 이벤트 처리 함수를 작성합니다.
    function handleButtonClick(event) {

        const buttonId = event.target.id;
        const itemCount = 1;
        let divLetter;
        let targetGrid;

        switch (buttonId) {
            case "depositButton":
                divLetter = "계약금";
                targetGrid = gridOrdrsPlan;
                break;
            case "installmentButton":
                divLetter = "중도금";
                targetGrid = gridOrdrsPlan;
                break;
            case "balanceButton":
                divLetter = "잔금";
                targetGrid = gridOrdrsPlan;
                break;
            case "advanceButton":
                divLetter = "선급금";
                targetGrid = gridOrdrsPlan;
                break;
            case "equipmentButton":
                divLetter = "설비";
                targetGrid = gridOrdrsDetail;
                break;
            case "additionalCostButton":
                divLetter = "부대비용";
                targetGrid = gridOrdrsDetail;
                break;
            case "extraCostButton":
                divLetter = "추가비용";
                targetGrid = gridOrdrsDetail;
                break;
        }

        addDtlDiv(targetGrid, divLetter, itemCount);
    }





    function insertOrdrs() {
        if (validateRequiredFields() && inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            filePostAjax("/user/cr/cr02/insertOrdrs", formData, function (data) {

                if (data.resultCode == 200) {
                    alert("정상적으로 insert/update 되었습니다.");
                    var odrSeq = data.odrSeq;
                    modalStack.close();
                    gridView.setData(0);
                    setTimeout(function () {

                    }, 500);
                }
            });
        }
    }

    function updateOrdrs() {
        if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            filePutAjax("/user/cr/cr02/updateOrdrs", formData, function (data) {
                alert(data.resultMessage);
                if (data.resultCode == 200) {
                    var odrSeq = $('#odrSeq').val();
                    modalStack.close();
                    gridView.setData(0);
                    setTimeout(function () {

                    }, 500);
                }
            });
        }
    }


    var actionType = modalStack.last().paramObj.actionType;
    if (actionType == "C") {

        $('#actionBtn').on("click", function () {
            insertOrdrs();
        });

    } else if (actionType == "U") {
        alert("수정")
        $('#actionBtn').on("click", function () {
            updateOrdrs();
        });


    }

    function validateRequiredFields() {
        // gridOrdrsDetail 리스트 검사
        // gridOrdrsPlan 리스트 검사
        const dataOrdrsPlan = gridOrdrsPlan.getList();

        for (let i = 0; i < dataOrdrsPlan.length; i++) {
            const row = dataOrdrsPlan[i];

            // 필수 입력 필드 검사
            if (!row.clmnPlanDiv || !row.clmnDivSeq || !row.clmnRate || !row.clmnAmt ||
                !row.billPblsDt || !row.clmnDt || !row.pmntDtAfterBill || !row.rmk) {
                alert(`수주 수금 계획 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
                return false;
            }
        }

        const dataOrdrsDetail = gridOrdrsDetail.getList();

        for (let i = 0; i < dataOrdrsDetail.length; i++) {
            const row = dataOrdrsDetail[i];

            // 필수 입력 필드 검사
            if (!row.ordrsDtlDiv || !row.prdtDiv || !row.itemDiv || !row.salesCd || !row.eqNm ||
                !row.ordrsPrcMach || !row.ordrsPrcElcty || !row.ordrsPrc || !row.ordrsQty ||
                !row.estEpctMatPrc || !row.trgtPchsPcostMach || !row.trgtPchsPcostElcty ||
                !row.trgtPchsPcostInHousePrcsn || !row.laborCostMfgCost || !row.dtlRmk) {
                alert(`수주 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
                return false;
            }
        }



        return true;
    }

    function initDeptTree() {
        $("#deptTree").jstree("destroy");
        $("#deptTree").jstree(
            {
                plugins: ['types'],
                core: {
                    data: selectDeptTree()
                },
                types: {
                    'unit': {
                        'icon': 'glyphicon glyphicon-folder-close'
                    },
                    'unit-open': {
                        'icon': 'glyphicon glyphicon-folder-open'
                    }
                }
            }).on("loaded.jstree", function () {
            // 루트 노드 로드 완료 시
            //전체 노드 펼침

            // $("#deptTree").jstree("open_all");
            // 최상위 노드 펼침
            $('#deptTree').jstree(true).open_node($('#deptTree li[aria-level="1"]').eq(0).attr('id'));
            $('#deptTree').jstree(true).open_node($('#deptTree li[aria-level="2"]').eq(0).attr('id'));
        }).on("refresh.jstree", function () {
            // 리프레시 완료 시
            var selectedId = $('#deptTree').jstree(true).get_selected()[0];
            $('#deptTree').jstree(true).deselect_all();
            $('#deptTree').jstree(true).select_node(selectedId);
        }).on("select_node.jstree", function (e, data) {
            // 노드 선택 시 발생 이벤트

            //파일정보 show
            if (!$('#deptTree').is(":visible")) {
                $('#deptTree').show();
            }

            // 파일정보 set
            // selectFileList(data.node.id);
            selectFileList();

        }).on('open_node.jstree', function (e, data) {
            // 노드 열릴 때
            data.instance.set_type(data.node, 'unit-open');
        }).on('close_node.jstree', function (e, data) {
            // 노드 닫힐 때
            data.instance.set_type(data.node, 'unit');
        })
    }


    function selectDeptTree() {
        var deptTree = null;
        var paramObj = {
            "coCd": $('#coCd_S').val(), //"GUN",
            "useYn": $("#useYn_S").val()
        };
        postAjaxSync("/admin/cm/cm05/selectDocTreeList", paramObj, null, function (data) {
            deptTree = data.docTreeList.filter(function (node) {
                return isRelatedToFitr02(node, data.docTreeList);
            });
        });
        return deptTree;
    }

    function isRelatedToFitr02(node, nodeList) {
        if (node.deptId === 'FILETREE' || node.deptId === 'FITR02' || node.parent === 'FITR02') {
            return true;
        }

        var parentNode = nodeList.find(function (parentNode) {
            return parentNode.deptId === node.parentDeptId;
        });

        if (!parentNode) {
            return false;
        }

        return isRelatedToFitr02(parentNode, nodeList);
    }


</script>


</html>
