
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">수주 등록</h4>
	</div>

	<!--     <div > //화살표 접었다 폈다 하는 기능-->
	<!--         <a class="tbody_more_btn"></a> -->
	<!--     </div> -->
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="pgmId" name="pgmId" value="CR0202P01">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">
			<table>
				<colgroup>
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th class="hit">회사</th>
					<td><select data-search="coCd" id="coCd" name="coCd"
						class="modal-coCd" style="width: 100%;" data-kind="CO" required
						msg="회사">
					</select></td>
					<th>견적서번호</th>
					<td>
						<div class="search_form">
							<input
								onkeydown="if(event.keyCode==13) openSecondEstSearch(this.value);"
								type="text" id="estNoOrdrs" name="estNoOrdrs"
								class="modal-estNoOrdrs"> <a
								onclick="openSecondEstSearch(document.getElementsByClassName('modal-estNoOrdrs').value);">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>
					<th>견적차수</th>
					<td><input id="estDeg" type="text"
						name="estDeg" readonly></td>

					<th>수주번호</th>
					<td><input id="ordrsNo" type="text" readonly></td>
				</tr>
				<!-- 2행 -->
				<tr>
					<th class="hit">수주일자</th>
					<td><input type="text" class="input_calendar"
						autocomplete="off" id="ordrsDt" name="ordrsDt" date required></td>
					<th class="hit">수주구분</th>
					<td><select id="ordrsDiv" name="ordrsDiv" data-kind="ORDRSDIV"
						required>

					</select></td>
					<th class="hit">고객사</th>
					<td><input type="hidden" id="ordrsClntCd" name="ordrsClntCd">
						<div class="search_form">
							<input
								onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);"
								type="text" id="ordrsClntNm" name="ordrsClntNm" required>
							<a
								onclick="openSecondClntSearch(document.getElementById('ordrsClntNm').value);">
								<i class="i_search_w"></i>
							</a>
						</div></td>
					<th class="hit">고객사PJT</th>
					<td><input type="text" id="clntPjt" class="clntPjtOrdrs"
						name="clntPjt" required></td>
				</tr>
				<!-- 3행 -->
				<tr>
					<th class="hit">계약명</th>
					<td colspan="3"><input type="text" id="ctrtNm" name="ctrtNm"
						required></td>
					<th class="hit">통화단위</th>
					<td><select id="currCd" name="currCd" data-kind="CURR"
						onchange="setByCoCd(this.value)" required></select></td>
					<th class="hit">수주금액</th>
					<td><input type="text" id="ordrsAmt" name="ordrsAmt" required
						value="0"></td>
				</tr>
				<!-- 4행 -->
				<tr>
					<th class="">결재방법</th>
					<td><select id="pmntMtd" name="pmntMtd" data-kind="PMNTMTD"
						onchange="setByCoCd(this.value)"></select>
					<th class="">발주자</th>
					<td><input type="text" id="ordrger" name="ordrger">
					<th class="hit" title="담당자 정보를 확인합니다">담당자</th>
					<td>
						<div class="search_form">
							<input
								onkeydown="if(event.keyCode==13)openSecondUserSearch( this.value);"
								type="text" id="mngIdVisible" name="mngIdVisible" required>
							<input type="hidden" id="mngId" name="mngId"> <a
								onclick="openSecondUserSearch( document.getElementById('mngIdVisible').value);">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>

					<!--                     <th class="">발주자</th>
                                             <td><input type="text" id="ordrger" name="ordrger"></td>-->
					<th class="">환율</th>
					<td><input type="text" id="exrate" name="exrate" value="1"></td>
				</tr>
				<!-- 5행 -->
				<tr>
					<th class="">선물환가입일</th>
					<td><input type="text" class="input_calendar"
						autocomplete="off" id="fwdExchJoinDt" name="fwdExchJoinDt" date></td>
					<th class="">선물환CheckList</th>
					<td><select id="fwdExchChkList" name="fwdExchChkList">
							<option>OK</option>
							<option>NG</option>
					</select></td>
					<th class="">계약문서</th>
					<td><input type="text" id="ctrtDoc" name="ctrtDoc"></td>
					<th class="" id="orgnSalesCdTh">원천SalesCode</th>
					<td id="orgnSalesCdTd">
						<div class="search_form">
							<input onkeydown="if(event.keyCode==13)wbsSalesCodeSearch();"
								type="text" id="orgnSalesCd" name="orgnSalesCd"> <a
								onclick="wbsSalesCodeSearch();"> <i class="i_search_w"></i>
							</a>
						</div>
					</td>
				</tr>
				<!-- 6행 -->
				<tr>
					<th class="">비고</th>
					<td colspan="3"><input type="text" id="ordrsRmk"
						name="ordrsRmk"></td>
				</tr>

			</table>
		</div>
	</form>

	<div class="contents_tit">
		<div style="float: right" class="add_btn_small pdl10">
			<!-- 		          <button id="ordrsPlanHis" style="margin-right:10px; display:none;" type="button">수금계획수정이력  -->
			<!-- 	              </button> -->
			<a id="addPaymentButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deletePaymentButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>

	<!-- 콘텐츠1 -->
	<div class="contents">
		<!-- 리스트 -->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"
					style="height: 230px; width: 100%"></div>
			</div>
		</div>
	</div>

	<div class="contents_tit">
		<div style="float: right" class="add_btn_small pdl10">
			<a id="addDetailButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deleteDetailButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>
	<!-- 콘텐츠2-->
	<div class="contents">
		<!-- 리스트-->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="second-grid-modal" data-ax5grid-config="{}"
					style="height: 300px; width: 100%"></div>
			</div>
		</div>
	</div>
	<!--     <div style="text-align: right;background:#e6e6e6"> -->
	<!--         <a class="tbody_more_btn"></a> -->
	<!--     </div> -->
	<!--     <div class="toggle-div" style="padding-left: 0;"> -->
	<!--         <div class="popup_table"> -->
	<!--             <div class="" style="padding-left: 0;"> -->
	<!--                 <div class="contents" style="margin:0px; padding:0px; height: 300px; width: 100%; min-width: 200px"> -->
	<!--                     <div style="float:right" style="" class="add_btn pdl10"> -->
	<!--                         <button id="ordrsPlanHis" style="margin-right:10px;display:none;" type="button">수금계획수정이력 -->
	<!--                         </button> -->
	<!--                         <a id="addPaymentButton" style="margin-top:8px">+</a> -->
	<!--                         <a id="deletePaymentButton" style="margin-top:8px;margin-right:8px;">-</a> -->
	<!--                     </div> -->
	<!--                     <h3 class="location"> -->
	<!--                         <a class="file_tag" id="file_tag" -->
	<!--                            style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a> -->
	<!--                         <span class="page_tit" style="text-align: right;"></span> -->
	<!--                     </h3> -->
	<!--                     <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px"> -->
	<!--                         <div data-ax5grid="ordrs-plan" data-ax5grid-config="{}" style="height: 100%;"></div> -->
	<!--                     </div> -->
	<!--                 </div> -->
	<!--             </div> -->
	<!--         </div> -->
	<!--     </div> -->
	<!--     <div style="text-align: right;background:#e6e6e6"> -->
	<!--         <a class="tbody_more_btn"></a> -->
	<!--     </div> -->
	<!--     <div class="toggle-div" style="padding-left: 0;"> -->
	<!--         <div class="popup_table" style="margin-top: 15px;"> -->

	<!--             <div class="" style="padding-left: 0;"> -->
	<!--                 <div class="contents" style="margin:0px; padding:0px; height: 300px; width: 100%; min-width: 200px"> -->
	<!--                     <div style="float:right" style="" class="add_btn pdl10"> -->
	<!--                         <a id="addDetailButton" style="margin-top:8px">+</a> -->
	<!--                         <a id="deleteDetailButton" style="margin-top:8px;margin-right:8px;">-</a> -->
	<!--                     </div> -->


	<!--                     <h3 class="location"> -->
	<!--                         <a class="file_tag" id="file_tag" -->
	<!--                            style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a> -->
	<!--                         <span class="page_tit" style="text-align: right;"></span> -->
	<!--                     </h3> -->
	<!--                     <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px"> -->
	<!--                         <div data-ax5grid="ordrs-detail" data-ax5grid-config="{}" style="height: 100%;"></div> -->
	<!--                     </div> -->
	<!--                 </div> -->
	<!--             </div> -->
	<!--         </div> -->
	<!--     </div> -->
	<!--     <div style="text-align: right;background:#e6e6e6"> -->
	<!--         <a class="tbody_more_btn"></a> -->
	<!--     </div> -->
	<!--     <div class="toggle-div" style="padding-left: 0;"> -->
	<!--         <div class="row" style="margin-top: 15px;margin-bottom:40px;width:100%;"> -->
	<!--             <div class="col-xs-2" style="padding-right: 5px;"> -->
	<!--                 <div class="contents" -->
	<!--                      style="margin: 0; padding: 0;width: 100%; min-width: 200px;height:380px;border-radius: 0"> -->
	<!--                     <h3 class="location"> -->
	<!--                         <span class="page_tit" style="text-align: left;"> 파일트리</span> -->
	<!--                     </h3> -->
	<!--                     <div id="treeview" style="padding: 5px"> -->
	<!--                         <div id="deptTreeOrdars"></div> -->
	<!--                     </div> -->
	<!--                 </div> -->
	<!--             </div> -->
	<!--             <div class="col-xs-10" style="padding-left: 0;"> -->
	<!--                 <div class="contents" -->
	<!--                      style="margin: 0; padding: 0;   width: 100%; min-width: 200px;height:380px;border-radius:0;text-align:center"> -->
	<!--                     <h3 class="location"> -->
	<!--                         <a class="file_tag" id="file_tag" -->
	<!--                            style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a> -->
	<!--                         <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span> -->
	<!--                     </h3> -->

	<!--                     <button disabled type="button" id="button_file" class="" -->
	<!--                             style="  background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" -->
	<!--                             authchk> -->
	<!--                         첨부파일 -->
	<!--                     </button> -->
	<!--                               <button  type="button" id="zip_down" class=""
<!--                                        style="display:none;height: 25px; line-height: 15px;" -->
	<!--                                        authchk> -->
	<!--                                    파일 전체 다운로드 -->
	<!--                                </button>-->
	<!--                     <div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" -->
	<!--                          style="height: 300px; width: 95%;margin: auto;"></div> -->
	<!--                 </div> -->
	<!--             </div> -->
	<!--         </div> -->
	<!--     </div> -->
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionOrdrsBtn" authchk>등록</button>

		<button class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
    /***********전역변수****************/
    let selectedRowKey;
    let selectedRowKey2;
    /***********전역변수****************/

 /* document.ready */
    let updating = false;
    $(document).ready(function () {
        setCommonSelect($(".popup_area select[data-kind]"));
        fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
        /*    $("#ordrsAmt").change(function () {


                const ordrsAmt = parseFloat($("#ordrsAmt").val().replace(/,/g, ''));

                if (!isNaN(ordrsAmt)) {
                    gridOrdrsPlan.list = gridOrdrsPlan.list.map(item => {
                        const clmnRate = parseFloat(item.clmnRate);

                        if (!isNaN(clmnRate)) {
                            const price = ordrsAmt * clmnRate / 100;
                            return {
                                ...item,
                                clmnAmt: price
                            };
                        }

                        return item;
                    });

                    gridOrdrsPlan.repaint();
                }

            })*/


        var inputIds = ['exrate', 'ordrsAmt'];
        inputIds.forEach(function (id) {
            document.getElementById(id).addEventListener('input', function (e) {
                let input = e.target.value;
                let pureNumber = input.replace(/[^0-9,]/g, ''); // 숫자와 콤마가 아닌 문자 제거

                // 한글을 포함하는 경우 경고 메시지 출력하고 함수 종료
                if (/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(input)) {
                    alertDebounced();
                    e.target.value = pureNumber;


                } else {
                    // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
                    e.target.value = e.target.value.replace(/[^0-9,]/g, '');
                    // 세 자리마다 콤마를 삽입합니다.
                    e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    // 0으로 시작하는 부분을 제거합니다.
                    e.target.value = e.target.value.replace(/^0+/, '');
                }
            });
        });


//         $('.tbody_more_btn').click(function () {
//             $(this).toggleClass('on');
//             $(this).parent().next('.toggle-div').toggle();
//         });

        $('#fwdExchJoinDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        }).datepicker("setDate", "today");

        $('.input_calendar').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

		
      	//수주일자//
		$('#ordrsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
      	
//         $('#ordrsDt,#fwdExchJoinDt,[data-ax5grid-editor="calendar"]').on('keydown', function (e) {
//             e.preventDefault();
//         });

        document.querySelectorAll(".custom-btn").forEach((button) => {

            button.addEventListener("click", handleButtonClick);
        });


        const ordrsDiv = document.getElementById('ordrsDiv');
        const orgnSalesCdTh = document.getElementById('orgnSalesCdTh');
        const orgnSalesCdTd = document.getElementById('orgnSalesCdTd');


        function toggleOrgnSalesCd() {

            if (ordrsDiv.value === 'ORDRSDIV1') {
                orgnSalesCdTd.style.display = 'none';
                orgnSalesCdTh.style.display = 'none';

            } else {
                orgnSalesCdTd.style.display = '';
                orgnSalesCdTh.style.display = '';
            }
        }

        ordrsDiv.addEventListener('change', toggleOrgnSalesCd);
        // 페이지 로드 시 초기 상태 설정
        toggleOrgnSalesCd();

        $('#ordrsDiv').on('change', function () {
            var selectedValue = $(this).val();
            if (selectedValue === 'ORDRSDIV1') {
                $('#orgnSalesCd').prop('required', false);
            } else {
                $('#orgnSalesTh').addClass('hit');
                $('#orgnSalesCd').prop('required', true);
            }
        })

        
        /*     fileGridView.init(); */
        /*    fileGridView.setData(); */
        // 공통코드 selectBox set
        // 견적일자 datepicker bind
//         $('#estDt').datepicker({
//             format: "yyyy-mm-dd",
//             language: "ko",
//             autoclose: true
//         });
//         $('#estBaseDate').datepicker({
//             format: "yyyy-mm-dd",
//             language: "ko",
//             autoclose: true
//         });
//         $('#issueDate').datepicker({
//             format: "yyyy-mm-dd",
//             language: "ko",
//             autoclose: true
//         });
//         // 낙찰일자 datepicker bind
//         $('#winbdDt').datepicker({
//             format: "yyyy-mm-dd",
//             language: "ko",
//             autoclose: true
//         });


        var inputIds = ['ordrsAmt'];

        // 디바운스 함수
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                if (timeout) clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        const alertDebounced = debounce(() => alert("숫자만 입력 가능합니다."), 300);

        inputIds.forEach(function (id) {
            document.getElementById(id).addEventListener('input', function (e) {
                let input = e.target.value;
                let pureNumber = input.replace(/[^0-9,]/g, ''); // 숫자와 콤마가 아닌 문자 제거

                // 한글을 포함하는 경우 경고 메시지 출력하고 함수 종료
                if (/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(input)) {
                    alertDebounced();
                    e.target.value = pureNumber;
                    return;
                }
                if (id === 'cstmMngHp') {
                    if (pureNumber.length > 11) { // 입력값의 길이가 11자리를 초과하면 초과하는 부분 제거
                        pureNumber = pureNumber.slice(0, 11);
                    }

                    let formatted = '';

                    if (pureNumber.length < 4) {
                        return e.target.value = pureNumber;
                    } else if (pureNumber.length < 7) {
                        formatted += pureNumber.substr(0, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(3);
                    } else if (pureNumber.length < 11) {
                        formatted += pureNumber.substr(0, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(3, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(6);
                    } else { // input.length === 11
                        formatted += pureNumber.substr(0, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(3, 4);
                        formatted += '-';
                        formatted += pureNumber.substr(7);
                    }

                    e.target.value = formatted;
                } else {
                    // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
                    e.target.value = e.target.value.replace(/[^0-9,]/g, '');
                    // 세 자리마다 콤마를 삽입합니다.
                    e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    // 0으로 시작하는 부분을 제거합니다.
                    e.target.value = e.target.value.replace(/^0+/, '');
                }
            });
        });

      	//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: $("#pgmId").val(),
			fileTrgtKey : fileTrgtKey
		}

		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
    });




    /* 견적서함수 */


    // 견적 정보 조회 함수
    function selectEstInfo() {
        var paramObj = modalStack.last().paramObj;
        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            setEstInfo(data.estInfo);
        });
    }

    // 견적 정보 설정 함수
    function setEstInfo(estInfo) {
        //메인정보 세팅
        $.each(estInfo, function (key, value) {
            if ($('#' + key)[0]) {
                if ($('#' + key).is('[date]')) {
                    $('#' + key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
                } else {
                    if ($('#' + key).is('[comma]')) {
                        value = addCommaStr(value);
                    }
                    if (key == "coCd") {
                        setByCoCd(value)
                    }
                    $('#' + key).val(value);
                }
            }
        });


        $.each(estInfo.estDetailList, function (idx, obj) {
            if (idx != 0) addRow();
            $addedRow = $("tr[name='detailRow']:last");

            $.each($addedRow.find('[name]'), function (idx, elem) {
                var itemValue = obj[elem.name];
                if (itemValue) {
                    if ($(elem).is("[comma]")) {
                        itemValue = addCommaStr(itemValue);
                    }
                    $(elem).val(itemValue);
                }
            });
        });
        countTot();


        /*     $.each(estInfo.estFileList, function (idx, obj) {
                 fileArr.push({
                     'fileKey': obj.fileKey,
                     'fileName': obj.fileName,
                     'fileType': obj.fileType,
                     'fileSize': obj.fileSize,
                     'file': obj
                 });
             });*/


        /* 	fileGridView.setData(); */
    }

    // 거래처 검색 함수
    function openSecondClntSearch(searchValue) {
    	//등록일 경우만 팝업처리
		if (actionType == "C") {
	        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: searchValue}, function (grid) {
	            var row = grid.target.getList("selected")[0];

	            $('#ordrsClntCd').val(row.clntCd);
	            $('#ordrsClntNm').val(row.clntNm);
	            //$('#clntPjt').val(row.clntPjt);
	            
	            var paramObj = {
	                "coCd": $('#coCd').val(),
	                "clntCd": row.clntCd
	            }
	            setMngInfo(paramObj);
	        });
		}
    }


    function openSecondEstSearch(searchValue) {
    	var aordrsDiv = $("#ordrsDiv").val()

    	//등록이거나 수주구분이 정상수주일 경우만 팝업처리
		if (actionType == "C" && aordrsDiv == "ORDRSDIV1" ) {
	        openSecondModal("/static/html/cmn/modal/estSearchWithOrdrs.html", 600, 420, "견적서 검색", {searchValue: searchValue}, function (grid) {
	            var row = grid.target.getList("selected")[0];

	            $('#estNoOrdrs').val(row.estNo);
	            $('#coCd').val(row.coCd);
	            $('#estDeg').val(row.estDeg);
	            $('#currCd').val(row.currCd);
	            $('#ordrsClntCd').val(row.estClntCd);
	            $('#ordrsClntNm').val(row.estClntNm);
	            $('#clntPjt').val(row.clntPjt);
	            $('#ordrsAmt').val(row.estAmt);
	            var paramObj = {
	                "coCd": $('#coCd').val(),
	                "clntCd": row.estClntCd
	            }
	           setMngInfo(paramObj);
	        });
		}
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {

                $('#mngId').val(data.mngInfo.salesEmpId);
                $('#mngIdVisible').val(data.mngInfo.salesEmpNm);
            } else {

                $('#mngId').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch() {
    	//등록일 경우만 팝업처리
		if (actionType == "C") {
	        var paramObj = {
	            "coCd": "GUN", //$('#coCd').val(),
	            "userId": $('#salesEmpId').val(),
	            "useYn": "Y"
	        };
	
	        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
	            var checkedId = tree.get_checked()[0];
	            var checkedNode = tree.get_node(checkedId);
	            $("#salesEmpId").val(checkedNode.id);
	            $("#salesEmpNm").val(checkedNode.text);
	        });
		}
    }

    // 문자열을 주어진 바이트 길이로 자르는 함수
    function cutStr(str, maxByte) {

        for (b = i = 0; c = str.charCodeAt(i);) {
            b += c >> 7 ? 2 : 1;
            if (b > maxByte)
                break;
            i++;
        }
        return str.substring(0, i);
    }

    // 견적 정보 삽입 함수
    function insertEst() {

        var formData = makeFormData();

        filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
            alert(data.resultMessage);
            if (data.resultCode == 200) {

                //location.href="/static/html/user/cr/cr01/CR0102P01.html";
            }
        });
    }

    // 견적 정보 업데이트 함수
    function updateEst() {
        //비고 문자열 길이 필드길이로 byte 자르기
        $("#estRprc").val(cutStr($("#estRprc").val(), 100));
        $("#prjctNm").val(cutStr($("#prjctNm").val(), 100));
        $("#rmk").val(cutStr($("#rmk").val(), 1000));

        if (inputValidation($('.popup_area input[required]'))) {
            var formData = makeFormData();
            filePutAjax("/user/cr/cr01/updateEst", formData, function (data) {

                if (data.resultCode == 200) {

                    gridView.setData(0);
                    modalStack.close();
                }
            });
        }
    }

    // 폼 데이터 생성 함수
    function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#exrate,#ordrsAmt'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });
        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);
        formData.append("ordrsNo", $("#ordrsNo").val());
        // 유저아이디 추가
       // formData.append("userId", jwt.userId);

        //---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#ordrsClntCd').val());			//첨부화일용
		formData.append("prdtCd" , $('#prdtCd').val(""));			//첨부화일용
		formData.append("itemCd" , $('#itemDiv').val(""));			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용

		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------

        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};

            $.each($(elem).find('[name]'), function (idx, elem) {

                formData.append(elem, JSON.elem.value);
            });

        });     
        
        var rowListPlan = gridOrdrsPlan.getList();
        var rowListDetail = gridOrdrsDetail.getList();


        if (rowListPlan.length == 0 || rowListDetail.length == 0) {
            alert("추가할 항목을 선택해주세요");
            return;
        }
        var planArr = [];
        var detailArr = [];

        $.each(rowListPlan, function (idx, elem) {
            var planObj = {};


            planObj["clmnPlanSeq"] = idx + 1;
            planObj["clmnPlanDiv"] = elem.clmnPlanDiv;
            planObj["clmnDivSeq"] = elem.clmnDivSeq;
            planObj["clmnRate"] = elem.clmnRate;
            //planObj["clmnAmt"] = elem.clmnAmt;
            planObj["clmnAmt"] = parseInt(elem.clmnAmt.replace(/,/g, ''));


            let clmnDt = new Date(elem.clmnDt);
            let pmntDtAfterBill = parseInt(elem.pmntDtAfterBill, 10); // 문자열을 숫자로 변환

            // clmnDt에서 pmntDtAfterBill를 뺍니다.
            clmnDt.setDate(clmnDt.getDate() - pmntDtAfterBill);

            // Date 객체를 YYYY-MM-DD 형식의 문자열로 변환
            let convertDateToString = function (dateObj) {
                let month = '' + (dateObj.getMonth() + 1),
                    day = '' + dateObj.getDate(),
                    year = dateObj.getFullYear();

                if (month.length < 2)
                    month = '0' + month;
                if (day.length < 2)
                    day = '0' + day;

                return [year, month, day].join('-');
            };

            // 계산된 날짜를 billPblsDt에 할당
            planObj["billPblsDt"] = convertDateToString(clmnDt);


            planObj["clmnDt"] = elem.clmnDt;
            planObj["pmntDtAfterBill"] = pmntDtAfterBill;
            planObj["clmnMgmtStatus"] = elem.clmnMgmtStatus;

            planArr.push(planObj);

        });

        // clmnAmt 합계 계산
        var totalClmnAmt = 0;
        $.each(planArr, function (idx, elem) {
            totalClmnAmt += parseFloat(elem.clmnAmt);
        });


        // input box 값과 비교
        var inputAmtVal = parseFloat($("#ordrsAmt").val());


        if (totalClmnAmt != inputAmtVal) {
            alert("합계가 입력 금액과 일치하지 않습니다(수금계획)");
            return false
        }


        var totalLaborCostMfgCost = 0;
        var totalMachineValueAfterDeduction = 0;

        $.each(rowListDetail, function (idx, elem) {
            var detailObj = {};
            detailObj["ordrsSeq"] = idx + 1;
            detailObj["ordrsDtlDiv10"] = elem.ordrsDtlDiv10;
            detailObj["ordrsDtlDiv20"] = elem.ordrsDtlDiv20;
            detailObj["ordrsDtlDiv30"] = elem.ordrsDtlDiv30;
            detailObj["prdtCd"] = elem.prdtCd;
            detailObj["itemDiv"] = elem.itemDiv;
            //salesCd undefined처리
            if (elem.salesCd == undefined){
            	detailObj["salesCd"] = ''
            }
            else {
            	detailObj["salesCd"] = elem.salesCd;
            }
            
            detailObj["eqpNm"] = elem.eqpNm;
            detailObj["ordrsPrcMach"] = elem.ordrsPrcMach;
            detailObj["ordrsPrcElcty"] = elem.ordrsPrcElcty;
//          detailObj["ordrsPrc"] = parseFloat(elem.ordrsPrcMach.replace(/,/g, '')) + parseFloat(elem.ordrsPrcElcty.replace(/,/g, ''));
			detailObj["ordrsPrc"] = parseInt(elem.ordrsPrcMach) + parseInt(elem.ordrsPrcElcty);
            detailObj["ordrsQty"] = elem.ordrsQty;
            detailObj["estEpctMatPrc"] = elem.estEpctMatPrc;
            detailObj["trgtPchsPcostMach"] = elem.trgtPchsPcostMach;
            detailObj["trgtPchsPcostElcty"] = elem.trgtPchsPcostElcty;
            detailObj["trgtPchsPcostInHousePrcsn"] = elem.trgtPchsPcostInHousePrcsn;
            detailObj["dtlRmk"] = elem.dtlRmk;
            detailObj["machineValueAfterDeduction"] = elem.trgtPchsPcostMach - elem.trgtPchsPcostInHousePrcsn;

            var laborCostMfgCost = elem.laborCostMfgCost ? parseFloat(elem.laborCostMfgCost.replace(/,/g, '')) : 0;
            var machineValueAfterDeduction = detailObj["machineValueAfterDeduction"] ? parseFloat(detailObj["machineValueAfterDeduction"].toString().replace(/<[^>]*>|,/g, '')) : 0;

            if (isNaN(laborCostMfgCost)) {
                laborCostMfgCost = 0; // 또는 다른 기본값
            }

            if (isNaN(machineValueAfterDeduction)) {
                machineValueAfterDeduction = 0; // 또는 다른 기본값
            }


            detailObj["laborCostMfgCost"] = laborCostMfgCost;
            detailObj["machineValueAfterDeduction"] = machineValueAfterDeduction;

            totalLaborCostMfgCost += laborCostMfgCost;
            totalMachineValueAfterDeduction += machineValueAfterDeduction;


            detailArr.push(detailObj);

        });


        var totalSum = totalLaborCostMfgCost + totalMachineValueAfterDeduction; //laborCostMfgCost(금액)+machineVVauleAfterDeduction(차감 후 기계값)
        var ordrsAmtVal = parseFloat($("#ordrsAmt").val().replace(/,/g, '')); //수주금액에 적힌 값
 
        if (isNaN(ordrsAmtVal)) {
            ordrsAmtVal = 0; // 또는 다른 기본값
        }

//         if (totalSum != ordrsAmtVal) {
//             alert("합계가 입력 금액과 일치하지 않습니다(수금상세)");
//             return false
//         }


        formData.append("planArr", JSON.stringify(planArr));
        formData.append("detailArr", JSON.stringify(detailArr));
        
        return formData;
    }


    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#estCoprt').data("rprc", value);
        $('#estCoprt option:not([value=""])').remove()
        setCommonSelect($('#estCoprt'));
    }

    //Select 선택 코드값 체크하여 명을 출력
    function baseOptionChk(key, option) {
        rtnNm = "";
        for (var element of option) {
            if (key.value == element.CD) {
                rtnNm = element.NM;
                break;
            }
        }
        console.log('key:', key, 'return value:', rtnNm); //

        return rtnNm;
        
    }

    function fetchCurrencyData() {
        var paramObj = {"codeKind": "ORDRSDTLDIV10", "useYn": "Y"};    //수주설비입력구분
        var paramObj2 = {"codeKind": "ITEMLIST", "useYn": "Y"};       //아이템내역
        var paramObj3 = {"codeKind": "ORDRSDTLDIV20", "useYn": "Y"};    //수주설비작업구분
        var paramObj4 = {"codeKind": "ORDRSDTLDIV30", "useYn": "Y"};   //수주설비자체구분
        var paramObj5 = {"codeKind": "CLMNPLANDIV", "useYn": "Y"};  //수금계획구분
        var promise1 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options = codeList.map(function (code) {
                        return {
                            CD: code.codeId,
                            NM: code.codeNm
                        };
                    });
                    resolve(options);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        var promise2 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj2, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options2 = codeList.map(function (code) {
                        return {
                            CD: code.codeId,
                            NM: code.codeNm
                        };
                    });
                    resolve(options2);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        var promise3 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj3, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options3 = codeList.map(function (code) {
                        return {
                            CD: code.codeId,
                            NM: code.codeNm
                        };
                    });
                    resolve(options3);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        var promise4 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj4, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options4 = codeList.map(function (code) {
                        return {
                            CD: code.codeId,
                            NM: code.codeNm
                        };
                    });
                    resolve(options4);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        var promise5 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj5, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options5 = codeList.map(function (code) {
                        return {
                            CD: code.codeId,
                            NM: code.codeNm
                        };
                    });
                    resolve(options5);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        return Promise.all([promise1, promise2, promise3, promise4,promise5]);
    }



    var thisGridRow = "";
    var thisGridCol = "";
    var originalValues = {};
    /* 그리드 관련 함수 */
    // 그리드 생성
    var data = null;
    const gridOrdrsPlan = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2, options3, options4,options5]) {
    	
        gridOrdrsPlan.setConfig({
        			target : $('[data-ax5grid="first-grid-modal"]'),
        			//target: $('[data-ax5grid="ordrs-detail"]'),
                    header: {
                        align: "center",
                        selector: false
                    },
                    columns: [
                        {
                            key: "seq", label: "번호", width: 60, align: "center", formatter: function () {
                                return this.item.__index + 1;
                            },
                        },

                        {
                            key: "clmnPlanDiv",   label: "수금구분", align: "center",  width: 60,
                            editor: {
                                type: "select",
                                config: {columnKeys: {optionValue: 'CD', optionText: 'NM'},
                                options: options5
                                }
                            }, formatter: function () {
                               return baseOptionChk(this, options5);
                           }

                        },
                        {key: "clmnDivSeq", label: "차수", width: 60, align: "center", editor: {type: "text"}},
                        {
                            key: "clmnRate",
                            label: "비율",
                            width: 60,
                            align: "center",
                            editor: {type: "number"}

                        },
                        {
                            key: "clmnAmt",
                            label: "수금금액",
                            width: 95,
                            align: "right",
                            editor: {type: "number"}, formatter: "money"


                        },
                        {key: "clmnDt", label: "수주수금일자", width: 120, align: "center", 
                        	editor: {type: "date", 
					                      	  config: { content: { config: { mode: "day", selectMode: "day" }}}}
                        },
                        {
                            key: "pmntDtAfterBill",
                            label: "계산서 발행 후 지급시기(단위: 일)",
                            width: 240,
                            align: "center",
                            editor: {type: "number"}
                        },
                        {
                            key: "billPblsDt",
                            label: "계산서발행일자",
                            width: 120,
                            align: "center",
                            editor: {type: "date"
                            	, 
                            	  config: {
                                      content: {
                                    			 config: { mode: "day", selectMode: "day" }
                                  		       }
                        			      }
                        },
                            formatter: function () {
                                var clmnDt = new Date(this.item.clmnDt || new Date());
                                clmnDt.setDate(clmnDt.getDate() - (this.item.pmntDtAfterBill || 0));
                                var month = String(clmnDt.getMonth() + 1).padStart(2, '0');
                                var day = String(clmnDt.getDate()).padStart(2, '0');
                                var year = clmnDt.getFullYear();
                                return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
                            }
                        },
                        {key: "clmnMgmtStatus", label: "수금관리상황", width: 590, align: "left", editor: {type: "text"}},

                    ],
                    footSum: [
                        /*     [
                             {label: "총합계", align: "center", colspan: 7},
                             {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
                         ]*/
                    ],
                    body: {

                        onClick: function () {
                            this.self.clearSelect();
                            this.self.select(this.dindex);
                            selectedRowKey = this.dindex;
                            const data = gridOrdrsPlan.getList();  // 현재 그리드 데이터 가져오기
                            if (isFirstExecution) {
                                isFirstExecution = false;
                            }
                        },


                        onDataChanged: function () {
                            var data = gridOrdrsPlan.getList();
                            var totalRate = 0;
                            var totalAmt = 0;

                            for (var i = 0; i < data.length; i++) {
                                totalRate += parseFloat(data[i].clmnRate);
                            }
                            for (var i = 0; i < data.length; i++) {
                                totalAmt += parseFloat(data[i].clmnAmt);
                            }

                            var ordVal = $("#ordrsAmt").val().replace(/,/g, '');
                            var ordrsAmt = parseFloat(ordVal) || 0;
			                            if (totalRate > 100 || totalAmt > ordrsAmt) {
			                                if (totalRate > 100) {
			                                    alert('비율의 합계는 100%를 초과할 수 없습니다.');
			                                    // 비율의 합계가 100%를 초과하면, 원래의 데이터로 복원
			//                                     for (var i = 0; i < data.length; i++) {
			//                                         if (prevData[i]) {
			
			//                                             data[i].clmnRate = prevData[i].clmnRate;
			//                                             gridOrdrsPlan.getList()[i].clmnRate = prevData[i].clmnRate;
			//                                         }
			//                                     }
			                                }
			
			                                if (totalAmt > ordrsAmt) {
			                                    alert('수금금액의 합계는 주문 금액을 초과할 수 없습니다.');
			                                }
			
			                                for (var i = 0; i < data.length; i++) {
			                                    if (prevData[i]) {
			                                        data[i].clmnAmt = prevData[i].clmnAmt;
			                                        gridOrdrsPlan.getList()[i].clmnAmt = prevData[i].clmnAmt;
			                                    }
			                                }
			
			                            } else {
											
			                                for (let i = 0; i < data.length; i++) {
			                                    let currData = data[i];
			                                    ////////////////////////////////
			                                    // 현재 행이 이전에 변경되었는지 확인
// 			                                    if (prevData[i]) {
			                                    	
			                                       // let prevAmt = parseFloat(prevData[i].clmnAmt || 0);
			                                       // let currAmt = parseFloat(currData.clmnAmt || 0);
			                                       // let prevRate = parseFloat(prevData[i].clmnRate || 0);
			                                        //let currRate = parseFloat(currData.clmnRate || 0);

// 			                                        if (prevAmt !== currAmt) {
			                                        	if( this.key == "clmnAmt" ) {
				                                            //clmnAmt가 변경되었으면 clmnRate를 업데이트
				                                            currData.clmnRate = parseInt(calculateRate((currData.clmnAmt).replace(/,/g, '')));
				                                            
			                                        	}
// 			                                            // 현재 clmnRate와 clmnAmt를 이전 데이터로 저장
// 			                                            if (!prevData[i]) {
// 			                                                prevData[i] = {};
// 			                                            }
// 			                                            prevData[i].clmnAmt = currData.clmnAmt;
// 			                                            prevData[i].clmnRate = currData.clmnRate // store the updated rate too
// 			                                        } else if (prevRate !== currRate) {
														 if( this.key == "clmnRate" ) {
				                                           	 //clmnRate가 변경되었으면 clmnAmt를 업데이트
				                                            currData.clmnAmt = calculateAmt(currData.clmnRate).toLocaleString();
														 }
			                                            // 현재 clmnRate와 clmnAmt를 이전 데이터로 저장
// 			                                            if (!prevData[i]) {
// 			                                                prevData[i] = {};
// 			                                            }
// 			                                            prevData[i].clmnRate = currData.clmnRate;
// 			                                            prevData[i].clmnAmt = currData.clmnAmt; // store the updated amt too
// 			                                        }
// 			                                    }
			                                    //////////////////
			                                }

			                            }

                            gridOrdrsPlan.setData(data);
                        }
                    },
                    contextMenu: {
                        iconWidth: 20,
                        acceleratorWidth: 100,
                        itemClickAndClose: false,
                        icons: {
                            'arrow': '<i class="fa fa-caret-right"></i>'
                        },
                        items: [
                            {type: 1, label: "붙여넣기"},
                            {divide: true},
                            {
                                label: "작업선택",
                                items: [
                                    {type: 1, label: "줄추가"},
                                    {type: 1, label: "내용 삭제"},
                                    {type: 2, label: "줄삭제"},
                                ]
                            },
                        ],
                        popupFilter: function (item, param) {
                            //console.log(item, param);
                            if (param.element) {
                                return true;
                            } else {
                                return item.type == 1;
                            }
                        },
                        onClick: function (item, param) {
                            console.log(item, param);
                            thisGridRow = param.dindex;
                            thisGridCol = param.colIndex;

                            if (item.label == "붙여넣기") {
                                gridPaste(thisGridRow, thisGridCol);
                            } else if (item.label == "줄추가") {
                                console.log('추가 인덱스 :', param.dindex);
                                //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                                gridOrdrsPlan.addRow($.extend({}, gridOrdrsPlan.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                                gridOrdrsPlan.setValue(param.dindex, 'updcheck', 1);

                            } else if (item.label == "내용 삭제") {
                                console.log('내용삭제 인덱스 :', param.dindex);

                                gridOrdrsPlan.config.columns.forEach((column) => {
                                    gridOrdrsPlan.setValue(param.dindex, column.key, '');
                                    gridOrdrsPlan.setValue(param.dindex, 'updcheck', 1);
                                    console.log('내용삭제 :', param.dindex, column.key);
                                });

                            } else if (item.label == "줄삭제") {
                                console.log('삭제 인덱스 :', param.dindex);
                                gridOrdrsPlan.removeRow(param.dindex);
                                //삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
// 		                		gridOrdrsPlan.setValue(param.dindex, 'delcheck', 1);
                            }


                            gridOrdrsPlan.contextMenu.close();
                            //또는 return true;
                        }
                    },


                });


   })


    let isFirstExecution = true;
    let prevData = [];
    let checkDataInterval = null;

    checkDataInterval = setInterval(() => {
        let data = gridOrdrsPlan.getList();
        if (data.length > 0) {
            prevData = JSON.parse(JSON.stringify(data));
            clearInterval(checkDataInterval);
            // 여기에서 그리드 데이터가 준비된 후 실행하려는 코드를 추가할 수 있습니다.
        }
    }, 100);


    function getOrdrsAmt() {
        var ordVal = $("#ordrsAmt").val().replace(/,/g, '');
        return parseFloat(ordVal) || 0;
    }

    // 수금비율을 사용해 수금금액을 계산하는 함수
    function calculateAmt(rate) {
        const clmnRateFloat = parseFloat(rate) || 0;
        const ordrsAmt = getOrdrsAmt();

        if (isNaN(ordrsAmt) || isNaN(clmnRateFloat)) {        	
            console.error("Invalid input");
            return;
        }
        return ordrsAmt * (clmnRateFloat / 100);
    }

    // 수금금액을 사용해 수금비율을 계산하는 함수
    function calculateRate(amt) {
        const clmnAmtFloat = parseFloat(amt) || 0;
        const ordrsAmt = getOrdrsAmt();

        if (isNaN(ordrsAmt) || isNaN(clmnAmtFloat)) {
            console.error("Invalid input");
            return;
        }
        return (clmnAmtFloat / ordrsAmt) * 100;
    }

    function calculateNewAmt(ordrsAmt, clmnRate) {
        return (ordrsAmt * clmnRate / 100).toLocaleString();
    }

    $("#ordrsAmt").change(function () {
        // Get the new value
        var ordVal = $("#ordrsAmt").val().replace(/,/g, '');
        var ordrsAmt = parseFloat(ordVal) || 0;

        // Get the current data from the grid
        const data = gridOrdrsPlan.getList();

        // Recalculate the grid data based on the new ordrsAmt
        // (This depends on how you want to adjust the grid data)
        for (var i = 0; i < data.length; i++) {
            // Update clmnAmt based on new ordrsAmt value
            data[i].clmnAmt = calculateNewAmt(ordrsAmt, data[i].clmnRate); // Assume you have a function to do this
        }

        // Set the data back to the grid
        gridOrdrsPlan.setData(data);
    });
    
    //견적서번호 지울경우 견적차수도 지워지게 처리
    $("#estNoOrdrs").change(function () {
    	var ordNo = $("#estNoOrdrs").val()
    	if (isNaN(ordNo) || ordNo == ""){
    		$("#estDeg").val("");
    	}
			
    });


    const gridOrdrsDetail = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2, options3, options4, options5]) {

        gridOrdrsDetail.setConfig({
            multipleSelect: false,
            //target: $('[data-ax5grid="ordrs-detail"]'),
            target : $('[data-ax5grid="second-grid-modal"]'),
            header: {
                align: "center",
                selector: false
            },
            columns: [
                {
                    key: "seq", label: "No", width: 40, align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },

                {
                    key: "ordrsDtlDiv10",
                    label: "입력구분",
                    width: 80,
                    align: "center",
                    editor: {
                        type: "select", disabled: function () { return this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010' && this.item.salesCd != ''; }, 
                        config: {
                            columnKeys: {
                                optionValue: 'CD',
                                optionText: 'NM'
                            },
                            options: options
                        }
                    }, formatter: function () {
                        return baseOptionChk(this, options);
                    }
                },


                {key: "prdtCd", label: "제품구분", align: "center", width: 60},
                {
                    key: "itemDiv", label: "아이템구분", align: "center", width: 80,
                    editor: {
                        type: "select", disabled: function () { return this.item.dataChk == "U" || this.item.ordrsDtlDiv10 !== 'ORDRSDTLDIV1010'; },
                        config: {
                            columnKeys: {
                                optionValue: 'CD',
                                optionText: 'NM'
                            },
                            options: options2
                        }
                    }, formatter: function () {
                        return baseOptionChk(this, options2);
                    }
                },

                {
                    key: "ordrsDtlDiv20", label: "작업구분", align: "center", width: 80,
                    editor: {
                        type: "select", disabled: function () { return this.item.ordrsDtlDiv10 !== 'ORDRSDTLDIV1010'; },
                        config: {
                            columnKeys: {
                                optionValue: 'CD',
                                optionText: 'NM'
                            },
                            options: options3
                        }
                    }, formatter: function () {
                        return baseOptionChk(this, options3);
                    }
                },
                {
                    key: "ordrsDtlDiv30", label: "자체구분", align: "center", width: 60,
                    editor: {
                        type: "select", disabled: function () { return this.item.ordrsDtlDiv10 !== 'ORDRSDTLDIV1010'; },
                        config: {
                            columnKeys: {
                                optionValue: 'CD',
                                optionText: 'NM'
                            },
                            options: options4
                        }
                    }, formatter: function () {
                        return baseOptionChk(this, options4);
                    }
                },

                {key: "dataChk", label: "비활성화체크", align: "center", width: 40, hidden: true},
                {key: "salesCd", label: "영업코드", align: "center", width: 80},
                {key: "eqpNm", label: "설비명", align: "center", width: 255, editor: {type: "text"}},

                {
                    key: undefined, label: "수주가", columns: [

                        {
                            key: "ordrsPrcMach",
                            label: "기계PART",
                            align: "right",
                            width: 80,
                            editor: {type: "number"},
                            formatter: "money"
                        },
                        {
                            key: "ordrsPrcElcty",
                            label: "전기PART",
                            align: "right",
                            width: 80,
                            editor: {type: "number"},
                            formatter: "money"
                        },
                        {
                            key: "ordrsPrc", label: "합계", align: "right", width: 80,
                            formatter: function () {
                                color = '#0000FF';
                                const ordrsPrcMach = isNaN(parseFloat(this.item.ordrsPrcMach)) ? 0 : parseFloat(this.item.ordrsPrcMach);
                                const ordrsPrcElcty = isNaN(parseFloat(this.item.ordrsPrcElcty)) ? 0 : parseFloat(this.item.ordrsPrcElcty);
                                const sum = ordrsPrcMach + ordrsPrcElcty;
                                return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
                            }
                        },

                    ]
                },


                {key: "ordrsQty", label: "수량", align: "right", width: 40, editor: {type: "number"}},
                {
                    key: "estEpctMatPrc",
                    label: "견적 예상 재료비",
                    align: "right",
                    width: 130,
                    editor: {type: "number"},
                    formatter: "money"
                },

                {
                    key: undefined, label: "목표구매원가", columns: [

                        {
                            key: undefined, label: "목표구매원가", columns: [{
                                key: "trgtPchsPcostMach",
                                label: "기계",
                                align: "right",
                                width: 110,
                                editor: {type: "number"},
                                formatter: "money"
                            },
                                {
                                    key: "trgtPchsPcostElcty",
                                    label: "전기",
                                    align: "right",
                                    width: 110,
                                    editor: {type: "number"}
                                    , formatter: "money"
                                },
                                {
                                    key: "sum",
                                    label: "합계",
                                    align: "right",
                                    width: 100,
                                    formatter: function () {
                                        color = '#0000FF';
                                        const trgtPchsPcostMach = isNaN(parseFloat(this.item.trgtPchsPcostMach)) ? 0 : parseFloat(this.item.trgtPchsPcostMach);
                                        const trgtPchsPcostElcty = isNaN(parseFloat(this.item.trgtPchsPcostElcty)) ? 0 : parseFloat(this.item.trgtPchsPcostElcty);
                                        const sum = trgtPchsPcostMach + trgtPchsPcostElcty;
                                        return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
                                    }
                                },

                            ]
                        },
                        {
                            key: undefined, label: "자체가공 투입시 기계부문 목표원가", columns: [

                                {
                                    key: "trgtPchsPcostInHousePrcsn",
                                    label: "자체 가공",
                                    align: "right",
                                    width: 100,
                                    editor: {type: "number"}
                                    , formatter: "money"
                                },
                                {
                                    key: "machineValueAfterDeduction",
                                    label: "차감 후 기계값",
                                    align: "right",
                                    width: 100,
                                    formatter: function () {
                                        color = '#0000FF';
                                        const trgtPchsPcostMach = isNaN(parseFloat(this.item.trgtPchsPcostMach)) ? 0 : parseFloat(this.item.trgtPchsPcostMach);
                                        const trgtPchsPcostInHousePrcsn = isNaN(parseFloat(this.item.trgtPchsPcostInHousePrcsn)) ? 0 : parseFloat(this.item.trgtPchsPcostInHousePrcsn);
                                        const sum = trgtPchsPcostMach - trgtPchsPcostInHousePrcsn;
                                        return '<div style="color: ' + color + '">' + sum.toLocaleString() + '</div>';
                                    }
                                },
                            ]
                        }
                    ]
                },

                {
                    key: undefined, label: "실집행 원가", columns: [
                        {
                            key: undefined, label: "노무비 및 제조경비(판관비 제외)", columns: [
                                {
                                    key: "laborCostMfgCost",
                                    label: "금액",
                                    align: "right",
                                    width: 180,
                                    editor: {type: "number"},
                                    formatter: "money"
                                },
                            ]
                        }
                    ]
                }
            ],
            footSum: [
                /*      [
                          {label: "총합계", align: "center", colspan: 7},
                          {key: "estAmt", collector: "sum", formatter: "money", align: "right"},
                      ]*/
            ],
            body: {
                onClick: function () {
                    this.self.select(this.dindex);
                    thisGridRow = this.dindex;
                    thisGridCol = this.colIndex;
                    selectedRowKey2 = this.dindex;
                   
                    // 제품구분(prdtCd)이거나 등록일 경우에만 실행하도록
                    if (this.column.key == 'prdtCd' && actionType == 'C' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010' && this.item.dataChk != 'U') {
                        openSecondPrdtSearch();       
                    }

                },
                columnHeight: 26,
                onDataChanged: function () {
                	var row = this.dindex;
				    var col = this.colIndex;
				    
                    const data = gridOrdrsDetail.getList();
                    gridOrdrsDetail.setData(data);

                    if (this.key == 'isChecked') {
                        this.self.updateChildRows(this.dindex, {isChecked: this.item.isChecked});
                    } else if (this.key == '__selected__') {
                        this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
                    }
                    //입력구분이고 해당 값이 저게 아닐때 해당셀을 빈값으로 세팅
                    if (this.key == 'ordrsDtlDiv10' && this.item.ordrsDtlDiv10 != 'ORDRSDTLDIV1010') {
                    	gridOrdrsDetail.setValue(row, 'prdtCd', "");
                    	gridOrdrsDetail.setValue(row, 'itemDiv', "");
                    	gridOrdrsDetail.setValue(row, 'ordrsDtlDiv20', "");
                    	gridOrdrsDetail.setValue(row, 'ordrsDtlDiv30', "");
                    }
                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons:
                    {
                        'arrow': '<i class="fa fa-caret-right"></i>'
                    },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter:

                    function (item, param) {
                        //console.log(item, param);
                        if (param.element) {
                            return true;
                        } else {
                            return item.type == 1;
                        }
                    },
                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        gridOrdrsDetail.addRow($.extend({}, gridOrdrsDetail.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        gridOrdrsDetail.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        gridOrdrsDetail.config.columns.forEach((column) => {
                            gridOrdrsDetail.setValue(param.dindex, column.key, '');
                            gridOrdrsDetail.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        gridOrdrsDetail.removeRow(param.dindex);
                        //삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
// 		                		gridOrdrsDetail.setValue(param.dindex, 'delcheck', 1);
                    }


                    gridOrdrsDetail.contextMenu.close();
                    //또는 return true;
                }
            }

        });
    })

    var actionType = modalStack.last().paramObj.actionType;
    var paramObj = modalStack.last().paramObj;

    var deleteFileArr = [];
    var selectedNodeId = "";
    var fileTrgtTyp = "";

    function setCurrentDateToDatePicker(selector) {
        var currentDate = new Date();
        currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset()); // 시간대를 고려한 날짜 시간 조정
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1; // 월은 0부터 시작하므로 1을 더합니다.
        var day = currentDate.getDate();

// 월과 일이 한 자리수라면 앞에 '0'을 추가합니다.
        if (month < 10) month = '0' + month;
        if (day < 10) day = '0' + day;

        var formattedDate = year + '-' + month + '-' + day;
        $(selector).val(formattedDate);

    }

    if (actionType == "C") {
        $('#actionOrdrsBtn').on("click", function () {
            insertOrdrs();


        });
//         setCurrentDateToDatePicker('#fwdExchJoinDt');
//         setCurrentDateToDatePicker('.input_calendar');

    } else if (actionType == "DC") {

        // treeModule.initFileArrays();
        $(".modal-estNoOrdrs").val(modalStack.last().paramObj.estNo)
        $(".modal-coCd").val(modalStack.last().paramObj.coCd)
        $("#ordrsClntNm").val(modalStack.last().paramObj.ordrsClntNm)
        $("#ordrsClntCd").val(modalStack.last().paramObj.ordrsClntCd)
        $("#clntPjt").val(modalStack.last().paramObj.clntPjt)
        $("#mngId").val(modalStack.last().paramObj.mngId)
        $("#exrate").val(modalStack.last().paramObj.exrate)
        $("#ordrsDiv").val("ORDRSDIV1");
        $("#pmntMtd").val("현금");
        $(".clntPjtOrdrs").val(modalStack.last().paramObj.clntPjt);


        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();


        $(document).on('click', function (e) {

            if ($(e.target).is('BODY') || $(e.target).is('.close_btn')) {
                // If the clicked element is a button
                $(".ax-mask").hide();
                location.reload();

            } else {
                // If the clicked element is not a button
                $(".ax-mask").show();
            }
        });


        $('#actionOrdrsBtn').on("click", function () {
            insertOrdrs();


        });
        setCurrentDateToDatePicker('#fwdExchJoinDt');
        setCurrentDateToDatePicker('.input_calendar');

    } else if (actionType == "U") {
    	//타이틀명 변경
		$('.tit').text('수주 수정')
		
		//회사 비활성화
		$('#popForm .coCd').removeClass('hit');
		$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//견적서번호 비활성화
		$('#popForm .estNoOrdrs').removeClass('hit');
		$('#estNoOrdrs').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//수주일자 비활성화
		$('#popForm .ordrsDt').removeClass('hit');
		$('#ordrsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//고객사 비활성화
		$('#popForm .ordrsClntNm').removeClass('hit');
		$('#ordrsClntNm').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//수주금액 비활성화
		$('#popForm .ordrsAmt').removeClass('hit');
		$('#ordrsAmt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		
        $("#ordrsPlanHis").show();
        $('#pmntMtd').val('PMNTMTD01');
        //$('#zip_down').show();
        postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {
            var parsedData = data;
            // Set the input field values with the received data
            Object.keys(parsedData.ordrsInfo).forEach(function (key) {

                var inputField = document.getElementById(key == 'estNo' ? 'estNoOrdrs' : key);
				
                if (!inputField) return;

                var value = parsedData.ordrsInfo[key];
                
                switch (key) {
                    case 'ordrsClntCd':
                        var clntNmField = document.getElementById('ordrsClntNm');
                        var clntCdField = document.getElementById('ordrsClntCd');
                        if (clntNmField) {
                            postAjax("/admin/bm/bm02/selectClntInfo", {"clntCd": value}, null, function (data) {
                                clntNmField.value = data.clntInfo.clntNm;
                            });
                        }
                        break;
                    case 'ordrsDiv':
                        if (value == 'ORDRSDIV1') {
                            $('#orgnSalesCdTd,#orgnSalesCdTh').hide();
                        }
                        else {
                        	inputField.value = value || '';
                        	$('#orgnSalesCdTd,#orgnSalesCdTh').show();
                        }
                        break;
                    case 'ordrsAmt':
                        inputField.value = (value != null && value != '') ? value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '';
                        break;
                    case 'mngId':
                        var mngIdField = document.getElementById('mngId');
                        var mngIdVisibleField = document.getElementById('mngIdVisible');
                        mngIdField.value = parsedData.ordrsInfo[key];
                        if (mngIdVisibleField) {
                            var paramObj = {
                                "userId": parsedData.ordrsInfo[key],
                            };
                            postAjaxSync("/admin/cm/cm06/selectUserInfo", paramObj, null, function (data) {
                                mngIdVisibleField.value = data.userInfo.name;
                            });
                        }
                        break;
                    default:
                        inputField.value = value || '';
                        break;
                }
            });

            
            //수정시  로드 될떄 gridOrdrsPlan 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var pmntPlans = data.ordrsInfo.plans;
			
            gridOrdrsPlan.setData({
                list: pmntPlans,
                page: {
                    totalElements: pmntPlans.length
                }
            });
			
            //수정시  로드 될떄 orderDetails 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var ordrsDetails = data.ordrsInfo.details;
			
            gridOrdrsDetail.setData({
                list: ordrsDetails,
                page: {
                    totalElements: ordrsDetails.length
                }
            });


        });
        
      	//버튼명 변경
		$('#actionOrdrsBtn').text("수정");

		//버튼 클릭 시
        $('#actionOrdrsBtn').on("click", function () {
            updateOrdrs();

        });


    }


    // treeModule.initAll('deptTreeOrdars', 'file-grid', 'FITR02', paramObj);

    //type ,key  2개를 넘기는 것으로 권한 체크 용도
    function validateRequiredFields() {
        // gridOrdrsDetail 리스트 검사
        // gridOrdrsPlan 리스트 검사
        // const dataOrdrsPlan = gridOrdrsPlan.getList();
        //
        // for (let i = 0; i < dataOrdrsPlan.length; i++) {
        //     const row = dataOrdrsPlan[i];
        //
        //     // 필수 입력 필드 검사
        //     if (!row.clmnPlanDiv || !row.clmnDivSeq || !row.clmnRate || !row.clmnAmt ||
        //         !row.billPblsDt || !row.clmnDt || !row.pmntDtAfterBill || !row.clmnPlanRmk) {
        //         alert(`수주 수금 계획 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
        //         return false;
        //     }
        // }

        const dataOrdrsDetail = gridOrdrsDetail.getList();

        // for (let i = 0; i < dataOrdrsDetail.length; i++) {
        //     const row = dataOrdrsDetail[i];
        //
        //     // 필수 입력 필드 검사
        //     if (!row.ordrsDtlDiv10 || !row.prdtCd || !row.itemDiv || !row.eqpNm ||
        //         !row.ordrsPrcMach || !row.ordrsPrcElcty || !row.ordrsPrc || !row.ordrsQty ||
        //         !row.estEpctMatPrc || !row.trgtPchsPcostMach || !row.trgtPchsPcostElcty ||
        //         !row.trgtPchsPcostInHousePrcsn || !row.laborCostMfgCost || !row.dtlRmk) {
        //         alert(`수주 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
        //         return false;
        //     }
        // }


        return true;
    }


//     // 기존 addDtlDiv 함수를 아래와 같이 수정하세요.
//     function addDtlDiv(gridInstance, estDtlDivLetter, itemCount) {


//         const columns = gridInstance.config.columns; // 컬럼 설정 가져오기
//         const divData = [];

//         for (let i = 1; i <= itemCount; i++) {
//             const newRow = {};

//             columns.forEach((column) => {
//                 const key = column.key;
//                 if (key) {
//                     newRow[key] = column.defaultValue || null;
//                 }
//             });


//             if (gridInstance === gridOrdrsPlan) {
//                 newRow.clmnPlanDiv = estDtlDivLetter; // gridOrdrsPlan의 경우
//             } else if (gridInstance === gridOrdrsDetail) {
//                 newRow.ordrsDtlDiv10 = estDtlDivLetter; // gridOrdrsDetail의 경우
//             }
//             divData.push(newRow);
//         }

//         const data = gridInstance.getList();
//         gridInstance.setData([...data, ...divData]);
//     }


    $("#addPaymentButton").on("click", function () {
        var row;

		var newRowData = {
				clmnPlanDiv: "",
				clmnDivSeq : 1,
				clmnRate : 0,
				clmnAmt : 0,
				clmnDt : "",
				pmntDtAfterBill : "",
				billPblsDt : "",
				clmnMgmtStatus : "",
		};

        var ordrsAmtVal = parseFloat($("#ordrsAmt").val().replace(/,/g, '')); //수주금액에 적힌 값

        if (ordrsAmtVal == 0 || ordrsAmtVal == ""){
        	alert("수주금액을 입력바랍니다.");
        	return false;
        }
        else {
		        // 첫 번째 경우: 선택된 행이 있는 경우
		        if (selectedRowKey !== undefined) {
		            let row = gridOrdrsPlan.getList("selected")[0];
		            let newRowData = $.extend({}, row, {__index: undefined, clmnRate: 0, clmnAmt: 0});
		            gridOrdrsPlan.addRow(newRowData, row.__index + 1);
		        }
		        // 두 번째 경우: 그리드가 비어 있는 경우
		        else if (gridOrdrsPlan.getList().length === 0) {
		            gridOrdrsPlan.addRow(newRowData, 0);
		        }
		        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
		        else {
		            gridOrdrsPlan.addRow(newRowData, gridOrdrsPlan.length);
		            return;
		        }
		
			        const data = gridOrdrsPlan.getList();
			        gridOrdrsPlan.setData({
			            list: data,
			            page: {
			                totalElements: data.length
			            }
			        });
        }
        prevData = JSON.parse(JSON.stringify(gridOrdrsPlan.getList()));
        // 여기에서 그리드 데이터가 준비된 후 실행하려는 코드를 추가할 수 있습니다.

    });

    $("#deletePaymentButton").on("click", function () {
        if (selectedRowKey !== undefined) {
            gridOrdrsPlan.removeRow(selectedRowKey);
            const data = gridOrdrsPlan.getList();
            gridOrdrsPlan.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                    gridOrdrsPlan.select(selectedRowKey);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey = selectedRowKey - 1;
                    gridOrdrsPlan.select(selectedRowKey);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });


    $("#addDetailButton").on("click", function () {
        var row;

		var newRowData = {
			ordrsDtlDiv10 : "",
			prdtCd : "",
			itemDiv : "",
			ordrsDtlDiv20 : "",
			ordrsDtlDiv30 : "",
			salesCd : "",
			eqpNm : "",
			ordrsPrcMach : 0,
			ordrsPrcElcty : 0,
			ordrsQty : 0,
			estEpctMatPrc : 0,
			trgtPchsPcostMach : 0,
			trgtPchsPcostElcty : 0,
			trgtPchsPcostInHousePrcsn : 0,
			laborCostMfgCost : 0,
		};
        var ordrsAmtVal = parseFloat($("#ordrsAmt").val().replace(/,/g, '')); //수주금액에 적힌 값
        var bordrsDiv = $("#ordrsDiv").val() //수주구분
      	//수주구분 : 정상수주가 아닐경우
 		if (bordrsDiv != 'ORDRSDIV1' && gridOrdrsDetail.getList().length >=1) {  
         	alert("수주구분이 A/S에서는 1줄만 추가 가능합니다.");
         	return false;
        }
         
        
        if (ordrsAmtVal == 0 || ordrsAmtVal == ""){
        	alert("수주금액을 입력바랍니다.");
        	return false;
        }

        else {
		       	// 첫 번째 경우: 선택된 행이 있는 경우
		        if (selectedRowKey2 !== undefined) {
		            let row = gridOrdrsDetail.getList("selected")[0];
		            //let newRowData = $.extend({}, row, {__index: undefined}); //선택한 행의 데이터 newRowData 담기
		            //gridOrdrsDetail.addRow(newRowData, row.__index + 1);
		            gridOrdrsDetail.addRow(newRowData, gridOrdrsDetail.length);
		        }
		        // 두 번째 경우: 그리드가 비어 있는 경우
		        else if (gridOrdrsDetail.getList().length === 0) {
		            gridOrdrsDetail.addRow(newRowData, 0);
		        }
		        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
		        else {
		            gridOrdrsDetail.addRow(newRowData, gridOrdrsDetail.length);
		            return;
		        }
		
		        const data = gridOrdrsDetail.getList();
		        gridOrdrsDetail.setData({
		            list: data,
		            page: {
		                totalElements: data.length
		            }
		        });
        }
    });


    $("#deleteDetailButton").on("click", function () {
        if (selectedRowKey2 !== undefined) {
            gridOrdrsDetail.removeRow(selectedRowKey2);
            const data = gridOrdrsDetail.getList();
            gridOrdrsDetail.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey2 < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                    gridOrdrsDetail.select(selectedRowKey2);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey2 = selectedRowKey2 - 1;
                    gridOrdrsDetail.select(selectedRowKey2);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey2 = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });


    // 각 버튼에 대한 클릭 이벤트 처리 함수를 작성합니다.
    function handleButtonClick(event) {

        const buttonId = event.target.id;
        const itemCount = 1;
        let divLetter;
        let targetGrid;

        switch (buttonId) {
            case "depositButton":
                divLetter = "계약금";
                targetGrid = gridOrdrsPlan;
                break;
            case "installmentButton":
                divLetter = "중도금";
                targetGrid = gridOrdrsPlan;
                break;
            case "balanceButton":
                divLetter = "잔금";
                targetGrid = gridOrdrsPlan;
                break;
            case "advanceButton":
                divLetter = "선급금";
                targetGrid = gridOrdrsPlan;
                break;
            case "equipmentButton":
                divLetter = "설비";
                targetGrid = gridOrdrsDetail;
                break;
            case "additionalCostButton":
                divLetter = "부대비용";
                targetGrid = gridOrdrsDetail;
                break;
            case "extraCostButton":
                divLetter = "추가비용";
                targetGrid = gridOrdrsDetail;
                break;
        }

        addDtlDiv(targetGrid, divLetter, itemCount);
    }


    function insertOrdrs() {
        // validateRequiredFields() && inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))
        if (true) {
            var formData = makeFormData();
     
            if (formData) {
                filePostAjax("/user/cr/cr02/insertOrdrs", formData, function (data) {

                    if (data.resultCode == 200) {
                        alert("저장 되었습니다.");
                        var odrSeq = data.odrSeq;
                        modalStack.close();
                        gridView.setData(0);
                        setTimeout(function () {

                        }, 500);
                    }
                });
            } else {

            }
        }
    }

    function updateOrdrs() {
        if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            
            if (formData) {
                filePostAjax("/user/cr/cr02/updateOrdrs", formData, function (data) {

                    if (data.resultCode == 200) {
                        var odrSeq = $('#odrSeq').val();
                        alert("정상적으로 update 되었습니다.");
                        modalStack.close();
                        gridView.setData(0);
                        setTimeout(function () {

                        }, 500);
                    }
                });
            } else {

            }
        }
    }

    var coCd;
    var coCdChanged = false;

    // 모달 초기화 함수
    function resetModal() {
        // 모달 내부의 모든 입력 필드 초기화
        var modalInputs = document.querySelectorAll(" input,  textarea,  select:not(#coCd)");
        modalInputs.forEach(function (input) {
            input.value = "";
        });
    }

    // coCd 변경 이벤트 리스너
    document.getElementById("coCd").addEventListener("change", function (event) {
        var newCoCd = event.target.value;
        console.log("coCd 변경됨: ", newCoCd);

        // 처음 변경하는 경우
        if (!coCdChanged) {
            coCd = newCoCd;
            coCdChanged = true;
        }
        // 사용자에게 변경 확인
        else if (confirm("회사 코드를 변경하시겠습니까? 이 경우 모달의 모든 값이 초기화됩니다.")) {
            coCd = newCoCd;

            // 모달 초기화
            resetModal();
        } else {
            // 사용자가 변경을 취소한 경우, coCdSelect 값을 원래대로 되돌림
            event.target.value = coCd;
        }
    });


    function openSecondPrdtSearch() {

        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#estClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            // 모달에서 선택된 행의 제품 코드를 가져옵니다.
            var prdtCd = grid.target.getList("selected")[0].prdtCd;

            // 메인 그리드에서 현재 선택된 행의 인덱스를 가져옵니다.
            var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];

            // 현재 선택된 행의 데이터를 가져옵니다.
            var rowData = gridOrdrsDetail.getList()[rowIndex];

            // 제품 코드를 업데이트합니다.
            rowData.prdtCd = prdtCd;

            // 행을 업데이트합니다.
            gridOrdrsDetail.updateRow(rowData, rowIndex);
        });
    }


    $("#ordrsPlanHis").click(function () {
        var paramObj = {
            "coCd": $("#coCd").val(),
            "ordrsNo": $("#ordrsNo").val(),
        };


        openSecondModal("/static/html/cmn/modal/ordrsPlanHisSearch.html", 1000, 420, "수금계획수정이력", paramObj, function (grid) {

        });


    })

    // 사용자 검색 함수
    function openSecondUserSearch(searchValue) {

        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        var paramObj = {
            "coCd": "GUN", //$('#coCd').val(),
            "userId": $('#salesEmpId').val(),
            "useYn": "Y",
            "searchValue": searchValue
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#mngId").val(checkedNode.id);
            $("#mngIdVisible").val(checkedNode.text);
            // $("#salesEmpNm").val(checkedNode.text);
            $("#mngId").focus();
            $("#mngId").trigger("click");
        });
    }

    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd').val(),
           "salesCd": $('#orgnSalesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/SalesCodeItemSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            //설비인것만 세팅
			if (row.ordrsDtlDiv10 == 'ORDRSDTLDIV1010'){
				var newRowData = {
	        			ordrsDtlDiv10 : row.ordrsDtlDiv10,
	        			prdtCd : row.prdtCd,
	        			itemDiv : row.itemDiv,
	        			ordrsDtlDiv20 : row.ordrsDtlDiv20,
	        			ordrsDtlDiv30 : row.ordrsDtlDiv30,
	        			salesCd : row.salesCd,
	        			eqpNm : row.eqpNm,
	        			ordrsPrcMach : 0,
	        			ordrsPrcElcty : 0,
	        			ordrsQty : 0,
	        			estEpctMatPrc : 0,
	        			trgtPchsPcostMach : 0,
	        			trgtPchsPcostElcty : 0,
	        			trgtPchsPcostInHousePrcsn : 0,
	        			laborCostMfgCost : 0,
	        			dataChk : "U"
	        		};

	            gridOrdrsDetail.addRow(newRowData, 0);
	            gridOrdrsDetail.removeRow(1);
	               $('#orgnSalesCd').val(row.salesCd);  //SalesCd
	               $('#ordrsClntCd').val(row.ordrsClntCd); //고객코드
	               $('#ordrsClntNm').val(row.ordrsClntNm); //고객명
	               $('#clntPjt').val(row.clntPjt);    //고객사PJT
//	             $('#prdtCd').val(row.prdtCd);   
//	 			 $('#prdtNm').val(row.prdtCdNm);
//	             $('#itemDiv').val(row.itemDiv);
//	             $('#itemDivNm').val(row.itemDivNm);
			}
			else {
				alert("설비가 아닙니다.\n다시 선택해 주십시오.");
				return;
			}
            
        });
    }

    $("#ordrsDiv").change(function () {
    	var aordrsDiv = $("#ordrsDiv").val()
		
		if (aordrsDiv != 'ORDRSDIV1') {  //수주구분 : 정상수주가 아닐경우
			//견적서번호 비활성화
			$('#popForm .estNoOrdrs').removeClass('hit');
			$('#estNoOrdrs').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//견적서번호, 견적차수 빈값
			$('#estNoOrdrs').val("");
			$('#estDeg').val("");
			
			if (gridOrdrsDetail.getList().length > 1){ //2번째 그리드 줄 수가 1이상이면
				for (var i = gridOrdrsDetail.getList().length; i >= 1; i--){ //그리드 줄 수 1개만 남기고 삭제
					//document.getElementById("deleteDetailButton").click();
					 gridOrdrsDetail.removeRow(i);
				}
			}
		}
			
    });
</script>


</html>
