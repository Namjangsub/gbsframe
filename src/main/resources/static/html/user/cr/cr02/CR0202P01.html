<style>
.truncate_multi_post {
	width: 802px;
	resize: none;
	padding: 1px;
	border: solid 1px #e6e6e6;
	border-radius: 5px;
	display: -webkit-box;
	word-wrap: break-word;
	text-align: left;
}
</style>

<!--  //class=coAuthChk : 회사구분에 따른 권한관리용 (건양은 투루넷 권한 제거, 트루넷은 건양 권한 제거) -->

<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit" id="cr02PopTit">수주 등록</h4>
	</div>

	<!-- <div>
		<a class="tbody_more_btn"></a>
	</div> -->

	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<div id="createHistoryDiv" class="contents_tit">
				<div class="add_btn_small pdl10">
					<button type="button" id="taskBtn" onclick="openSecondModalTaskPop();">과제관리</button>
					<a id="ReportMain" onclick="setReportMain();" style="height: 30px; line-height: 28px; width: 100px;">원가관리표 출력</a>
					<a id="viewHistory" onclick="comparison_cr14_Modal();" style="height: 30px; line-height: 28px; width: 100px;">변경이력 조회</a>
					<a id="createHistory" onclick="createHistory();" class="coAuthChk" style="height: 30px; line-height: 28px; width: 60px;" authchk>Ver.Up</a>
				</div>
			</div>

			<input type="hidden" id="pgmId" name="pgmId" value="CR0202P01">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">
			<table>
				<colgroup>
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th class="hit">회사</th>
					<td><select data-search="coCd" id="coCd" name="coCd"
						class="modal-coCd" style="width: 100%;" data-kind="CO" required
						msg="회사">
					</select></td>

					<th>견적서번호</th>
					<td>
						<div class="search_form">
							<input
								onkeydown="if(event.keyCode==13) openSecondEstSearch(this.value);"
								type="text" id="estNoOrdrs" name="estNoOrdrs"
								class="modal-estNoOrdrs form-control"> <a
								onclick="openSecondEstSearch($('#estNoOrdrs').val());"><i
								class="i_search_w"></i></a>
							<!-- <a onclick="openSecondEstSearch(document.getElementsByClassName('modal-estNoOrdrs').value);"><i class="i_search_w"></i></a> -->
						</div>
					</td>

					<th>견적차수</th>
					<td><input id="estDeg" type="text" name="estDeg" readonly>
					</td>

					<th>수주번호</th>
					<td><input id="ordrsNo" name="ordrsNo" type="text" readonly>
						<input id="newOrdrsDiv" name="newOrdrsDiv" type="hidden">
					</td>
				</tr>

				<!-- 2행 -->
				<tr>
					<th class="hit">수주일자</th>
					<td><input type="text" class="input_calendar ordrsDt"
						autocomplete="off" id="ordrsDt" name="ordrsDt" date
						class="form-control" required
						onchange="monthCloseChk(this.value);"></td>

					<th class="hit">수주구분</th>
					<td><select id="ordrsDiv" name="ordrsDiv" data-kind="ORDRSDIV"
						class="form-control" required msg="수주구분">
					</select></td>

					<th class="hit">고객사</th>
					<td>
						<!-- <input type="hidden" id="ordrsClntCd" name="ordrsClntCd"> -->
						<input type="hidden" id="ordrsClntCd" name="ordrsClntCd" required
						msg="고객사코드">
						<div class="search_form">
							<input
								onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);"
								type="text" id="ordrsClntNm" name="ordrsClntNm" required
								msg="고객사"> <a
								onclick="openSecondClntSearch(document.getElementById('ordrsClntNm').value);">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>

					<th id="ordrsNoTh" class="">건양수주번호</th>
					<td>
						<div class="search_form">
							<input id="oldOrdrsNo" name="oldOrdrsNo" type="hidden" readonly>
							<input id="newOrdrsNo" name="newOrdrsNo" type="text" readonly>
							<a onclick="fn_orderSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>

				<!-- 3행 -->
				<tr>
					<th class="hit">계약명</th>
					<td colspan="3"><input type="text" id="ctrtNm" name="ctrtNm"
						class="form-control" required msg="계약명"></td>

					<th class="hit" title="담당자 정보를 확인합니다">담당자</th>
					<td>
						<div class="search_form">
							<input
								onkeydown="if(event.keyCode==13)openSecondUserSearch( this.value);"
								type="text" id="mngIdNm" name="mngIdNm" required msg="담당자">
							<input type="hidden" id="mngId" name="mngId" required msg="담당자">
							<a
								onclick="openSecondUserSearch( document.getElementById('mngIdNm').value);">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>

					<th>차수</th>
					<td><input type="text" id="histNo" name="histNo"
						class="form-control" readonly></td>
				</tr>

				<!-- 4행 -->
				<tr>
					<th class="">결재방법</th>
					<td><select id="pmntMtd" name="pmntMtd" data-kind="PMNTMTD"
						class="form-control">

					</select></td>

					<th class="">발주자</th>
					<td><input type="text" id="ordrger" name="ordrger"
						class="form-control"></td>

					<th class="hit" id="ordrsAmtTh">수주금액</th>
					<td><input type="text" id="ordrsAmt" name="ordrsAmt" required
						value="0" class="form-control"
						onkeyup="onlyNumber(this); chechChange();" comma msg="수주금액">
					</td>

					<th class="hit" id="currCdTh">통화단위</th>
					<td><select id="currCd" name="currCd" data-kind="CURR"
						class="form-control" onchange="setByCoCd(this.value)" required
						msg="통화단위">
					</select></td>
				</tr>

				<!-- 5행 -->
				<tr>
					<th class="">선물환CheckList</th>
					<td><select data-kind="YN" id="fwdExchChkList"
						name="fwdExchChkList" class="form-control">

					</select></td>
					<th class="">선물환가입일</th>
					<td><input type="text" class="input_calendar"
						autocomplete="off" id="fwdExchJoinDt" name="fwdExchJoinDt" date>
					</td>


					<th class="">원화금액</th>
					<td><input type="text" id="exchangeAmt" name="exchangeAmt"
						readonly></td>

					<th class="">환율</th>
					<td><input type="text" id="exrate" name="exrate" value="1"
						class="form-control" onkeyup="onlyNumber(this); chechChange();"
						comma></td>

				</tr>

				<!-- 6행 -->
				<tr>
					<th class="hit">계약문서</th>
					<td><select type="text" id="ctrtDoc" name="ctrtDoc"
						data-kind="CONTRACTDIV" class="form-control" required msg="계약문서">
							<option value=""></option>
					</select></td>

					<th>국내/해외</th>
					<td><select data-kind="INPEXP" id="inpexpCd" name="inpexpCd"
						class="form-control" style="text-align: center;">
					</select></td>

					<!-- 빈값추가 -->
					<th class="hit" id="prjctTh">프로젝트명</th>
					<td>
						<div class="search_form">
							<input type="text" id="prjctSeqNm" name="prjctSeqNm"
								onkeydown="if(event.keyCode==13)openSecondProjectSearch(this.value);"
								readonly msg="프로젝트명"> <input type="hidden" id="prjctSeq"
								name="prjctSeq"><a id="searchButton"
								onclick="openSecondProjectSearch(document.getElementById('prjctSeqNm').value);"><i
								class="i_search_w"></i></a>
						</div>
					</td>
					<th>고객사PJT</th>
					<td><select id="clntPjt" name="clntPjt" data-kind="PRJCTCD"
						class="form-control" required msg="고객사PJT">
							<option value=""></option>
					</select> <!-- 						<input type="hidden" id="clntPjt" name="clntPjt" required msg="고객사PJT" readonly> -->
					</td>

				</tr>

				<!-- 7행 -->
				<tr>
					<th>비고</th>
					<td colspan="5">
						<div class="scroll-container">
							<textarea rows=4 cols=120 wrap="hard" id="ordrsRmk"
								name="ordrsRmk" class="truncate_multi_post form-control"
								msg="비고"></textarea>
						</div>
					</td>
					<td colspan="2">원가관리표 출력을 위해 글자폭 제한하였으며, 최대 30줄 출력 가능.</td>
				</tr>

			</table>
		</div>
	</form>

	<div class="contents_tit coAuthChk">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※
				수금 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10">
			<!-- <button id="ordrsPlanHis" style="margin-right:10px; display:none;" type="button">수금계획수정이력 </button> -->
			<!-- <button id="ordrsPlanUpdate" style="margin-right:10px; display:none;" type="button">수금정보수정</button> -->
			<button id="clmnPlanRmkUpdate" type="button">수금관리사항수정</button>
			<a id="addPaymentButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deletePaymentButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>

	<!-- 콘텐츠1 -->
	<div class="contents_tit coAuthChk">
		<!-- 리스트 -->
		<div class="ax5_grid">

			<div>
				<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"
					style="height: 180px; width: 100%"></div>
			</div>
		</div>
	</div>

	<div id="datailButtonDiv" class="contents_tit">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※
				설비&원가 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10 coAuthChk">
			<a id="addDetailButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deleteDetailButton" style="height: 20px; line-height: 18px">-</a>
			<!-- 엑셀다운로드 버튼 -->
			<a onclick="excelDown1();"
				style="height: 30px; line-height: 28px; width: 90px;"><i
				class="fas fa-file-excel"></i> 엑셀다운로드</a>
		</div>
	</div>

	<!-- 콘텐츠2-->
	<div id="datailGridDiv" class="contents">
		<!-- 리스트-->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="second-grid-modal" data-ax5grid-config="{}"
					style="height: 300px; width: 100%"></div>
			</div>
		</div>
	</div>

	<div class="contents">
		<tr>
			<td colspan=8>
				<!-- 공유대상자-->
				<div class="popup_table" id="approval_trgt">
					<table style="border: 0px;">
						<tr style="height: 30px;">
							<td
								style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold;">※
								공유 및 결재</td>
							<td>
								<div class="add_btn_small pdl10" id="plus-minus">
									<a onclick="insertShareUserModal1();"
										style="height: 30px; line-height: 28px;" authchk>+</a> <a
										onclick="deleteShareUser1();"
										style="height: 30px; line-height: 28px;" authchk>-</a>
								</div>
							</td>
						</tr>

						<tr>
							<td colspan="2">
								<div class="ax5_grid" data-ax5grid="third-grid-modal"
									data-ax5grid-config="{}" style="height: 150px; width: 100%;"></div>
							</td>
						</tr>
					</table>
				</div>
			</td>
		</tr>
		<br> <br>
	</div>

	<!-- 공통 파일 영역 -->
	<div id="fileList_area" style="margin-bottom: 30px;"></div>

	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionOrdrsBtn" class="coAuthChk" authchk>등록</button>
		<button class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	/***********전역변수****************/
	let selectedRowKey;
	let selectedRowKey2;

	var currToday = [];

	var ordrsNo = "";
	var thisGridRow = "";
	var thisGridCol = "";
	var beforeGridSize = 0; //수주상세그리드의 갯수용 그리드컨텐츠 높이조절용
	var detailAcFlag = false;	// 설비에 정산상계, 추후 정산 포함여부 플래그
	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];

	//수주상세내역의 콤보선택자료 생성임.
	const comboOdd1 = [...setComboOptionCode('ORDRSDTLDIV10')];
	const comboOdd2 = [...setComboOptionCode('ORDRSDTLDIV20')];
	const comboOdd3 = [...setComboOptionCode('ORDRSDTLDIV30')];
	const comboOdd4 = [...setComboOptionCode('MCTYPE')];
	const comboItemList = [...setComboOptionCode('ITEMLIST')];
	const comboClmnPlanDiv = [...setComboOptionCode('CLMNPLANDIV')];

	let refCode = setRefCode(); //공통코드에 있는 codeEtc = 1 -->현재 설정된값(GUN, 건양아이티티의 거래처등록번호임))

	var actionType = modalStack.last().paramObj.actionType;
	var paramObj = modalStack.last().paramObj;

	var deleteFileArr = [];
	var selectedNodeId = "";
	var fileTrgtTyp = "";
	var gridOrdrsDetaildeleteArr = [];  //수주설비&원가 삭제저장용

	let originalOrdrsInfo = null; // 처음 불러온 데이터를 원본 정보

	function setComboOptionCode(selectComobo) {
		var optionCode = [];
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : selectComobo} , null, function(data) {
			var codeList = data.childCodeList;
			$.each(codeList, function (index, item) {
				let tempCode = {
					'CD' : item.codeId,
					'NM' : item.codeNm
				}
				optionCode.push(tempCode);
			});
		})
		return optionCode;
	}

	//(GUN, 건양아이티티의 거래처등록번호 추출 설정하기)
	function setRefCode() {
		var refCode = '';
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : "CO"} , null, function(data) {
			var codeList = data.childCodeList;
			$.each(codeList, function (index, item) {
				if(item.codeId == 'GUN') {
					refCode = item.codeEtc;
				}
			});
		})
		return refCode;
	}

	/***********전역변수****************/
	/* document.ready */
	$(document).ready(function () {
		setCommonSelect($(".popup_area select[data-kind]"));
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		$("#taskBtn").hide();

		$("#mngIdNm").val(jwt.userNm);
		$("#mngId").val(jwt.userId);
		
		$('#fwdExchJoinDt').datepicker({
			format: "yyyy-mm-dd",
			language: "ko",
			autoclose: true
		}).datepicker("setDate", new Date());

		$('.input_calendar').datepicker({
			format: "yyyy-mm-dd",
			language: "ko",
			autoclose: true
		});

		//수주일자//
		$('#ordrsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());

		const ordrsDiv = document.getElementById('ordrsDiv');
		// const orgnSalesCdTh = document.getElementById('orgnSalesCdTh');
		// const orgnSalesCdTd = document.getElementById('orgnSalesCdTd');

		// function toggleOrgnSalesCd() {
		//     if (ordrsDiv.value === 'ORDRSDIV1') {
		//         orgnSalesCdTd.style.display = 'none';
		//         orgnSalesCdTh.style.display = 'none';
		//     } else {
		//         orgnSalesCdTd.style.display = 'none';
		//         orgnSalesCdTh.style.display = 'none';
		//     }
		// }

		// ordrsDiv.addEventListener('change', toggleOrgnSalesCd);
		// 페이지 로드 시 초기 상태 설정
		// toggleOrgnSalesCd();

		// 고객사PJT 변경에 따른 적용
		$('#clntPjt').on('change', function () {
			$('#prjctSeqNm').val('');
    		$('#prjctSeq').val('');
		})
		$('#inpexpCd').on('change', function () {
			$('#prjctSeqNm').val('');
			$('#prjctSeq').val('');
		})

		// 회사구분 변경에 따른 적용
		$('#coCd').on('change', function () {
			//---------------------------------------------------------------
			//첨부 화일 처리 시작
			//---------------------------------------------------------------
			$('#fileList_area').empty();
			fileParam = {
					fileTrgtTyp	: "CR0202P01",
					fileTrgtKey : fileTrgtKey,
					todoNo 		: modalStack.last().paramObj.ordrsNo,	//수주번호
					etcField2 	: modalStack.last().paramObj.histNo		//차수
				}

			treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
			//---------------------------------------------------------------
			//첨부 화일 처리 끝
			//---------------------------------------------------------------

		});
		// 수주구분 변경에 따른 적용
		$('#ordrsDiv').on('change', function () {
			if(actionType == "C" || actionType == "U"){
				const data = [];
				// const tempOrdrsDiv = $("#ordrsDiv").val();
				const tempOrdrsDiv = $(this).val();
				const gridData = gridOrdrsDetail.getList();

				// 발주요청서, 구매발주서, 외주관리에 등록되어 있으면 변경 불가, 메세지
				if (tempOrdrsDiv == "ORDRSDIV8") {
					paramObj={"" : $("#ordrsNo").val()};
					postAjaxSync("/user/cr/cr02/ordrsDivChangeChk", paramObj, null, function(data){
						if(data.result) {
							let msg = data.result.msg;
							if (msg && msg.trim() !== "") {
								alert("해당 수주는 " + msg + "에 이미 등록되어 있어, 변경하실 수 없습니다.");
								$('#ordrsDiv').val($('#ordrsDiv').data('prevVal'));
							}
						}
					});
					if ($('#ordrsDiv').val() !== tempOrdrsDiv) {
						// 변경이 취소되었으므로, 더 이상의 처리는 하지 않음.
						return;
					}
				}
				// 수주구분에 따른 분기 처리
				// 유상AS, 무상AS
				if (tempOrdrsDiv === "ORDRSDIV2" || tempOrdrsDiv === "ORDRSDIV3") {	 // 유상AS, 무상AS
					$('#prjctSeqNm').prop('disabled', true); 
					$('#prjctSeqNm').val('');
					$('#prjctSeq').val('');
					$('#searchButton').addClass('hidden'); 
					$('#clntPjt').prop('disabled', false);
					$("#prjctTh").removeClass('hit');
					if (tempOrdrsDiv === "ORDRSDIV2") {	// 유상AS
						$("#ordrsAmtTh").addClass('hit');
						$("#currCdTh").addClass('hit');
						$('#ordrsAmt').removeAttr('readonly', 'true');
						const paiAsGridData = gridData.map(row => ({ // 화살표함수로
							...row,
							ordrsDtlDiv20: row.ordrsDtlDiv10 === "ORDRSDTLDIV1010" ? "ORDRSDTLDIV2040" : row.ordrsDtlDiv20
						}));
						gridOrdrsDetail.setData(paiAsGridData);
					} else { // 무상AS
						$("#ordrsAmtTh").removeClass('hit');
						$("#currCdTh").removeClass('hit');
						$('#ordrsAmt').attr('readonly', 'true');
						$('#ordrsAmt').val("0");
						$('#exchangeAmt').val("0");
						const freeAsGridData = gridData.map(row => ({
							...row,
							ordrsPrcMach: "",
							ordrsPrcElcty: "",
							ordrsPrc: "",
							ordrsDtlDiv20: row.ordrsDtlDiv10 === "ORDRSDTLDIV1010" 
								? "ORDRSDTLDIV2040" 
								: row.ordrsDtlDiv20
						}));
						gridOrdrsDetail.setData(freeAsGridData);
					}
				// 정상수주, 수주취소, 가수주
				} else { 
					$('#prjctSeqNm').prop('disabled', false); 
					$('#searchButton').removeClass('hidden');
					$('#clntPjt').prop('disabled', true);
					const updateWorkGridData = gridData.map(row => ({
						...row,
						ordrsDtlDiv20: row.ordrsDtlDiv10 === "ORDRSDTLDIV1010" ? "ORDRSDTLDIV2010" : row.ordrsDtlDiv20
					})); 
					gridOrdrsDetail.setData(updateWorkGridData);
				$("#prjctTh").addClass('hit');
					if (tempOrdrsDiv == "ORDRSDIV8" || tempOrdrsDiv == "ORDRSDIV9") {  // 수주취소, 가수주
						$("#ordrsAmtTh").removeClass('hit');
						$("#currCdTh").removeClass('hit');
						$('#ordrsAmt').attr('readonly', 'true');
					} else { //정상수주
						$("#ordrsAmtTh").addClass('hit');
						$("#currCdTh").addClass('hit');
						$('#ordrsAmt').removeAttr('readonly', 'true');
					}
				}
			}
		})

		// 수주구분 요소가 포커스를 받을 때 이전 값을 저장
		$('#ordrsDiv').on('focus', function () {
			$(this).data('prevVal', $(this).val());
		});


		// 선물환 CheckList 변경에 따른 적용
		$('#fwdExchChkList').on('change', function () {

			if($("#fwdExchChkList").val() == "N"){
				$('#fwdExchJoinDt').val("");
				$('#fwdExchJoinDt').attr('readonly', 'true');
				$('#fwdExchJoinDt').hide();
			}else{
				$('#fwdExchJoinDt').val($('#ordrsDt').val());
				$('#fwdExchJoinDt').removeAttr('readonly', 'true');
				$('#fwdExchJoinDt').show();
			}

		})

		// 수주금액 변경에 따른 적용
		$("#ordrsAmt").change(function () {
			calclateTotalClmnAmt();
		});

		//견적서번호 지울경우 견적차수도 지워지게 처리
		$("#estNoOrdrs").change(function () {
			var ordNo = $("#estNoOrdrs").val()
			if (isNaN(ordNo) || ordNo == "") {
				$("#estDeg").val("");
			}
		});
		$(clntPjt).prop('disabled', true); //프로젝트 변경 불가능하세 수정
		//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
		// $('#ordrsPlanUpdate').on("click", function() {
		//     ordrsPlanUpdate();
		// });
		// //선물환기입check리스트 NG일떄 계약문서칸 사용못하게 해야함
		// $("#fwdExchChkList").change(function () {
		//     var fwdExchChkList = $("#fwdExchChkList").val();
		//     if(fwdExchChkList == "N"){
		// 		//내용 삭제 후 비활성화
		//     	$("#ctrtDoc").val("");
		//     	$('#ctrtDoc').prop('disabled', true);
		//     }else{
		//     	$('#ctrtDoc').prop('disabled', false);
		//     }
		// });

		$('#clmnPlanRmkUpdate').on("click", function() {
			let selRow = gridOrdrsPlan.getList("selected")
			let gridData = selRow[0];
			if( typeof(selRow[0])=="undefined" || selRow.length == 0 ) {
				alert("선택된 행이 없습니다.");
				return false;
			}

			if (confirm("수금관리 사항 수정 처리 하시겠습니까?")) {
				// 기본값 set
				var formData = new FormData();
				formData.append('userId', jwt.userId);
				formData.append('pgmId', "CR0202P01");

				formData.append("detailArr", JSON.stringify(selRow));

				filePostAjax("/user/cr/cr02/clmnPlanRmkUpdate", formData, function (data) {
					if (data.resultCode == 200) {
						alert(data.resultMessage);
					}else{
						alert(data.resultMessage);
					}
				});
			}

		});
		//gridViewPop7.initView();

		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
// 		fileParam = {
// 			fileTrgtTyp	: "CR0202P01",
// 			fileTrgtKey : fileTrgtKey,
// 			todoNo 		: modalStack.last().paramObj.ordrsNo,	//수주번호
// 			etcField2 	: modalStack.last().paramObj.histNo		//차수
// 		}

// 		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);

		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
		
	});  /* document.ready */

	// 고객사 검색 함수
	function openSecondClntSearch(searchValue) {
		//등록일 경우만 팝업처리
		// if (actionType == "C") {
			var paramObj = {
				"searchValue" : searchValue,
				"clntDivCd"   : "CLNTDIV12"
			};
			openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "고객사 검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];

				$('#ordrsClntCd').val(row.clntCd);
				$('#ordrsClntNm').val(row.clntNm);

				//$('#clntPjt').val(row.clntPjt);
				if ($('#mngId').val() == "") {
					var paramObj = {
						"coCd": $('#coCd').val(),
						"clntCd": row.clntCd
					}
					setMngInfo(paramObj);
				}
				$('#newOrdrsNo').val('');

				setDetailButton();

			});
		// }
	}

	// 견적서번호 검색
	function openSecondEstSearch(searchValue) {
		var aordrsDiv = $("#ordrsDiv").val();

		//등록이거나 수주구분이 정상수주일 경우만 팝업처리
		if (actionType == "C" && (aordrsDiv == "ORDRSDIV1" || aordrsDiv == "ORDRSDIV2")) {
			var paramObj = {
				"searchValue" : searchValue,
				"coCd" : $('#coCd').val()
			};
			// openSecondModal("/static/html/cmn/modal/estSearchWithOrdrs.html", 600, 420, "견적서 검색", {searchValue: searchValue}, function (grid) {
			openSecondModal("/static/html/cmn/modal/estSearch.html", 1200, 420, "견적서 검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];

				$('#estNoOrdrs').val(row.estNo);
				$('#coCd').val(row.coCd);
				$('#estDeg').val(row.estDeg);
				$('#currCd').val(row.currCd);
				$('#ordrsClntCd').val(row.estClntCd);
				$('#ordrsClntNm').val(row.estClntNm);
// 	            $('#clntPjt').val(row.clntPjt);
				$('#ordrsAmt').val(row.estAmt);
				$('#ctrtNm').val(row.estNm);
				var paramObj = {
					"coCd": $('#coCd').val(),
					"clntCd": row.estClntCd
				}
			setMngInfo(paramObj);
			});
		} else if (actionType == "U" && (aordrsDiv == "ORDRSDIV1" || aordrsDiv == "ORDRSDIV2")) {
			//수정시 견적서 연결할때 견적서번호&&견척차수만 세팅(11/28 요청사항)
			var paramObj = {
				"searchValue" : searchValue,
				"coCd" : $('#coCd').val()
			};
			// openSecondModal("/static/html/cmn/modal/estSearchWithOrdrs.html", 600, 420, "견적서 검색", {searchValue: searchValue}, function (grid) {
			openSecondModal("/static/html/cmn/modal/estSearch.html", 1200, 420, "견적서 검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];
				$('#estNoOrdrs').val(row.estNo);
				$('#estDeg').val(row.estDeg);   //견적차수
			});
		}
	}

	// 담당자 정보 설정 함수
	function setMngInfo(paramObj) {
		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
			if (data.mngInfo) {
				$('#mngId').val(data.mngInfo.salesEmpId);
				$('#mngIdNm').val(data.mngInfo.salesEmpNm);
			} else {
				// $('#mngId').val("");
			}
		});
	}

	// 담당자 검색 함수
	function openSecondUserSearch() {
		//등록일 경우만 팝업처리
		if (actionType == "C") {
			var paramObj = {
				"coCd"   : $('#coCd').val(),
				"userId" : $('#salesEmpId').val(),
				"userNm" : $('#salesEmpNm').val(),
				"useYn"  : "Y"
			};

			openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function (tree) {
				var checkedId = tree.get_checked()[0];
				var checkedNode = tree.get_node(checkedId);
				$("#salesEmpId").val(checkedNode.id);
				$("#salesEmpNm").val(checkedNode.text);
			});
		}
	}

	// 폼 데이터 생성 함수
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma],#exrate,#ordrsAmt,#exchangeAmt'), function (idx, elem) {
			deleteComma(elem);
		});

		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function (idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		$('#popForm').find(':disabled').each(function() {
			// console.log("name: " + $(this).attr('name'), "value: " + $(this).val());
			formData.append( $(this).attr('name'), $(this).val() );
		});
		formData.append("ordrsNo", $("#ordrsNo").val());

		// 유저아이디 추가
		// formData.append("userId", jwt.userId);

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#ordrsClntCd').val());			//첨부화일용
		formData.append("prdtCd" , $('#prdtCd').val(""));			//첨부화일용
		formData.append("itemCd" , $('#itemDiv').val(""));			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용

		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();

		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------

		// 원본 데이터를 추가
		if (originalOrdrsInfo) {
			formData.append("originalOrdrsInfo", JSON.stringify(originalOrdrsInfo));
		}

		$.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
			var detailObj = {};
			$.each($(elem).find('[name]'), function (idx, elem) {
				formData.append(elem, JSON.elem.value);
			});
		});

		var rowListPlan = gridOrdrsPlan.getList();
		var rowListDetail = gridOrdrsDetail.getList();

		var planArr = [];
		var detailArr = [];
		let clmnDtCnt = 0;
		let clmnAmtCnt = 0;

		// 헤더에 PJT가 들어있는 경우에만 검사 (비어 있으면 통과)
		if ($("#clntPjt").val()) {
			for (var i = 0; i < rowListDetail.length; i++) {
				var row = rowListDetail[i];
				// 설비행(ORDRSDTLDIV1010)만 검사
				if (row.ordrsDtlDiv10 === 'ORDRSDTLDIV1010') {
					// openSalesCdSearch에서 넣어준 clntPjt 사용
					if (row.clntPjt && row.clntPjt !== $("#clntPjt").val()) {
						customAlert("고객사PJT가 다른 설비가 존재합니다. 동일한 고객사PJT의 원천 SALES CODE만 선택해 주세요.");
						return false;
					}
				} else if (row.ordrsDtlDiv10 == 'ORDRSDTLDIV1040' || row.ordrsDtlDiv10 == 'ORDRSDTLDIV1050') {
					// 정산상계, 추후정산 포함여부 체크
					detailAcFlag = true;
				}
			}
		}
		//수주금액 필수체크
		if (!detailAcFlag && (pasFloatChk($("#ordrsAmt").val()) == 0 || pasFloatChk($("#ordrsAmt").val()) == "") && $("#ordrsDiv").val() != 'ORDRSDIV3' && $("#ordrsDiv").val() != 'ORDRSDIV8' && $("#ordrsDiv").val() != 'ORDRSDIV9') {
			customAlert("수주금액을 입력바랍니다.");
			return;
		}

		const tempOrdrsDiv = $("#ordrsDiv").val();
		if(tempOrdrsDiv == "ORDRSDIV3" || tempOrdrsDiv == "ORDRSDIV8" || tempOrdrsDiv == "ORDRSDIV9"){ //무상AS start, 수주취소, 가수주건
		} else {
			//수금내역
			if (rowListPlan.length == 0) {
				commaChange();
				alert("수금내역을 확인해 주세요?");
				return false;
			}

			$.each(rowListPlan, function (idx, elem) {
				var planObj = {};

				planObj["clmnPlanSeq"] = idx + 1;
				planObj["clmnPlanDiv"] = elem.clmnPlanDiv;
				planObj["clmnDivSeq"] = elem.clmnDivSeq;
				planObj["clmnRate"] = elem.clmnRate;
				// planObj["clmnAmt"] = pasIntChk(elem.clmnAmt.replace(/,/g, ''));
				planObj["clmnAmt"] = elem.clmnAmt;

				let clmnDt = new Date(elem.clmnDt);

				if(isNaN(clmnDt)) {
					clmnDtCnt++;
				}

				let pmntDtAfterBill = pasIntChk(elem.pmntDtAfterBill, 10); // 문자열을 숫자로 변환
				// clmnDt에서 pmntDtAfterBill를 뺍니다.
				clmnDt.setDate(clmnDt.getDate() - pmntDtAfterBill);

				// Date 객체를 YYYY-MM-DD 형식의 문자열로 변환
				let convertDateToString = function (dateObj) {
					let month = '' + (dateObj.getMonth() + 1),
					day = '' + dateObj.getDate(),
					year = dateObj.getFullYear();

					if (month.length < 2)
					month = '0' + month;

					if (day.length < 2)
					day = '0' + day;

					return [year, month, day].join('-');
				};

				if(elem.clmnAmt == 0) {
					clmnAmtCnt++;
				}

				// 계산된 날짜를 billPblsDt에 할당 일자없으면 null로 세팅
				if(isNaN(pmntDtAfterBill)) {
					planObj["billPblsDt"] = "";
					planObj["pmntDtAfterBill"] = "";
				} else {
					planObj["billPblsDt"] = convertDateToString(clmnDt);
					planObj["pmntDtAfterBill"] = pmntDtAfterBill;
				}
				planObj["clmnDt"] = elem.clmnDt;
				planObj["clmnMgmtStatus"] = elem.clmnMgmtStatus;

				planArr.push(planObj);
			});

			//수금정보 입력 자료 중복 체크 (수금구분과  차수가 중복확인)
			const chkValues = new Set();
			for (const obj of rowListPlan) {
				let chkValue = obj.clmnPlanDiv + obj.clmnDivSeq; //수금구분 || 수금차수 중복 체크를 확인용
				if (chkValues.has(chkValue)) {
					alert("수금구분과 차수가 중복됩니다. 확인바랍니다.");
					return false;
				}
				chkValues.add(chkValue);
			}

			if(clmnAmtCnt > 0 && !detailAcFlag) {
				commaChange();
				alert("수금계획 금액이 없습니다!");
				return false;
			} else if(clmnDtCnt > 0) {
				commaChange();
				alert("수금예정일자가 없습니다.");
				return false;
			}

			// clmnAmt 합계 계산
			var totalClmnAmt = 0;

			$.each(planArr, function (idx, elem) {
				totalClmnAmt += pasFloatChk(elem.clmnAmt);
			});

			// input box 값과 비교
			var inputAmtVal = pasFloatChk($("#ordrsAmt").val());

			if (totalClmnAmt != inputAmtVal) {
				if($("#ordrsDiv").val() != "ORDRSDIV3" && $("#ordrsDiv").val() != "ORDRSDIV8" && $("#ordrsDiv").val() != "ORDRSDIV9" ) {
					commaChange();
					alert("수주금액과 수금계획금액 합계가 일치하지 않습니다.");
					return false;
				}
			}
		}
		//무상AS end

		if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) { //투루넷,건양 start //refCode = 1 (GUN, 건양아이티티의 거래처등록번호 추출 설정하기)
		} else {
			//설비&원가 정보
			if (rowListDetail.length == 0) {
				commaChange();
				alert("주문 세부 내역이 없습니다.");
				return false;
			}

			var totalLaborCostMfgCost = 0;
			var totalMachineValueAfterDeduction = 0;
			let orgnSalesCdCnt = 0;

			// clmnAmt 합계 계산
			var totalClmnAmt = 0;
			let eqpNmChk = false;
			let orgnSalesCodeChk = false;	//AS의경우 원천 SalesCode 체크하기위한  스위치 변수


			const seenNo2 = new Set(); 	//정산수주번호+순번 중복체크용
			let seenNoDup = false;		//정산수주번호+순번 중복체크용
			$.each(rowListDetail, function (idx, elem) {
				var detailObj = {
					"ordrsSeq"				: elem.ordrsSeq,
					"cudCheck"				: elem.cudCheck,
					"devDiv"				: elem.devDiv,
					"ordrsDtlDiv10"			: elem.ordrsDtlDiv10,
					"ordrsDtlDiv20"			: elem.ordrsDtlDiv20,
					"ordrsDtlDiv30"			: elem.ordrsDtlDiv30,
					"orgnSalesCd"			: elem.orgnSalesCd,
					"mctype"				: elem.mctype,
					"prdtCd"				: elem.prdtCd,
					"itemDiv"				: elem.itemDiv,
					"salesCd"				: elem.salesCd || '',
					"eqpNm"					: elem.eqpNm,
					"dudtIntendDt"			: elem.dudtIntendDt,
					"dtlRmk"				: elem.dtlRmk,
					"ordrsPrcMach"			: pasIntChk(elem.ordrsPrcMach),
					"ordrsPrcElcty"			: pasIntChk(elem.ordrsPrcElcty),
					"ordrsPrc"				: pasIntChk(elem.ordrsPrcMach) + pasIntChk(elem.ordrsPrcElcty),
					"ordrsQty"				: pasIntChk(elem.ordrsQty),
					"estEpctMatPrc"			: pasIntChk(elem.estEpctMatPrc),
					"trgtPchsPcostMach"		: pasIntChk(elem.trgtPchsPcostMach),
					"trgtPchsPcostElcty"	: pasIntChk(elem.trgtPchsPcostElcty),
					"trgtPchsPcostInHousePrcsn": pasIntChk(elem.trgtPchsPcostInHousePrcsn),
					"machineValueAfterDeduction": pasIntChk(elem.trgtPchsPcostMach) - pasIntChk(elem.trgtPchsPcostInHousePrcsn),
					"outtkClntNm"			: elem.outtkClntNm,
					"estTrgtCost"			:  pasIntChk(elem.estTrgtCost),
					"unsettledOrdrsNo"		: elem.unsettledOrdrsNo,
					"unsettledOrdrsSeq"		: elem.unsettledOrdrsSeq,
				};

				let orgnSalesCode = elem.orgnSalesCd;
				let ordrsDtlDiv20 = elem.ordrsDtlDiv20;
				let ordrsDtlDiv30 = elem.ordrsDtlDiv30;
				let mctype = elem.mctype;
				let prdtCd = elem.prdtCd;
				let itemDiv = elem.itemDiv;
				let eqpNm = elem.eqpNm;

				if (elem.ordrsDtlDiv10 == 'ORDRSDTLDIV1010') {//설비인경우
					if(orgnSalesCode == '' || orgnSalesCode == undefined) { //원천SalesCd
						orgnSalesCodeChk = true;
						detailObj["orgnSalesCd"] = "";
					}
					if(prdtCd == '' || prdtCd ==  undefined) {
						alert("제품구분을 입력해주세요.")
						return false;
					}
					if(itemDiv == '' || itemDiv ==  undefined) {
						alert("아이템 구분을 입력해주세요.")
						return false;
					}
				}
				//정산수주번호+순번 중복체크용
				if (elem.unsettledOrdrsNo && seenNo2.has(elem.unsettledOrdrsNo+elem.unsettledOrdrsSeq)) {
					alert(`정상상계처리를 동일 수주번호에서 2개로 분할 처리할 수 없습니다.\n수주번호: ${elem.unsettledOrdrsNo} - ${elem.unsettledOrdrsSeq}`);
					seenNoDup = true;	//오류처리 flag
					return false;
				} else {
				    seenNo2.add(elem.unsettledOrdrsNo+elem.unsettledOrdrsSeq);
				}
				
				
				if(ordrsDtlDiv20 == '' || ordrsDtlDiv20 == undefined) { //수주설비 작업구분
					detailObj["ordrsDtlDiv20"] = "";
				}

				if(ordrsDtlDiv30 == '' || ordrsDtlDiv30 == undefined) { //수주설비 자체구분
					detailObj["ordrsDtlDiv30"] = "";
				}

				if(mctype == '' || mctype == undefined) { //수주설비 기계구분
					detailObj["mctype"] = "";
				}

				if(prdtCd == '' || prdtCd == undefined) { //제품구분
					detailObj["prdtCd"] = "";
				}

				if(itemDiv == '' || itemDiv == undefined) { //아이템구분
					detailObj["itemDiv"] = "";
				}

				if(eqpNm == '' || eqpNm == undefined) {  //설비명
					detailObj["eqpNm"] = "";
					eqpNmChk = true;
				}

				var laborCostMfgCost = pasIntChk(elem.laborCostMfgCost); //노무비 제조걍비
				var machineValueAfterDeduction = pasIntChk(detailObj["machineValueAfterDeduction"]); //

				detailObj["laborCostMfgCost"] = laborCostMfgCost; //노무비 제조걍비
				detailObj["machineValueAfterDeduction"] = machineValueAfterDeduction;

				totalLaborCostMfgCost += laborCostMfgCost; //노무비 제조걍비
				totalMachineValueAfterDeduction += machineValueAfterDeduction;

				totalClmnAmt += pasFloatChk(elem.ordrsPrcMach);
				totalClmnAmt += pasFloatChk(elem.ordrsPrcElcty);

				detailArr.push(detailObj);  //설비정보
			});

			// 정산관련 중복 및 잔액 점검 이상유무 확인
			if(seenNoDup) {
				return false;
			}

			//정산상계 처리건의 경우 설정금액을 초과되지 않았는지 점검하기
			// 1) ordrsDtlDiv10 == ORDRSDTLDIV1050 인 행만 추출
			const check1050 = rowListDetail.filter(row => row.ordrsDtlDiv10 === 'ORDRSDTLDIV1050');
			// 2) 비정상인 자료 메세지 표시 
			check1050.forEach((row, idx) => {
				if (gPasIntChk(row.ordrsPrc) <= 0) {
					alert(`정산상계 처리금액이 ${addCommaStr(row.ordrsPrc)}원 입니다.`)
					seenNoDup = true;	//오류처리 flag
					return false;
				}
				//DB에서 정산잔액 초과 여부 점검하기 (해당건을 제외한 잔액 산정후 초과 여부 체크하기)
                paramObj = {
					coCd	  			: row.coCd,
					ordrsNo				: row.ordrsNo,
					ordrsSeq			: row.ordrsSeq,
					unsettledOrdrsNo	: row.unsettledOrdrsNo,
					unsettledOrdrsSeq	: row.unsettledOrdrsSeq,
				};
				postAjaxSync("/user/cr/cr02/settledAmtCreditTotalAmt", paramObj, null, function(data){
					if (data.result) {
					    console.warn(
					        `[${idx}] 비정상 eqpNm`,
					        'code=', row.code,
					        'eqpNm=', row.eqpNm,
					        '원본 row=', row
					        );
					    // 최종잔여금액 = 다른수주에서 처리된 정산금액 - 현재수주에서 정산하려는 금액
					    const remCheckAmt = gPasIntChk(data.result.remOrdrsPrc) - gPasIntChk(row.ordrsPrc);
					    if (remCheckAmt < 0) {
							alert(`추후정산 발생금액보다 정산상계 처리금액이 많습니다.\n${addCommaStr(remCheckAmt)}원 차액 발생 확인 바람니다.`)
							seenNoDup = true;	//오류처리 flag
							return false;
					    }
					}
				});
			});
			// 정산관련 중복 및 잔액 점검 이상유무 확인
			if(seenNoDup) {
				return false;
			}
			
			if(eqpNmChk) {
				alert("설비명은 필수 입력입니다.");
				return false;
			}

			if((orgnSalesCodeChk) && (tempOrdrsDiv == "ORDRSDIV2" || tempOrdrsDiv == "ORDRSDIV3")) {	//AS유상, AS무상
				alert("AS의 경우에는 원천 SalesCode가 정보가 필요합니다.");
				return false;
			}
			// if(orgnSalesCdCnt > 0) {
			//     commaChange();
			//     alert("원천SalesCode가 없습니다.");
			//     return false;
			// }

			// 정상수주, 수주쉬소, 가수주 로 등록시 prjctSeq 없으면 등록못하게 막음 <2025-05-29 최지상>
			if ((tempOrdrsDiv == "ORDRSDIV1" || tempOrdrsDiv == "ORDRSDIV8" || tempOrdrsDiv == "ORDRSDIV9") && ($("#prjctSeq").val() == '' || $("#prjctSeq").val() == undefined)) {
				alert("정상수주, 수주취소, 가수주 등록시 프로젝트명은 필수입니다. 전산실에 문의해주세요.");
				return false;
			}

			// input box 값과 비교
			// var inputAmtVal = pasIntChk($("#ordrsAmt").val());
			var inputAmtVal = pasIntChk($("#exchangeAmt").val());
			if (totalClmnAmt != inputAmtVal) {
				if($("#ordrsDiv").val() != "ORDRSDIV3" && $("#ordrsDiv").val() != "ORDRSDIV8" && $("#ordrsDiv").val() != "ORDRSDIV9" ) {
					commaChange();
					alert("수주금액과 수주가합계가 일치하지 않습니다.");
					return false;
				}
			}

			var totalSum = totalLaborCostMfgCost + totalMachineValueAfterDeduction; //laborCostMfgCost(금액)+machineVVauleAfterDeduction(차감 후 기계값)
			var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값

		}
		//투루넷,건양 end
		formData.append("planArr", JSON.stringify(planArr));				//수금내역
		formData.append("detailArr", JSON.stringify(detailArr)); 			//설비정보
		formData.append("gridOrdrsDetaildeleteArr", JSON.stringify(gridOrdrsDetaildeleteArr)); //설비삭제내역

		// 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가 (박성준 : 2023.08.03)
		// 공유 : TODODIV10, TODODIV1040  결재 :TODODIV20, TODODIV2020
		var rowSharngList = gridViewPop7.target.list;
		var ParamObj = modalStack.last().paramObj.ParamObj;

		// // 2024.05.16 김성욱 추가 수정 대분류 TODO 내용에 추가
		// var paramObj2 = {
		//     "ordrsNo" : $("#ordrsNo").val(),
		//     "histNo" : $("#histNo").val()
		// };
		// postAjaxSync("/user/cr/cr02/selectOrderChangeTitle", paramObj2, null, function(data) {
		//     if (data.result[0] == undefined || data.result[0].chgNm == "") {
		//         chgNm = "";
		//     } else {
		//         chgNm = data.result[0].chgNm;
		//     }
		// });
		// // 2024.05.16 김성욱 추가 수정 대분류 TODO 내용에 추가 끝

		if(rowSharngList.length > 0) {
			var rowSharngListArr = []; //공유정보
			var rowApprovalListArr = []; //결재정보

			$.each(rowSharngList, function(idx, elem) {
				var rowSharngListObj = elem;
				var rowApprovalListObj = elem;

				if (elem.gb == '공유') {
					rowSharngListObj["gb"] = elem.gb;
					rowSharngListObj["coCd"] = $('#coCd').val();
					//rowSharngListObj["salesCd"] = $('#salesCd').val();
					rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
					rowSharngListObj["todoDiv2CodeId"] = "TODODIV1100";
					rowSharngListObj["todoId"] = elem.usrNm;
					rowSharngListObj["todoCoCd"] = elem.coCd;
					rowSharngListObj["empNo"] = elem.empNo;
					rowSharngListObj["name"] = elem.name;
					rowSharngListObj["telNo"] = elem.telNo;
					rowSharngListObj["email"] = elem.eMail;
					rowSharngListObj["pgPath"] = "/user/cr/cr02/CR0202P02.html";
					//TITLE 추가
					// rowSharngListObj['todoTitle'] = $("#ordrsClntNm").val() + ', ' + document.getElementById("clntPjt").options[clntPjt.selectedIndex].text + ' 공유 ' + chgNm;
					rowSharngListObj['todoTitle'] = $("#ordrsClntNm").val() + ', ' + document.getElementById("clntPjt").options[clntPjt.selectedIndex].text + ' 공유 ';
					rowSharngListArr.push(rowSharngListObj);
				} else if (elem.gb == '결재') {
					rowApprovalListObj["gb"] = elem.gb;
					rowApprovalListObj["coCd"] = $('#coCd').val();
					//rowApprovalListObj["salesCd"] = $('#salesCd').val();
					rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
					rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2100";
					rowApprovalListObj["todoId"] = elem.usrNm;
					rowApprovalListObj["todoCoCd"] = elem.coCd;
					rowApprovalListObj["empNo"] = elem.empNo;
					rowApprovalListObj["name"] = elem.name;
					rowApprovalListObj["telNo"] = elem.telNo;
					rowApprovalListObj["email"] = elem.eMail;
					rowApprovalListObj["pgPath"] = "/user/cr/cr02/CR0202P02.html";
					//TITLE 추가
					// rowApprovalListObj['todoTitle'] = $("#ordrsClntNm").val() + ', ' + document.getElementById("clntPjt").options[clntPjt.selectedIndex].text + ' 결재 ' + chgNm;
					rowApprovalListObj['todoTitle'] = $("#ordrsClntNm").val() + ', ' + document.getElementById("clntPjt").options[clntPjt.selectedIndex].text + ' 결재 ';
					rowApprovalListArr.push(rowApprovalListObj);
				}
			});
			formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
			formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
		}
		formData.append("S_todoDiv1CodeId", "TODODIV10");
		formData.append("S_todoDiv2CodeId", "TODODIV1100");

		return formData;
	}

	// 판매법인 설정 함수
	function setByCoCd(value) {
		// 판매법인 set
		$('#estCoprt').data("rprc", value);
		chechChange();
		$('#estCoprt option:not([value=""])').remove()
		setCommonSelect($('#estCoprt'));
	}

	/* 그리드 관련 함수 */
	// 그리드 생성
	// 수금 정보 그리드
	const gridOrdrsPlan = new ax5.ui.grid();

	gridOrdrsPlan.setConfig({
		target : $('[data-ax5grid="first-grid-modal"]'),
		header: {
			align: "center",
			selector: false
		},
		columns: [
			{key: "seq", label: "번호", width: 40, align: "center", formatter: function () {return this.item.__index + 1;},},
			{ key: "clmnPlanDiv",   label: "수금구분", align: "center",  width: 70,
				editor: {
					type: 'select', config: {
						columnKeys: { optionValue: 'CD', optionText: 'NM' },
						options : comboClmnPlanDiv
					}
				},
				formatter : function() {
					return getComboName(comboClmnPlanDiv, this)
				}
			},
			{key: "clmnDivSeq", label: "차수", width: 50, align: "center", editor: {type: "text"}},
			{key: "clmnRate", label: "비율", width: 50, align: "center", editor: {type: "number"}},
			{key: "clmnAmt",label: "수금계획금액", width: 110, align: "right", editor: {type: "number"}, formatter: "money"},
			{key: "clmnDt", label: "수금예정일자", width: 100, align: "center",
				editor: {
					type: "date", config: {
						content: {
							config: { mode: "day", selectMode: "day" }
						}
					}
				}
			},
			{key: "pmntDtAfterBill", label: "계산서 발행 후 지급시기(단위: 일)", width: 180, align: "center", editor: {type: "number"}},
			{key: "billPblsDt", label: "계산서발행예정일", width: 100, align: "center",
				editor: {
					type: "date", config: {
						content: {
							config: { mode: "day", selectMode: "day" }
						}
					}
				},
				formatter: function () {
					var clmnDt = new Date(this.item.clmnDt || new Date());
					clmnDt.setDate(clmnDt.getDate() - (this.item.pmntDtAfterBill || 0));
					var month = String(clmnDt.getMonth() + 1).padStart(2, '0');
					var day = String(clmnDt.getDate()).padStart(2, '0');
					var year = clmnDt.getFullYear();

					return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
				}
			},
			{key: "매출확정합계", label: "매출확정금액", width: 120, align: "right", formatter: "money", styleClass: function () {
				return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.매출확정합계)) ? "grid-font-red" : "grid-font-blue";}
			},
			{key: "세금계산서합계", label: "계산서발행금액", width: 120, align: "right", formatter: "money", styleClass: function () {
				return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.세금계산서합계)) ? "grid-font-red" : "grid-font-blue";}
			},
			{key: "수금합계", label: "수금금액", width: 120, align: "right", formatter: "money", styleClass: function () {
				return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.수금합계)) ? "grid-font-red" : "grid-font-blue";}
			},
			{key: "zzzz", label: "미수잔액", width: 120, align: "right",
				formatter: function () {
					return addCommaStr(pasFloatChk(this.item.clmnAmt) - pasFloatChk(this.item.수금합계));
				},
				styleClass: function () {
					return "grid-font-blue";
				}
			},
			{key: "clmnMgmtStatus", label: "수금관리상황", width: "*", align: "left", editor: {type: "text"}},
		],
		footSum: [
			[
				{label: "수금합계", align: "center", colspan: 3},
				{key: "clmnRate", collector: "sum", formatter: "money", align: "right"},
				{key: "clmnAmt", collector: "sum", formatter: "money", align: "right"},
				{colspan: 3},
				{key: "매출확정합계", collector: "sum", formatter: "money", align: "right"},
				{key: "세금계산서합계", collector: "sum", formatter: "money", align: "right"},
				{key: "수금합계", collector: "sum", formatter: "money", align: "right"},
				{key: "zzzz", collector:
					function () {
						var value = 0;
						this.list.forEach(function (n) {
							if (!n.__isGrouping) value += (pasFloatChk(n.clmnAmt) - pasFloatChk(n.수금합계));
						});
						return addCommaStr(value);
					},
					formatter: "money", align: "right"
				},
			]
		],
		page : {
			display: false,
		},
		body: {
			onClick: function () {
				this.self.clearSelect();
				this.self.select(this.dindex);
				selectedRowKey = this.dindex;
			},
			onDataChanged: function () {
				if( this.key == "clmnAmt" || this.key == "clmnRate" ) {
					const ordrsAmt = pasFloatChk($("#ordrsAmt").val());

					if( this.key == "clmnAmt" ) {
						const clmnAmt = pasFloatChk(this.value);
						this.value = clmnAmt;

						if (!isNaN(clmnAmt) && !isNaN(ordrsAmt)) {
							// this.item.clmnRate = ordrsAmt !== 0 ? pasFloatChk((clmnAmt / ordrsAmt * 100 + 0.5) ) : 0;
							this.item.clmnRate = ordrsAmt !== 0 ? pasFloatChk((clmnAmt / ordrsAmt * 100) ) : 0;
						}
					}

					if( this.key == "clmnRate" ) {
						const clmnRate = pasIntChk(this.value);
						this.value = clmnRate;

						if (!isNaN(clmnRate) && !isNaN(ordrsAmt)) {
							// this.item.clmnAmt = pasFloatChk(clmnRate * ordrsAmt / 100 + 0.5);
							this.item.clmnAmt = pasFloatChk(clmnRate * ordrsAmt / 100);
						}
					}

					var data = gridOrdrsPlan.getList();
					var totalRate = 0;
					var totalAmt = 0;

					for (var i = 0; i < data.length; i++) {
						totalRate += pasIntChk(data[i].clmnRate);
						totalAmt += pasFloatChk(data[i].clmnAmt);
					}

					if (totalRate > 100) {
						alert('비율의 합계는 100%를 초과할 수 없습니다.');
					}

					if (totalAmt > ordrsAmt) {
						alert('수금금액의 합계는 주문 금액을 초과할 수 없습니다.');
					}
				}
				gridOrdrsPlan.repaint();

				//수주자료 수정모드가 아닐경우 수금정보 수정시 수금정보 저장버튼 활성화 시킴
				//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
				// if ($('#actionOrdrsBtn').is(':hidden')) {
				//     $('#ordrsPlanUpdate').show();
				// }
			}
		},
		contextMenu: {
			iconWidth: 20,
			acceleratorWidth: 100,
			itemClickAndClose: false,
			icons: {
				'arrow': '<i class="fa fa-caret-right"></i>'
			},
			items: [
				{type: 1, label: "붙여넣기"},
				{divide: true},
				{type: 1, label: "줄추가"},
				{type: 1, label: "내용 삭제"},
				{type: 2, label: "줄삭제"},
			],
			popupFilter: function (item, param) {
				//console.log(item, param);
				if (param.element) {
					return true;
				} else {
					return item.type == 1;
				}
			},
			onClick: function (item, param) {
				// console.log(item, param);
				thisGridRow = param.dindex;
				thisGridCol = param.colIndex;
				if (item.label == "붙여넣기") {
					gridPaste(gridOrdrsPlan, thisGridRow, thisGridCol, "PLAN");
				} else if (item.label == "줄추가") {
					// console.log('추가 인덱스 :', param.dindex);
					//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
					let newRow = gridOrdrsPlan.list[param.dindex];
					gridOrdrsPlan.addRow($.extend({}, newRow, {__index: undefined}), param.dindex + 1,);
				} else if (item.label == "내용 삭제") {
					// console.log('내용삭제 인덱스 :', param.dindex);
					gridOrdrsPlan.config.columns.forEach((column) => {
						gridOrdrsPlan.setValue(param.dindex, column.key, '');
						// console.log('내용삭제 :', param.dindex, column.key);
					});
				} else if (item.label == "줄삭제") {
					// console.log('삭제 인덱스 :', param.dindex);
					gridOrdrsPlan.removeRow(param.dindex);
				}
				//결재완료후 수금내역 수정시 수정 버튼 활성화 하기
				//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
				// if ($('#actionOrdrsBtn').is(':hidden')) {
				//     $('#ordrsPlanUpdate').show();
				// }
				gridOrdrsPlan.contextMenu.close();
			}
		},
	});

	function calclateTotalClmnAmt () {
		var ordrsAmt = pasIntChk($("#ordrsAmt").val());
		var data = gridOrdrsPlan.getList();
		var totClmnAmt = 0;
		for (var i = 0; i < data.length; i++) {
			data[i].clmnAmt = pasIntChk(ordrsAmt * pasIntChk(data[i].clmnRate) / 100 + 0.5);
			totClmnAmt += data[i].clmnAmt;
		}
		if (data.length > 0){
			data[data.length-1].clmnAmt += ordrsAmt - totClmnAmt; //오더금액과 수금금액 차이는 마지막 수금에 포함 처리
		}

		gridOrdrsPlan.setData(data);
	}

	//Select 선택 코드값 체크하여 명을 출력
	function getComboName(comboArray, key) {
		let rtnNm = "";
		for (const element of comboArray) {
			if (key.value == element.CD) {
				rtnNm = element.NM;
				break;
			}
		}
		return rtnNm;
	}

	function gridStyle(row) {
		if (!row) return "";
		if (row.ordrsDtlDiv10 == "ORDRSDTLDIV1040" || row.ordrsDtlDiv10 == "ORDRSDTLDIV1050") {
			if (row.ordrsPrcMach <  0) {
				return "grid-row-blue grid-font-red-bold";
			} else {
				return "grid-row-blue grid-no-msg-font-blue-bold";
			}
		}
		return "";
	}
	
	const gridOrdrsDetail = new ax5.ui.grid();

	gridOrdrsDetail.setConfig({
		multipleSelect: false,
		target : $('[data-ax5grid="second-grid-modal"]'),
		header: {
			align: "center",
			selector: false
		},
		// frozenColumnIndex: 8,
		columns: [
			{key: "cudCheck",    label: "입력,삭제체크용", align: "left", width: 100, hidden: true},
			{key: "seq", 			label: "No", 		width: 40, align: "center", formatter: function () { return this.item.__index + 1; }, styleClass: function () { return gridStyle(this.item); }},
			{key: "ordrsDtlDiv10", 	label: "입력구분", 	width: 60, align: "center", editor: { type: 'select',
				config: {
					columnKeys: { optionValue: 'CD', optionText: 'NM' },
					options : comboOdd1
				} }, formatter : function()  {return getComboName(comboOdd1, this)}, styleClass: function () { return gridStyle(this.item); }},
			{key: "devDiv", 	label: "개발", 	align: "center", width: 40, editor: { type: 'select',
			config: {
				columnKeys: { optionValue: 'CD', optionText: 'NM' },
				options : [
					{CD: "", NM: ""},
					{CD: "D", NM: "D"}
						]
					}
				}, styleClass: function () { return gridStyle(this.item); }
			},
			{key: "ordrsSeq",	label: "ordrsSeq", 	align: "center", width: 50, hidden: true},
			{key: "orgnSalesCd",	label: "원천SalesCode", 	align: "center", width: 110, styleClass: function () { return gridStyle(this.item); }},
			{key: "prdtCd", 		label: "제품구분", 	align: "center", width: 60, styleClass: function () { return gridStyle(this.item); }},
			{key: "itemDiv", 		label: "아이템구분", 	align: "center", width: 80, editor: { type: 'select',
				config: {
					columnKeys: { optionValue: 'CD', optionText: 'NM' },
					options : comboItemList
				} }, formatter : function()  {return getComboName(comboItemList, this)}, styleClass: function () { return gridStyle(this.item); }},
			{key: "ordrsDtlDiv20", 	label: "작업구분", 	align: "center", width: 60, editor: { type: 'select',
				config: {
					columnKeys: { optionValue: 'CD', optionText: 'NM' },
					options : comboOdd2
				} }, formatter : function()  {return getComboName(comboOdd2, this)}, styleClass: function () { return gridStyle(this.item); }},
			{key: "ordrsDtlDiv30", 	label: "자체구분", 	align: "center", width: 60, editor: { type: 'select',
				config: {
					columnKeys: { optionValue: 'CD', optionText: 'NM' },
					options : comboOdd3
				} }, formatter : function()  {return getComboName(comboOdd3, this)}, styleClass: function () { return gridStyle(this.item); }},
			{key: "mctype", 	label: "기계구분", 	align: "center", width: 60, editor: { type: 'select',
			config: {
				columnKeys: { optionValue: 'CD', optionText: 'NM' },
				options : comboOdd4
				} }, formatter : function()  {return getComboName(comboOdd4, this)}, styleClass: function () { return gridStyle(this.item); }},
			{key: "dataChk", 		label: "비활성화체크",	align: "center", width: 40, hidden: true},
			{key: "salesCd", 	 label: "sales Code", 	align: "center", width: 120, styleClass: function () { return gridStyle(this.item); }},
			{key: "eqpNm", 			label: "설비명", 		align: "center", width: 255, editor: {type: "text"}, styleClass: function () { return gridStyle(this.item); }},
			{key: "dudtIntendDt",   label: "납기예정일", width: 100, align: "center", editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" } } }},
				formatter: function () {
					//기존 데이터 있으면
					if(this.item.dudtIntendDt){
						var dudtIntendDt = new Date(this.item.dudtIntendDt);
						var month = String(dudtIntendDt.getMonth() + 1).padStart(2, '0');
						var day = String(dudtIntendDt.getDate()).padStart(2, '0');
						var year = dudtIntendDt.getFullYear();
						return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
					}else{
					//기존 데이터 없으면
						if(actionType == "C"){//등록시 오늘날짜 기본으로
							var dudtIntendDt = new Date();
							var month = String(dudtIntendDt.getMonth() + 1).padStart(2, '0');
							var day = String(dudtIntendDt.getDate()).padStart(2, '0');
							var year = dudtIntendDt.getFullYear();
							return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
						}else{//수정시는 없는 건 없는 것
							return null;
						}
					}
				}, styleClass: function () { return gridStyle(this.item); }
			},
			{key: "estTrgtCost", 	label: "수주목표가",align: "right", width: 80, editor: {type: "number"}, formatter: "money", styleClass: function () { return gridStyle(this.item); }},
			{key: undefined, 		label: "수주가", columns: [
					{key: "ordrsPrcMach", label: "기계PART", align: "right", width: 80, editor: {type: "number"}, formatter: "money", styleClass: function () { return gridStyle(this.item); }},
					{key: "ordrsPrcElcty", label: "전기PART", align: "right", width: 80, editor: {type: "number"}, formatter: "money", styleClass: function () { return gridStyle(this.item); }},
					{key: "ordrsPrc", label: "합계", align: "right", width: 80,
						formatter: function () {return addCommaStr(pasIntChk(this.item.ordrsPrcMach) + pasIntChk(this.item.ordrsPrcElcty));},
						styleClass: function () {return "grid-font-blue";} , styleClass: function () { return gridStyle(this.item); }},
				]},
			{key: "ordrsQty", label: "수량", align: "right", width: 40, editor: {type: "number"}},
			{key: "estEpctMatPrc", label: "견적 예상 재료비",align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
			{key: undefined, label: "목표구매원가", columns: [
					{key: undefined, label: "목표구매원가", columns: [
							{ key: "trgtPchsPcostMach", label: "기계", align: "right", width: 90, editor: {type: "number"}, formatter: "money"},
							{ key: "trgtPchsPcostElcty", label: "전기", align: "right", width: 90, editor: {type: "number"} , formatter: "money"},
							{ key: "trgtsum", label: "합계", align: "right", width: 100,
								formatter: function () {return addCommaStr(pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty));},
								styleClass: function () {return "grid-font-blue";}, },
						] },
					{key: undefined, label: "자체가공 투입시 기계부문 목표원가", columns: [
							{key: "trgtPchsPcostInHousePrcsn", label: "자체 가공", align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
							{key: "machineValueAfterDeduction", label: "차감 후 기계값", align: "right", width: 100, formatter: function () {return addCommaStr(pasIntChk(this.item.trgtPchsPcostMach) - this.item.trgtPchsPcostInHousePrcsn);},
								styleClass: function () {return "grid-font-blue";},},
						]}
				]
			},

			// {key: undefined, label: "실집행 원가", columns: [
			//         {key: undefined, label: "노무비 및 제조경비(판관비 제외)", columns: [
			//                 {key: "laborCostMfgCost", label: "금액", align: "right", width: 130, editor: {type: "number"}, formatter: "money" },
			//             ]}
			//     ]},
			{key: "outtkClntNm", label: "외주턴키", align: "left", width: 120, editor: {type: "text"}},
			{key: "dtlRmk",      label: "비고", align: "left", width: 120, editor: {type: "text"}},
			{key: "unsettledOrdrsNo",      label: "정상오더", align: "left", width: 100, hidden: false},
			{key: "unsettledOrdrsSeq",      label: "정상오더순번", align: "left", width: 60, hidden: false},
		],
		footSum: [
			[
				{label: "총합계", align: "center", colspan: 12},
				{key: "estTrgtCost", collector: "sum", formatter: "money", align: "right"},
				{key: "ordrsPrcMach", collector: "sum", formatter: "money", align: "right"},
				{key: "ordrsPrcElcty", collector: "sum", formatter: "money", align: "right"},
				{key: "ordrsPrc", collector: function () {
					var value = 0;
					this.list.forEach(function (n) {
						if (!n.__isGrouping) value += (pasIntChk(n.ordrsPrcMach) + pasIntChk(n.ordrsPrcElcty));
					});
					return addCommaStr(value);
				},  align: "right"},
				{key: "ordrsQty", collector: "sum", formatter: "money", align: "right"},
				{key: "estEpctMatPrc", collector: "sum", formatter: "money", align: "right"},
				{key: "trgtPchsPcostMach", collector: "sum", formatter: "money", align: "right"},
				{key: "trgtPchsPcostElcty", collector: "sum", formatter: "money", align: "right"},
				{key: "trgtsum",  collector: function () {
					var value = 0;
					this.list.forEach(function (n) {
						if (!n.__isGrouping) value += (pasIntChk(n.trgtPchsPcostMach) + pasIntChk(n.trgtPchsPcostElcty));
					});
					return addCommaStr(value);
				},  align: "right"},
				{key: "trgtPchsPcostInHousePrcsn", collector: "sum", formatter: "money", align: "right"},
				{key: "machineValueAfterDeduction", collector: function () {
					var value = 0;
					this.list.forEach(function (n) {
						if (!n.__isGrouping) value += (pasIntChk(n.trgtPchsPcostMach) - pasIntChk(n.trgtPchsPcostInHousePrcsn));
					});
					return addCommaStr(value);
				}, align: "right"},
				// {key: "laborCostMfgCost", collector: "sum", formatter: "money", align: "right"},
			]
		],
		body: {
			onClick: function () {
				this.self.select(this.dindex);
				thisGridRow = this.dindex;
				thisGridCol = this.colIndex;
				selectedRowKey2 = this.dindex;
				
				if (this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1050') { //정산상계, 추후정상(ORDRSDTLDIV1040)
					let chkCol = this.column.key;
					if (chkCol == 'devDiv' || chkCol == 'orgnSalesCd' || chkCol == 'prdtCd' || chkCol == 'itemDiv' || chkCol == 'ordrsDtlDiv20' || chkCol == 'ordrsDtlDiv30' || chkCol == 'mctype') {
						openUnsettledAmtSearch(this.item);
						return;
					}
				}
				
				if (this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010') {	//설비이면
					if (this.column.key == 'prdtCd' ) {	//제품구분
						openSecondPrdtSearch();
					} else if (this.column.key == 'orgnSalesCd') {	//원천SalesCd
						openSalesCdSearch();
					} 
				}

			},
			onDBLClick: function () {
			},
			columnHeight: 26,
			onDataChanged: function () {
				var row = this.dindex;
				var col = this.colIndex;
				if (this.item.cudCheck !='C') {  //추가일경우
					this.item.cudCheck = "U";   //추가, 수정, 삭제구분
				}
				switch (this.key) {
					case 'ordrsPrcMach':
						this.item.ordrsPrcMach = pasIntChk(this.value);
						// this.item.ordrsPrc = pasIntChk(this.item.ordrsPrcMach + this.item.ordrsPrcElcty);
						gridOrdrsDetail.setValue(row, "ordrsPrc", pasIntChk(this.item.ordrsPrcMach) + pasIntChk(this.item.ordrsPrcElcty));
						break;
					case 'ordrsPrcElcty':
						this.item.ordrsPrcElcty = pasIntChk(this.value);
						this.item.ordrsPrc = pasIntChk(this.item.ordrsPrcMac) + pasIntChk(this.item.ordrsPrcElcty);
						break;
					case 'trgtPchsPcostMach':
						this.item.trgtPchsPcostMach = pasIntChk(this.value);
						this.item.sum = pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty);
						break;
					case 'trgtPchsPcostElcty':
						this.item.trgtPchsPcostElcty = pasIntChk(this.value);
						this.item.sum = pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty);
						break;
					case 'trgtPchsPcostInHousePrcsn':
						this.item.trgtPchsPcostInHousePrcsn = pasIntChk(this.value);
						this.item.machineValueAfterDeduction = pasIntChk(this.item.trgtPchsPcostMach) - pasIntChk(this.item.trgtPchsPcostInHousePrcsn);
						break;
					case 'trgtPchsPcostElcty':
						this.item.trgtPchsPcostElcty = pasIntChk(this.value);
						break;
					case 'ordrsQty':
						this.item.ordrsQty = pasIntChk(this.value);
						break;
					case 'estEpctMatPrc':
						this.item.estEpctMatPrc = pasIntChk(this.value);
						break;
					case 'laborCostMfgCost':
						this.item.laborCostMfgCost = pasIntChk(this.value);
						break;
					case 'estTrgtCost':
						this.item.estTrgtCost = pasIntChk(this.value);
						break;
				}

				//입력구분이고 해당 값이 저게 아닐때 해당셀을 빈값으로 세팅
				// if (this.key == 'ordrsDtlDiv10' && this.item.ordrsDtlDiv10 != 'ORDRSDTLDIV1010') {
				if (this.key == 'ordrsDtlDiv10') {
					gridOrdrsDetail.setValue(row, 'orgnSalesCd', "");
					gridOrdrsDetail.setValue(row, 'prdtCd', "");
					gridOrdrsDetail.setValue(row, 'itemDiv', "");
					gridOrdrsDetail.setValue(row, 'ordrsDtlDiv20', "");
					gridOrdrsDetail.setValue(row, 'ordrsDtlDiv30', "");
					gridOrdrsDetail.setValue(row, 'mctype', "");
					// gridOrdrsDetail.setValue(row, 'eqpNm', "");
					gridOrdrsDetail.setValue(row, 'salesCd', "");
				}

				var currEndRow = currGridEndRow();
				// gridOrdrsDetail.repaint();

				// if (beforeGridSize != gridOrdrsDetail.list.length) {
					//row focus 처리용
					// var gridStatus = $('.popup_area [data-ax5grid="second-grid-modal"] [data-ax5grid-page="status"]').text().trim();
					// var gridStatusIdx = gridStatus.indexOf(' ');
					// var topRow = gridStatus.slice(0, gridStatusIdx).trim();
					// gridOrdrsDetail.focus(topRow);
					// console.log(topRow, row);


					// const data = gridOrdrsDetail.getList();
					// gridOrdrsDetail.setData(data);
					// gridResize(gridOrdrsDetail.list.length); //그리드 높이 조정
					// beforeGridSize = gridOrdrsDetail.list.length;
					// gridOrdrsDetail.focus(row);

					resetGridFocus(currEndRow, thisGridRow);
				// }
				gridOrdrsDetail.repaint();
			},
		},
		contextMenu: {
			iconWidth: 20,
			acceleratorWidth: 100,
			itemClickAndClose: false,
			icons:
				{
					'arrow': '<i class="fa fa-caret-right"></i>'
				},
			items: [
				{type: 1, label: "붙여넣기"},
				{divide: true},
				{type: 1, label: "줄추가"},
				{type: 1, label: "내용 삭제"},
				{type: 2, label: "줄삭제"},
				{divide: true},
				{type: 3, label: "관리용SalesCd생성"},
			],
			popupFilter:

				function (item, param) {
					//console.log(item, param);
					if (param.element) {
						return true;
					} else {
						return item.type == 1;
					}
				},
			onClick: function (item, param) {

				thisGridRow = param.dindex;
				thisGridCol = param.colIndex;

				if (item.label == "붙여넣기") {
					gridPaste(gridOrdrsDetail, thisGridRow, thisGridCol);
				} else if (item.label == "줄추가") {
					// console.log('추가 인덱스 :', param.dindex);
					//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
					let newRow =   {...gridOrdrsDetail.list[param.dindex]};
					newRow.salesCd = "";
					newRow.cudCheck = "C";
					newRow.ordrsSeq = "0"; //추가후 삭제할 경우를 대비 반드시ordrsSeq= 0으로 채울것
					gridOrdrsDetail.addRow($.extend({}, newRow, {__index: undefined}), param.dindex + 1,);
					gridOrdrsDetail.focus(param.dindex + 1);

				} else if (item.label == "내용 삭제") {
					// console.log('내용삭제 인덱스 :', param.dindex)
					// gridOrdrsDetail.config.columns.forEach((column) => {
					let tempCudCheck = gridOrdrsDetail.list[param.dindex].cudCheck;
					gridOrdrsDetail.colGroup.forEach((column) => {
						gridOrdrsDetail.setValue(param.dindex, column.key, '');
						// console.log('내용삭제 :', param.dindex, column.key);
					});
					if (tempCudCheck == "C") {
						gridOrdrsDetail.setValue(param.dindex, "cudCheck", "C");
					}

				} else if (item.label == "줄삭제") {
					// console.log('삭제 인덱스 :', param.dindex);
					if (gridOrdrsDetail.list[param.dindex].cudCheck != "C") {
						gridOrdrsDetaildeleteArr.push(gridOrdrsDetail.list[param.dindex]);
					}
					gridOrdrsDetail.removeRow(param.dindex);
					//삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
				} else if (item.label == "관리용SalesCd생성") {
					if (!param.item.salesCd) { 
						const tempordrsNo = $('#ordrsNo').val();
						if (tempordrsNo) {
							let tempSalesCd = tempordrsNo + '-' + String(param.doindex+1).padStart(2, '0') + 'NNNNN';
							gridOrdrsDetail.setValue(param.dindex, 'salesCd', tempSalesCd);

							gridOrdrsDetail.setValue(param.dindex, 'itemDiv', 'ITEMLIST99');
							gridOrdrsDetail.setValue(param.dindex, 'ordrsDtlDiv20', 'ORDRSDTLDIV2050');
							gridOrdrsDetail.setValue(param.dindex, 'ordrsDtlDiv30', 'ORDRSDTLDIV3010');
							gridOrdrsDetail.setValue(param.dindex, 'mctype', 'MCT09');
						} else {
							customAlert('저장후 수정모드에서만 가능합니다. 수주번호 확인 필요!');
						}
					} else {
						customAlert('salesCd등록된 경우에는 생성 할 수 없습니다.');
					}
				}

				gridOrdrsDetail.contextMenu.close();
				//또는 return true;
			}
		}

	});
	
	//공유 결재 그리드
	var gridViewPop7 = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="third-grid-modal"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function () {
						this.self.select(this.dindex);
					},
					onDBLClick: function () {
					},
					mergeCells : ["gb"],
				},
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView7.setData(this.page.selectPage);
					}
				},
				columns : [
					{key: "gb",      			label: "구분",      	align: "center",   width: 40},
					{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 50},
					{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
					{key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
					//{key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: false},
					{key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
					{key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
					{key: "name",       		label: "성명",      	align: "center",   width: 80},
					{key: "jik",       			label: "직위",      	align: "center",   width: 60},
					{key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 90},
					{key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 130},
					{key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: "*"},
					{key: "telNo",      		label: "H.P",		align: "center",   width: 130},
					{key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
					{key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},
					{key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
					{key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
					]
					});
					return this;
				},

				setData : function(_pageNo) {
					var targetObj = this.target;
					var formData = {
						"fileTrgtKey" : fileTrgtKey,
						"reqNo" : modalStack.last().paramObj.ordrsNo,
						"etcField2" : $("#histNo").val(),
						"pageNo" : _pageNo + 1
					}
					postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
						try {
							var list = data.result;
							if( list.length > 0 ) {
								var inCnt = 0;
								var inGb = 0; //해당 결재개수 변수

								let processChk = false;	//결재 진행여부 체크 (결재가 하나라도  진행되면 true)
								list.forEach(elem => {
									if (elem.gb === "결재") {  // 결재와 공유 중 결재 갯수 파악
										if (elem.todoId !== jwt.userId) {	//결재자가 동일하면 제외
											//상태가 'Y'인 경우
											if (elem.sanctnSttus === "Y") {
												processChk = true;
												inCnt++;
											}

											inGb++;
										}
									}
								});
								// 기본 상태: 숨김 처리
								// $('#createHistory, #actionOrdrsBtn').hide();

								if (processChk && inCnt == inGb) {
									// 결재자가 있고 결재가 완료된 경우
									$('#createHistory').show();
								} else if (list.length > 0 && inCnt > 0) {
									// 결재자가 있고, 결재가 진행 중일 경우 (결재자가 1명 이상일 때)
									// 이미 숨김 처리된 상태이므로 추가 처리 불필요
								} else {
									// 결재자가 없거나 아무도 결재를 하지 않았을 경우
									// 이미 기본 숨김 처리되어 있으므로 추가 처리 불필요
									$('#actionOrdrsBtn').show();
								}
							}
							targetObj.setData({
								list : list,
								page : {
									totalElements : list.length
								}
							});
						} catch (error) {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					});
				},

				setData2 : function(_list) {
					this.target.setData({
								list : _list,
								page : {
										totalElements :  _list.length,
							}
							});
				}
				,
				setData3 : function(_pageNo) {
					var targetObj = this.target;
					var paramObj = { "userId": jwt.userId
								, "appDiv": 'APPDIV09'		//수주원가관리 결재라인
					};
					postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : { totalElements : list.length }
							});
						} catch (error) {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					
					});
				}
	}

	if (actionType == "C") {
		
		//회사 기본값지정
		if(modalStack.last().paramObj.coCd == '' || modalStack.last().paramObj.coCd == undefined){
			$("#coCd").val(jwt.coCd);
		}else{
			$("#coCd").val(modalStack.last().paramObj.coCd);
			//회사 비활성화
			$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		}
		$('#coCd').trigger('change'); //파일트리 새로 그리기

		$('#createHistoryDiv').removeClass("contents_tit")
		$('#createHistory').hide();

		setInitInsert();
		gridViewPop7.initView().setData3(0);

		$('#actionOrdrsBtn').on("click", function () {
			insertOrdrs();
		});
		//as등록으로 들어왔을 경우
		if(modalStack.last().paramObj.isAs == "Y"){
			postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {
				var parsedData = data;
				// 원본 데이터를 깊은 복사로 저장
				originalOrdrsInfo = JSON.parse(JSON.stringify(parsedData.ordrsInfo));

				Object.keys(parsedData.ordrsInfo).forEach(function (key) {
					var inputField = document.getElementById(key == 'estNo' ? 'estNoOrdrs' : key);
					if (!inputField) return;

					var value = parsedData.ordrsInfo[key];

					switch (key) {
					    case 'ordrsDiv':
					    	$('#ordrsDiv').val('ORDRSDIV3');
					    	break;
						case 'ordrsDt':	//바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
							// $(".ordrsDt").val(value);
							$(".ordrsDt").datepicker("setDate", new Date(value));
						case 'fwdExchJoinDt':
							$('#fwdExchJoinDt').datepicker("setDate", new Date(value));
						case 'dudtPlanDt':  //바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
							// $(".dudtPlanDt").val(value);
						case 'ordrsAmt': $('#ordrsAmt').val(0);
						case 'exrate':
							inputField.value = addCommaStr(value);
							break;
						case 'exchangeAmt':
							$('#ordrsAmt').val(0);
							break;
						case 'ordrsNo' : // 수주 번호 pass
							break;
						default:
							inputField.value = value || '';
							break;
					}
				});
		}); 
			$('#ordrsDiv option').each(function() {
				 if ($(this).val() === 'ORDRSDIV3') {
					    $(this).prop('selected', true);  // 명시적으로 선택
					  } else {
					    $(this).prop('selected', false); // 나머지 옵션은 비선택
					  }  // 각 option의 value 값 출력
				});
			$('#ordrsDiv').val('ORDRSDIV3').trigger('change');
			
			addDetailButtionClick();
			
			
		}
		
		setInitSetting();
		$("#ReportMain").hide();
		$("#viewHistory").hide();
	} else if (actionType == "U") {
		$('#taskBtn').show();
		//타이틀명 변경
		$('#cr02PopTit').text('수주 수정')

		//버튼명 변경
		$('#actionOrdrsBtn').text("수정");
		$('#actionOrdrsBtn').on("click", function () {
			updateOrdrs();
		});

		monthCloseChk($('#ordrsDt').val());  //마감일통제

		//회사 비활성화
		$('#popForm .coCd').removeClass('hit');
		$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		//견적서번호 비활성화
		// $('#popForm .estNoOrdrs').removeClass('hit');
		// $('#estNoOrdrs').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		//수주일자 비활성화
		// $('#popForm .ordrsDt').removeClass('hit');
		// $('#ordrsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		//고객사 비활성화
		// $('#popForm .ordrsClntNm').removeClass('hit');
		// $('#ordrsClntNm').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		//수주금액 비활성화
		// $('#popForm .ordrsAmt').removeClass('hit');
		// $('#ordrsAmt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		$("#ordrsPlanHis").show();
		$('#pmntMtd').val('PMNTMTD01');

		postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {
			var parsedData = data;
			// 원본 데이터를 깊은 복사로 저장
			originalOrdrsInfo = JSON.parse(JSON.stringify(parsedData.ordrsInfo));

			Object.keys(parsedData.ordrsInfo).forEach(function (key) {
				var inputField = document.getElementById(key == 'estNo' ? 'estNoOrdrs' : key);
				if (!inputField) return;

				var value = parsedData.ordrsInfo[key];

				switch (key) {
				//    case 'ordrsDiv':
				//        if (value == 'ORDRSDIV1') {
				//            $('#orgnSalesCdTd,#orgnSalesCdTh').hide();
				//        }
				//        else {
				//        	inputField.value = value || '';
				//        	$('#orgnSalesCdTd,#orgnSalesCdTh').show();
				//        }
				//        break;
					case 'ordrsDt':	//바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
						// $(".ordrsDt").val(value);
						$(".ordrsDt").datepicker("setDate", new Date(value));
					case 'fwdExchJoinDt':
						$('#fwdExchJoinDt').datepicker("setDate", new Date(value));
					case 'dudtPlanDt':  //바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
						// $(".dudtPlanDt").val(value);
					case 'ordrsAmt':
					case 'exrate':
						inputField.value = addCommaStr(value);
						break;
					case 'exchangeAmt':
						inputField.value = addCommaStr(value);
						break;
					default:
						inputField.value = value || '';
						break;
				}
			});

			//수정시  로드 될떄 gridOrdrsPlan 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
			var pmntPlans = data.ordrsInfo.plans;
			gridOrdrsPlan.setData({
				list: pmntPlans,
				page: {
					totalElements: pmntPlans.length
				}
			});
			//수정시  로드 될떄 orderDetails 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
			var ordrsDetails = data.ordrsInfo.details;
// 			if ($("#coCd").val() != jwt.coCd) {
			//****************************************************
			// 2027.07.15 남장서 수정 적용
			//회사코드가 GUN 인경우 영업(GUN30), 회계팀(GUN20), 전산팀(GUN80)
			//회사코드가 TRN 인경우 트루넷(TRN),  회계팀(GUN20), 전산팀(GUN80)만 수주목표가 및 수주금액 조회가능 함. 
			let passChkDeptId = jwt.deptId;

   			if (($("#coCd_S").val() == 'GUN' && (passChkDeptId.includes('GUN00') || passChkDeptId.includes('GUN30') || passChkDeptId.includes('GUN20') || passChkDeptId.includes('GUN80'))) ||
   			    ($("#coCd_S").val() == 'TRN' && (passChkDeptId.includes('GUN00') || passChkDeptId.includes('TRN')   || passChkDeptId.includes('GUN20') || passChkDeptId.includes('GUN80')))) {
				//정상 조회가능함
			} else {
				$("#ordrsAmt").val("0");
				$("#exchangeAmt").val("0");
				for (var i = 0; i < ordrsDetails.length; i++) {
					ordrsDetails[i].estTrgtCost = 0;	//수주목표가
					ordrsDetails[i].ordrsAmt = 0;		//수주가
					ordrsDetails[i].exchangeAmt = 0;	//
					ordrsDetails[i].ordrsPrcMach = 0;	//기계PART
					ordrsDetails[i].ordrsPrcElcty = 0;	//전기PART
					ordrsDetails[i].ordrsPrc = 0;		//전기PART
// 					ordrsDetails[i].estEpctMatPrc = 0;	//견적 예상 재료비
				}

				$("#viewHistory").hide();
			}
			gridOrdrsDetail.setData({
				list: ordrsDetails,
				page: {
					totalElements: ordrsDetails.length
				}
			});
			

			$('#coCd').trigger('change'); //파일트리 새로 그리기
			
			gridResize(ordrsDetails.length+1); //그리드 높이 조정
			//monthCloseChk($('#ordrsDt').val());  //마감일통제 원래 위치
			gridViewPop7.initView().setData(0);
			gridViewPop7.target.setHeight((gridViewPop7.target.list.length+1) * 27 + 123 );//그리드 높이 조정

			setDetailButton();// 설비 & 원가 정보 버튼 통제

			//최초값셋팅
			setInitSetting();
		});

	}

	$("#addPaymentButton").on("click", function () {
		var row;
		var newRowData = {
				clmnPlanDiv: "CLMNPLANDIV1",
				clmnDivSeq : 1,
				clmnRate : 0,
				clmnAmt : 0,
				clmnDt : "",
				pmntDtAfterBill : "",
				billPblsDt : "",
				clmnMgmtStatus : "",
		};

		//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
		// if ($('#actionOrdrsBtn').is(':hidden')) {
		//     $('#ordrsPlanUpdate').show();
		// }

		var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
		var bordrsDiv = $("#ordrsDiv").val() //수주구분
		// if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && bordrsDiv != 'ORDRSDIV3' && $("#ordrsDiv").val() != "ORDRSDIV8" && bordrsDiv != 'ORDRSDIV9' ){
		// 	alert("수주금액을 입력바랍니다.");
		// 	return false;
		// } else {
				// 첫 번째 경우: 선택된 행이 있는 경우
				if (selectedRowKey !== undefined) {
					let row = gridOrdrsPlan.getList("selected")[0];
					let newRowData = $.extend({}, row, {__index: undefined, clmnRate: 0, clmnAmt: 0});
					gridOrdrsPlan.addRow(newRowData, row.__index + 1);
				}
				// 두 번째 경우: 그리드가 비어 있는 경우
				else if (gridOrdrsPlan.getList().length === 0) {
					gridOrdrsPlan.addRow(newRowData, 0);
				}
				// 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
				else {
					gridOrdrsPlan.addRow(newRowData, gridOrdrsPlan.list.length);
					return;
				}

					const data = gridOrdrsPlan.getList();
					gridOrdrsPlan.setData({
						list: data,
						page: {
							totalElements: data.length
						}
					});
		// }
		prevData = JSON.parse(JSON.stringify(gridOrdrsPlan.getList()));
		// 여기에서 그리드 데이터가 준비된 후 실행하려는 코드를 추가할 수 있습니다.

	});

	$("#deletePaymentButton").on("click", function () {
		if (selectedRowKey !== undefined) {
			gridOrdrsPlan.removeRow(selectedRowKey);
			const data = gridOrdrsPlan.getList();
			gridOrdrsPlan.setData({
				list: data,
				page: {
					totalElements: data.length
				}
			});

			//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
			// if ($('#actionOrdrsBtn').is(':hidden')) {
			//     $('#ordrsPlanUpdate').show();
			// }

			// 선택된 행을 업데이트합니다.
			if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
				if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
					gridOrdrsPlan.select(selectedRowKey);
				} else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
					selectedRowKey = selectedRowKey - 1;
					gridOrdrsPlan.select(selectedRowKey);
				}
			} else { // 데이터가 없다면 선택된 행을 초기화합니다.
				selectedRowKey = undefined;
				// 이 경우 삭제 버튼을 비활성화할 수 있습니다.
				// 예: $("#deleteProductButton").prop("disabled", true);
			}
		} else {
			alert("삭제를 위해 선택된 행이 없습니다.");
		}
	});

	
	function getTypeCodeByName(name, options) {
		  const found = options.find(opt => opt.NM === name);
		  return found ? found.CD : null;
		}
	
	//자동 설비원가 등록
	function addDetailButtionClick(){
		var paramObj = modalStack.last().paramObj;
		var date = dateToStr(new Date());
		
		var mctype = "MCT01";
		var itemDiv = "ITEMLIST01";
		var ordrsDtlDiv30 = "ORDRSDTLDIV3010";
		var prdtCd = "NVF";
		var eqpNm = "";
		var salesCd = "";
		var dudtIntendDt = date;	
		
		
		if(paramObj.isAs == "Y"){
			mctype = getTypeCodeByName(paramObj.mctypeNm, comboOdd4);
			itemDiv = paramObj.itemDiv;
			ordrsDtlDiv30 = getTypeCodeByName(paramObj.ordrsDtlDiv30Nm, comboOdd3);
			prdtCd = paramObj.prdtCd;
			eqpNm = paramObj.eqpNm;
			salesCd = paramObj.salesCd;
			dudtIntendDt = paramObj.dudtIntendDt;
		}
		
		// var row;
		var newRowData = {
			ordrsDtlDiv10 : "ORDRSDTLDIV1010",
			prdtCd : prdtCd,
			itemDiv : itemDiv,
			ordrsDtlDiv20: ($('#ordrsDiv').val() === 'ORDRSDIV2' || $('#ordrsDiv').val() === 'ORDRSDIV3') ? "ORDRSDTLDIV2040" : "ORDRSDTLDIV2010",
			ordrsDtlDiv30 : ordrsDtlDiv30,
			mctype : mctype,
			orgnSalesCd : salesCd,
			eqpNm : eqpNm,
			dudtIntendDt : dudtIntendDt,
			ordrsPrcMach : 0,
			ordrsPrcElcty : 0,
			ordrsQty : 0,
			estEpctMatPrc : 0,
			trgtPchsPcostMach : 0,
			trgtPchsPcostElcty : 0,
			trgtPchsPcostInHousePrcsn : 0,
			laborCostMfgCost : 0,
			cudCheck : "C",   //추가, 수정, 삭제구분
			ordrsSeq : "0",   //삭제오류 방지용
			estTrgtCost : 0,   //수주목표원가

		};
		var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
		var bordrsDiv = $("#ordrsDiv").val() //수주구분
		//수주구분 : 정상수주가 아닐경우
		// if (bordrsDiv != 'ORDRSDIV1' && gridOrdrsDetail.getList().length >=1) {
		//     alert("수주구분이 A/S에서는 1줄만 추가 가능합니다.");
		//     return false;
		// }
		// if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && (bordrsDiv != 'ORDRSDIV3') && (bordrsDiv != 'ORDRSDIV8') && (bordrsDiv != 'ORDRSDIV9')){
		// 	alert("수주금액을 입력바랍니다.");
		// 	return false;
		// } else {
				// 첫 번째 경우: 선택된 행이 있는 경우

				let row = gridOrdrsDetail.getList("selected")[0];
				if (row !== undefined) {
					row.salesCd = "";
					row.cudCheck = "C";	//추가, 수정, 삭제구분
					row.ordrsSeq = "0";	//삭제오류 방지용
					gridOrdrsDetail.addRow(row, gridOrdrsDetail.list.length);
					gridResize(gridOrdrsDetail.list.length + 1); //그리드 높이 조정
				}
				else {
					gridOrdrsDetail.addRow(newRowData, gridOrdrsDetail.list.length);
					gridResize(gridOrdrsDetail.list.length + 1); //그리드 높이 조정s
				}
		// }
		
		
		
	}
	
	$("#addDetailButton").on("click", function () {
		addDetailButtionClick();
		
	});

	//설비&원가정보 삭제키_OLD
	$("#deleteDetailButton").on("click", function () {
		let gridList = gridOrdrsDetail.getList("selected")[0];
		if (gridList == undefined) {
			alert("선택된 행이 없습니다.");
			return false;
		}
		paramObj = {
				"salesCd" 	: gridList.salesCd,
				"coCd"	  	: gridList.coCd,
				"ordrsNo"	: gridList.ordrsNo,
				"ordrsSeq" 	: gridList.ordrsSeq
			};
		let processNoDelete = false;	//오류 체크용
		if (gridList.ordrsDtlDiv10 == 'ORDRSDTLDIV1040') {
			postAjaxSync("/user/cr/cr02/unsettledAmtCreditChk", paramObj, null, function(data){
				const list = data.result;
				if (list.length != 0) {
					let msg = '';
					for (let i = 0; i <list.length; i++) {
						msg += '\n' + list[i].ordrsNo + '-' + list[i].ordrsSeq;
					}
					alert(`${gridList.eqpNm} 건은 정상상계처리가 등록되어 있어 삭제할 수 없습니다.` + msg);
					processNoDelete = true; //삭제 불가능
					return false;
				}
			});
		} 
		if (processNoDelete) return false; //삭제 불가능
		
		if (gridList.salesCd) {
			postAjaxSync("/user/cr/cr02/deleteDetailChk", paramObj, null, function(data){
				if (data.result) {
					let msg = data.result.msg;
					if (msg && msg.trim() !== "") 
						{alert(gridList.salesCd + "는 " + msg + "에 이미 등록되어 있어 삭제할 수 없습니다.");
						return false;
					}
				} else {
					deleteRow(gridList);
					return true;
				}
			});
		} else {
			deleteRow(gridList);
		}

		// 해당 로우 삭제하는 함수
		function deleteRow(gridList) {
			let todoKey = gridList.ordrsSeq;
			let selRow = gridList.__index;
			if (typeof(todoKey) === "undefined") {
				gridOrdrsDetail.removeRow(selRow);
			} else {
				if (gridList.cudCheck !== "C") {
					gridOrdrsDetaildeleteArr.push(gridList);
				}
				gridOrdrsDetail.removeRow(selRow);
			}
		}
	});

	function insertOrdrs() {
		if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) {
			if($('#newOrdrsNo').val() == ''){
				alert('건양ITT 수주번호를 선택해 주십시요.')
				fn_orderSearch();
				return false;
			}
		}

		if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
			var formData = makeFormData();
			if (formData) {
				openProgress(true);
				filePostAjax("/user/cr/cr02/insertOrdrs", formData, function (data) {
					if (data.resultCode == 200) {
						
					 	
						alert(data.resultMessage);
						//var odrSeq = data.odrSeq;
						ordrsNo = data.ordrsNo;
						$('#ordrsNo').val(ordrsNo);
						$('#histNo').val("1"); //insert는 무조건 처음 차수니까 무조건 1
						
						kakaoTodo(); 
						modalStack.close();
						gridView.setData(0);
					}else{
						alert(data.resultMessage);
					}
				});
			}
			openProgress(false);
		}
	}

	function updateOrdrs() {
		if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
			var formData = makeFormData();
			if (formData) {
				openProgress(true);
				filePostAjax("/user/cr/cr02/updateOrdrs", formData, function (data) {
					if (data.resultCode == 200) {
						alert(data.resultMessage);
						var odrSeq = $('#odrSeq').val();
						kakaoTodo(); 
						modalStack.close();
						gridView.setData(0);
					}else{
						alert(data.resultMessage);
					}
				});
			}
			openProgress(false);
		}
	}

	// 수금정보 수정시 처리하는 함수
	//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
	// function ordrsPlanUpdate() {
	//     if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
	//         var formData = makeFormData();
	//         if (formData) {
	//             openProgress(true);
	//             filePostAjax("/user/cr/cr02/updateOrdrsPmntPlanProcess", formData, function (data) {
	//                 if (data.resultCode == 200) {
	//                     alert(data.resultMessage);
	//                     var odrSeq = $('#odrSeq').val();
	//                 }else{
	//                 	alert(data.resultMessage);
	//                 }
	//             });
	//         }
	//     	openProgress(false);
	//     }
	// }

	//제품구분 찾기(그리드)
	function openSecondPrdtSearch() {
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd": $("#coCd").val(),
			"selpchCd": "SELPCH2",
			"impYn": "N",
			"clntCd": $("#estClntCd").val(),
			"prjctCd": $("#prjctCd").val(),
			"useYn": "Y"
		};

		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var prdtCd = grid.target.getList("selected")[0].prdtCd;
			var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];
			var rowData = gridOrdrsDetail.getList()[rowIndex];
			rowData.prdtCd = prdtCd;
			gridOrdrsDetail.updateRow(rowData, rowIndex);
		});
	}

	
	//정상상계처리인경우 추후정상 대상 SalesCode 찾기(그리드)
	function openUnsettledAmtSearch(row) {
		var paramObj = {
			coCd 		: $('#coCd').val(),
			clntCd		: $('#ordrsClntCd').val(),
			ordrsNo		: $('#ordrsNo').val(),	//자기오더내의 추후정산은 제외처리하기 위함.
			ordrsAmt	: row.ordrsAmt,
		};
		openSecondModal("/static/html/cmn/modal/unsettledAmtSearch.html", 1000, 700, "추후정상 대상 SALES CODE 검색", paramObj, function (grid) {
			var selRow = grid.target.getList("selected")[0];
			if (selRow.remOrdrsPrc < 0) {
				alert("정산상계처리에서 마이너스금액을 처리 할 수 없습니다.");
				return false;
			}
			
			
				rowIndex 			= row.__index;
				rowData 			= row;
				rowData.rowData				= "U";
				rowData.cudCheck 			= row.cudCheck;
				rowData.ordrsPrcMach 		= selRow.remOrdrsPrc;
				rowData.ordrsPrcElcty 		= 0;
				rowData.ordrsPrc 			= selRow.remOrdrsPrc;
				rowData.unsettledOrdrsNo 	= selRow.ordrsNo;
				rowData.unsettledOrdrsSeq 	= selRow.ordrsSeq;
				rowData.eqpNm 				= `${selRow.ordrsNo}-${selRow.ordrsSeq}에서 정산 처리됨`;

				if (rowData.cudCheck != "C") {
					rowData.cudCheck = "U";   //추가, 수정, 삭제구분
				}
// 				gridOrdrsDetail.updateRow($.extend({}, gridOrdrsDetail.list[rowIndex], rowData), rowIndex);
				gridOrdrsDetail.updateRow(rowData, rowIndex);

		});
	}

	//원천SalesCode 찾기(그리드)
	function openSalesCdSearch() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"salesCd": $('#orgnSalesCd').val()
		};

		openSecondModal("/static/html/cmn/modal/SalesCodeItemSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];
			var rowData = gridOrdrsDetail.getList()[rowIndex];

			// 선택한 원천 salesCd의 고객사 PJT가 기존에 등록되어 잇는 PJT가 다르면 return false 시키고 원복시켜야함
			if ((actionType == 'U' && originalOrdrsInfo != undefined && originalOrdrsInfo.clntPjt != row.clntPjt)) {
				customAlert("고객사PJT가 등록되어 있는 자료와 다릅니다. 확인하고 다시 입력해주세요.")
				return false;
			}

			//설비인것만 세팅
			if (rowData.ordrsDtlDiv10 == 'ORDRSDTLDIV1010') {
				rowData = {
					// ordrsDtlDiv10 : row.ordrsDtlDiv10,
					prdtCd : row.prdtCd,
					itemDiv : row.itemDiv,
					ordrsDtlDiv20: ($('#ordrsDiv').val() === 'ORDRSDIV2' || $('#ordrsDiv').val() === 'ORDRSDIV3') ? "ORDRSDTLDIV2040" : row.ordrsDtlDiv20,
					ordrsDtlDiv30 : row.ordrsDtlDiv30,
					orgnSalesCd : row.salesCd,
					eqpNm : row.eqpNm,
					// ordrsPrcMach : 0,
					// ordrsPrcElcty : 0,
					// ordrsQty : 0,
					// estEpctMatPrc : 0,
					// trgtPchsPcostMach : 0,
					// trgtPchsPcostElcty : 0,
					// trgtPchsPcostInHousePrcsn : 0,
					// laborCostMfgCost : 0,
					dataChk : "U",
					cudCheck : rowData.cudCheck,
					clntPjt : row.clntPjt
					// estTrgtCost : 0,   //수주목표원가
				};

				if (rowData.cudCheck != "C") {
					rowData.cudCheck = "U";   //추가, 수정, 삭제구분
				}
				gridOrdrsDetail.updateRow($.extend({}, gridOrdrsDetail.list[rowIndex], rowData), rowIndex);
				// gridOrdrsDetail.updateRow(rowData, rowIndex);
				//수주구분이 무상AS 이면 프로젝트 원천 Sales Code로 변경처리함.
				if ($('#ordrsDiv').val() === "ORDRSDIV3" || ($('#prjctSeq').val()=="" &&  $('#clntPjt').val() == "")) {
					// $('#ordrsDiv').val(row.prjctNm);
					$('#prjctSeqNm').val(row.prjctNm);
					$('#prjctSeq').val(row.prjctSeq);
					$('#clntPjt').val(row.clntPjt);
				}
			}
		});
	}
	
	$("#ordrsPlanHis").click(function () {
		var paramObj = {
			"coCd": $("#coCd").val(),
			"ordrsNo": $("#ordrsNo").val(),
		};

		openSecondModal("/static/html/cmn/modal/ordrsPlanHisSearch.html", 1000, 420, "수금계획수정이력", paramObj, function (grid) {

		});
	})

	// 사용자 검색 함수
	function openSecondUserSearch(searchValue) {

		if (event && event.keyCode === 13) {
			event.preventDefault();  // prevent form from submitting
		}
		var paramObj = {
			"coCd": $('#coCd').val(),
			"userId": $('#mngId').val(),
			"userNm": $('#mngIdNm').val(),
			"useYn": "Y",
			"searchValue": searchValue
		};

		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree) {
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$("#mngId").val(checkedNode.id);
			$("#mngIdNm").val(checkedNode.text);
			// $("#salesEmpNm").val(checkedNode.text);
			$("#mngId").focus();
			$("#mngId").trigger("click");
		});
	}


	// 프로젝트 검색 함수
	function openSecondProjectSearch(searchValue) {

		if (event && event.keyCode === 13) {
			event.preventDefault();  // prevent form from submitting
		}
		var paramObj = {
			"coCd"		 : $('#coCd').val(),
			"prjctSeq"	 : $('#prjctSeq').val(),
			"prjctSeqNm" : $('#prjctSeqNm').val(),
			"reqDtFrom"	 : $('#ordrsDt').val(),
			// "prjctNm"	 : $('#clntPjt').val(),
			"prjctNm"	 : $('#clntPjt option:selected').text(),
			"searchValue": $('#prjctSeqNm').val()
		};

		openSecondModal("/static/html/cmn/modal/prjctSearch.html", 1300, 670, "프로젝트 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$("#prjctSeq").val(row.prjctSeq);
			$("#prjctSeqNm").val(row.prjctNm);
			$("#clntPjt").val(row.prjctCd);
			$("#prjctSeqNm").focus();
			$("#prjctSeqNm").trigger("click");
		});
	}


	function gridResize(size) {
		if (beforeGridSize != size) {
			let tagHeight = (size) * 27 + 123 ;
			tagHeight = tagHeight > 750 ? 750 : tagHeight;
			tagHeight = tagHeight < 300 ? 300 : tagHeight;

			// $('[data-ax5grid="second-grid-modal"]').height(tagHeight);
			// $('[data-ax5grid="second-grid-modal"] [data-ax5grid-container="root"]').height(tagHeight);

			gridOrdrsDetail.setHeight(tagHeight);
			beforeGridSize = size;
		}
	}

	function  gridPaste(thisGrid, thisGridRow, thisGridCol, _type = "DETAIL" ) {
		var pasteData = "";

		navigator.clipboard.readText()
		.then(pasteData => {
			// console.log('클립보드에 저장된 값:', pasteData);
			if (pasteData == undefined || pasteData == "" || thisGridRow == undefined) {
				console.error('클립보드에 데이터가 없습니다.');
				return;
			}

			// 붙여넣기할 데이터를 배열로 변환한다.
			var pasteRows = pasteData.split("\n").map(function(row) {
				return row.split("\t");
			});

			//복사대상의 마지막 배열의 값이 없으면 제외
			if (pasteRows[pasteRows.length - 1] == "") pasteRows.splice(pasteRows.length - 1, 1);

			// 붙여넣기를 시작할 셀의 인덱스를 구한다.
			var startRowIndex = thisGridRow;
			var startColIndex = thisGridCol;

			// 붙여넣을 데이터의 행과 열 개수를 구한다.
			var numRows = pasteRows.length;
			var numCols = pasteRows[0].length;

			//그리드 컬럼정보를 가져와서 붙여넣기할때 위치정보로 사용한다.
			tempColumns = thisGrid.colGroup;
			for (var i = tempColumns.length - 1; i >= 0; i--) {
				if (tempColumns[i].hidden) {
					tempColumns.splice(i, 1);
				}
			}

			var currGridData = thisGrid.list;

			//마지막자료와 같은 값으로 추가하고 ordrsSeq는 0으로 설정
			//참조복사를 방지하기 위함
			var tempData = JSON.parse(JSON.stringify(currGridData[thisGridRow]));
			tempData.ordrsSeq = "0";

			// 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
			for (var i = 0; i < numRows; i++) {
				for (var j = 0; j < numCols; j++) {
					//carriage return 문자 삭제
					var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');

					calRow = startRowIndex + i;
					calCol = startColIndex + j;

					if (calRow >= currGridData.length) {
						//참조복사를 방지하기 위함
						let tempDataCopy = JSON.parse(JSON.stringify(tempData));
						tempDataCopy.cudCheck = "C"; //추가 플래그 설정
						currGridData.push(tempDataCopy);
					}

					var tkey = tempColumns[calCol].key;
					currGridData[calRow][tkey] = cellData;
				}
				if (_type == "DETAIL") {  //설비쪽 붙여넣기인경우  신규추가 레코드가 아니면 수정 Flag로 변경처리
					if (currGridData[calRow]["cudCheck"] != "C") {  //추가된 레코드가 아니면 수정 함으로 설정
						currGridData[calRow]["cudCheck"] = "U"; //수정 플래그 설정
					}
				}
			}

			var currEndRow = currGridEndRow();
			thisGrid.setData(currGridData);
			// gridResize(currGridData.length);
			// thisGrid.focus(thisGridRow);
			resetGridFocus(currEndRow, thisGridRow);
		})
		.catch(error => {
			// console.log('클립보드 읽기 오류 발생:', error);
		});
	};

	//환율 load
	var paramObj = {
		"userId" : jwt.userId,
		"codeKind" : "CURR"
	};

	postAjax("/user/sm/sm02/selectCurrToday", paramObj, null , function(data) {
		if(data.resultList.length > 0 ) {
			currToday = data.resultList;
		}
	});
	//user search ajax end

	//등록시 통화단위에 따른 환율 SET
	$('#popForm #currCd').on("change", function() {
		var ordrsAmtVal = pasFloatChk($("#ordrsAmt").val()); //수주금액에 적힌 값

		// if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && $("#ordrsDiv").val() != 'ORDRSDIV3' && $("#ordrsDiv").val() != 'ORDRSDIV8' && $("#ordrsDiv").val() != 'ORDRSDIV9') {
		// 	$('#currCd').val('CURR01');
		// 	alert("수주금액을 입력바랍니다.");
		// 	return;
		// }

		if(actionType == "C" && $(this).val() != "" ) {
			var selVal = $(this).val();
			var exrate = currToday[selVal];
			var find = currToday.find(e => e.codeId === selVal);

			if( typeof(find.codeEtc) != "undefined" ) {
				$('#popForm #exrate').val(addCommaStr(find.codeEtc));
				$('#exchangeAmt').val(addCommaStr(find.codeEtc*ordrsAmtVal));
			}
		} else if( actionType == "C" && $(this).val() == "" ) {
			$('#popForm #exrate').val('');
		}
	});

	// Ctrl + V 단축키 이벤트 처리
	gridOrdrsDetail.$target.on("paste", function (e, a) {
		gridPaste(gridOrdrsDetail, thisGridRow, thisGridCol);
	});

	function pasIntChk (ivalue) {
		let value = ivalue +' ';
		const cvtValue = parseInt(value.replace(/[^0-9.-]/g, ''));
		return isNaN(cvtValue) ? 0 : cvtValue;
	}

	function pasFloatChk (ivalue) {
		let value = ivalue +' ';
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다.
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}

	//그리드 수정후 현재 위치로 이동하기 위한 함수
	//상태바에서 시작 또는 마지막 표시 row를 산정함
	// resetGridFocus()와 분리한 이유는 화면에 기존 데이터 Refresh하기전 위치 위치 저장하기 위함
	function currGridEndRow() {
		//row focus 처리용 그리드 상태바에서 "30 - 53 of 59" 에서 시작 ROW 30, 마지막ROW 53임
		// var gridStatus = $('.popup_area [data-ax5grid="second-grid-modal"] [data-ax5grid-page="status"]').text().trim();
		// var gridStatusIdx = gridStatus.indexOf(' ');
		// var topRow = gridStatus.slice(0, gridStatusIdx).trim();
		// var regex = /-(.*?) of/; // '-'와 'of' 사이의 숫자를 찾는 정규 표현식
		// var match = regex.exec(gridStatus);

		// if (match && match.length > 1) {
		//     var gridDisplayEndRow = match[1].trim(); // '-'와 'of' 사이의 숫자를 가져옴
		// }
		//현재 표시하는 ROW정보 상태바에서 grid 함수내 값으로 대체
		var gridDisplayEndRow = gridOrdrsDetail.xvar.virtualPaintRowCount //화면출력 row수
							+ gridOrdrsDetail.xvar.virtualPaintStartRowIndex; //화면 출력 시작 Row index
		return gridDisplayEndRow < 4 ? 0 : gridDisplayEndRow - 3;
	}

	function resetGridFocus(endRow, row) {
		gridOrdrsDetail.focus(endRow);

		gridResize(gridOrdrsDetail.list.length+2); //그리드 높이 조정
		beforeGridSize = gridOrdrsDetail.list.length;
		gridOrdrsDetail.focus(row);
	}

	//이력생성
	function createHistory() {
		var hist_no = $("#histNo").val();
		if(confirm("저장 된 정보로 이력을 생성을 진행하시겠습니까?")) {
			var paramObj = {
				coCd : $("#coCd").val(),
				ordrsNo : $("#ordrsNo").val(),
				histNo : $("#histNo").val(),
				pgmId : $("#pgmId").val(),
				userId : jwt.userId
			};

			postAjaxSync("/user/cr/cr02/callCopyOrdrs", paramObj, null, function(data) {
				$("#histNo").val(parseInt(hist_no) + 1);
				gridViewPop7.initView();
				$('#actionOrdrsBtn').show();
				alert("이력생성이 완료되었습니다.");
			});
		}
	}

	function chechChange() {
		// var inputAmtVal = pasIntChk($("#ordrsAmt").val());
		// var inputExrateVal = pasIntChk($("#exrate").val());
		var inputAmtVal = pasFloatChk($("#ordrsAmt").val());
		var inputExrateVal = pasFloatChk($("#exrate").val());

		var exchangeAmt = addCommaStr(inputAmtVal*inputExrateVal);
		inputAmtVal = addCommaStr($("#ordrsAmt").val());
		inputExrateVal = addCommaStr($("#exrate").val());

		$("#exchangeAmt").val(exchangeAmt);
		$("#exrate").val(inputExrateVal);
		$("#ordrsAmt").val(inputAmtVal);
	}

	function commaChange() {
		var inputAmtVal = addCommaStr($("#ordrsAmt").val());
		var inputExrateVal = addCommaStr($("#exrate").val());
		var inputExchangeVal = addCommaStr($("#exchangeAmt").val());

		$("#exchangeAmt").val(inputExchangeVal);
		$("#exrate").val(inputExrateVal);
		$("#ordrsAmt").val(inputAmtVal);
	}

	function setClmnDtYn(clmnDt) {
		if(isNaN(clmnDt)) {
			commaChange();
			alert("수금예정일자가 없습니다.");
			return false;
		}
	}

	function fn_orderSearch() {
		// if (actionType == "C") {
			if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) {
				var paramObj = {
					"searchValue" : '',
					"coCd" : 'GUN'
				};

				openSecondModal("/static/html/cmn/modal/noSalesCdordrsSearch.html", 1200, 650, "건양수주번호 검색", paramObj, function (grid) {
					var row = grid.target.getList("selected")[0];
					// console.log(row);
					$('#newOrdrsNo').val(row.ordrsNo);
					$('#ctrtNm').val(row.ctrtNm);
					$('#clntPjt').val(row.clntPjt);
				});
			}
		// }
	}

	function setDetailButton() {
		//고객사가 건양ITT면 설비&원가정보는 필요없음
		// if($('#coCd').val() == 'TRN' && $("#ordrsClntCd").val() == refCode) {
		//     $("#datailButtonDiv").hide();
		//     $("#datailGridDiv").hide();
		//     $('#ordrsNoTh').addClass('hit');
		//     $('#newOrdrsNo').attr('required', 'required');
		// } else {
		//     $("#datailButtonDiv").show();
		//     $("#datailGridDiv").show();
		//     $('#ordrsNoTh').removeClass('hit');
		//     $('#newOrdrsNo').removeAttr('required', 'required');
		// }
	//사용자 테이블의 회사코드와 자료의 회사코드가 다르면  조회모드만 작동
	if ($('#popForm #coCd').val() != jwt.coCd) {
		$('.coAuthChk').hide();
	}
	}

	function setInitSetting() {
		if($("#ordrsDiv").val() == "ORDRSDIV3" || $("#ordrsDiv").val() == "ORDRSDIV8" || $("#ordrsDiv").val() == "ORDRSDIV9") {
			$("#ordrsAmtTh").removeClass('hit');
			$("#currCdTh").removeClass('hit');
			$('#ordrsAmt').attr('readonly', 'true');
			$('#ordrsAmt').val("0");
			$('#exchangeAmt').val("0");
		} else {
			$("#ordrsAmtTh").addClass('hit');
			$("#currCdTh").addClass('hit');
			$('#ordrsAmt').removeAttr('readonly', 'true');
		}
		if ($("#ordrsDiv").val() == "ORDRSDIV2" || $("#ordrsDiv").val() == "ORDRSDIV3") {
			$('#prjctTh').removeClass('hit')
			$('#prjctSeqNm').prop('disabled', true); 
			$('#searchButton').addClass('hidden'); 
			$('#clntPjt').prop('disabled', false);
		} else {
			$('#prjctSeqNm').prop('disabled', false); 
			$('#searchButton').removeClass('hidden');
			$('#clntPjt').prop('disabled', true);
		}
		setInitInsert();
	}

	function setInitInsert() {
		if($("#fwdExchChkList").val() == "N") {
			$('#fwdExchJoinDt').attr('readonly', 'true');
			$('#fwdExchJoinDt').hide();
		} else {
			$('#fwdExchJoinDt').removeAttr('readonly', 'true');
			$('#fwdExchJoinDt').show();
		}
	}

	function excelDown1() {
			//var list = data.result;
			var todayDate = new Date().format('yyyyMMddHHmmss');
			gridOrdrsDetail.exportExcel("수주관리 설비원가정보("+$('#ordrsNo').val()+")_"+todayDate+".xls");
	}

	// 출력 버튼용
	function setReportMain() {
		////////////////////////////////
		var paramObj = {
				coCd : $("#coCd").val(),
				ordrsNo : $("#ordrsNo").val(),
				histNo : $("#histNo").val()
			};

			postAjaxSync("/user/cr/cr02/selectJunmooApproval", paramObj, null, function(data) {
				if (data.JunmooApproval == 1){
					//소속부서가 영업팀이면 원가관리표(CR0202R03.jrf), 아니면 목표원가표(CR0202R04.jrf) 출력
					// GUN==GUN && GUN30, TRN==TRN && TRN30만 원가관리표 출력 가능함
					let fileName = (jwt.coCd==$("#coCd").val() && (jwt.deptId.substr(0,5) == 'GUN30' || jwt.deptId.substr(0,5) == 'TRN30')) ? "CR0202R03.jrf" : "CR0202R04.jrf";
					let arg = "coCd#" + $("#coCd").val() + "#ordrsNo#" + $("#ordrsNo").val() + "#histNo#" +  $("#histNo").val()
					+ "#";
					callReport(fileName, arg, "1050", "700", $("#ordrsClntNm").val()+"_"+$("#ordrsNo").val()+"-"+$("#histNo").val());
				}
				else {
					alert("원가 출력은 전무님 결재 처리 후 가능합니다.");
				}
			});
		////////////////////////////////
	}

	// 공유대상자 추가//
	function insertShareUserModal1() {

		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

		var paramObj = {};
		var appshaList = gridViewPop7.target.list;
		paramObj["coCd"] = $('#coCd').val();
		paramObj["useYn"] =  "Y";
		paramObj["userId"] =  $('#ordrgId').val();
		paramObj["userNm"] =  $('#ordrgNm').val();
		paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
				}).map(function(item) {
						return {
							gb: "결재",
							id: item.usrNm,
							text: item.name,
							parent: item.jik,
							deptNm: item.dtNm,
							telNo: item.telNo,
							offTelNo: item.offTelNo,
							email: item.email,
							todoId: item.id
							, todoKey: item.todoKey
							, sanctnSn: item.sanctnSn
							, sanctnSttus: item.sanctnSttus
							, todoCfDt: item.todoCfDt
							, todoCfOpn: item.todoCfOpn
							, flag: item.flag
						};
				});
		paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
				}).map(function(item) {
						return {
							gb: "공유",
							id: item.usrNm,
							text: item.name,
							parent: item.jik,
							deptNm: item.dtNm,
							telNo: item.telNo,
							offTelNo: item.offTelNo,
							email: item.email,
							todoId: item.id
							, todoKey: item.todoKey
							, sanctnSn: item.sanctnSn
							, sanctnSttus: item.sanctnSttus
							, todoCfDt: item.todoCfDt
							, todoCfOpn: item.todoCfOpn
							, flag: item.flag
						};
				});

		openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
			// console.log('결재라인 : ', approvalGrid.target.list);
			// console.log('공유라인 : ', shareGrid.target.list);

			var appArray = approvalGrid.target.list.map(function(item) {
				return {
						gb: "결재",
						usrNm: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id
						, todoKey: item.todoKey
						, sanctnSn: item.sanctnSn
						, sanctnSttus: item.sanctnSttus
						, todoCfDt: item.todoCfDt
						, todoCfOpn: item.todoCfOpn
						, flag: item.flag
					};
			});
			var shaArray = shareGrid.target.list.map(function(item) {
				return {
							gb: "공유",
						usrNm: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id
						, todoKey: item.todoKey
						, sanctnSn: item.sanctnSn
						, sanctnSttus: item.sanctnSttus
						, todoCfDt: item.todoCfDt
						, todoCfOpn: item.todoCfOpn
						, flag: item.flag
					};
			});
			gridViewPop7.setData2(appArray.concat(shaArray));

		});

	}

	//결재 여부
	function approvalYn() {
		var gridList = gridViewPop7.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
				var msgArr = [];
				$.each(gridList, function (idx, elem) {
				//결재자가 본인이 아니면서 상태가 Y인 경우
				if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
				})
		}
	return inCnt;
	}

	function deleteShareUser1(){
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

		var selRow = parseInt(gridViewPop7.target.selectedDataIndexs);
		if( isNaN(selRow) ) {
			alert("선택된 행이 없습니다.");
			return;
		} else {
			if( selRow > -1 ) {
				var todoKey = gridViewPop7.target.getList()[selRow].todoKey;
				var gridList = gridViewPop7.target.getList("selected")[0];
				if( typeof(todoKey) == "undefined" ) {
					gridViewPop7.target.removeRow(selRow);
					$.gridNoSet(gridViewPop7, "sanctnSn");
				} else {
					var paramObj = {
						todoNo: $("#popForm #ordrsNo").val(),
						todoKey: gridList.todoKey,
						sanctnSn: gridList.sanctnSn,
						todoDiv1CodeId: gridList.todoDiv1CodeId,
						todoDiv2CodeId: gridList.todoDiv2CodeId
					}
						//  if( confirm("선택행을 삭제하시겠습니까?")) {
							deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
							if (data.resultCode == 200) {
								alert(data.resultMessage);
								gridViewPop7.setData(0);
							} else {
								alert("삭제중 오류가 발생했습니다");
							}
							});
					//      }
					//    } else {
					//       alert("삭제중 오류가 발생했습니다.")
					//    }
				}
			}
		}
	}


	/*
	#   TODO 알림톡발송 시작
	#
	*/
	// $("#approvalReqTodoBtn").on("click", function () {
	//    kakaoTodo();
	// });

	function kakaoTodo() {
		//message load
		if (kakaoErr.length == 0) {
			var paramObj = {
				"userId" : jwt.userId
				, "codeKind" : "KAKAOMSG"
			};
			postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
				if(data.resultList.length > 0 ) {
					kakaoErr = data.resultList;
				}
			});
		}

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
		var paramObj1 = {
			"coCd" : $("#coCd").val(),
			"userId" : $("#mngId").val()
		};
		postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data) {
			if (data.result[0] == undefined || data.result[0].telNo == "") {
				teleNo = "051-312-2400";
			} else {
				teleNo = data.result[0].telNo;
			}
		});

		// 2024.05.16 김성욱 추가 수정 대분류 알림메세지에 추가
		var paramObj2 = {
			"ordrsNo" : $("#ordrsNo").val(),
			"histNo" : $("#histNo").val()
		};
		postAjaxSync("/user/cr/cr02/selectOrderChangeTitle", paramObj2, null, function(data) {
			if (data.result[0] == undefined || data.result[0].chgNm == "") {
				chgNm = "수주관리";
			} else {
				chgNm = "수주관리 " + data.result[0].chgNm;
			}
		});
		// 2024.05.16 김성욱 추가 수정 대분류 알림메세지에 추가 끝

		//---------------------------------------
		let param = {
			"tmplatDiv": "TMPLATDIV02"
			, "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
			, "todoDiv1CodeId": "TODODIV20"               //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV2100"               //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "결재"                  //공통코드 해당업무 - 결재 - 발주서
			//, "todoDiv2CodeNm": "발주 및 출장 요청"                  //공통코드 해당업무 - 결재 - 발주서
			, "title": chgNm
			, "sanctnDiv2": "결재"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo": $("#popForm #ordrsNo").val()
			, "histNo": $("#popForm #histNo").val()   //수주차수
			//, "todoNo": tReqNo
			, "clntCd": "1"               //발신회사는 로그인사용자 회사
			, "clntNm": clntNm            //로그의 수신거래처명
			, "ordrgMngNm": $("#popForm #mngIdNm").val()         //수주작성자(담당자)
			, "ordrgMngTelNo": teleNo      //담당자전화번호
			, "creatPgm"  : "CR0202P01"
		}
		commKaKaoSendTodo(param);

		//공유
		let param2 = {
			"tmplatDiv": "TMPLATDIV02"
			, "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
			, "todoDiv1CodeId": "TODODIV10"               //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "TODODIV1100"               //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "공유"                  //공통코드 해당업무 - 결재 - 발주서
			, "title": chgNm
			, "sanctnDiv2": "공유"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo": $("#popForm #ordrsNo").val()
			, "histNo": $("#popForm #histNo").val()   //수주차수
			//, "todoNo": tReqNo
			, "clntCd": "1"               //발신회사는 로그인사용자 회사
			, "clntNm": clntNm            //로그의 수신거래처명
			, "ordrgMngNm": $("#popForm #mngIdNm").val()         //수주작성자(담당자)
			, "ordrgMngTelNo": teleNo      //담당자전화번호
			, "creatPgm"  : "CR0202P01"
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
			kakaoCnt = 0;
			// alert("알림톡이 정상 발송되었습니다.");
		}
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
		// console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);
		//알림톡수신번호 채번
		var maxMessageId = null;         //message id(unique key)
		var talkMessage = null             //발송될 내용 template
		var mobile = null               //수신인 휴대전화번호
		var title = null               //todo title
		var todoDiv2CodeNm = null               //todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null, function(data) {
			if(data.resultList.length > 0 ) {
				if( data.resultList[0].maxMessageId != "" ) {
					sendList = data.resultList;
				} else {
					alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
					return;
				}
			}
		});
		//user search ajax end

		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			//로그용
			param.rcvId = sendObj.todoId;         //todo 수신id
			param.rcvNm = sendObj.name;            //todo 수신자명
			param.nameTo = sendObj.name;            //todo 수신자명
			//title      = sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = todoDiv2CodeNm;
			//param.title = title;                        //요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}

			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.title = param.title;               //알림톡 타이틀 -
			talkBody.message = message;            //알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;            //휴대전화번호
			talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end

		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}


	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
		// console.log('---gridNoset run ---');
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}


	//수주변경 이력 조회
	function comparison_cr14_Modal() {
		//건양수주정보는 건양영업담당자만 상세내역 조회가능 함.  트루넷은 조회 불가
		//트루넷수주정보는 건양담당자 조회 가능함.
		if ($("#coCd").val() == 'GUN' && $("#coCd").val() != jwt.coCd) { 
			return false;
		}
		//최초 등록인경우에는 이력 정보가 없음		
		if ($("#ordrsNo").val() == "" || histNo == "") {
			alert("해당 수주건은 이력정보가 없습니다.");			
			return false;
		}
		var paramObj = {
			"fileTrgtKey" : fileTrgtKey,
			"coCd" 	      : $("#coCd").val(),
			"coNm" 	      : $('#coCd').find('option:selected').text(),
			"ordrsNo"     : $("#ordrsNo").val(),
			"histNo"	  : $("#histNo").val(),
			"pgmId"       : "CR0202P01",
		};
		openSecondModal("/static/html/user/cr/cr14/CR1401P01.html",  $('body').width(), $('body').height(), "", paramObj, function(data) {
			//callBakc 처리없음			
		});
	}

	
	//과제 팝업
	function openSecondModalTaskPop() {
		var row = gridOrdrsDetail.getList("selected")[0];
		if (!row) return false;
		var paramObj = {
			"sjNo"        : row.ordrsNo,
			"verNo"       : row.verNo,
			"fileTrgtKey" : row.wb21FileTrgtKey,
			"coCd" 	      : row.coCd,
			"userId"      : jwt.userId,
			"pgmId"       : "WB2101M02",
			"actionType"  : "U",
			"row"	      : row
		};
		openSecondModal("/static/html/user/wb/wb21/WB2101P01.html", 1200, 900, "과제관리수정", paramObj);
	}
	
	</script>

</html>
