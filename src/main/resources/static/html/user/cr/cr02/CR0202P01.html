<style>
 .truncate_multi_post {
 width: 802px;
      resize: none;
      padding: 1px;
      border: solid 1px #e6e6e6;
      border-radius: 5px;
      display: -webkit-box;   
      word-wrap:break-word;  
      text-align: left;
  }
</style>
<!--  //class=coAuthChk : 회사구분에 따른 권한관리용 (건양은 투루넷 권한 제거, 트루넷은 건양 권한 제거) -->

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit" id="cr02PopTit">수주 등록</h4>
    </div>
    
    <!-- <div>
        <a class="tbody_more_btn"></a>
    </div> -->
    
    <form id="popForm" onSubmit="return false;">
        <div class="form-group popup_table">
            <div id="createHistoryDiv" class="contents_tit">
                <div  class="add_btn_small pdl10">
                	<a id="ReportMain" onclick="setReportMain();"  style="height: 30px; line-height: 28px; width: 100px;">원가관리표 출력</a>
                    <a id="createHistory" onclick="createHistory();" class="coAuthChk" style="height: 30px; line-height: 28px; width: 60px;" authchk>Ver.Up</a>
                </div>
            </div>
            
            <input type="hidden" id="pgmId" name="pgmId" value="CR0202P01">
            <input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">
            <table>
                <colgroup>
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th class="hit">회사</th>
                    <td>
                        <select data-search="coCd" id="coCd" name="coCd" class="modal-coCd" style="width: 100%;" data-kind="CO" required msg="회사">
                        </select>
                    </td>
					
                    <th>견적서번호</th>
                    <td>
                        <div class="search_form">
                            <input
								onkeydown="if(event.keyCode==13) openSecondEstSearch(this.value);"
								type="text" id="estNoOrdrs" name="estNoOrdrs"
								class="modal-estNoOrdrs form-control" >
                            <a onclick="openSecondEstSearch($('#estNoOrdrs').val());"><i class="i_search_w"></i></a>
                            <!-- <a onclick="openSecondEstSearch(document.getElementsByClassName('modal-estNoOrdrs').value);"><i class="i_search_w"></i></a> -->
						</div>
					</td>

					<th>견적차수</th>
                    <td>
                        <input id="estDeg" type="text" name="estDeg" readonly>
                    </td>

					<th>수주번호</th>
					<td>
						<input id="ordrsNo" name="ordrsNo" type="text" readonly>
						<input id="newOrdrsDiv" name="newOrdrsDiv" type="hidden" >
					</td>
				</tr>

				<!-- 2행 -->
				<tr>
                    <th class="hit">수주일자</th>
                    <td>
                        <input type="text" class="input_calendar ordrsDt"
						autocomplete="off" id="ordrsDt" name="ordrsDt" date class="form-control" required onchange="monthCloseChk(this.value);">
                    </td>
                    
                    <th class="hit">수주구분</th>
					<td>
                        <select id="ordrsDiv" name="ordrsDiv" data-kind="ORDRSDIV" class="form-control" required>
                        </select>
                    </td>                    
                    
                    <th class="hit">고객사</th>
					<td>
<!--                         <input type="hidden" id="ordrsClntCd" name="ordrsClntCd"> -->
                        <input type="hidden" id="ordrsClntCd" name="ordrsClntCd">
						<div class="search_form">
							<input onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);" type="text" id="ordrsClntNm" name="ordrsClntNm" required msg="고객사">
							<a onclick="openSecondClntSearch(document.getElementById('ordrsClntNm').value);"> <i class="i_search_w"></i> </a>
						</div>
                    </td>

                    <th id="ordrsNoTh" class="">건양수주번호</th>
                    <td>
                        <div class="search_form">
                            <input id="oldOrdrsNo" name="oldOrdrsNo" type="hidden" readonly>
                            <input id="newOrdrsNo" name="newOrdrsNo" type="text" readonly>
                            <a onclick="fn_orderSearch();"><i class="i_search_w"></i></a>
                        </div>
                    </td>
                </tr>
				<!-- 3행 -->
				<tr>
					<th class="hit">계약명</th>
					<td colspan="3">
                        <input type="text" id="ctrtNm" name="ctrtNm" class="form-control" required msg="계약명">
                    </td>
                    
                    <th class="hit" title="담당자 정보를 확인합니다">담당자</th>
                    <td>
                        <div class="search_form">
                            <input
                                onkeydown="if(event.keyCode==13)openSecondUserSearch( this.value);"
                                type="text" id="mngIdNm" name="mngIdNm" required>
                            <input type="hidden" id="mngId" name="mngId"> <a
                                onclick="openSecondUserSearch( document.getElementById('mngIdNm').value);">
                                <i class="i_search_w"></i>
                            </a>
                        </div>
                    </td>

                    <th>고객사PJT</th>
					<td>
						<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" class="form-control"  required ></select>
						<!-- <input type="text" id="clntPjt" class="clntPjtOrdrs" name="clntPjt" required> -->
					</td>
				</tr>

				<!-- 4행 -->
				<tr>
					<th class="">결재방법</th>
					<td>
                        <select id="pmntMtd" name="pmntMtd" data-kind="PMNTMTD" class="form-control" >

                        </select>
                    </td>

					<th class="">발주자</th>
					<td>
                        <input type="text" id="ordrger" name="ordrger" class="form-control" >
                    </td>

                    <th class="hit" id="ordrsAmtTh">수주금액</th>
					<td>
                        <input type="text" id="ordrsAmt" name="ordrsAmt" required value="0"  class="form-control" onkeyup="onlyNumber(this); chechChange();" comma>
                    </td>

                    <th class="hit" id="currCdTh">통화단위</th>
                    <td>
                        <select id="currCd" name="currCd" data-kind="CURR" class="form-control" onchange="setByCoCd(this.value)" required>
                        </select>
                    </td>
				</tr>

				<!-- 5행 -->
				<tr>
					<th class="">선물환CheckList</th>
					<td>
                        <select data-kind="YN" id="fwdExchChkList" name="fwdExchChkList" class="form-control" >
                            
                        </select>
                    </td>
					<th class="">선물환가입일</th>
					<td>
                        <input type="text" class="input_calendar" autocomplete="off" id="fwdExchJoinDt" name="fwdExchJoinDt" date>
                    </td>


                    <th class="">원화금액</th>
                    <td>
                        <input type="text" id="exchangeAmt" name="exchangeAmt" readonly>
                    </td>

                    <th class="">환율</th>
					<td>
						<input type="text" id="exrate" name="exrate" value="1" class="form-control" onkeyup="onlyNumber(this); chechChange();" comma>
					</td>
                    
                </tr>

				<!-- 6행 -->
				<tr>
                    <th class="">계약문서</th>
					<td>
                        <select type="text" id="ctrtDoc" name="ctrtDoc" data-kind="CONTRACTDIV" class="form-control">
                            <option value=""></option>
                        </select>
					</td>

                    <th>국내/해외</th>
                    <td>
                        <select data-kind="INPEXP" id="inpexpCd" name="inpexpCd" class="form-control" style="text-align: center;">
                        </select>
                    </td>
                    
                    <!-- 빈값추가 -->
					<th></th>
					<th></th>
                    <th>차수</th>
                    <td>
                      <input type="text" id="histNo" name="histNo" class="form-control" readonly>
                    </td>
					                    
                </tr>

				<!-- 7행 -->
				<tr>
                    <th>비고</th>
                    <td colspan="5">
                    	<div class="scroll-container">
                        <textarea rows=4 cols=120 wrap="hard" id="ordrsRmk" name="ordrsRmk" class="truncate_multi_post form-control" msg="비고"></textarea>
                        </div>
                        </td><td colspan="2">
                        원가관리표 출력을 위해 글자폭 제한하였으며, 최대 30줄 출력 가능.
                    </td>
                </tr>

            </table>
		</div>
	</form>

	<div class="contents_tit coAuthChk">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※ 수금 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10">
            <!-- <button id="ordrsPlanHis" style="margin-right:10px; display:none;" type="button">수금계획수정이력 </button> -->
<!--             <button id="ordrsPlanUpdate" style="margin-right:10px; display:none;" type="button">수금정보수정</button> -->
			<a id="addPaymentButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deletePaymentButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>

	<!-- 콘텐츠1 -->
	<div class="contents_tit coAuthChk">
		<!-- 리스트 -->
		<div class="ax5_grid">
		
			<div>
				<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"
					style="height: 180px; width: 100%"></div>
			</div>
		</div>
	</div>

	<div id="datailButtonDiv" class="contents_tit">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※ 설비&원가 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10 coAuthChk">
			<a id="addDetailButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deleteDetailButton" style="height: 20px; line-height: 18px">-</a>
            <!-- 엑셀다운로드 버튼 -->
			<a onclick="excelDown1();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
		</div>
	</div>
	<!-- 콘텐츠2-->
	<div id="datailGridDiv" class="contents">
		<!-- 리스트-->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="second-grid-modal" data-ax5grid-config="{}"
					style="height: 300px; width: 100%"></div>
			</div>
		</div>
	</div>
	<div>
	 <tr>
	    <td colspan= 8>
		    <!-- 공유대상자-->
		    <div class="popup_table" id="approval_trgt">               
		        <table style="border:0px;">
		            <tr style="height:30px;">
		              <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
		              <td>
			              <div class="add_btn_small pdl10" id="plus-minus">       
					          <a onclick="insertShareUserModal1();" style="height: 30px; line-height: 28px;" authchk>+</a>
					          <a onclick="deleteShareUser1();" style="height: 30px; line-height: 28px;" authchk>-</a>    
					      </div>
		              </td>
		            </tr>
		            <tr>
		              <td colspan="2">
		               <div>
						 <div class="ax5_grid" data-ax5grid="third-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
					   </div>
					  </td> 
					</tr>  
		        </table>
		    </div> 
		    </td>
		 </tr>
    <br>
    <br>
	</div>
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionOrdrsBtn" class="coAuthChk" authchk>등록</button>

		<button class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
	<!-- 하단여백 영역(버튼영역 확보) -->
	<div>
	<br>
    <br>
	<br>
	<br>
	</div>
</div>

<script type="text/javascript">
    /***********전역변수****************/
    let selectedRowKey;
    let selectedRowKey2;

    var currToday = [];
  	
    var ordrsNo = "";
    var thisGridRow = "";
    var thisGridCol = "";
    var beforeGridSize = 0; //수주상세그리드의 갯수용 그리드컨텐츠 높이조절용
 	// 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
    //수주상세내역의 콤보선택자료 생성임.
  	const comboOdd1 = [...setComboOptionCode('ORDRSDTLDIV10')];
  	const comboOdd2 = [...setComboOptionCode('ORDRSDTLDIV20')];
  	const comboOdd3 = [...setComboOptionCode('ORDRSDTLDIV30')];
  	const comboOdd4 = [...setComboOptionCode('MCTYPE')];
  	const comboItemList = [...setComboOptionCode('ITEMLIST')];
  	const comboClmnPlanDiv = [...setComboOptionCode('CLMNPLANDIV')];

  	let refCode = setRefCode();

    var actionType = modalStack.last().paramObj.actionType;
    var paramObj = modalStack.last().paramObj;

    var deleteFileArr = [];
    var selectedNodeId = "";
    var fileTrgtTyp = "";
    var gridOrdrsDetaildeleteArr = [];  //수주설비&원가 삭제저장용
    
    function setComboOptionCode(selectComobo) {
        var optionCode = [];
        postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : selectComobo} , null, function(data) {
            var codeList = data.childCodeList;
            $.each(codeList, function (index, item) {
                let tempCode = {
                    'CD' : item.codeId,
                    'NM' : item.codeNm
                }
                optionCode.push(tempCode);
            });
        })
        return optionCode;
    }  
    
    function setRefCode() {
        var refCode = '';
        postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : "CO"} , null, function(data) {
            var codeList = data.childCodeList;
            $.each(codeList, function (index, item) {
                if(item.codeId == 'GUN') {
                    refCode = item.codeEtc;
                }
            });
		})
		return refCode;
	}
    
    /***********전역변수****************/
    /* document.ready */
    $(document).ready(function () {
        setCommonSelect($(".popup_area select[data-kind]"));
        fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;

        $("#mngIdNm").val(jwt.userNm);
        $("#mngId").val(jwt.userId);
        
        $('#fwdExchJoinDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        }).datepicker("setDate", new Date());

        $('.input_calendar').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

      	//수주일자//
		$('#ordrsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
        
        const ordrsDiv = document.getElementById('ordrsDiv');
        // const orgnSalesCdTh = document.getElementById('orgnSalesCdTh');
        // const orgnSalesCdTd = document.getElementById('orgnSalesCdTd');
        
        // function toggleOrgnSalesCd() {
        //     if (ordrsDiv.value === 'ORDRSDIV1') {
        //         orgnSalesCdTd.style.display = 'none';
        //         orgnSalesCdTh.style.display = 'none';
        //     } else {
        //         orgnSalesCdTd.style.display = 'none';
        //         orgnSalesCdTh.style.display = 'none';
        //     }
        // }
       
        // ordrsDiv.addEventListener('change', toggleOrgnSalesCd);
        // 페이지 로드 시 초기 상태 설정
        // toggleOrgnSalesCd();
        
        $('#ordrsDiv').on('change', function () {
        	if(actionType == "C" || actionType == "U"){
        		const data = [];
            	if($("#ordrsDiv").val() == "ORDRSDIV3"){
            		$("#ordrsAmtTh").removeClass('hit');
            		$("#currCdTh").removeClass('hit');
            		$('#ordrsAmt').attr('readonly', 'true');
            		$('#ordrsAmt').val("0");
            		$('#exchangeAmt').val("0");
            		
            		gridOrdrsPlan.setData({
        	            list: data,
        	            page: {
        	                totalElements: data.length
        	            }
        	        });
               		gridOrdrsDetail.setData({
        	            list: data,
        	            page: {
        	                totalElements: data.length
        	            }
        	        });
            	}else{
            		$("#ordrsAmtTh").addClass('hit');
            		$("#currCdTh").addClass('hit');
            		$('#ordrsAmt').removeAttr('readonly', 'true');
            	}
        	}
        })
        
        $('#fwdExchChkList').on('change', function () {

        	if($("#fwdExchChkList").val() == "N"){
        		$('#fwdExchJoinDt').val("");
        		$('#fwdExchJoinDt').attr('readonly', 'true');
        		$('#fwdExchJoinDt').hide();
        	}else{
        		$('#fwdExchJoinDt').val($('#ordrsDt').val());
        		$('#fwdExchJoinDt').removeAttr('readonly', 'true');
        		$('#fwdExchJoinDt').show();
        	}

        })

        $("#ordrsAmt").change(function () {
            calclateTotalClmnAmt();
        });
        
        //견적서번호 지울경우 견적차수도 지워지게 처리
        $("#estNoOrdrs").change(function () {
        	var ordNo = $("#estNoOrdrs").val()
        	if (isNaN(ordNo) || ordNo == "") {
        		$("#estDeg").val("");
        	}
        });
        
		//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
//         $('#ordrsPlanUpdate').on("click", function() {
//             ordrsPlanUpdate();
// 		});
        // //선물환기입check리스트 NG일떄 계약문서칸 사용못하게 해야함
        // $("#fwdExchChkList").change(function () {
    	//     var fwdExchChkList = $("#fwdExchChkList").val();
    	//     if(fwdExchChkList == "N"){
    	// 		//내용 삭제 후 비활성화	    	
    	//     	$("#ctrtDoc").val("");
    	//     	$('#ctrtDoc').prop('disabled', true);
    	//     }else{
    	//     	$('#ctrtDoc').prop('disabled', false);
    	//     }
        // });
        
        //gridViewPop7.initView();

      	//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: "CR0202P01",
			fileTrgtKey : fileTrgtKey
		}

		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
		
    });  /* document.ready */

    // 거래처 검색 함수
    function openSecondClntSearch(searchValue) {    	
    	//등록일 경우만 팝업처리
//  		if (actionType == "C") {
			var paramObj = {
                "searchValue" : searchValue,
                "clntDivCd"   : "CLNTDIV12"
            };
	        openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
	            var row = grid.target.getList("selected")[0];

	            $('#ordrsClntCd').val(row.clntCd);
	            $('#ordrsClntNm').val(row.clntNm);
	            
	            //$('#clntPjt').val(row.clntPjt);
	            if ($('#mngId').val() == "") {
		            var paramObj = {
		                "coCd": $('#coCd').val(),
		                "clntCd": row.clntCd
		            }
		            setMngInfo(paramObj);
	        	}
	            $('#newOrdrsNo').val('');
				
	            setDetailButton();

	        });
//  		}
    }

    function openSecondEstSearch(searchValue) {
        var aordrsDiv = $("#ordrsDiv").val();
        
        //등록이거나 수주구분이 정상수주일 경우만 팝업처리
		if (actionType == "C" && (aordrsDiv == "ORDRSDIV1" || aordrsDiv == "ORDRSDIV2")) {
            var paramObj = {
                "searchValue" : searchValue,
                "coCd" : $('#coCd').val()
            };
            // openSecondModal("/static/html/cmn/modal/estSearchWithOrdrs.html", 600, 420, "견적서 검색", {searchValue: searchValue}, function (grid) {
            openSecondModal("/static/html/cmn/modal/estSearch.html", 1200, 420, "견적서 검색", paramObj, function (grid) {
	            var row = grid.target.getList("selected")[0];

	            $('#estNoOrdrs').val(row.estNo);
	            $('#coCd').val(row.coCd);
	            $('#estDeg').val(row.estDeg);
	            $('#currCd').val(row.currCd);
	            $('#ordrsClntCd').val(row.estClntCd);
	            $('#ordrsClntNm').val(row.estClntNm);
	            $('#clntPjt').val(row.clntPjt);
	            $('#ordrsAmt').val(row.estAmt);
	            $('#ctrtNm').val(row.estNm);
	            var paramObj = {
	                "coCd": $('#coCd').val(),
	                "clntCd": row.estClntCd
	            }
	           setMngInfo(paramObj);
	        });
		}
            //수정시 견적서 연결할때 견적서번호&&견척차수만 세팅(11/28 요청사항)
            else if (actionType == "U" && (aordrsDiv == "ORDRSDIV1" || aordrsDiv == "ORDRSDIV2")){
            	var paramObj = {
                        "searchValue" : searchValue,
                        "coCd" : $('#coCd').val()
                    };
                    // openSecondModal("/static/html/cmn/modal/estSearchWithOrdrs.html", 600, 420, "견적서 검색", {searchValue: searchValue}, function (grid) {
                    openSecondModal("/static/html/cmn/modal/estSearch.html", 1200, 420, "견적서 검색", paramObj, function (grid) {
        	            var row = grid.target.getList("selected")[0];

        	            $('#estNoOrdrs').val(row.estNo);
         	            $('#estDeg').val(row.estDeg);   //견적차수
        	        });
            }
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {
                $('#mngId').val(data.mngInfo.salesEmpId);
                $('#mngIdNm').val(data.mngInfo.salesEmpNm);
            } else {
                // $('#mngId').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch() {
    	//등록일 경우만 팝업처리
		if (actionType == "C") {
	        var paramObj = {
	            "coCd"   : $('#coCd').val(),
	            "userId" : $('#salesEmpId').val(),
	            "userNm" : $('#salesEmpNm').val(),
	            "useYn"  : "Y"
	        };
	
	        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
	            var checkedId = tree.get_checked()[0];
	            var checkedNode = tree.get_node(checkedId);
	            $("#salesEmpId").val(checkedNode.id);
	            $("#salesEmpNm").val(checkedNode.text);
	        });
		}
    }
    
    // 폼 데이터 생성 함수
    function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#exrate,#ordrsAmt'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });
        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);
        formData.append("ordrsNo", $("#ordrsNo").val());
        // 유저아이디 추가
        // formData.append("userId", jwt.userId);
        
        //---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#ordrsClntCd').val());			//첨부화일용
		formData.append("prdtCd" , $('#prdtCd').val(""));			//첨부화일용
		formData.append("itemCd" , $('#itemDiv').val(""));			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------

        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                formData.append(elem, JSON.elem.value);
            });
        });     
        
        var rowListPlan = gridOrdrsPlan.getList();
        var rowListDetail = gridOrdrsDetail.getList();

        var planArr = [];
        var detailArr = [];
        let clmnDtCnt = 0;
        let clmnAmtCnt = 0;
        
        if($("#ordrsDiv").val() == "ORDRSDIV3" || $("#ordrsDiv").val() == "ORDRSDIV9"){ //무상AS start, 가수주건
        } else {
            //수금내역
            if (rowListPlan.length == 0) {
                commaChange();
                alert("수금내역을 확인해 주세요?");
                return false;
            }
            
            $.each(rowListPlan, function (idx, elem) {
                var planObj = {};
                
                planObj["clmnPlanSeq"] = idx + 1;
                planObj["clmnPlanDiv"] = elem.clmnPlanDiv;
                planObj["clmnDivSeq"] = elem.clmnDivSeq;
                planObj["clmnRate"] = elem.clmnRate;
                // planObj["clmnAmt"] = pasIntChk(elem.clmnAmt.replace(/,/g, ''));
                planObj["clmnAmt"] = elem.clmnAmt;

                let clmnDt = new Date(elem.clmnDt);
                
                if(isNaN(clmnDt)) {
                    clmnDtCnt++;
                }
                
                let pmntDtAfterBill = pasIntChk(elem.pmntDtAfterBill, 10); // 문자열을 숫자로 변환
                // clmnDt에서 pmntDtAfterBill를 뺍니다.
                clmnDt.setDate(clmnDt.getDate() - pmntDtAfterBill);
                
                // Date 객체를 YYYY-MM-DD 형식의 문자열로 변환
                let convertDateToString = function (dateObj) {
                    let month = '' + (dateObj.getMonth() + 1),
                    day = '' + dateObj.getDate(),
                    year = dateObj.getFullYear();
                    
                    if (month.length < 2)
                    month = '0' + month;
                    
                    if (day.length < 2)
                    day = '0' + day;
                    
                    return [year, month, day].join('-');
                };
                
                if(elem.clmnAmt == 0) {
                	clmnAmtCnt++;
                }
                
                // 계산된 날짜를 billPblsDt에 할당 일자없으면 null로 세팅
                if(isNaN(pmntDtAfterBill)) {
                    planObj["billPblsDt"] = "";
                    planObj["pmntDtAfterBill"] = "";
                } else {
                    planObj["billPblsDt"] = convertDateToString(clmnDt);
                    planObj["pmntDtAfterBill"] = pmntDtAfterBill;
                }
                planObj["clmnDt"] = elem.clmnDt;
                planObj["clmnMgmtStatus"] = elem.clmnMgmtStatus;
                
                planArr.push(planObj);
            });
			
            //수금정보 입력 자료 중복 체크 (수금구분과  차수가 중복확인)
            const chkValues = new Set();
            for (const obj of rowListPlan) {
            	let chkValue = obj.clmnPlanDiv + obj.clmnDivSeq; //수금구분 || 수금차수 중복 체크를 확인용
                if (chkValues.has(chkValue)) {
                    alert("수금구분과 차수가 중복됩니다. 확인바랍니다.");
                    return false; 
                }
                chkValues.add(chkValue);
            }
            
            if(clmnAmtCnt > 0) {
                commaChange();
                alert("수금계획 금액이 없습니다!");
                return false;
            } else if(clmnDtCnt > 0) {
                commaChange();
                alert("수금예정일자가 없습니다.");
                return false;
            }
            
            // clmnAmt 합계 계산
            var totalClmnAmt = 0;
            
            $.each(planArr, function (idx, elem) {
                totalClmnAmt += pasFloatChk(elem.clmnAmt);
            });
            
            // input box 값과 비교
            var inputAmtVal = pasFloatChk($("#ordrsAmt").val());
            
            if (totalClmnAmt != inputAmtVal) {
                if($("#ordrsDiv").val() != "ORDRSDIV3" && $("#ordrsDiv").val() != "ORDRSDIV9" ) {
                    commaChange();
                    alert("수주금액과 수금계획금액 합계가 일치하지 않습니다.");
                    return false;
                }
            }
        }
        //무상AS end
        
        if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) { //투루넷,건양 start
        } else {
            //설비&원가 정보
            if (rowListDetail.length == 0) {
            	commaChange();
                alert("주문 세부 내역이 없습니다.");
                return false;
            }

            var totalLaborCostMfgCost = 0;
            var totalMachineValueAfterDeduction = 0;
            let orgnSalesCdCnt = 0;

            // clmnAmt 합계 계산
            var totalClmnAmt = 0;
            let eqpNmChk = false;
            
            $.each(rowListDetail, function (idx, elem) {
                var detailObj = {
                    "ordrsSeq"				: elem.ordrsSeq,
                    "cudCheck"				: elem.cudCheck,
                    "devDiv"				: elem.devDiv,
                    "ordrsDtlDiv10"			: elem.ordrsDtlDiv10,
                    "ordrsDtlDiv20"			: elem.ordrsDtlDiv20,
                    "ordrsDtlDiv30"			: elem.ordrsDtlDiv30,
                    "orgnSalesCd"			: elem.orgnSalesCd,
                    "mctype"				: elem.mctype,
                    "prdtCd"				: elem.prdtCd,
                    "itemDiv"				: elem.itemDiv,
                    "salesCd"				: elem.salesCd || '',
                    "eqpNm"					: elem.eqpNm,
                    "dudtIntendDt"			: elem.dudtIntendDt,
                    "dtlRmk"				: elem.dtlRmk,
                    "ordrsPrcMach"			: pasIntChk(elem.ordrsPrcMach),
                    "ordrsPrcElcty"			: pasIntChk(elem.ordrsPrcElcty),
                    "ordrsPrc"				: pasIntChk(elem.ordrsPrcMach) + pasIntChk(elem.ordrsPrcElcty),
                    "ordrsQty"				: pasIntChk(elem.ordrsQty),
                    "estEpctMatPrc"			: pasIntChk(elem.estEpctMatPrc),
                    "trgtPchsPcostMach"		: pasIntChk(elem.trgtPchsPcostMach),
                    "trgtPchsPcostElcty"	: pasIntChk(elem.trgtPchsPcostElcty),
                    "trgtPchsPcostInHousePrcsn": pasIntChk(elem.trgtPchsPcostInHousePrcsn),
                    "machineValueAfterDeduction": pasIntChk(elem.trgtPchsPcostMach) - pasIntChk(elem.trgtPchsPcostInHousePrcsn),
                    "outtkClntNm"			: elem.outtkClntNm,
                    "estTrgtCost"			:  pasIntChk(elem.estTrgtCost)
                };
                
                let orgnSalesCode = elem.orgnSalesCd;
                let ordrsDtlDiv20 = elem.ordrsDtlDiv20;
                let ordrsDtlDiv30 = elem.ordrsDtlDiv30;
                let mctype = elem.mctype;
                let prdtCd = elem.prdtCd;
                let itemDiv = elem.itemDiv;
                let eqpNm = elem.eqpNm;
                
                if(orgnSalesCode == '' || orgnSalesCode == undefined) { //원천SalesCd
                    detailObj["orgnSalesCd"] = "";
                }

     			if(ordrsDtlDiv20 == '' || ordrsDtlDiv20 == undefined) { //수주설비 작업구분
                    detailObj["ordrsDtlDiv20"] = "";
                }

     			if(ordrsDtlDiv30 == '' || ordrsDtlDiv30 == undefined) { //수주설비 자체구분
                    detailObj["ordrsDtlDiv30"] = "";
                }

     			if(mctype == '' || mctype == undefined) { //수주설비 기계구분
                    detailObj["mctype"] = "";
                }

     			if(prdtCd == '' || prdtCd == undefined) { //제품구분
                    detailObj["prdtCd"] = "";
                }
                
                if(itemDiv == '' || itemDiv == undefined) { //아이템구분
                    detailObj["itemDiv"] = "";
                }
                
                if(eqpNm == '' || eqpNm == undefined) {  //설비명
                    detailObj["eqpNm"] = "";
                    eqpNmChk = true;
                }
                
                var laborCostMfgCost = pasIntChk(elem.laborCostMfgCost); //노무비 제조걍비
                var machineValueAfterDeduction = pasIntChk(detailObj["machineValueAfterDeduction"]); //

                detailObj["laborCostMfgCost"] = laborCostMfgCost; //노무비 제조걍비
                detailObj["machineValueAfterDeduction"] = machineValueAfterDeduction;

                totalLaborCostMfgCost += laborCostMfgCost; //노무비 제조걍비
                totalMachineValueAfterDeduction += machineValueAfterDeduction;
                
                totalClmnAmt += pasFloatChk(elem.ordrsPrcMach);
                totalClmnAmt += pasFloatChk(elem.ordrsPrcElcty);
                
                detailArr.push(detailObj);  //설비정보
            });
            
            if(eqpNmChk) {
                alert("설비명은 필수 입력입니다.");
                return false;
            }
            
            // if(orgnSalesCdCnt > 0) {
            //     commaChange();
            //     alert("원천SalesCode가 없습니다.");
            //     return false;
            // }
            

            // input box 값과 비교
            // var inputAmtVal = pasIntChk($("#ordrsAmt").val());
            var inputAmtVal = pasIntChk($("#exchangeAmt").val());
            if (totalClmnAmt != inputAmtVal) {
            	if($("#ordrsDiv").val() != "ORDRSDIV3" && $("#ordrsDiv").val() != "ORDRSDIV9" ) {
                    commaChange();
                    alert("수주금액과 수주가합계가 일치하지 않습니다.");
                    return false;
            	}
            }
            
            var totalSum = totalLaborCostMfgCost + totalMachineValueAfterDeduction; //laborCostMfgCost(금액)+machineVVauleAfterDeduction(차감 후 기계값)
            var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
        
        }
        //투루넷,건양 end
        formData.append("planArr", JSON.stringify(planArr));				//수금내역
        formData.append("detailArr", JSON.stringify(detailArr)); 			//설비정보
		formData.append("gridOrdrsDetaildeleteArr", JSON.stringify(gridOrdrsDetaildeleteArr)); //설비삭제내역
        
        // 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가 (박성준 : 2023.08.03) 
        // 공유 : TODODIV10, TODODIV1040  결재 :TODODIV20, TODODIV2020
         var rowSharngList = gridViewPop7.target.list;
         var ParamObj = modalStack.last().paramObj.ParamObj;

         if(rowSharngList.length > 0) {
             var rowSharngListArr = []; //공유정보
             var rowApprovalListArr = []; //결재정보
             $.each(rowSharngList, function(idx, elem){
                 var rowSharngListObj = elem;
                 var rowApprovalListObj = elem;

                 if (elem.gb == '공유'){
                     rowSharngListObj["gb"] = elem.gb;
                     rowSharngListObj["coCd"] = $('#coCd').val();
                     //rowSharngListObj["salesCd"] = $('#salesCd').val();
                     rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
                     rowSharngListObj["todoDiv2CodeId"] = "TODODIV1100";
                     rowSharngListObj["todoId"] = elem.usrNm;
                     rowSharngListObj["todoCoCd"] = elem.coCd;
                     rowSharngListObj["empNo"] = elem.empNo;
                     rowSharngListObj["name"] = elem.name;
                     rowSharngListObj["telNo"] = elem.telNo;
                     rowSharngListObj["email"] = elem.eMail;    
                     rowSharngListObj["pgPath"] = "/user/cr/cr02/CR0202P02.html";
                   //TITLE 추가
                     rowSharngListObj['todoTitle'] = $("#ordrsClntNm").val() + ', ' + document.getElementById("clntPjt").options[clntPjt.selectedIndex].text + ' 공유 ';
                     rowSharngListArr.push(rowSharngListObj);

                 }
                 else if (elem.gb == '결재'){
                    rowApprovalListObj["gb"] = elem.gb;
                    rowApprovalListObj["coCd"] = $('#coCd').val();
                  	//rowApprovalListObj["salesCd"] = $('#salesCd').val();
                  	rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
                  	rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2100";
                  	rowApprovalListObj["todoId"] = elem.usrNm;
                  	rowApprovalListObj["todoCoCd"] = elem.coCd;
                  	rowApprovalListObj["empNo"] = elem.empNo;
                  	rowApprovalListObj["name"] = elem.name;
                  	rowApprovalListObj["telNo"] = elem.telNo;
                  	rowApprovalListObj["email"] = elem.eMail;    
                  	rowApprovalListObj["pgPath"] = "/user/cr/cr02/CR0202P02.html";
                //TITLE 추가
                  rowApprovalListObj['todoTitle'] = $("#ordrsClntNm").val() + ', ' + document.getElementById("clntPjt").options[clntPjt.selectedIndex].text + ' 결재 ';
                  rowApprovalListArr.push(rowApprovalListObj);
                 }

                 
             });
             
             formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
             formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
         }
         formData.append("S_todoDiv1CodeId", "TODODIV10");
         formData.append("S_todoDiv2CodeId", "TODODIV1100");
        
        return formData;
    }
    
    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#estCoprt').data("rprc", value);
        chechChange();
        $('#estCoprt option:not([value=""])').remove()
        setCommonSelect($('#estCoprt'));
    }
    
    /* 그리드 관련 함수 */
    // 그리드 생성
    const gridOrdrsPlan = new ax5.ui.grid();
    
    gridOrdrsPlan.setConfig({
        target : $('[data-ax5grid="first-grid-modal"]'),
        header: {
            align: "center",
            selector: false
        },
        columns: [
            {key: "seq", label: "번호", width: 40, align: "center", formatter: function () {return this.item.__index + 1;},},
            { key: "clmnPlanDiv",   label: "수금구분", align: "center",  width: 70,
                editor: {
                    type: 'select', config: {
                        columnKeys: { optionValue: 'CD', optionText: 'NM' },
                        options : comboClmnPlanDiv
                    }
                },
                formatter : function() {
                    return getComboName(comboClmnPlanDiv, this)
                }
            },
            {key: "clmnDivSeq", label: "차수", width: 50, align: "center", editor: {type: "text"}},
            {key: "clmnRate", label: "비율", width: 50, align: "center", editor: {type: "number"}},
            {key: "clmnAmt",label: "수금계획금액", width: 110, align: "right", editor: {type: "number"}, formatter: "money"},
            {key: "clmnDt", label: "수금예정일자", width: 100, align: "center",
                editor: {
                    type: "date", config: {
                        content: {
                            config: { mode: "day", selectMode: "day" }
                        }
                    }
                }
            },
            {key: "pmntDtAfterBill", label: "계산서 발행 후 지급시기(단위: 일)", width: 180, align: "center", editor: {type: "number"}},
            {key: "billPblsDt", label: "계산서발행예정일", width: 100, align: "center",
                editor: {
                    type: "date", config: {
                        content: {
                            config: { mode: "day", selectMode: "day" }
                        }
                    }
                },
                formatter: function () {
                    var clmnDt = new Date(this.item.clmnDt || new Date());
                    clmnDt.setDate(clmnDt.getDate() - (this.item.pmntDtAfterBill || 0));
                    var month = String(clmnDt.getMonth() + 1).padStart(2, '0');
                    var day = String(clmnDt.getDate()).padStart(2, '0');
                    var year = clmnDt.getFullYear();
                    
                    return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
                }
            },
            {key: "매출확정합계", label: "매출확정금액", width: 120, align: "right", formatter: "money", styleClass: function () {
                return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.매출확정합계)) ? "grid-font-red" : "grid-font-blue";}
            },
            {key: "세금계산서합계", label: "계산서발행금액", width: 120, align: "right", formatter: "money", styleClass: function () {
                return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.세금계산서합계)) ? "grid-font-red" : "grid-font-blue";}
            },
            {key: "수금합계", label: "수금금액", width: 120, align: "right", formatter: "money", styleClass: function () {
                return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.수금합계)) ? "grid-font-red" : "grid-font-blue";}
            },
            {key: "zzzz", label: "미수잔액", width: 120, align: "right",
                formatter: function () {
                    return addCommaStr(pasFloatChk(this.item.clmnAmt) - pasFloatChk(this.item.수금합계));
                },
                styleClass: function () {
                    return "grid-font-blue";
                }
            },
            {key: "clmnMgmtStatus", label: "수금관리상황", width: 370, align: "left", editor: {type: "text"}},
        ],
        footSum: [
            [
                {label: "수금합계", align: "center", colspan: 3},
                {key: "clmnRate", collector: "sum", formatter: "money", align: "right"},
                {key: "clmnAmt", collector: "sum", formatter: "money", align: "right"},
                {colspan: 3},
                {key: "매출확정합계", collector: "sum", formatter: "money", align: "right"},
                {key: "세금계산서합계", collector: "sum", formatter: "money", align: "right"},
                {key: "수금합계", collector: "sum", formatter: "money", align: "right"},
                {key: "zzzz", collector:
                    function () {
                        var value = 0;
                        this.list.forEach(function (n) {
                            if (!n.__isGrouping) value += (pasFloatChk(n.clmnAmt) - pasFloatChk(n.수금합계));
                        });
                        return addCommaStr(value);
                    },
                    formatter: "money", align: "right"
                },
            ]
        ],
        page : {
            display: false,
        },
        body: {
            onClick: function () {
                this.self.clearSelect();
                this.self.select(this.dindex);
                selectedRowKey = this.dindex;
            },
            onDataChanged: function () {
                if( this.key == "clmnAmt" || this.key == "clmnRate" ) {
                    const ordrsAmt = pasFloatChk($("#ordrsAmt").val());
                    
                    if( this.key == "clmnAmt" ) {
                        const clmnAmt = pasFloatChk(this.value);
                        this.value = clmnAmt;
                        
                        if (!isNaN(clmnAmt) && !isNaN(ordrsAmt)) {
                            // this.item.clmnRate = ordrsAmt !== 0 ? pasFloatChk((clmnAmt / ordrsAmt * 100 + 0.5) ) : 0;
                            this.item.clmnRate = ordrsAmt !== 0 ? pasFloatChk((clmnAmt / ordrsAmt * 100) ) : 0;
                        }
                    }

                    if( this.key == "clmnRate" ) {
                        const clmnRate = pasIntChk(this.value);
                        this.value = clmnRate;
                        
                        if (!isNaN(clmnRate) && !isNaN(ordrsAmt)) {
                            // this.item.clmnAmt = pasFloatChk(clmnRate * ordrsAmt / 100 + 0.5);
                            this.item.clmnAmt = pasFloatChk(clmnRate * ordrsAmt / 100);
                        }
                    }

                    var data = gridOrdrsPlan.getList();
                    var totalRate = 0;
                    var totalAmt = 0;
                    
                    for (var i = 0; i < data.length; i++) {
                        totalRate += pasIntChk(data[i].clmnRate);
                        totalAmt += pasFloatChk(data[i].clmnAmt);
                    }
                    
                    if (totalRate > 100) {
                        alert('비율의 합계는 100%를 초과할 수 없습니다.');
                    }
                    
                    if (totalAmt > ordrsAmt) {
                        alert('수금금액의 합계는 주문 금액을 초과할 수 없습니다.');
                    }
                }
                gridOrdrsPlan.repaint();
                
                //수주자료 수정모드가 아닐경우 수금정보 수정시 수금정보 저장버튼 활성화 시킴
                //2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
//                 if ($('#actionOrdrsBtn').is(':hidden')) {
//                     $('#ordrsPlanUpdate').show();
//                 }
            }
        },
        contextMenu: {
            iconWidth: 20,
            acceleratorWidth: 100,
            itemClickAndClose: false,
            icons: {
                'arrow': '<i class="fa fa-caret-right"></i>'
            },
            items: [
                {type: 1, label: "붙여넣기"},
                {divide: true},
                {type: 1, label: "줄추가"},
                {type: 1, label: "내용 삭제"},
                {type: 2, label: "줄삭제"},
            ],
            popupFilter: function (item, param) {
                //console.log(item, param);
                if (param.element) {
                    return true;
                } else {
                    return item.type == 1;
                }
            },
            onClick: function (item, param) {
                // console.log(item, param);
                thisGridRow = param.dindex;
                thisGridCol = param.colIndex;
                if (item.label == "붙여넣기") {
                    gridPaste(gridOrdrsPlan, thisGridRow, thisGridCol, "PLAN");
                } else if (item.label == "줄추가") {
                    // console.log('추가 인덱스 :', param.dindex);
                    //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                    let newRow = gridOrdrsPlan.list[param.dindex];
                    gridOrdrsPlan.addRow($.extend({}, newRow, {__index: undefined}), param.dindex + 1,);
                } else if (item.label == "내용 삭제") {
                    // console.log('내용삭제 인덱스 :', param.dindex);
                    gridOrdrsPlan.config.columns.forEach((column) => {
                        gridOrdrsPlan.setValue(param.dindex, column.key, '');
                        // console.log('내용삭제 :', param.dindex, column.key);
                    });
                } else if (item.label == "줄삭제") {
                    // console.log('삭제 인덱스 :', param.dindex);
                    gridOrdrsPlan.removeRow(param.dindex);
                }
                //결재완료후 수금내역 수정시 수정 버튼 활성화 하기
                //2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
//                 if ($('#actionOrdrsBtn').is(':hidden')) {
//                     $('#ordrsPlanUpdate').show();
//                 }
                gridOrdrsPlan.contextMenu.close();
            }
        },
    });
    
    function calclateTotalClmnAmt () {
        var ordrsAmt = pasIntChk($("#ordrsAmt").val());
        var data = gridOrdrsPlan.getList();
        var totClmnAmt = 0; 
        for (var i = 0; i < data.length; i++) {
            data[i].clmnAmt = pasIntChk(ordrsAmt * pasIntChk(data[i].clmnRate) / 100 + 0.5); 
            totClmnAmt += data[i].clmnAmt; 
        }
        if (data.length > 0){
            data[data.length-1].clmnAmt += ordrsAmt - totClmnAmt; //오더금액과 수금금액 차이는 마지막 수금에 포함 처리
        }

        gridOrdrsPlan.setData(data);
    } 
    
    //Select 선택 코드값 체크하여 명을 출력
    function getComboName(comboArray, key) {
	    let rtnNm = "";
	    for (const element of comboArray) {
            if (key.value == element.CD) {
                rtnNm = element.NM;
                break;
            }
        }
        return rtnNm;
    }
    
    const gridOrdrsDetail = new ax5.ui.grid();
    
    gridOrdrsDetail.setConfig({
        multipleSelect: false,
        target : $('[data-ax5grid="second-grid-modal"]'),
        header: {
            align: "center",
            selector: false
        },
        // frozenColumnIndex: 8,
        columns: [
        	{key: "cudCheck",    label: "입력,삭제체크용", align: "left", width: 120, hidden: true},
            {key: "seq", 			label: "No", 		width: 40, align: "center", formatter: function () { return this.item.__index + 1; }},
            {key: "ordrsDtlDiv10", 	label: "입력구분", 	width: 60, align: "center", editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboOdd1
                  } }, formatter : function()  {return getComboName(comboOdd1, this)}},
           {key: "devDiv", 	label: "개발", 	align: "center", width: 40, editor: { type: 'select',
               config: {
                   columnKeys: { optionValue: 'CD', optionText: 'NM' },
                   options : [
                	   {CD: "", NM: ""},
                	   {CD: "D", NM: "D"}
                   		]
                 	} 
           		}
            },
            {key: "ordrsSeq",	label: "ordrsSeq", 	align: "center", width: 50, hidden: true},
            {key: "orgnSalesCd",	label: "원천SalesCode", 	align: "center", width: 110},
            {key: "prdtCd", 		label: "제품구분", 	align: "center", width: 60},
            {key: "itemDiv", 		label: "아이템구분", 	align: "center", width: 80, editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboItemList
                  } }, formatter : function()  {return getComboName(comboItemList, this)}},
            {key: "ordrsDtlDiv20", 	label: "작업구분", 	align: "center", width: 60, editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboOdd2
                  } }, formatter : function()  {return getComboName(comboOdd2, this)}},
            {key: "ordrsDtlDiv30", 	label: "자체구분", 	align: "center", width: 60, editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboOdd3
                  } }, formatter : function()  {return getComboName(comboOdd3, this)}},
            {key: "mctype", 	label: "기계구분", 	align: "center", width: 60, editor: { type: 'select',
               config: {
                   columnKeys: { optionValue: 'CD', optionText: 'NM' },
                   options : comboOdd4
                 } }, formatter : function()  {return getComboName(comboOdd4, this)}},
            {key: "dataChk", 		label: "비활성화체크",	align: "center", width: 40, hidden: true},
            {key: "salesCd", 	 label: "sales Code", 	align: "center", width: 120},
            {key: "eqpNm", 			label: "설비명", 		align: "center", width: 255, editor: {type: "text"}},
            {key: "dudtIntendDt",   label: "납기예정일", width: 100, align: "center", editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" } } }},
                formatter: function () {
                	//기존 데이터 있으면
					if(this.item.dudtIntendDt){
		                var dudtIntendDt = new Date(this.item.dudtIntendDt);
	                    var month = String(dudtIntendDt.getMonth() + 1).padStart(2, '0');
	                    var day = String(dudtIntendDt.getDate()).padStart(2, '0');
	                    var year = dudtIntendDt.getFullYear();
	                    return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
					}else{
					//기존 데이터 없으면				
						if(actionType == "C"){//등록시 오늘날짜 기본으로
							var dudtIntendDt = new Date();
		                    var month = String(dudtIntendDt.getMonth() + 1).padStart(2, '0');
		                    var day = String(dudtIntendDt.getDate()).padStart(2, '0');
		                    var year = dudtIntendDt.getFullYear();
		                    return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
						}else{//수정시는 없는 건 없는 것
							return null;
						}
					}
                }
            },
            {key: "estTrgtCost", 	label: "수주목표가",align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
            {key: undefined, 		label: "수주가", columns: [
                    {key: "ordrsPrcMach", label: "기계PART", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                    {key: "ordrsPrcElcty", label: "전기PART", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                    {key: "ordrsPrc", label: "합계", align: "right", width: 80,
                        formatter: function () {return addCommaStr(pasIntChk(this.item.ordrsPrcMach) + pasIntChk(this.item.ordrsPrcElcty));}, 
                        styleClass: function () {return "grid-font-blue";} },
                ]},
            {key: "ordrsQty", label: "수량", align: "right", width: 40, editor: {type: "number"}},
            {key: "estEpctMatPrc", label: "견적 예상 재료비",align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
            {key: undefined, label: "목표구매원가", columns: [
                    {key: undefined, label: "목표구매원가", columns: [
                        	{ key: "trgtPchsPcostMach", label: "기계", align: "right", width: 90, editor: {type: "number"}, formatter: "money"},
                            { key: "trgtPchsPcostElcty", label: "전기", align: "right", width: 90, editor: {type: "number"} , formatter: "money"},
                            { key: "trgtsum", label: "합계", align: "right", width: 100,
                                formatter: function () {return addCommaStr(pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty));}, 
                                styleClass: function () {return "grid-font-blue";}, },
                        ] },
                    {key: undefined, label: "자체가공 투입시 기계부문 목표원가", columns: [
                            {key: "trgtPchsPcostInHousePrcsn", label: "자체 가공", align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
                            {key: "machineValueAfterDeduction", label: "차감 후 기계값", align: "right", width: 100, formatter: function () {return addCommaStr(pasIntChk(this.item.trgtPchsPcostMach) - this.item.trgtPchsPcostInHousePrcsn);}, 
                                styleClass: function () {return "grid-font-blue";},},
                        ]}
                ]
            },

//             {key: undefined, label: "실집행 원가", columns: [
//                     {key: undefined, label: "노무비 및 제조경비(판관비 제외)", columns: [
//                             {key: "laborCostMfgCost", label: "금액", align: "right", width: 130, editor: {type: "number"}, formatter: "money" },
//                         ]}
//                 ]},
            {key: "outtkClntNm", label: "외주턴키", align: "left", width: 120, editor: {type: "text"}},
        	{key: "dtlRmk",      label: "비고", align: "left", width: 120, editor: {type: "text"}},
        ],
        footSum: [
                  [
                      {label: "총합계", align: "center", colspan: 12},
                      {key: "estTrgtCost", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrcMach", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrcElcty", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrc", collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.ordrsPrcMach) + pasIntChk(n.ordrsPrcElcty));
                            });
                            return addCommaStr(value);
                        },  align: "right"},
                      {key: "ordrsQty", collector: "sum", formatter: "money", align: "right"},
                      {key: "estEpctMatPrc", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtPchsPcostMach", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtPchsPcostElcty", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtsum",  collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.trgtPchsPcostMach) + pasIntChk(n.trgtPchsPcostElcty));
                            });
                            return addCommaStr(value);
                        },  align: "right"},
                      {key: "trgtPchsPcostInHousePrcsn", collector: "sum", formatter: "money", align: "right"},
                      {key: "machineValueAfterDeduction", collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.trgtPchsPcostMach) - pasIntChk(n.trgtPchsPcostInHousePrcsn));
                            });
                            return addCommaStr(value);
                        }, align: "right"},
//                       {key: "laborCostMfgCost", collector: "sum", formatter: "money", align: "right"},
                  ]
        ],
        body: {
            onClick: function () {
                this.self.select(this.dindex);
                thisGridRow = this.dindex;
                thisGridCol = this.colIndex;
                selectedRowKey2 = this.dindex;
               
                // 제품구분(prdtCd)이거나 등록일 경우에만 실행하도록
                if (this.column.key == 'prdtCd' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010') {
                // if (this.column.key == 'prdtCd' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010' && this.item.dataChk != 'U') {
                // if (this.column.key == 'prdtCd' && actionType == 'C' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010' && this.item.dataChk != 'U') {
                    openSecondPrdtSearch();       
                }

                if (this.column.key == 'orgnSalesCd') {
//                	if($('#ordrsDiv').val() == "ORDRSDIV1"){
//                		gridOrdrsDetail.setValue(this.dindex, "orgnSalesCd", "");
//                		return;
//                	}
                    openSalesCdSearch();
                }

            },
            columnHeight: 26,
            onDataChanged: function () {
            	var row = this.dindex;
			    var col = this.colIndex;
			    if (this.item.cudCheck !='C') {  //추가일경우
                	this.item.cudCheck = "U";   //추가, 수정, 삭제구분
			    }
			    switch (this.key) {
			        case 'ordrsPrcMach':
			        	this.item.ordrsPrcMach = pasIntChk(this.value);
			            // this.item.ordrsPrc = pasIntChk(this.item.ordrsPrcMach + this.item.ordrsPrcElcty); 
			            gridOrdrsDetail.setValue(row, "ordrsPrc", pasIntChk(this.item.ordrsPrcMach) + pasIntChk(this.item.ordrsPrcElcty));
			            break;
			        case 'ordrsPrcElcty':
			        	this.item.ordrsPrcElcty = pasIntChk(this.value);
			            this.item.ordrsPrc = pasIntChk(this.item.ordrsPrcMac) + pasIntChk(this.item.ordrsPrcElcty);
			            break;
			        case 'trgtPchsPcostMach':
			        	this.item.trgtPchsPcostMach = pasIntChk(this.value);
			            this.item.sum = pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty);
			            break;
			        case 'trgtPchsPcostElcty':
			        	this.item.trgtPchsPcostElcty = pasIntChk(this.value);
			            this.item.sum = pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty);
			            break;
			        case 'trgtPchsPcostInHousePrcsn':
			        	this.item.trgtPchsPcostInHousePrcsn = pasIntChk(this.value);
			            this.item.machineValueAfterDeduction = pasIntChk(this.item.trgtPchsPcostMach) - pasIntChk(this.item.trgtPchsPcostInHousePrcsn);
			            break;
			        case 'trgtPchsPcostElcty':
			        	this.item.trgtPchsPcostElcty = pasIntChk(this.value);
			            break;
			        case 'ordrsQty':
			        	this.item.ordrsQty = pasIntChk(this.value);
			            break;
			        case 'estEpctMatPrc':
			        	this.item.estEpctMatPrc = pasIntChk(this.value);
			            break;
			        case 'laborCostMfgCost':
			        	this.item.laborCostMfgCost = pasIntChk(this.value);
			            break;
			        case 'estTrgtCost':
			        	this.item.estTrgtCost = pasIntChk(this.value);
			            break;
			    }
                
                //입력구분이고 해당 값이 저게 아닐때 해당셀을 빈값으로 세팅
//                if (this.key == 'ordrsDtlDiv10' && this.item.ordrsDtlDiv10 != 'ORDRSDTLDIV1010') {
                if (this.key == 'ordrsDtlDiv10') {
                    gridOrdrsDetail.setValue(row, 'orgnSalesCd', "");
                    gridOrdrsDetail.setValue(row, 'prdtCd', "");
                	gridOrdrsDetail.setValue(row, 'itemDiv', "");
                	gridOrdrsDetail.setValue(row, 'ordrsDtlDiv20', "");
                	gridOrdrsDetail.setValue(row, 'ordrsDtlDiv30', "");
                	gridOrdrsDetail.setValue(row, 'mctype', "");
//                 	gridOrdrsDetail.setValue(row, 'eqpNm', "");
                	gridOrdrsDetail.setValue(row, 'salesCd', "");
                }
                
                var currEndRow = currGridEndRow();
                // gridOrdrsDetail.repaint(); 
                
			    // if (beforeGridSize != gridOrdrsDetail.list.length) {
                    //row focus 처리용
                    // var gridStatus = $('.popup_area [data-ax5grid="second-grid-modal"] [data-ax5grid-page="status"]').text().trim();
                    // var gridStatusIdx = gridStatus.indexOf(' ');
                    // var topRow = gridStatus.slice(0, gridStatusIdx).trim();
                    // gridOrdrsDetail.focus(topRow);  
                    // console.log(topRow, row);

                    
                    // const data = gridOrdrsDetail.getList();
                    // gridOrdrsDetail.setData(data);
                    // gridResize(gridOrdrsDetail.list.length); //그리드 높이 조정
                    // beforeGridSize = gridOrdrsDetail.list.length;
                    // gridOrdrsDetail.focus(row);  
                     
                    resetGridFocus(currEndRow, thisGridRow);
			    // }
                gridOrdrsDetail.repaint();
            }
        },
        contextMenu: {
            iconWidth: 20,
            acceleratorWidth: 100,
            itemClickAndClose: false,
            icons:
                {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
            items: [
                {type: 1, label: "붙여넣기"},
                {divide: true},
                {type: 1, label: "줄추가"},
                {type: 1, label: "내용 삭제"},
                {type: 2, label: "줄삭제"},
            ],
            popupFilter:

                function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
            onClick: function (item, param) {
  
                thisGridRow = param.dindex;
                thisGridCol = param.colIndex;

                if (item.label == "붙여넣기") {
                    gridPaste(gridOrdrsDetail, thisGridRow, thisGridCol);
                } else if (item.label == "줄추가") {
                    // console.log('추가 인덱스 :', param.dindex);
                    //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                    let newRow =   {...gridOrdrsDetail.list[param.dindex]};
                    newRow.salesCd = "";
                    newRow.cudCheck = "C";
                    newRow.ordrsSeq = "0"; //추가후 삭제할 경우를 대비 반드시ordrsSeq= 0으로 채울것
                    gridOrdrsDetail.addRow($.extend({}, newRow, {__index: undefined}), param.dindex + 1,);
                    gridOrdrsDetail.focus(param.dindex + 1);

                } else if (item.label == "내용 삭제") {
                    // console.log('내용삭제 인덱스 :', param.dindex)
                    // gridOrdrsDetail.config.columns.forEach((column) => {
                    gridOrdrsDetail.colGroup.forEach((column) => {
                        gridOrdrsDetail.setValue(param.dindex, column.key, '');
                        gridOrdrsDetail.setValue(param.dindex, "cudCheck", "C");
                        // console.log('내용삭제 :', param.dindex, column.key);
                    });

                } else if (item.label == "줄삭제") {
                    // console.log('삭제 인덱스 :', param.dindex);
                    if (gridOrdrsDetail.list[param.dindex].cudCheck != "C") {
                    	gridOrdrsDetaildeleteArr.push(gridOrdrsDetail.list[param.dindex]);
                    }
                    gridOrdrsDetail.removeRow(param.dindex);
                    //삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
                }

                gridOrdrsDetail.contextMenu.close();
                //또는 return true;
            }
        }

    });
                    
  //공유 결재 그리드
 	var gridViewPop7 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $('[data-ax5grid="third-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView7.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 50},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: false},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 80},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 60},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 90},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 130},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: 200},
                    {key: "telNo",      		label: "H.P",		align: "center",   width: 130},
                    {key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},                   
                    {key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
                    var targetObj = this.target;
                    var formData = {
                        "fileTrgtKey" : fileTrgtKey,
                        "reqNo" : modalStack.last().paramObj.ordrsNo,
                        "etcField2" : $("#histNo").val(),
                        "pageNo" : _pageNo + 1
                    }
                    postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
                        var list = data.result;
                        if( list.length > 0 ) {
                            var inCnt = 0;
                            var inGb = 0; //해당 결재개수 변수
     
                            let processChk = false;	//결재 진행여부 체크 (결재가 하나라도  진행되면 true)
                            $.each(list, function (idx, elem) {
                                if (elem.gb == "결재") {	//결재와 공유 중 결재 갯수 파악
                                	if (elem.sanctnSttus == "Y") processChk = true;
                                
                                	inGb++;
                                	
	                                //결재자가 본인이 아니면서 상태가 Y인 경우
	                                //2024.01.30 김성욱 결재조건 추가
	                                if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
                                }
                            })
                            
                            //수주 결재올렸을때 ver.up 버튼 하이드 처리
                            if (processChk && (inCnt == inGb)){	//결재자가있고 결재가 완료되면 버젼업버튼 활성화 및 수정버튼 숨김
                                $('#createHistory').show();
                                $('#actionOrdrsBtn').hide();
                            } else if (list.length == 0 || inCnt == 0){	//결재자가 없으면 버젼업 버튼 숨김
                                //아무도 결재가 이뤄지지 않았을 경우의 조건
                                $('#createHistory').hide();
                            } else {								//결재 진행중이면 버젼업, 수정 버튼 숨김처리
                                $('#createHistory').hide();
                                $('#actionOrdrsBtn').hide();
                            }
                        }
                        targetObj.setData({
                            list : list,
                            page : {
                                totalElements : list.length
                            }
                        });
                    });
                },

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    } 
   	  					});
          		}
                ,
                setData3 : function(_pageNo) {
                   var targetObj = this.target;
                   var paramObj = { "userId": jwt.userId
                               , "appDiv": 'APPDIV09'		//수주원가관리 결재라인
                   };
                    postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
                    var list = data.result;
                       targetObj.setData({
                            list : list,
                            page : { totalElements : list.length } 
                         });
                      });
                  }
  	}

    if (actionType == "C") {
        //회사 기본값지정
		if(modalStack.last().paramObj.coCd == '' || modalStack.last().paramObj.coCd == undefined){
			$("#coCd").val(jwt.coCd);
		}else{
			$("#coCd").val(modalStack.last().paramObj.coCd);
			//회사 비활성화
			$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		}

        $('#createHistoryDiv').removeClass("contents_tit")
        $('#createHistory').hide();
        
        setInitInsert();
        gridViewPop7.initView().setData3(0);
        
        $('#actionOrdrsBtn').on("click", function () {
            insertOrdrs();
        });
    } else if (actionType == "U") {
    	//타이틀명 변경
		$('#cr02PopTit').text('수주 수정')
		
		//버튼명 변경
		$('#actionOrdrsBtn').text("수정");
        $('#actionOrdrsBtn').on("click", function () {
            updateOrdrs();
        });
        
        monthCloseChk($('#ordrsDt').val());  //마감일통제
        
		//회사 비활성화
		$('#popForm .coCd').removeClass('hit');
		$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

		//견적서번호 비활성화
		// $('#popForm .estNoOrdrs').removeClass('hit');
		// $('#estNoOrdrs').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//수주일자 비활성화
		// $('#popForm .ordrsDt').removeClass('hit');
		// $('#ordrsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//고객사 비활성화
		// $('#popForm .ordrsClntNm').removeClass('hit');
		// $('#ordrsClntNm').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//수주금액 비활성화
		// $('#popForm .ordrsAmt').removeClass('hit');
		// $('#ordrsAmt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
        $("#ordrsPlanHis").show();
        $('#pmntMtd').val('PMNTMTD01');

        postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {
            var parsedData = data;
            Object.keys(parsedData.ordrsInfo).forEach(function (key) {
                var inputField = document.getElementById(key == 'estNo' ? 'estNoOrdrs' : key);
                if (!inputField) return;

                var value = parsedData.ordrsInfo[key];

                switch (key) {
                //    case 'ordrsDiv':
                //        if (value == 'ORDRSDIV1') {
                //            $('#orgnSalesCdTd,#orgnSalesCdTh').hide();
                //        }
                //        else {
                //        	inputField.value = value || '';
                //        	$('#orgnSalesCdTd,#orgnSalesCdTh').show();
                //        }
                //        break;
                    case 'ordrsDt':	//바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
                    	$(".ordrsDt").val(value);
                    case 'dudtPlanDt':  //바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
//                     	$(".dudtPlanDt").val(value);
                    case 'ordrsAmt':
                    case 'exrate':
                        inputField.value = addCommaStr(value);
                        break;
                    case 'exchangeAmt':
                        inputField.value = addCommaStr(value);
                        break;
                    default:
                        inputField.value = value || '';
                        break;
                }
            });
            
            //수정시  로드 될떄 gridOrdrsPlan 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var pmntPlans = data.ordrsInfo.plans;
            gridOrdrsPlan.setData({
                list: pmntPlans,
                page: {
                    totalElements: pmntPlans.length
                }
            });
            //수정시  로드 될떄 orderDetails 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var ordrsDetails = data.ordrsInfo.details;
            if ($("#coCd").val() != jwt.coCd) {ordrsAmt
            	$("#ordrsAmt").val("0");
            	$("#exchangeAmt").val("0");
            	for (var i = 0; i < ordrsDetails.length; i++) {
            		ordrsDetails[i].ordrsAmt = 0;
            		ordrsDetails[i].exchangeAmt = 0;
            		ordrsDetails[i].ordrsPrcMach = 0;
            		ordrsDetails[i].ordrsPrcElcty = 0;
            		ordrsDetails[i].ordrsPrc = 0;
            		ordrsDetails[i].estEpctMatPrc = 0;
                }
            }
            gridOrdrsDetail.setData({
                list: ordrsDetails,
                page: {
                    totalElements: ordrsDetails.length
                }
            });
	        gridResize(ordrsDetails.length+1); //그리드 높이 조정
	        //monthCloseChk($('#ordrsDt').val());  //마감일통제 원래 위치
	        gridViewPop7.initView().setData(0);
	        gridViewPop7.target.setHeight((gridViewPop7.target.list.length+1) * 27 + 123 );//그리드 높이 조정
	        
	        setDetailButton();// 설비 & 원가 정보 버튼 통제
	        
			//최초값셋팅
			setInitSetting();
        });
        
    }
    
    $("#addPaymentButton").on("click", function () {
        var row;
		var newRowData = {
				clmnPlanDiv: "CLMNPLANDIV1",
				clmnDivSeq : 1,
				clmnRate : 0,
				clmnAmt : 0,
				clmnDt : "",
				pmntDtAfterBill : "",
				billPblsDt : "",
				clmnMgmtStatus : "",
		};

		//2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
//         if ($('#actionOrdrsBtn').is(':hidden')) {
//             $('#ordrsPlanUpdate').show();
//         }

        var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
        var bordrsDiv = $("#ordrsDiv").val() //수주구분
        if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && bordrsDiv != 'ORDRSDIV3' && bordrsDiv != 'ORDRSDIV9' ){
        	alert("수주금액을 입력바랍니다.");
        	return false;
        } else {
		        // 첫 번째 경우: 선택된 행이 있는 경우
		        if (selectedRowKey !== undefined) {
		            let row = gridOrdrsPlan.getList("selected")[0];
		            let newRowData = $.extend({}, row, {__index: undefined, clmnRate: 0, clmnAmt: 0});
		            gridOrdrsPlan.addRow(newRowData, row.__index + 1);
		        }
		        // 두 번째 경우: 그리드가 비어 있는 경우
		        else if (gridOrdrsPlan.getList().length === 0) {
		            gridOrdrsPlan.addRow(newRowData, 0);
		        }
		        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
		        else {
		            gridOrdrsPlan.addRow(newRowData, gridOrdrsPlan.list.length);
		            return;
		        }
		
			        const data = gridOrdrsPlan.getList();
			        gridOrdrsPlan.setData({
			            list: data,
			            page: {
			                totalElements: data.length
			            }
			        });
        }
        prevData = JSON.parse(JSON.stringify(gridOrdrsPlan.getList()));
        // 여기에서 그리드 데이터가 준비된 후 실행하려는 코드를 추가할 수 있습니다.

    });

    $("#deletePaymentButton").on("click", function () {
        if (selectedRowKey !== undefined) {
            gridOrdrsPlan.removeRow(selectedRowKey);
            const data = gridOrdrsPlan.getList();
            gridOrdrsPlan.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

          //2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
//             if ($('#actionOrdrsBtn').is(':hidden')) {
//                 $('#ordrsPlanUpdate').show();
//             }

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                    gridOrdrsPlan.select(selectedRowKey);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey = selectedRowKey - 1;
                    gridOrdrsPlan.select(selectedRowKey);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });


    $("#addDetailButton").on("click", function () {
        var row;
		var newRowData = {
			ordrsDtlDiv10 : "ORDRSDTLDIV1010",
			prdtCd : "NVF",
			itemDiv : "ITEMLIST01",
			ordrsDtlDiv20 : "ORDRSDTLDIV2010",
			ordrsDtlDiv30 : "ORDRSDTLDIV3010",
			mctype : "MCT01",
			salesCd : "",
			eqpNm : "",
			ordrsPrcMach : 0,
			ordrsPrcElcty : 0,
			ordrsQty : 0,
			estEpctMatPrc : 0,
			trgtPchsPcostMach : 0,
			trgtPchsPcostElcty : 0,
			trgtPchsPcostInHousePrcsn : 0,
			laborCostMfgCost : 0,
			cudCheck : "C",   //추가, 수정, 삭제구분
			ordrsSeq : "0",   //삭제오류 방지용
			estTrgtCost : 0,   //수주목표원가
			
		};
        var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
        var bordrsDiv = $("#ordrsDiv").val() //수주구분
      	//수주구분 : 정상수주가 아닐경우
        // if (bordrsDiv != 'ORDRSDIV1' && gridOrdrsDetail.getList().length >=1) {
        //     alert("수주구분이 A/S에서는 1줄만 추가 가능합니다.");
        //     return false;
        // }
        if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && (bordrsDiv != 'ORDRSDIV3') && (bordrsDiv != 'ORDRSDIV9')){
        	alert("수주금액을 입력바랍니다.");
        	return false;
        } else {
		       	// 첫 번째 경우: 선택된 행이 있는 경우
		       	
		        let row = gridOrdrsDetail.getList("selected")[0];
		        if (row !== undefined) {
		            row.salesCd = "";
		            row.cudCheck = "C";	//추가, 수정, 삭제구분
		            row.ordrsSeq = "0";	//삭제오류 방지용
		            gridOrdrsDetail.addRow(row, gridOrdrsDetail.list.length);
			        gridResize(gridOrdrsDetail.list.length + 1); //그리드 높이 조정
		        }
		        else {
		            gridOrdrsDetail.addRow(newRowData, gridOrdrsDetail.list.length);
			        gridResize(gridOrdrsDetail.list.length + 1); //그리드 높이 조정s
		        }
        }
    });

//설비&원가정보 삭제키_OLD
    $("#deleteDetailButton").on("click", function () {
        if (selectedRowKey2 !== undefined) {
            var selRow = pasIntChk(gridOrdrsDetail.selectedDataIndexs);
            if( isNaN(selRow) ) {
               alert("선택된 행이 없습니다.");
               return;
            } else {         
                  if( selRow > -1 ) {
                     var todoKey = gridOrdrsDetail.getList()[selRow].ordrsSeq;
                     var gridList = gridOrdrsDetail.getList("selected")[0];
                 if( typeof(todoKey) == "undefined" ) {
                	 gridOrdrsDetail.removeRow(selRow);
                 } else {
                    var paramObj = {
                    	  coCd : $("#popForm #coCd").val(),
                          ordrsNo: $("#popForm #ordrsNo").val(),
                          ordrsSeq: todoKey,
                    }
                    if (gridOrdrsDetail.list[selRow].cudCheck != "C") {
                    	gridOrdrsDetaildeleteArr.push(gridList);
                    }
               	 	gridOrdrsDetail.removeRow(selRow);
//                     deleteAjax("/user/cr/cr02/deleteOrdrsDetail", paramObj, null, function(data) {
//                        if (data.resultCode == 200) {
//                           alert(data.resultMessage);
//                           postAjax("/user/cr/cr02/selectOrdrsDetails", paramObj, null, function (data) {
//                               var parsedData = data;
//                               //수정시  로드 될떄 orderDetails 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
//                               var ordrsDetails = data.fileList;

//                               gridOrdrsDetail.setData({
//                                   list: ordrsDetails,
//                                   page: {
//                                       totalElements: ordrsDetails.length
//                                   }
//                               });
//                               var currEndRow = currGridEndRow();
//                               resetGridFocus(currEndRow, thisGridRow);
//                               gridOrdrsDetail.repaint();
//                           });
//                        } else {
//                           alert("삭제중 오류가 발생했습니다");                                
//                        }
//                     });                    
                 }
               }
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });


    function insertOrdrs() {
		if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) {
			if($('#newOrdrsNo').val() == ''){
				alert('건양ITT 수주번호를 선택해 주십시요.')
				fn_orderSearch();
				return false;
			}
		}
    
    	if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            if (formData) {
                openProgress(true);
                filePostAjax("/user/cr/cr02/insertOrdrs", formData, function (data) {
                    if (data.resultCode == 200) {
                        alert(data.resultMessage);
                        //var odrSeq = data.odrSeq;
                        ordrsNo = data.ordrsNo;
                        $('#ordrsNo').val(ordrsNo);
                        $('#histNo').val("1"); //insert는 무조건 처음 차수니까 무조건 1
                        kakaoTodo();
                        modalStack.close();
                        gridView.setData(0);
                    }else{
                    	alert(data.resultMessage);
                    } 
                });
            }
        	openProgress(false);
        }
    }

    function updateOrdrs() {

        if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            if (formData) {
                openProgress(true);
                filePostAjax("/user/cr/cr02/updateOrdrs", formData, function (data) {
                    if (data.resultCode == 200) {
                        alert(data.resultMessage);
                        var odrSeq = $('#odrSeq').val();
                        kakaoTodo();
                        modalStack.close();
                        gridView.setData(0);
                    }else{
                    	alert(data.resultMessage);
                    }
                });
            }
        	openProgress(false);
        }
    }

    // 수금정보 수정시 처리하는 함수
    //2024.03.04 전무님 지시로 수금정보 수정 기능 삭제 남장섭
//     function ordrsPlanUpdate() {   
//         if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
//             var formData = makeFormData();
//             if (formData) {
//                 openProgress(true);
//                 filePostAjax("/user/cr/cr02/updateOrdrsPmntPlanProcess", formData, function (data) {
//                     if (data.resultCode == 200) {
//                         alert(data.resultMessage);
//                         var odrSeq = $('#odrSeq').val();
//                     }else{
//                     	alert(data.resultMessage);
//                     }
//                 });
//             }
//         	openProgress(false);
//         }
//     }

    //제품구분 찾기(그리드)
    function openSecondPrdtSearch() {
        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#estClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            var prdtCd = grid.target.getList("selected")[0].prdtCd;
            var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];
            var rowData = gridOrdrsDetail.getList()[rowIndex];
            rowData.prdtCd = prdtCd;
            gridOrdrsDetail.updateRow(rowData, rowIndex);
        });
    }
    
    //원천SalesCode 찾기(그리드)
    function openSalesCdSearch() {
        var paramObj = {
            "coCd" : $('#coCd').val(),
            "salesCd": $('#orgnSalesCd').val()
        };
        
        openSecondModal("/static/html/cmn/modal/SalesCodeItemSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];
            var rowData = gridOrdrsDetail.getList()[rowIndex];
            //설비인것만 세팅
            if (rowData.ordrsDtlDiv10 == 'ORDRSDTLDIV1010') {
                rowData = {
                    // ordrsDtlDiv10 : row.ordrsDtlDiv10,
                    prdtCd : row.prdtCd,
                    itemDiv : row.itemDiv,
                    ordrsDtlDiv20 : row.ordrsDtlDiv20,
                    ordrsDtlDiv30 : row.ordrsDtlDiv30,
                    orgnSalesCd : row.salesCd,
                    eqpNm : row.eqpNm,
//                     ordrsPrcMach : 0,
//                     ordrsPrcElcty : 0,
//                     ordrsQty : 0,
//                     estEpctMatPrc : 0,
//                     trgtPchsPcostMach : 0,
//                     trgtPchsPcostElcty : 0,
//                     trgtPchsPcostInHousePrcsn : 0,
//                     laborCostMfgCost : 0,
                    dataChk : "U",
//         			estTrgtCost : 0,   //수주목표원가
                };

                if (rowData.cudCheck != "C") {
                	rowData.cudCheck = "U";   //추가, 수정, 삭제구분
                }
                gridOrdrsDetail.updateRow($.extend({}, gridOrdrsDetail.list[rowIndex], rowData), rowIndex);
                // gridOrdrsDetail.updateRow(rowData, rowIndex);
            }
        });
    }
     
    $("#ordrsPlanHis").click(function () {
        var paramObj = {
            "coCd": $("#coCd").val(),
            "ordrsNo": $("#ordrsNo").val(),
        };
        
        openSecondModal("/static/html/cmn/modal/ordrsPlanHisSearch.html", 1000, 420, "수금계획수정이력", paramObj, function (grid) {
            
        });
    })
    
    // 사용자 검색 함수
    function openSecondUserSearch(searchValue) {

        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        var paramObj = {
            "coCd": $('#coCd').val(),
            "userId": $('#mngId').val(),
            "userNm": $('#mngIdNm').val(),
            "useYn": "Y",
            "searchValue": searchValue
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#mngId").val(checkedNode.id);
            $("#mngIdNm").val(checkedNode.text);
            // $("#salesEmpNm").val(checkedNode.text);
            $("#mngId").focus();
            $("#mngId").trigger("click");
        });
    }

    
    function gridResize(size) {
        if (beforeGridSize != size) {
            let tagHeight = (size) * 27 + 123 ;
            tagHeight = tagHeight > 750 ? 750 : tagHeight;
            tagHeight = tagHeight < 300 ? 300 : tagHeight;
            
            // $('[data-ax5grid="second-grid-modal"]').height(tagHeight);
            // $('[data-ax5grid="second-grid-modal"] [data-ax5grid-container="root"]').height(tagHeight);
            
            gridOrdrsDetail.setHeight(tagHeight);
            beforeGridSize = size;
        }
    }
    
    function  gridPaste(thisGrid, thisGridRow, thisGridCol, _type = "DETAIL" ) {
        var pasteData = "";
        
        navigator.clipboard.readText()
        .then(pasteData => {
            // console.log('클립보드에 저장된 값:', pasteData);
            if (pasteData == undefined || pasteData == "" || thisGridRow == undefined) {
                console.error('클립보드에 데이터가 없습니다.');
                return;
            }
            
            // 붙여넣기할 데이터를 배열로 변환한다.
            var pasteRows = pasteData.split("\n").map(function(row) {
                return row.split("\t");
            });
            
            //복사대상의 마지막 배열의 값이 없으면 제외
            if (pasteRows[pasteRows.length - 1] == "") pasteRows.splice(pasteRows.length - 1, 1);
            
            // 붙여넣기를 시작할 셀의 인덱스를 구한다.
            var startRowIndex = thisGridRow;
            var startColIndex = thisGridCol;
            
            // 붙여넣을 데이터의 행과 열 개수를 구한다.
            var numRows = pasteRows.length;
            var numCols = pasteRows[0].length;
            
            //그리드 컬럼정보를 가져와서 붙여넣기할때 위치정보로 사용한다.
            tempColumns = thisGrid.colGroup;
            for (var i = tempColumns.length - 1; i >= 0; i--) {
                if (tempColumns[i].hidden) {
                    tempColumns.splice(i, 1);
                }
            }
            
            var currGridData = thisGrid.list;
            
            //마지막자료와 같은 값으로 추가하고 ordrsSeq는 0으로 설정
            //참조복사를 방지하기 위함
            var tempData = JSON.parse(JSON.stringify(currGridData[thisGridRow]));
            tempData.ordrsSeq = "0";
            
            // 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
            for (var i = 0; i < numRows; i++) {
                for (var j = 0; j < numCols; j++) {
                    //carriage return 문자 삭제
                    var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
                    
                    calRow = startRowIndex + i;
                    calCol = startColIndex + j;
                    
                    if (calRow >= currGridData.length) {
                        //참조복사를 방지하기 위함
                        let tempDataCopy = JSON.parse(JSON.stringify(tempData));
                        currGridData.push(tempDataCopy);
                    }
                    
                    var tkey = tempColumns[calCol].key;
                    currGridData[calRow][tkey] = cellData;
                }
                if (_type == "DETAIL") {  //설비쪽 붙여넣기인경우  신규추가 레코드가 아니면 수정 Flag로 변경처리
	                if (currGridData[calRow]["cudCheck"] != "C") {  //추가된 레코드가 아니면 수정 함으로 설정
	                	currGridData[calRow]["cudCheck"] = "U"; //수정 플래그 설정
	                }
                }
            }
            
            var currEndRow = currGridEndRow();
            thisGrid.setData(currGridData);
            // gridResize(currGridData.length);
            // thisGrid.focus(thisGridRow);
            resetGridFocus(currEndRow, thisGridRow);
        })
        .catch(error => {
//             console.log('클립보드 읽기 오류 발생:', error);
        });
    };
    
    //환율 load
	var paramObj = {
        "userId" : jwt.userId,
        "codeKind" : "CURR"
    };
    
    postAjax("/user/sm/sm02/selectCurrToday", paramObj, null , function(data) {
        if(data.resultList.length > 0 ) {
            currToday = data.resultList;
        }
    });
    //user search ajax end
    
    //등록시 통화단위에 따른 환율 SET
	$('#popForm #currCd').on("change", function() {
        var ordrsAmtVal = pasFloatChk($("#ordrsAmt").val()); //수주금액에 적힌 값

		if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && $("#ordrsDiv").val() != 'ORDRSDIV3' && $("#ordrsDiv").val() != 'ORDRSDIV9') {
            $('#currCd').val('CURR01');
            alert("수주금액을 입력바랍니다.");
            return;
        }
        
        if(actionType == "C" && $(this).val() != "" ) {
            var selVal = $(this).val();
            var exrate = currToday[selVal];
            var find = currToday.find(e => e.codeId === selVal);
            
            if( typeof(find.codeEtc) != "undefined" ) {
                $('#popForm #exrate').val(addCommaStr(find.codeEtc));
                $('#exchangeAmt').val(addCommaStr(find.codeEtc*ordrsAmtVal));
            }
        } else if( actionType == "C" && $(this).val() == "" ) {
            $('#popForm #exrate').val('');
        }
    });
    
    // Ctrl + V 단축키 이벤트 처리
	gridOrdrsDetail.$target.on("paste", function (e, a) {
		gridPaste(gridOrdrsDetail, thisGridRow, thisGridCol);
	});
 	
	function pasIntChk (ivalue) {
		let value = ivalue +' ';    
		const cvtValue = parseInt(value.replace(/[^0-9.-]/g, ''));
		return isNaN(cvtValue) ? 0 : cvtValue;
	}

    function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}
    
    //그리드 수정후 현재 위치로 이동하기 위한 함수
    //상태바에서 시작 또는 마지막 표시 row를 산정함
    // resetGridFocus()와 분리한 이유는 화면에 기존 데이터 Refresh하기전 위치 위치 저장하기 위함
    function currGridEndRow() {
        //row focus 처리용 그리드 상태바에서 "30 - 53 of 59" 에서 시작 ROW 30, 마지막ROW 53임
        // var gridStatus = $('.popup_area [data-ax5grid="second-grid-modal"] [data-ax5grid-page="status"]').text().trim();
        // var gridStatusIdx = gridStatus.indexOf(' ');
        // var topRow = gridStatus.slice(0, gridStatusIdx).trim();
        // var regex = /-(.*?) of/; // '-'와 'of' 사이의 숫자를 찾는 정규 표현식
        // var match = regex.exec(gridStatus);

        // if (match && match.length > 1) {
        //     var gridDisplayEndRow = match[1].trim(); // '-'와 'of' 사이의 숫자를 가져옴
        // }
        //현재 표시하는 ROW정보 상태바에서 grid 함수내 값으로 대체
        var gridDisplayEndRow = gridOrdrsDetail.xvar.virtualPaintRowCount //화면출력 row수
                              + gridOrdrsDetail.xvar.virtualPaintStartRowIndex; //화면 출력 시작 Row index
        return gridDisplayEndRow < 4 ? 0 : gridDisplayEndRow - 3;
    }
    
    function resetGridFocus(endRow, row) {
        gridOrdrsDetail.focus(endRow);  
         
        gridResize(gridOrdrsDetail.list.length+2); //그리드 높이 조정
        beforeGridSize = gridOrdrsDetail.list.length;
        gridOrdrsDetail.focus(row);  
    }
    
    //이력생성
    function createHistory() {
    	var hist_no = $("#histNo").val();
        if(confirm("저장 된 정보로 이력을 생성을 진행하시겠습니까?")) {
            var paramObj = {
                coCd : $("#coCd").val(),
                ordrsNo : $("#ordrsNo").val(),
                histNo : $("#histNo").val(),
                pgmId : $("#pgmId").val(),
                userId : jwt.userId
            };
            
            postAjaxSync("/user/cr/cr02/callCopyOrdrs", paramObj, null, function(data) {
            	$("#histNo").val(parseInt(hist_no) + 1);
            	gridViewPop7.initView();
            	$('#actionOrdrsBtn').show();
                alert("이력생성이 완료되었습니다.");
            });
        }
    }
    
    function chechChange() {
        // var inputAmtVal = pasIntChk($("#ordrsAmt").val());
        // var inputExrateVal = pasIntChk($("#exrate").val());
        var inputAmtVal = pasFloatChk($("#ordrsAmt").val());        
		var inputExrateVal = pasFloatChk($("#exrate").val());

		var exchangeAmt = addCommaStr(inputAmtVal*inputExrateVal);
		inputAmtVal = addCommaStr($("#ordrsAmt").val());
		inputExrateVal = addCommaStr($("#exrate").val());
		 	 
		$("#exchangeAmt").val(exchangeAmt);
		$("#exrate").val(inputExrateVal);
		$("#ordrsAmt").val(inputAmtVal);
	}

	function commaChange() {
		var inputAmtVal = addCommaStr($("#ordrsAmt").val());
		var inputExrateVal = addCommaStr($("#exrate").val());
		var inputExchangeVal = addCommaStr($("#exchangeAmt").val());
				 
		$("#exchangeAmt").val(inputExchangeVal);
		$("#exrate").val(inputExrateVal);
		$("#ordrsAmt").val(inputAmtVal);
	}
	
    function setClmnDtYn(clmnDt) {
        if(isNaN(clmnDt)) {
            commaChange();
            alert("수금예정일자가 없습니다.");
            return false;
        }
    }
    
    function fn_orderSearch() {
        // if (actionType == "C") {
            if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) {
                var paramObj = {
                    "searchValue" : '',
                    "coCd" : 'GUN'
                };
                
                openSecondModal("/static/html/cmn/modal/noSalesCdordrsSearch.html", 1200, 650, "건양수주번호 검색", paramObj, function (grid) {
                    var row = grid.target.getList("selected")[0];
                    // console.log(row);
                    $('#newOrdrsNo').val(row.ordrsNo);
                    $('#ctrtNm').val(row.ctrtNm);
                    $('#clntPjt').val(row.clntPjt);
                });
            }
        // }
    }

    function setDetailButton() {
        //고객사가 건양ITT면 설비&원가정보는 필요없음 
//     	if($('#coCd').val() == 'TRN' && $("#ordrsClntCd").val() == refCode) {
//             $("#datailButtonDiv").hide();
//             $("#datailGridDiv").hide();
//             $('#ordrsNoTh').addClass('hit');
//             $('#newOrdrsNo').attr('required', 'required');
//         } else {
//             $("#datailButtonDiv").show();
//             $("#datailGridDiv").show();
//             $('#ordrsNoTh').removeClass('hit');
//             $('#newOrdrsNo').removeAttr('required', 'required');
//         }
       //사용자 테이블의 회사코드와 자료의 회사코드가 다르면  조회모드만 작동
       if ($('#popForm #coCd').val() != jwt.coCd) {
           $('.coAuthChk').hide();
       }
    }
    
    function setInitSetting() {
        if($("#ordrsDiv").val() == "ORDRSDIV3" || $("#ordrsDiv").val() == "ORDRSDIV9") {
            $("#ordrsAmtTh").removeClass('hit');
            $("#currCdTh").removeClass('hit');
            $('#ordrsAmt').attr('readonly', 'true');
            $('#ordrsAmt').val("0");
            $('#exchangeAmt').val("0");
        } else {
            $("#ordrsAmtTh").addClass('hit');
            $("#currCdTh").addClass('hit');
            $('#ordrsAmt').removeAttr('readonly', 'true');
        }
        setInitInsert();
    }
    
    function setInitInsert() {
        if($("#fwdExchChkList").val() == "N") {
            $('#fwdExchJoinDt').attr('readonly', 'true');
            $('#fwdExchJoinDt').hide();
        } else {
            $('#fwdExchJoinDt').removeAttr('readonly', 'true');
            $('#fwdExchJoinDt').show();
        }
    }

    function excelDown1() {
			//var list = data.result;
			var todayDate = new Date().format('yyyyMMddHHmmss');
			gridOrdrsDetail.exportExcel("수주관리 설비원가정보("+$('#ordrsNo').val()+")_"+todayDate+".xls");
	}
    
 	// 출력 버튼용
	function setReportMain() {
 		////////////////////////////////
 		var paramObj = {
                coCd : $("#coCd").val(),
                ordrsNo : $("#ordrsNo").val(),
                histNo : $("#histNo").val()
            };
            
            postAjaxSync("/user/cr/cr02/selectJunmooApproval", paramObj, null, function(data) {
                if (data.JunmooApproval == 1){
					//소속부서가 영업팀이면 원가관리표(CR0202R03.jrf), 아니면 목표원가표(CR0202R04.jrf) 출력
					// GUN==GUN && GUN30, TRN==TRN && TRN30만 원가관리표 출력 가능함
              		let fileName = (jwt.coCd==$("#coCd").val() && (jwt.deptId.substr(0,5) == 'GUN30' || jwt.deptId.substr(0,5) == 'TRN30')) ? "CR0202R03.jrf" : "CR0202R04.jrf";
					let arg = "coCd#" + $("#coCd").val() + "#ordrsNo#" + $("#ordrsNo").val() + "#histNo#" +  $("#histNo").val()
                	+ "#";
            		callReport(fileName, arg, "1050", "700", $("#ordrsClntNm").val()+"_"+$("#ordrsNo").val()+"-"+$("#histNo").val());
                }
                else {
                	alert("전무님의 결재가 필요합니다.");
                }
            });
 		////////////////////////////////
	}
 	
 // 공유대상자 추가//  
    function insertShareUserModal1() {
		
    	if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

        var paramObj = {};
        var appshaList = gridViewPop7.target.list;
        paramObj["coCd"] = $('#coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $('#ordrgId').val();
        paramObj["userNm"] =  $('#ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";   
        		}).map(function(item) {
	        		  	return {
	        			    gb: "결재",
	        			    id: item.usrNm,
	        			    text: item.name,
	        			    parent: item.jik,
	        			    deptNm: item.dtNm,
	        			    telNo: item.telNo,
	        			    offTelNo: item.offTelNo,
	        			    email: item.email,
	        			    todoId: item.id
	        			    , todoKey: item.todoKey        			    
	        			    , sanctnSn: item.sanctnSn
	        			    , sanctnSttus: item.sanctnSttus
	        		        , todoCfDt: item.todoCfDt
	        		        , todoCfOpn: item.todoCfOpn        			    
	        			    , flag: item.flag
	        			};
        		});
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
        		}).map(function(item) {
				  		return {
						    gb: "공유",
						    id: item.usrNm,
						    text: item.name,
						    parent: item.jik,
						    deptNm: item.dtNm,
						    telNo: item.telNo,
						    offTelNo: item.offTelNo,
						    email: item.email,
						    todoId: item.id
	        			    , todoKey: item.todoKey        			    
	        			    , sanctnSn: item.sanctnSn
	        			    , sanctnSttus: item.sanctnSttus
	        		        , todoCfDt: item.todoCfDt
	        		        , todoCfOpn: item.todoCfOpn        			    
	        			    , flag: item.flag
						};
				});
        
        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//     		console.log('결재라인 : ', approvalGrid.target.list);
//     		console.log('공유라인 : ', shareGrid.target.list);
    		
    		var appArray = approvalGrid.target.list.map(function(item) {
    			  return {
    				  	gb: "결재",
    				  	usrNm: item.id,
    				  	name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id
        			    , todoKey: item.todoKey        			    
        			    , sanctnSn: item.sanctnSn
        			    , sanctnSttus: item.sanctnSttus
        		        , todoCfDt: item.todoCfDt
        		        , todoCfOpn: item.todoCfOpn        			    
        			    , flag: item.flag
					};
			});
    		var shaArray = shareGrid.target.list.map(function(item) {
  			  return {
	  				  	gb: "공유",
						usrNm: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id
        			    , todoKey: item.todoKey        			    
        			    , sanctnSn: item.sanctnSn
        			    , sanctnSttus: item.sanctnSttus
        		        , todoCfDt: item.todoCfDt
        		        , todoCfOpn: item.todoCfOpn        			    
        			    , flag: item.flag
					};
			});
  			gridViewPop7.setData2(appArray.concat(shaArray));
  			
        });
		
    } 
 	
    //결재 여부
    function approvalYn() {
       var gridList = gridViewPop7.target.getList();
       var inCnt = 0;
       if( gridList.length > 0 ) {
            var msgArr = [];         
            $.each(gridList, function (idx, elem) {   
               //결재자가 본인이 아니면서 상태가 Y인 경우
               if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
            })
       }
       return inCnt;
    }
    
    function deleteShareUser1(){
        
        if( approvalYn() ) {
          alert("결재가 이미 진행중입니다.");
          return;
       }
        
        var selRow = parseInt(gridViewPop7.target.selectedDataIndexs);    
        if( isNaN(selRow) ) {
           alert("선택된 행이 없습니다.");
           return;
        } else {         
              if( selRow > -1 ) {
                 var todoKey = gridViewPop7.target.getList()[selRow].todoKey;
                 var gridList = gridViewPop7.target.getList("selected")[0];
             if( typeof(todoKey) == "undefined" ) {
                gridViewPop7.target.removeRow(selRow);
                $.gridNoSet(gridViewPop7, "sanctnSn");
             } else {
                var paramObj = {
                      todoNo: $("#popForm #ordrsNo").val(),
                      todoKey: gridList.todoKey,
                      sanctnSn: gridList.sanctnSn,
                      todoDiv1CodeId: gridList.todoDiv1CodeId,
                      todoDiv2CodeId: gridList.todoDiv2CodeId
                }
//                      if( confirm("선택행을 삭제하시겠습니까?")) {
                        deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
                           if (data.resultCode == 200) {
                              alert(data.resultMessage);
                              gridViewPop7.setData(0);
                           } else {
                              alert("삭제중 오류가 발생했습니다");                                
                           }
                        });                   
//                      }                                                
//                    } else {
//                       alert("삭제중 오류가 발생했습니다.")
//                    }      
             }
           }
        }
     }
 
                
    /*
    #   TODO 알림톡발송 시작
    #
    */
//     $("#approvalReqTodoBtn").on("click", function () {
//        kakaoTodo();
//     });
    function kakaoTodo() {
       let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
       
       // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅 
         var paramObj1 = {
                 "coCd" : $("#coCd").val(),
                 "userId" : $("#mngId").val()
             };
          postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){  
              if (data.result[0] == undefined
                   || data.result[0].telNo == "") {
                 teleNo = "051-312-2400";  
              }
              else {
                 teleNo = data.result[0].telNo;
                 
              }
          }); 
         //---------------------------------------
       let param = {
             "tmplatDiv": "TMPLATDIV02"
             , "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
             , "todoDiv1CodeId": "TODODIV20"               //공통코드 해당업무 - 결재
             , "todoDiv2CodeId": "TODODIV2100"               //공통코드 해당업무 - 결재 - 발주서
             , "todoDiv1CodeNm": "결재"                  //공통코드 해당업무 - 결재 - 발주서
             //, "todoDiv2CodeNm": "발주 및 출장 요청"                  //공통코드 해당업무 - 결재 - 발주서
             , "title": "수주관리"
             , "sanctnDiv2": "결재"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
             , "todoNo": $("#popForm #ordrsNo").val()
             , "histNo": $("#popForm #histNo").val()   //수주차수
             //, "todoNo": tReqNo
             , "clntCd": "1"               //발신회사는 로그인사용자 회사
             , "clntNm": clntNm            //로그의 수신거래처명
             , "ordrgMngNm": $("#popForm #mngIdNm").val()         //수주작성자(담당자)
             , "ordrgMngTelNo": teleNo      //담당자전화번호      
             , "creatPgm"  : "CR0202P01"            
       }
       commKaKaoSendTodo(param);
         
       //공유
       let param2 = {
             "tmplatDiv": "TMPLATDIV02"
                , "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
                , "todoDiv1CodeId": "TODODIV10"               //공통코드 해당업무 - 결재
                , "todoDiv2CodeId": "TODODIV1100"               //공통코드 해당업무 - 결재 - 발주서
                , "todoDiv1CodeNm": "공유"                  //공통코드 해당업무 - 결재 - 발주서
                , "title": "수주관리"
                , "sanctnDiv2": "공유"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
                , "todoNo": $("#popForm #ordrsNo").val()
                , "histNo": $("#popForm #histNo").val()   //수주차수
                //, "todoNo": tReqNo
                , "clntCd": "1"               //발신회사는 로그인사용자 회사
                , "clntNm": clntNm            //로그의 수신거래처명
                , "ordrgMngNm": $("#popForm #mngIdNm").val()         //수주작성자(담당자)
                , "ordrgMngTelNo": teleNo      //담당자전화번호      
                , "creatPgm"  : "CR0202P01"
       }
       commKaKaoSendTodo(param2);
       
       if (kakaoCnt > 0) {
           kakaoCnt = 0;
//            alert("알림톡이 정상 발송되었습니다.");
        }
    }

    //to-do결재요청 알림톡
    function commKaKaoSendTodo(param) {
//        console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);

       //알림톡수신번호 채번
       var maxMessageId = null;         //message id(unique key)
       var talkMessage = null             //발송될 내용 template
       var mobile = null               //수신인 휴대전화번호
       var title = null               //todo title
       var todoDiv2CodeNm = null               //todo title
       var sendList = [];
       let talkParam = {};
       let talkBody = {};      
       let sendCnt = 0;
       postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
                , function(data) {   
                   if(data.resultList.length > 0 ) {
                      if( data.resultList[0].maxMessageId != "" ) {
                         sendList = data.resultList; 
                      } else {
                         alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                         return;
                      } 

                   }
       });        
       //user search ajax end
       
       //대상 loop
       $.each(sendList, function (key, sendObj) {
          maxMessageId = sendObj.maxMessageId;                     
          talkMessage = sendObj.messageDesc;
          mobile =  sendObj.telNo;
          //로그용
          param.rcvId = sendObj.todoId;         //todo 수신id
          param.rcvNm = sendObj.name;            //todo 수신자명
          param.nameTo = sendObj.name;            //todo 수신자명
          //title      = sendObj.todoTitl;
          todoDiv2CodeNm =   sendObj.todoTitl;
          param.todoDiv2CodeNm = todoDiv2CodeNm;
          //param.title = title;                        //요청내용제목
          param.sendDt = sendObj.sendDt;
          
          if(mobile == "" || mobile == null) {
             alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
             return;
          }
          if(talkMessage == "" || talkMessage == null) {
             alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
             return;
          }   
          //message 치환
          let message = talkMessage;
          let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);   
          //loop
          $.each(splitStr, function (key, val) {      
             let compKey = val.substring(1, val.length-1);
             if( compKey != "" && compKey != "undefined" ) {
                if( typeof(param[compKey]) != "undefined" ) {
                   let val2 = '#'+val;
                   message = message.replaceAll(val2, param[compKey]);
                }
             }
          });

          talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
          talkParam.serverName = "gyitt2400";      
          talkParam.paymentType = "P";
          talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
          talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);   
          talkBody.title = param.title;               //알림톡 타이틀 -
          talkBody.message = message;            //알림톡 메시지 (1000 byte) 
          talkBody.mobile = mobile;            //휴대전화번호
          talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
          let talkJson = JSON.stringify(talkBody);
          sendCnt = kakaoSendReal(talkJson, talkParam, param);      
       });
       //대상 loop end
       if( sendCnt > 0 ) {
          //alert("알림톡 정상 발송되었습니다.");
          kakaoCnt++;
       }
    }



    var kakaoErr = [];
    //message load
    var paramObj = {
                "userId" : jwt.userId
                , "codeKind" : "KAKAOMSG"
                };
    postAjax("/user/sm/sm02/selectCurrToday", paramObj, null
             , function(data) {   
                if(data.resultList.length > 0 ) {
                   kakaoErr = data.resultList;
                }
    });     //user search ajax end
    
	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
// 		console.log('---gridNoset run ---');		
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};	 
				gridObj.target.setValue(idx, key, idx+1);
			});	
			gridObj.target.repaint();
		}		
	}
    
    
    </script>

</html>
