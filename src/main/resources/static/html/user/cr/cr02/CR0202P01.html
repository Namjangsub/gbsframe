<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit" id="cr02PopTit">수주 등록</h4>
    </div>
    
    <!-- <div>
        <a class="tbody_more_btn"></a>
    </div> -->
    
    <form id="popForm" onSubmit="return false;">
        <div class="form-group popup_table">
            <div id="createHistoryDiv" class="contents_tit">
                <div  class="add_btn_small pdl10">
                    <a id="createHistory" onclick="createHistory();" style="height: 30px; line-height: 28px; width: 60px;">Ver.Up</a>
                </div>
            </div>
            
            <input type="hidden" id="pgmId" name="pgmId" value="CR0202P01">
            <input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">
            <table>
                <colgroup>
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
					<col width="10%">
					<col width="15%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th class="hit">회사</th>
                    <td>
                        <select data-search="coCd" id="coCd" name="coCd" class="modal-coCd" style="width: 100%;" data-kind="CO" required msg="회사">
                        </select>
                    </td>
					
                    <th>견적서번호</th>
                    <td>
                        <div class="search_form">
                            <input
								onkeydown="if(event.keyCode==13) openSecondEstSearch(this.value);"
								type="text" id="estNoOrdrs" name="estNoOrdrs"
								class="modal-estNoOrdrs">
                            <a onclick="openSecondEstSearch($('#estNoOrdrs').val());"><i class="i_search_w"></i></a>
                            <!-- <a onclick="openSecondEstSearch(document.getElementsByClassName('modal-estNoOrdrs').value);"><i class="i_search_w"></i></a> -->
						</div>
					</td>

					<th>견적차수</th>
                    <td>
                        <input id="estDeg" type="text" name="estDeg" readonly>
                    </td>

					<th>수주번호</th>
					<td>
						<input id="ordrsNo" name="ordrsNo" type="text" readonly>
						<input id="newOrdrsDiv" name="newOrdrsDiv" type="hidden" >
					</td>
				</tr>

				<!-- 2행 -->
				<tr>
                    <th class="hit">수주일자</th>
                    <td>
                        <input type="text" class="input_calendar"
						autocomplete="off" id="ordrsDt" name="ordrsDt" date required onchange="monthCloseChk(this.value);">
                    </td>
                    
                    <th class="hit">수주구분</th>
					<td>
                        <select id="ordrsDiv" name="ordrsDiv" data-kind="ORDRSDIV" required>
                        </select>
                    </td>                    
                    
                    <th class="hit">고객사</th>
					<td>
<!--                         <input type="hidden" id="ordrsClntCd" name="ordrsClntCd"> -->
                        <input type="hidden" id="ordrsClntCd" name="ordrsClntCd">
						<div class="search_form">
							<input onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);" type="text" id="ordrsClntNm" name="ordrsClntNm" required msg="고객사">
							<a onclick="openSecondClntSearch(document.getElementById('ordrsClntNm').value);"> <i class="i_search_w"></i> </a>
						</div>
                    </td>

                    <th id="ordrsNoTh" class="">건양수주번호</th>
                    <td>
                        <div class="search_form">
                            <input id="oldOrdrsNo" name="oldOrdrsNo" type="hidden" readonly>
                            <input id="newOrdrsNo" name="newOrdrsNo" type="text" readonly>
                            <a onclick="fn_orderSearch();"><i class="i_search_w"></i></a>
                        </div>
                    </td>
                </tr>
				<!-- 3행 -->
				<tr>
					<th class="hit">계약명</th>
					<td colspan="3">
                        <input type="text" id="ctrtNm" name="ctrtNm" required msg="계약명">
                    </td>
                    
                    <th class="hit" title="담당자 정보를 확인합니다">담당자</th>
                    <td>
                        <div class="search_form">
                            <input
                                onkeydown="if(event.keyCode==13)openSecondUserSearch( this.value);"
                                type="text" id="mngIdNm" name="mngIdNm" required>
                            <input type="hidden" id="mngId" name="mngId"> <a
                                onclick="openSecondUserSearch( document.getElementById('mngIdNm').value);">
                                <i class="i_search_w"></i>
                            </a>
                        </div>
                    </td>

                    <th>고객사PJT</th>
					<td>
						<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" required ></select>
						<!-- <input type="text" id="clntPjt" class="clntPjtOrdrs" name="clntPjt" required> -->
					</td>
				</tr>

				<!-- 4행 -->
				<tr>
					<th class="">결재방법</th>
					<td>
                        <select id="pmntMtd" name="pmntMtd" data-kind="PMNTMTD">

                        </select>
                    </td>

					<th class="">발주자</th>
					<td>
                        <input type="text" id="ordrger" name="ordrger">
                    </td>

                    <th class="hit" id="ordrsAmtTh">수주금액</th>
					<td>
                        <input type="text" id="ordrsAmt" name="ordrsAmt" required value="0"  onkeyup="onlyNumber(this); chechChange();" comma>
                    </td>

                    <th class="hit" id="currCdTh">통화단위</th>
                    <td>
                        <select id="currCd" name="currCd" data-kind="CURR" onchange="setByCoCd(this.value)" required>
                        </select>
                    </td>
				</tr>

				<!-- 5행 -->
				<tr>
					<th class="">선물환CheckList</th>
					<td>
                        <select data-kind="YN" id="fwdExchChkList" name="fwdExchChkList">
                            
                        </select>
                    </td>
					<th class="">선물환가입일</th>
					<td>
                        <input type="text" class="input_calendar" autocomplete="off" id="fwdExchJoinDt" name="fwdExchJoinDt" date>
                    </td>


                    <th class="">원화금액</th>
                    <td>
                        <input type="text" id="exchangeAmt" name="exchangeAmt" readonly>
                    </td>

                    <th class="">환율</th>
					<td>
						<input type="text" id="exrate" name="exrate" value="1" onkeyup="onlyNumber(this); chechChange();" comma>
					</td>
                    
                    <!-- <th></th>
                    <td>
                        <div class="search_form">
                            <input onkeydown="if(event.keyCode==13)wbsSalesCodeSearch();" type="text" id="orgnSalesCd" name="orgnSalesCd">
                            <a onclick="wbsSalesCodeSearch();"> <i class="i_search_w"></i></a>
                        </div>
                    </td> -->
                    
                </tr>

				<!-- 6행 -->
				<tr>
                    <th class="">계약문서</th>
					<td>
                        <select type="text" id="ctrtDoc" name="ctrtDoc" data-kind="CONTRACTDIV">
                            <option value=""></option>
                        </select>
					</td>

                    <th>국내/해외</th>
                    <td>
                        <select data-kind="INPEXP" id="inpexpCd" name="inpexpCd" class="form-control" style="text-align: center;">
                        </select>
                    </td>
                    
                    <!-- 빈값추가 -->
					<th></th>
					<th></th>
                    <th></th>
					<th></th>                    
                </tr>

				<!-- 7행 -->
				<tr>
                    <th>비고</th>
                    <td colspan="7">
                        <textarea rows="2" id="ordrsRmk" name="ordrsRmk" class="form-control"  msg="비고"></textarea>
                    </td>
                </tr>

            </table>
		</div>
	</form>

	<div class="contents_tit">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※ 수금 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10">
            <!-- <button id="ordrsPlanHis" style="margin-right:10px; display:none;" type="button">수금계획수정이력 </button> -->
			<a id="addPaymentButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deletePaymentButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>

	<!-- 콘텐츠1 -->
	<div class="contents">
		<!-- 리스트 -->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}"
					style="height: 180px; width: 100%"></div>
			</div>
		</div>
	</div>

	<div id="datailButtonDiv" class="contents_tit">
		<div style="float: left">
			<span style="font-size: 15px; margin-left: 10px; font-weight: bold;">※ 설비&원가 정보</span>
		</div>
		<div style="float: right" class="add_btn_small pdl10">
			<a id="addDetailButton" style="height: 20px; line-height: 18px">+</a>
			<a id="deleteDetailButton" style="height: 20px; line-height: 18px">-</a>
		</div>
	</div>
	<!-- 콘텐츠2-->
	<div id="datailGridDiv" class="contents">
		<!-- 리스트-->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="second-grid-modal" data-ax5grid-config="{}"
					style="height: 300px; width: 100%"></div>
			</div>
		</div>
	</div>
	<div>
    <br>
    <br>
	</div>
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionOrdrsBtn" authchk>등록</button>

		<button class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
	<div>
    <br>
    <br>
	</div>
</div>

<script type="text/javascript">
    /***********전역변수****************/
    let selectedRowKey;
    let selectedRowKey2;

    var currToday = [];
  	
    var thisGridRow = "";
    var thisGridCol = "";
    var beforeGridSize = 0; //수주상세그리드의 갯수용 그리드컨텐츠 높이조절용
    //수주상세내역의 콤보선택자료 생성임.
  	const comboOdd1 = [...setComboOptionCode('ORDRSDTLDIV10')];
  	const comboOdd2 = [...setComboOptionCode('ORDRSDTLDIV20')];
  	const comboOdd3 = [...setComboOptionCode('ORDRSDTLDIV30')];
  	const comboOdd4 = [...setComboOptionCode('MCTYPE')];
  	const comboItemList = [...setComboOptionCode('ITEMLIST')];
  	const comboClmnPlanDiv = [...setComboOptionCode('CLMNPLANDIV')];

  	let refCode = setRefCode();
  	
    function setComboOptionCode(selectComobo) {
        var optionCode = [];
        postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : selectComobo} , null, function(data) {
            var codeList = data.childCodeList;
            $.each(codeList, function (index, item) {
                let tempCode = {
                    'CD' : item.codeId,
                    'NM' : item.codeNm
                }
                optionCode.push(tempCode);
            });
        })
        return optionCode;
    }  
    
    function setRefCode() {
        var refCode = '';
        postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : "CO"} , null, function(data) {
            var codeList = data.childCodeList;
            $.each(codeList, function (index, item) {
                if(item.codeId == 'GUN') {
                    refCode = item.codeEtc;
                }
            });
		})
		return refCode;
	}
    
    /***********전역변수****************/
    /* document.ready */
    $(document).ready(function () {
        setCommonSelect($(".popup_area select[data-kind]"));
        fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;

        $("#mngIdNm").val(jwt.userNm);
        $("#mngId").val(jwt.userId);
        
        $('#fwdExchJoinDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        }).datepicker("setDate", new Date());

        $('.input_calendar').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

      	//수주일자//
		$('#ordrsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
        
        const ordrsDiv = document.getElementById('ordrsDiv');
        // const orgnSalesCdTh = document.getElementById('orgnSalesCdTh');
        // const orgnSalesCdTd = document.getElementById('orgnSalesCdTd');
        
        // function toggleOrgnSalesCd() {
        //     if (ordrsDiv.value === 'ORDRSDIV1') {
        //         orgnSalesCdTd.style.display = 'none';
        //         orgnSalesCdTh.style.display = 'none';
        //     } else {
        //         orgnSalesCdTd.style.display = 'none';
        //         orgnSalesCdTh.style.display = 'none';
        //     }
        // }
       
        // ordrsDiv.addEventListener('change', toggleOrgnSalesCd);
        // 페이지 로드 시 초기 상태 설정
        // toggleOrgnSalesCd();
        
        $('#ordrsDiv').on('change', function () {
        	const data = [];
        	if($("#ordrsDiv").val() == "ORDRSDIV3"){
        		$("#ordrsAmtTh").removeClass('hit');
        		$("#currCdTh").removeClass('hit');
        		$('#ordrsAmt').attr('readonly', 'true');
        		$('#ordrsAmt').val("0");
        		$('#exchangeAmt').val("0");
        		
        		gridOrdrsPlan.setData({
    	            list: data,
    	            page: {
    	                totalElements: data.length
    	            }
    	        });
           		gridOrdrsDetail.setData({
    	            list: data,
    	            page: {
    	                totalElements: data.length
    	            }
    	        });
        	}else{
        		$("#ordrsAmtTh").addClass('hit');
        		$("#currCdTh").addClass('hit');
        		$('#ordrsAmt').removeAttr('readonly', 'true');
        	}

        })
        
        $('#fwdExchChkList').on('change', function () {

        	if($("#fwdExchChkList").val() == "N"){
        		$('#fwdExchJoinDt').val("");
        		$('#fwdExchJoinDt').attr('readonly', 'true');
        		$('#fwdExchJoinDt').hide();
        	}else{
        		$('#fwdExchJoinDt').val($('#ordrsDt').val());
        		$('#fwdExchJoinDt').removeAttr('readonly', 'true');
        		$('#fwdExchJoinDt').show();
        	}

        })

      	//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: $("#pgmId").val(),
			fileTrgtKey : fileTrgtKey
		}

		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
		
    });  /* document.ready */

    // 거래처 검색 함수
    function openSecondClntSearch(searchValue) {    	
    	//등록일 경우만 팝업처리
//  		if (actionType == "C") {
			var paramObj = {
                "searchValue" : searchValue,
                "clntDivCd"   : "CLNTDIV12"
            };
	        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
	            var row = grid.target.getList("selected")[0];

	            $('#ordrsClntCd').val(row.clntCd);
	            $('#ordrsClntNm').val(row.clntNm);
	            
	            //$('#clntPjt').val(row.clntPjt);
	            
	            var paramObj = {
	                "coCd": $('#coCd').val(),
	                "clntCd": row.clntCd
	            }
	            setMngInfo(paramObj);
	            $('#newOrdrsNo').val('');
				
	            setDetailButton();

	        });
//  		}
    }

    function openSecondEstSearch(searchValue) {
        var aordrsDiv = $("#ordrsDiv").val();
        
        //등록이거나 수주구분이 정상수주일 경우만 팝업처리
		if (actionType == "C" && aordrsDiv == "ORDRSDIV1" ) {
            var paramObj = {
                "searchValue" : searchValue,
                "coCd" : $('#coCd').val()
            };
            // openSecondModal("/static/html/cmn/modal/estSearchWithOrdrs.html", 600, 420, "견적서 검색", {searchValue: searchValue}, function (grid) {
            openSecondModal("/static/html/cmn/modal/estSearch.html", 1200, 420, "견적서 검색", paramObj, function (grid) {
	            var row = grid.target.getList("selected")[0];

	            $('#estNoOrdrs').val(row.estNo);
	            $('#coCd').val(row.coCd);
	            $('#estDeg').val(row.estDeg);
	            $('#currCd').val(row.currCd);
	            $('#ordrsClntCd').val(row.estClntCd);
	            $('#ordrsClntNm').val(row.estClntNm);
	            $('#clntPjt').val(row.clntPjt);
	            $('#ordrsAmt').val(row.estAmt);
	            var paramObj = {
	                "coCd": $('#coCd').val(),
	                "clntCd": row.estClntCd
	            }
	           setMngInfo(paramObj);
	        });
		}
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {
                $('#mngId').val(data.mngInfo.salesEmpId);
                $('#mngIdNm').val(data.mngInfo.salesEmpNm);
            } else {
                // $('#mngId').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch() {
    	//등록일 경우만 팝업처리
		if (actionType == "C") {
	        var paramObj = {
	            "coCd"   : $('#coCd').val(),
	            "userId" : $('#salesEmpId').val(),
	            "userNm" : $('#salesEmpNm').val(),
	            "useYn"  : "Y"
	        };
	
	        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
	            var checkedId = tree.get_checked()[0];
	            var checkedNode = tree.get_node(checkedId);
	            $("#salesEmpId").val(checkedNode.id);
	            $("#salesEmpNm").val(checkedNode.text);
	        });
		}
    }

    // 폼 데이터 생성 함수
    function makeFormData() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#exrate,#ordrsAmt'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });
        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);
        formData.append("ordrsNo", $("#ordrsNo").val());
        // 유저아이디 추가
       // formData.append("userId", jwt.userId);

        //---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#ordrsClntCd').val());			//첨부화일용
		formData.append("prdtCd" , $('#prdtCd').val(""));			//첨부화일용
		formData.append("itemCd" , $('#itemDiv').val(""));			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------

        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                formData.append(elem, JSON.elem.value);
            });
        });     
        
        var rowListPlan = gridOrdrsPlan.getList();
        var rowListDetail = gridOrdrsDetail.getList();

        var planArr = [];
        var detailArr = [];
        let clmnDtCnt = 0;
        
        if($("#ordrsDiv").val() == "ORDRSDIV3"){ //무상AS start
        }else{
        	
        //수금내역
        if (rowListPlan.length == 0) {
        	commaChange();
            alert("수금내역을 확인해 주세요?");
            return false;
        }

        $.each(rowListPlan, function (idx, elem) {
            var planObj = {};

            planObj["clmnPlanSeq"] = idx + 1;
            planObj["clmnPlanDiv"] = elem.clmnPlanDiv;
            planObj["clmnDivSeq"] = elem.clmnDivSeq;
            planObj["clmnRate"] = elem.clmnRate;
            // planObj["clmnAmt"] = parseInt(elem.clmnAmt.replace(/,/g, ''));
            planObj["clmnAmt"] = elem.clmnAmt;

            let clmnDt = new Date(elem.clmnDt);

            if(isNaN(clmnDt)){
            	clmnDtCnt++;
             }
             
            let pmntDtAfterBill = parseInt(elem.pmntDtAfterBill, 10); // 문자열을 숫자로 변환

            // clmnDt에서 pmntDtAfterBill를 뺍니다.
            clmnDt.setDate(clmnDt.getDate() - pmntDtAfterBill);

            // Date 객체를 YYYY-MM-DD 형식의 문자열로 변환
            let convertDateToString = function (dateObj) {
                let month = '' + (dateObj.getMonth() + 1),
                    day = '' + dateObj.getDate(),
                    year = dateObj.getFullYear();

                if (month.length < 2)
                    month = '0' + month;
                if (day.length < 2)
                    day = '0' + day;

                return [year, month, day].join('-');
            };

            // 계산된 날짜를 billPblsDt에 할당 일자없으면 null로 세팅
            if(isNaN(pmntDtAfterBill)){
            	planObj["billPblsDt"] = "";
            	planObj["pmntDtAfterBill"] = "";
            }else{
	            planObj["billPblsDt"] = convertDateToString(clmnDt);
	            planObj["pmntDtAfterBill"] = pmntDtAfterBill;
            }
            planObj["clmnDt"] = elem.clmnDt;
            planObj["clmnMgmtStatus"] = elem.clmnMgmtStatus;

            planArr.push(planObj);

        });
        
        if(clmnDtCnt > 0){
	       	 commaChange();
           	 alert("수금예정일자가 없습니다.");
             return false;
        }

        // clmnAmt 합계 계산
        var totalClmnAmt = 0;
        $.each(planArr, function (idx, elem) {
            totalClmnAmt += parseFloat(elem.clmnAmt);
        });

        // input box 값과 비교
        var inputAmtVal = pasIntChk($("#ordrsAmt").val());

        if (totalClmnAmt != inputAmtVal) {
        	if($("#ordrsDiv").val() != "ORDRSDIV3"){
	        	commaChange();
	            alert("수주금액과 수금계획금액 합계가 일치하지 않습니다.");
	            return false;
        	}
        }
        
      } //무상AS end

        if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) { //투루넷,건양 start
        }else{
        	
            //설비&원가 정보
            if (rowListDetail.length == 0) {
            	commaChange();
                alert("주문 세부 내역이 없습니다.");
                return false;
            }

            var totalLaborCostMfgCost = 0;
            var totalMachineValueAfterDeduction = 0;
            let orgnSalesCdCnt = 0;

            $.each(rowListDetail, function (idx, elem) {
                var detailObj = {
                        "ordrsSeq": idx + 1,
                        "ordrsDtlDiv10": elem.ordrsDtlDiv10,
                        "ordrsDtlDiv20": elem.ordrsDtlDiv20,
                        "ordrsDtlDiv30": elem.ordrsDtlDiv30,
                        "orgnSalesCd": elem.orgnSalesCd,
                        "mctype": elem.mctype,
                        "prdtCd": elem.prdtCd,
                        "itemDiv": elem.itemDiv,
                        "salesCd": elem.salesCd || '', 
                        "eqpNm": elem.eqpNm,
                        "dudtIntendDt": elem.dudtIntendDt,
                        "dtlRmk": elem.dtlRmk,
                        "ordrsPrcMach": pasIntChk(elem.ordrsPrcMach),
                        "ordrsPrcElcty": pasIntChk(elem.ordrsPrcElcty),
                        "ordrsPrc": pasIntChk(elem.ordrsPrcMach) + pasIntChk(elem.ordrsPrcElcty),
                        "ordrsQty": pasIntChk(elem.ordrsQty),
                        "estEpctMatPrc": pasIntChk(elem.estEpctMatPrc),
                        "trgtPchsPcostMach": pasIntChk(elem.trgtPchsPcostMach),
                        "trgtPchsPcostElcty": pasIntChk(elem.trgtPchsPcostElcty),
                        "trgtPchsPcostInHousePrcsn": pasIntChk(elem.trgtPchsPcostInHousePrcsn),
                        "machineValueAfterDeduction": pasIntChk(elem.trgtPchsPcostMach) - pasIntChk(elem.trgtPchsPcostInHousePrcsn),
                };
                
                let orgnSalesCode = elem.orgnSalesCd;
                let ordrsDtlDiv20 = elem.ordrsDtlDiv20;
                let ordrsDtlDiv30 = elem.ordrsDtlDiv30;
                let mctype = elem.mctype;
                let prdtCd = elem.prdtCd;
                let itemDiv = elem.itemDiv;
                let eqpNm = elem.eqpNm;

     			if(orgnSalesCode == '' || orgnSalesCode == undefined){
                 	detailObj["orgnSalesCd"] = "";
                 }
     			if(ordrsDtlDiv20 == '' || ordrsDtlDiv20 == undefined){
                 	detailObj["ordrsDtlDiv20"] = "";
                 }
     			if(ordrsDtlDiv30 == '' || ordrsDtlDiv30 == undefined){
                 	detailObj["ordrsDtlDiv30"] = "";
                 }
     			if(mctype == '' || mctype == undefined){
                 	detailObj["mctype"] = "";
                 }
     			if(prdtCd == '' || prdtCd == undefined){
                 	detailObj["prdtCd"] = "";
                 }
     			if(itemDiv == '' || itemDiv == undefined){
                 	detailObj["itemDiv"] = "";
                 }
     			if(eqpNm == '' || eqpNm == undefined){
                 	detailObj["eqpNm"] = "";
                 }

                var laborCostMfgCost = pasIntChk(elem.laborCostMfgCost);
                var machineValueAfterDeduction = pasIntChk(detailObj["machineValueAfterDeduction"]);

                detailObj["laborCostMfgCost"] = laborCostMfgCost;
                detailObj["machineValueAfterDeduction"] = machineValueAfterDeduction;

                totalLaborCostMfgCost += laborCostMfgCost;
                totalMachineValueAfterDeduction += machineValueAfterDeduction;
                
                detailArr.push(detailObj);
            });
            
//    	    if(orgnSalesCdCnt > 0){
//    	        commaChange();
//    	     	alert("원천SalesCode가 없습니다.");
//    	         return false;
//    	     }

            // clmnAmt 합계 계산
            var totalClmnAmt = 0;
            $.each(detailArr, function (idx, elem) {
                totalClmnAmt += parseFloat(elem.ordrsPrcMach);
                totalClmnAmt += parseFloat(elem.ordrsPrcElcty);
            });

            // input box 값과 비교
            // var inputAmtVal = pasIntChk($("#ordrsAmt").val());
            var inputAmtVal = pasIntChk($("#exchangeAmt").val());
            
            if (totalClmnAmt != inputAmtVal) {
            	if($("#ordrsDiv").val() != "ORDRSDIV3"){
                	commaChange();
                    alert("수주금액과 수주가합계가 일치하지 않습니다.");
                    return false;
            	}
            }
            
            var totalSum = totalLaborCostMfgCost + totalMachineValueAfterDeduction; //laborCostMfgCost(금액)+machineVVauleAfterDeduction(차감 후 기계값)
            var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
        
        } //투루넷,건양 end
        
        formData.append("planArr", JSON.stringify(planArr));
        formData.append("detailArr", JSON.stringify(detailArr));
        
        return formData;
    }


    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#estCoprt').data("rprc", value);
        $('#estCoprt option:not([value=""])').remove()
        setCommonSelect($('#estCoprt'));
    }


    /* 그리드 관련 함수 */
    // 그리드 생성
    const gridOrdrsPlan = new ax5.ui.grid();
    
    gridOrdrsPlan.setConfig({
        			target : $('[data-ax5grid="first-grid-modal"]'),
                    header: {
                        align: "center",
                        selector: false
                    },
                    columns: [
                        {key: "seq", label: "번호", width: 40, align: "center", formatter: function () {return this.item.__index + 1;},},
                        { key: "clmnPlanDiv",   label: "수금구분", align: "center",  width: 70, editor: { type: 'select',
                            config: {
                                columnKeys: { optionValue: 'CD', optionText: 'NM' },
                                options : comboClmnPlanDiv
                              } }, formatter : function()  {return getComboName(comboClmnPlanDiv, this)}
                          },
                        {key: "clmnDivSeq", label: "차수", width: 50, align: "center", editor: {type: "text"}},
                        {key: "clmnRate", label: "비율", width: 50, align: "center", editor: {type: "number"}},
                        {key: "clmnAmt",label: "수금계획금액", width: 110, align: "right", editor: {type: "number"}, formatter: "money"},
                        {key: "clmnDt", label: "수금예정일자", width: 100, align: "center", 
                        	editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" }}}}
                        },
                        {key: "pmntDtAfterBill", label: "계산서 발행 후 지급시기(단위: 일)", width: 180, align: "center", editor: {type: "number"}},
                        {key: "billPblsDt", label: "계산서발행예정일", width: 100, align: "center", editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" } } }},
                            formatter: function () {
                                var clmnDt = new Date(this.item.clmnDt || new Date());
                                clmnDt.setDate(clmnDt.getDate() - (this.item.pmntDtAfterBill || 0));
                                var month = String(clmnDt.getMonth() + 1).padStart(2, '0');
                                var day = String(clmnDt.getDate()).padStart(2, '0');
                                var year = clmnDt.getFullYear();
                                return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
                            }
                        },
                        {key: "매출확정합계", label: "매출확정금액", width: 120, align: "right", formatter: "money", 	styleClass: function () {
                        		return (pasIntChk(this.item.clmnAmt) < pasIntChk(this.item.매출확정합계)) ? "grid-font-red" : "grid-font-blue";}},
                        {key: "세금계산서합계", label: "계산서발행금액", width: 120, align: "right", formatter: "money", 	styleClass: function () {
			            		return (pasIntChk(this.item.clmnAmt) < pasIntChk(this.item.세금계산서합계)) ? "grid-font-red" : "grid-font-blue";}},
                        {key: "수금합계", label: "수금금액", width: 120, align: "right", formatter: "money", 	styleClass: function () {
			            		return (pasIntChk(this.item.clmnAmt) < pasIntChk(this.item.수금합계)) ? "grid-font-red" : "grid-font-blue";}},
                        {key: "zzzz", label: "미수잔액", width: 120, align: "right", 
                            formatter: function () {return addCommaStr(pasIntChk(this.item.clmnAmt) - pasIntChk(this.item.수금합계));}, 
                            styleClass: function () {return "grid-font-blue";}},
                        {key: "clmnMgmtStatus", label: "수금관리상황", width: 370, align: "left", editor: {type: "text"}},
                    ],
                    footSum: [
                        [
                        {label: "수금합계", align: "center", colspan: 3},
                        {key: "clmnRate", collector: "sum", formatter: "money", align: "right"},
                        {key: "clmnAmt", collector: "sum", formatter: "money", align: "right"},
                        {colspan: 3},
                        {key: "매출확정합계", collector: "sum", formatter: "money", align: "right"},
                        {key: "세금계산서합계", collector: "sum", formatter: "money", align: "right"},
                        {key: "수금합계", collector: "sum", formatter: "money", align: "right"},
                        {key: "zzzz", collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.clmnAmt) - pasIntChk(n.수금합계));
                            });
                            return addCommaStr(value);
                        }, formatter: "money", align: "right"},
                    	]
                    ],
                    page : {
	   					display: false,
		   			},
                    body: {

                        onClick: function () {
                            this.self.clearSelect();
                            this.self.select(this.dindex);
                            selectedRowKey = this.dindex;
                        },

                        onDataChanged: function () {
                        	if( this.key == "clmnAmt" || this.key == "clmnRate" ) {
	                            
                                const ordrsAmt = pasIntChk($("#ordrsAmt").val());
	                            if( this.key == "clmnAmt" ) {
	                                const clmnAmt = parseInt(this.value);
	                                this.value = clmnAmt;
	                                if (!isNaN(clmnAmt) && !isNaN(ordrsAmt)) {
	                                	this.item.clmnRate = ordrsAmt !== 0 ? parseInt((clmnAmt / ordrsAmt * 100 + 0.5) ) : 0;
	                                }
	                            }
	                            if( this.key == "clmnRate" ) {
	                                const clmnRate = parseInt(this.value);
	                                this.value = clmnRate;
	                                if (!isNaN(clmnRate) && !isNaN(ordrsAmt)) {
	                                	this.item.clmnAmt = parseInt(clmnRate * ordrsAmt / 100 + 0.5);
	                                }
	                            }
	                            var data = gridOrdrsPlan.getList();
	                            var totalRate = 0;
	                            var totalAmt = 0;
	                            for (var i = 0; i < data.length; i++) {
	                                totalRate += parseInt(data[i].clmnRate);
	                                totalAmt += parseInt(data[i].clmnAmt);
	                            }
                                if (totalRate > 100) {
                                    alert('비율의 합계는 100%를 초과할 수 없습니다.');
                                }
                                if (totalAmt > ordrsAmt) {
                                    alert('수금금액의 합계는 주문 금액을 초과할 수 없습니다.');
                                }
                        	}
                            gridOrdrsPlan.repaint();
                        }
                    },
                    contextMenu: {
                        iconWidth: 20,
                        acceleratorWidth: 100,
                        itemClickAndClose: false,
                        icons: {
                            'arrow': '<i class="fa fa-caret-right"></i>'
                        },
                        items: [
                            {type: 1, label: "붙여넣기"},
                            {divide: true},
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ],
                        popupFilter: function (item, param) {
                            //console.log(item, param);
                            if (param.element) {
                                return true;
                            } else {
                                return item.type == 1;
                            }
                        },
                        onClick: function (item, param) {
                            // console.log(item, param);
                            thisGridRow = param.dindex;
                            thisGridCol = param.colIndex;

                            if (item.label == "붙여넣기") {
                                gridPaste(gridOrdrsPlan, thisGridRow, thisGridCol);
                            } else if (item.label == "줄추가") {
                                // console.log('추가 인덱스 :', param.dindex);
                                //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                                gridOrdrsPlan.addRow($.extend({}, gridOrdrsPlan.list[param.dindex], {__index: undefined}), param.dindex + 1,);

                            } else if (item.label == "내용 삭제") {
                                // console.log('내용삭제 인덱스 :', param.dindex);

                                gridOrdrsPlan.config.columns.forEach((column) => {
                                    gridOrdrsPlan.setValue(param.dindex, column.key, '');
                                    // console.log('내용삭제 :', param.dindex, column.key);
                                });

                            } else if (item.label == "줄삭제") {
                                // console.log('삭제 인덱스 :', param.dindex);
                                gridOrdrsPlan.removeRow(param.dindex);
                            }
                            gridOrdrsPlan.contextMenu.close();
                        }
                    },


                });

    function calclateTotalClmnAmt () {
        var ordrsAmt = pasIntChk($("#ordrsAmt").val());
        var data = gridOrdrsPlan.getList();
        var totClmnAmt = 0; 
        for (var i = 0; i < data.length; i++) {
            data[i].clmnAmt = parseInt(ordrsAmt * pasIntChk(data[i].clmnRate) / 100 + 0.5); 
            totClmnAmt += data[i].clmnAmt; 
        }
        data[data.length-1].clmnAmt += ordrsAmt - totClmnAmt; //오더금액과 수금금액 차이는 마지막 수금에 포함 처리
        
        gridOrdrsPlan.setData(data);
    } 

    $("#ordrsAmt").change(function () {
        calclateTotalClmnAmt();

    }); 
    
    //견적서번호 지울경우 견적차수도 지워지게 처리
    $("#estNoOrdrs").change(function () {
    	var ordNo = $("#estNoOrdrs").val()
    	if (isNaN(ordNo) || ordNo == ""){
    		$("#estDeg").val("");
    	}
    });
    
    // //선물환기입check리스트 NG일떄 계약문서칸 사용못하게 해야함
    // $("#fwdExchChkList").change(function () {
	//     var fwdExchChkList = $("#fwdExchChkList").val();
	//     if(fwdExchChkList == "N"){
	// 		//내용 삭제 후 비활성화	    	
	//     	$("#ctrtDoc").val("");
	//     	$('#ctrtDoc').prop('disabled', true);
	//     }else{
	//     	$('#ctrtDoc').prop('disabled', false);
	//     }
    // });
    
    //Select 선택 코드값 체크하여 명을 출력
    function getComboName(comboArray, key) {
	    let rtnNm = "";
	    for (const element of comboArray) {
	        if (key.value == element.CD)  {
	            rtnNm = element.NM;
	            break;
	        }
	    }
	    return rtnNm;
	}
    
    const gridOrdrsDetail = new ax5.ui.grid();
    
    gridOrdrsDetail.setConfig({
        multipleSelect: false,
        target : $('[data-ax5grid="second-grid-modal"]'),
        header: {
            align: "center",
            selector: false
        },
        // frozenColumnIndex: 8,
        columns: [
            {key: "seq", 			label: "No", 		width: 40, align: "center", formatter: function () { return this.item.__index + 1; }},
            {key: "ordrsDtlDiv10", 	label: "입력구분", 	width: 60, align: "center", editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboOdd1
                  } }, formatter : function()  {return getComboName(comboOdd1, this)}},
            {key: "orgnSalesCd",	label: "원천SalesCode", 	align: "center", width: 110},
            {key: "prdtCd", 		label: "제품구분", 	align: "center", width: 60},
            {key: "itemDiv", 		label: "아이템구분", 	align: "center", width: 80, editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboItemList
                  } }, formatter : function()  {return getComboName(comboItemList, this)}},
            {key: "ordrsDtlDiv20", 	label: "작업구분", 	align: "center", width: 60, editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboOdd2
                  } }, formatter : function()  {return getComboName(comboOdd2, this)}},
            {key: "ordrsDtlDiv30", 	label: "자체구분", 	align: "center", width: 60, editor: { type: 'select',
                config: {
                    columnKeys: { optionValue: 'CD', optionText: 'NM' },
                    options : comboOdd3
                  } }, formatter : function()  {return getComboName(comboOdd3, this)}},
            {key: "mctype", 	label: "기계구분", 	align: "center", width: 60, editor: { type: 'select',
               config: {
                   columnKeys: { optionValue: 'CD', optionText: 'NM' },
                   options : comboOdd4
                 } }, formatter : function()  {return getComboName(comboOdd4, this)}},
            {key: "dataChk", 		label: "비활성화체크",	align: "center", width: 40, hidden: true},
            {key: "salesCd", 	 label: "sales Code", 	align: "center", width: 120},
            {key: "eqpNm", 			label: "설비명", 		align: "center", width: 255, editor: {type: "text"}},
            {key: "dudtIntendDt",   label: "납기예정일", width: 100, align: "center", editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" } } }},
                formatter: function () {
                	//기존 데이터 있으면
					if(this.item.dudtIntendDt){
		                var dudtIntendDt = new Date(this.item.dudtIntendDt);
	                    var month = String(dudtIntendDt.getMonth() + 1).padStart(2, '0');
	                    var day = String(dudtIntendDt.getDate()).padStart(2, '0');
	                    var year = dudtIntendDt.getFullYear();
	                    return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
					}else{
					//기존 데이터 없으면				
						if(actionType == "C"){//등록시 오늘날짜 기본으로
							var dudtIntendDt = new Date();
		                    var month = String(dudtIntendDt.getMonth() + 1).padStart(2, '0');
		                    var day = String(dudtIntendDt.getDate()).padStart(2, '0');
		                    var year = dudtIntendDt.getFullYear();
		                    return `${year}-${month}-${day}`;  // returns date in 'YYYY-MM-DD' format
						}else{//수정시는 없는 건 없는 것
							return null;
						}
					}
                }
            },
            {key: undefined, 		label: "수주가", columns: [
                    {key: "ordrsPrcMach", label: "기계PART", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                    {key: "ordrsPrcElcty", label: "전기PART", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                    {key: "ordrsPrc", label: "합계", align: "right", width: 80,
                        formatter: function () {return addCommaStr(pasIntChk(this.item.ordrsPrcMach) + pasIntChk(this.item.ordrsPrcElcty));}, 
                        styleClass: function () {return "grid-font-blue";} },
                ]},
            {key: "ordrsQty", label: "수량", align: "right", width: 40, editor: {type: "number"}},
            {key: "estEpctMatPrc", label: "견적 예상 재료비",align: "right", width: 110, editor: {type: "number"}, formatter: "money"},
            {key: undefined, label: "목표구매원가", columns: [
                    {key: undefined, label: "목표구매원가", columns: [
                        	{ key: "trgtPchsPcostMach", label: "기계", align: "right", width: 110, editor: {type: "number"}, formatter: "money"},
                            { key: "trgtPchsPcostElcty", label: "전기", align: "right", width: 110, editor: {type: "number"} , formatter: "money"},
                            { key: "trgtsum", label: "합계", align: "right", width: 100,
                                formatter: function () {return addCommaStr(pasIntChk(this.item.trgtPchsPcostMach) + pasIntChk(this.item.trgtPchsPcostElcty));}, 
                                styleClass: function () {return "grid-font-blue";}, },
                        ] },
                    {key: undefined, label: "자체가공 투입시 기계부문 목표원가", columns: [
                            {key: "trgtPchsPcostInHousePrcsn", label: "자체 가공", align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
                            {key: "machineValueAfterDeduction", label: "차감 후 기계값", align: "right", width: 100, formatter: function () {return addCommaStr(pasIntChk(this.item.trgtPchsPcostMach) - this.item.trgtPchsPcostInHousePrcsn);}, 
                                styleClass: function () {return "grid-font-blue";},},
                        ]}
                ]
            },

            {key: undefined, label: "실집행 원가", columns: [
                    {key: undefined, label: "노무비 및 제조경비(판관비 제외)", columns: [
                            {key: "laborCostMfgCost", label: "금액", align: "right", width: 130, editor: {type: "number"}, formatter: "money" },
                        ]}
                ]},
        	{key: "dtlRmk",      label: "비고", align: "left", width: 120, editor: {type: "text"}},
        ],
        footSum: [
                  [
                      {label: "총합계", align: "center", colspan: 11},
                      {key: "ordrsPrcMach", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrcElcty", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrc", collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.ordrsPrcMach) + pasIntChk(n.ordrsPrcElcty));
                            });
                            return addCommaStr(value);
                        },  align: "right"},
                      {key: "ordrsQty", collector: "sum", formatter: "money", align: "right"},
                      {key: "estEpctMatPrc", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtPchsPcostMach", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtPchsPcostElcty", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtsum",  collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.trgtPchsPcostMach) + pasIntChk(n.trgtPchsPcostElcty));
                            });
                            return addCommaStr(value);
                        },  align: "right"},
                      {key: "trgtPchsPcostInHousePrcsn", collector: "sum", formatter: "money", align: "right"},
                      {key: "machineValueAfterDeduction", collector: function () {
                            var value = 0;
                            this.list.forEach(function (n) {
                                if (!n.__isGrouping) value += (pasIntChk(n.trgtPchsPcostMach) - pasIntChk(n.trgtPchsPcostInHousePrcsn));
                            });
                            return addCommaStr(value);
                        }, align: "right"},
                      {key: "laborCostMfgCost", collector: "sum", formatter: "money", align: "right"},
                  ]
        ],
        body: {
            onClick: function () {
                this.self.select(this.dindex);
                thisGridRow = this.dindex;
                thisGridCol = this.colIndex;
                selectedRowKey2 = this.dindex;
               
                // 제품구분(prdtCd)이거나 등록일 경우에만 실행하도록
                if (this.column.key == 'prdtCd' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010') {
                // if (this.column.key == 'prdtCd' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010' && this.item.dataChk != 'U') {
                // if (this.column.key == 'prdtCd' && actionType == 'C' && this.item.ordrsDtlDiv10 == 'ORDRSDTLDIV1010' && this.item.dataChk != 'U') {
                    openSecondPrdtSearch();       
                }

                if (this.column.key == 'orgnSalesCd') {
//                	if($('#ordrsDiv').val() == "ORDRSDIV1"){
//                		gridOrdrsDetail.setValue(this.dindex, "orgnSalesCd", "");
//                		return;
//                	}
                    openSalesCdSearch();
                }

            },
            columnHeight: 26,
            onDataChanged: function () {
            	var row = this.dindex;
			    var col = this.colIndex;
			    
			    switch (this.key) {
			        case 'ordrsPrcMach':
			        	this.item.ordrsPrcMach = pasIntChk(this.value);
			            // this.item.ordrsPrc = parseInt(this.item.ordrsPrcMach + this.item.ordrsPrcElcty); 
			            gridOrdrsDetail.setValue(row, "ordrsPrc", parseInt(this.item.ordrsPrcMach + this.item.ordrsPrcElcty));
			            break;
			        case 'ordrsPrcElcty':
			        	this.item.ordrsPrcElcty = pasIntChk(this.value);
			            this.item.ordrsPrc = parseInt(this.item.ordrsPrcMach + this.item.ordrsPrcElcty);
			            break;
			        case 'trgtPchsPcostMach':
			        	this.item.trgtPchsPcostMach = pasIntChk(this.value);
			            this.item.sum = parseInt(this.item.trgtPchsPcostMach + this.item.trgtPchsPcostElcty);
			            break;
			        case 'trgtPchsPcostElcty':
			        	this.item.trgtPchsPcostElcty = pasIntChk(this.value);
			            this.item.sum = parseInt(this.item.trgtPchsPcostMach + this.item.trgtPchsPcostElcty);
			            break;
			        case 'trgtPchsPcostInHousePrcsn':
			        	this.item.trgtPchsPcostInHousePrcsn = pasIntChk(this.value);
			            this.item.machineValueAfterDeduction = parseInt(this.item.trgtPchsPcostMach - this.item.trgtPchsPcostInHousePrcsn);
			            break;
			        case 'trgtPchsPcostElcty':
			        	this.item.trgtPchsPcostElcty = pasIntChk(this.value);
			            break;
			        case 'ordrsQty':
			        	this.item.ordrsQty = pasIntChk(this.value);
			            break;
			        case 'estEpctMatPrc':
			        	this.item.estEpctMatPrc = pasIntChk(this.value);
			            break;
			        case 'laborCostMfgCost':
			        	this.item.laborCostMfgCost = pasIntChk(this.value);
			            break;
			    }
                
                //입력구분이고 해당 값이 저게 아닐때 해당셀을 빈값으로 세팅
//                if (this.key == 'ordrsDtlDiv10' && this.item.ordrsDtlDiv10 != 'ORDRSDTLDIV1010') {
                if (this.key == 'ordrsDtlDiv10') {
                    gridOrdrsDetail.setValue(row, 'orgnSalesCd', "");
                    gridOrdrsDetail.setValue(row, 'prdtCd', "");
                	gridOrdrsDetail.setValue(row, 'itemDiv', "");
                	gridOrdrsDetail.setValue(row, 'ordrsDtlDiv20', "");
                	gridOrdrsDetail.setValue(row, 'ordrsDtlDiv30', "");
                	gridOrdrsDetail.setValue(row, 'mctype', "");
                	gridOrdrsDetail.setValue(row, 'eqpNm', "");
                }
                
                var currEndRow = currGridEndRow();
                // gridOrdrsDetail.repaint(); 
                
			    // if (beforeGridSize != gridOrdrsDetail.list.length) {
                    //row focus 처리용
                    // var gridStatus = $('.popup_area [data-ax5grid="second-grid-modal"] [data-ax5grid-page="status"]').text().trim();
                    // var gridStatusIdx = gridStatus.indexOf(' ');
                    // var topRow = gridStatus.slice(0, gridStatusIdx).trim();
                    // gridOrdrsDetail.focus(topRow);  
                    // console.log(topRow, row);
                    // debugger;
                    
                    // const data = gridOrdrsDetail.getList();
                    // gridOrdrsDetail.setData(data);
                    // gridResize(gridOrdrsDetail.list.length); //그리드 높이 조정
                    // beforeGridSize = gridOrdrsDetail.list.length;
                    // gridOrdrsDetail.focus(row);  
                     
                    resetGridFocus(currEndRow, thisGridRow);
			    // }
                gridOrdrsDetail.repaint();
            }
        },
        contextMenu: {
            iconWidth: 20,
            acceleratorWidth: 100,
            itemClickAndClose: false,
            icons:
                {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
            items: [
                {type: 1, label: "붙여넣기"},
                {divide: true},
                {type: 1, label: "줄추가"},
                {type: 1, label: "내용 삭제"},
                {type: 2, label: "줄삭제"},
            ],
            popupFilter:

                function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
            onClick: function (item, param) {
  
                thisGridRow = param.dindex;
                thisGridCol = param.colIndex;

                if (item.label == "붙여넣기") {
                    gridPaste(gridOrdrsDetail, thisGridRow, thisGridCol);
                } else if (item.label == "줄추가") {
                    // console.log('추가 인덱스 :', param.dindex);
                    //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                    gridOrdrsDetail.addRow($.extend({}, gridOrdrsDetail.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                    gridOrdrsDetail.focus(param.dindex + 1);

                } else if (item.label == "내용 삭제") {
                    // console.log('내용삭제 인덱스 :', param.dindex)
                    // gridOrdrsDetail.config.columns.forEach((column) => {
                    gridOrdrsDetail.colGroup.forEach((column) => {
                        gridOrdrsDetail.setValue(param.dindex, column.key, '');
                        // console.log('내용삭제 :', param.dindex, column.key);
                    });

                } else if (item.label == "줄삭제") {
                    // console.log('삭제 인덱스 :', param.dindex);
                    gridOrdrsDetail.removeRow(param.dindex);
                    //삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
                }

                gridOrdrsDetail.contextMenu.close();
                //또는 return true;
            }
        }

    });

    var actionType = modalStack.last().paramObj.actionType;
    var paramObj = modalStack.last().paramObj;

    var deleteFileArr = [];
    var selectedNodeId = "";
    var fileTrgtTyp = "";

    if (actionType == "C") {
        //회사 기본값지정
		if(modalStack.last().paramObj.coCd == '' || modalStack.last().paramObj.coCd == undefined){
			$("#coCd").val(jwt.coCd);
		}else{
			$("#coCd").val(modalStack.last().paramObj.coCd);
			//회사 비활성화
			$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		}

        $('#createHistoryDiv').removeClass("contents_tit")
        $('#createHistory').hide();
        
        setInitInsert();
        
        $('#actionOrdrsBtn').on("click", function () {
            insertOrdrs();
        });
    } else if (actionType == "U") {
    	//타이틀명 변경
		$('#cr02PopTit').text('수주 수정')
		
		//버튼명 변경
		$('#actionOrdrsBtn').text("수정");
        $('#actionOrdrsBtn').on("click", function () {
            updateOrdrs();
        });
        
		//회사 비활성화
		$('#popForm .coCd').removeClass('hit');
		$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//견적서번호 비활성화
		// $('#popForm .estNoOrdrs').removeClass('hit');
		// $('#estNoOrdrs').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//수주일자 비활성화
		// $('#popForm .ordrsDt').removeClass('hit');
		// $('#ordrsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//고객사 비활성화
		// $('#popForm .ordrsClntNm').removeClass('hit');
		// $('#ordrsClntNm').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
		//수주금액 비활성화
		// $('#popForm .ordrsAmt').removeClass('hit');
		// $('#ordrsAmt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		
        $("#ordrsPlanHis").show();
        $('#pmntMtd').val('PMNTMTD01');

        postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {
            var parsedData = data;
            Object.keys(parsedData.ordrsInfo).forEach(function (key) {
                var inputField = document.getElementById(key == 'estNo' ? 'estNoOrdrs' : key);
                if (!inputField) return;

                var value = parsedData.ordrsInfo[key];

                switch (key) {
                //    case 'ordrsDiv':
                //        if (value == 'ORDRSDIV1') {
                //            $('#orgnSalesCdTd,#orgnSalesCdTh').hide();
                //        }
                //        else {
                //        	inputField.value = value || '';
                //        	$('#orgnSalesCdTd,#orgnSalesCdTh').show();
                //        }
                //        break;
                    case 'ordrsAmt':
                    case 'exrate':
                        inputField.value = addCommaStr(value);
                        break;
                    case 'exchangeAmt':
                        inputField.value = addCommaStr(value);
                        break;
                    default:
                        inputField.value = value || '';
                        break;
                }
            });

            
            //수정시  로드 될떄 gridOrdrsPlan 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var pmntPlans = data.ordrsInfo.plans;
            gridOrdrsPlan.setData({
                list: pmntPlans,
                page: {
                    totalElements: pmntPlans.length
                }
            });
            //수정시  로드 될떄 orderDetails 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var ordrsDetails = data.ordrsInfo.details;
            gridOrdrsDetail.setData({
                list: ordrsDetails,
                page: {
                    totalElements: ordrsDetails.length
                }
            });
	        gridResize(ordrsDetails.length); //그리드 높이 조정
	        monthCloseChk($('#ordrsDt').val());  //마감일통제
	        
	        setDetailButton();// 설비 & 원가 정보 버튼 통제
	        
			//최초값셋팅
			setInitSetting();
        });

    }
    
    $("#addPaymentButton").on("click", function () {
        var row;
		var newRowData = {
				clmnPlanDiv: "CLMNPLANDIV1",
				clmnDivSeq : 1,
				clmnRate : 0,
				clmnAmt : 0,
				clmnDt : "",
				pmntDtAfterBill : "",
				billPblsDt : "",
				clmnMgmtStatus : "",
		};

        var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
        var bordrsDiv = $("#ordrsDiv").val() //수주구분
        if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && bordrsDiv != 'ORDRSDIV3'){
        	alert("수주금액을 입력바랍니다.");
        	return false;
        } else {
		        // 첫 번째 경우: 선택된 행이 있는 경우
		        if (selectedRowKey !== undefined) {
		            let row = gridOrdrsPlan.getList("selected")[0];
		            let newRowData = $.extend({}, row, {__index: undefined, clmnRate: 0, clmnAmt: 0});
		            gridOrdrsPlan.addRow(newRowData, row.__index + 1);
		        }
		        // 두 번째 경우: 그리드가 비어 있는 경우
		        else if (gridOrdrsPlan.getList().length === 0) {
		            gridOrdrsPlan.addRow(newRowData, 0);
		        }
		        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
		        else {
		            gridOrdrsPlan.addRow(newRowData, gridOrdrsPlan.length);
		            return;
		        }
		
			        const data = gridOrdrsPlan.getList();
			        gridOrdrsPlan.setData({
			            list: data,
			            page: {
			                totalElements: data.length
			            }
			        });
        }
        prevData = JSON.parse(JSON.stringify(gridOrdrsPlan.getList()));
        // 여기에서 그리드 데이터가 준비된 후 실행하려는 코드를 추가할 수 있습니다.

    });

    $("#deletePaymentButton").on("click", function () {
        if (selectedRowKey !== undefined) {
            gridOrdrsPlan.removeRow(selectedRowKey);
            const data = gridOrdrsPlan.getList();
            gridOrdrsPlan.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                    gridOrdrsPlan.select(selectedRowKey);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey = selectedRowKey - 1;
                    gridOrdrsPlan.select(selectedRowKey);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });


    $("#addDetailButton").on("click", function () {
        var row;

		var newRowData = {
			ordrsDtlDiv10 : "ORDRSDTLDIV1010",
			prdtCd : "NVF",
			itemDiv : "ITEMLIST01",
			ordrsDtlDiv20 : "ORDRSDTLDIV2010",
			ordrsDtlDiv30 : "ORDRSDTLDIV3010",
			mctype : "MCT01",
			salesCd : "",
			eqpNm : "",
			ordrsPrcMach : 0,
			ordrsPrcElcty : 0,
			ordrsQty : 0,
			estEpctMatPrc : 0,
			trgtPchsPcostMach : 0,
			trgtPchsPcostElcty : 0,
			trgtPchsPcostInHousePrcsn : 0,
			laborCostMfgCost : 0,
		};
        var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
        var bordrsDiv = $("#ordrsDiv").val() //수주구분
      	//수주구분 : 정상수주가 아닐경우
        // if (bordrsDiv != 'ORDRSDIV1' && gridOrdrsDetail.getList().length >=1) {
        //     alert("수주구분이 A/S에서는 1줄만 추가 가능합니다.");
        //     return false;
        // }
        if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && bordrsDiv != 'ORDRSDIV3'){
        	alert("수주금액을 입력바랍니다.");
        	return false;
        } else {
		       	// 첫 번째 경우: 선택된 행이 있는 경우
		        if (selectedRowKey2 !== undefined) {
		            let row = gridOrdrsDetail.getList("selected")[0];
		            gridOrdrsDetail.addRow(row, gridOrdrsDetail.length);
			        gridResize(gridOrdrsDetail.list.length + 2); //그리드 높이 조정
		        }
		        else {
		            gridOrdrsDetail.addRow(newRowData, gridOrdrsDetail.length);
			        gridResize(gridOrdrsDetail.list.length + 2); //그리드 높이 조정
		        }
        }
    });


    $("#deleteDetailButton").on("click", function () {
        if (selectedRowKey2 !== undefined) {
            gridOrdrsDetail.removeRow(selectedRowKey2);
            const data = gridOrdrsDetail.getList();
            gridOrdrsDetail.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey2 < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                    gridOrdrsDetail.select(selectedRowKey2);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey2 = selectedRowKey2 - 1;
                    gridOrdrsDetail.select(selectedRowKey2);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey2 = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });


    function insertOrdrs() {
		if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) {
			if($('#newOrdrsNo').val() == ''){
				alert('건양ITT 수주번호를 선택해 주십시요.')
				fn_orderSearch();
				return false;
			}
		}
    
    	if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            if (formData) {
                openProgress(true);
                filePostAjax("/user/cr/cr02/insertOrdrs", formData, function (data) {
                    if (data.resultCode == 200) {
                        alert(data.resultMessage);
                        var odrSeq = data.odrSeq;
                        modalStack.close();
                        gridView.setData(0);
                    }else{
                    	alert(data.resultMessage);
                    } 
                });
            }
        	openProgress(false);
        }
    }

    function updateOrdrs() {

        if (inputValidation($('.popup_area [required]').not('#frameTable [required], #nonStockTable [required]'))) {
            var formData = makeFormData();
            if (formData) {
                openProgress(true);
                filePostAjax("/user/cr/cr02/updateOrdrs", formData, function (data) {
                    if (data.resultCode == 200) {
                        alert(data.resultMessage);
                        var odrSeq = $('#odrSeq').val();
                        modalStack.close();
                        gridView.setData(0);
                    }else{
                    	alert(data.resultMessage);
                    }
                });
            }
        	openProgress(false);
        }
    }

    //제품구분 찾기(그리드)
    function openSecondPrdtSearch() {
        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#estClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            var prdtCd = grid.target.getList("selected")[0].prdtCd;
            var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];
            var rowData = gridOrdrsDetail.getList()[rowIndex];
            rowData.prdtCd = prdtCd;
            gridOrdrsDetail.updateRow(rowData, rowIndex);
        });
    }
    
    //원천SalesCode 찾기(그리드)
    function openSalesCdSearch() {
        var paramObj = {
                "coCd" : $('#coCd').val(),
                "salesCd": $('#orgnSalesCd').val()
             };
             openSecondModal("/static/html/cmn/modal/SalesCodeItemSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
                 var row = grid.target.getList("selected")[0];
                 var rowIndex = gridOrdrsDetail.selectedDataIndexs[0];
                 var rowData = gridOrdrsDetail.getList()[rowIndex];
                 //설비인것만 세팅
     			if (rowData.ordrsDtlDiv10 == 'ORDRSDTLDIV1010'){
     				rowData = {
//     	        			ordrsDtlDiv10 : row.ordrsDtlDiv10,
     	        			prdtCd : row.prdtCd,
     	        			itemDiv : row.itemDiv,
     	        			ordrsDtlDiv20 : row.ordrsDtlDiv20,
     	        			ordrsDtlDiv30 : row.ordrsDtlDiv30,
     	        			orgnSalesCd : row.salesCd,
     	        			eqpNm : row.eqpNm,
     	        			ordrsPrcMach : 0,
     	        			ordrsPrcElcty : 0,
     	        			ordrsQty : 0,
     	        			estEpctMatPrc : 0,
     	        			trgtPchsPcostMach : 0,
     	        			trgtPchsPcostElcty : 0,
     	        			trgtPchsPcostInHousePrcsn : 0,
     	        			laborCostMfgCost : 0,
     	        			dataChk : "U"
     	        		};
      	            gridOrdrsDetail.updateRow($.extend({}, gridOrdrsDetail.list[rowIndex], rowData), rowIndex);    
    	            // gridOrdrsDetail.updateRow(rowData, rowIndex); 
     			}
     			else {
     				rowData = {
     	        			orgnSalesCd : row.salesCd,
     	        			dataChk : "U"
     	        		};
     				gridOrdrsDetail.updateRow($.extend({}, gridOrdrsDetail.list[rowIndex], rowData), rowIndex);
//     				alert("설비가 아닙니다.\n다시 선택해 주십시오.");
//     				return;
     			}
                 
             });
    }

    $("#ordrsPlanHis").click(function () {
        var paramObj = {
            "coCd": $("#coCd").val(),
            "ordrsNo": $("#ordrsNo").val(),
        };
        openSecondModal("/static/html/cmn/modal/ordrsPlanHisSearch.html", 1000, 420, "수금계획수정이력", paramObj, function (grid) {
        });
    })

    // 사용자 검색 함수
    function openSecondUserSearch(searchValue) {

        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        var paramObj = {
            "coCd": $('#coCd').val(),
            "userId": $('#mngId').val(),
            "userNm": $('#mngIdNm').val(),
            "useYn": "Y",
            "searchValue": searchValue
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#mngId").val(checkedNode.id);
            $("#mngIdNm").val(checkedNode.text);
            // $("#salesEmpNm").val(checkedNode.text);
            $("#mngId").focus();
            $("#mngId").trigger("click");
        });
    }

    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd').val(),
           "salesCd": $('#orgnSalesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/SalesCodeItemSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            //설비인것만 세팅
			if (row.ordrsDtlDiv10 == 'ORDRSDTLDIV1010'){
				var newRowData = {
	        			ordrsDtlDiv10 : row.ordrsDtlDiv10,
	        			prdtCd : row.prdtCd,
	        			itemDiv : row.itemDiv,
	        			ordrsDtlDiv20 : row.ordrsDtlDiv20,
	        			ordrsDtlDiv30 : row.ordrsDtlDiv30,
	        			// salesCd : row.salesCd,
	        			eqpNm : row.eqpNm,
	        			ordrsPrcMach : 0,
	        			ordrsPrcElcty : 0,
	        			ordrsQty : 0,
	        			estEpctMatPrc : 0,
	        			trgtPchsPcostMach : 0,
	        			trgtPchsPcostElcty : 0,
	        			trgtPchsPcostInHousePrcsn : 0,
	        			laborCostMfgCost : 0,
	        			dataChk : "U"
	        		};

	            gridOrdrsDetail.addRow(newRowData, 0);
	            gridOrdrsDetail.removeRow(1);
	               $('#orgnSalesCd').val(row.salesCd);  //SalesCd
	               $('#ordrsClntCd').val(row.ordrsClntCd); //고객코드
	               $('#ordrsClntNm').val(row.ordrsClntNm); //고객명
	               $('#clntPjt').val(row.clntPjt);    //고객사PJT
	            //  $('#prdtCd').val(row.prdtCd);   
	 			//  $('#prdtNm').val(row.prdtCdNm);
	            //  $('#itemDiv').val(row.itemDiv);
	            //  $('#itemDivNm').val(row.itemDivNm);
			}
			else {
				alert("설비가 아닙니다.\n다시 선택해 주십시오.");
				return;
			}
            
        });
    }


    function gridResize(size) {
	    if (beforeGridSize != size) {
		    var tagHeight = (size) * 27 + 123 ;
		    tagHeight = tagHeight > 750 ? 750 : tagHeight;
		    tagHeight = tagHeight < 300 ? 300 : tagHeight;
	
		    // $('[data-ax5grid="second-grid-modal"]').height(tagHeight);
		    // $('[data-ax5grid="second-grid-modal"] [data-ax5grid-container="root"]').height(tagHeight);
		    
		    gridOrdrsDetail.setHeight(tagHeight)
		    beforeGridSize = size;
	    }
    }

    function  gridPaste(thisGrid, thisGridRow, thisGridCol ) {
    	var pasteData = "";

    	navigator.clipboard.readText()
    		.then(pasteData => {
        //    console.log('클립보드에 저장된 값:', pasteData);
            if (pasteData == undefined || pasteData == "" || thisGridRow == undefined) {
                console.error('클립보드에 데이터가 없습니다.');
                return;
            }

    		// 붙여넣기할 데이터를 배열로 변환한다.
    		var pasteRows = pasteData.split("\n").map(function(row) {
    			return row.split("\t");
    		});
    		//복사대상의 마지막 배열의 값이 없으면 제외
    		if (pasteRows[pasteRows.length - 1] == "") pasteRows.splice(pasteRows.length - 1, 1);
    		
    		// 붙여넣기를 시작할 셀의 인덱스를 구한다.
    		var startRowIndex = thisGridRow;
    		var startColIndex = thisGridCol;
    		
    		// 붙여넣을 데이터의 행과 열 개수를 구한다.
    		var numRows = pasteRows.length;
    		var numCols = pasteRows[0].length;
    		
    		//그리드 컬럼정보를 가져와서 붙여넣기할때 위치정보로 사용한다.
    		tempColumns = thisGrid.colGroup;
    		for (var i = tempColumns.length - 1; i >= 0; i--) {
    		    if (tempColumns[i].hidden) {
    		        tempColumns.splice(i, 1); 
    		    }
    		}
    		var currGridData = thisGrid.list;
    		
    		//마지막자료와 같은 값으로 추가하고 ordrsSeq는 0으로 설정
    		//참조복사를 방지하기 위함
    		var tempData = JSON.parse(JSON.stringify(currGridData[thisGridRow]));
    		tempData.ordrsSeq = "0";
    		
    		// 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
    		for (var i = 0; i < numRows; i++) {
    			for (var j = 0; j < numCols; j++) {
    			  	//carriage return 문자 삭제
    			    var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
    			
    			    calRow = startRowIndex + i;
    				calCol = startColIndex + j;
    				if (calRow >= currGridData.length) {
						//참조복사를 방지하기 위함
    					let tempDataCopy = JSON.parse(JSON.stringify(tempData));
    					currGridData.push(tempDataCopy);
    		        } 
    		        var tkey = tempColumns[calCol].key;
    		        currGridData[calRow][tkey] = cellData;
    
    		    }
    		}
            var currEndRow = currGridEndRow();
    		thisGrid.setData(currGridData);
    		// gridResize(currGridData.length);
    		// thisGrid.focus(thisGridRow);
            resetGridFocus(currEndRow, thisGridRow);
      
    		})
    	    .catch(error => {
    	        console.log('클립보드 읽기 오류 발생:', error);
    	    });	  
    };        
 
    //환율 load
	var paramObj = {
					"userId" : jwt.userId
					, "codeKind" : "CURR"
				   };
	postAjax("/user/sm/sm02/selectCurrToday", paramObj, null , function(data) {
		if(data.resultList.length > 0 ) {
			currToday = data.resultList;
		}
	});     //user search ajax end
	
	//등록시 통화단위에 따른 환율 SET
	$('#popForm #currCd').on("change", function(){
		
		var ordrsAmtVal = pasIntChk($("#ordrsAmt").val()); //수주금액에 적힌 값
		if ((ordrsAmtVal == 0 || ordrsAmtVal == "") && $("#ordrsDiv").val() != 'ORDRSDIV3'){
			$('#currCd').val('CURR01');
        	alert("수주금액을 입력바랍니다.");
        	return;
        }
		if(actionType == "C" && $(this).val() != "" ) {
			var selVal = $(this).val();
			var exrate = currToday[selVal];
			var find = currToday.find(e => e.codeId === selVal);
			if( typeof(find.codeEtc) != "undefined" ) {
				$('#popForm #exrate').val(addCommaStr(find.codeEtc));	
				
				$('#exchangeAmt').val(addCommaStr(find.codeEtc*ordrsAmtVal));
			}
		} else if( actionType == "C" && $(this).val() == "" ) {
			$('#popForm #exrate').val('');
		}
	});
	
 	// Ctrl + V 단축키 이벤트 처리
	gridOrdrsDetail.$target.on("paste", function (e, a) {
		gridPaste(gridOrdrsDetail, thisGridRow, thisGridCol);
	});
 	
	function pasIntChk (value) {
		const cvtValue = parseInt(deleteCommaStr(value));
		return isNaN(cvtValue) ? 0 : cvtValue;
	}

    //그리드 수정후 현재 위치로 이동하기 위한 함수
    //상태바에서 시작 또는 마지막 표시 row를 산정함
    // resetGridFocus()와 분리한 이유는 화면에 기존 데이터 Refresh하기전 위치 위치 저장하기 위함
    function currGridEndRow() {
        //row focus 처리용 그리드 상태바에서 "30 - 53 of 59" 에서 시작 ROW 30, 마지막ROW 53임
        // var gridStatus = $('.popup_area [data-ax5grid="second-grid-modal"] [data-ax5grid-page="status"]').text().trim();
        // var gridStatusIdx = gridStatus.indexOf(' ');
        // var topRow = gridStatus.slice(0, gridStatusIdx).trim();
        // var regex = /-(.*?) of/; // '-'와 'of' 사이의 숫자를 찾는 정규 표현식
        // var match = regex.exec(gridStatus);

        // if (match && match.length > 1) {
        //     var gridDisplayEndRow = match[1].trim(); // '-'와 'of' 사이의 숫자를 가져옴
        // }
        //현재 표시하는 ROW정보 상태바에서 grid 함수내 값으로 대체
        var gridDisplayEndRow = gridOrdrsDetail.xvar.virtualPaintRowCount //화면출력 row수
                              + gridOrdrsDetail.xvar.virtualPaintStartRowIndex; //화면 출력 시작 Row index
        return gridDisplayEndRow < 4 ? 0 : gridDisplayEndRow - 3;
    }
    
    function resetGridFocus(endRow, row) {
        gridOrdrsDetail.focus(endRow);  
         
        gridResize(gridOrdrsDetail.list.length); //그리드 높이 조정
        beforeGridSize = gridOrdrsDetail.list.length;
        gridOrdrsDetail.focus(row);  
    }
    
    //이력생성
    function createHistory(){
    	if(confirm("저장 된 정보로 이력을 생성을 진행하시겠습니까?")){
	    	var paramObj = {
				   coCd : $("#coCd").val()
				 , ordrsNo : $("#ordrsNo").val()
				 , pgmId : $("#pgmId").val()
				 , userId : jwt.userId
				 };
			postAjaxSync("/user/cr/cr02/callCopyOrdrs", paramObj, null, function(data){
				alert("이력생성이 완료되었습니다.");
			});
    	}
    }
    
	function chechChange(){
		var inputAmtVal = pasIntChk($("#ordrsAmt").val());
		var inputExrateVal = pasIntChk($("#exrate").val());
		var exchangeAmt = addCommaStr(inputAmtVal*inputExrateVal);
		inputAmtVal = addCommaStr($("#ordrsAmt").val());
		inputExrateVal = addCommaStr($("#exrate").val());
		 	 
		$("#exchangeAmt").val(exchangeAmt);
		$("#exrate").val(inputExrateVal);
		$("#ordrsAmt").val(inputAmtVal);
	}

	function commaChange(){
		var inputAmtVal = addCommaStr($("#ordrsAmt").val());
		var inputExrateVal = addCommaStr($("#exrate").val());
		var inputExchangeVal = addCommaStr($("#exchangeAmt").val());
				 
		$("#exchangeAmt").val(inputExchangeVal);
		$("#exrate").val(inputExrateVal);
		$("#ordrsAmt").val(inputAmtVal);
	}
	
	function setClmnDtYn(clmnDt){
       if(isNaN(clmnDt)){
      	 commaChange();
       	 alert("수금예정일자가 없습니다.");
         return false;
       }
	}
	
    function fn_orderSearch() {
//     	if (actionType == "C") {
    
	    	if($('#coCd').val() == 'TRN' && $('#ordrsClntCd').val() == refCode) {
	        	var paramObj = {
	                    "searchValue" : '',
	                    "coCd" : 'GUN'
	                };
	        	openSecondModal("/static/html/cmn/modal/noSalesCdordrsSearch.html", 1200, 420, "건양수주번호 검색", paramObj, function (grid) {
	                    var row = grid.target.getList("selected")[0];
// 	                    console.log(row);
	                    $('#newOrdrsNo').val(row.ordrsNo);
	                    $('#ctrtNm').val(row.ctrtNm);
	                    $('#clntPjt').val(row.clntPjt);
	                });
	    	}
//     	}
    }

    function setDetailButton(){
    	//고객사가 건양ITT면 설비&원가정보는 필요없음 
    	if($('#coCd').val() == 'TRN' && $("#ordrsClntCd").val() == refCode){
    		$("#datailButtonDiv").hide();
    		$("#datailGridDiv").hide();
    		
    		$('#ordrsNoTh').addClass('hit');
			$('#newOrdrsNo').attr('required', 'required');    		
    	}else{
    		$("#datailButtonDiv").show();
    		$("#datailGridDiv").show();
    		
    		$('#ordrsNoTh').removeClass('hit');
			$('#newOrdrsNo').removeAttr('required', 'required');
    	}
    	
    }
	
	function setInitSetting(){
		if($("#ordrsDiv").val() == "ORDRSDIV3"){
			$("#ordrsAmtTh").removeClass('hit');
			$("#currCdTh").removeClass('hit');
			$('#ordrsAmt').attr('readonly', 'true');
			$('#ordrsAmt').val("0");
			$('#exchangeAmt').val("0");
		}else{
			$("#ordrsAmtTh").addClass('hit');
			$("#currCdTh").addClass('hit');
			$('#ordrsAmt').removeAttr('readonly', 'true');
		}
		
		setInitInsert();
	}
	
	function setInitInsert(){
		
    	if($("#fwdExchChkList").val() == "N"){
    		$('#fwdExchJoinDt').attr('readonly', 'true');
    		$('#fwdExchJoinDt').hide();
    	}else{
    		$('#fwdExchJoinDt').removeAttr('readonly', 'true');
    		$('#fwdExchJoinDt').show();
    	}
	}

	</script>

</html>
