<div class="popup_area of_a" style="width: 100%; height: 100%;">
   	<div class="tit_contents">
    	<h4 class="tit">매출확정등록</h4>
   	</div>

	<form id="popForm">
        <div class="popup_table">
        	<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
			<input type="hidden" id="userId"     	name="userId">
			<input type="hidden" id="pgmId" 		name="pgmId" 	value="CR0701M01">
            <table>
				<colgroup>
					<col width="11%">
		        	<col width="14%">
		        	<col width="11%">
		        	<col width="14%">
		        	<col width="11%">
		        	<col width="14%">
		        	<col width="11%">
		        	<col width="14%">
				</colgroup>
				<tr>
					<th class="hit">회사</th>
                   	<td>
						<select id="coCd" class="form-control input-sm" name="coCd" data-kind="CO" required msg="회사">
                       		<option value="">전체</option>
                  	 	</select>
                   	</td>
                   	<th>매출확정번호</th>
                   	<td>
                    	<input type="text" id="sellDcsnNo" class="form-control" name="sellDcsnNo" data-search="sellDcsnNo">
                   	</td>
                   	<th class="hit">고객사</th>
                   	<td>
                  	<input type="hidden" id="ordrsClntCd1" class="form-control" name="ordrsClntCd_S1" data-kind="ordrsClntCd_S1" msg="고객사">
						<div class="search_form">
						<input type="text" id="ordrsClntNm_S1" class="form-control" name="ordrsClntNm_S1" data-kind="ordrsClntNm_S1" onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);" required msg="고객사">
							<a onclick="openSecondClntSearch(document.getElementById('ordrsClntNm_S1').value);">
                           		<i class="i_search_w"></i>
                           	</a>
                       </div>
                   	</td>
                   	<th class="hit">확정일자</th>
					<td>
						<input type="text" id="sellDcsnDt" class="input_calendar" autocomplete="off"  name="sellDcsnDt" required msg="확정일자" date>							
					</td>
              	</tr>
               	<tr>
                	<th>통화단위</th>
                   	<td>
                   		<select id="currCd" name="currCd" class="form-control input-sm" data-kind="CURR">
                       	</select>
                   	</td>
                   	<th>환율</th>
                   	<td>
                    	<input type="text" id="ordrsExrate" class="form-control" name="ordrsExrate" data-kind="ordrsExrate">
                   	</td>
                   	<th>확정금액</th>
                   	<td>
                    	<input type="text" id="sellDcsnAmt" class="form-control" name="sellDcsnAmt" data-kind="sellDcsnAmt" comma>
                   	</td>
                   	<th>비고</th>
                   	<td>
                   		<input type="text" id="sellDcsnRmk" class="form-control" name="sellDcsnRmk" data-kind="sellDcsnRmk">
                   	</td>
				</tr>
			</table>
		</div>
	</form>

    <br>
    <div class="popup_table" style="">
    	<!-- div 테두리 가리는 용인듯?-->
        <div class="tbody_more" style="text-align:right; background:#e6e6e6">
            <a class="tbody_more_btn"></a>
        </div>
        <!-- div 테두리 -->
        <div class="toggle-div" style="padding-left:0;">
            <div class="" style="margin:0px;">
                <div class="contents" style="margin:0px; padding:0px; height:380px; width:100%; min-width:200px; border-radius:0;">
                    <h3 class="location">
                       <!--  <a class="file_tag" id="file_tag"
                           style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a> -->
                        <span class="page_tit" style="text-align: right;"></span>
                    </h3>
                    <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                        <div data-ax5grid="sellDcsn-modal" data-ax5grid-config="{}" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    	
    <br>
    <div style="text-align:right; background:#e6e6e6">
        <a class="tbody_more_btn"></a>
    </div>
    
    <!-- 공통 파일 영역 -->
	<div class="col-sm-2" style="padding-right: 5px;">
		<div class="contents" style="margin: 0; padding: 0;width: 100%; min-width: 200px">
			<h3 class="location">
				<span class="page_tit" style="text-align: left;"> 파일트리</span>
			</h3>
			
			<div id="treeview" style="height: 400px;padding: 5px">
				<div id="deptTreeOrdars"></div>
			</div>
		</div>
	</div>
	
	<div class="col-sm-10" style="padding-left: 0;">
		<div class="contents" style="margin: 0; padding: 0;  width: 100%; min-width: 200px">
			<h3 class="location">
				<a class="file_tag" id="file_tag" style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
				<span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
			</h3>
			
			<button disabled type="button" id="button_file" style="background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();" authchk> 첨부파일</button>
			<div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%"></div>
		</div>
	</div>
    <br>
	<div class="col-xs-2" style="height: 70px;">
	</div>
    </div>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
        <button type="button" id="actionBtn" authchk>등록</button>
        <button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>

<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	// 확정정보 그리드 생성
	var gridView = {
		initView: function(){
	    	this.target = new ax5.ui.grid();
            this.target.setConfig({
            	showLineNumber : true,
                showRowSelector: false,
                multipleSelect: false,
                sortable: false,
  			    target: $('[data-ax5grid="sellDcsn-modal"]'),
        		header: {
            		align: "center",
            		selector: false
        },
        body: {
        	mergeCells : ["ordrsNo", "ordrsClntCd", "clntPjt", "ctrtNm", "ordrsCurrNm"],
            onClick: function() {
                this.self.select(this.dindex); 
              // var row = this.dindex;
              // 행내용 복붙 안된다.
              //gridView.setValue(param.dindex, 'updcheck', 1);
              //  var paramObj = {"flag":"P","row":row};
              //  updateSecondWBSModal(2, paramObj);
                var index = this.dindex;
                var item = this.item;
                var self = this.self;
                checkSellDcsnAmt(item, index, self);
            },
            onDBLClick: function () {
                this.self.clearSelect();
                this.self.select(this.dindex);
            },
      	 },
        columns: [
        	{key: "rn",      		label: "No.",			align: "center",	width: 50, hidden: true},
            {key: "ordrsNo", 		label: "수주번호", 		align: "center", 	width: 100},
            {key: "ordrsClntCd", 	label: "고객사", 			align: "center", 	width: 100},
            {key: "clntPjt", 		label: "고객사PJT", 		align: "center", 	width: 100},
            {key: "ctrtNm", 		label: "계약명", 			align: "center", 	width: 100},
            {key: "ordrsCurrNm", 	label: "통화단위", 		align: "center", 	width: 100},
            {key: "clmnPlanDivNm", 	label: "수금구분", 		align: "center", 	width: 100},
            {key: "clmnDivSeq", 	label: "차수", 			align: "center", 	width: 100},
            {key: "clmnRate", 		label: "비율", 			align: "center", 	width: 100},
            {key: "clmnAmt", 		label: "수금금액", 		align: "right", 	width: 100, formatter: "money"},
            {key: "clmnBillPblsDt", label: "계산서발행일자",		align: "center", 	width: 100},
            {key: "clmnDt", 		label: "수금일자", 		align: "center", 	width: 100},
            // {key: "clmnAmt", label: "수금금액", align: "right", width: 100, formatter: "money"},
            {key: "befConfAmt", 	label: "기 매출 확정금액",	align: "center", 	width: 100},
            {key: "unconfAmt", 		label: "매출 미확정금액",	align: "center", 	width: 100},
            {
            	key: "chk", label: "", width: 50, sortable: false, align: "center", editor: {
                type: "checkbox", config: {height: 17, trueValue: "Y", falseValue: "N"}}
            },		           
            {key: "confAmt", 		label: "매출확정금액", 		align: "center", 	width: 100},
            ]
   		});
		return this;
		},
        setData: function() {
			var targetObj = this.target;
            // debugger;
            var formData = {
            	// 회사
            	"coCd" : $("#coCd").val(),
            	// 매출확정번호
            	
                // 고객사
                "ordrsClntCd" : $("#ordrsClntCd_S1").val(),
                "clntNm" : $("#ordrsClntNm_S1").val(),
               	// 확정일자
 				"sellDcsnDt" : $("#sellDcsnDt").val(),
				// 통화단위
				"currCdNm" : $("#currCd").val(),
				// 환율
				"ordrsExrate" : $("#ordrsExrate").val(),
				// 확정금액
				"sellDcsnAmt" : $("#sellDcsnAmt").val(),
				// 비고
				"sellDcsnRmk" : $("#sellDcsnRmk").val(),
                "searchValue" : $("#searchValue_S").val(),
                "searchName" : $("#searchName_S").val(),
                //"pageNo" : _pageNo + 1, 
                "recordCnt" : $("#recordCnt").val()
              }
              postAjax("/user/cr/cr07/addSellDscnList", formData, null, function(data){
                 //debugger;
            	  var list = data.resultList;
                  targetObj.setData({
                       list : list,
                       page : {
                           totalElements : list.length
                       }
                   });
              }); 
         } 
	}  
	
	$(document).ready(function() {  
		setCommonSelect($('.popup_area select[data-kind]'));
		setByCoCd(modalStack.last().paramObj.coCd);
		
		$('#coCd').val(jwt.coCd);
		$("#popForm #userId").val(jwt.userId);
		authChk(); //권한체크
		
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	
		if (actionType == "C") {
			// 환율
			$('#ordrsExrate').val("1");
			// 확정금액
			$("#sellDcsnAmt").val("0");
			
			// 확정일자
			$('#sellDcsnDt').datepicker({
				format: "yyyy-mm-dd",
	            language: "ko",
	            autoclose: true
			});
			setCurrentDateToDatePicker('#sellDcsnDt');
			
			//버튼명 변경
			$("#actionBtn").text("등록");
		} else if(actionType == "U") {
			//타이틀명 변경
			$('.tit').text('매출확정 수정')
			//버튼명 변경
			$("#actionBtn").text("수정");
		}
		
		gridView.initView().setData();
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: $("#pgmId").val(),
			fileTrgtKey : fileTrgtKey
		}
		
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
		
		
	
	});
	
	// 현재 날짜 넣기
	function setCurrentDateToDatePicker(selector) {
        var currentDate = new Date();
        //alert(currentDate);
        currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset()); // 시간대를 고려한 날짜 시간 조정
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1; // 월은 0부터 시작하므로 1을 더합니다.
        var day = currentDate.getDate();

        //console.log(year+ " " + month + " " + day);
        
		// 월과 일이 한 자리수라면 앞에 '0'을 추가합니다.
        if (month < 10) month = '0' + month;
        if (day < 10) day = '0' + day;

        var formattedDate = year + '-' + month + '-' + day;
        $(selector).val(formattedDate);

    }
	
	// 체크박스 선택 시 매출미확정금액을 확정금액에 표기
	// 매출확정금액 합계 기본정보의 확정금액에 표기
	function checkSellDcsnAmt(item, index, self) {
		var row = gridView.target.getList("selected")[index];
		debugger;
		// 확정금액
		//$("#sellDcsnAmt").val(row.confAmt);
		  //체크박스 유무에 따른 행 update
		console.log(item); // grid 컬럼
		console.log(index);
		console.log(self);	// 얘가 제공하는 함수?
		console.log(item.chk);
		//console.log(item.chk);
        if (item.chk == "Y") {
        //    if(item.outQty != item.stockQty && item.outQty != "0"){}
        // else {
                self.updateRow($.extend({}, row, 
                        {
                			ordrsNo : item.ordrsNo,
                			ordrsClntCd : item.ordrsClntCd,
                			clntPjt : item.clntPjt,
                			ctrtNm : item.ctrtNm,
                			ordrsCurrNm : item.ordrsCurrNm,
                			clmnPlanDivNm : item.clmnPlanDivNm,
                			clmnDivSeq : item.clmnDivSeq,
                			clmnRate : item.clmnRate,
                			clmnAmt : item.clmnAmt,
                			clmnBillPblsDt : item.clmnBillPblsDt,
                			clmnDt : item.clmnBillPblsDt,
                			befConfAmt : item.befConfAmt,
                			isChecked : item.isChecked,
                			unconfAmt : item.unconfAmt,
                            confAmt : item.unconfAmt
                        }, 
                    ), index);
//             }
		
        } else if (item.chk == "N") {
            //self.updateColumn({key: "outQty", label: "출고수량", align: "right", width: 120}, 11);
            //item.chk = "Y";
            self.updateRow($.extend({}, row, 
                    {
                      	ordrsNo : item.ordrsNo,
              			ordrsClntCd : item.ordrsClntCd,
              			clntPjt : item.clntPjt,
              			ctrtNm : item.ctrtNm,
              			ordrsCurrNm : item.ordrsCurrNm,
              			clmnPlanDivNm : item.clmnPlanDivNm,
              			clmnDivSeq : item.clmnDivSeq,
              			clmnRate : item.clmnRate,
              			clmnAmt : item.clmnAmt,
              			clmnBillPblsDt : item.clmnBillPblsDt,
              			clmnDt : item.clmnBillPblsDt,
              			befConfAmt : item.befConfAmt,
              			isChecked : item.isChecked,
              			unconfAmt : item.unconfAmt,
                        isChecked :item.isChecked,
                        unconfAmt : item.unconfAmt,
                        confAmt : 0
                    }
            ), index);

        } 
	}
	
	
	// 거래처 검색 함수
	function openSecondClntSearch(searchValue) {
	    if (event && event.keyCode === 13) {
	        event.preventDefault();  // prevent form from submitting
	    }
	    openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: searchValue}, function (grid) {
	        var row = grid.target.getList("selected")[0];
	        $('#ordrsClntCd_S1').val(row.clntCd);
	        $('#ordrsClntNm_S1').val(row.clntNm);
	
	        var paramObj = {
	            "coCd": $('#coCd').val(),
	            "clntCd": row.clntCd
	        }
	       
	    });
	}
	
	// 등록버튼 클릭
 	// 파일대상KEY : FILE_TRGT_KEY(MAX + 1 자동채번)   
 	// 확정번호 : CONF+년도2자리+’-’+순번4자리   (년도 기준 MAX + 1 자동채번) ex) CONF23-0001

 	
 	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}
 	
</script>
