<style>
  
	.popup_bottom_btn {
    	bottom: 30px;
    }

</style>
<html>
<div id="sellDcsnPopup" class="popup_area of_a" style=" height: 100%;">
   	<div id="first-focus" class="tit_contents">
    	<h4 class="tit">매출확정등록</h4>
   	</div>
   	<div id="overlay2" style="z-index:100;display: none; position: absolute; width: 100%; height: 630px; top: 0; left: 0; background-color: rgba(0,0,0,0); pointer-events: auto;"></div>
   	<div style="text-align: right;background:#e6e6e6">
       <a class="tbody_more_btn"></a>
   	</div>
    <div class="toggle-div" style="padding-left: 0;">
        <div class="popup_table">
            <form id="popForm">
                <input type="hidden" id="pgmId" name="pgmId" value="CR0701M01">
                <table>
                    <tr>
                        <th class="hit" title="회사를 선택합니다">회사</th>
                        <td>
                        	<select id="coCd" name="coCd" data-kind="CO" required="required">
                            	<option value="">전체</option>
                            </select>
                        </td>
                        <th title="매출확정번호를 확인하거나,입력합니다">매출확정번호</th>
                        <td>
                            <input type="text" id="sellDcsnNo" name="sellDcsnNo" data-kind="sellDcsnNo">
                        </td>
                        <th class="hit" title="고객사를 선택합니다">고객사</th>
                        <td>
                            <input type="hidden" id="ordrsClntCd1" name="ordrsClntCd_S1" data-kind="ordrsClntCd_S1">
                            <div class="search_form">
                                <input onkeydown="if(event.keyCode==13) openSecondClntSearch(this.value);" type="text" id="ordrsClntNm_S1" name="ordrsClntNm_S1" data-kind="ordrsClntNm_S1" required="required">
                                <a onclick="openSecondClntSearch(document.getElementById('ordrsClntNm_S1').value);">
                                	<i class="i_search_w"></i>
                                </a>
                            </div>
                        </td>
                        <th class="hit" title="확정일자를 선택합니다">확정일자</th>
						<td>
							<input type="text" class="input_calendar" autocomplete="off" id="sellDcsnDt" name="sellDcsnDt" date required>							
						</td>
                   	</tr>
                    <tr>
                        <th title="통화단위를 선택합니다">통화단위</th>
                        <td>
                            <select id="currCd" name="currCd" data-kind="CURR" required="required">
                            </select>
                        </td>
                        <th>환율</th>
                        <td>
                            <input type="text" id="ordrsExrate" name="ordrsExrate" data-kind="ordrsExrate">
                        </td>
                        <th title="확정금액을 입력합니다">확정금액</th>
                        <td>
                            <input type="text" id="sellDcsnAmt" name="sellDcsnAmt" data-kind="sellDcsnAmt" required>
                        </td>
                        <th>비고</th>
                        <td>
                            <input type="text" id="sellDcsnRmk" name="sellDcsnRmk" data-kind="sellDcsnRmk" required>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <br>
    <div class="popup_table" style="">
        <div class="tbody_more" style="text-align:right; background:#e6e6e6">
            <a class="tbody_more_btn"></a>
        </div>
        <div class="toggle-div" style="padding-left:0;">
            <div class="" style="padding-left:0;">
                <div class="contents" style="margin:0px; padding:0px; height:380px; width:100%; min-width:200px; border-radius:0;">
               <!--      <div style="float:right" style="" class="add_btn pdl10">
                        <a id="addDetailButton" style="margin-top:8px">+</a>
                        <a id="deleteDetailButton" style="margin-top:8px;margin-right:8px;">-</a>
                    </div> -->
                    <h3 class="location">
                        <a class="file_tag" id="file_tag"
                           style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                        <span class="page_tit" style="text-align: right;"></span>
                    </h3>
                    <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                        <div data-ax5grid="sellDcsn-modal" data-ax5grid-config="{}" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div style="text-align:right; background:#e6e6e6">
        <a class="tbody_more_btn"></a>
    </div>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
        <button id="actionBtn" authchk>등록</button>
        <button class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
</div>
<script type="text/javascript">
	// 전역변수
	let selectedRowKey2;
	
	// 확정정보 그리드 생성
	var gridSellDcsnView = {
		initView: function(){
	    	this.target = new ax5.ui.grid();
            this.target.setConfig({
            	showLineNumber: true,
                showRowSelector: false,
                multipleSelect: false,
                sortable: false,
  			    target: $('[data-ax5grid="sellDcsn-modal"]'),
        		header: {
            		align: "center",
            		selector: false
        },
        body: {
        	mergeCells : ["ordrsNo", "ordrsClntCd", "clntPjt", "ctrtNm", "ordrsCurrNm"],
            onClick: function() {
                this.self.select(this.dindex); 
                var row = this.dindex;
                selectedRowKey2 = this.dindex;
              // 행내용 복붙 안된다.
              //gridSellDcsnView.setValue(param.dindex, 'updcheck', 1);
              //  var paramObj = {"flag":"P","row":row};
              //  updateSecondWBSModal(2, paramObj);
            },
            onDBLClick: function () {
                this.self.clearSelect();
                this.self.select(this.dindex);
            },
      	 },
        columns: [
            {key: "ordrsNo", label: "수주번호", align: "center", width: 100},
            {key: "ordrsClntCd", label: "고객사", align: "center", width: 100},
            {key: "clntPjt", label: "고객사PJT", align: "center", width: 100},
            {key: "ctrtNm", label: "계약명", align: "center", width: 100},
            {key: "ordrsCurrNm", label: "통화단위", align: "center", width: 100,
            	formatter: function () {
                	var value = this.value;
                    switch (value) {
                        case "CURR01":
                            return "WON";
                        case "CURR02":
                            return "달러";
                        case "CURR03":
                            return "유로";
                        case "CURR04":
                            return "엔화";
                        default:
                            return value;  // unknown value, return as is
                    }
                }},
            {key: "clmnPlanDivNm", label: "수금구분", align: "center", width: 100},
            {key: "clmnDivSeq", label: "차수", align: "center", width: 100},
            {key: "clmnRate", label: "비율", align: "center", width: 100},
            {key: "clmnAmt", label: "수금금액", align: "right", width: 100, formatter: "money"},
            {key: "clmnBillPblsDt", label: "계산서발행일자", align: "center", width: 100},
            {key: "clmnDt", label: "수금일자", align: "center", width: 100},
            // {key: "clmnAmt", label: "수금금액", align: "right", width: 100, formatter: "money"},
            {key: "befConfAmt", label: "기 매출 확정금액", align: "center", width: 100},
            {key: "unconfAmt", label: "매출 미확정금액", align: "center", width: 100},
            {
            	key: "isChecked", label: "", width: 50, sortable: false, align: "center", editor: {
                type: "checkbox", config: {height: 17, trueValue: "Y", falseValue: "N"}
            }},		           
            {key: "confAmt", label: "매출확정금액", align: "center", width: 100},
            ]
   		});
		return this;
		},
        setData: function() {
			var targetObj = this.target;
            // debugger;
            var formData = {
            	// 회사
            	"coCd" : $("#coCd").val(),
            	// 매출확정번호
            	
                // 고객사
                "ordrsClntCd" : $("#ordrsClntCd_S1").val(),
                "clntNm" : $("#ordrsClntNm_S1").val(),
               	// 확정일자
 				"sellDcsnDt" : $("#sellDcsnDt").val(),
				// 통화단위
				"currCdNm" : $("#currCd").val(),
				// 환율
				"ordrsExrate" : $("#ordrsExrate").val(),
				// 확정금액
				"sellDcsnAmt" : $("#sellDcsnAmt").val(),
				// 비고
				"sellDcsnRmk" : $("#sellDcsnRmk").val(),
                "searchValue" : $("#searchValue_S").val(),
                "searchName" : $("#searchName_S").val(),
                //"pageNo" : _pageNo + 1, 
                "recordCnt" : $("#recordCnt").val()
              }
              postAjax("/user/cr/cr07/addSellDscnList", formData, null, function(data){
                 //debugger;
            	  var list = data.resultList;
                  targetObj.setData({
                       list : list,
                       page : {
                           totalElements : list.length
                       }
                   });
              }); 
         } 
	}  
	
	$(document).ready(function() {  
		setCommonSelect($('#sellDcsnPopup select[data-kind]'));
		
		$('#coCd').val(jwt.coCd);
		
		$('#ordrsExrate').val("1");
		// 확정금액
		$("#sellDcsnAmt").val("0");
		
		// 확정일자
		$('#sellDcsnDt').datepicker({
			format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
		});
		setCurrentDateToDatePicker('#sellDcsnDt');
		gridSellDcsnView.initView().setData();
	
	});
	
	// 현재 날짜 넣기
	function setCurrentDateToDatePicker(selector) {
        var currentDate = new Date();
        //alert(currentDate);
        currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset()); // 시간대를 고려한 날짜 시간 조정
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth() + 1; // 월은 0부터 시작하므로 1을 더합니다.
        var day = currentDate.getDate();

        //console.log(year+ " " + month + " " + day);
        
		// 월과 일이 한 자리수라면 앞에 '0'을 추가합니다.
        if (month < 10) month = '0' + month;
        if (day < 10) day = '0' + day;

        var formattedDate = year + '-' + month + '-' + day;
        $(selector).val(formattedDate);

    }
	
	// 체크박스 선택 시 매출미확정금액을 확정금액에 표기
	// 매출확정금액 합계 기본정보의 확정금액에 표기
// 	function checkSellDcsnAmt {
// 		var row =  gridSellDcsnView.target.getList("selected")[0];
// 		// 확정금액
// 		$("#sellDcsnAmt").val(row.confAmt);
// 	}
	
	
	// 거래처 검색 함수
	function openSecondClntSearch(searchValue) {
	    if (event && event.keyCode === 13) {
	        event.preventDefault();  // prevent form from submitting
	    }
	    openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: searchValue}, function (grid) {
	        var row = grid.target.getList("selected")[0];
	        $('#ordrsClntCd_S1').val(row.clntCd);
	        $('#ordrsClntNm_S1').val(row.clntNm);
	
	        var paramObj = {
	            "coCd": $('#coCd').val(),
	            "clntCd": row.clntCd
	        }
	       
	    });
	}
	// 행추가
	$("#addDetailButton").on("click", function () {
        var row;
        var newRowData = {
            estDtlDiv: "",
            estComm: "",
            estSpec: "",
            estUnit: "",
            estQty: "",
            estUpr: "",
        };

        // 첫 번째 경우: 선택된 행이 있는 경우
        if (selectedRowKey2 !== undefined) {
            let row = gridSellDcsnView.target.getList("selected")[0];
            let newRowData = $.extend({}, row, {__index: undefined});
            gridSellDcsnView.target.addRow(newRowData, row.__index + 1);
        }
        // 두 번째 경우: 그리드가 비어 있는 경우
        else if (gridSellDcsnView.target.getList().length === 0) {
        	gridSellDcsnView.target.addRow(newRowData, 0);
        }
        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
        else {
        	gridSellDcsnView.target.addRow(newRowData, gridSellDcsnView.length);
            return;
        }

        const data = gridSellDcsnView.getList();
        gridSellDcsnView.setData({
            list: data,
            page: {
                totalElements: data.length
            }
        });
    });

	// 행삭제
    $("#deleteDetailButton").on("click", function () {
        if (selectedRowKey2 !== undefined) {
        	gridSellDcsnView.target.removeRow(selectedRowKey2);
            const data = gridSellDcsnView.target.getList();
            gridSellDcsnView.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey2 < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                	gridSellDcsnView.target.select(selectedRowKey2);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey2 = selectedRowKey2 - 1;
                    gridSellDcsnView.target.select(selectedRowKey2);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey2 = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });
	
	// 등록버튼 클릭
 	// 파일대상KEY : FILE_TRGT_KEY(MAX + 1 자동채번)   
 	// 확정번호 : CONF+년도2자리+’-’+순번4자리   (년도 기준 MAX + 1 자동채번) ex) CONF23-0001

</script>

</html>