<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">

<script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
<script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script type="text/javascript" src="/static/js/global.js"></script>
<script type="text/javascript" src="/static/js/fileTree.js"></script>
<script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
<script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>
<script src="/static/js/jquery.blockUI.js"></script>

<!-- 도움말 팝업 -->
<script src="/static/js/manualPopup.js"></script>

</head>

<body>
    <div id="head_area"></div>
    <div id="top_area"></div>
    <div id="main_area">
        <!-- 페이지 상단 -->
        <div class="contents no_bg">
        	<input type="hidden" id="pgmId"  name="pgmId" value="CR5001M01">
            <ul class="btn_ul">
                <li class="btn_r">
                	<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
                    <a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
                    <a onclick="searchList();"><button class="bg_gray">검 색</button></a>
                </li>
            </ul>
        </div>
        
        <!-- 검색 콘텐츠 -->
        <div class="contents search">
            <div class="">
                <!-- 테이블 인풋 3분할 -->
                <table class="table_input type04">
                
                    <!-- 검색조건 1행 -->
                    <tr>
                        <th class="hit" style="width:80px;">회사</th>
                        <td style="width:200px;">
                           <select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사">
                           </select>
                        </td>
						<th style="width:100px;">수주일자</th>
	                    <td >
	                    <div style="width:400px;">
	                      <input type="text" class="input_calendar" id="beginDt_S" name="beginDt_S" data-search="beginDt_S" autocomplete="off" date data-search="beginDt" onkeyup="dateMask(this);">
	                      <span>~</span>
	                      <input type="text" class="input_calendar" id="deDt_S" name="deDt_S" data-search="deDt_S"  autocomplete="off" date data-search="deDt" onkeyup="dateMask(this);">
	                    </div>
	                    </td>
                        <th >과제명</th>
                        <td style="width:260px;">
                        <input type="text" id="sjNm_S" name="sjNm_S" data-search="sjNm" onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''">
                        </td> 
	                    <th style="width:100px;">확정구분</th>
                        <td>
                        <select id="closeYn_S" name="closeYn_S" data-search="closeYn">
							<option value="" selected>전체</option>
							<option value="Y">확정</option>
							<option value="N">미확정</option>
                        </select>
                        </td>  
                        
                    </tr>
                    <!-- 검색조건 2행 -->
					<tr>
                        <th style="width:90px;">Sales Code</th>
                        <td style="width:200px;">
                            <div class="search_form">
                                <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''">
                                <a onclick="wbsSalesCodeSearch('S');"><i class="i_search_w"></i></a>
                            </div>
                            <input type="hidden" id="salesNm_S" name="salesNm_S" >
                        </td>
						<th>고객사PJT</th>
						<td>
                            <select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt">
								<option value="">전체</option>
							</select>
						</td>
                        <th class="">고객사</th>
						<td>
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm" onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
                        
                        <th></th>
                        <td></td>
					</tr>
                    <!-- 검색조건 END -->
                </table>
            </div>
        </div>
        
        <!-- 콘텐츠 -->
        <div class="contents no_bg">
            <div class="contents_tit">
                <div class="add_btn_small pdl10">
					<a onclick="openPFUList('C');" style="height: 30px; line-height: 28px; width: 90px;" title="선택된 SalesCd에 PFU신규 등록작업입니다."><i class="fas fa-folder-plus" authchk></i> PFU등록화면</a>
					<a onclick="openPFUList('U');" style="height: 30px; line-height: 28px; width: 90px;" title="선택된 PFU수정 작업입니다."><i class="fas fa-clipboard-list" authchk></i> PFU등록수정</a>
                    <a onclick="deletePFUList();" style="height: 30px; line-height: 28px;" authchk title="선택된 PFU를 삭제합니다.">-</a>
					<a onclick="pfuCopySearch();" style="height: 30px; line-height: 28px; width: 90px;" title="선택된 PFU를 다른 SalesCd에 복사합니다."><i class="fas fa-clipboard-list" authchk></i> PFU복사하기</a>
                    <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
                </div>
                <select id="recordCnt" style="height: 30px;" class="prae_select" data-search="recordCnt">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="500">500</option>
                    <option value="9999999">전체</option>
                </select>
            </div>
            
            <div class="contents">
                <div class="ax5_grid">
                    <div class="ax5_grid" data-ax5grid="first-grid" data-ax5grid-config="{}" style="width: 100%; height: 725px;" ></div>
                    <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
                </div>
            </div>
			  
    	</div>
	</div>

<script type="text/javascript">
var actionType = null;
var fileTrgtKey = null;

ax5.ui.grid.formatter["chkYn"] = function () {
    var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
    return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
};

var gridView = {
    initView : function() {
        this.target = new ax5.ui.grid();
        this.target.setConfig({
            showRowSelector: false,
            multipleSelect: false,
            sortable: true,
            target: $('[data-ax5grid="first-grid"]'),
            header : {
                align : "center",
                selector : false
            },
            body: {
                mergeCells : ["salesCd", "clntNm","clntPjtNm"],
                columnHeight: 26,
                onClick: function () {
                    this.self.select(this.dindex);
                },
                onDBLClick: function () {
                    this.self.select(this.dindex);
                    openPFUList('U');
                },
            },
            columns: [
                {key: "rn",  			label: "NO",  			align: "center",   width: 40},
                {key: "clntNm", 		label: "고객사명", 		align: "center",   width: 120 },
                {key: "clntPjtNm",      label: "고객사PJT",    	align: "center",   width: 80},
                {key: "salesCd",  		label: "SALES CD", 		align: "center",   width: 110},
                {key: "sjNm",  			label: "과제명", 			align: "left",     width: 200},
                {key: "closeYn",  		label: "확정", 			align: "center",   width: 40, formatter: "chkYn"},
//                 {key: "ordrsNo",  		label: "수주번호", 		align: "center",   width: 70},
                {key: "smrizeNm",   	label: "총괄PM명", 		align: "center",   width: 70},
                {key: "mctypeNm",   	label: "구분", 			align: "center",   width: 60},
                {key: "itemDivNm",   	label: "ITEM", 			align: "left",   width: 100},
                {key: "ordrsDtlDiv20Nm",label: "제작", 			align: "center",   width: 60},
//                 {key: "planExceptNm",  	label: "일정예외사항", 		align: "left",   width: 110},
                {key: "pfuNo",  		label: "PFU NO", 		align: "center",   width: 80},
                {key: "pfuVerNo",  		label: "Ver", 			align: "center",   width: 50},
                {key: "pfuPrdtDivNm",  	label: "PFU유형", 		align: "left",   width: 110},
                {key: "prdtCavNm",  	label: "작동방식", 		align: "left",   width: 230},
                {key: "prdtStepNm",  	label: "Step", 			align: "left",   width: 100},
                {key: "mkerDivNm",   	label: "제작처구분", 		align: "center",   width: 70},
                {key: "mkerNm",   		label: "제작처명", 		align: "center",   width: 80},
                {key: "beginDt",   		label: "시작일", 			align: "center",   width: 80},
                {key: "deDt",   		label: "출고일", 			align: "center",   width: 80},
                {key: "acptncDt",   	label: "검수일", 			align: "center",   width: 80},
//                 {key: "reqreDaycnt",   	label: "소요일수", 		align: "center",   width: 70},
//                 {key: "dsgnDifCodeNm",  label: "설계난이도", 		align: "center",   width: 70},
//                 {key: "dsgnPlanHour",   label: "설계공수", 		align: "center",   width: 60},
//                 {key: "prdctnDifCodeNm",label: "생산난이도", 		align: "center",   width: 70},
//                 {key: "prdctnPlanHour", label: "생산공수", 		align: "center",   width: 60},
                {key: "sjRmk", 			label: "비고", 			align: "left",     width: 300},
            ],
            page: {
                navigationItemCount: 9,
                height: 30,
                display: true,
                firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                onChange: function () {
                    gridView.setData(this.page.selectPage);
                    pageNo = this.page.selectPage;
                }
            },
        });
        return this;
    },
    setData : function(_pageNo) {
        var targetObj = this.target;
        var paramObj = {
            "coCd"		: $('#coCd_S').val(),
            "salesCd"	: $('#salesCd_S').val(),
            "ordrsClntNm": $('#ordrsClntNm_S').val(),
            "clntPjt"	: $('#clntPjt_S').val(),
            "beginDt"	: $('#beginDt_S').val(),
            "deDt"		: $('#deDt_S').val(),
            "sjNm"		: $('#sjNm_S').val(),
            "closeYn"	: $('#closeYn_S').val(),
            "pageNo" 	: _pageNo + 1,
            "recordCnt" : $("#recordCnt").val(),
        };
        
        postAjax("/user/cr/cr50/selectPfuList", paramObj, null, function(data) {
            try {
                var list = data.resultList;
                targetObj.setData({
                    list : list,
                    page : {
                        currentPage : _pageNo,
                        pageSize : data.paginationInfo.pageSize,
                        totalElements : data.paginationInfo.totalRecordCount,
                        totalPages : data.paginationInfo.totalPageCount
                    }
                });

                gridHeightResize(gridView, 194); // 194 = 919 - 725 : 화면 Body 높이 - 그리드 기본크기 725
            } catch (error) {
                alert("오류 발생!! 전산실 연락 바랍니다", error.message);
                return null; // 오류 발생 시 null 반환
            } finally {
                // console.log("함수 실행 완료.");
            }
        });
    }
}

var excelView = {
        initView: function(){
        this.target = new ax5.ui.grid();
        this.target.setConfig({
        target: $('[data-ax5grid="excel-grid"]'),
        columns: [
           ]
        });
        return this;
    }
}        

$(document).ready(function() {
    mainDefaultLoad("영업관리", "PFU관리");
    setCommonSelect($("#main_area select[data-kind]"));
    
    $('#userId').val(jwt.userId);
    $('#coCd_S').val(jwt.coCd);
    $('a[title]').tooltip();

	// 시작일 (현재날짜의 이전월 첫일)
	const now = moment().startOf("month");
	var beDay = now.add(-2, "M").format("YYYY-MM-DD");

	$('#beginDt_S').datepicker({
		format : "yyyy-mm-dd",
		language : "ko",
		autoclose : true
	})
//      .datepicker("setDate", moment(new Date()).startOf("year").toDate())
	.datepicker("setDate", beDay)
	.on("changeDate", function(){
		if($('#beginDt_S').val() > $('#deDt_S').val()){
			customAlert("날짜를 확인해주세요")
			$('#deDt_S').datepicker("setDate", new Date($('#beginDt_S').val()));
		}
		gridView.setData(0);
	});
	
	$('#deDt_S').datepicker({
		format : "yyyy-mm-dd",
		language : "ko",
		autoclose : true
	})
	.datepicker("setDate",  moment(new Date()).endOf("month").toDate())
	.on("changeDate", function(){
		if ($('#beginDt_S').val() > $('#deDt_S').val()) {
			customAlert("날짜를 확인해주세요")
			$('#beginDt_S').datepicker("setDate", new Date($('#deDt_S').val()));
		}
		gridView.setData(0);
	});
    
    gridView.initView().setData(0);
    excelView.initView();
})


// 고객사 검색
function openClntSearch() {
    var paramObj = {
        "searchValue" :  $("#mkerNm").val(),
        "clntDivCd"   : "CLNTDIV12"
    }
    openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
        var row = grid.target.getList("selected")[0];
        $('#mkerCd').val(row.clntCd);
        $('#mkerNm').val(row.clntNm);
    });
}

function wbsSjNoconfirmSearch() {

    var paramObj = {};
    var row = gridView.target.getList("selected")[0];
    if (row != undefined) {
        // 리스트 선택 시
        paramObj["coCd"] = $('#coCd_S').val();
        // paramObj["searchValue"] = jwt.userNm;

        var tempCode = row.salesCd;
        paramObj["searchValue"] = tempCode.substring(0,5);
        paramObj["pgmId"] = "CR5001M01";
    } else {
        // 리스트 미 선택 시
        paramObj["coCd"] = $('#coCd_S').val();
        paramObj["searchValue"] = "";
        paramObj["pgmId"] = "CR5001M01";
    }
    openSecondModal("/static/html/cmn/modal/wbsSjNoconfirmSearch.html", 1200, 650, "과제 일괄확정 대상 검색", paramObj);
}

function wbsSalesCodeSearch(flag) {
	if(flag != "S" && actionType == "U"){
		alert("SALES CODE는 수정 불가합니다.");
		return;
	}
    var paramObj = {};
    if (flag == "S") {
    	paramObj["coCd"] = $('#coCd_S').val();
        paramObj["searchValue"] = $('#salesCd_S').val();
    }
    else {
    	paramObj["coCd"] = jwt.coCd;
        paramObj["searchValue"] = $('#salesCd').val();
    }
//     console.log(flag);
    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 700, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        if (flag == "S") {
        	$('#salesCd_S').val(row.salesCd);
        	gridView.setData(0);
        }
        else {
        	// console.log(row);
        	$('#salesCd').val(row.salesCd);
        	$('#clntCd').val(row.ordrsClntCd);
        	$('#clntNm').val(row.ordrsClntNm);
        	$('#prdtCd').val(row.prdtCd);
            $('#prdtNm').val(row.prdtCdNm);     	
            $('#clntPjt').val(row.clntPjt);
            $('#clntPjtNm').val(row.clntPjtNm);
            
            //과제명 = 설비명 적용 후 수정 불가
            $('#sjNm').val(row.eqpNm);
            $('#sjNm').prop('readonly', true);
            
        }
    });
}


//신규 등록
function cretSjNo() {
    actionType = "C";
    fileTrgtKey = null;
    
    var paramObj = {
        "userId"      : jwt.userId,
        "fileTrgtKey" : "",
        "pgmId"       : "CR5001M01"
    };
    openModal("/static/html/user/wb/wb21/WB2101P01.html", 1200, 800, "과제관리등록", paramObj);
}

function initSearch() {
    $('[data-search]').off("change");   //바인딩기능 오프
    $('.contents.search select, .contents.search input').val("");
    
    $("#beginDt_S").val(dateToStr( moment(new Date()).startOf("month").toDate() ));
    $("#deDt_S").val(dateToStr( moment(new Date()).endOf("month").toDate() ));

    $("#coCd_S").val(jwt.coCd);
    gridView.initView().setData(0);
    
}

function searchList() {
	gridView.initView().setData(0);
}

function excelDown() {
	var paramObj = {
       	    "coCd"		: $('#coCd_S').val(),
       	    "salesCd"	: $('#salesCd_S').val(),
       	    "ordrsClntNm": $('#ordrsClntNm_S').val(),
       	    "clntPjt"	: $('#clntPjt_S').val(),
       	    "beginDt"	: $('#beginDt_S').val(),
       	    "deDt"		: $('#deDt_S').val(),
       	    "sjNm"		: $('#sjNm_S').val(),
       	    "closeYn"	: $('#closeYn_S').val(),
            "pageNo" : 1, 
            "recordCnt" : 9999999
            };
    postAjax("/user/wb/wb21/selectSjList", paramObj, null, function(data){
        var list = data.resultList;
        excelView.target.setData({
            list : list,
            page : {
            	totalElements : list.length,
            } 
        });
        var todayDate = new Date().format('yyyyMMddHHmmss');
        excelView.target.exportExcel("PFU등록현황"+todayDate+".xls");
    }); 
}      

// 거래처 검색 함수
function opendClntSearch(inputValue) {
	var paramObj = {
            "searchValue" : inputValue,
            "clntDivCd"   : "CLNTDIV12"
        };
	openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
		var row = grid.target.getList("selected")[0];
		$('#ordrsClntCd_S').val(row.clntCd);
		$('#ordrsClntNm_S').val(row.clntNm);
		gridView.setData(0);
	});
}

//삭제 버튼 클릭 시
function deletePFUList() {
	var row = gridView.target.getList("selected")[0];
	if (row == undefined) return false;
	if (row.pfuNo == undefined) {
		alert("등록된 PFU정보가 없습니다.");
		return false;
	}
	var formData = {
		"fileTrgtKey" 	: row.pfuNo,
		"coCd"        	: row.coCd,
		"salesCd"     	: row.salesCd,
		"todoNo" 		: row.pfuNo,
		"todoDiv2CodeId": "TODODIV2120",
		"coCd"        : row.coCd,
		"userId"      : jwt.userId,
		"fileTrgtTyp" : "CR5001P01"
	}
    
    // if(!monthCloseChk(row.ioDt, 'D')) return;  //마감일통제
	if (confirm(row.pfuNo +"를 삭제하시겠습니까?")) {
		putAjax("/user/cr/cr50/deletePfuNo", formData, null, function(data) {
			alert(data.resultMessage);
			if (data.resultCode == 200) {
				gridView.setData(0);
			}
		});
	}
}


function openPFUList(jobType = 'C') {
    let row = gridView.target.getList("selected")[0];
    if (row == undefined) return false;
//     if (row.closeYn != "Y"){
//     	alert("과제 확정이후에 PFU등록 가능합니다.");
//     	return false;
//     }
    if (row.pfuNo == undefined) jobType = 'C';

    var paramObj = {
        coCd 			: $('#coCd_S').val(),
        ordrsNo 		: row.ordrsNo,
        salesCd 		: row.salesCd,
        fileTrgtKey	  	: row.pfuNo, //PFU번호임 PFUyyssss -> PFU240006
        verNo 			: row.pfuVerNo,
        actionType 		: jobType,
    };
    
    openModal("/static/html/user/cr/cr50/CR5001P01.html", 1800, $('body').height()-40, "PFU 등록 화면", paramObj, function (grid) {
//         var row = grid.target.getList("selected")[0];
//         $('#ordrsNo_S').val(row.ordrsNo);
        gridView.setData(0);
    });
}



function pfuCopySearch() {
	var row = gridView.target.getList("selected")[0];
	if (row == undefined) {
		alert("복사 원본 PFU를 선택하고 작업하시기 바랍니다.");
		return false;
	}
	if (row.pfuNo == undefined) {
		alert("등록된 PFU정보가 없습니다.");
		return false;
	}
    const tempCode = row.salesCd;
	const paramObj = {
			pfuNo 			: row.pfuNo,
			coCd 			: $("#popForm #coCd").val(),
			salesCd 		: tempCode.substring(0,5),
			pgmId 			: "CR5001M01",
	};
	openSecondModal("/static/html/user/cr/cr50/CR5001P04.html", 1400, 650, `${row.salesCd} (${row.pfuNo})의 PFU를 선택된 SalesCode에 복사 처리 합니다.`, paramObj);
}

</script>

</body>
</html>