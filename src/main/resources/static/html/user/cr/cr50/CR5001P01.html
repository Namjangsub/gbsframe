<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script type="text/javascript" src="/static/js/tinymce/tinymce.min.js"></script>

 
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body, div, ul, li { margin: 0; padding: 0; }
        ul, li { list-style: none; }

        .modal-body {
            padding: 10px;
            height: calc(100% - 40px); /* 헤더 높이만큼 뺀 값 */
            overflow-y: auto; /* 세로 스크롤바 생성 */
        }
		
		/*tab css*/
		.tab{float:left; width:100%; height:290px; margin-bottom: 20px; /* 탭과 아래 컨텐츠 사이 여백 */}
		.tabnav{font-size:0; width:100%; border:1px solid #ddd;margin-bottom: -1px; 
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;/* 중복 경계 제거 */}
		.tabnav li{display: inline-block;  height:30px; text-align:center; border-right:1px solid #ddd;}
		.tabnav li a:before{content:""; position:absolute; left:0; top:0px; width:100%; height:3px; }
		.tabnav li a.active:before{background: blue;}
		.tabnav li a.active{border-bottom:1px solid #fff;}
		.tabnav li a{ position:relative; display:block; background: #f8f8f8; color: #000; padding:0 10px; line-height:30px; text-decoration:none; font-size:12px;}
		.tabnav li a:hover,
		.tabnav li a.active{background:lightcyan; color:blue; }
		.tabcontent{padding: 2px; height:600px; border:1px solid #ddd; border-top:none; }
		
        .tabcontainer {
            margin-top: 20px; /* 탭 컨텐츠와 상단 사이의 여백 */
        }
        .mce-content-body {
            max-height: 700px;
            overflow-y: auto;
        }
    </style>
</head>


<body>

<!-- 모달 폼 -->
<div class="modal-body">
	<form id="popForm" onSubmit="return false;">
	<input type="hidden" id="pgmId"     	name="pgmId"	value="CR5001P01">
	<input type="hidden" id="ordrgMngNm"	name="creatNm" value="">		<!-- 알림톡발송용 생성자명(발주담당자) -->
	<input type="hidden" id="ordrgMngTelNo"	name="ordrgMngTelNo" value="">		<!-- 알림톡발송용 생성자전화번호 -->		
	
   	<div class="popup_area of_a" style="width: 100%; height: 100%;">
	    <div class="tit_contents">
	      <h4 class="tit" id="pfuPopTit">설비 기본정보</h4>
	    </div>
	    <div class="form-group popup_table">
	 		<table>
	
		        <colgroup>
		          <col width="10%">
		          <col width="23%">
		          <col width="11%">
		          <col width="23%">
		          <col width="10%">
		          <col width="23%">
		          <col width="10%">
		          <col width="23%">
		        </colgroup>
		        <tr>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
						</select>
					</td>
					<th>고객사</th>
					<td><input type="hidden" id="clntCd" name="clntCd" msg="고객사">
						<input type="text" id="clntNm" name="clntNm" msg="고객사" class="form-control" readonly>
					</td>
					<th>고객사PJT</th>
					<td><input type="hidden" id="clntPjt" name="clntPjt" msg="고객사PJT">
						<input type="text" id="clntPjtNm" name="clntPjtNm" msg="고객사PJT" class="form-control" readonly> 
					</td>
					<th>PFU번호</th>
					<td>
						<input type="text" id="fileTrgtKey" name="fileTrgtKey" msg="PFU번호" class="form-control" readonly>
					</td>
		        </tr>
		        
		        <tr>
					<th class="hit">수주번호</th>
					<td>
						<div class="search_form" >
							<input type="hidden"  id="ordrsCoCd" name="ordrsCoCd"  readonly="readonly">
							<input type="text"  id="ordrsNo" name="ordrsNo" readonly="readonly" required msg="수주번호">
							<a onclick="popOpendOrdrsSearch($('#ordrsNo').val(), $('#ordrsCoCd').val());"><i class="i_search_w" ></i></a>
						</div>
					</td>
					<th class="hit">Sales Code</th>
					<td colspan=3>
						<div class="search_form">
							<input type="text" id="salesCd" name="salesCd" msg="Sales Code" class="form-control" required> 
							<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>Version No</th>
					<td>
						<div style="display: flex; align-items: center;">
							<input type="text" id="verNo" name="verNo" msg="버젼번호" class="form-control" readonly> 
							<div  class="add_btn_small">
								<a id="createHistory" onclick="createHistory();" style="height: 24px; line-height: 24px; width: 100px;background-color: blanchedalmond; display:none;" authchk>Ver.Up</a>
							</div>
						</div>
					</td>
		        </tr>
		        
		        <tr>
					<th class="hit">장비명</th>
					<td colspan=3>
						<input type="text" id="ctrtNm" name="ctrtNm" msg="장비명" class="form-control" required> 
					</td>
		            <th title="운송조건을 확인합니다">운송조건</th>
		            <td>
						<input type="text" id="transOpt" name="transOpt" msg="운송조건" class="form-control" > 
		            </td>
					<th>포장/물류정보</th>
					<td>
						<input type="text" id="transInfo" name="transInfo" msg="포장/물류정보" class="form-control" > 
		            </td>
		        </tr>
		        
		        <tr>
					<th class="hit">제품군</th>
					<td colspan=1>
                       	<select id="prdtDiv" name="prdtDiv" data-kind="PRDTDIV" class="form-control" required msg="제품군"  onchange="setPrdtDiv(this, 'main');">
                       	</select>
					</td>
					<th class="hit">계약일자</th>
					<td>
						<input id="ctrtDt" name="ctrtDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
					<th title="고객담당 정보를 확인합니다">고객담당</th>
					<td>
						<input type="text" id="clntMngNm" name="clntMngNm" msg="고객담당" class="form-control" > 
					</td>
					<th>설치주소</th>
					<td>
						<input type="text" id="installAddr" name="installAddr" msg="설치주소" class="form-control" > 
		            </td>
		        </tr>
		        
		        <tr>
					<th class="hit">장비Type</th>
					<td colspan=1>
                       	<select id="prdtTyp" name="prdtTyp" data-kind="PFU01" class="form-control" required msg="장비Type">
                       	</select>
					</td>
					<th class="hit">조립완료일자</th>
					<td>
						<input id="prdctnDt" name="prdctnDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
		            <th title="고객 E-Mail을 확인합니다">고객 E-Mail</th>
		            <td>
						<input type="text" id="clntMngEmail" name="clntMngEmail" msg="고객 E-Mail" class="form-control" > 
		            </td>
					<th>입구Spec</th>
					<td>
		                <div style="display: flex; align-items: center;">
						폭 :　 <input type="text" id="gateWidth" name="gateWidth" msg="입구Spec 폭" class="form-control" style="width:50px;" >M　　
						높이 :　 <input type="text" id="gateHeight" name="gateHeight" msg="입구Spec 높이" class="form-control"  style="width:50px;" > M
		                </div>
		            </td>
		        </tr>
		        
		        <tr>
					<th class="hit">작동방식</th>
					<td colspan=1>
                       	<select id="prdtCav" name="prdtCav" data-kind="PFUCAV" class="form-control" required msg="장비Type">
                       	</select>
					</td>
					<th class="hit">T/O완료일자</th>
					<td>
						<input id="acptncDt" name="acptncDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
		            <th title="고객전화번호를 확인합니다">고객전화번호</th>
		            <td>
						<input type="text" class="form-control" id="clntMngHp" name="clntMngHp" onkeyup="telNumberFormatter(this);" maxlength="13"> 
		            </td>
					<th>이동장치</th>
					<td>
						<input type="text" id="transVehicle" name="transVehicle" msg="이동장치" class="form-control" > 
		            </td>
		        </tr>
		        
		        <tr>
		            <th class="hit" title="담당자 정보를 확인합니다">영업담당자</th>
		            <td>
		                <div class="search_form">
		                    <input type="text" id="mngIdNm" name="mngIdNm" onkeydown="if(event.keyCode==13)openUserTree( this.value);" required readonly>
		                    <input type="hidden" id="mngId" name="mngId" required msg="영업담당자" readonly>
		                    <!--  <a onclick="openUserTree( document.getElementById('mngIdNm').value);"><i class="i_search_w"></i></a> -->
		                </div>
		            </td>
					<th>제작업체</th>
					<td>
		                <div class="search_form">
						<input type="hidden" id="mkerCd" name="mkerCd">
						<input type="text" id="mkerNm" name="mkerNm" readonly>
						</div>
					</td>
					<th>일정예외상황</th>
					<td>
						<input type="text" id="PLAN_EXCEPT_NM" name="PLAN_EXCEPT_NM" data-kind="PLANEXCEPT" class="form-control" readonly> 
					</td>
					<th>연구소접수일</th>
					<td>
						<input type="text" id="rndAcceptDt" name="rndAcceptDt" msg="연구소접수일" class="form-control" readonly> 
					</td>
		        </tr>
			</table>
		</div>
	</div>
		
	
  <div class="tab">
    <ul class="tabnav">
      <li><a href="#tab01">1.PFU 기본정보</a></li>
      <li><a href="#tab02">2.PFU 설비기본 CHECK사양(1)</a></li>
      <li><a href="#tab05">2.PFU 설비기본 CHECK사양(2)</a></li>
      <li><a href="#tab03">3.PFU 사용 부품 MAKER</a></li>
      <li><a href="#tab04">4.PFU 세부 CHECK 사양</a></li>
      <li><a href="#tab09">5.PFU 첨부파일</a></li>
      <li><a href="#tab10">공유 및 결재</a></li>
    </ul>
    
<!-- 	Tab 컨텐츠 -->
    <div class="tabcontent">
      <div id="tab01">
	      <div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">1. PFU 기본정보</h4>
		    </div>
			    <div class="form-group popup_table">
			 		<table>
			
			        <colgroup>
			          <col width="10%">
			          <col width="23%">
			          <col width="11%">
			          <col width="23%">
			          <col width="10%">
			          <col width="23%">
			          <col width="10%">
			          <col width="23%">
			        </colgroup>
			        <tr>
			        	<th  colspan="8">
						      <h4 class="tit">제품 정보(작업포인트) - 형상이미지 파일 첨부</h4>
						</th>
			        </tr>
			        <tr>
						<td colspan="8">
							<textarea id="ctrtRmk" name="ctrtRmk"  msg="제품 정보(작업포인트)">제품 정보(작업포인트)</textarea>
						</td>			
			        </tr>
			        <tr>
						<!-- 콘텐츠 -->
						<div class="contents">
						    <!-- 리스트 -->
						    <div class="ax5_grid">
				              <div class="table_list_tit">
				                  <h5 class="tit">제품 기본정보</h5>
				                  <div class="add_btn_small plus-minus">
				                      <a onclick= "insertList('AREA01GridView');" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 정보추가</a>
				                      <a onclick= "deleteList('AREA01GridView')" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택정보삭제 </a>
				                  </div>
				              </div>
				              <div>
				              	<div data-ax5grid="AREA01-grid" data-ax5grid-config="{}" style="height:200px; width: 100%; " ></div>
				              </div>
						    </div>
						</div>
			        </tr>
			      </table>
			      
			</div>
      	</div>
      
      </div><!-- tab01 -->
      
      <div id="tab02">
		<div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">2.PFU 설비기본 CHECK사양</h4>
		    </div>
		
				<!-- 콘텐츠 -->
				<div class="contents">
				    <!-- 리스트 -->
				    <div class="ax5_grid">
		              <div class="table_list_tit">
		                  <h5 class="tit">사용 부품 MAKER</h5>
		                  <div class="add_btn_small plus-minus">
		                      <a onclick= "insertList('AREA02GridView');" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 부품추가</a>
		                      <a onclick= "deleteList('AREA02GridView')" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택부품삭제 </a>
		                  </div>
		              </div>
		              <div>
		              	<div data-ax5grid="AREA02-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
		              </div>
				    </div>
				</div>
				
		  </div>
		</div><!-- tab02 -->
      
      <div id="tab05">
		<div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">2.PFU 설비기본 CHECK사양(2)</h4>
		    </div>
		
		 		<table>
		        <colgroup>
		          <col width="10%">
		          <col width="23%">
		          <col width="10%">
		          <col width="23%">
		          <col width="10%">
		          <col width="24%">
		        </colgroup>
		
		        <tr>
		        	<th  colspan="6" style="background-color: bisque;">
					      <h4 class="tit">[ 고객 요청 사항 ]</h4>
					</th>
		        </tr>
		        
		        <tr>
					<td colspan="6" style="background-color: aqua;">
						<textarea id="custReq" name="custReq"  msg="고객 요청 사항">고객 요청 사항</textarea>
					</td>			
		        </tr>
		
		        <tr>
		        	<th  colspan="6" style="background-color: bisque;">
					      <h4 class="tit">[ SPARE LIST ]</h4>
					</th>
		        </tr>
		        
		        <tr>
					<td colspan="6"  style="background-color: aqua;">
						<textarea id="spareList" name="spareList"  msg="SPARE LIST">SPARE LIST</textarea>
					</td>			
		        </tr>
		
		        <tr>
		        	<th  colspan="6"  style="background-color: bisque;">
					      <h4 class="tit">[ 특기사항 ] ※별도기록사항 (ex:부대창치, 고객사 사급품, 연계장비 등)</h4>
					</th>
		        </tr>
		        
		        <tr>
					<td colspan="6"  style="background-color: aqua;">
						<textarea id="pfuEtc" name="pfuEtc"  msg="특기사항">특기사항</textarea>
					</td>			
		        </tr>
		      </table>
		  </div>
		</div><!-- tab05 -->
      
      
        <div id="tab03">
			<div class="popup_area of_a" style="width: 100%; height: 100%;">
			    <div class="tit_contents">
			      <h4 class="tit">3. 사용 부품 MAKER</h4>
			    </div>
				<!-- 콘텐츠 -->
				<div class="contents">
				    <!-- 리스트 -->
				    <div class="ax5_grid">
		              <div class="table_list_tit">
		                  <h5 class="tit">사용 부품 MAKER</h5>
		                  <div class="add_btn_small plus-minus">
		                      <a onclick= "insertList('AREA03GridView');" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 부품추가</a>
		                      <a onclick= "deleteList('AREA03GridView')" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택부품삭제 </a>
		                  </div>
		              </div>
		              <div>
		              	<div data-ax5grid="AREA03-grid" data-ax5grid-config="{}" style="height:500px; width: 100%" ></div>
		              </div>
				  </div>
				</div>
			    
			</div>
		      
        </div>
      
        <div id="tab04">
		<div class="popup_area of_a" style="width: 100%; height: 100%;">
		    <div class="tit_contents">
		      <h4 class="tit">4.PFU 세부 CHECK사양</h4>
		    </div>
		
				<!-- 콘텐츠 -->
				<div class="contents">
				    <!-- 리스트 -->
				    <div class="ax5_grid">
		              <div class="table_list_tit">
		                  <h5 class="tit">세부 CHECK사양</h5>
		                  <div class="add_btn_small plus-minus">
		                      <a onclick= "insertList('AREA04GridView');" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> 사양추가</a>
		                      <a onclick= "deleteList('AREA04GridView')" style="width: 90px;" authchk><i class="fas fa-trash"></i> 선택사양삭제 </a>
		                  </div>
		              </div>
		              <div>
		              	<div data-ax5grid="AREA04-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
		              </div>
				    </div>
				</div>
		  </div>
        </div>
      
	    <div id="tab09">
			<div class="popup_area of_a" style="width: 100%; height: 100%;">
			    <div class="tit_contents">
			      <h4 class="tit">5. PFU 첨부파일</h4>
			    </div>
				<!-- 공통 파일 영역 -->
				<div id="fileList_area" style="margin-top: 0px;"></div>
			</div>
	    </div><!-- tab09 -->
      
	    <div id="tab10">
            <div class="popup_table" id="approval_trgt" style="display: flex; justify-content: center">
				<div class="popup_area of_a" style="width: 60%; height: 100%;">
                    <table style="border:0px;">
                        <tr style="height:30px;">
                        	<td>
							    <div class="tit_contents">
							      <h4 class="tit">※ 공유 및 결재</h4>
							    </div>
                            </td>
                        </tr>
                        
                        <tr>
                        	<td>
								<!-- 공통 파일 영역 -->
				                 <div class="add_btn_small pdl10 plus-minus" id="plus-minus">
				                     <a onclick="insertShareUserModal1();" style="height: 30px; line-height: 28px;" authchk>+</a>
				                     <a onclick="deleteShareUser1();" class="insDel" style="height: 30px; line-height: 28px;" authchk>-</a>
				                 </div>
				            </td>
                        </tr>
                        <tr>
                        	<td>
				                 <div class="ax5_grid" data-ax5grid="third-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
				            </td>
                        </tr>
		            </table>
				</div>
			</div>
	    </div><!-- tab10 -->
      </div><!--tabcontent-->
  </div><!--tab-->
</form>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" onclick="setReportMain();"><i class="fas fa-envelope"></i> PFU 출력</button>
<!-- 		<button type="button" id="mailSendBtn" onclick="sendMailCall();" authChk><i class="fas fa-envelope"></i> 기타발주서메일</a></button> -->
	</div>

</div>
<script>
	var tabArrInit = {tab1:true, tab2:true, tab3:true, tab4:true, tab9:true, tab10:true};
	var thisGridRow=0; // 선택된 행 정보 저장할 변수
	var thisGridCol=0; // 선택된 열 정보 저장할 변수
	var paramActionType = modalStack.last().paramObj.actionType
	var AREA01GridView;
	var AREA02GridView;
	var AREA03GridView;
	var AREA04GridView;
 	// 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
    var kakaoErr = [];

	ax5.ui.grid.formatter["changeYn"] = function () {
		var color = this.value == "N" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E") {
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};

	function gridStyle(row) {
		if (!row) return "";
// 		if (row.indChk === "D")  return "grid-cell-orange";
		if (row.indChk === "D")  return "grid-font-red";
// 		if (row.matrError === "E")  return "grid-no-msg-font-blue-bold";
// 		if (pasFloatChk(row.lowerQty) == 0)  return "grid-no-msg-font-blue-bold";
// 		if (pasFloatChk(row.pchsBomCnt) > 0)  return "grid-font-red";
		return "";
	}

	var gridColumn01 =
		[
	        {key : "strChkNm", 	label : "표준PFU", 			width : 60,		align: "center", formatter: function() { return this.item.stdChk === "Y" ? "표준" : "추가";}, styleClass: function () { return gridStyle(this.item); } }, 
	        {key : "indChkNm", 	label : "수정/삭제", 			width : 60,		align: "center", formatter: function() { if (this.item.indChk === "U") { return "수정"; } else if (this.item.indChk === "D") { return "삭제"; } }, styleClass: function () { return gridStyle(this.item); } }, 
			{key : "partNm", 	label : "설비구분", 				width : 300,	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partStd", 	label : "FRT", 				width : 260, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partCust", 	label : "RR", 				width : 260, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
// 			{key : "partConf", 	label : "확정", 				width : 220, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
// 				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partEtc", 	label : "참고설비", 			width : 260, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "creatIdNm", label : "등록담당", 			width : 60,	 hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "creatDttm", label : "등록일시", 			width : 90,  hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "udtIdNm", 	label : "수정담당", 			width : 60,	 hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "udtDttm", 	label : "수정일시", 			width : 90,  hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "changeYn", 	label : "수정", 				width : 80,  hidden: true },
	        {key : "updChk", 	label : "updChk", 			width : 80,  hidden: true},
	        {key : "prdtDiv", 	label : "제품분류", 			width : 80,  hidden: true},
	        {key : "areaDiv", 	label : "구매수정", 			width : 80,  hidden: true},
	        {key : "partDiv", 	label : "구매수정", 			width : 80,  hidden: true},
			{key : "partId", 	label : "코드ID", 			width : 80,	 hidden: true},
			{key : "stdChk", 	label : "stdChk", 			width : 80,	 hidden: true},
			{key : "indChk", 	label : "indChk", 			width : 80,	 hidden: true},
			{key : "creatId", 	label : "등록담당", 			width : 80,	 hidden: true},
			{key : "creatPgm", 	label : "creatPgm", 		width : 80,	 hidden: true},
			{key : "udtId", 	label : "수정담당", 			width : 80,	 hidden: true},
			{key : "udtPgm", 	label : "udtPgm", 			width : 80,	 hidden: true},
			{key : "orginData", label : "orginData", 		width : 80,	 hidden: true},
		];

	var gridColumn02 = 
		[
	        {key : "strChkNm", 	label : "표준PFU", 			width : 60,		align: "center", formatter: function() { return this.item.stdChk === "Y" ? "표준" : "추가";}, styleClass: function () { return gridStyle(this.item); } }, 
	        {key : "indChkNm", 	label : "수정/삭제", 			width : 60,		align: "center", formatter: function() { if (this.item.indChk === "U") { return "수정"; } else if (this.item.indChk === "D") { return "삭제"; } }, styleClass: function () { return gridStyle(this.item); } }, 
			{key : "partNm", 	label : "설비구분", 			width : 160,	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partStd", 	label : "건양표준", 			width : 300, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partEtc", 	label : "옵션사항", 			width : 300, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partCust", 	label : "고객요청", 			width : 200, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "partConf", 	label : "확정", 				width : 200, 	align: "left", 	editor: { type: "textarea", disabled: function () { return this.item.changeYn == "Y"; } }, styleClass: function () { return gridStyle(this.item); },  
				formatter: function () { return (this.value) ? '<span style="display: block;white-space: pre;">'+this.value+'</span>' : '' }},
			{key : "creatIdNm", label : "등록담당", 			width : 60,	 hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "creatDttm", label : "등록일시", 			width : 90,  hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "udtIdNm", 	label : "수정담당", 			width : 60,	 hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "udtDttm", 	label : "수정일시", 			width : 90,  hidden: false, styleClass: function () { return gridStyle(this.item); }},
			{key : "changeYn", 	label : "수정", 				width : 80,  hidden: true},
	        {key : "updChk", 	label : "updChk", 			width : 80,  hidden: true},
	        {key : "prdtDiv", 	label : "제품분류", 			width : 80,  hidden: true},
	        {key : "areaDiv", 	label : "영역구분", 			width : 80,  hidden: true},
	        {key : "partDiv", 	label : "PART구분", 			width : 80,  hidden: true},
	        {key : "partId", 	label : "코드ID", 			width : 100, hidden: true},
	        {key : "partId", 	label : "코드ID", 			width : 100, hidden: true},
			{key : "stdChk", 	label : "stdChk", 			width : 80,	 hidden: true},
			{key : "indChk", 	label : "indChk", 			width : 80,	 hidden: true},
			{key : "orgPartId", label : "orgPartId", 		width : 80,	 hidden: true},
			{key : "creatId", 	label : "등록담당", 			width : 80,	 hidden: true},
			{key : "creatPgm", 	label : "creatPgm", 		width : 80,	 hidden: true},
			{key : "udtId", 	label : "수정담당", 			width : 80,	 hidden: true},
			{key : "udtPgm", 	label : "udtPgm", 			width : 80,	 hidden: true},
			{key : "orginData", label : "orginData", 		width : 80,	 hidden: true},
		];
	
	
	function createGridView(gridName, gridTarget, gridColumn, prdtDiv, areaDiv) {
	    return {
	        initView: function() {
	            this.target = new ax5.ui.grid();
	            this.target.setConfig({
	                showLineNumber    : false,
	                showRowSelector   : false,
	                multipleSelect    : false,
	                sortable: false,
	                target: $(gridTarget),
	                header: {
	                    align: "center",
	                    selector: true
	                },
	                body: {
	                    onClick: function (columnIndex, rowData) {
	                        this.self.clearSelect();
	                        this.self.select(this.dindex);
	                        thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
	                        thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
	                    },
	                    onDBLClick: function () {
	                        this.self.clearSelect();
	                        this.self.select(this.dindex);
	                    },
	                    onDataChanged: function (e, i) {
	                    	if (this.item.updChk != "I") { 
	                    		this.item.updChk = "U";
	                    		this.item.indChk = "U";
	                    		window[gridName].target.repaint();
	                    	}
	                        if (this.key == "partNm") {
	                        }
	                    },
	                },
	                columns :  gridColumn,
	                contextMenu: {
	                    iconWidth: 20,
	                    acceleratorWidth: 100,
	                    itemClickAndClose: false,
	                    icons: {
	                        'arrow': '<i class="fa fa-caret-right"></i>'
	                    },
	                    items: [
	                        {type: 1, label: "붙여넣기"},
	                        {divide: true},
	                        {type: 2, label: "줄추가"},
	                        // {type: 3, label: "내용 삭제"},
	                        {type: 4, label: "줄삭제"},
	                    ],
	                    popupFilter: function (item, param) {
	                        if(param.element) {
	                            return true;
	                        } else {
	                            return item.type == 1;
	                        }
	                    },
	                    onClick: function (item, param) {
	                        thisGridRow = param.dindex;
	                        thisGridCol = param.colIndex;
	                        
	                        if (item.label == "붙여넣기") {
	                            gridPaste(gridName, thisGridRow, thisGridCol);
	                        } else if (item.label == "줄추가") {
// 	                            let tempRow = JSON.parse(JSON.stringify(window[gridName].target.list[param.dindex]));
// 	                            tempRow.updChk = "I";	//추가 등록 자료임.
// 	                            tempRow.indChk = "I";	//추가 등록 자료임.
// 	                            tempRow.stdChk = "N";	//추가시 표준  PFU항목 아님
// 	                            tempRow.orginData = "";	//추가시 표준  PFU항목 아님
// 	                            tempRow.orgPartId = "";	//원본 코드는 clear 처리
// 	                            window[gridName].target.addRow(tempRow, param.dindex+1);
	                            insertList(gridName, true, param.dindex+1)
	                        } else if (item.label == "줄삭제") {
	                        	window[gridName].target.clearSelect();
	                        	window[gridName].target.select(param.dindex);
	                            deleteList(gridName);
	                        	
	                        }
	                        window[gridName].target.contextMenu.close();
	                    }
	                },
	            });
	            return this;
	        },
	        setData: function(chk) {
	            var target = this.target;
	            var formData = {
	                "userId" 	: jwt.userId,
	                "clntCd" 	: $("#clntCd").val(),
	                "ordrsNo" 	: $("#ordrsNo").val(),
	                "salesCd" 	: $("#salesCd").val(),
// 	                "prdtDiv" 	: prdtDiv,
	                "prdtDiv" 	: $('#prdtDiv option:selected').data('rprc'),
	                "areaDiv" 	: areaDiv,
	                "fileTrgtKey" : $("#fileTrgtKey").val(),
	            }
	            let callAjax = paramActionType=="C" ? "/user/cr/cr50/selectPFUAreaItemList" : "/user/cr/cr50/selectPFUAreaRetriveList";
	            postAjax(callAjax, formData, null, function(data) {
	                var list = data.result;
	                
	                list = $.map(list, function(obj) {
	                    obj.originData = `${obj.partNm}${obj.partStd}${obj.partCust}${obj.partConf}${obj.partEtc}${obj.stdChk}${obj.indChk}${obj.orgPartId}`;
	                    return obj; 
	                });

	                
	                target.setData({
	                    list : list,
	                    page : {
	                        totalElements : list.length
	                    }
	                });
	            });
	        }
	    };
	}
	

	

    
    //공유 결재 그리드
 	var gridViewPop7 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $('[data-ax5grid="third-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView7.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 50},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",	label: "ID",      	align: "center",   width: 130, hidden: false},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 80},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 60},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 90},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 130},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: 200},
                    {key: "telNo",      		label: "H.P",		align: "center",   width: 130},
                    {key: "todoKey",      		label: "todoKey",		align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",		align: "center",   width: 130, hidden: true},                   
                    {key: "todoId",      		label: "todoId",		align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			let fileTrgtKey = $("#fileTrgtKey").val();
        			if (!fileTrgtKey) return false;
        			
                    var targetObj = this.target;
                    var formData = {
                        "fileTrgtKey" 	: fileTrgtKey,
                        "reqNo" 		: fileTrgtKey,
                        "etcField2" 	: $("#verNo").val(),
                        "pageNo" 		: _pageNo + 1
                    }
                    postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
                        var list = data.result;
                        if( list.length > 0 ) {
                            var inCnt = 0;
                            var inGb = 0; //해당 결재개수 변수
                            let processChk = false;	//결재 진행여부 체크 (결재가 하나라도  진행되면 true)
                            $.each(list, function (idx, elem) {
                                if (elem.gb == "결재") {	//결재와 공유 중 결재 갯수 파악
                                	if (elem.sanctnSttus == "Y") processChk = true;
                                
                                	inGb++;
	                                if( elem.sanctnSttus == "Y" ) inCnt++;
                                }
                            })
                            debugger;
                            //PFU 결재올렸을때 ver.up 버튼 하이드 처리
                            if (processChk && (inCnt == inGb)){	//결재자가있고 결재가 완료되면 버젼업버튼 활성화 및 수정버튼 숨김
                                $('#createHistory').show();
                                $('#actionBtn').hide();
                            } else if (list.length == 0 || inCnt == 0){	//결재자가 없으면 버젼업 버튼 숨김
                                //아무도 결재가 이뤄지지 않았을 경우의 조건
                                $('#createHistory').hide();
                            } else {								//결재 진행중이면 버젼업, 수정 버튼 숨김처리
                                $('#createHistory').hide();
                                $('#actionBtn').hide();
                            }
                        }
                        targetObj.setData({
                            list : list,
                            page : {
                                totalElements : list.length
                            }
                        });
                    });
                },

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    } 
   	  					});
          		}
                ,
                setData3 : function(_pageNo) {
                   var targetObj = this.target;
                   var paramObj = { "userId": jwt.userId
                               , "appDiv": 'APPDIV09'		//수주원가관리 결재라인
                   };
                    postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
                    var list = data.result;
                       targetObj.setData({
                            list : list,
                            page : { totalElements : list.length } 
                         });
                      });
                  }
  	}
	
	
    $(document).ready(function () {
//     	$('#fileTrgtKey').val('PFU240006');

    	$('#fileTrgtKey').val(modalStack.last().paramObj.fileTrgtKey);
    	$('#salesCd').val(modalStack.last().paramObj.salesCd)
    	paramActionType = modalStack.last().paramObj.actionType;
    	
    	//조회모드 (결재, 공유) 이면 그리드 편집 못하게 수정
    	if (paramActionType=="T" || paramActionType =="S") { 
	    	// 인덱스 배열을 반복하여 'editor' 속성을 삭제합니다.
	    	
			//editor 속성이 있는 목록입니다.
			let gridind01 = [2, 3, 4, 5];
			let gridind02 = [2, 3, 4, 5, 6];
	    	gridind01.forEach(function(index) {
	    		if (gridColumn01[index]) delete gridColumn01[index].editor;
	    	});
	
	    	gridind02.forEach(function(index) {
	    		if (gridColumn02[index])delete gridColumn02[index].editor;
	    	});
	    	
// 	    	$('.plus-minus').hide();	//추가 삭제버튼 숨김
// 	    	$('#actionBtn').hide();	//등록버튼 숨김
    	}
	    
        setCommonSelect($("select[data-kind]"));
        
        //계약일자
        $('#ctrtDt').datepicker({ format: "yyyy-mm-dd",  language: "ko",  autoclose: true });
        // 조립완료일자
        $('#prdctnDt').datepicker({ format: "yyyy-mm-dd",  language: "ko",  autoclose: true });
        // T/O완료일자
        $('#acptncDt').datepicker({ format: "yyyy-mm-dd",  language: "ko",  autoclose: true });

        

	    // AREA01 GridView 인스턴스 생성
	    AREA01GridView = createGridView("AREA01GridView", '[data-ax5grid="AREA01-grid"]', gridColumn01, 'PFU01', 'PFUAREA01');
	    // AREA02 GridView 인스턴스 생성
	    AREA02GridView = createGridView("AREA02GridView", '[data-ax5grid="AREA02-grid"]', gridColumn02, 'PFU01', 'PFUAREA02');
	    // AREA03 GridView 인스턴스 생성
		AREA03GridView = createGridView("AREA03GridView", '[data-ax5grid="AREA03-grid"]', gridColumn02, 'PFU01', 'PFUAREA03');
	    // AREA04 GridView 인스턴스 생성
		AREA04GridView = createGridView("AREA04GridView", '[data-ax5grid="AREA04-grid"]', gridColumn02, 'PFU01', 'PFUAREA04');

		
		AREA01GridView.initView().setData();
		AREA02GridView.initView().setData();
		AREA03GridView.initView().setData();
		AREA04GridView.initView().setData();
		//결재그리드 활성화및 초기화
        gridViewPop7.initView().setData3(0);
		
		//TAB Menu Control Start-----------------
		$('.tabcontent > div').hide();
		$('.tabnav a').click(function () {
			$('.tabcontent > div').hide().filter(this.hash).fadeIn();
// 			$('.tabcontent > div').hide().filter(this.hash).show();
			$('.tabnav a').removeClass('active');
			$(this).addClass('active');
			
			if ($(this).attr('href') == "#tab01" && tabArrInit.tab1) {
				AREA01GridView.setData(AREA01GridView.target.list);
				tabArrInit.tab1 = false;
			} else if ($(this).attr('href') == "#tab02" && tabArrInit.tab2) {
				AREA02GridView.setData(AREA02GridView.target.list);
				tabArrInit.tab2 = false;
			} else if ($(this).attr('href') == "#tab03" && tabArrInit.tab3) {
				AREA03GridView.setData(AREA03GridView.target.list);
				tabArrInit.tab3 = false;
			} else if ($(this).attr('href') == "#tab04" && tabArrInit.tab4) {
				AREA04GridView.setData(AREA04GridView.target.list);
				tabArrInit.tab4 = false;
			} else  if ($(this).attr('href') == "#tab09" && tabArrInit.tab9) {
				fileTreeGridView.reqSetData(fileTreeGridView.target.list)
				tabArrInit.tab9 = false;
			} else  if ($(this).attr('href') == "#tab10" && tabArrInit.tab10) {
				gridViewPop7.setData(gridViewPop7.target.list)
				tabArrInit.tab10 = false;
			}
			
			return false;
		}).filter(':eq(0)').click();
		//TAB Menu Control End-----------------
		

		//textarea WYSIWYGHTML 설정하기
// 		WYSIWYGHTML();

// 	    $("#save").on("click", function(){
// 	        var content = tinymce.activeEditor.getContent();
// 	        console.log(content);
// 	    });
	    

		// 초기화가 완료될 때까지 대기하고 후속 작업 수행
        Promise.all([
    		WYSIWYGHTML('#ctrtRmk', 700),
    		WYSIWYGHTML('#custReq', 500),
    		WYSIWYGHTML('#spareList', 500),
    		WYSIWYGHTML('#pfuEtc', 500),
        ]).then((editors) => {
               	if (paramActionType == "U" || paramActionType == "T" || paramActionType == "S") {
       				selectPFUInfo();				//PFU 정보 호출
               	} else if (paramActionType == "C") {
               		selectSalesCdInfo();			//신규 생성시 salesCd의 자료 가져오기
               	}
        }).catch((error) => {
            console.error('Error initializing TinyMCE:', error);
        });
		
	    // tinymce html 편집기 end ----------------------------------------------------------
	    

		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (paramActionType == "C") {
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertPFU();
			});

		} else if (paramActionType == "U") {
			$('#pfuPopTit').text('설비 기본정보 수정');
// 			selectPFUInfo();				//PFU 정보 호출 (WYSIWYGHTML 초기화가 끝나면 자료를 가져와서 화면에 뿌려줍니다.)

			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updatePFU();
			});
		}



	    // 그리드 내용 붙여넣기 이벤트 처리-->간헐적 실행으로 오작동~~~ 원인을 모르겠음 아래이벤트로 대체
	    // Ctrl + V 단축키 이벤트 처리
		AREA01GridView.target.$target.on("paste", function (e, a) { gridPaste("AREA01GridView", thisGridRow, thisGridCol); });
		AREA02GridView.target.$target.on("paste", function (e, a) { gridPaste("AREA02GridView", thisGridRow, thisGridCol); });
		AREA03GridView.target.$target.on("paste", function (e, a) { gridPaste("AREA03GridView", thisGridRow, thisGridCol); });
		AREA04GridView.target.$target.on("paste", function (e, a) { gridPaste("AREA04GridView", thisGridRow, thisGridCol); });
		
        
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey	: $("#fileTrgtKey").val()
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//--------------------------------------------------------------- 
		$("#fileAttachTxt").click(); //파일첨부내역 활성화 

		authChk();						// 권한체크

	});
    
 	// 출력 버튼용
	function setReportMain() {
		let fileName = "aaaClobTest.jrf";
		let arg = "coCd#" + $("#coCd").val() + "#partNo#" + "B"
             	+ "#";
		callReport(fileName, arg, "1050", "700", "PFU출력" + "B");
	}
    
	function gridPaste(targetGrid, thisGridRow, thisGridCol) {
	    navigator.clipboard.readText().then(pasteData => {
	        if (pasteData === undefined || pasteData === "" || thisGridRow === undefined) {
	            return;
	        }

	        // 붙여넣기할 데이터를 배열로 변환한다.
	        pasteData = (pasteData.charAt(pasteData.length - 1) === "\n") ? pasteData : pasteData + "\n";
	        var pasteRows = pasteData.split("\n").map(function (row) {
	            return row.split("\t");
	        });

	        // 붙여넣기를 시작할 셀의 인덱스를 구한다.
	        var startRowIndex = thisGridRow;
	        var startColIndex = thisGridCol;

	        // 붙여넣을 데이터의 행과 열 개수를 구한다.
	        var numRows = pasteRows.length;
	        var numCols = pasteRows[0].length;

	        // 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
	        let gridView = window[targetGrid];
	        var gridLength = gridView.target.getList().length;
	        var gridColumns = gridView.target.config.columns;
			
	        let newRow = {updChk: "I", stdChk:"N", indChk:"I", orgPartId:"", orginData:""};
	        for (var i = 0; i < numRows - 1; i++) {
	            if (startRowIndex + i >= gridLength) {
	            	
	                gridView.target.addRow($.extend(newRow, gridView.target.list[thisGridRow], {__index: undefined}));
// 	                gridView.target.setValue(startRowIndex + i, 'stdChk', 'N');
// 	                gridView.target.setValue(startRowIndex + i, 'indChk', 'I');
	                gridLength = gridView.target.getList().length;
	            }

	            for (var j = 0; j < numCols; j++) {
	                var calRow = startRowIndex + i;
	                var calCol = startColIndex + j;
	                // carriage return 문자 삭제
	                var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');

	                if (calCol >= gridColumns.length) {
	                    gridView.target.addColumn();
	                }

	                gridView.target.setValue(calRow, gridColumns[calCol].key, cellData);
	                let chkUpdChk = gridView.target.list[calRow].updChk;
	                if (chkUpdChk != "I" && chkUpdChk != "D" ) {  //기존값이 수정이나, 삭제인경우에는 Update 안함.
		                gridView.target.setValue(calRow, 'updChk', 'U');
		                gridView.target.setValue(calRow, 'indChk', 'U');
	                }
	            }
	        }
	        gridView.target.repaint();
	    });
	}
	

    function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}

    
    function insertList(gridView, isInsert= false, dindex) {
        var newRow = window[gridView].target.getList("selected")[0];
        if (!newRow) {
            newRow = window[gridView].target.getList()[window[gridView].target.list.length - 1];
        } 
        
        if (!newRow) {
        	let tempArea = "";
        	if (gridView == "AREA01GridView") {
        		tempArea = 'PFUAREA01';
        	} else if (gridView == "AREA02GridView") {
        		tempArea = 'PFUAREA02';
        	} else if (gridView == "AREA03GridView") {
        		tempArea = 'PFUAREA03';
        	} else if (gridView == "AREA04GridView") {
        		tempArea = 'PFUAREA04';
        	}
            newRow = {
                useYn		:  "Y",
                reaDiv 		:  tempArea,
                fileTrgtKey :  $('#fileTrgtKey ').val(),
                orgPartId  	:  tempArea + "0101",
                originData  :  "",
                partDiv  	:  tempArea + "01",
                prdtDiv		:  $('#prdtDiv option:selected').data('rprc'),
            };
        }
        newRow.updChk = "I";
        newRow.stdChk = "I";
        newRow.indChk = "I";
        newRow.orgPartId = "";
        newRow.originData = "";
        newRow.creatId = "";
        newRow.creatIdNm = "";
        newRow.creatDttm = "";
        newRow.creatPgm = "";
        newRow.udtId = "";
        newRow.udtIdNm = "";
        newRow.udtDttm = "";
        newRow.udtPgm = "";
        newRow.__index = "";

//         gridView.target.addRow($.extend({}, newRow), "last", {focus: "END"});

        if (isInsert) {
            let tempRow = JSON.parse(JSON.stringify(newRow));
            window[gridView].target.addRow(tempRow,dindex);
        } else {
        	 window[gridView].target.addRow($.extend({}, newRow), "last", { focus: "END" });
             setTimeout(function() {
            	 window[gridView].target.focus("END");
            }, 100);
        }
        
    }

	function deleteList(gridView) {
	    var delRow = window[gridView].target.getList("selected");
	    
	    for (var i = delRow.length - 1; i >= 0; i--) {
	        var list = delRow[i];
		    if (list.stdChk == 'Y') {
		    	list.changeYn = 'N';
		    	list.indChk = "D";	//추가 등록 자료임.
		    	window[gridView].target.updateRow(list, list.__index);
		    } else {
	        	window[gridView].target.removeRow(list.__index);
		    }
	    }
// 	    window[gridView].target.repaint(); // 수정 내용 적용하기
	}


    
	function WYSIWYGHTML(selector, maxHeight) {
	    return new Promise((resolve, reject) => {
		    // tinymce html 편집기 start ----------------------------------------------------------
		    var plugins = [
		        "advlist", "autolink", "lists", "link", "image", "charmap", "print", "preview", "anchor",
		        "searchreplace", "visualblocks", "code", "fullscreen", "insertdatetime", "media", "table",
		        "code", "help", "wordcount", "save", 'autoresize'
		    ];
		    var edit_toolbar = 'formatselect fontselect fontsizeselect |'
		               + ' forecolor backcolor |'
		               + ' bold italic underline strikethrough |'
		               + ' alignjustify alignleft aligncenter alignright |'
		               + ' bullist numlist |'
		               + ' table tabledelete |'
		               + ' link image';
	
		    tinymce.init({
	//	     	language: "ko_KR", //한글판으로 변경
		    	license_key: 'gpl',
		        selector: selector,
	            autoresize_bottom_margin: 0,
	            max_height: maxHeight,
	            setup: function (editor) {
	                editor.on('init', function () {
	                    editor.getDoc().body.style.maxHeight = '700px';
	                    editor.getDoc().body.style.overflowY = 'auto';
	                    editor.getBody().style.fontSize = '10pt';
	                    resolve(editor); // 초기화가 완료되면 Promise를 해결합니다.
	                });
	            },
		        height: 300,
		        menubar: false,
		        plugins: plugins,
		        toolbar: edit_toolbar,
		        
		        /*** image upload ***/
		        image_title: true,
		        /* enable automatic uploads of images represented by blob or data URIs*/
		        automatic_uploads: true,
		        /*
		            URL of our upload handler (for more details check: https://www.tiny.cloud/docs/configure/file-image-upload/#images_upload_url)
		            images_upload_url: 'postAcceptor.php',
		            here we add custom filepicker only to Image dialog
		        */
		        file_picker_types: 'image',
		        /* and here's our custom image picker*/
		        file_picker_callback: function (cb, value, meta) {
		            var input = document.createElement('input');
		            input.setAttribute('type', 'file');
		            input.setAttribute('accept', 'image/*');
	
		            /*
		            Note: In modern browsers input[type="file"] is functional without
		            even adding it to the DOM, but that might not be the case in some older
		            or quirky browsers like IE, so you might want to add it to the DOM
		            just in case, and visually hide it. And do not forget do remove it
		            once you do not need it anymore.
		            */
		            input.onchange = function () {
		                var file = this.files[0];
	
		                var reader = new FileReader();
		                reader.onload = function () {
		                    /*
		                    Note: Now we need to register the blob in TinyMCEs image blob
		                    registry. In the next release this part hopefully won't be
		                    necessary, as we are looking to handle it internally.
		                    */
		                    var id = 'blobid' + (new Date()).getTime();
		                    var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
		                    var base64 = reader.result.split(',')[1];
		                    var blobInfo = blobCache.create(id, file, base64);
		                    blobCache.add(blobInfo);
	
		                    /* call the callback and populate the Title field with the file name */
		                    cb(blobInfo.blobUri(), { title: file.name });
		                };
		                reader.readAsDataURL(file);
		            };
		            input.click();
		        },
		        /*** image upload ***/
		        
		        content_style: 'body { font-family:Helvetica,Arial,sans-serif; } p {margin: 0;  font-size:10pt}'
		    });
	    });
	}
	function insertPFU() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();
			filePostAjax("/user/cr/cr50/insertPfu", formData ,function(data) {
				// alert(data.resultMessage);	
				if (data.resultCode == 200) {
                    kakaoTodo();
					modalStack.last().callback(formData);
					modalStack.close();
				} else {
					alert(data.resultMessage);
				}
			});
		}
	}


	// 수정
	function updatePFU() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();
			if (formData) {
	      		filePostAjax("/user/cr/cr50/updatePfu", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
	                        kakaoTodo();
							gridView.setData(0);
							modalStack.close();
						}
					});
			}
		}
	}
	
	function makeFormData() {
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);

		//하위레벨 자료 수정된 자료만 arr 담기
// 		var a01updateRow = AREA01GridView.target.getList("modified");
// 		var a02updateRow = AREA02GridView.target.getList("modified");
// 		var a03updateRow = AREA03GridView.target.getList("modified");
// 		var a04updateRow = AREA04GridView.target.getList("modified");

		var a01ListRow = updateOriginData(AREA01GridView);
		var a02ListRow = updateOriginData(AREA02GridView);
		var a03ListRow = updateOriginData(AREA03GridView);
		var a04ListRow = updateOriginData(AREA04GridView);
		

// 		formData.append("a01updateRow", JSON.stringify(a01updateRow));
// 		formData.append("a02updateRow", JSON.stringify(a02updateRow));
// 		formData.append("a03updateRow", JSON.stringify(a03updateRow));
// 		formData.append("a04updateRow", JSON.stringify(a04updateRow));
		formData.append("a01ListRow", JSON.stringify(a01ListRow));
		formData.append("a02ListRow", JSON.stringify(a02ListRow));
		formData.append("a03ListRow", JSON.stringify(a03ListRow));
		formData.append("a04ListRow", JSON.stringify(a04ListRow));

		formData.append("pgmId" 		, $("#pgmId").val());
		formData.append("useYn" 		, "Y");	
		

		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#clntCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtDiv').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 
		
		
		formData.set("ctrtRmk" 		, tinymce.get('ctrtRmk').getContent());
		formData.set("custReq" 		, tinymce.get('custReq').getContent());
		formData.set("spareList" 	, tinymce.get('spareList').getContent());
		formData.set("pfuEtc" 		, tinymce.get('pfuEtc').getContent());
		
		
		

        // 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가
        // 공유 : TODODIV10, TODODIV1040  결재 :TODODIV20, TODODIV2020
        var rowSharngList = gridViewPop7.target.list;
        var ParamObj = modalStack.last().paramObj.ParamObj;

        if(rowSharngList.length > 0) {
            var rowSharngListArr = []; //공유정보
            var rowApprovalListArr = []; //결재정보

            function createListItem(elem, type) {
                return {
                    gb: type,
                    coCd: $('#coCd').val(),
                    todoDiv1CodeId: type === '공유' ? "TODODIV10" : "TODODIV20",
                    todoDiv2CodeId: type === '공유' ? "TODODIV1120" : "TODODIV2120",
                    todoId: elem.usrNm,
                    todoCoCd: elem.coCd,
                    empNo: elem.empNo,
                    name: elem.name,
                    telNo: elem.telNo,
                    email: elem.eMail,
                    pgPath: "/user/cr/cr50/CR5001P01.html",
                    todoTitle: `${$("#popForm #clntNm").val()} ${$("#clntPjtNm").val()} ${type}`

                };
            }

            $.each(rowSharngList, function(idx, elem) {
                var listItem = createListItem(elem, elem.gb);
                if (elem.gb === '공유') {
                    rowSharngListArr.push(listItem);
                } else if (elem.gb === '결재') {
                    rowApprovalListArr.push(listItem);
                }
            });

            formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
            formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
            formData.append("S_todoDiv1CodeId", "TODODIV10");
            formData.append("S_todoDiv2CodeId", "TODODIV1120");
        }
		
		return 	formData;
		
	}
	
	function updateOriginData(areaGridView) {
	    var listRow = areaGridView.target.list;
	    return $.map(listRow, function(obj) {
	        obj.checkData = `${obj.partNm}${obj.partStd}${obj.partCust}${obj.partConf}${obj.partEtc}${obj.stdChk}${obj.indChk}${obj.orgPartId}`;
	        obj.modifyedChk = obj.originData == obj.checkData ? "N" : "Y";
	        return obj;
	    });
	}

	
	//PFU 신규 생성시 salesCd 정보와 표준 PFU 내용을 불러와서 화면에 표시하기
	function selectSalesCdInfo() {						//그리드에 뿌리는 데이터

		var formData = {
			"coCd" 			: $('#coCd').val(),
			"salesCd" 		: $('#salesCd').val(),
// 			"prdtDiv" 		: $('#prdtDiv option:selected').data('rprc'),,  //'PFU01', //백단에서 salesCd를 검색하여 설정한다.
			"prdtTyp" 		: '0',  //Default = 0
			"clntCd" 		: '0',  //Default = 0
// 			"partId" 		: 'PFUAREA010101',  //특정 영역만 가져올경우 처리
		}
		postAjax("/user/cr/cr50/selectSalesCdInfo", formData, null, function(data) {
			//--------- data 구조 -----------------------------
			//  data 
			//    ㄴ--- result :일반필드 data
			//           ㄴ----- resultclob   : CLOB data
			//-----------------------------------------------
			$('#popForm #dudtPlanDt').val('');  //기본 오늘날자이므로 clear
			$('#popForm #ordrsPlanDt').val(''); //기본 오늘날자이므로 clear
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					} else 
					if ($('#popForm #' + key).is('[date]')) {
						$('#popForm #' + key).datepicker('setDate', value);
					}
				}
			});
			debugger;
			setContentInEditor('ctrtRmk',  data.resultImg[0].partImg);
			setContentInEditor('pfuEtc',  data.resultImg[1].partImg);
			
// 			if (data.result.resultclob.length) {
// 				setContentInEditor('ctrtRmk', clobList.ctrtRmk);
// 				setContentInEditor('custReq', clobList.custReq);
// 				setContentInEditor('spareList', clobList.spareList);
// 				setContentInEditor('pfuEtc', clobList.pfuEtc);
// 			}
			
			//결재정보 불러오기
// 	        gridViewPop7.initView().setData(0);
// 	        gridViewPop7.target.setHeight((gridViewPop7.target.list.length+1) * 27 + 123 );//그리드 높이 조정
			
			//제품군에 따라 장비 Type재설정 하고 해당 아이템 설정함.
			setPrdtDiv($('#popForm #prdtDiv'), "main");
// 			$("#popForm #prdtDiv").trigger("change");  //제품군 변경 내용 적용(위의 문장으로 대체 가능함)
			$('#popForm #prdtTyp').val(data.result.prdtTyp);
			
			

		});
	}
	

	function selectPFUInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"coCd" 			: $('#coCd').val(),
			"salesCd" 		: $('#salesCd').val(),
			"fileTrgtKey" 	: $('#fileTrgtKey').val(),
			"prdtDiv" 		: $('#prdtTyp').val(),  //'PFU01',
		}
		postAjax("/user/cr/cr50/selectPfuInfo", formData, null, function(data) {
			//--------- data 구조 -----------------------------
			//  data 
			//    ㄴ--- result :일반필드 data
			//           ㄴ----- resultclob   : CLOB data
			//-----------------------------------------------
			$('#popForm #dudtPlanDt').val('');  //기본 오늘날자이므로 clear
			$('#popForm #ordrsPlanDt').val(''); //기본 오늘날자이므로 clear
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					} else 
					if ($('#popForm #' + key).is('[date]')) {
						$('#popForm #' + key).datepicker('setDate', value);
					}
				}
			});
			
			var clobList = data.result.resultclob[0];
			
			if (data.result.resultclob.length) {
				setContentInEditor('ctrtRmk', clobList.ctrtRmk);
				setContentInEditor('custReq', clobList.custReq);
				setContentInEditor('spareList', clobList.spareList);
				setContentInEditor('pfuEtc', clobList.pfuEtc);
			}
			
			//결재정보 불러오기
	        gridViewPop7.initView().setData(0);
	        gridViewPop7.target.setHeight((gridViewPop7.target.list.length+1) * 27 + 123 );//그리드 높이 조정
			
			//제품군에 따라 장비 Type재설정 하고 해당 아이템 설정함.
			setPrdtDiv($('#popForm #prdtDiv'), "main");
// 			$("#popForm #prdtDiv").trigger("change");  //제품군 변경 내용 적용(위의 문장으로 대체 가능함)
			$('#popForm #prdtTyp').val(data.result.prdtTyp);

		});
	}
	
	function setContentInEditor(editorId, content) {
        var editor = tinymce.get(editorId);
        if (editor) {
            editor.setContent(content);
            editor.save(); // 에디터 내용을 저장하여 화면에 즉시 반영
        } else {
            console.error('Editor not found: ' + editorId);
        }
    }
	

	
	function setPrdtDiv(elem, target) {
	    prdtDivTarget = target;
	    const elemValue = $(elem).val();
// 	    const elemRprcValue = $(elem).data('rprc');
	    const elemRprcValue =$('#prdtDiv option:selected').data('rprc');

	    // 기본 옵션 HTML
	    let optionHtml = '<option value="">전체</option>';
	    if (elemValue) {
	        const paramObj = { "codeKind": elemRprcValue };
	        
	        postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data) {
	            const childCodeList = data.childCodeList;

	            // childCodeList가 존재할 때만 옵션 추가
	            optionHtml += childCodeList.map(obj => 
	                `<option value="${obj.codeId}">${obj.codeNm}</option>`
	            ).join('');

	            // 선택된 타겟에 따라 HTML 업데이트
	            const targetSelector = prdtDivTarget === "main" ? '#prdtTyp' : '[data-search="prdtTyp"]';
	            $(targetSelector).html(optionHtml);
	        });
	    } else {
	        // 기본 옵션만 설정
	        $('[data-search="prdtTyp"]').html(optionHtml);
	    }
	}
	

    
    // 공유대상자 추가//  
    function insertShareUserModal1() {
		
    	if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}


        const paramObj = {
            coCd: $('#coCd').val(),
            useYn: "Y",
            userId: $('#ordrgId').val(),
            userNm: $('#ordrgNm').val(),
            approvalGrid: [],
            shareGrid: []
        };

        const  appshaList = gridViewPop7.target.list;

        // 결재와 공유 정보를 필터링 및 매핑
        function mapItemsByType(type) {
            return $.grep(appshaList, function(item) {
                return item.gb === type;
            }).map(function(item) {
                return {
                    gb: type,
                    id: item.usrNm,
                    text: item.name,
                    parent: item.jik,
                    deptNm: item.dtNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                    todoId: item.id,
                    todoKey: item.todoKey,
                    sanctnSn: item.sanctnSn,
                    sanctnSttus: item.sanctnSttus,
                    todoCfDt: item.todoCfDt,
                    todoCfOpn: item.todoCfOpn,
                    flag: item.flag
                };
            });
        }

        paramObj.approvalGrid = mapItemsByType("결재");
        paramObj.shareGrid = mapItemsByType("공유");
        
        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
    		// console.log('결재라인 : ', approvalGrid.target.list);
    		// console.log('공유라인 : ', shareGrid.target.list);
    		
			// 결재와 공유 리스트 변환
	        function convertList(list, type) {
	            return list.map(function(item) {
	                return {
	                    gb: type,
	                    usrNm: item.id,
	                    name: item.text,
	                    jik: item.parent,
	                    dtNm: item.deptNm,
	                    telNo: item.telNo,
	                    offTelNo: item.offTelNo,
	                    email: item.email,
	                    todoId: item.id,
	                    todoKey: item.todoKey,
	                    sanctnSn: item.sanctnSn,
	                    sanctnSttus: item.sanctnSttus,
	                    todoCfDt: item.todoCfDt,
	                    todoCfOpn: item.todoCfOpn,
	                    flag: item.flag
	                };
	            });
	        }
	
	        var appArray = convertList(approvalGrid.target.list, "결재");
	        var shaArray = convertList(shareGrid.target.list, "공유");
        	
  			gridViewPop7.setData2(appArray.concat(shaArray));
  			
        });
		
    } 
 	
    //결재 여부
    function approvalYn() {
       var gridList = gridViewPop7.target.getList();
       var inCnt = 0;
       if( gridList.length > 0 ) {
            var msgArr = [];         
            $.each(gridList, function (idx, elem) {   
               //결재자가 본인이 아니면서 상태가 Y인 경우
               if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
            })
       }
       return inCnt;
    }
    
    function deleteShareUser1(){
        
        if( approvalYn() ) {
          alert("결재가 이미 진행중입니다.");
          return;
       }
        
        var selRow = parseInt(gridViewPop7.target.selectedDataIndexs);    
        if( isNaN(selRow) ) {
           alert("선택된 행이 없습니다.");
           return;
        } else {         
              if( selRow > -1 ) {
                 var todoKey = gridViewPop7.target.getList()[selRow].todoKey;
                 var gridList = gridViewPop7.target.getList("selected")[0];
             if( typeof(todoKey) == "undefined" ) {
                gridViewPop7.target.removeRow(selRow);
                $.gridNoSet(gridViewPop7, "sanctnSn");
             } else {
                var paramObj = {
                      todoNo: $("#popForm #fileTrgtKey").val(),
                      todoKey: gridList.todoKey,
                      sanctnSn: gridList.sanctnSn,
                      todoDiv1CodeId: gridList.todoDiv1CodeId,
                      todoDiv2CodeId: gridList.todoDiv2CodeId
                	}
                 deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
                    if (data.resultCode == 200) {
                       alert(data.resultMessage);
                       gridViewPop7.setData(0);
                    } else {
                       alert("삭제중 오류가 발생했습니다");                                
                    }
                 });                   
             }
           }
        }
     }


	//수주번호 검색
    function popOpendOrdrsSearch(inputValue, coCd) {
        var paramObj = {
            "searchValue" : inputValue,
            "coCd" : coCd
        };
    	
        openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];

            $('#ordrsCoCd').val(row.coCd);
            $('#ordrsNo').val(row.ordrsNo);
            $('#clntCd').val(row.ordrsClntCd);
            $("#popForm #clntNm").val(row.clntNm);
            $('#clntPjt').val(row.clntPjtCd);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#ctrtNm').val(row.ctrtNm);
            $('#mngId').val(row.mngId);
            $('#mngIdNm').val(row.mngNm);
            $('#ctrtDt').datepicker('setDate', row.ordrsDt);
        });
    }

	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch(inputValue, coCd) {
		let tempSalesCd = $('#salesCd').val();  //sample 자료 --> 24046-01URFUP
        var paramObj = {
           "coCd" : $('#ordrsCoCd').val() != "" ?  $('#ordrsCoCd').val() : $('#coCd').val(),
           "searchValue": tempSalesCd != "" ? tempSalesCd : $('#ordrsNo').val()
        };
        openSecondModal("/static/html/cmn/modal/SalesCodeTreeSearch.html", 1000, 500, "SALES CODE 검색", paramObj, function (grid){
        	//dataGbn이 "D"==SALES CODE자료만 검색
            var rows = grid.target.getList("selected").filter(item => item.dataGbn === 'D');
        	if (rows.length != 0) {
	            var row = rows[0];
	            $('#ordrsCoCd').val(row.coCd);
	            $('#ordrsNo').val(row.ordrsNo);
	            $('#clntCd').val(row.ordrsClntCd);
	            $("#popForm #clntNm").val(row.ordrsClntNm);
	            $('#clntPjt').val(row.clntPjt);
	            $('#clntPjtNm').val(row.clntPjtNm);
	//             $('#ctrtNm').val(row.ctrtNm);	//계약명
	            $('#ctrtNm').val(row.eqpNm); //설비명
	            $('#mngId').val(row.mngId);
	            $('#mngIdNm').val(row.mngNm);
	            $('#ctrtDt').datepicker('setDate', row.ordrsDt);
// 	            $('#salesCd').val(rows.map(item => item.salesCd).join(","));  //SalesCd 합치기
	            $('#salesCd').val(row.salesCd);
	            $('#prdtDiv').val(row.prdtGrp);
	            $('#prdtCd').val(row.prdtCd);
	// 			$('#prdtNm').val(row.prdtCdNm);
	//             $('#itemDiv').val(row.itemDiv);
	//             $('#itemDivNm').val(row.itemDivNm);
        	}
        });
    }
    		


                
    /*
    #   TODO 알림톡발송 시작
    #
    */
    // $("#approvalReqTodoBtn").on("click", function () {
    //    kakaoTodo();
    // });

        
    function kakaoTodo() {
        
        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	            "userId" : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });   
        }
    	
        let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
        // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
        var paramObj1 = {
            "coCd" : $("#coCd").val(),
            "userId" : $("#mngId").val()
        };
        postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data) {
        	teleNo = (data.result[0] && data.result[0].telNo) ? data.result[0].telNo : "051-312-2400";
        });

//         var chgNm = $("#popForm #clntNm").val() + "(" + $("#popForm #clntPjtNm").val() + " - " + $("#popForm #salesCd").val() + ") PFU" + $("#popForm #verNo").val() + "차 ";   
        const chgNm = `${$("#popForm #clntNm").val()}(${$("#popForm #clntPjtNm").val()}:${$("#popForm #salesCd").val()}) PFU ${$("#popForm #verNo").val()}차`;

        
        //---------------------------------------
        
	    // 파라미터 생성 함수
	    function createTodoParam(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, sanctnDiv2) {
	        return {
	            "tmplatDiv": "TMPLATDIV02",
	            "coCd": $("#popForm #coCd").val(),
	            "todoDiv1CodeId": todoDiv1CodeId,
	            "todoDiv2CodeId": todoDiv2CodeId,
	            "todoDiv1CodeNm": todoDiv1CodeNm,
	            "title": chgNm,
	            "sanctnDiv2": sanctnDiv2,
	            "todoNo": $("#popForm #salesCd").val(),
	            "histNo": $("#popForm #verNo").val(),
	            "clntCd": "1", // 발신회사는 로그인사용자 회사
	            "clntNm": clntNm, // 로그의 수신거래처명
	            "ordrgMngNm": $("#popForm #mngIdNm").val(), // 수주작성자(담당자)
	            "ordrgMngTelNo": teleNo, // 담당자 전화번호
	            "creatPgm": "CR5001P01"
	        };
	    }

	    // 알림톡 전송 함수
	    function sendKakaoTodo(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, sanctnDiv2) {
	        const param = createTodoParam(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, sanctnDiv2);
	        commKaKaoSendTodo(param);
	    }
        
        
        // PFU 결재 및 공유 알림톡 전송
        sendKakaoTodo("TODODIV20", "TODODIV2120", "결재", "결재");
        sendKakaoTodo("TODODIV10", "TODODIV1120", "공유", "공유");
     
       
        if (kakaoCnt > 0) {
            kakaoCnt = 0;
            // alert("알림톡이 정상 발송되었습니다.");
        }
    }
    
    //to-do결재요청 알림톡
    function commKaKaoSendTodo(param) {
        // console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);
        //알림톡수신번호 채번
        var maxMessageId = null;         //message id(unique key)
        var talkMessage = null             //발송될 내용 template
        var mobile = null               //수신인 휴대전화번호
        var title = null               //todo title
        var todoDiv2CodeNm = null               //todo title
        var sendList = [];
        let talkParam = {};
        let talkBody = {};
        let sendCnt = 0;
        postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null, function(data) {
            if(data.resultList.length > 0 ) {
                if( data.resultList[0].maxMessageId != "" ) {
                    sendList = data.resultList;
                } else {
                    alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                    return;
                }
            }
        });
        //user search ajax end
        
        //대상 loop
        $.each(sendList, function (key, sendObj) {
            maxMessageId = sendObj.maxMessageId;
            talkMessage = sendObj.messageDesc;
            mobile =  sendObj.telNo;
            //로그용
            param.rcvId = sendObj.todoId;         //todo 수신id
            param.rcvNm = sendObj.name;            //todo 수신자명
            param.nameTo = sendObj.name;            //todo 수신자명
            //title      = sendObj.todoTitl;
            todoDiv2CodeNm =   sendObj.todoTitl;
            param.todoDiv2CodeNm = todoDiv2CodeNm;
            //param.title = title;                        //요청내용제목
            param.sendDt = sendObj.sendDt;
            
            if(mobile == "" || mobile == null) {
                alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
                return;
            }
            
            if(talkMessage == "" || talkMessage == null) {
                alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
                return;
            }
            //message 치환
            let message = talkMessage;
            let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
            //loop
            $.each(splitStr, function (key, val) {
                let compKey = val.substring(1, val.length-1);
                if( compKey != "" && compKey != "undefined" ) {
                    if( typeof(param[compKey]) != "undefined" ) {
                        let val2 = '#'+val;
                        message = message.replaceAll(val2, param[compKey]);
                    }
                }
            });
            
            talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
            talkParam.serverName = "gyitt2400";
            talkParam.paymentType = "P";
            talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
            talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);
            talkBody.title = param.title;               //알림톡 타이틀 -
            talkBody.message = message;            //알림톡 메시지 (1000 byte)
            talkBody.mobile = mobile;            //휴대전화번호
            talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
            let talkJson = JSON.stringify(talkBody);
            sendCnt = kakaoSendReal(talkJson, talkParam, param);
        });
        //대상 loop end
        
        if( sendCnt > 0 ) {
            //alert("알림톡 정상 발송되었습니다.");
            kakaoCnt++;
        }
    }  //user search ajax end
    
    //입력그리드 No. 재정립
    $.gridNoSet = function(gridObj, key) {
        // console.log('---gridNoset run ---');
        var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			gridList.forEach((elem, idx) => {
	            gridObj.target.setValue(idx, key, idx + 1);
	        });
			gridObj.target.repaint();
		}		
	}
    
</script>

</body>
</html>