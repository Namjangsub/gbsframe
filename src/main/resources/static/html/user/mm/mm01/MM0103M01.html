<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
	<link rel="stylesheet" href="/static/css/tui-grid/4.21.22/tui-grid.css" />
	<link rel="stylesheet" href="/static/css/gnb.css" />
	<link rel="stylesheet" href="/static/css/main.css" />
	<link rel="stylesheet" href="/static/css/sub.css" />
	<link rel="stylesheet" href="/static/css/common.css" />
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/tui-grid/4.21.22/tui-grid.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	
	<!-- 마인드맵 -->
    <link type="text/css" rel="stylesheet" href="./jsmind.css" />
    <script src="./jsmind.js"></script>
    <script src="./jsmind.draggable-node.js"></script>
    <style type="text/css">
        #jsmind_container { width: 1900px; height: 890px; border: solid 1px #ccc; background: #f4f4f4; }
        
        /* Tooltip Style */
        #node-tooltip {
            position: absolute;
            display: none;
            background-color: rgba(50, 50, 50, 0.9);
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            pointer-events: none; /* Prevent flickering */
            max-width: 300px;
            line-height: 1.4;
        }
        #node-tooltip table {
            width: 100%;
            border-collapse: collapse;
        }
        #node-tooltip th {
            text-align: left;
            padding-right: 10px;
            color: #aaa;
            font-weight: normal;
        }
        #node-tooltip td {
            text-align: left;
            word-break: break-all;
        }
        #node-tooltip .tooltip-header {
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #777;
            font-size: 13px;
        }
    </style>
    
</head>

<body>
<div id="head_area"></div>
<div id="top_area"></div>
<div id="main_area">
    <input type="hidden" id="pgmId"  name="pgmId" value="MM0103M01">
    <input type="hidden" id="coCd"  name="coCd">

	<!-- 검색 콘텐츠 -->
	<div class="contents search">
		<!--  테이블 인풋 4분할  -->
		<table class="table_input type05">
	        <!-- Search Bar -->
			<tr>
				<th>회사</th>
				<td>
						<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required>
							<option value="">전체</option>
						</select>
				</td>
				<th>SalesCode</th>
				<td>
					<div class="search_form" style="display: flex; align-items: center;">
						<input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd">
						<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
					</div>
                </td>
				<th></th>
				<td></td>
				<th></th>
				<td></td>
				<th></th>
				<td>
                    <div class="add_btn_small">
                        <a onclick="saveMindMapImage()" style="height: 30px; line-height: 28px; width: 110px; margin-right: 5px;"><i class="fa fa-file-image"></i> Save Image</a>
                        <a onclick="printMindMap()" style="height: 30px; line-height: 28px; width: 110px;"><i class="fa fa-print"></i> Print</a>
                    </div>  </td>
			</tr>
		</table>
    </div>
    <div id="jsmind_container" style="height: calc(100% - 40px);"></div>
    <!-- Tooltip Container -->
    <div id="node-tooltip"></div>
 </div>
    <script type="text/javascript">
    const blueGradient = ['#0d47a1', '#1565c0', '#1976d2', '#1e88e5', '#2196f3', '#42a5f5', '#64b5f6', '#90caf9', '#bbdefb', '#e3f2fd'];
    const greenHarmony = ['#10451d', '#155d27', '#1a7431', '#208b3a', '#25a244', '#2dc653', '#4ad66d', '#6ede8a', '#92e6a7', '#b7efc5'];
    const sunsetBliss = ['#0d47a1', '#0d47a1', '#006494', '#006d77', '#166088', '#218380', '#73d2de', '#ffbc42', '#d81159', '#8f2d56', '#218380', '#73d2de'];
    
    var jm = null;
    function load_jsmind() {
        var param = {
            salesCd: $('#salesCd_S').val(),
            ordrsNo: $('#salesCd_S').val().slice(0, 5).trim(),
        };

        var mindMapData = [];
        var agendaData = [];

        // 1. Existing MindMap, Agenda List
        postAjax('/user/mm/mm01/selectMindMapList', param, null, function(data) {
            // 1. Existing MindMap List
            if (data.mindMapData) {
                mindMapData = data.mindMapData;
            }
            // 2. New Agenda List
            if (data.agendaData) {
                agendaData = data.agendaData;
            }
            
            var combinedData = mindMapData.concat(agendaData);
            if (combinedData.length > 0) {
                renderMind(combinedData);
            } else {
                alert("데이터 조회 실패 또는 데이터가 없습니다.");
            }
        });


    }
    

 	$(document).ready(function() {
 		//초기설정들
 		mainDefaultLoad("공통정보", "마인드맵현황");
 		setCommonSelect($("#main_area select[data-kind]"));

 		// 화면 크기 조절
//  		$("#top_area").hide();
 		$('#head_area').toggleClass('off');
 		$('#main_area').toggleClass('on');
 		
 		

 		// Load Parameters (Prioritize LocalStorage, Fallback to URL)
        var storedParams = localStorage.getItem("MM0103M01_PARAMS");
        var hasStoredParams = false;
        
        if (storedParams) {
            try {
                var params = JSON.parse(storedParams);
                if (params.salesCd) {
                    $('#salesCd_S').val(params.salesCd);
                    hasStoredParams = true;
                }
                if (params.coCd) $('#coCd_S').val(params.coCd);
                if (params.pgmId) $('#pgmId').val(params.pgmId);
            } catch(e) {
                console.error("Param Parse Error", e);
            }
        }
        
        if (!hasStoredParams) {
            // Fallback to URL Params
    		const urlParams = new URLSearchParams(window.location.search);
    		const salesCd = urlParams.get('salesCd') || "";
    		const coCd = urlParams.get('coCd') || "";
    		if (salesCd) $('#salesCd_S').val(salesCd);
    		if (coCd) $('#coCd_S').val(coCd);
        }

         load_jsmind();
         
         // Auto search on Enter or Blur
         $('#salesCd_S').on('keypress', function(e) {
             if (e.which == 13) {
                 load_jsmind();
                 $(this).blur(); // Remove focus
             }
         }).on('change', function() {
             // Triggered on blur if value changed
             load_jsmind();
         });
         

         // 뒤로가기 시 목록 화면으로 이동
         history.pushState(top.location.href, null, top.location.href);
         window.addEventListener('popstate', function(event) {
             location.href = "/static/index.html";
         });

         // [Tooltip Implementation]
         // Event delegation for dynamically created jmnode elements
         $(document).on('mouseenter', 'jmnode', function(e) {
             var nodeid = $(this).attr('nodeid');
             if (!jm) return;
             
             var node = jm.get_node(nodeid);
             if (node && node.data) {
                 showTooltip(e, node);
             }
         }).on('mouseleave', 'jmnode', function() {
             $('#node-tooltip').hide();
         }).on('mousemove', 'jmnode', function(e) {
             moveTooltip(e);
         }).on('dblclick', 'jmnode', function(e) {
             var nodeid = $(this).attr('nodeid');
             if (!jm) return;
             var node = jm.get_node(nodeid);
             
             // Handle potential nested data (resolve node.data or node.data.data)
             var data = node.data;
             if (data && data.data) data = data.data;
             
             // Ensure dataType matches robustly
             var dataType = (data && data.dataType) ? String(data.dataType) : "";
             
             if (dataType == '6') {
                 // [Type 6] Agenda (안건)
                 const targetUrl = "/static/html/user/pm/pm20/PM2001M01.html";
                 const tabIdentifier = "PM2001M01_TAB";
                 
                 localStorage.setItem("PM2001M01_PARAMS", JSON.stringify({
                     salesCd: data.salesCd || "",
                     ordrsNo: data.ordrsNo || "",
                     coCd: $('#coCd_S').val() || "GUN"
                 }));
                 
                 const popup = window.open(targetUrl, tabIdentifier);
                 if (popup) popup.focus();
                 
             } else if (dataType == '3') {
                if (data && data.salesCd) {
                    var paramObj = {
                        "coCd": data.coCd,
                        "salesCd": data.salesCd,
                        "planVerNo": "",
                        "histYn": 'N',
                    };
                    openModal("/static/html/user/wb/wb22/WB2201P01.html", 1400, 900, "WBS 계획등록", paramObj, function () {
                        load_jsmind();
                    });
                }
             } else if (dataType == '4') {
                 // [Type 4] Issue Correction (실적문제수정)
                 var paramObj = {
                    "actionType"     : "U4",
                    "coCd"           : data.coCd,
                    "salesCd"        : data.salesCd,
                    "issFileTrgtKey" : data.fileTrgtKey
                 };
                 openModal("/static/html/user/wb/wb24/WB2401P11.html", 1200, 870, "WBS 실적문제수정", paramObj, function (){
                     load_jsmind(); // Refresh on close
                 });
                 
             } else if (dataType == '5') {
                if (data.id) {
                    // 발주요청번호가 존재하면 발주요청서 수정 업무 시작
                    var paramObj = {
                        "actionType" : "U",
                        "reqNo"    : data.id,
                        "coCd" 	   : data.coCd,
                        "userId"   : jwt.userId,
                        "deptId"   : jwt.deptId,
                        "issNo"    : data.parentid,
                        "pgmId"    : "QM0101M01"
                    };
                    openModal("/static/html/user/qm/qm01/QM0101P01.html", 1600, 870, "", paramObj, function(data) {
                        if (data == 'ok') load_jsmind();
                    });
                } 
             }
         });
 	});
    
    function showTooltip(e, node) {
        if (!node.data) return;
        var data = node.data.data;
        // console.log("Tooltip Data:", data); // Debugging

        var html = '<div class="tooltip-header">' + (node.topic || 'Node Info') + '</div>';
        html += '<table>';
        
        var fields = [
            { key: 'id', label: 'ID' },
            { key: 'ordrsNo', label: '수주번호' }, // Check ordrsNo, ORDRSNO, ORDRS_NO
            { key: 'salesCd', label: 'Sales Code' }, // Check salesCd, SALESCD, SALES_CD
            { key: 'ordrsClntNm', label: '고객사' }, // Check ordrsClntNm, ORDRSCLNTNM, ORDRS_CLNT_NM
            { key: 'clntPjtNm', label: 'Project' }, // Check clntPjtNm, CLNTPJTNM, CLNT_PJT_NM
            { key: 'mctypeNm', label: '설비유형' }, // Check mctypeNm, MCTYPENM, MCTYPE_NM
            { key: 'issueNo', label: '문제번호' }, // Check issueNo, ISSUENO, ISSUE_NO
            { key: 'reqNo', label: '발주요청번호' }, // Check reqNo, REQNO, REQ_NO
            { key: 'issSts', label: '문제상태' }, // Check issStsNm, ISSSTSNM, ISS_STS_NM
            { key: 'reqStNm', label: '발주요청서상태' }, // Check reqStsNm, REQSTSNM, REQ_STS_NM    
            { key: 'dataType', label: 'Data Type' },
            { key: 'agendaStatusNm', label: '회의자료-안건상태' },
            { key: 'agendaCnts', label: '회의자료-안건내용' },
            { key: 'issCnts', label: '문제내용' },
            { key: 'reqRmk', label: '발주요청서비고' }
        ];

        var dataTypeMap = {
            "1": "root",
            "2": "수주 자료",
            "3": "기계설비",
            "4": "문제발생자료",
            "5": "요인별발주요청서 자료",
            "6": "회의자료-안건"
        };

        // Pre-fetch reqStNm for the override logic using the helper
        var reqStNmVal = getValueIgnoreCase(data, 'reqStNm');
        
        var issStsMap = {
            "ISSSTS01": "접수중",
            "ISSSTS02": "진행중",
            "ISSSTS03": "완료"
        };

        fields.forEach(function(f) {
            var val = getValueIgnoreCase(data, f.key);
            
            // Override logic: if issSts is being processed and reqStNm exists, use reqStNm
            if (f.key === 'issSts') {
                 if (reqStNmVal) {
                     val = reqStNmVal;
                 } else if (val && issStsMap[val]) {
                     val = issStsMap[val];
                 }
            }

            // Apply dataType mapping
            if (f.key === 'dataType' && val && dataTypeMap[val]) {
                val = dataTypeMap[val];
            }
            
            if (val !== undefined && val !== null && val !== '') {
                html += '<tr><th>' + f.label + '</th><td>' + val + '</td></tr>';
            }
        });
        
        html += '</table>';
        
        $('#node-tooltip').html(html).show();
        moveTooltip(e);
    }
    
    // Helper to find value with various key formats
    function getValueIgnoreCase(data, key) {
        if (data[key]) return data[key];
        
        var upperKey = key.toUpperCase();
        if (data[upperKey]) return data[upperKey];
        
        // Try Snake Case conversion (e.g. ordrsNo -> ORDRS_NO)
        var snakeKey = key.replace(/([A-Z])/g, "_$1").toUpperCase();
        if (data[snakeKey]) return data[snakeKey];
        
        return "";
    }

    function moveTooltip(e) {
        var tooltip = $('#node-tooltip');
        var offset = 15; // Distance from mouse cursor
        
        // Calculate position
        var top = e.pageY + offset;
        var left = e.pageX + offset;
        
        // Boundary checks (optional, but good for UX)
        if (left + tooltip.outerWidth() > $(window).width()) {
            left = e.pageX - tooltip.outerWidth() - offset;
        }
        if (top + tooltip.outerHeight() > $(window).height()) {
            top = e.pageY - tooltip.outerHeight() - offset;
        }

        tooltip.css({
            top: top,
            left: left
        });
    }

     function renderMind(dbList) {
         // console.log("renderMind data:", dbList);
         if (!dbList || dbList.length === 0) {
             alert("조회된 데이터가 없습니다.");
             return;
         }

         // Transform DB list to jsMind node_array
         var nodeArray = [];
         
         dbList.forEach(function(item) {
             var id = item.id || item.ID;
             var topic = item.topic || item.TOPIC || id;
             var parentid = item.parentid || item.PARENTID;
             // DB field can be camel/snake/upper depending on mapper
             var dataType = (item.dataType != null ? item.dataType : '');

             // Data Fields
             var actNm = item.actNm || item.ACT_NM || '';
             var reqSt = item.reqSt || item.REQ_ST || '';
             var issSts = item.issSts || item.ISS_STS || '';
             var direction = item.direction || item.DIRECTION || '';
             var agendaStatus = item.agendaStatus || item.AGENDA_STATUS || '';
             
             // Topic Formatting
             var displayTopic = topic;
             
             if (dataType == '5') {
                 // Type 5: actNm / topic (+ warning if not REQST03)
                 displayTopic = actNm + ' / ' + topic;
                 if (reqSt !== 'REQST03') {
                     displayTopic += ' <i class="fa fa-exclamation-circle" style="color:red; font-size:14px; margin-left:4px;" title="미완료"></i>';
                 }
             } else if (dataType == '4') {
                 // Type 4: actNm / topic (+ warning if not ISSSTS03)
                 displayTopic = actNm + ' / ' + topic;
                 if (issSts !== 'ISSSTS03') {
                     displayTopic += ' <i class="fa fa-exclamation-circle" style="color:red; font-size:14px; margin-left:4px;" title="미완료"></i>';
                 }
             } else if (dataType == '6') {
                 // Type 6: Agenda (+ warning if not Y)
                 displayTopic = id + ' / ' + topic;
                 if (agendaStatus !== 'Y') {
                      displayTopic += ' <i class="fa fa-exclamation-circle" style="color:red; font-size:14px; margin-left:4px;" title="진행중"></i>';
                 }
             } else if (parseInt(dataType) >= 2) {
                 // Type 2,3: id / topic
                 displayTopic = id + ' / ' + topic;
             }

             var node = {
                 id: id,
                 topic: displayTopic,
                 direction: direction
             };
             
             if (parentid && parentid !== 'ROOT' && parentid !== '') {
                 node.parentid = parentid;
             } else {
                 node.isroot = true;
             }
             
             // Color Logic
             if ((dataType == '4' && issSts === 'ISSSTS03') || 
                 (dataType == '5' && reqSt === 'REQST03') ||
                 (dataType == '6' && agendaStatus === 'Y')) {
                  // Completed Issue/Request/Agenda -> Neutral/No Color
                  node['background-color'] = '#f0f0f0'; 
                  node['foreground-color'] = '#777'; // Dimmed text
             } else {
                  node['background-color'] = sunsetBliss[gPasIntChk(dataType)];
                  node['foreground-color'] = (dataType == '5') ? '#fff' : '#fff';
             }
             
             // Extra metadata for details
             node.data = Object.assign({}, item);
              
             nodeArray.push(node);
         });

         var mind = {
             meta: { name: 'ProjectMap', author: 'GBS', version: '1.0', },
             format: 'node_array',
             data: nodeArray
         };

         var options = {
             container: 'jsmind_container',
             editable: false, 
             theme: 'greensea',
             support_html: true, // Enable HTML for icons
             view:{ line_width: 2, line_color: '#ccc', },
             layout: { hspace: 50, vspace: 10, pspace: 13, }
         };
         
         // Clear previous map
         $('#jsmind_container').empty();

         jm = new jsMind(options);
         jm.show(mind);

     }


      /**
       * [Common] Capture the entire mind map including off-screen nodes.
       * Uses CSS Transform to shift all content into the visible area before capturing.
       */
      function captureMindMap() {
          return new Promise((resolve, reject) => {
              const container = document.querySelector('#jsmind_container');
              if (!container) return reject('Container not found');

              // jsMind scroll container is `.jsmind-inner` (not `#jsmind_container`).
              // If we use the wrong scroll offsets, the capture bounds become too small and
              // the lower nodes get clipped in image/print.
              const panel = container.querySelector('.jsmind-inner') || container;
              const captureEl = panel;

              const originalStyles = {
                  containerWidth: container.style.width,
                  containerHeight: container.style.height,
                  containerOverflow: container.style.overflow,
                  panelWidth: panel.style.width,
                  panelHeight: panel.style.height,
                  panelOverflow: panel.style.overflow,
                  transforms: []
              };

              const shiftChildren = Array.from(panel.children);
              shiftChildren.forEach(child => {
                  originalStyles.transforms.push(child.style.transform);
              });

              // Make overflow visible so html2canvas can draw outside the viewport.
              container.style.overflow = 'visible';
              panel.style.overflow = 'visible';

              // Calculate bounding box of ALL nodes relative to the scrollable panel.
              let minX = Infinity, minY = Infinity;
              let maxX = -Infinity, maxY = -Infinity;

              const panelRect = panel.getBoundingClientRect();
              const nodes = panel.querySelectorAll('jmnode');

              if (nodes.length === 0) {
                  minX = 0; minY = 0;
                  maxX = panel.clientWidth; maxY = panel.clientHeight;
              } else {
                  nodes.forEach(node => {
                      const rect = node.getBoundingClientRect();
                      const relLeft = rect.left - panelRect.left + panel.scrollLeft;
                      const relTop = rect.top - panelRect.top + panel.scrollTop;
                      minX = Math.min(minX, relLeft);
                      minY = Math.min(minY, relTop);
                      maxX = Math.max(maxX, relLeft + rect.width);
                      maxY = Math.max(maxY, relTop + rect.height);
                  });
              }

              const padding = 50;
              const shiftX = padding - minX;
              const shiftY = padding - minY;
              const captureWidth = Math.ceil((maxX - minX) + (padding * 2));
              const captureHeight = Math.ceil((maxY - minY) + (padding * 2));

              // Resize to fit everything (both container + panel to avoid 100% sizing surprises).
              container.style.width = captureWidth + 'px';
              container.style.height = captureHeight + 'px';
              panel.style.width = captureWidth + 'px';
              panel.style.height = captureHeight + 'px';

              // Reset scroll so our translation is predictable.
              panel.scrollLeft = 0;
              panel.scrollTop = 0;

              // Shift canvas + nodes together (they are siblings under the panel).
              shiftChildren.forEach(child => {
                  child.style.transform = `translate(${shiftX}px, ${shiftY}px)`;
              });

              // Prevent large captures from silently clipping due to browser canvas limits.
        // [User Request] High resolution scale (Text Ratio)
        const desiredScale = 3; 
        const maxDim = 16384;
        const safeScale = Math.max(0.1, Math.min(desiredScale, maxDim / captureWidth, maxDim / captureHeight));

        html2canvas(captureEl, {
            scale: safeScale,
            width: captureWidth,
            height: captureHeight,
            windowWidth: captureWidth,
            windowHeight: captureHeight,
            x: 0,
            y: 0,
            scrollX: 0,
            scrollY: 0,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#f4f4f4',
            logging: false,
            onclone: function(clonedDoc) {
                // [User Request] Thinner borders and robust text sizing
                const nodes = clonedDoc.querySelectorAll('jmnode');
                nodes.forEach(node => {
                    node.style.borderWidth = '1px';
                    // Optional: Ensure font smoothing or slight adjust if needed
                    // node.style.fontWeight = 'bold'; 
                });
            }
        }).then(canvas => {
                  // Cleanup / Restore
                  container.style.width = originalStyles.containerWidth;
                  container.style.height = originalStyles.containerHeight;
                  container.style.overflow = originalStyles.containerOverflow;
                  panel.style.width = originalStyles.panelWidth;
                  panel.style.height = originalStyles.panelHeight;
                  panel.style.overflow = originalStyles.panelOverflow;
                  shiftChildren.forEach((child, i) => {
                      child.style.transform = originalStyles.transforms[i];
                  });
                  resolve(canvas);
              }).catch(err => {
                  // Cleanup on error
                  container.style.width = originalStyles.containerWidth;
                  container.style.height = originalStyles.containerHeight;
                  container.style.overflow = originalStyles.containerOverflow;
                  panel.style.width = originalStyles.panelWidth;
                  panel.style.height = originalStyles.panelHeight;
                  panel.style.overflow = originalStyles.panelOverflow;
                  shiftChildren.forEach((child, i) => {
                      child.style.transform = originalStyles.transforms[i];
                  });
                  reject(err);
              });
          });
      }

     /**
      * [Export] Save Mind Map as PNG image
      */
     function saveMindMapImage() {
         captureMindMap().then(canvas => {
             const salesCd = $('#salesCd_S').val() || "MindMap";
             const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
             const filename = `MindMap_${salesCd}_${dateStr}.png`;
             
             const link = document.createElement('a');
             link.download = filename;
             link.href = canvas.toDataURL("image/png");
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }).catch(err => {
             console.error("Image export failed:", err);
             alert("이미지 저장 중 오류가 발생했습니다.");
         });
     }

     /**
      * [Print] Print Mind Map (Fit to Page)
      */
     function printMindMap() {
         captureMindMap().then(canvas => {
             var imgData = canvas.toDataURL("image/png");
             var w = window.open("");
             w.document.write("<html><head><title>Mind Map Print</title>");
             // Set page margin to 0 or small value, and center content
             w.document.write("<style>@page { size: landscape; margin: 5mm; } body { margin: 0; text-align: center; display: flex; align-items: center; justify-content: center; height: 100vh; background: #fff; }</style>");
             w.document.write("</head><body>");
             // Fit image: max-width/height 100% preserves aspect ratio and fits in the page
             w.document.write("<img src='" + imgData + "' style='max-width:100%; max-height:100%; object-fit: contain; border: 1px solid #ddd;'>");
             w.document.write("</body></html>");
             w.document.close();
             
             setTimeout(function () {
                 w.print();
                 w.close();
             }, 500);
         }).catch(err => {
             console.error("Print capture failed:", err);
             alert("출력 중 오류가 발생했습니다.");
         });
     }

   	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
   	function wbsSalesCodeSearch() {

   		var paramObj = {
   		   "coCd" : $('#coCd_S').val(),
   		   "salesCd": $('#salesCd_S').val()
   		};
   		openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 700, "SALES CODE 검색", paramObj, function (grid){
   			var row = grid.target.getList("selected")[0];
   			$('#salesCd_S').val(row.salesCd); 
   			//$('#wbsClntPjt').val(row.clntPjt); // 고객사 PJT
   			//$('#prdtCd_S').val(row.prdtCd); // 제품구분
   			//$('#prdtNm_S').val(row.prdtCdNm); // 제품구분
   			//$('#itemDiv_S').val(row.itemDiv); // 아이템 구분
   			//$('#eqp_nm').val(row.eqpNm); // 설비명
   			//$('#clntCd').val(row.ordrsClntCd); // 고객사코드
   			//$('#clntNm').val(row.ordrsClntNm); // 고객사명
   			load_jsmind();
   		});
   	}

    // [Type 4/5 Logic Helpers]

    // Issue View/Edit Modal (Also used for Type 4 indirectly or Type 5 check)
    function wbsIssModal(row) {
        var paramObj = {
            "actionType"     : "U4",
            "coCd"           : row.coCd,
            "salesCd"        : row.salesCd,
            "issFileTrgtKey" : row.fileTrgtKey
        };
        // Reuse same modal as Type 4
        openModal("/static/html/user/wb/wb24/WB2401P11.html", 1200, 870, "WBS 실적문제수정", paramObj, function (){
             load_jsmind();
        });
    }

</script>
   </body>
</html>
