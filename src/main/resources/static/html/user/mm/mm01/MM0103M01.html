<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
	<link rel="stylesheet" href="/static/css/tui-grid/4.21.22/tui-grid.css" />
	<link rel="stylesheet" href="/static/css/gnb.css" />
	<link rel="stylesheet" href="/static/css/main.css" />
	<link rel="stylesheet" href="/static/css/sub.css" />
	<link rel="stylesheet" href="/static/css/common.css" />
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/tui-grid/4.21.22/tui-grid.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	
	<!-- 마인드맵 -->
    <link type="text/css" rel="stylesheet" href="./jsmind.css" />
    <script src="./jsmind.js"></script>
    <script src="./jsmind.draggable-node.js"></script>
    <style type="text/css">
        #jsmind_container { width: 1900px; height: 890px; border: solid 1px #ccc; background: #f4f4f4; }
    </style>
    
</head>

<body>
<div id="head_area"></div>
<div id="top_area"></div>
<div id="main_area">
    <input type="hidden" id="pgmId"  name="pgmId" value="MM0103M01">
    <input type="hidden" id="coCd"  name="coCd">

	<!-- 검색 콘텐츠 -->
	<div class="contents search">
		<!--  테이블 인풋 4분할  -->
		<table class="table_input type04">
	        <!-- Search Bar -->
			<tr>
				<th>SalesCode</th>
				<td>
					<div class="search_form" style="display: flex; align-items: center;">
						<input type="text" id="salesCd" name="salesCd" data-search="salesCd">
						<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
					</div>
                </td>
				<th></th>
				<td></td>
				<th></th>
				<td></td>
				<th></th>
				<td>
                    <div class="add_btn_small">
                        <a onclick="saveMindMapImage()" style="height: 30px; line-height: 28px; width: 110px; margin-right: 5px;"><i class="fa fa-file-image"></i> Save Image</a>
                        <a onclick="printMindMap()" style="height: 30px; line-height: 28px; width: 110px;"><i class="fa fa-print"></i> Print</a>
                    </div>  </td>
			</tr>
		</table>
    </div>
    <div id="jsmind_container" style="height: calc(100% - 40px);"></div>
 </div>
    <script type="text/javascript">
    const blueGradient = ['#0d47a1', '#1565c0', '#1976d2', '#1e88e5', '#2196f3', '#42a5f5', '#64b5f6', '#90caf9', '#bbdefb', '#e3f2fd'];
    const greenHarmony = ['#10451d', '#155d27', '#1a7431', '#208b3a', '#25a244', '#2dc653', '#4ad66d', '#6ede8a', '#92e6a7', '#b7efc5'];
    const sunsetBliss = ['#0d47a1', '#0d47a1', '#006494', '#006d77', '#166088', '#218380', '#73d2de', '#ffbc42', '#d81159', '#8f2d56', '#218380', '#73d2de'];
    
    var jm = null;
    function load_jsmind() {
        var param = {
            salesCd: $('#salesCd').val(),
            ordrsNo: $('#salesCd').val().slice(0, 5).trim(),
        };

        postAjax('/user/mm/mm01/selectMindMapList', param, null, function(data) {
            if (data.resultList) {
                renderMind(data.resultList);
            } else {
                alert("데이터 조회 실패");
            }
        });
    }
    

 	$(document).ready(function() {
 		//초기설정들
 		mainDefaultLoad("공통정보", "마인드맵현황");
 		setCommonSelect($("#main_area select[data-kind]"));

 		// 화면 크기 조절
//  		$("#top_area").hide();
 		$('#head_area').toggleClass('off');
 		$('#main_area').toggleClass('on');
 		
 		

		// URL 파라미터 추출
		const urlParams = new URLSearchParams(window.location.search);
		const salesCd = urlParams.get('salesCd') || "";
		const coCd = urlParams.get('coCd') || "";
		
		if (salesCd) $('#salesCd').val(salesCd);
		if (coCd) $('#coCd').val(coCd);

         load_jsmind();
         
         // Auto search on Enter or Blur
         $('#salesCd').on('keypress', function(e) {
             if (e.which == 13) {
                 load_jsmind();
                 $(this).blur(); // Remove focus
             }
         }).on('change', function() {
             // Triggered on blur if value changed
             load_jsmind();
         });
         

         // 뒤로가기 시 목록 화면으로 이동
         history.pushState(top.location.href, null, top.location.href);
         window.addEventListener('popstate', function(event) {
             location.href = "/static/index.html";
         });
 	});

     function renderMind(dbList) {
         // console.log("renderMind data:", dbList);
         if (!dbList || dbList.length === 0) {
             alert("조회된 데이터가 없습니다.");
             return;
         }

         // Transform DB list to jsMind node_array
         var nodeArray = [];
         
         dbList.forEach(function(item) {
             var id = item.id || item.ID;
             var topic = item.topic || item.TOPIC || id;
             var parentid = item.parentid || item.PARENTID;
             // DB field can be camel/snake/upper depending on mapper
             var dataType = (item.dataType != null ? item.dataType : '');

             // Data Fields
             var actNm = item.actNm || item.ACT_NM || '';
             var reqSt = item.reqSt || item.REQ_ST || '';
             var issSts = item.issSts || item.ISS_STS || '';
             
             // Topic Formatting
             var displayTopic = topic;
             
             if (dataType == '5') {
                 // Type 5: actNm / topic (+ warning if not REQST03)
                 displayTopic = actNm + ' / ' + topic;
                 if (reqSt !== 'REQST03') {
                     displayTopic += ' <i class="fa fa-exclamation-circle" style="color:red; font-size:14px; margin-left:4px;" title="미완료"></i>';
                 }
             } else if (dataType == '4') {
                 // Type 4: actNm / topic (+ warning if not ISSSTS03)
                 displayTopic = actNm + ' / ' + topic;
                 if (issSts !== 'ISSSTS03') {
                     displayTopic += ' <i class="fa fa-exclamation-circle" style="color:red; font-size:14px; margin-left:4px;" title="미완료"></i>';
                 }
             } else if (parseInt(dataType) >= 2) {
                 // Type 2,3: id / topic
                 displayTopic = id + ' / ' + topic;
             }

             var node = {
                 id: id,
                 topic: displayTopic
             };
             
             if (parentid && parentid !== 'ROOT' && parentid !== '') {
                 node.parentid = parentid;
             } else {
                 node.isroot = true;
             }

             // Color Logic
             if ((dataType == '4' && issSts === 'ISSSTS03') || 
                 (dataType == '5' && reqSt === 'REQST03')) {
                  // Completed Issue/Request -> Neutral/No Color
                  node['background-color'] = '#f0f0f0'; 
                  node['foreground-color'] = '#777'; // Dimmed text
             } else {
                  node['background-color'] = sunsetBliss[gPasIntChk(dataType)];
                  node['foreground-color'] = (dataType == '5') ? '#fff' : '#fff';
             }
             
             // Extra metadata for details
             node.data = Object.assign({}, item);
              
             nodeArray.push(node);
         });

         var mind = {
             meta: { name: 'ProjectMap', author: 'GBS', version: '1.0', },
             format: 'node_array',
             data: nodeArray
         };

         var options = {
             container: 'jsmind_container',
             editable: false, 
             theme: 'greensea',
             support_html: true, // Enable HTML for icons
             view:{ line_width: 2, line_color: '#ccc', },
             layout: { hspace: 50, vspace: 10, pspace: 13, }
         };
         
         // Clear previous map
         $('#jsmind_container').empty();

         jm = new jsMind(options);
         jm.show(mind);

     }


      /**
       * [Common] Capture the entire mind map including off-screen nodes.
       * Uses CSS Transform to shift all content into the visible area before capturing.
       */
      function captureMindMap() {
          return new Promise((resolve, reject) => {
              const container = document.querySelector('#jsmind_container');
              if (!container) return reject('Container not found');

              // jsMind scroll container is `.jsmind-inner` (not `#jsmind_container`).
              // If we use the wrong scroll offsets, the capture bounds become too small and
              // the lower nodes get clipped in image/print.
              const panel = container.querySelector('.jsmind-inner') || container;
              const captureEl = panel;

              const originalStyles = {
                  containerWidth: container.style.width,
                  containerHeight: container.style.height,
                  containerOverflow: container.style.overflow,
                  panelWidth: panel.style.width,
                  panelHeight: panel.style.height,
                  panelOverflow: panel.style.overflow,
                  transforms: []
              };

              const shiftChildren = Array.from(panel.children);
              shiftChildren.forEach(child => {
                  originalStyles.transforms.push(child.style.transform);
              });

              // Make overflow visible so html2canvas can draw outside the viewport.
              container.style.overflow = 'visible';
              panel.style.overflow = 'visible';

              // Calculate bounding box of ALL nodes relative to the scrollable panel.
              let minX = Infinity, minY = Infinity;
              let maxX = -Infinity, maxY = -Infinity;

              const panelRect = panel.getBoundingClientRect();
              const nodes = panel.querySelectorAll('jmnode');

              if (nodes.length === 0) {
                  minX = 0; minY = 0;
                  maxX = panel.clientWidth; maxY = panel.clientHeight;
              } else {
                  nodes.forEach(node => {
                      const rect = node.getBoundingClientRect();
                      const relLeft = rect.left - panelRect.left + panel.scrollLeft;
                      const relTop = rect.top - panelRect.top + panel.scrollTop;
                      minX = Math.min(minX, relLeft);
                      minY = Math.min(minY, relTop);
                      maxX = Math.max(maxX, relLeft + rect.width);
                      maxY = Math.max(maxY, relTop + rect.height);
                  });
              }

              const padding = 50;
              const shiftX = padding - minX;
              const shiftY = padding - minY;
              const captureWidth = Math.ceil((maxX - minX) + (padding * 2));
              const captureHeight = Math.ceil((maxY - minY) + (padding * 2));

              // Resize to fit everything (both container + panel to avoid 100% sizing surprises).
              container.style.width = captureWidth + 'px';
              container.style.height = captureHeight + 'px';
              panel.style.width = captureWidth + 'px';
              panel.style.height = captureHeight + 'px';

              // Reset scroll so our translation is predictable.
              panel.scrollLeft = 0;
              panel.scrollTop = 0;

              // Shift canvas + nodes together (they are siblings under the panel).
              shiftChildren.forEach(child => {
                  child.style.transform = `translate(${shiftX}px, ${shiftY}px)`;
              });

              // Prevent large captures from silently clipping due to browser canvas limits.
              const desiredScale = Math.min(2, (window.devicePixelRatio || 1));
              const maxDim = 16384;
              const safeScale = Math.max(0.1, Math.min(desiredScale, maxDim / captureWidth, maxDim / captureHeight));

              html2canvas(captureEl, {
                  scale: safeScale,
                  width: captureWidth,
                  height: captureHeight,
                  windowWidth: captureWidth,
                  windowHeight: captureHeight,
                  x: 0,
                  y: 0,
                  scrollX: 0,
                  scrollY: 0,
                  useCORS: true,
                  allowTaint: true,
                  backgroundColor: '#f4f4f4',
                  logging: false
              }).then(canvas => {
                  // Cleanup / Restore
                  container.style.width = originalStyles.containerWidth;
                  container.style.height = originalStyles.containerHeight;
                  container.style.overflow = originalStyles.containerOverflow;
                  panel.style.width = originalStyles.panelWidth;
                  panel.style.height = originalStyles.panelHeight;
                  panel.style.overflow = originalStyles.panelOverflow;
                  shiftChildren.forEach((child, i) => {
                      child.style.transform = originalStyles.transforms[i];
                  });
                  resolve(canvas);
              }).catch(err => {
                  // Cleanup on error
                  container.style.width = originalStyles.containerWidth;
                  container.style.height = originalStyles.containerHeight;
                  container.style.overflow = originalStyles.containerOverflow;
                  panel.style.width = originalStyles.panelWidth;
                  panel.style.height = originalStyles.panelHeight;
                  panel.style.overflow = originalStyles.panelOverflow;
                  shiftChildren.forEach((child, i) => {
                      child.style.transform = originalStyles.transforms[i];
                  });
                  reject(err);
              });
          });
      }

     /**
      * [Export] Save Mind Map as PNG image
      */
     function saveMindMapImage() {
         captureMindMap().then(canvas => {
             const salesCd = $('#salesCd').val() || "MindMap";
             const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
             const filename = `MindMap_${salesCd}_${dateStr}.png`;
             
             const link = document.createElement('a');
             link.download = filename;
             link.href = canvas.toDataURL("image/png");
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }).catch(err => {
             console.error("Image export failed:", err);
             alert("이미지 저장 중 오류가 발생했습니다.");
         });
     }

     /**
      * [Print] Print Mind Map (Fit to Page)
      */
     function printMindMap() {
         captureMindMap().then(canvas => {
             var imgData = canvas.toDataURL("image/png");
             var w = window.open("");
             w.document.write("<html><head><title>Mind Map Print</title>");
             // Set page margin to 0 or small value, and center content
             w.document.write("<style>@page { size: landscape; margin: 5mm; } body { margin: 0; text-align: center; display: flex; align-items: center; justify-content: center; height: 100vh; background: #fff; }</style>");
             w.document.write("</head><body>");
             // Fit image: max-width/height 100% preserves aspect ratio and fits in the page
             w.document.write("<img src='" + imgData + "' style='max-width:100%; max-height:100%; object-fit: contain; border: 1px solid #ddd;'>");
             w.document.write("</body></html>");
             w.document.close();
             
             setTimeout(function () {
                 w.print();
                 w.close();
             }, 500);
         }).catch(err => {
             console.error("Print capture failed:", err);
             alert("출력 중 오류가 발생했습니다.");
         });
     }

   	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
   	function wbsSalesCodeSearch() {

   		var paramObj = {
   		   "coCd" : $('#coCd').val(),
   		   "salesCd": $('#salesCd').val()
   		};
   		openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 700, "SALES CODE 검색", paramObj, function (grid){
   			var row = grid.target.getList("selected")[0];
   			$('#salesCd').val(row.salesCd);
   			//$('#wbsClntPjt').val(row.clntPjt); // 고객사 PJT
   			//$('#prdtCd_S').val(row.prdtCd); // 제품구분
   			//$('#prdtNm_S').val(row.prdtCdNm); // 제품구분
   			//$('#itemDiv_S').val(row.itemDiv); // 아이템 구분
   			//$('#eqp_nm').val(row.eqpNm); // 설비명
   			//$('#clntCd').val(row.ordrsClntCd); // 고객사코드
   			//$('#clntNm').val(row.ordrsClntNm); // 고객사명
   			load_jsmind();
   		});
   	}
</script>
   </body>
</html>
