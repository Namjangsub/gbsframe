<style>
.checkbox-container input[type="checkbox"] {
	margin-left: 10px; /* 왼쪽에 10픽셀의 여백 추가 */
}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">개선 제안서 등록</h4>
	</div>

	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="userId" name="userId"> 
			<input type="hidden" id="pgmId" name="pgmId" value="IM0101P01"> 
			<input type="hidden" id="ordrgMngNm" name="creatNm" value="">
			<!-- 알림톡발송용 생성자명(발주담당자) -->
			<input type="hidden" id="ordrgMngTelNo" name="ordrgMngTelNo" value="">
			<!-- 알림톡발송용 생성자전화번호 -->
			<select id="prdMngChk" data-kind="SPECRTS" hidden></select>
			<!-- 생산관리(제조혁신체크) -->
			<table>

				<colgroup>
					<col width="10%">
					<col width="23%">
					<col width="11%">
					<col width="23%">
					<col width="10%">
					<col width="23%">
					<col width="10%">
					<col width="23%">
				</colgroup>

				<tr class='imprArea'>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
						</select>
					</td>
					<th class="hit">작성자</th>
					<td>
                        <div class="search_form">
                            <input type="hidden" id="imprvmId" name="imprvmId" required msg="작성자">
                            <input type="hidden" id="imprvmDeptCd" name="imprvmDeptCd"> 
                            <input type="text" id="imprvmIdNm" name="imprvmIdNm" required onkeyUp="if(window.event.keyCode == 8){imprvmId.value = '';imprvmDeptCd = '';};">
                            <a onclick="openUserSearch(1);"><i class="i_search_w"></i></a>
                        </div>
					</td>
					<th>작성일자</th>
					<td>
						<input type="text" id="imprvmDt" name="imprvmDt" readonly="readonly">
					</td>
					<th>제안서번호</th>
					<td>
						<input type="text" id="imprvmNo" name="imprvmNo" readonly="readonly">
					</td>
				</tr>

				<tr class='imprArea'>
					<th  class="hit" id="salesCode">SalesCode</th>
					<td>
						<div class="search_form">
							<input type='hidden' id="clntPjt" name="clntPjt"> 
							<input type="text" id="salesCd" name="salesCd" class="form-control" msg="salesCode" required placeholder="필수입력"> 
							<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>장비명</th>
					<td colspan="1"><input type="text" id="unitNo" name="unitNo" cols="100%" rows="1"  msg="장비명 및 문서명" readonly placeholder="SalesCode 선택"></td>
					
					<th>제품유형</th>
					<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" class="form-control" style="text-align: center;" readonly>
					<td colspan="1">
						<div class="search_form">
							<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtNm" class="form-control" readonly></a>
						</div>
					</td>
					<th>진행상태</th>
					<td>
						<div>
							<input type='hidden' id="imprvmStsCdOrg" name="imprvmStsCdOrg"> 
							<select id="imprvmStsCd" name="imprvmStsCd" class="form-control" data-kind="IMPRSTS" msg="진행상태">
								<!-- 	                    <option value="">선택</option> -->
							</select>
						</div>
					</td>
				</tr>

				<tr class='imprArea'>

					<th class="hit">분류</th>
					<td colspan=3>
						<div class="checkbox-container" style="text-align: left;">
							<label><input type="checkbox" id="IMPRVMCD01" name="imprvmType" value="IMPRVMCD01" data-label="장애"> 장애 </label> 
							<label><input type="checkbox" id="IMPRVMCD02" name="imprvmType" value="IMPRVMCD02" data-label="반복장애"> 반복장애</label> 
							<label><input type="checkbox" id="IMPRVMCD03" name="imprvmType" value="IMPRVMCD03" data-label="품질"> 품질</label> 
							<label><input type="checkbox" id="IMPRVMCD04" name="imprvmType" value="IMPRVMCD04" data-label="원가"> 원가</label> 
							<label><input type="checkbox" id="IMPRVMCD05" name="imprvmType" value="IMPRVMCD05" data-label="일정"> 일정</label> 
							<label><input type="checkbox" id="IMPRVMCD06" name="imprvmType" value="IMPRVMCD06" data-label="업무"> 업무</label> 
							<label><input type="checkbox" id="IMPRVMCD07" name="imprvmType" value="IMPRVMCD07" data-label="아이디어"> 아이디어</label> 
							<label><input type="checkbox" id="IMPRVMCD99" name="imprvmType" value="IMPRVMCD99" data-label="기타"> 기타</label>
						</div>
					</td>
					<td colspan="4">
					</td>

				</tr>
				<tr class='imprArea'>
					<th class="hit">개선내용</th>
					<td colspan="3">
						<textarea id="imprvmTxt" name="imprvmTxt" rows="5" class="form-control" required msg="개선내용">
						</textarea>
					</td>
					<th>비고</th>
					<td colspan="3"><textarea type="text" id="imprvmRmk" name="imprvmRmk" cols="100%" rows="5" class="form-control" msg="비고"></textarea></td>
					<div>
						<div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 140px; width: 100%; display:none;"></div>
					</div>
				</tr>


				<tr class='level1'>
					<th colspan="8" style='text-align: center; background-color: lemonchiffon; padding-top: 20px;'>개선업무 담당자
				</tr>

				<tr class='level1'>
					<th class="hit">검토부서</th>
					<td>
                        <div class="search_form">
                            <input type="hidden" id="execActDept" name="execActDept" required msg="검토부서">
                            <input type="text" id="execActDeptNm" name="execActDeptNm" onkeyUp="if(window.event.keyCode == 8){execActDept.value = ''};" readonly>
                            <a onclick="openDeptTree();"><i class="i_search_w"></i></a>
                        </div>
					</td>
					<td colspan="6">
					</td>
				</tr>
				
				<tr class='execArea'>
					<th colspan="8" style='text-align: center; background-color: lemonchiffon; padding-top: 20px;'>검토부서
				</tr>
				<tr class='execArea'>
					<th class="hit fieldTitle">기계분류</th>
					<td colspan="1">
						<div>
							<select id="mcPartCd" name="mcPartCd" data-kind="MCPARTCD" class="form-control" required msg="기계분류">
								<option value="">선택(필수)</option>
							</select>
						</div>
					</td>
					<th class="hit fieldTitle">중요도</th>
					<td colspan="1">
						<div>
							<select id="importantCd" name="importantCd" data-kind="IMPORTANTCD" class="form-control" required msg="중요도">
								<option value="">선택(필수)</option>
							</select>
						</div>
					</td>
					<th class="hit fieldTitle">영향도</th>
					<td colspan="1">
						<div>
							<select id="impactCd" name="impactCd" data-kind="IMPACTCD" class="form-control" required msg="영향도">
								<option value="">선택(필수)</option>
							</select>
						</div>
					</td>
					<th>검토일자</th>
					<td colspan="1">
							<input id="execTeamDttm" name="execTeamDttm" class="input_calendar" onkeyup="dateMask(this);" autocomplete="off" msg="검토일자" >
					</td>
				</tr>
				<tr class='execArea'>
					<th class="hit">검토부서의견</th>
					<td colspan="3"><textarea id="execActTxt" name="execActTxt" cols="100%" rows="4" class="form-control" required msg="검토부서의견"></textarea></td>
					<td colspan="4" rowspan="2">
						<!-- 공유대상자-->
						<div class="popup_table" id="approval_trgt">
							<table style="border: 0px; display:none;">
								<tr>
									<td style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold;">※ 검토부서 공유 및 결재</td>
									<td>
										<div class="add_btn_small pdl10" id="plus-minus2">
											<a onclick="insertShareUserModal1(gridViewPop2);" style="height: 30px; line-height: 28px;">+</a> <a onclick="deleteShareUser1(gridViewPop2);" style="height: 30px; line-height: 28px;">-</a>
										</div>
									</td>
								</tr>
								<tr>
									<td colspan="2">
										<div>
											<div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 140px; width: 100%;"></div>
										</div>
									</td>
								</tr>
							</table>
						</div>
					</td>
				</tr>
				<tr class='execArea'>
					<th>기타 의견</th>
					<td colspan="3"><textarea id="execTeamTxt" name="execTeamTxt" cols="100%" rows="4" class="form-control" msg="기타 의견"></textarea></td>
				</tr>

				<tr class='evalArea'>
					<th colspan="8" style='text-align: center; background-color: lemonchiffon; padding-top: 20px;'>평가 결과
				</tr>
				<tr class='evalArea'>
					<th rowspan="3">평가의견</th>
					<td rowspan="3" colspan="5">
						<textarea type="text" id="imprvmApprTxt" name="imprvmApprTxt" cols="100%" rows="4" class="form-control" msg="평가 결과" placeholder="사장님 최종 평가 내용을 등록합니다."></textarea>
					</td>
					<th>평가등급</th>
					<td>
<!-- 						<input type="text" id="imprvmApprGrade" name="imprvmApprGrade" class="form-control" msg="평가등급"  placeholder="사장님 평가 내용입니다."> -->
						<select id="imprvmApprGrade" name="imprvmApprGrade" class="form-control" msg="평가등급">
							<option value="">등급(필수)</option>
							<option value="S등급">S등급</option>
							<option value="A등급">A등급</option>
							<option value="B등급">B등급</option>
							<option value="C등급">C등급</option>
							<option value="D등급">D등급</option>
							<option value="채택상">채택상</option>
							<option value="참여상">참여상</option>
						</select>
					</td>
				</tr>
				<tr class='evalArea'>
					<th>평가점수</th>
					<td><input type="text" id="imprvmApprPoint" name="imprvmApprPoint" class="form-control" msg="평가점수" onkeyup="checkChange(this);" placeholder="사장님 평가 내용입니다."></td>
				</tr>
				<tr class='evalArea'>
					<th>평가일자</th>
					<td>
						<input id="imprvmApprDttm" name="imprvmApprDttm" class="input_calendar" onkeyup="dateMask(this);" autocomplete="off" msg="평가일자" >
					</td>
				</tr>

			</table>
	</form>


	<!-- 공통 파일 영역 -->
	<div id="fileList_area_IM" style="margin-bottom: 30px;"></div>


	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button type="button" id="actionBtn">등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" id="reportBtn" onclick="reportDetail();">출력</button>
	</div>

</div>
<script type="text/javascript">

	/***********전역변수****************/
	let actionType = null;		//C:등록,  U: 수정
	let jobLevel = 0;		//0:등록,  1:검토부서 처리, 2:검토부서의견, 3:평가결과 등록 
	let currFormId = '#popForm';
	let imprvmNo = '';
    var approvalList = null;
    var hasImprApproval = false;
    var hasExecApproval = false;
	var imprvmReqId= ''	//작성자 팀장 ID정보
	var execTeamId ='' 	//조치부서팀장 ID정보
	
    var teleNo = ""; //카카오 접수자 전화번호변수
 	// 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
    
	const imprAreaKey = ['coCd', 'SalesCode', 'salesCd', 'imprvmTxt', 'imprvmRmk', 'imprvmIdNm', 'imprvmId'];
	const level1Key = ['execActDept'];
	const execAreaKey = ['mcPartCd', 'importantCd', 'impactCd', 'execActTxt'];
	const evalAreaKey = ['imprvmApprTxt', 'imprvmApprGrade','imprvmApprPoint'];


	// 크기 조절할 textarea ID 리스트
	const textAreas = [
	    '#imprvmTxt',  // 개선내용
	    '#imprvmRmk',  // 비고
	    '#imprvmReqTxt',  // 제안팀장의견
	    '#execActTxt', // 조치결과
	    '#execTeamTxt', // 조치팀장결과
	    '#imprvmApprTxt' // 평가결과
	];
	
	var gridViewPop1 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $(currFormId).find('[data-ax5grid="first-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 40},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 60},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 40},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 80},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 80},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: "*"},
                    {key: "todoKey",      		label: "todoKey",	align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",align: "center",   width: 130, hidden: true},
                    {key: "todoId",      		label: "todoId",	align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			var targetObj = this.target;
        			var formData = {
     	        			"fileTrgtKey" : imprvmNo,
     	        			"reqNo" 	  : imprvmNo,
     	        			"flag" 	  	  : 'Y1',
     	        			"pageNo" 	  : _pageNo + 1
     	    		}

   					postAjax("/user/im/im01/selectImprovementShareUserlst", formData, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : {
											totalElements : list.length
								}
							});
							
							$.gridNoSet(gridViewPop1, "sanctnSn");
							gridResize(gridViewPop1, list.length); //그리드 높이 조정
						} catch (error) {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
   	  				});
          		},

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    }
   	  					});

					gridResize(gridViewPop1, _list.length); //그리드 높이 조정
          		}
  	}

	var gridViewPop2 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $(currFormId).find('[data-ax5grid="second-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 40},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 60},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 40},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 80},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 80},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: "*"},
                    {key: "todoKey",      		label: "todoKey",	align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",align: "center",   width: 130, hidden: true},
                    {key: "todoId",      		label: "todoId",	align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			var targetObj = this.target;
        			var formData = {
     	        			"fileTrgtKey" : imprvmNo,
     	        			"reqNo" 	  : imprvmNo,
     	        			"flag" 	  	  : 'Y2',
     	        			"pageNo" 	  : _pageNo + 1
     	    		}

   					postAjax("/user/im/im01/selectImprovementShareUserlst", formData, null, function(data){
						try {
							var list = data.result;
							targetObj.setData({
								list : list,
								page : {
											totalElements : list.length
								}
							});

							//조치결과 결재 값이 'Y'인 것이 하나라도 있는지 확인
							hasExecApproval = list.some(item => item.gb === '결재' && item.sanctnSttus === 'Y');
							if (hasExecApproval) {
	//    					    	alert("조치결과 결재완료건입니다.");
								toast.push({msg: "검토부서 결재완료건입니다.", theme: 'danger'});
							}

							$.gridNoSet(gridViewPop2, "sanctnSn");
							gridResize(gridViewPop2, list.length); //그리드 높이 조정
						} catch (error) {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
   	  				});
          		},

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    }
   	  					});

					gridResize(gridViewPop2, _list.length); //그리드 높이 조정
          		}
  	}
	
	$(document).ready(function() {
		toast.init();
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		actionType = modalStack.last().paramObj.actionType;
		jobLevel = modalStack.last().paramObj.jobLevel;
		imprvmNo = modalStack.last().paramObj.imprvmNo;
		$(currFormId + ' #userId').val(jwt.userId);
		$(currFormId + ' #imprvmId').val(jwt.userId);
		$(currFormId + ' #imprvmIdNm').val(jwt.userNm);
		$(currFormId + ' #imprvmDeptCd').val(jwt.deptId);
		$(currFormId + ' #imprvmNo').val('신규');


		// 시작일 (현재날짜의 월 첫일)
		$('#execTeamDttm').datepicker({format : "yyyy-mm-dd",language : "ko",autoclose : true});
		$('#imprvmApprDttm').datepicker({format : "yyyy-mm-dd",language : "ko",autoclose : true});

		 $('#imprvmTxt').val("①현황 : \n②문제점 : \n③개선내용 : \n④기대효과 : \n로 작성요망");
		$(currFormId + ' #imprvmStsCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		$(currFormId + ' #imprvmStsCdOrg').val('IMPRSTS01');
		//처리일자//
//     	$(currFormId + ' #imprvmDt').datepicker("setDate", new Date().format('yyyy-MM-dd'));
		$(currFormId + ' #imprvmDt').val(new Date().format('yyyy-MM-dd'));
		//결재자정보 그리드
		gridViewPop1.initView();
		gridViewPop2.initView();

		// 분류 체크에 따른 SalesCode 필수 지정 변경
		$('input[name="imprvmType"]').on('change', function() {
			checkImprvmType();
		});

		if (actionType == "C") {
			$("#actionBtn").text("등록");
			formControl(); //작업단계별 입력화면 변경
			
			$('#actionBtn').on("click", function() {
				insertImprovement();
			});
			$('#reportBtn').hide();
			
		} else if (actionType == "U") {
			$('.tit').text('개선 제안서 수정')
			selectImprovement(imprvmNo);
			
			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateImprovement();
			});
		}
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: 'IM0101P01',
				fileTrgtKey	: modalStack.last().paramObj.imprvmNo,
	            todoNo		: imprvmNo,		//결재정보처리를 위함
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid-IM', 'FILETREE', fileParam, 'fileList_area_IM');
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		// 크기 조절할 textarea ID 리스트
		$(textAreas.join(',')).keydown(function () {
			// 각 textarea에 대해 크기 조절 함수 호출
			    txtareaHeightResize($(this));
		});
		
		authChk();						// 권한체크

	});
	
	//분류코드가 업무/아이디어/기타 인경우 SalesCd, 기계분류, 중요도, 영향도 필드 필수 해제
	function checkImprvmType () {
		// 필수 그룹: 장애, 반복장애, 품질, 원가, 일정
		var hitGroup = ["IMPRVMCD01", "IMPRVMCD02", "IMPRVMCD03", "IMPRVMCD04", "IMPRVMCD05"];
		var selected = $('input[name="imprvmType"]:checked');
		var hitRequriedCancel = false; 
		
		// 선택된 체크박스가 없으면 salesCode는 필수로 함
		if (selected.length === 0) {
			hitRequriedCancel = true;
		} else {
			// 선택된 체크박스 중 하나라도 필수 그룹에 있으면 salesCode는 필수
			selected.each(function(){
				if ($.inArray($(this).attr('id'), hitGroup) !== -1) {
					hitRequriedCancel = true;
					return false; // 반복문 탈출
				}
			});
		}
		
		if (hitRequriedCancel) {
			$("#salesCode").addClass('hit');					// 필수 조건 충족	: salesCode 필드에 hit 클래스 추가
			$("#salesCd").attr("required", "required");			// 필수 조건 충족	: salesCode required 속성 부여
		} else {
			$("#salesCode").removeClass('hit');					// 업무, 아이디어, 기타만 체크된 경우	: hit 클래스 제거 
			$("#salesCd").removeAttr("required");				// 업무, 아이디어, 기타만 체크된 경우 	: required 속성 제거

			$(".fieldTitle").removeClass('hit');				// 모든 타이틀에서 hit 클래스 제거
			$("#mcPartCd").removeAttr("required");				// 업무, 아이디어, 기타만 체크된 경우 	: required 속성 제거
			$("#importantCd").removeAttr("required");			// 업무, 아이디어, 기타만 체크된 경우 	: required 속성 제거
			$("#impactCd").removeAttr("required");				// 업무, 아이디어, 기타만 체크된 경우 	: required 속성 제거
			$('#mcPartCd, #importantCd, #impactCd').css({'background-color':'#e6e6e6','pointer-events':'none'});
		}
	}

	function formControl() {
		let imprvmStsCd = $(currFormId + ' #imprvmStsCd').val();
		//*********************************************************************************************************
		// 작업 단계별 상태코드 및 화면 컨트롤 하기
		//  1단계 : IMPRSTS01 --> 등록단계 , jobLevel = 1 , actionType = 'C', 'U'
		//  2단계 : IMPRSTS02 --> 접수단계 , jobLevel = 2 , actionType = 'U'
		//  3단계 : IMPRSTS03 --> 검토단계 , jobLevel = 3 , actionType = 'U'
		//  4단계 : IMPRSTS04 --> 결과단계 , jobLevel = 4 , actionType = 'U' --> IMPRSTS09
		//*********************************************************************************************************
		if (jobLevel == '2') {
			imprvmStsCd = 'IMPRSTS02';
		} else if (jobLevel == '3') {
			imprvmStsCd = 'IMPRSTS03';
		} else if (jobLevel == '4') {
			imprvmStsCd = 'IMPRSTS04';
		} 

		$(currFormId + ' #imprvmStsCd').val(imprvmStsCd);
		if (imprvmStsCd == 'IMPRSTS01' ) { //접수 단계 : 최초 등록상태 및 검토부서 등록전 단계
			//imprAreaKey 영역
			$('.level1').hide();
			$('.execArea').hide();
			$('.evalArea').hide();
			$('.level1').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.level1 th').removeClass('hit');
			$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.execArea th').removeClass('hit');
			$('.evalArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.evalArea th').removeClass('hit');
			level1Key.forEach(selector => { $('#'+selector).removeAttr('required', true); });
    		execAreaKey.forEach(selector => { $('#'+selector).removeAttr('required', true); });
    		evalAreaKey.forEach(selector => { $('#'+selector).removeAttr('required', true); });
		} else if (imprvmStsCd == 'IMPRSTS02' )  { //검토부서 확정 단계 : 검토부서 확정 단계
			//level1Key 영역
			$('#imprvmType').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	    	if ($('#prdMngChk option').attr('data-etc').replace(/\s/g,'').split(',').includes(jwt.userId)  || jwt.userId == 'js.nam') {
	    		$('#execActDeptNm').on('click', function () {
	    		    openDeptTree();
	    		});
	    	} else {
				$('.level1').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	    		$('.level1 th').removeClass('hit');
	    	}

//				$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'}); //제안영역Class 클릭 이벤트 금지하기
    		$('.imprArea th').removeClass('hit');
    		imprAreaKey.forEach(selector => { $('#'+selector).prop('readonly', true);  });	//제안영역의 수정 방지하기
    		$('[name="imprvmType"]').on('click', function(e) {
    		    e.preventDefault();
    		    e.stopPropagation();
    		});	//제안영역의 선택변경 방지하기
	    	$('#imprvmIdNm, #salesCd + a').removeAttr('onclick'); //제안영역의 상세검색 기능 제거
			$('.evalArea').hide();
			$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.execArea th').removeClass('hit');
			$('.evalArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.evalArea th').removeClass('hit');
    		execAreaKey.forEach(selector => { $('#'+selector).removeAttr('required', true); });
    		evalAreaKey.forEach(selector => { $('#'+selector).removeAttr('required', true); });
		} else if (imprvmStsCd == 'IMPRSTS03' )  { //검토부서 의견등록 : 검토결과 등록단계
			//execAreaKey 영역
			$('.evalArea').hide();
			$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.imprArea th').removeClass('hit');
			$('.level1').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.level1 th').removeClass('hit');
			$('.evalArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.evalArea th').removeClass('hit');
    		evalAreaKey.forEach(selector => { $('#'+selector).removeAttr('required', true); });
    		$(currFormId + ' #execTeamDttm').datepicker("setDate", new Date().format('yyyy-MM-dd'));
		} else if (imprvmStsCd == 'IMPRSTS04' )  { //평가결과 등록 
			//evalAreaKey 영역
			$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.imprArea th').removeClass('hit');
			$('.level1').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.level1 th').removeClass('hit');
			$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.execArea th').removeClass('hit');

    		//평가일자//
    		$(currFormId + ' #imprvmApprDttm').datepicker("setDate", new Date().format('yyyy-MM-dd'));
			evalAreaKey.forEach(selector => { $('#'+selector).parent('td').prev('th').addClass('hit'); });
    		evalAreaKey.forEach(selector => { $('#'+selector).attr('required', true); });

    		
    		$(currFormId + ' #imprvmStsCd').val('IMPRSTS09');
// 		} else if (imprvmStsCd == 'IMPRSTS09' ) { //평가결과 등록 : 평가완료
		} else  { //평가결과 등록 : 평가완료
			//evalAreaKey 영역
			$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.imprArea th').removeClass('hit');
			$('.level1').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.level1 th').removeClass('hit');
			$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.execArea th').removeClass('hit');
			$('.evalArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
    		$('.evalArea th').removeClass('hit');

			$('#actionBtn').hide(); //평가완료인경우 수정버튼 활성화 없음
		}
	}
	
	
	function selectImprovement(_imprvmNo) {
		var formData = {
			"imprvmNo" 		: _imprvmNo,
		}
		postAjax("/user/im/im01/selectImprovement", formData, null, function(data) {
			if (data.result == undefined) {
				alert('자료가 존재하지 않습니다. 확인 바랍니다.' + _imprvmNo);
				return false;
			}
			if (actionType == "C") {
				data.result.imprvmNo = '';
				delete data.result.creatId;
				delete data.result.creatNm;
				delete data.result.creatPgm;
				delete data.result.creatDttm;
				delete data.result.udtId;
				delete data.result.udtNm;
				delete data.result.udtPgm;
				delete data.result.udtDttm;
				delete data.result.imprvmStsCd;
			}
			
			$.each(data.result, function(key, value) {
				if ($(currFormId + ' #' + key)[0]) {
					$(currFormId + ' #' + key).val(value);
					if ($(currFormId + ' #' + key).is('[comma]')) {
						onlyNumber($(currFormId + ' #' + key)[0]);
					}
				}
			});
			//작업 컨트롤을 위한 Data의 작업 단계를 저장함
			$(currFormId + ' #imprvmStsCdOrg').val(data.result.imprvmStsCd);

			// 
			if (jobLevel == '1' && $("#imprvmStsCd").val() !== 'IMPRSTS01') {
				$('#actionBtn').hide();
			}
			
			let tmpReqInfo = data.result.imprvmReqDttm == undefined ? '' : `${data.result.imprvmReqIdNm}\n${data.result.imprvmReqDttm}`;
			let tmpExecInfo = data.result.execTeamDttm == undefined ? '' : `${data.result.execTeamIdNm}\n${data.result.execTeamDttm}`;
			$(currFormId + ' #imprvmReqIdTxt').val(tmpReqInfo);	//작성부서장명+ 확인일시
			$(currFormId + ' #execTeamIdTxt').val(tmpExecInfo);		//조치부서장명+ 확인일시

	        // 분류항목 각 체크박스별로 체크하기 (저장시 콤마로 합쳐서 저장되어 있음))
			const idsArray = data.result.imprvmType.split(',').map(id => id.trim()); // 체크할 체크박스 ID 목록을  쉼표로 분리하여 배열로 변환
			idsArray.forEach(function(id) {
                $('#' + id).prop('checked', true); // 체크박스 체크
            });

// 			gridViewPop1.setData();
// 			gridViewPop2.setData();

			// 각 textarea에 대해 크기 조절 함수 호출
			textAreas.forEach(textAreaId => {
			    txtareaHeightResize($(textAreaId));
			});

			// 월마감체크 - 워킹데이기준
// 			monthCloseWorkingChk($('#imprvmApprDttm').val());
				
			formControl(); //작업단계별 입력화면 변경

			checkImprvmType();
		});
	}



	 // 등록
	function insertImprovement() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			if($("input[name='imprvmType']:checked").val() == undefined){
	            alert("분류 항목을 체크하세요");
	            return false;
	        }
			var formData = makeFormData();
			if (formData) {
				filePostAjax("/user/im/im01/insertImprovement", formData,
					function(data) {
						if (data.resultCode == 200) {
							$('#imprvmNo').val(data.imprvmNo);
							alert(data.resultMessage);
							kakaoTodo();
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
			}
		}
	}

	// 수정
	function updateImprovement() {
		if (inputValidation($('.popup_area [required]'))) {
			if($("input[name='imprvmType']:checked").val() == undefined){
	            alert("분류 항목을 체크하세요");
	            return false;
	        }
			var formData = makeFormData();	
			if (formData) {
	      		filePostAjax("/user/im/im01/updateImprovement", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							kakaoTodo();
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
			}
		}
	}

	//----------------------------------------------//
	
	function makeFormData() {

		// 폼데이터 생성
		var formData = new FormData($(currFormId)[0]);
		
		//품목정보를 comma로 구분하여 저장
        let tempValues = [];
        $('input[name="imprvmType"]:checked').each(function() {
        	tempValues.push($(this).val());
        });
        formData.set("imprvmType", tempValues.join(', '));

		selectTeamManagerApprovalAdd();

		const formDataKey = (jobLevel == '1' || jobLevel == '2')  ? 'approvalArr' : ''
		const approvalArr = processApprovalGrid(
			gridViewPop1,               // 결재자 그리드 객체
			formDataKey,              // 폼 필드명
			modalStack.last().paramObj, // 모달 파라미터 (rsltNo 등 포함)
			currFormId,                 // 폼 선택자
			modalStack
		);
		formData.set("approvalArr", JSON.stringify(approvalArr));
			
//     	formData.set("imprvmReqId", imprvmReqId);	//작성자 팀장 ID정보
	    	
		//*********************************************************************************************************
		// 작업 단계별 상태코드 및 화면 컨트롤 하기
		//  1단계 : IMPRSTS01 --> 등록단계 , jobLevel = 1 , actionType = 'C', 'U'
		//  2단계 : IMPRSTS02 --> 접수단계 , jobLevel = 2 , actionType = 'U'
		//  3단계 : IMPRSTS03 --> 검토단계 , jobLevel = 3 , actionType = 'U'
		//  4단계 : IMPRSTS04 --> 결과단계 , jobLevel = 4 , actionType = 'U' --> IMPRSTS09
		//*********************************************************************************************************
		
		if (jobLevel == '3') {
			formData.set("execTeamId", jwt.userId);
			formData.set("execTeamDttm", moment().format('YYYY/MM/DD HH:mm:ss'));
		} 
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.set("userId", jwt.userId);
		formData.set("clntCd", '');			//첨부화일용
		formData.set("prdtCd", $(currFormId + ' #prdtCd').val());			//첨부화일용
		formData.set("itemCd", $(currFormId + ' #itemCd').val());			//첨부화일용
		formData.set("prjctCd", '');		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.set("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.set("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.set("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	function processApprovalGrid(gridView, formDataKey, paramObj, currFormId, modalStack) {
		const rowSharngList = gridView.target.list;
		const ParamObj = { ...paramObj };
		ParamObj.rsltNo = $(`${currFormId} #imprvmNo`).val();
		ParamObj.actionType = 'U'; // 결재모드는 수정으로 접근하기 위함

		if (rowSharngList.length > 0) {
			const approvalArr = [];

			// 공통 파라미터 설정
			const addParam = {
				coCd: $(`${currFormId} #coCd`).val(),
				salesCd: $(`${currFormId} #salesCd`).val(),
				pgmId: $(`${currFormId} #pgmId`).val(),
				pgPath: "/user/im/im01/IM0101P01.html",
				sanctnSttus: "N",
				todoCoCd: $(`${currFormId} #coCd`).val(),
				todoNo: $(`${currFormId} #imprvmNo`).val(),
				todoFileTrgtKey: modalStack.last().paramObj.imprvmNo,
				pgParam: JSON.stringify(ParamObj),
				userId: jwt.userId,
				todoTitl: `${$(`${currFormId} #unitNo`).val()} 개선 제안서`,
				todoKey: "",
				todoCodeKind: "",
				todoCodeId: "",
			};

			let 결재순번 = 0;
			let 공유순번 = 0;

			$.each(rowSharngList, function (idx, elem) {
				if (!elem.usrNm.includes('gyrsult')) {
					const approvalListObj = { ...elem };

					addParam["todoId"] = elem.usrNm;
					addParam["empNo"] = elem.empNo;
					addParam["name"] = elem.name;
					addParam["telNo"] = elem.telNo;
					addParam["email"] = elem.eMail;
					addParam["gb"] = elem.gb;

					if (elem.gb === '공유') {
									공유순번 += 1;
						approvalListObj["sanctnSn"] = 공유순번;
						approvalListObj["todoDiv1CodeId"] = "TODODIV10";
						approvalListObj["todoDiv2CodeId"] = formDataKey === "approvalArr" ? "TODODIV1150" : "TODODIV1160";
					} else if (elem.gb === '결재') {
									결재순번 += 1;
						approvalListObj["sanctnSn"] = 결재순번;
						approvalListObj["todoDiv1CodeId"] = "TODODIV20";
						approvalListObj["todoDiv2CodeId"] = formDataKey === "approvalArr" ? "TODODIV2150" : "TODODIV2160";
					}

					approvalArr.push({ ...addParam, ...approvalListObj });
				}
			});

			return approvalArr;
		}
	}

	// 공유대상자 추가//
    function insertShareUserModal1(_grid) {

    	if( approvalYn(_grid) ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

        var paramObj = {};
        var appshaList = _grid.target.list;
        paramObj["coCd"] = $(currFormId + ' #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $(currFormId + ' #imprvmId').val();
        paramObj["userNm"] =  $(currFormId + ' #imprvmIdNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
        		}).map(function(item) {
	        		  	return {
	        			    gb: "결재",
	        			    id: item.usrNm,
	        			    text: item.name,
	        			    parent: item.jik,
	        			    deptNm: item.dtNm,
	        			    telNo: item.telNo,
	        			    offTelNo: item.offTelNo,
	        			    email: item.email,
	        			    todoId: item.usrNm,
	        			};
        		});
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
        		}).map(function(item) {
				  		return {
						    gb: "공유",
						    id: item.usrNm,
						    text: item.name,
						    parent: item.jik,
						    deptNm: item.dtNm,
						    telNo: item.telNo,
						    offTelNo: item.offTelNo,
						    email: item.email,
						    todoId: item.usrNm,
						};
				});

        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//     		console.log('결재라인 : ', approvalGrid.target.list);
//     		console.log('공유라인 : ', shareGrid.target.list);

    		var appArray = approvalGrid.target.list.map(function(item) {
    			  return {
    				  	gb: "결재",
    				  	usrNm: item.id,
    				  	name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id,
					};
			});
    		var shaArray = shareGrid.target.list.map(function(item) {
  			  return {
	  				  	gb: "공유",
						usrNm: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
	                    todoId: item.id,
					};
			});
    		_grid.setData2(appArray.concat(shaArray));
			$.gridNoSet(_grid, "sanctnSn");
    		gridResize(_grid, _grid.target.list.length); //그리드 높이 조정
    		
//     		approvalGrid.id //userId
//     		approvalGrid.text //성명
//     		approvalGrid.parent //직책
//     		approvalGrid.deptNm //부서
//     		approvalGrid.telNo
//     		approvalGrid.offTelNo
//     		approvalGrid.email

//     		shareGrid.id //userId
//     		shareGrid.text //성명
//     		shareGrid.parent //직책
//     		shareGrid.deptNm //부서
//     		shareGrid.telNo
//     		shareGrid.offTelNo
//     		shareGrid.email
        });

    }



	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
// 		console.log('---gridNoset run ---');
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}

    function deleteShareUser1(_grid){
    	if( approvalYn(_grid) ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

    	var selRow = parseInt(_grid.target.selectedDataIndexs);
	 		if( isNaN(selRow) ) {
	 			alert("선택된 행이 없습니다.");
	 			return;
	 		} else {
	 				if( selRow > -1 ) {
	 					//gridViewPop.target.removeRow(selRow);
	 					var todoKey = _grid.target.getList()[selRow].todoKey;
					if( typeof(todoKey) == "undefined" ) {
						_grid.target.removeRow(selRow);
						$.gridNoSet(_grid, "sanctnSn");
					} else {
						var gridList = _grid.target.getList("selected")[0];
						var paramObj = {
								todoKey			: gridList.todoKey,
								todoNo			: $(currFormId + ' #rsltNo').val(),
								sanctnSn		: gridList.sanctnSn,
								todoDiv1CodeId	: gridList.todoDiv1CodeId,
								todoDiv2CodeId	: gridList.todoDiv2CodeId,
						}
		 		        if(paramObj.todoKey && paramObj.sanctnSn && paramObj.todoDiv1CodeId && paramObj.todoDiv2CodeId ) {
	 	 						deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
	 	 							if (data.resultCode == 200) {
	 	 								_grid.setData(0);

	 	 								$.gridNoSet(_grid, "sanctnSn");
	 	 					    		gridResize(_grid, _grid.target.list.length); //그리드 높이 조정
	 	 							} else {
	 	 								alert("삭제중 오류가 발생했습니다");
	 	 							}
	 	 						});
		 		        } else {
		 		        	alert("삭제중 오류가 발생했습니다.")
		 		        }
					}
	 			}
	 		}
    }



    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $(currFormId + ' #coCd').val(),
           "salesCd": $(currFormId + ' #salesCd').val(),
           "searchValue": $(currFormId + ' #salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $(currFormId + ' #salesCd').val(row.salesCd);
            $(currFormId + ' #clntPjtCd').val(row.clntPjt);
            $(currFormId + ' #unitNo').val(row.eqpNm);
//             $('#vendCd').val(row.ordrsClntCd);
//             $('#vendNm').val(row.ordrsClntNm);
//             $('#eqpNm').val(row.eqpNm);
            $(currFormId + ' #prdtCd').val(row.prdtCd);
			$(currFormId + ' #prdtCdNm').val(row.prdtCdNm);
            $(currFormId + ' #itemDiv').val(row.itemDiv);
            $(currFormId + ' #itemDivNm').val(row.itemDivNm);
        });
    }
    		
		
	function setByCoCd(value) {
		$(currFormId + ' #coCd option:not([value="'+value+'"])').remove();
	}

    
	function gridResize(gridObj, size) {
		    size = size < 1 ? 1 : size;
	        var tagHeight = (size) * 28 + 60 ;
	        tagHeight = tagHeight > 750 ? 750 : tagHeight;
	        tagHeight = tagHeight < 140 ? 140 : tagHeight;

	        gridObj.target.setHeight(tagHeight);
	}


	//결재 여부
	function approvalYn(_grid) {
		var gridList = _grid.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
        	var msgArr = [];
	        $.each(gridList, function (idx, elem) {
	        	//결재자가 본인이 아니면서 상태가 Y인 경우
	        	if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
	        })
		}
		return inCnt;
	}


	/*
	#	TODO 알림톡발송 시작
	#
	*/
// 	$("#approvalReqTodoBtn").on("click", function () {
// 		kakaoTodo();
// 	});

	var kakaoErr = [];

	function kakaoTodo() {
        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	              "userId" 	 : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });
        }

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
	     var paramObj1 = {
	             "coCd" 	: $(currFormId + ' #coCd').val(),
	             "userId" 	: $(currFormId + ' #imprvmId').val()
	         };
	      postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
	          if (data.result[0] == undefined
	               || data.result[0].telNo == "") {
	        	  teleNo = "051-312-2400";
	          }
	          else {
	        	  teleNo = data.result[0].telNo;

	          }
	      });
	     //---------------------------------------
		const appDiv20 = (jobLevel == '1' || jobLevel == '2')  ? 'TODODIV2150' : 'TODODIV2160'
		const shaDiv20 = (jobLevel == '1' || jobLevel == '2')  ? 'TODODIV1150' : 'TODODIV1160'
		let param = {
				"tmplatDiv": "TMPLATDIV02"
				, "coCd": $(currFormId + ' #coCd').val()				//해당업무의 coCd(트르넷발주 TRN )
				, "todoDiv1CodeId": "TODODIV20"					//공통코드 해당업무 - 결재
				, "todoDiv2CodeId": appDiv20					//공통코드 해당업무 - 결재 - 발주서
				, "todoDiv1CodeNm": "결재"						//공통코드 해당업무 - 결재 - 발주서
				//, "todoDiv2CodeNm": "발주 및 출장 요청"						//공통코드 해당업무 - 결재 - 발주서
				, "title": "개선 제안서"
				, "sanctnDiv2": "결재"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
				, "todoNo": $(currFormId + ' #imprvmNo').val()
				, "clntCd": "1"					//발신회사는 로그인사용자 회사
				, "clntNm": clntNm				//로그의 수신거래처명
				, "ordrgMngNm": $(currFormId + ' #imprvmId').val()			//발주작성자(담당자)
				, "ordrgMngTelNo": teleNo		//담당자전화번호
				, "creatPgm"  : 'IM0101P01'
		}
		commKaKaoSendTodo(param);

		//공유
		let param2 = {
				"tmplatDiv": "TMPLATDIV02"
					, "coCd":  $(currFormId + ' #coCd').val()				//				//해당업무의 coCd(트르넷발주 TRN )
					, "todoDiv1CodeId": "TODODIV10"					//공통코드 해당업무 - 결재
					, "todoDiv2CodeId": shaDiv20					//공통코드 해당업무 - 결재 - 발주서
					, "todoDiv1CodeNm": "공유"						//공통코드 해당업무 - 결재 - 발주서
					, "title": "개선 제안서"
					, "sanctnDiv2": "공유"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
					, "todoNo": $(currFormId + ' #imprvmNo').val()
					, "clntCd": "1"					//발신회사는 로그인사용자 회사
					, "clntNm": clntNm				//로그의 수신거래처명
					, "ordrgMngNm": $(currFormId + ' #imprvmId').val()			//발주작성자(담당자)
					, "ordrgMngTelNo": teleNo		//담당자전화번호
					, "creatPgm"  : 'IM0101P01'
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
	    	kakaoCnt = 0;
// 	    	alert("알림톡이 정상 발송되었습니다.");
	    }
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
// 		console.log('---카카오 발주및출장결과서 알림톡발송시작 --' + param);

		//알림톡수신번호 채번
		var maxMessageId = null;			//message id(unique key)
		var talkMessage = null 				//발송될 내용 template
		var mobile = null					//수신인 휴대전화번호
		//var title = null					//todo title
		var todoDiv2CodeNm = null					//todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
					, function(data) {
						if(data.resultList.length > 0 ) {
							if( data.resultList[0].maxMessageId != "" ) {
								sendList = data.resultList;
							} else {
								alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
								return;
							}

						}
		});
		//user search ajax end

		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			//로그용
			param.rcvId = sendObj.todoId;			//todo 수신id
			param.rcvNm = sendObj.name;				//todo 수신자명
			param.nameTo = sendObj.name;				//todo 수신자명
			//title		= sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = todoDiv2CodeNm;
			//param.title = title;								//요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}
			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.title = param.title;					//알림톡 타이틀 -
			talkBody.message = message;				//알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;				//휴대전화번호
			talkBody.template = "10003";			//템플릿관리화면 템플릿ID	- 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end
		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}



	//제품코드 검색
	function openPrdtSearch(){
		var paramObj = {
				"coCd"	: $(currFormId + ' #coCd').val(),
				"prdtCd": $(currFormId + ' #prdtCd').val(),
				"prdtNm": $(currFormId + ' #prdtCdNm').val(),
				"useYn" : "Y"
		}
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$(currFormId + ' #prdtCd').val(row.prdtCd);
			$(currFormId + ' #prdtCdNm').val(row.prdtNm);
		});
	}


    //개선제안서 결재자 정보 추가
	function selectTeamManagerApprovalAdd() {
    	let appshaList = gridViewPop1.target.getList();

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보

        appshaList.forEach(item => (item.gb === "결재" ? appArray : shaArray).push(item));

// 		//작성자의 팀장 정보 가져와서  결제자에  추가
		if (jobLevel == '1' || jobLevel == '3') {
			// appArray = approvalTeamManagerSpecialInfoData('ycy', appArray);
			// appArray = approvalTeamManagerSpecialInfoData('cyh', appArray);
			appArray = approvalTeamManagerSpecialInfoData('pwj', appArray);
			if (jobLevel == '3') {
				appArray = approvalTeamManagerSpecialInfoData($("#imprvmId").val(), appArray)
			}
		} else if (jobLevel == '2') {
			appArray = selectDept2TeamManagerInfo($("#execActDept").val(), appArray);
		}
		
		gridViewPop1.setData2(appArray.concat(shaArray));

		$.gridNoSet(gridViewPop1, "sanctnSn");
	}

    //조치담당자정보 자동 추가하기
	function approvalUserInfoData (appUserId, appArray, shaArray) {
	    var formData = {
	        "userId" : appUserId,
	    }
	    postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
	    	if (data.resultList != '' && data.resultList!=null) {
	    		//조치결과 결자자 정보 가져오기
	    		let list = data.resultList[0];
	    		if (appArray.some(item => item.usrNm === list.usrNm)) {
	    			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
	    		} else {
	    			appArray.push({
		                        gb: "공유",
		                        usrNm: list.usrNm,
		                        name: list.name,
		                        jik: list.jik,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                    });
	    		}

        		// 공유영역에 usrNm 값이 list.id 와 같은 결제자는 삭제
        		shaArray = shaArray.filter(item => item.usrNm !== list.id);
	    	}
		});
		return appArray;
	}

	//특정담당자 정보 가져오기
	function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

	

    //작성자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray, shaArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        		imprvmReqId = list.id;	//작성자 팀장 ID정보 백엔드로 보내기위해 저장함.
        		// 공유영역에 usrNm 값이 list.id 와 같은 결제자는 삭제
        		shaArray = shaArray.filter(item => item.usrNm !== list.id);
        	}
		});
		return appArray;
	}
	

    //부서코드로 팀장 정보 가져오기
	function selectDept2TeamManagerInfo(deptId, appArray) {

		// TRN30(트루넷직접매출) 일때는 TRN50(트루넷외주구매팀)의 허상렬 부장에게 알림을 보내기 위함
		if (deptId.slice(0,3) == 'TRN') {
			deptId = 'TRN50';
		}
	    var formData = {
		        "deptId" : deptId,
		}
        postAjaxSync("/user/wb/wb24/selectDept2TeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}

        		execTeamId = list.id;	//조치부서 팀장 ID정보 백엔드로 보내기위해 저장함.
        		// 공유영역에 usrNm 값이 list.id 와 같은 결제자는 삭제
        	}
		});
		return appArray;
	}


	//부서 검색
	function openDeptTree() {
		var paramObj = {
// 			"coCd"   : $('#coCd').val(),
			"coCd"   : '',
			"userId" : $('#userId').val(),
			"useYn"  : "Y"
		};
		openSecondModal("/static/html/cmn/modal/deptSearch.html", 300, 500, "부서 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#execActDept').val(checkedNode.id.slice(0,5));
			$('#execActDeptNm').val(checkedNode.text);
		});
	}
	


    //작성자, 담당자  검색
    function openUserSearch(type) {
        if ($(currFormId + ' #imprvmStsCd').val() != "IMPRSTS01") {
            return false;
        }

        var userID = null;
        var paramObj = {};
        paramObj["coCd"] = $(currFormId + ' #coCd').val();
        paramObj["userId"] = $(currFormId + ' #imprvmId').val();
        paramObj["userNm"] = $(currFormId + ' #imprvmIdNm').val();
        paramObj["useYn"] =  "Y";
        openThirdModal("/static/html/cmn/modal/userSearch.html", 450, 650, "작성자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            userID = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);

            $(currFormId + ' #imprvmId').val(checkedNode.id);
            $(currFormId + ' #imprvmIdNm').val(checkedNode.text);
            $(currFormId + ' #imprvmDeptCd').val(checkedNode.parent.slice(0,5));
        });
    }


 	//개선제안서  출력 - report 출력
 	function reportDetail(_type = "") {
		let fileName = 'IM0101R01.jrf';
 		
 		let arg =  
 			  "#userId#"	+  jwt.userId
 		    + "#imprvmNo#"	+  imprvmNo 
 	    	+ "#";    
 		
 		if (_type == '' || _type == undefined ) {
 			callReport(fileName, arg, 1150, 720, '개선제안서 출력');
 		} else { //Export 작업
 			ubiExportAjax(fileName, arg, function(response) {
 				if (response.resultCode === 200) {
 					var base64FileData = response.base64FileData;
 					var fileName = response.exportFileName;
 					downloadPDFFromBase64(base64FileData, fileName);
 				} else {
 					alert('PDF 내보내기 실패: ' + response.resultText);
 				}

 			});
 		}
 	}


	function txtareaHeightResize(obj) {
		if (obj.val() == undefined) return false;
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;
		if(rowCount < 3)
			if (obj[0].name == 'unitNo' || obj[0].name == 'imprvmRmk') {
				obj.css('height', "40px");
			} else if (obj[0].name == 'execActTxt' ) {
				obj.css('height', "170px");
			} else {
				obj.css('height', "60px");
			}
		else
			obj.css('height', (rowCount * 21) + "px");
		
		if (obj[0].name == 'execActTxt' && obj.height() < 166) {
			obj.css('height', "170px");
		}
		if (['imprvmTxt', 'imprvmRmk'].includes(obj[0].name)) {
		    const targetId = obj[0].name === 'imprvmTxt' ? '#imprvmRmk' : '#imprvmTxt';
		    const objHeight = obj.height() < 100 ? 100 : obj.height(); // 내용의 전체 높이
		    const targetHeight = $(targetId).height();
			const maxtargetHeight = objHeight > targetHeight ? objHeight : targetHeight;

		    $(targetId).height(maxtargetHeight);
		    obj.height(maxtargetHeight);
		}
	}
    
    function checkChange(elm) {
    	elm.value = addCommaStr(gPasIntChk(elm.value));
    }

	// 월마감체크 - 워킹데이기준
	function monthCloseWorkingChk(chkValue) {
		// 하이픈 제거
		chkValue = chkValue.replaceAll("-", "");
		if (!chkValue) return false;
		
		var menuUrl = window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.lastIndexOf("."));
		
		var paramObj = {
			"coCd"       : $('#coCd').val(),
			"menuUrl"    : menuUrl,
			"actionType" : modalStack.last().paramObj.actionType,
			"chkValue"   : chkValue
		};
		
		postAjaxSync("/admin/cm/cm05/selectMonthCloseChk", paramObj, null, function(data) {
			// 서버에서 받은 sysDate는 "YYYY-MM-DD" 형태, workDay는 정수
			var sysDateObj = new Date(data.sysDate);
			var workDay = parseInt(data.workDay, 10);
			
			// 기준 날짜 : sysDate에 workDay일(음수이면 빼기)을 적용
			sysDateObj.setDate(sysDateObj.getDate() + workDay);
			
			// chkValue ("YYYYMMDD")를 Date 객체로 변환
			var chkYear  = parseInt(chkValue.substring(0, 4), 10);
			var chkMonth = parseInt(chkValue.substring(4, 6), 10) - 1;
			var chkDay   = parseInt(chkValue.substring(6, 8), 10);
			var chkDateObj = new Date(chkYear, chkMonth, chkDay);
			
			// Date 객체를 직접 비교: cutoff가 chkValue보다 늦으면 수정 불가
			if (sysDateObj.getTime() > chkDateObj.getTime()) {
				alert("마감된 일자입니다. " + dateToStr(sysDateObj) + "일 이전은 수정할 수가 없습니다.");
			}
		});
	}

</script>