<style>
.confirmField {
	justify-content: center; /* 가로 가운데 정렬 */
	align-items: center; /* 세로 가운데 정렬 */
	text-align: center; /* 텍스트 가운데 정렬 */
}

.checkbox-container input[type="checkbox"] {
	margin-left: 10px; /* 왼쪽에 10픽셀의 여백 추가 */
}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">개선 제안서 등록</h4>
	</div>

	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="userId" name="userId"> <input type="hidden" id="pgmId" name="pgmId" value="IM0101P01"> <input type="hidden" id="ordrgMngNm" name="creatNm" value="">
			<!-- 알림톡발송용 생성자명(발주담당자) -->
			<input type="hidden" id="ordrgMngTelNo" name="ordrgMngTelNo" value="">
			<!-- 알림톡발송용 생성자전화번호 -->
			<table>

				<colgroup>
					<col width="10%">
					<col width="23%">
					<col width="11%">
					<col width="23%">
					<col width="10%">
					<col width="23%">
					<col width="10%">
					<col width="23%">
				</colgroup>

				<tr class='imprArea'>
					<th class="hit">회사</th>
					<td><select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
					</select></td>
					<th>작성일자</th>
					<td><input type="text" id="imprvmDt" name="imprvmDt" readonly="readonly"></td>
					<th>작성자</th>
					<td><input type="hidden" id="imprvmId" name="imprvmId" readonly="readonly"> <input type="hidden" id="imprvmDeptCd" name="imprvmDeptCd" readonly="readonly"> <input type="text" id="imprvmIdNm" name="imprvmIdNm" readonly="readonly"></td>
					<th>제안서번호</th>
					<td><input type="text" id="imprvmNo" name="imprvmNo" readonly="readonly"></td>
				</tr>

				<tr class='imprArea'>
					<th class="hit">장비명/문서명</th>
					<td colspan="3"><textarea id="unitNo" name="unitNo" cols="100%" rows="2" required msg="장비명 및 문서명" placeholder="장비명 및  문서명 (도번 DWG)"></textarea></td>
					<th class="">SalesCode</th>
					<td>
						<div class="search_form">
							<input type='hidden' id="clntPjt" name="clntPjt"> <input type="text" id="salesCd" name="salesCd" class="form-control" msg="salesCode" readonly="readonly" placeholder="선택사항임"> <a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>

					<th>제품유형</th>
					<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" class="form-control" style="text-align: center;" readonly>
					<td colspan="1">
						<div class="search_form">
							<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtNm" class="form-control" readonly="readonly"> <a onclick="openPrdtSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>


				<tr class='imprArea'>

					<th class="hit">분류</th>
					<td colspan=3>
						<div class="checkbox-container" style="text-align: left;">
							<label><input type="checkbox" id="IMPRVMCD01" name="imprvmType" value="IMPRVMCD01" data-label="장애"> 장애 </label> <label><input type="checkbox" id="IMPRVMCD02" name="imprvmType" value="IMPRVMCD02" data-label="반복장애"> 반복장애</label> <label><input type="checkbox" id="IMPRVMCD03" name="imprvmType" value="IMPRVMCD03" data-label="품질"> 품질</label> <label><input type="checkbox" id="IMPRVMCD04" name="imprvmType" value="IMPRVMCD04" data-label="원가"> 원가</label> <label><input type="checkbox" id="IMPRVMCD05" name="imprvmType" value="IMPRVMCD05" data-label="일정"> 일정</label> <label><input type="checkbox" id="IMPRVMCD06" name="imprvmType" value="IMPRVMCD06" data-label="업무"> 업무</label> <label><input type="checkbox" id="IMPRVMCD07" name="imprvmType" value="IMPRVMCD07" data-label="아이디어"> 아이디어</label> <label><input type="checkbox" id="IMPRVMCD99" name="imprvmType" value="IMPRVMCD99" data-label="기타"> 기타</label>
						</div>
					</td>
					<th>아이템구분</th>
					<td><select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv" class="form-control" msg="아이템구분">
							<option value=""></option>
					</select></td>
					<th class="hit">진행상태</th>
					<td>
						<div>
							<select id="imprvmStsCd" name="imprvmStsCd" class="form-control" required data-kind="ISSSTS" msg="진행상태">
								<!-- 	                    <option value="">선택</option> -->
							</select>
						</div>
					</td>

				</tr>
				<tr class='imprArea'>
					<th class="hit">개선내용</th>
					<td colspan="3"><textarea id="imprvmTxt" name="imprvmTxt" cols="100%" rows="4" class="form-control" required msg="개선내용" placeholder="-작성시 ①현황 ②문제점 ③개선내용 ④기대효과 순으로 참고하여 작성요망"></textarea></td>
					<td colspan="4" rowspan="5">
						<!-- 공유대상자-->
						<div class="popup_table" id="approval_src">
							<table style="border: 0px;">
								<tr>
									<td style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold;">※ 작성부서 공유 및 결재</td>
									<td>
										<div class="add_btn_small pdl10" id="plus-minus1">
											<a onclick="insertShareUserModal1(gridViewPop1);" style="height: 30px; line-height: 28px;">+</a> <a onclick="deleteShareUser1(gridViewPop1);" style="height: 30px; line-height: 28px;">-</a>
										</div>
									</td>
								</tr>
								<tr>
									<td colspan="2">
										<div>
											<div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 140px; width: 100%;"></div>
										</div>
									</td>
								</tr>
							</table>
						</div>
					</td>
				</tr>

				<tr class='imprArea'>
					<th class="hit">실행부서</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="execActDept" name="execActDept" required msg="실행부서"> <input type="text" id="execActDeptNm" name="execActDeptNm" onkeyUp="if(window.event.keyCode == 8){execActDept.value = ''};" readonly placeholder="개선 조치 또는 실행부서를 선택하세요"> <a onclick="openDeptTree();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th class="hit">영향도</th>
					<td colspan="1">
						<div>
							<select id="impactCd" name="impactCd" data-kind="IMPACTCD" class="form-control" required msg="영향도">
								<option value="">선택(필수)</option>
							</select>
						</div>
					</td>
				</tr>


				<tr class='imprArea'>
					<th class="hit">기계분류</th>
					<td colspan="1">
						<div>
							<select id="mcPartCd" name="mcPartCd" data-kind="MCPARTCD" class="form-control" required msg="기계분류">
								<option value="">선택(필수)</option>
							</select>
						</div>
					</td>
					<th class="hit">중요도</th>
					<td colspan="1">
						<div>
							<select id="importantCd" name="importantCd" data-kind="IMPORTANTCD" class="form-control" required msg="중요도">
								<option value="">선택(필수)</option>
							</select>
						</div>
					</td>
				</tr>

				<tr class='imprArea'>
					<th>비고</th>
					<td colspan="3"><textarea type="text" id="imprvmRmk" name="imprvmRmk" cols="100%" rows="2" class="form-control" msg="비고"></textarea></td>
				</tr>

				<tr class='imprArea'>
					<th>제안팀장의견</th>
					<td colspan="3"><textarea type="text" id="imprvmReqTxt" name="imprvmReqTxt" cols="100%" rows="2" class="form-control" readonly msg="제안팀장의견" placeholder="제안팀장결재시 결재의견으로 자동 반영됨"></textarea></td>
				</tr>

				<tr>
				</tr>

				<!--         <tr> -->
				<!-- 			<th class="hit">담당부서장의견</th> -->
				<!-- 			<td colspan="5"> -->
				<!--                 <textarea id="imprvmReqTxt" name="imprvmReqTxt" cols="100%" rows="3" class="form-control"  required msg="담당부서장의견"></textarea> -->
				<!-- 			</td> -->
				<!-- 			<th>제안팀장확인</th> -->
				<!-- 			<td colspan="1"> -->
				<!-- 				<input type="hidden" id="imprvmReqId" name="imprvmReqId" required msg="제안팀장확인"> -->
				<!-- 				<input type="hidden" id="imprvmReqDttm" name="imprvmReqDttm" required msg="제안팀장확인"> -->
				<!-- 				<input type="hidden" id="imprvmReqId" name="imprvmReqId" required msg="제안팀장확인"> -->
				<!-- 				<textarea  type="text" id="imprvmReqIdTxt" name="imprvmReqIdTxt" cols="100%" rows="3"  class="form-control confirmField" msg="제안팀장확인"></textarea> -->
				<!-- 			</td> -->
				<!--         </tr> -->


				<tr>
					<th colspan="8" style='text-align: center; background-color: lemonchiffon; padding-top: 30px;'>조치(실행)부서
				</tr>
				<tr class='execArea'>
					<th>조치팀장의견</th>
					<td colspan="3"><textarea id="execActTxt" name="execActTxt" cols="100%" rows="9" class="form-control" msg="조치결과" placeholder="진행상태 완료로 변경시 입력가능합니다."></textarea></td>
					<td colspan="4" rowspan="2">
						<!-- 공유대상자-->
						<div class="popup_table" id="approval_trgt">
							<table style="border: 0px;">
								<tr>
									<td style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold;">※ 조치부서 공유 및 결재</td>
									<td>
										<div class="add_btn_small pdl10" id="plus-minus2">
											<a onclick="insertShareUserModal1(gridViewPop2);" style="height: 30px; line-height: 28px;">+</a> <a onclick="deleteShareUser1(gridViewPop2);" style="height: 30px; line-height: 28px;">-</a>
										</div>
									</td>
								</tr>
								<tr>
									<td colspan="2">
										<div>
											<div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 140px; width: 100%;"></div>
										</div>
									</td>
								</tr>
							</table>
						</div>
					</td>
				</tr>
<!-- 				<tr class='execArea'> -->
<!-- 					<th>조치팀장의견</th> -->
<!-- 					<td colspan="3"><textarea id="execTeamTxt" name="execTeamTxt" cols="100%" rows="2" class="form-control" readonly msg="조치팀장의견" placeholder="조치팀장결재시 결재의견으로 자동 반영됨"></textarea></td> -->
<!-- 				</tr> -->
				<tr>
				</tr>
				<tr>
					<th colspan="8" style='text-align: center; background-color: lemonchiffon; padding-top: 30px;'>평가 결과
				</tr>
				<tr class='evalArea'>
					<th rowspan="3">평가의견</th>
					<td rowspan="3" colspan="5"><textarea type="text" id="imprvmApprTxt" name="imprvmApprTxt" cols="100%" rows="4" class="form-control" placeholder="사장님 최종 평가 내용을 등록합니다."></textarea></td>
					<th>평가등급</th>
					<td><input type="text" id="imprvmApprGrade" name="imprvmApprGrade" class="form-control" placeholder="사장님 평가 내용입니다."></td>
				</tr>
				<tr class='evalArea'>
					<th>평가점수</th>
					<td><input type="text" id="imprvmApprPoint" name="imprvmApprPoint" class="form-control" placeholder="사장님 평가 내용입니다."></td>
				</tr>
				<tr class='evalArea'>
					<th>평가일자</th>
					<td><input type="text" id="imprvmApprDttm" name="imprvmApprDttm" class="form-control" placeholder="사장님 평가 내용입니다."></td>
				</tr>


			</table>
	</form>


	<!-- 공통 파일 영역 -->
	<div id="fileList_area" style="margin-bottom: 30px;"></div>


	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button type="button" id="actionBtn">등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
		<button type="button" id="reportBtn" onclick="reportDetail();">출력</button>
	</div>

</div>
<script type="text/javascript">

	/***********전역변수****************/
	let actionType = null;
	let currFormId = '#popForm';
	let imprvmNo = '';
    var approvalList = null;
    var hasImprApproval = false;
    var hasExecApproval = false;
	var imprvmReqId= ''	//작성자 팀장 ID정보
	var execTeamId ='' 	//조치부서팀장 ID정보
	
    var teleNo = ""; //카카오 접수자 전화번호변수
 	// 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;

	var gridViewPop1 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $(currFormId).find('[data-ax5grid="first-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 40},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 60},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 40},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 80},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 80},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: "*"},
                    {key: "todoKey",      		label: "todoKey",	align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",align: "center",   width: 130, hidden: true},
                    {key: "todoId",      		label: "todoId",	align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			var targetObj = this.target;
        			var formData = {
     	        			"fileTrgtKey" : imprvmNo,
     	        			"reqNo" 	  : imprvmNo,
     	        			"flag" 	  	  : 'Y1',
     	        			"pageNo" 	  : _pageNo + 1
     	    		}

   					postAjax("/user/im/im01/selectImprovementShareUserlst", formData, null, function(data){
   						var list = data.result;
   						targetObj.setData({
   	  						list : list,
	   	  					page : {
				                    	totalElements : list.length
						    }
   	  					});
   						//개선제안 결재  값이 'Y'인 것이 하나라도 있는지 확인
   						hasImprApproval = list.some(item => item.gb === '결재' && item.sanctnSttus === 'Y');
   						if (hasImprApproval) {
//    							alert("개선제안서 결재진행건입니다.");
	   					 	toast.push({msg: "개선제안서 결재진행건입니다", theme: 'danger'});
   						}
   						
//    						$('#imprvmStsCd').change();
//    		        		const hideButton = (hasImprApproval && $('#imprvmStsCd').val()!== 'ISSTS03') || actionType === 'I';
//    		        	    $('#actionBtn').toggle(!hideButton);
   		        	    
   						$.gridNoSet(gridViewPop1, "sanctnSn");
						gridResize(gridViewPop1, list.length); //그리드 높이 조정

   	  				});
          		},

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    }
   	  					});

					gridResize(gridViewPop1, _list.length); //그리드 높이 조정
          		}
  	}

	var gridViewPop2 = {
		initView : function() {
  			this.target = new ax5.ui.grid();
  			this.target.setConfig({
  		    	showRowSelector: true,
  		    	multipleSelect: false,
  		    	sortable: false,
  		        target: $(currFormId).find('[data-ax5grid="second-grid-modal"]'),
  		        header: {
  		        	align: "center",
  		        	selector: true
  		        },
  		        body: {
  		        	 onClick: function () {
  		                this.self.select(this.dindex);
  		            },
  		            onDBLClick: function () {
  		            },
					mergeCells : ["gb"],
  		        },
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
					}
				},
		    	columns : [
		    		{key: "gb",      			label: "구분",      	align: "center",   width: 40},
			    	{key: "sanctnSn", 			label: "순번", 		align: "center",   width: 40},
			    	{key: "coCd",      			label: "coCd",		align: "center",   width: 50, hidden: true},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    {key: "usrNm",				label: "ID",      	align: "center",   width: 130, hidden: true},
                    {key: "empNo",      		label: "사원번호", 	align: "center",   width: 130, hidden: true},
                    {key: "name",       		label: "성명",      	align: "center",   width: 60},
                    {key: "jik",       			label: "직위",      	align: "center",   width: 40},
                    {key: "creatDttm",      	label: "요청일자", 	align: "center",   width: 80},
                    {key: "todoCfDt",      		label: "확인일자",		align: "center",   width: 80},
                    {key: "todoCfOpn",      	label: "확인의견", 	align: "left",     width: "*"},
                    {key: "todoKey",      		label: "todoKey",	align: "center",   width: 130, hidden: true},
                    {key: "sanctnSttus",      	label: "sanctnSttus",align: "center",   width: 130, hidden: true},
                    {key: "todoId",      		label: "todoId",	align: "center",   width: 130, hidden: true},
                    {key: "flag",      			label: "flag",		align: "center",   width: 130, hidden: true}
    	              ]
					});
        			return this;
        		},

        		setData : function(_pageNo) {
        			var targetObj = this.target;
        			var formData = {
     	        			"fileTrgtKey" : imprvmNo,
     	        			"reqNo" 	  : imprvmNo,
     	        			"flag" 	  	  : 'Y2',
     	        			"pageNo" 	  : _pageNo + 1
     	    		}

   					postAjax("/user/im/im01/selectImprovementShareUserlst", formData, null, function(data){
   						var list = data.result;
   						targetObj.setData({
   	  						list : list,
	   	  					page : {
				                    	totalElements : list.length
						    }
   	  					});

   						//조치결과 결재 값이 'Y'인 것이 하나라도 있는지 확인
   						hasExecApproval = list.some(item => item.gb === '결재' && item.sanctnSttus === 'Y');
   					    if (hasExecApproval) {
//    					    	alert("조치결과 결재완료건입니다.");
	   					 	toast.push({msg: "조치결과 결재완료건입니다.", theme: 'danger'});
   					    }

//    		        		const hideButton = hasExecApproval || actionType === 'I';
//    		        	    $('#actionBtn').toggle(!hideButton);

   						$('#imprvmStsCd').change();
   						$.gridNoSet(gridViewPop2, "sanctnSn");
						gridResize(gridViewPop2, list.length); //그리드 높이 조정
   	  				});
          		},

        		setData2 : function(_list) {
        			this.target.setData({
   	  						list : _list,
	   	  					page : {
				                    	totalElements :  _list.length,
						    }
   	  					});

					gridResize(gridViewPop2, _list.length); //그리드 높이 조정
          		}
  	}

	$(document).ready(function() {
		toast.init();
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		actionType = modalStack.last().paramObj.actionType;
		imprvmNo = modalStack.last().paramObj.imprvmNo;
		$(currFormId + ' #userId').val(jwt.userId);
		$(currFormId + ' #imprvmId').val(jwt.userId);
		$(currFormId + ' #imprvmIdNm').val(jwt.userNm);
		$(currFormId + ' #imprvmDeptCd').val(jwt.deptId);
		$(currFormId + ' #imprvmNo').val('신규');
		
		//처리일자//
		$(currFormId + ' #imprvmDt').val(new Date().format('yyyy-MM-dd'));

		//결재자정보 그리드
		gridViewPop1.initView();
		gridViewPop2.initView();

		if (actionType == "C") {
			$("#actionBtn").text("등록");
			
			$('#actionBtn').on("click", function() {
				insertImprovement();
			});
			$('#reportBtn').hide();
			$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		} else if (actionType == "U") {
			$('.tit').text('개선 제안서 수정')
			selectImprovement(imprvmNo);
			
			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateImprovement();
			});
			$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		}

		$('.evalArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		$('#imprvmStsCd').css({'background-color':'', 'pointer-events':'auto'});
		

		//진행상태가 완료일 경우 투입공수, 투입비용, 조치내용은 필수 입력임  actAmtSts actDng
		$('#imprvmStsCd').change(function () {
			if ($("#imprvmStsCd").val() == 'ISSSTS03') {
				$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
				$('.execArea').css({'background-color':'', 'pointer-events':'auto'});
				$('#actionBtn').toggle(!hasExecApproval);
        		if (hasExecApproval) {	//조치결과에 결재 진행이면 수정 불가능함
    				$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	        		$('.imprArea th').removeClass('hit');
        			$("#execActTxt").closest('td').prev('th').removeClass("hit");
	        		$('#execActTxt').attr('required', 'false');
					$("#imprvmStsCd").closest('td').prev('th').removeClass("hit");
	        		$('#imprvmStsCd').attr('required', 'false');
        		} else {
    				$('#imprvmStsCd').css({'background-color':'', 'pointer-events':'auto'});
    				$('.execArea').css({'background-color':'', 'pointer-events':'auto'});
					$("#execActTxt").closest('td').prev('th').addClass("hit");
	        		$('#execActTxt').attr('required', 'true');
	
	        		$('.imprArea th').removeClass('hit');
					$("#imprvmStsCd").closest('td').prev('th').addClass("hit");

	        	    
        		}

        	} else {
        	    $('#actionBtn').toggle(!hasImprApproval);
				$('.execArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
        		$('#execActTxt').closest('td').prev('th').removeClass('hit');
        		$('#execActTxt').removeAttr('required', 'true');
        		if (hasImprApproval) {	//개선제안 결재 진행이면 수정 불가능함
    				$('.imprArea').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	        		$('.imprArea th').removeClass('hit');
					$("#imprvmStsCd").closest('td').prev('th').addClass("hit");
//     				$('#imprvmStsCd').css({'background-color':'', 'pointer-events':'auto'});
        		} else {
    				$('.imprArea').css({'background-color':'', 'pointer-events':'auto'});
	        		$('.imprArea th').addClass('hit');
					$("#salesCd").closest('td').prev('th').removeClass("hit");
					$("#prdtCd").closest('td').prev('th').removeClass("hit");
					$("#itemDiv").closest('td').prev('th').removeClass("hit");
					$("#imprvmRmk").closest('td').prev('th').removeClass("hit");
        		}
        	}
		});
// 		$('.imprArea, .execArea').on('click', function() {
// 			if ($(this)[0].className == 'imprArea') {
//                 event.preventDefault(); // 기본 클릭 동작 방지
//                 event.stopPropagation(); // 상위 요소로의 전파 방지
// 				if (hasImprApproval) alert('수정 불가 (개선제안서 결재 진행중입니다.)');
// 			}
// 			if ($(this)[0].className == 'execArea') {
//                 event.preventDefault(); // 기본 클릭 동작 방지
//                 event.stopPropagation(); // 상위 요소로의 전파 방지
// 				if (hasExecApproval) alert('수정 불가 (조치결과 결재 진행중입니다.)');
// 			}
//         });
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $(currFormId + ' #pgmId').val(),
				fileTrgtKey	: modalStack.last().paramObj.imprvmNo,
	            todoNo		: imprvmNo,		//결재정보처리를 위함
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		// 크기 조절할 textarea ID 리스트
		$('#unitNo, #imprvmTxt, #imprvmRmk, #imprvmReqTxt, #execActTxt, #execTeamTxt, #imprvmApprTxt').keydown(function () {
			// 각 textarea에 대해 크기 조절 함수 호출
			    txtareaHeightResize($(this));
		});
		
		authChk();						// 권한체크

	});

	function selectImprovement(_imprvmNo) {
		var formData = {
			"imprvmNo" 		: _imprvmNo,
		}
		postAjax("/user/im/im01/selectImprovement", formData, null, function(data) {
			if (data.result == undefined) {
				alert('자료가 존재하지 않습니다. 확인 바랍니다.' + _imprvmNo);
				return false;
			}
			if (actionType == "C") {
				data.result.imprvmNo = '';
				delete data.result.creatId;
				delete data.result.creatNm;
				delete data.result.creatPgm;
				delete data.result.creatDttm;
				delete data.result.udtId;
				delete data.result.udtNm;
				delete data.result.udtPgm;
				delete data.result.udtDttm;

			}
			$.each(data.result, function(key, value) {
				if ($(currFormId + ' #' + key)[0]) {
					$(currFormId + ' #' + key).val(value);
					if ($(currFormId + ' #' + key).is('[comma]')) {
						onlyNumber($(currFormId + ' #' + key)[0]);
					}
				}
			});
			
			let tmpReqInfo = data.result.imprvmReqDttm == undefined ? '' : `${data.result.imprvmReqIdNm}\n${data.result.imprvmReqDttm}`;
			let tmpExecInfo = data.result.execTeamDttm == undefined ? '' : `${data.result.execTeamIdNm}\n${data.result.execTeamDttm}`;
			$(currFormId + ' #imprvmReqIdTxt').val(tmpReqInfo);	//작성부서장명+ 확인일시
			$(currFormId + ' #execTeamIdTxt').val(tmpExecInfo);		//조치부서장명+ 확인일시

	        // 분류항목 각 체크박스별로 체크하기 (저장시 콤마로 합쳐서 저장되어 있음))
			const idsArray = data.result.imprvmType.split(',').map(id => id.trim()); // 체크할 체크박스 ID 목록을  쉼표로 분리하여 배열로 변환
			idsArray.forEach(function(id) {
                $('#' + id).prop('checked', true); // 체크박스 체크
            });

			gridViewPop1.setData();
			gridViewPop2.setData();

			// 크기 조절할 textarea ID 리스트
			const textAreas = [
			    '#unitNo',   // 장비명
			    '#imprvmTxt',  // 개선내용
			    '#imprvmRmk',  // 비고
			    '#imprvmReqTxt',  // 제안팀장의견
			    '#execActTxt', // 조치결과
			    '#execTeamTxt', // 조치팀장결과
			    '#imprvmApprTxt' // 평가결과
			];
			// 각 textarea에 대해 크기 조절 함수 호출
			textAreas.forEach(textAreaId => {
			    txtareaHeightResize($(textAreaId));
			});
				//마감체크
// 				monthCloseChk($('#ctrtDt').val(), '', $('#coCd').val());
		});
	}



	 // 등록
	function insertImprovement() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			if($("input[name='imprvmType']:checked").val() == undefined){
	            alert("분류 항목을 체크하세요");
	            return false;
	        }
			var formData = makeFormData();
			if (formData) {
				filePostAjax("/user/im/im01/insertImprovement", formData,
					function(data) {
						if (data.resultCode == 200) {
							$('#imprvmNo').val(data.imprvmNo);
							alert(data.resultMessage);
// 							kakaoTodo();
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
			}
		}
	}

	// 수정
	function updateImprovement() {
		if (inputValidation($('.popup_area [required]'))) {
			if($("input[name='imprvmType']:checked").val() == undefined){
	            alert("분류 항목을 체크하세요");
	            return false;
	        }
			var formData = makeFormData();	
			if (formData) {
	      		filePostAjax("/user/im/im01/updateImprovement", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
// 							kakaoTodo();
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
			}
		}
	}

	//----------------------------------------------//
	
	function makeFormData() {
		// 폼데이터 생성
		var formData = new FormData($(currFormId)[0]);
		
		//품목정보를 comma로 구분하여 저장
        let tempValues = [];
        $('input[name="imprvmType"]:checked').each(function() {
        	tempValues.push($(this).val());
        });
        formData.set("imprvmType", tempValues.join(', '));


		/*	결재그리드 insert make start */
	    //개선제안시 작성자 팀장, 조치부서 팀장 정보 자동 등록하기
    	selectTeamManagerApprovalAdd();

    	// 개선 제안서 결재그리드 처리
    	const imprApprovalArr = processApprovalGrid(gridViewPop1, "approvalArr", modalStack.last().paramObj, currFormId, modalStack);
    	formData.append("imprApprovalArr", JSON.stringify(imprApprovalArr));
    	
    	// 개선 조치결과 결재그리드 처리
    	const execApprovalArr = processApprovalGrid(gridViewPop2, "execApprovalArr", modalStack.last().paramObj, currFormId, modalStack);
    	formData.append("execApprovalArr", JSON.stringify(execApprovalArr));
    	
    	formData.append("imprvmReqId", imprvmReqId);	//작성자 팀장 ID정보
    	formData.append("execTeamId", execTeamId);		//조치부서팀장 ID정보
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", '');			//첨부화일용
		formData.append("prdtCd", $(currFormId + ' #prdtCd').val());			//첨부화일용
		formData.append("itemCd", $(currFormId + ' #itemCd').val());			//첨부화일용
		formData.append("prjctCd", '');		//첨부화일용
		
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	function processApprovalGrid(gridView, formDataKey, paramObj, currFormId, modalStack) {
	    const rowSharngList = gridView.target.list;
	    const ParamObj = { ...paramObj };
	    ParamObj.rsltNo = $(`${currFormId} #imprvmNo`).val();
	    ParamObj.actionType = 'U'; // 결재모드는 수정으로 접근하기 위함

	    if (rowSharngList.length > 0) {
	        const approvalArr = [];

	        // 공통 파라미터 설정
	        const addParam = {
	            coCd: $(`${currFormId} #coCd`).val(),
	            salesCd: $(`${currFormId} #salesCd`).val(),
	            pgmId: $(`${currFormId} #pgmId`).val(),
	            pgPath: "/user/im/im01/iM0101P01.html",
	            sanctnSttus: "N",
	            todoCoCd: $(`${currFormId} #coCd`).val(),
	            todoNo: $(`${currFormId} #imprvmNo`).val(),
	            todoFileTrgtKey: modalStack.last().paramObj.imprvmNo,
	            pgParam: JSON.stringify(ParamObj),
	            userId: jwt.userId,
	            todoTitl: `${$(`${currFormId} #unitNo`).val()} 개선 제안서`,
	            todoKey: "",
	            todoCodeKind: "",
	            todoCodeId: "",
	        };

	        let 결재순번 = 0;
	        let 공유순번 = 0;

	        $.each(rowSharngList, function (idx, elem) {
	            if (!elem.usrNm.includes('gyrsult')) {
	                const approvalListObj = { ...elem };

	                addParam["todoId"] = elem.usrNm;
	                addParam["empNo"] = elem.empNo;
	                addParam["name"] = elem.name;
	                addParam["telNo"] = elem.telNo;
	                addParam["email"] = elem.eMail;
	                addParam["gb"] = elem.gb;

	                if (elem.gb === '공유') {
	                                   공유순번 += 1;
	                    approvalListObj["sanctnSn"] = 공유순번;
	                    approvalListObj["todoDiv1CodeId"] = "TODODIV10";
	                    approvalListObj["todoDiv2CodeId"] = formDataKey === "approvalArr" ? "TODODIV1150" : "TODODIV1160";
	                } else if (elem.gb === '결재') {
	                                   결재순번 += 1;
	                    approvalListObj["sanctnSn"] = 결재순번;
	                    approvalListObj["todoDiv1CodeId"] = "TODODIV20";
	                    approvalListObj["todoDiv2CodeId"] = formDataKey === "approvalArr" ? "TODODIV2150" : "TODODIV2160";
	                }

	                approvalArr.push({ ...addParam, ...approvalListObj });
	            }
	        });

	        return approvalArr;
	    }
	}


	// 공유대상자 추가//
    function insertShareUserModal1(_grid) {

    	if( approvalYn(_grid) ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

        var paramObj = {};
        var appshaList = _grid.target.list;
        paramObj["coCd"] = $(currFormId + ' #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $(currFormId + ' #imprvmId').val();
        paramObj["userNm"] =  $(currFormId + ' #imprvmIdNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
        		}).map(function(item) {
	        		  	return {
	        			    gb: "결재",
	        			    id: item.usrNm,
	        			    text: item.name,
	        			    parent: item.jik,
	        			    deptNm: item.dtNm,
	        			    telNo: item.telNo,
	        			    offTelNo: item.offTelNo,
	        			    email: item.email,
	        			    todoId: item.usrNm,
	        			};
        		});
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
        		}).map(function(item) {
				  		return {
						    gb: "공유",
						    id: item.usrNm,
						    text: item.name,
						    parent: item.jik,
						    deptNm: item.dtNm,
						    telNo: item.telNo,
						    offTelNo: item.offTelNo,
						    email: item.email,
						    todoId: item.usrNm,
						};
				});

        openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//     		console.log('결재라인 : ', approvalGrid.target.list);
//     		console.log('공유라인 : ', shareGrid.target.list);

    		var appArray = approvalGrid.target.list.map(function(item) {
    			  return {
    				  	gb: "결재",
    				  	usrNm: item.id,
    				  	name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
						todoId: item.id,
					};
			});
    		var shaArray = shareGrid.target.list.map(function(item) {
  			  return {
	  				  	gb: "공유",
						usrNm: item.id,
						name: item.text,
						jik: item.parent,
						dtNm: item.deptNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email,
	                    todoId: item.id,
					};
			});
    		_grid.setData2(appArray.concat(shaArray));
			$.gridNoSet(_grid, "sanctnSn");
    		gridResize(_grid, _grid.target.list.length); //그리드 높이 조정
    		
//     		approvalGrid.id //userId
//     		approvalGrid.text //성명
//     		approvalGrid.parent //직책
//     		approvalGrid.deptNm //부서
//     		approvalGrid.telNo
//     		approvalGrid.offTelNo
//     		approvalGrid.email

//     		shareGrid.id //userId
//     		shareGrid.text //성명
//     		shareGrid.parent //직책
//     		shareGrid.deptNm //부서
//     		shareGrid.telNo
//     		shareGrid.offTelNo
//     		shareGrid.email
        });

    }



	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
// 		console.log('---gridNoset run ---');
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}

    function deleteShareUser1(_grid){
    	if( approvalYn(_grid) ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

    	var selRow = parseInt(_grid.target.selectedDataIndexs);
	 		if( isNaN(selRow) ) {
	 			alert("선택된 행이 없습니다.");
	 			return;
	 		} else {
	 				if( selRow > -1 ) {
	 					//gridViewPop.target.removeRow(selRow);
	 					var todoKey = _grid.target.getList()[selRow].todoKey;
					if( typeof(todoKey) == "undefined" ) {
						_grid.target.removeRow(selRow);
						$.gridNoSet(_grid, "sanctnSn");
					} else {
						var gridList = _grid.target.getList("selected")[0];
						var paramObj = {
								todoKey			: gridList.todoKey,
								todoNo			: $(currFormId + ' #rsltNo').val(),
								sanctnSn		: gridList.sanctnSn,
								todoDiv1CodeId	: gridList.todoDiv1CodeId,
								todoDiv2CodeId	: gridList.todoDiv2CodeId,
						}
		 		        if(paramObj.todoKey && paramObj.sanctnSn && paramObj.todoDiv1CodeId && paramObj.todoDiv2CodeId ) {
	 	 						deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
	 	 							if (data.resultCode == 200) {
	 	 								_grid.setData(0);

	 	 								$.gridNoSet(_grid, "sanctnSn");
	 	 					    		gridResize(_grid, _grid.target.list.length); //그리드 높이 조정
	 	 							} else {
	 	 								alert("삭제중 오류가 발생했습니다");
	 	 							}
	 	 						});
		 		        } else {
		 		        	alert("삭제중 오류가 발생했습니다.")
		 		        }
					}
	 			}
	 		}
    }



    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $(currFormId + ' #coCd').val(),
           "salesCd": $(currFormId + ' #salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $(currFormId + ' #salesCd').val(row.salesCd);
            $(currFormId + ' #clntPjtCd').val(row.clntPjt);
//             $('#eqpNm').val(row.eqNm);
//             $('#vendCd').val(row.ordrsClntCd);
//             $('#vendNm').val(row.ordrsClntNm);
//             $('#eqpNm').val(row.eqpNm);
            $(currFormId + ' #prdtCd').val(row.prdtCd);
			$(currFormId + ' #prdtCdNm').val(row.prdtCdNm);
            $(currFormId + ' #itemDiv').val(row.itemDiv);
            $(currFormId + ' #itemDivNm').val(row.itemDivNm);
        });
    }
    		

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $(currFormId + ' #coCd').val(),
			"userId": $(currFormId + ' #mngId').val(),
			"userNm": $(currFormId + '#mngIdNm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			let checkedId = tree.get_checked()[0];
			let checkedNode = tree.get_node(checkedId);
			$(currFormId + ' #mngId').val(checkedNode.id);
			$(currFormId + ' #mngIdNm').val(checkedNode.text);
		});
	}
	
		
	function setByCoCd(value) {
		$(currFormId + ' #coCd option:not([value="'+value+'"])').remove();
	}

    
	function gridResize(gridObj, size) {
		    size = size < 1 ? 1 : size;
	        var tagHeight = (size) * 28 + 60 ;
	        tagHeight = tagHeight > 750 ? 750 : tagHeight;
	        tagHeight = tagHeight < 140 ? 140 : tagHeight;

	        gridObj.target.setHeight(tagHeight);
	}


	//결재 여부
	function approvalYn(_grid) {
		var gridList = _grid.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
        	var msgArr = [];
	        $.each(gridList, function (idx, elem) {
	        	//결재자가 본인이 아니면서 상태가 Y인 경우
	        	if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
	        })
		}
		return inCnt;
	}

	
	function selectApprovalCheck(value) {
		var formData = {
				"reqNo" : value
		}
		postAjaxSync("/user/qm/qm01/selectApprovalChk", formData, null, function(data) {//결재가 진행이 되었는지 안되었는지 DB체크
			var list = data.result[0]
		    if (list == 'Y'){//결재가 한개라도 진행이 되었으면 알림창

		        //input readonly, radio.checkbox disabled
// 				$.each($('#popForm2 select, input, textarea'), function(idx, elem){
// 					var id = $(elem).attr("ID");
// 					if( id ) {
// 						var eleId = "#popForm2 #"+id;
// 						if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
// 						if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
// 						if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 						if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).prop("disabled", true);
// 					}

// 				});

// 				$("#resDt").prop("disabled", true);
// 		    	$("#actionBtn").hide();
// 		        $("#plus-minus").hide();
		    }
		});
	}


	/*
	#	TODO 알림톡발송 시작
	#
	*/
// 	$("#approvalReqTodoBtn").on("click", function () {
// 		kakaoTodo();
// 	});

	var kakaoErr = [];

	function kakaoTodo() {
        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	              "userId" 	 : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });
        }

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
	     var paramObj1 = {
	             "coCd" 	: $(currFormId + ' #coCd').val(),
	             "userId" 	: $(currFormId + ' #imprvmId').val()
	         };
	      postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
	          if (data.result[0] == undefined
	               || data.result[0].telNo == "") {
	        	  teleNo = "051-312-2400";
	          }
	          else {
	        	  teleNo = data.result[0].telNo;

	          }
	      });
	     //---------------------------------------

		let param = {
				"tmplatDiv": "TMPLATDIV02"
				, "coCd": $(currFormId + ' #coCd').val()				//해당업무의 coCd(트르넷발주 TRN )
				, "todoDiv1CodeId": "TODODIV20"					//공통코드 해당업무 - 결재
				, "todoDiv2CodeId": "TODODIV2150"					//공통코드 해당업무 - 결재 - 발주서
				, "todoDiv1CodeNm": "결재"						//공통코드 해당업무 - 결재 - 발주서
				//, "todoDiv2CodeNm": "발주 및 출장 요청"						//공통코드 해당업무 - 결재 - 발주서
				, "title": "개선 제안서"
				, "sanctnDiv2": "결재"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
				, "todoNo": $(currFormId + ' #imprvmNo').val()
				, "clntCd": "1"					//발신회사는 로그인사용자 회사
				, "clntNm": clntNm				//로그의 수신거래처명
				, "ordrgMngNm": $(currFormId + ' #imprvmId').val()			//발주작성자(담당자)
				, "ordrgMngTelNo": teleNo		//담당자전화번호
				, "creatPgm"  : 'IM0101P01'
		}
		commKaKaoSendTodo(param);

		//공유
		let param2 = {
				"tmplatDiv": "TMPLATDIV02"
					, "coCd":  $(currFormId + ' #coCd').val()				//				//해당업무의 coCd(트르넷발주 TRN )
					, "todoDiv1CodeId": "TODODIV10"					//공통코드 해당업무 - 결재
					, "todoDiv2CodeId": "TODODIV1150"					//공통코드 해당업무 - 결재 - 발주서
					, "todoDiv1CodeNm": "공유"						//공통코드 해당업무 - 결재 - 발주서
					, "title": "개선 제안서"
					, "sanctnDiv2": "공유"							//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
					, "todoNo": $(currFormId + ' #imprvmNo').val()
					, "clntCd": "1"					//발신회사는 로그인사용자 회사
					, "clntNm": clntNm				//로그의 수신거래처명
					, "ordrgMngNm": $(currFormId + ' #imprvmId').val()			//발주작성자(담당자)
					, "ordrgMngTelNo": teleNo		//담당자전화번호
					, "creatPgm"  : 'IM0101P01'
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
	    	kakaoCnt = 0;
// 	    	alert("알림톡이 정상 발송되었습니다.");
	    }
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
// 		console.log('---카카오 발주및출장결과서 알림톡발송시작 --' + param);

		//알림톡수신번호 채번
		var maxMessageId = null;			//message id(unique key)
		var talkMessage = null 				//발송될 내용 template
		var mobile = null					//수신인 휴대전화번호
		//var title = null					//todo title
		var todoDiv2CodeNm = null					//todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null
					, function(data) {
						if(data.resultList.length > 0 ) {
							if( data.resultList[0].maxMessageId != "" ) {
								sendList = data.resultList;
							} else {
								alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
								return;
							}

						}
		});
		//user search ajax end

		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			//로그용
			param.rcvId = sendObj.todoId;			//todo 수신id
			param.rcvNm = sendObj.name;				//todo 수신자명
			param.nameTo = sendObj.name;				//todo 수신자명
			//title		= sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = todoDiv2CodeNm;
			//param.title = title;								//요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}
			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";				//서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.title = param.title;					//알림톡 타이틀 -
			talkBody.message = message;				//알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;				//휴대전화번호
			talkBody.template = "10003";			//템플릿관리화면 템플릿ID	- 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end
		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}



	//제품코드 검색
	function openPrdtSearch(){
		var paramObj = {
				"coCd"	: $(currFormId + ' #coCd').val(),
				"prdtCd": $(currFormId + ' #prdtCd').val(),
				"prdtNm": $(currFormId + ' #prdtCdNm').val(),
				"useYn" : "Y"
		}
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$(currFormId + ' #prdtCd').val(row.prdtCd);
			$(currFormId + ' #prdtCdNm').val(row.prdtNm);
		});
	}


    //개선제안서 작성자 팀장 및 조치 부서 팀장 정보 가져오기
	function selectTeamManagerApprovalAdd() {
    	//------------------------------------------------
    	//개선제안서 등록시 결재자 정보를 메모리에 가져오기  start
    	//결재자 정보와 공유자 정보를 분리하고 개선제안 작성자, 조치부서 팀장추가 및 조치부서 팀장이 공유에 있으면 제외 처리함.
    	//------------------------------------------------
    	let appshaList = gridViewPop1.target.getList();

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보

        appshaList.forEach(item => (item.gb === "결재" ? appArray : shaArray).push(item));

		//작성자의 팀장 정보 가져와서  결제자에  추가
		appArray = approvalTeamManagerInfoData( $(currFormId + ' #imprvmId').val(), appArray, shaArray);
		gridViewPop1.setData2(appArray.concat(shaArray));

		$.gridNoSet(gridViewPop1, "sanctnSn");
		//------------------------------------------------
		//개선제안서 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------
		
		
		//조치담당부서 결재자 처리
    	let appshaList2 = gridViewPop2.target.getList();

		var appArray2 = [];	//결재권자 정보
		var shaArray2 = [];	//공유자 정보

        appshaList2.forEach(item => (item.gb === "결재" ? appArray2 : shaArray2).push(item));
		//조치부서 팀장정보가져와서 결제자에 추가
		appArray2 = selectDept2TeamManagerInfo( $(currFormId + ' #execActDept').val(), appArray2, shaArray2);
		//조치부서가 기술연구소이면 정상훈 공유자로 자동 추가함
		if ($(currFormId + ' #execActDept').val() == 'GUN40') {
			appArray2 = approvalUserInfoData('shjung', appArray2, shaArray2);
		}
		
		gridViewPop2.setData2(appArray2.concat(shaArray2));

		$.gridNoSet(gridViewPop2, "sanctnSn");
		//------------------------------------------------
		//개선조치부서 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------
	}

    //조치담당자정보 자동 추가하기
	function approvalUserInfoData (appUserId, appArray, shaArray) {
	    var formData = {
	        "userId" : appUserId,
	    }
	    postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
	    	if (data.resultList != '' && data.resultList!=null) {
	    		//조치결과 결자자 정보 가져오기
	    		let list = data.resultList[0];
	    		if (appArray.some(item => item.usrNm === list.usrNm)) {
	    			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
	    		} else {
	    			appArray.push({
		                        gb: "공유",
		                        usrNm: list.usrNm,
		                        name: list.name,
		                        jik: list.jik,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                    });
	    		}

        		// 공유영역에 usrNm 값이 list.id 와 같은 결제자는 삭제
        		shaArray = shaArray.filter(item => item.usrNm !== list.id);
	    	}
		});
		return appArray;
	}

	

    //작성자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray, shaArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        		imprvmReqId = list.id;	//작성자 팀장 ID정보 백엔드로 보내기위해 저장함.
        		// 공유영역에 usrNm 값이 list.id 와 같은 결제자는 삭제
        		shaArray = shaArray.filter(item => item.usrNm !== list.id);
        	}
		});
		return appArray;
	}
	

    //부서코드로 팀장 정보 가져오기
	function selectDept2TeamManagerInfo(deptId, appArray, shaArray) {
	    var formData = {
		        "deptId" : deptId,
		}
        postAjaxSync("/user/wb/wb24/selectDept2TeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}

        		execTeamId = list.id;	//조치부서 팀장 ID정보 백엔드로 보내기위해 저장함.
        		// 공유영역에 usrNm 값이 list.id 와 같은 결제자는 삭제
        		shaArray = shaArray.filter(item => item.usrNm !== list.id);
        	}
		});
		return appArray;
	}


	//부서 검색
	function openDeptTree() {
		var paramObj = {
			"coCd"   : $('#coCd').val(),
			"userId" : $('#userId').val(),
			"useYn"  : "Y"
		};
		openSecondModal("/static/html/cmn/modal/deptSearch.html", 300, 500, "부서 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#execActDept').val(checkedNode.id.slice(0,5));
			$('#execActDeptNm').val(checkedNode.text);
		});
	}
	



 	//개선제안서  출력 - report 출력
 	function reportDetail(_type = "") {
		let fileName = 'IM0101R01.jrf';
 		
 		let arg =  
 			  "#userId#"	+  jwt.userId
 		    + "#imprvmNo#"	+  imprvmNo 
 	    	+ "#";    
 		
 		if (_type == '' || _type == undefined ) {
 			callReport(fileName, arg, 1150, 720, '개선제안서 출력');
 		} else { //Export 작업
 			ubiExportAjax(fileName, arg, function(response) {
 				if (response.resultCode === 200) {
 					var base64FileData = response.base64FileData;
 					var fileName = response.exportFileName;
 					downloadPDFFromBase64(base64FileData, fileName);
 				} else {
 					alert('PDF 내보내기 실패: ' + response.resultText);
 				}

 			});
 		}
 	}


	function txtareaHeightResize(obj) {
		if (obj.val() == undefined) return false;
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;
		if(rowCount < 3)
			if (obj[0].name == 'unitNo' || obj[0].name == 'imprvmRmk') {
				obj.css('height', "40px");
			} else if (obj[0].name == 'execActTxt' ) {
				obj.css('height', "170px");
			} else {
				obj.css('height', "60px");
			}
		else
			obj.css('height', (rowCount * 20) + "px");
	}
</script>