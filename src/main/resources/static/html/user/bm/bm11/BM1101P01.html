<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">구매단가 등록</h4>
	</div>
	
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
			<input type="hidden" id="userId"      name="userId">
			<input type="hidden" id="pgmId"       name="pgmId" value="BM1101P01">
			<table>
				<colgroup>
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th class="hit coCd">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control input-sm" required msg="회사"></select>
					</td>

					<th class="hit clntCd">구매업체</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd" required msg="구매업체">
						<div class="search_form">
							<input type="text" id="clntNm" name="clntNm"
								onkeyup="event.keyCode == 8 ? clntCd.value = '' : event.keyCode == 13 ? ClntSearch($('#clntNm').val()) : ''">
							<a onclick="ClntSearch($('#clntNm').val());"><i class="i_search_w"></i></a>
						</div>
					</td>

					<th class="hit uprDiv">단가구분</th>
					<td>
						<select id="uprDiv" name="uprDiv" data-kind="UPRDIV" class="form-control input-sm" required msg="단가구분"></select>
					</td>

					<th class="hit adptDt">적용일자</th>
					<td>
						<input id="adptDt" name="adptDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
				</tr>
				
				<!-- 2행 -->
				<tr>
					<th class="hit matrCd">품번</th>
					<td>
						<div class="search_form">
							<input type="text" id="matrCd" name="matrCd" required msg="품번" onkeyup="event.keyCode == 13 ? MatListSearch('P') : ''">
							<a onclick="MatListSearch('P');"><i class="i_search_w"></i></a>
						</div>
					</td>
					
					<th>품명</th>
					<td colspan="3">
						<input type="text" id="matrNm" name="matrNm" readonly="readonly">
					</td>

					<th>규격</th>
					<td>
						<input type="text" id="matrSpec" name="matrSpec" readonly="readonly">
					</td>
				</tr>
				
				<!-- 3행 -->
				<tr>
					<th>소재</th>
					<td>
						<input type="text" id="matrMat" name="matrMat" readonly="readonly">
					</td>

					<th>Maker</th>
					<td>
						<input type="text" id="matrMakrNm" name="matrMakrNm" readonly="readonly">
					</td>

					<th>형번</th>
					<td>
						<input type="text" id="matrMno" name="matrMno" readonly="readonly">
					</td>

					<th>품목구분</th>
					<td>
						<input type="hidden" id="goodsDiv" name="goodsDiv" readonly="readonly">
						<input type="text" id="goodsDivNm" name="goodsDivNm" readonly="readonly">
					</td>
				</tr>
				
				<!-- 4행 -->
				<tr>
					<th>거래처구분</th>
					<td>
						<input type="hidden" id="matrClntDiv" name="matrClntDiv" readonly="readonly">
						<input type="text" id="matrClntDivNm" name="matrClntDivNm" readonly="readonly">
					</td>

					<th>자재유형</th>
					<td>
						<input type="hidden" id="matrDiv" name="matrDiv" readonly="readonly">
						<input type="text" id="matrDivNm" name="matrDivNm" readonly="readonly">
					</td>

					<th>자재그룹</th>
					<td>
						<input type="hidden" id="matrGrp" name="matrGrp" readonly="readonly">
						<input type="text" id="matrGrpNm" name="matrGrpNm" readonly="readonly">
					</td>

					<th>단위</th>
					<td>
						<input type="hidden" id="matrUnit" name="matrUnit" readonly="readonly">
						<input type="text" id="matrUnitNm" name="matrUnitNm" readonly="readonly">
					</td>
				</tr>
				
				<!-- 5행 -->
				<tr>
					<th>구매/외주</th>
					<td>
						<input type="hidden" id="matrPurcDiv" name="matrPurcDiv" readonly="readonly">
						<input type="text" id="matrPurcDivNm" name="matrPurcDivNm" readonly="readonly">
					</td>
					
					<th class="hit currCd">통화단위</th>
					<td>
						<select id="currCd" name="currCd" data-kind="CURR" class="form-control input-sm" required msg="통화단위"></select>
					</td>

					<th class="hit matrUpr">구매단가</th>
					<td>
						<input type="text" id="matrUpr" name="matrUpr" class="form-control" required msg="구매단가" comma onkeyup="onlyPositive(this);" >
					</td>

					<th class="">공제단가</th>
					<td>
						<input type="text" id="deductUpr" name="deductUpr" class="form-control" comma onkeyup="onlyPositive(this);" >
					</td>
				</tr>

				<!-- 6행 -->
				<tr>
					<th class="hit outWhCd">사용여부</th>
					<td>
						<select id="useYn" name="useYn" data-kind="YN" class="form-control input-sm" required msg="사용여부">
						</select>
					</td>

					<!-- 빈값추가 -->
					<th></th>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
				</tr>

				<!-- 7행 -->
				<tr>
					<th class="">비고</th>
					<td colspan="7">
						<textarea class="form-control" id="matrUprRmk" name="matrUprRmk" style="height: 60px;" maxlength="500"></textarea>
					</td>
				</tr>

			</table>
		</div>
	</form>
	
	<!-- 콘텐츠 -->
	<div class="contents">
		<!-- 리스트 -->
		<div class="ax5_grid">
			<div>
				<div data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height:300px; width: 100%" ></div>
			</div>
		</div>
	</div>
	
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
</div>

<!-- 하단 버튼 -->
<div class ="popup_bottom_btn">
	<button type="button" id="actionBtn" authChk>등록</button>
	<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
</div>

<script type="text/javascript">
	ax5.ui.grid.formatter["useYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E"){
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};
	
	var actionType  = null;
	var fileTrgtKey = null;
	var detailArr   = []; // 상세 그리드내용

	var ModalgridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber : true,
				// 체크박스
				//showRowSelector: true,
				multipleSelect : false,
				sortable       : true,
				target : $('[data-ax5grid="first-grid-modal"]'),
				header : {
					align   : "center",
					selector: false
				},
				
				body : {
					mergeCells : ["uprDivNm", "currNm"],
					onClick: function () {
						this.self.select(this.dindex);
					},
				},
				
				page : {
					navigationItemCount: 10,
					height: 30,
					display: true,
					firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange: function () {
						ModalgridView.setData(this.page.selectPage);
					}
				},
				
				columns : [
					{key: "uprDiv"       , label: "단가구분"   , align: "center", width: 70 , hidden: true},
					{key: "uprDivNm"     , label: "단가구분"   , align: "center", width: 70 , hidden: false},
					{key: "currCd"       , label: "통화단위"   , align: "center", width: 70 , hidden: true},
					{key: "currNm"       , label: "통화단위"   , align: "center", width: 70 , hidden: false},
					{key: "adptDt"       , label: "적용일자"   , align: "center", width: 90, hidden: false},
					{key: "useYn"        , label: "사용"      , align: "center", width: 50 , hidden: false, formatter: "useYn"},
					{key: "matrUpr"      , label: "구매단가"   , align: "right" , width: 80 , hidden: false, formatter: "money"},
					{key: "deductUpr"    , label: "공제단가"   , align: "right" , width: 80 , hidden: false, formatter: "money"},
					{key: "matrUprRmk"   , label: "비고"      , align: "left"  , width: 300, hidden: false}
				]
			});
			return this;
		},
		
		setData: function(_pageNo) {
			var targetObj = this.target;

			var formData = new FormData();
			formData = {
				"coCd": $('#coCd').val(),
				"clntCd": $('#clntCd').val(),
				"currCd": modalStack.last().paramObj.currCd,
				"matrCd": $('#matrCd').val()
			}
			postAjax("/user/bm/bm11/select_bm11_Info_Dtl", formData, null, function(data) {
				var list = data.result;
				//debugger;
				targetObj.setData({
					list : list,
					page : {
						totalElements: list.length
					}
				});
			});
		}
	}
	
	//화면 초기 설정
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);

		$("#popForm #userId").val(jwt.userId);

		//처리일자//
		$('#adptDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());
		
		ModalgridView.initView();
		
		authChk(); //권한체크
		
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		
		if (actionType == "C") {
			$('#popForm .coCd').addClass('hit');
			$('#popForm input#coCd').attr('required', 'required');
			
			//버튼명 변경
			$("#actionBtn").text("등록");

			$("#popForm #useYn").val("Y");
			$("#popForm #matrUpr").val("0");
			$("#popForm #deductUpr").val("0");

			//버튼 클릭 시
			$('#actionBtn').on("click", function() {
				insert_bm11();
			});
		} else if (actionType == "U") {
			//타이틀명 변경
			$('.tit').text('구매단가 수정')
			
			//회사 비활성화
			$('#popForm .coCd').removeClass('hit');
			$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//구매업체 비활성화
			$('#popForm .clntCd').removeClass('hit');
			$('#clntNm').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//적용일자 비활성화
			$('#popForm .adptDt').removeClass('hit');
			$('#adptDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//품번 비활성화
			$('#popForm .matrCd').removeClass('hit');
			$('#matrCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//통화단위 비활성화
			$('#popForm .currCd').removeClass('hit');
			$('#currCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

			//수정 모드 데이터 가져오기
			select_bm11_Info();
			
			//버튼명 변경
			$('#actionBtn').text("수정");

			//버튼 클릭 시
			$('#actionBtn').on("click", function() {
				update_bm11();
			});
		}
		
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: $("#popForm #pgmId").val(),
			fileTrgtKey : fileTrgtKey
		}
		
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
	});
	
	//입력정보
	function select_bm11_Info() {
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		
		postAjaxSync("/user/bm/bm11/select_bm11_Info", formData, null, function(data) {
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
			});
			//debugger;
		});
		ModalgridView.setData(0);
	}
	
	// 등록
	function insert_bm11() {
		if (inputValidation($('.popup_area [required]'))) {		// 필수 필드의 유효성 검사
			// 구매단가 확인
			var matrUpr = parseInt( deleteCommaStr($('#matrUpr').val()) );
			if (matrUpr <= 0) {
				alert('구매단가 0 이하는 등록할 수 없습니다.');
				return;
			}

			var formData = makeFormData();						// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			//debugger;
			filePostAjax("/user/bm/bm11/insert_bm11", formData,	// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
			            function(data) {
							alert(data.resultMessage);			// 결과 메시지를 alert으로 출력
							
							if (data.resultCode == 200) {		//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
								gridView.setData(0);
								modalStack.close();				// 모달을 닫음
							}
						}
			);
		}
	}
	
	// 수정
	function update_bm11() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			
			filePostAjax("/user/bm/bm11/update_bm11", formData,function(data) {
				alert(data.resultMessage);
				
				if (data.resultCode == 200) {
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
// 		console.log(formData);
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , $('#clntCd').val());         //첨부화일용
		//formData.append("prdtCd" , $('#prdtCd').val());         //첨부화일용
		//formData.append("itemCd" , $('#itemCd').val());        //첨부화일용
		//formData.append("prjctCd", $('#clntPjt').val());        //첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------

		return formData;
	}

	// 거래처 검색 함수
	function ClntSearch(inputValue) {
		//등록일 경우만 팝업처리
		if (actionType == "C") {
			openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue : inputValue}, function(grid) {
				var row = grid.target.getList("selected")[0];
				$('#clntCd').val(row.clntCd);
				$('#clntNm').val(row.clntNm);
				Modal_DataSearch();
			});
		}
	}

	//자재품번 검색
	function MatListSearch(openType) {
		//등록일 경우만 팝업처리
		if (actionType == "C") {
			var paramObj = {
				"coCd" : $('#coCd').val(),
				"searchValue" : $("#matrCd").val()
			}
			
			openSecondModal("/static/html/cmn/modal/matListSearch.html", 1200, 700, "자재품번 검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];
				//debugger;
				$("#matrCd").val(row.matrCd);
				$("#matrNm").val(row.matrNm);
				$("#matrSpec").val(row.matrSpec);
				$("#matrMat").val(row.matrMat);
				$("#matrMakrNm").val(row.matrMakrNm);
				$("#matrMno").val(row.matrMno);

				$("#goodsDiv").val(row.goodsDiv);
				$("#goodsDivNm").val(row.goodsDivNm);

				$("#matrClntDiv").val(row.matrClntDiv);
				$("#matrClntDivNm").val(row.matrClntDivNm);

				$("#matrDiv").val(row.matrDiv);
				$("#matrDivNm").val(row.matrDivNm);

				$("#matrGrp").val(row.matrGrp);
				$("#matrGrpNm").val(row.matrGrpNm);

				$("#matrUnit").val(row.matrUnit);
				$("#matrUnitNm").val(row.matrUnitNm);

				$("#matrPurcDiv").val(row.matrPurcDiv);
				$("#matrPurcDivNm").val(row.matrPurcDivNm);
				Modal_DataSearch();
			});
		}
	}

	// 팝업 그리드 조회
	function Modal_DataSearch() {
		ModalgridView.setData(0);
	}

	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

</script>