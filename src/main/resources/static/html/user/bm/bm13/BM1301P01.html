<style>
* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">결재선 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="BM1301M01">      
      <table>

        <colgroup>
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="19%">
        </colgroup>

        <tr>
          <th class="hit">회사</th>
          <td>
				<select id="coCd" name="coCd" data-kind="CO" required msg="회사">
				</select>
          </td>
          <th class="hit">작성자</th>
			<td>
				<div class="search_form">
					<input type="hidden" id="userId_P" name="userId_P"  data-search="userId_P">
					<input type="text"	id="userName_P"   data-search="userName_P"  onkeyup="">
					<a onclick="openUserSearchPop();"><i class="i_search_w"></i></a>
				</div>
          </td>

          <th class="hit">결재선 구분</th>
			<td>
				<select id="appDiv" name="appDiv" data-kind="APPDIV" required msg="결재선구분">
				</select>
			</td>
        </tr>

        <tr>
          <th class="hit">결재선 명칭</th>
          <td colspan="3">
          <input type="text" id="app_line_nm" name="app_line_nm" required msg="결재선명">
          </td>

          <th class="hit">사용여부</th>
          <td>
            <select id="useYn" name="useYn" data-search="useYn" required msg="사용여부">
            	<option value="Y">Y</option>
            	<option value="N">N</option>
             </select>
          </td>
        </tr>
      </table>
    </form>

    <br>
    <div class="popup_table" style="">

        <div class="tbody_more" style="text-align: right;background:#e6e6e6">
            <a class="tbody_more_btn"></a>
        </div>
        <div class="toggle-div" style="padding-left: 0;">
            <div class="" style="padding-left: 0;">
                <div id="est_grid" class="contents"
                     style="margin:0px; padding:0px; height: 380px; width: 100%; min-width: 200px;border-radius:0;">
                    <div style="float:right" style="" class="add_btn pdl10">
                        <a id="addDetailButton" style="margin-top:8px">+</a>
                        <a id="deleteDetailButton" style="margin-top:8px;margin-right:8px;">-</a>
                    </div>

                    <h3 class="location">
                        <a class="file_tag" id="file_tag"
                           style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                        <span class="page_tit" style="text-align: right;"></span>
                    </h3>
                    <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                        <div data-ax5grid="approval-grid-modal" data-ax5grid-config="{}" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">

//전역 초기화
var actionType = null;
var userId = null;
var userNm = null;
var coCd = null;

//결재대상자 그리드
var gridViewPop = {
	  	initView: function(){
		this.target = new ax5.ui.grid();
		this.target.setConfig({
			showRowSelector: false,
			multipleSelect: false,
			sortable: false,
			target: $('[data-ax5grid="approval-grid-modal"]'),
			header: {
	             align: "center",
	             selector: false
	           },
	           body: {
				onClick: function () {
				    this.self.select(this.dindex); 
				    
				},
				onDBLClick: function () {
					      this.self.clearSelect();
	                      this.self.select(this.dindex);
	                      var row = this.dindex;
	                      var paramObj = {"flag":"M","row":row};
				},
		   },
	          page: {
				navigationItemCount: 9,
				height: 30,
				display: true,
				firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
				prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
				nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
				lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
				onChange: function () {
					gridViewPop.setData(this.page.selectPage); 
				}
	          },
	          columns: [
	       	   {key: "rn",      label: "No.",          align: "center",   width: 40},
	              {key: "coCd",      			label: "회사",          hidden: true},
	              {key: "actFlag",     			label: "상태",		align: "center",   width: 50, 	styleClass: "grid-font-blue-bold" },
	              {key: "appUserNm",      		label: "결재자명",      align: "center",   width: 100},
	              {key: "appId",      			label: "결재자ID",      align: "center",   width: 130,		hidden: true},
	              {key: "deptNm",      			label: "부서",      align: "center",   width: 100},
	              {key: "levelNm",      		label: "직급",      align: "center",   width: 80},
	              {key: "email",      			label: "E-mail",      align: "center",   width: 200},              
	              {key: "telNo",    	  		label: "전화번호",      align: "center",   width: 100},
	              {key: "offTelNo",      		label: "회사번호",      align: "center",   width: 100},
	              {key: "faxNo",      			label: "Fax번호",      align: "center",   width: 100},              
	              {key: "creatDttm",			label: "변경일시",      align: "center",   width: 130}
	             ]
	       });
	       return this;

	     },
	       setData: function(_pageNo) {
	     	    var targetObj = this.target;
	     	    var userId = $("#userId").val();
	     	    var formData = {
	     	    		   "userId" : userId,	//userId - 작성자
	     	               "coCd" : $("#coCd").val(), //회사코드
	     	               "appId" : $("#appId_S").val(), //결재자
	     	               "appNo" : modalStack.last().paramObj.appNo	, //결재선번호
	     	               "pageNo" : _pageNo + 1, 
	     	               "recordCnt" : $("#recordCnt").val()
	     	           }
	             postAjax("/user/bm/bm13/selectApprovalList", formData, null, function(data){
	                 var list = data.resultList;
	                 	targetObj.setData({
						    list : list,
						    page : {
				                   currentPage : _pageNo,
				                   pageSize : data.paginationInfo.pageSize,
				                   totalElements : data.paginationInfo.totalRecordCount,
				                   totalPages : data.paginationInfo.totalPageCount
						    } 
				         });
	             });
	        } 
	}
	

	// 권한체크    
authChk();		
	
//결재선 그리드 - 신규등록은 기존데이터가 의미가 없음(결재선 번호가 없기때문)
gridViewPop.initView();	 	

//등록/수정 버튼
actionType = modalStack.last().paramObj.actionType;
if (actionType == "C") {
     $("#costNo").prop("readonly", true);
	$("#actionBtn").text("등록");
	$('#actionBtn').on("click", function() {
		insertApproval();
	});

} else if (actionType == "U") {
	$('.tit').text('결재선 수정')
	
	//그리드 load
	gridViewPop.initView().setData(0);

	$('#actionBtn').text("수정");
	$('#actionBtn').on("click", function() {
		updateApproval();
	});
}	

	
$(document).ready(function() {
	setCommonSelect($(".popup_area select[data-kind]"));
	//회사명 콤보 set
	$("#popForm #userId").val(jwt.userId);
	coCd = modalStack.last().paramObj.coCd;	
	$("#coCd").val(coCd);

	//작성자 readonly 등 set
	userId = modalStack.last().paramObj.userId;
	userNm  = modalStack.last().paramObj.userNm;
	appLineNm  = modalStack.last().paramObj.appLineNm;
    $("#userId_P").val(userId);
    $(".popup_area #userId").val(userId);
    $("#userName_P").val(userNm);
	$("#userName_P").attr("readonly", true);    
	$("#app_line_nm").val(appLineNm);
    	
    //관리자권한 체크후 없으면 readonly
    var authInfo = jwt.authInfo;
    var isAdmin = authInfo.indexOf("AUTH001");
    
    if( isAdmin < 0 ) {
    	$("#userName_S").attr("readonly", true);    	
    	$("#userIdBtn").hide();
    	$("#appIdBtn").hide();    	
    }	
	
	//결재선 목록 그리드 추가(등록)
    $("#addDetailButton").on("click", function (tempRun) {

        var paramObj = {
                "coCd" : $(".popup_area #coCd").val(),
                /* "userId": $(".popup_area #userId").val(), */
                "useYn": "Y"
            }; 
            openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "담당자 검색", paramObj, function (tree){
               var checkedId = tree.get_checked()[0];
               var checkedNode = tree.get_node(checkedId);   

               var paramObj = {"coCd" : $(".popup_area #coCd").val(), "userId" : checkedId};
               
				postAjax("/user/wb/wb02/selectRsltsMemberList", paramObj, null, function(data) {
					var dupChk = true;		//중복 check flag
					var appId = data.resultList[0].id;
					dupChk = $.dupUserChk(gridViewPop, appId);
					if( dupChk ) {
			        	alert("이미 지정된 결재자 입니다.");
			        	return;
					} else {
						gridViewPop.target.addRow($.extend({}, "last", false));                             
						var row = gridViewPop.target.getList().length - 1;
						gridViewPop.target.setValue(row, "rn", "");
						gridViewPop.target.setValue(row, "coCd", $("#coCd").val());
						//등록플래그
						gridViewPop.target.setValue(row, "actFlag", "I");
						gridViewPop.target.setValue(row, "appUserNm", data.resultList[0].name);
						gridViewPop.target.setValue(row, "appId", data.resultList[0].id);
						gridViewPop.target.setValue(row, "deptNm", data.resultList[0].deptNm);
						gridViewPop.target.setValue(row, "levelNm", data.resultList[0].levelNm);
						gridViewPop.target.setValue(row, "email", data.resultList[0].email);
						gridViewPop.target.setValue(row, "telNo", data.resultList[0].telNo);
						gridViewPop.target.setValue(row, "offTelNo", data.resultList[0].offTelNo);
						gridViewPop.target.setValue(row, "faxNo", data.resultList[0].faxNo);					
					}
				});                 
				//postAjax set end
            });  
            //second 사용자검색 모달 end
        //No. set -- line 추가시 실행되게 수정
        $.gridNoSet(gridViewPop);            
    });
	//click function end

	//그리드 추가 중복처리
	$.dupUserChk = function(gridObj, appId) {
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			var idArr = [];			
	        $.each(gridList, function (idx, elem) {
        		idArr.push(elem.appId);
	        });			
	        if( idArr.indexOf(appId) > -1 ) {
	        	return true;
	        } else {
	        	return false;
	        }
		}
	}
	
	//결재선 그리드 삭제
    $("#deleteDetailButton").on("click", function () {

 		var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
		if( typeof(selRow) != NaN && selRow > -1 ) {
			//신규 추가한 행일 경우만 삭제
			if ( typeof(gridViewPop.target.getList()[selRow].actFlag) != "undefined" ) {
				gridViewPop.target.removeRow(selRow);
				$.gridNoSet(gridViewPop);					
			} 				
		} else if( typeof(selRow) != NaN ) {
		          alert("삭제를 위해 선택된 행이 없습니다.");				
		}
    });	
	
	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj) {
		console.log('---gridNoset run ---');		
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
	        $.each(gridList, function (idx, elem) {
	        	//flag I인것만 처리
	        	if( elem.actFlag == "I" ) {
		            var detailObj = {};	 
		            gridObj.target.setValue(idx, "rn", idx+1);
	        	}
	        });			
		}		
	}
	
	//등록시 그리드값 배열 저장
	$.gridPutArr = function(gridObj) {
		var gridList = gridObj.target.getList();
		var detailArr = [];    			
		if( gridList.length > 0 ) {
	        $.each(gridList, function (idx, elem) {
	        	//flag I인것만 처리
	        	if( elem.actFlag == "I" ) {
		            var detailObj = {};
		            detailObj["idx"] = idx + 1;
		            detailObj["actFlag"] = elem.actFlag;
		            detailObj["appId"] = elem.appId;		            
		            detailObj["appUserNm"] = elem.appUserNm;
		            console.log('---' + detailObj);
		            detailArr.push(detailObj);	        		
	        	}
	        });			
		}
		return detailArr;
	}

});
//ready end

function tempRun() {
		console.log('----temRun---');
        //No. set -- line 추가시 실행되게 수정
        //$.gridNoSet(gridViewPop);		
	}

// 작성자 검색 //
function openUserSearchPop() {
	var paramObj = {
		  "coCd" : $('#coCd').val(),
		"userId" : $('#userName_P').val(),
	};
	debugger;

	openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500,
			"사용자 검색", paramObj, function(tree) {
				var checkedId = tree.get_checked()[0];
				var checkedNode = tree.get_node(checkedId);
				$('#userId_P').val(checkedNode.id);
				$('#userName_P').val(checkedNode.text);
				 gridViewPop.setData(0);
			});
}

 // 등록 - done
function insertApproval() {
	if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
		var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		var makeArr = {};
        //저장용 배열 push
		makeArr = $.gridPutArr(gridViewPop);		
        
		if(makeArr.length<1) {
			alert("결재선 항목은 최소 1개 이상이어야 합니다.");
			return;
		} else {
			formData.append("makeArr", JSON.stringify(makeArr));
		}        

		filePostAjax("/user/bm/bm13/insertApproval", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행		
			function(data) {
				alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
				if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridViewPop.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
					gridView.setData(0);
					modalStack.close();									// 모달을 닫음
				}
		});
	}
}

// 수정
function updateApproval() {
	if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
		var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
      	filePostAjax("/user/sm/sm10/updatePchsCost", formData,function(data) {
					alert(data.resultMessage);
					if (data.resultCode == 200) {
						gridViewPop.setData(0);
						modalStack.close();
					}
				});
	}
}

//----------------------------------------------//

function makeFormData() {
	// 금액 콤마 제거
	$.each($('.popup_area input[comma]'), function(idx, elem) {
		deleteComma(elem);
	});
	// 날짜 하이픈 제거
	$.each($('.popup_area input[date]'), function(idx, elem) {
		deleteHyphen(elem);
	});
	// 폼데이터 생성
	var formData = new FormData($("#popForm")[0]);
	
	// 기본값 set
	formData.append("userId", jwt.userId);
	 
	return formData;
}

	
</script>