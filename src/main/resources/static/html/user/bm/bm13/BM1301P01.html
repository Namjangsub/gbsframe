<style>
* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">결재선 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="BM1301M01">      
      <table>

        <colgroup>
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="19%">
        </colgroup>

        <tr>
          <th class="hit">회사</th>
          <td>
				<select id="coCd" name="coCd" data-kind="CO" required msg="회사">
				</select>
          </td>
          <th class="hit">작성자</th>
			<td>
				<input type="hidden" id="userId_P" name="userId_P"  data-search="userId_P">
				<input type="text"	id="userName_P"   data-search="userName_P"  onkeyup="">
				<a onclick="openUserSearchPop();"><i class="i_search_w" id="userIdBtn"></i></a>
          </td>

          <th class="hit">결재선 구분</th>
			<td>
				<select id="appDiv" name="appDiv" data-kind="APPDIV" required msg="결재선구분">
				</select>
			</td>
        </tr>

        <tr>
          <th>결재선 명칭</th>
          <td colspan="3">
          <input type="text" id=""app_line_nm"" name="app_line_nm" required msg="결재선명">
          </td>

          <th>사용여부</th>
          <td>
            <select id="useYn" name="useYn" data-search="useYn" required msg="사용여부">
            	<option value="">Y</option>
            	<option value="">N</option>
             </select>
          </td>
        </tr>
      </table>
    </form>

    <br>
    <div class="popup_table" style="">

        <div class="tbody_more" style="text-align: right;background:#e6e6e6">
            <a class="tbody_more_btn"></a>
        </div>
        <div class="toggle-div" style="padding-left: 0;">
            <div class="" style="padding-left: 0;">
                <div id="est_grid" class="contents"
                     style="margin:0px; padding:0px; height: 380px; width: 100%; min-width: 200px;border-radius:0;">
                    <div style="float:right" style="" class="add_btn pdl10">
                        <a id="addProductButton" style="margin-top:8px">+</a>
                        <a id="deleteProductButton" style="margin-top:8px;margin-right:8px;">-</a>
                    </div>

                    <h3 class="location">
                        <a class="file_tag" id="file_tag"
                           style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                        <span class="page_tit" style="text-align: right;"></span>
                    </h3>
                    <div class="contents" style="margin:0px;padding:0 5px;height:80%; width:100%; min-width:300px">
                        <div data-ax5grid="approval-grid-modal" data-ax5grid-config="{}" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">

var actionType = null;

//결재대상자 그리드
var gridView = {
	  	initView: function(){
		this.target = new ax5.ui.grid();
		this.target.setConfig({
			showRowSelector: true,
			multipleSelect: false,
			sortable: true,
			target: $('[data-ax5grid="approval-grid-modal"]'),
			header: {
	             align: "center",
	             selector: false
	           },
	           body: {
				onClick: function () {
				    this.self.select(this.dindex); 
				    
				},
				onDBLClick: function () {
					      this.self.clearSelect();
	                      this.self.select(this.dindex);
	                      var row = this.dindex;
	                      var paramObj = {"flag":"M","row":row};
				},
		   },
	          page: {
				navigationItemCount: 9,
				height: 30,
				display: true,
				firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
				prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
				nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
				lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
				onChange: function () {
					gridView.setData(this.page.selectPage); 
				}
	          },
	          columns: [
	       	   {key: "rn",      label: "No.",          align: "center",   width: 60},
	              {key: "coCd",      			label: "회사",          hidden: true},
	              {key: "appUserNm"   			label: "결재자",      align: "center",   width: 150},	              
	              {key: "appId",      			label: "결재자ID",      align: "center",   width: 130,		hidden: true},
	              {key: "deptNm",      			label: "부서",      align: "center",   width: 130},
	              {key: "levelNm",      		label: "직급",      align: "center",   width: 130},
	              {key: "email",      			label: "E-mail",      align: "center",   width: 130},              
	              {key: "telNo",    	  		label: "전화번호",      align: "center",   width: 100},
	              {key: "offTelNo",      		label: "회사번호",      align: "center",   width: 100},
	              {key: "faxNo",      			label: "Fax번호",      align: "center",   width: 100},              
	              {key: "creatDttm",			label: "변경일시",      align: "center",   width: 140}
	             ]
	       });
	       return this;

	     },
	       setData: function(_pageNo) {
	     	    var targetObj = this.target;
	     	    var userId = "";
	     	    userId = jwt.userId;
	     	    var formData = {
	     	    		   "userId" : userId,	//userId - 작성자
	     	               "coCd" : $("#coCd").val(), //회사코드
	     	               "appId" : $("#appId_S").val(), //결재자
	     	               "pageNo" : _pageNo + 1, 
	     	               "recordCnt" : $("#recordCnt").val()
	     	           }
	             postAjax("/user/bm/bm13/selectApprovalList", formData, null, function(data){
	                 var list = data.resultList;
	                 	targetObj.setData({
						    list : list,
						    page : {
				                   currentPage : _pageNo,
				                   pageSize : data.paginationInfo.pageSize,
				                   totalElements : data.paginationInfo.totalRecordCount,
				                   totalPages : data.paginationInfo.totalPageCount
						    } 
				         });
	             });
	        } 
	}
	
	
$(document).ready(function() {
	setCommonSelect($(".popup_area select[data-kind]"));
	//회사명 콤보 set
	$("#popForm #userId").val(jwt.userId);
	var coCd = modalStack.last().paramObj.coCd;
	$("#coCd").val(coCd);

	//작성자 readonly 등 set
    $("#userId_P").val(jwt.userId);
    $("#userName_P").val(jwt.userNm);
	$("#userName_P").attr("readonly", true);    
    	
    //관리자권한 체크후 없으면 readonly
    var authInfo = jwt.authInfo;
    var isAdmin = authInfo.indexOf("AUTH001");
    
    if( isAdmin < 0 ) {
    	$("#userName_S").attr("readonly", true);    	
    	$("#userIdBtn").hide();
    	$("#appIdBtn").hide();    	
    }	
	
 	// 권한체크    
	authChk();						

	//등록/수정 버튼
	actionType = modalStack.last().paramObj.actionType;
	if (actionType == "C") {
	     $("#costNo").prop("readonly", true);
		$("#actionBtn").text("등록");
		$('#actionBtn').on("click", function() {
			insertApproval();
		});

	} else if (actionType == "U") {
		$('.tit').text('결재선 수정')
		
		selectPchsCostInfo();

		$('#actionBtn').text("수정");
		$('#actionBtn').on("click", function() {
			updateApproval();
		});
	}	
	
	//결재선 그리드
	gridView.initView().setData(0);	
	
});
//ready end

// 작성자 검색 //
function openUserSearchPop() {
	var paramObj = {
		  "coCd" : $('#coCd').val(),
		"userId" : $('#userName_P').val(),
	};
	debugger;

	openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500,
			"사용자 검색", paramObj, function(tree) {
				var checkedId = tree.get_checked()[0];
				var checkedNode = tree.get_node(checkedId);
				$('#userId_P').val(checkedNode.id);
				$('#userName_P').val(checkedNode.text);
				 gridView.setData(0);
			});
}

 // 등록
function insertApproval() {
	if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
		var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		debugger;
		filePostAjax("/user/bm/bm13/insertApproval", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
				
				function(data) {
					alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
					if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
						gridView.setData(0);
						modalStack.close();									// 모달을 닫음
					}
				});
	}
}

// 수정
function updatePchsCost() {
	if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
		var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
      	filePostAjax("/user/sm/sm10/updatePchsCost", formData,function(data) {
					alert(data.resultMessage);
					if (data.resultCode == 200) {
						gridView.setData(0);
						modalStack.close();
					}
				});
	}
}

//----------------------------------------------//

function makeFormData() {
	// 금액 콤마 제거
	$.each($('.popup_area input[comma]'), function(idx, elem) {
		deleteComma(elem);
	});
	// 날짜 하이픈 제거
	$.each($('.popup_area input[date]'), function(idx, elem) {
		deleteHyphen(elem);
	});
	// 폼데이터 생성
	var formData = new FormData($("#popForm")[0]);
	
	//---------------------------------------------------------------  
	//-------itemarr  --첨부화일 처리를 위한 부분 시작
	//---------------------------------------------------------------  
	// 유저아이디 추가
	formData.append("userId", jwt.userId);
	formData.append("clntCd", $('#vendCd').val());			//첨부화일용
	formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
	formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
	formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
	formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
	var fileUploadArr = [];
	var tempArr = [];
	
	tempArr = treeModule.getFileArr();
	$.each(tempArr, function(idx, obj) {
		if (obj.fileKey == 0) {
            formData.append("files", obj.file);
            obj.file = '';
            fileUploadArr.push(obj);
		}
	});

	formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
	formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
	//---------------------------------------------------------------  
	//--첨부화일 처리를 위한 부분 끝
	//--------------------------------------------------------------- 

	return formData;
}



		

//  업체명 검색 //
function clntSearch() {
	openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
			"업체명 검색", {}, function(grid) {
				var row = grid.target.getList("selected")[0];
				$('#pchsClntCd').val(row.clntCd);
				$('#pchsClntNm').val(row.clntNm);
//					$('#mngId').val(row.salesEmpId);
//					$('#mngNm').val(row.salesEmpNm);

//					var paramObj = {
//						"coCd" : $('#coCd').val(),
//						"clntCd" : row.clntCd
//					}
//					setMngInfo(paramObj);
			});
}

// 영업담당자 set
//	function setMngInfo(paramObj) {
//		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
//				function(data) {
//					if (data.mngInfo) {
//						$('#mngId').val(data.mngInfo.salesEmpId);
//						$('#mngNm').val(data.mngInfo.salesEmpNm);
//					} else {
//						$('#mngId').val("");
//						$('#mngNm').val("");
//					}
//				});
//	}





	function setByCoCd(value) {
	$('#coCd option:not([value="'+value+'"])').remove();
}
	
</script>