<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="/static/js/jquery-latest.min.js"></script>
<script src="/static/js/jquery.serializeObject.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script src="/static/js/moment/moment-with-locales.js"></script>
<script src="/static/js/jstree/jstree.min.js"></script>
<script src="/static/js/ax5/ax5core.min.js"></script>
<script src="/static/js/ax5/ax5grid.min.js"></script>
<script src="/static/js/ax5/ax5mask.min.js"></script>
<script src="/static/js/ax5/ax5modal.min.js"></script>
<script src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5calendar.min.js"></script>
<script src="/static/js/ax5/ax5picker.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script src="/static/js/ax5/ax5formatter.min.js"></script>
<script src="/static/js/ax5/ax5combobox.min.js"></script>
<script src="/static/js/ax5/ax5grid-inline-editor.js"></script>
<script src="https://unpkg.com/exceljs/dist/exceljs.min.js"></script>
<script src="/static/js/global.js"></script>
<!-- 도움말 팝업 -->
<script src="/static/js/manualPopup.js"></script>
<style>
	.add_btn_small {
		display: inline-block;
		padding: 0px;
	}
	
	.add_btn_small a {
		display: inline-block;
		width: 33px;
		height: 20px;  
		line-height: 20px;
		text-align: center;
		color: #444;
		background: #ffffff;
		box-shadow: 1px 1px rgba(0, 0, 0, 0.15);
	}
	
	
	 div#wrapper {
		width: 950px;
		height: 700px;
		margin-left: 500px;
	 }
	 
	 div#form {
		float: left;
		padding: 10px 0px 0px 10px;
		width: 400px;
		height: 700px;
		border: 1px solid;
	 }
	 
	 div#tree_wrapper {
		float: left;
		padding: 10px 0px 0px 10px;
		width: 500px;
		height: 700px;
		margin-left: 2px;
		border: 1px dashed;
		display: none;
	 }
	 
	 div#deptTree  {
		margin: 0px 2px 0px 2px;
	/*   width: 470px; */
		height: 640px;
		border: 1px solid;
		overflow: auto;
	 }
	 
	 div#search_guide_wrapper {
		padding: 10px 0px 0px 10px;
		width: 500px;
		height: 700px;
		margin-left: 2px;
		border: 1px dashed;
		float: left;
	 }
    .resizable-div {
      border: 1px dashed #bbb9b9;
    }
    .blue-node > a { color: blue !important; } /* Define the blue color for the specific node */
	</style>
</head>
  <body>
    <div id="head_area"></div>
    <div id="top_area"></div>
  
    <div id="main_area">
      <!-- 페이지 상단 -->
      <div class="contents no_bg">
        <ul class="btn_ul">
          <li class="btn_r">
            <a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
            <a onclick="initSearch();"><button class="bg_gray">초기화</button></a> 
            <a onclick="initDeptTree();"><button class="bg_gray">검 색</button>
            </a>
          </li>
        </ul>
      </div>
      <!-- 검색 콘텐츠 -->
      <div class="contents search">
        <div class="">
          <!-- 테이블 인풋 3분할 -->
          <table class="table_input type03"> 
            <tr>
				<th class="hit">회사</th>
				<td><select id="coCd_S" name="coCd_S" data-kind="CO" required="required" data-search="coCd" onchange="initDeptTree();">
				</select></td>
				<th class="hit">Sales Code</th>
				<td>
				    <div class="search_form">
				    	<input type="text" id="salesCd_S" name="salesCd_S" value="" data-search="salesCd" onkeyup="event.keyCode == 13 ? initDeptTree() : ''">
				    	<a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
				    </div>
				</td>
				</td>
				<th>고객사</th>
				<td>
					<input type="text" id="clntNm_S" name="clntNm_S">
				</td>
			</tr>
	        <tr>
				<th></th>
				<td>
					<input type="hidden" id="prdtCd" name="prdtCd">
					<input type="text" id="prdtCdNm" name="prdtCdNm"  readonly>
					<input type="hidden" id="itemDiv" name="itemDiv">
					<input type="text" id="itemDivNm" name="itemDivNm" readonly>
					<input type="hidden" id="ordrsNo" name="ordrsNo">
	
				</td>
				<th>프로젝트</th>
				<td>
					<input type="hidden" id="clntPjt" name="clntPjt">
					<input type="text" id="clntPjtNm" name="clntPjtNm">
				</td>
				<th>설비명</th>
				<td>
					<input type="text" id="eqpNm" name="eqpNm">
				</td>
				<th></th>
	        </tr>
          </table>
        </div>
      </div>
      <!-- // 콘텐츠 -->
		<input type="hidden" id="pgmId" name="pgmId">
  
      <!-- 콘텐츠 --> 
      <div class="contents no_bg">
        <!-- 콘텐츠 타이틀 -->
        <div class="contents_tit" style="margin: 0px;">
          <div class="add_btn_small pdl10" style="margin: 0px; padding: 0px;">
            <a onclick="setReportMulti()" style="height: 30px; line-height: 28px; width: 100px;" authchk><i class="fas fa-print"></i> Part List출력</a> 
            <a onclick="copyBom();" style="height: 30px; line-height: 28px; width: 80px;" authchk><i class="fas fa-clone"></i> 복사생성</a> 
            <a onclick="excelUpload();" style="height: 30px; line-height: 28px; width: 80px;" authChk><i class="fa fa-upload"></i> 엑셀업로드</a>
		    <a onclick="jsonToExcel(firstGrid);" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
          </div>
        </div>
      </div>
      <!-- 콘텐츠 -->
    <div class="row" style="margin-top: 0px;">
      <div id="treeFrame" class="col-xs-3 resizable-div" style="padding-right: 1px; min-height: 247px; ">
        <div class="contents" style="margin: 0px; padding: 0px; height: 100%;  min-height: 245px; min-width: 200px;">
			<h3 class="location">
			  <span class="page_tit" style="text-align: left;"> PART내역</span>
			</h3>
			<div style="float: right;">
				<a id="treeExpandBtn" class="btn btn-default btn-sm" onclick="treeExpandClose()"><i class="fas fa-chevron-up"></i></a>
				<a id="bomcreateBtn" class="btn btn-default btn-sm" onclick="createBom('C');" authChk>등록</a>
				<a id="bomUpdateBtn" class="btn btn-default btn-sm" onclick="createBom('U');" authChk>수정</a>
<!-- 				<a id="bomDeleteBtn" class="btn btn-default btn-sm" onclick="deleteBom();" authChk>삭제</a> -->
			</div>          
            <div id="deptTree" style="height: 690px;  width: 100%;" ></div>
        </div>
      </div>
      <div id="gridFrame" class="col-xs-9 resizable-div" style="padding-left: 0; padding-right: 0px;min-height:247px;">
        <div class="contents " style="margin:0px; padding:0px; height: 100%; width: 100%; min-height:200px; min-width: 245px">
          <h3 class="location">
            <span class="page_tit" style="text-align: right;"> BOM상세</span>
          </h3>
            <div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 690px;  min-height:200px;"></div>
        </div>
      </div>
    </div>
  
    <script type="text/javascript">

	function gridStyle(row) {
		if (!row) return "";
		if (row.updChk === "D")  return "grid-font-red";
		if (pasFloatChk(row.lowerQty) == 0)  return "grid-no-msg-font-blue-bold";
		if (pasFloatChk(row.pchsBomCnt) > 0)  return "grid-font-red";
		return "";
	}
	
  var firstGrid = {
	  initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
	           target: $('[data-ax5grid="first-grid"]'),
	           showLineNumber: true,
	           lineNumberColumnWidth: 40,
	           showRowSelector: false,  
		       multipleSelect: false,
	           header: {align:'center'}, 
	           frozenColumnIndex: 3,
	           frozenRowIndex: 1,
	           
	           columns: [
// 	               {key: "coCd",		label: "coCd",		width: 50,align: "left",  hidden: true},
// 	               {key: "fileTrgtKey",	label: "key",		width: 50,align: "left",  hidden: true},
// 	               {key: "upperKey",	label: "upperKey",	width: 50,align: "left",  hidden: true},
// 	               {key: "lowerKey",	label: "lowerkey",	width: 50,align: "left",  hidden: true},
// 	               {key: "pid",			label: "pid",		width: 50,align: "left",  hidden: true},
// 	               {key: "id",			label: "id",		width: 50,align: "left",  hidden: true},
	               {key: "matrYn", 		label: "자재", 		width: 40,align: "center", 	formatter: function () { return this.value == "Y" ? "자재" : ""} },
	               {key: "pchsBomCnt", 	label: "BOM", 		width: 40,align: "center",  formatter: function () { return this.value > 0 ? "BOM" : ""}},
	               {key: "lowerCd",		label: "도번코드",		width: 160,align: "left",  hidden: false, treeControl: true, styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrNm", 		label: "품명", 		width: 200,align: "left", styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrMno", 	label: "형번/규격", 		width: 200,align: "left", styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrMat", 	label: "소재/제조사", 		width: 100,align: "left", styleClass: function () { return gridStyle(this.item); }},
	               {key: "lowerUnit", 	label: "단위", 		width: 50,align: "center", styleClass: function () { return gridStyle(this.item); }},
	               {key: "lowerQty", 	label: "수량", 		width: 40,align: "right", formatter:"money", styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrSpec", 	label: "규격", 		width: 70,align: "left", styleClass: function () { return gridStyle(this.item); }},
// 	               {key: "matrMakrNm", 	label: "제조사", 		width: 100,align: "left", styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrRmk", 	label: "비고", 		width: 200,align: "left", styleClass: function () { return gridStyle(this.item); }},
	               {key: "dsgnNo", 		label: "도면번호", 	width: 200,align: "left",  hidden: false, styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrCd", 		label: "자재코드", 	width: 80,align: "center", styleClass: function () { return gridStyle(this.item); }},
	               {key: "matrUnitCdNm",label: "단위", 		width: 50,align: "center", styleClass: function () { return gridStyle(this.item); }},
// 	               {key: "matrUnitCd",	label: "자재단위", 	width: 50,align: "center",  hidden: true, styleClass: function () { return gridStyle(this.item); }},
	               {key: "lvl", 		label: "단계", 		width: 40,align: "center", styleClass: function () { return gridStyle(this.item); }},
// 	               {key: "upperCd", 	label: "상위", 		width: 40,align: "center",  hidden: true, styleClass: function () { return gridStyle(this.item); }},
// 	               {key: "matrUnitCd", 	label: "단위", 		width: 40,align: "center",  hidden: true, styleClass: function () { return gridStyle(this.item); }},
// 	               {key: "matrUnitCdNm",label: "단위", 		width: 40,align: "center",  hidden: true, styleClass: function () { return gridStyle(this.item); }},
 	               {key: "matrUpr", 	label: "단가", 		width: 80,align: "right", formatter:"money", styleClass: function () { return gridStyle(this.item); }},
 	               {key: "partAmt", 	label: "금액", 		width: 80,align: "right", formatter:"money", styleClass: function () { return gridStyle(this.item); }},
 	               {key: "matrAvrgUpr", 	label: "평균단가", 		width: 80,align: "right", formatter:"money", styleClass: function () { return gridStyle(this.item); }},
 	               {key: "matrLastTrstDt", 	label: "최종거래일", 		width: 80,align: "right", styleClass: function () { return gridStyle(this.item); }},
 	               {key: "matrWt", 	label: "단위중량", 		width: 80,align: "right", formatter:"money", styleClass: function () { return gridStyle(this.item); }},
 	               {key: "upperKey", 	label: "상위", 		width: 50,align: "center", styleClass: function () { return gridStyle(this.item); }},
 	               {key: "lowerKey", 	label: "하위", 		width: 50,align: "center", styleClass: function () { return gridStyle(this.item); }},
			    ],
		        footSum: [
		    		[
						{colspan: 3},
		    			{label: "총합계", 	 align:"center",	  colspan:12},
	           			{key: "partAmt",     collector: "sum",   formatter:"money",  align: "right"},
						{colspan: 1},
	           			{key: "matrWt",     collector: "sum",   formatter:"money",  align: "right"},
			    	]
			    ],
		        body: {
		        	columnHeight: 24,
		        	showRowSelector: false,
					onClick: function () {
// 						this.self.select(this.doindex);
					},                
					onDBLClick: function () {
// 						if (this.column.key == 'sampleDate') {
// 						}
// 		        		this.self.select(this.dindex);
						//그리드에서 더블클릭하면 해당로우를 상위로하여 하위코드 조회
		        		gridFromCreateBom(this.item);
		        	},
		        	onDataChanged: function () {
					},
		        }, //body
	           tree: {
	               use: true,
	               indentWidth: 15,
	               arrowWidth: 15,
	               iconWidth: 18,
	               icons: {
	                   openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
	                   collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                   groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
	                   collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
	                   itemIcon: '<i class="fa fa-cog" aria-hidden="true"></i>'
	               },
	               columnKeys: {
	                   parentKey: "pid",
	                   selfKey: "id"
	               }
	           }, //tree
           }); //setConfig
           return this;
		},  //initView
           
        setData: function(fileTrgtKey){
				var target = this.target;
				var formData = {
					"userId" 	: jwt.userId,
					"coCd" 		: $("#coCd_S").val(),
					"salesCd" 	: $("#salesCd_S").val(),
					"fileTrgtKey"	: fileTrgtKey
				}
	    		postAjax("/user/bm/bm14/selectBomAllLevelList", formData, null, function(data) {
					var list = data.result;
					target.setData({
	            		list : list,
	            		page : {
	            			totalElements : list.length
	            		}
	       			 });
					gridHeightResize(firstGrid, 229); // 229 = 919 - 690 : 화면 Body 높이 - 그리드 기본크기 690
					$('#deptTree').height($('body').height()-229);
	    	 	});
     	} //setData           
	}
     	
      $(document.body).ready(function () {
	  	    //권한체크
	  	    authChk();
			mainDefaultLoad("기준관리", "설계BOM관리");
			$('#pgmId').val("BM1401M01");
			setCommonSelect($("#main_area select[data-kind]"));
			//수주일//
			$('#reqDtFrom').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true
			}).datepicker("setDate", new Date());
			//예상납기//
			$('#reqDtTo').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true
			}).datepicker("setDate", new Date());		
			
			//세션에 정보가 있으면 salesCd를 활용한다.
			var sessionSalesCd = sessionStorage.getItem('salesCd');
			sessionStorage.removeItem('salesCd');
			if (sessionSalesCd && sessionSalesCd != "undefined") {
				$('#salesCd_S').val(sessionSalesCd);
			}

			initDeptTree(); //왼쪽 트리 그리기
			
// 			if ($('#main_area').hasClass('on')) {
// 				var workWidth = $("#main_area").width() - 10;
// 			}
			$(".resizable-div").resizable();
			// 사이즈 조정 시 태그 자동 크기 조절
			$("#gridFrame").resize(function() {
				var workWidth = $("#main_area").width() - 10;
				
			    var tagHeight = $("#gridFrame").height() - 45 ;
			    var tagWidth  = $("#gridFrame").width();
			    tagWidth = tagWidth < 100 ? 100 : tagWidth;
			    tagWidth = tagWidth > 1400 ? 1400 : tagWidth;
			    	
			    $('[data-ax5grid="first-grid"]').height(tagHeight);
			    $('[data-ax5grid-container="root"]').height(tagHeight);
			    $('#treeFrame').height(tagHeight + 45);
			    $('#deptTree').height(tagHeight);
			    $('#treeFrame .contents').height(tagHeight+50);

				var chgWidth = workWidth - tagWidth;
			    chgWidth = (tagWidth + chgWidth) > workWidth ?  (workWidth - tagWidth) : chgWidth;
				$("#gridFrame").width(tagWidth);
			    $("#treeFrame").width(chgWidth);
			    $('#deptTree').width(chgWidth);
			    $('#treeFrame .contents').width(chgWidth);
			});			
			// 사이즈 조정 시 태그 자동 크기 조절
			$("#treeFrame").resize(function() {
				var workWidth = $("#main_area").width() - 10;
				
			    var tagHeight = $("#treeFrame").height() ;
			    var tagWidth  = $("#treeFrame").width();
			    tagWidth = tagWidth < 100 ? 100 : tagWidth;
			    tagWidth = tagWidth > 1400 ? 1400 : tagWidth;
			    
			    $('#deptTree').height(tagHeight -45);
			    $('#treeFrame .contents').height(tagHeight);
			    $('#gridFrame').height(tagHeight);
			    $('[data-ax5grid="first-grid"]').height(tagHeight - 45);
			    $('[data-ax5grid-container="root"]').height(tagHeight- 45);
			    
			    $("#treeFrame").width(tagWidth);
			    $('#deptTree').width(tagWidth);
			    $('#treeFrame .contents').width(tagWidth);
			    var chgWidth = workWidth - tagWidth;
			    chgWidth = (tagWidth + chgWidth) > workWidth ?  (workWidth - tagWidth) : chgWidth;
			    $("#gridFrame").width(chgWidth);
			});			
			
			authChk("BM1401M01");
      });
		      
  	// 트리 초기화
  	function initDeptTree() {

		firstGrid.initView();
		
		//제품정보 확인
		selectSalesCdSearchOrderInfo();

  		$("#deptTree").jstree("destroy");
  		$("#deptTree").jstree(
  		{
  			//dnd 기능 제거 남장섭 240328 작업자 오류 발생 가능
  			plugins : ['types', 'contextmenu', 'search' ],
  			core : {
//   				"check_callback": checkOperation,
  				dblclick_toggle: false,
  				data : selectDeptTree()
  			},
  			
//   			1. plugins에 Contextmenu를 추가한다.
//   			2. item에서 넘어오는 $node는 메뉴 클릭할 때 선택한 node를 가르킨다. 
//   			3. return 항목에 메뉴들을 정의한다.
//   			4. 메뉴에 action에 메뉴를 클릭하면 실행할 코드를 넣는다 
  			'contextmenu' : {
  				"items" : function($node) {
//   					var tree = $("#deptTree").jstree(true);
  					return {
	  					"create" : { 
	  		        		"separator_before" : false,
	  						"separator_after" : true,
	  						"icon": "glyphicon glyphicon-edit",
	  						"label" : "BOM 수정",
	  						"_disabled":  !$("#bomUpdateBtn").length,
	  						"action" : function(obj){createBom('U')}
	  					},
	  					"remove" : {
	  						"separator_before" : false,
	  						"separator_after" : true,
	  						"icon": "glyphicon glyphicon-erase",
	  						"label" : "BOM 삭제",
	  						"_disabled":  !$("#bomDeleteBtn").length,
	  						"action" : function(obj){deleteBom()}
	  					},
	  					"confirm" : {
	  						"separator_before" : false,
	  						"separator_after" : true,
	  						"icon": "glyphicon glyphicon-check",
	  						"label" : "BOM 작업완료",
	  						"_disabled":  ($node.original.cnfCheck=='Y'),
	  						"action" : function(obj){confirmBom($node, 'Y')}
	  					},
	  					"cancel" : {
	  						"separator_before" : false,
	  						"separator_after" : true,
	  						"icon": "glyphicon glyphicon-remove",
	  						"label" : "BOM 완료취소",
	  						"_disabled":  ($node.original.cnfCheck=='N'),
	  						"action" : function(obj){confirmBom($node, 'N')}
	  					}
  					}
  				}
  			} ,
  			
  			types : {
  				'unit' : {
  					'icon' : 'glyphicon glyphicon-folder-close'
  				},
  				'unit-open' : {
  					'icon' : 'glyphicon glyphicon-folder-open'
  				},
  				'leaf' : {
  					'icon' : 'glyphicon glyphicon-cog'
  				}
  			}
  		}).on('loaded.jstree', function() {
  		// 루트 노드 로드 완료 시
  			// 최상위 노드 펼침
  			
  			$('#deptTree').jstree(true).open_node($('#deptTree li[aria-level=1]').eq(0).attr('id'));
  			//첫번째 노드 검색해서 선택하기
  			var firstNode = $('#deptTree').jstree(true).get_node('#').children[0];
  			$('#deptTree').jstree(true).activate_node(firstNode);
  		}).on("refresh.jstree", function() {
  		// 리프레시 완료 시
  			var selectedId = $('#deptTree').jstree(true).get_selected()[0];
  			$('#deptTree').jstree(true).deselect_all();
  			$('#deptTree').jstree(true).select_node(selectedId);
  		}).on("select_node.jstree", function(e, data) {
  		// 노드 선택 시 발생 이벤트
  			
  			// BOM정보 set
//   			setBomInfo(data.node);
			firstGrid.setData(data.node.id);
  			// 신규 노드 삭제
  			if($('#deptTree').jstree(true).get_node('new')){
  				if(data.node.id != "new"){
  					$('#deptTree').jstree(true).refresh();
  				}
  			}
  		}).on('open_node.jstree', function(e, data) {
  		// 노드 열릴 때
  			data.instance.set_type(data.node, 'unit-open');
  		}).on('close_node.jstree', function(e, data) {
  		// 노드 닫힐 때
  			data.instance.set_type(data.node, 'unit');
  		}).on('create_node.jstree', function(e, data){
  		// 노드 생성 시
  			$('#deptTree').jstree(true).deselect_all();
  			$('#deptTree').jstree(true).select_node(data.node.id);
  			setBomInfo(data.node);
  		}).on('dblclick.jstree', function(e, data) {
  			// 노드 더블클릭 시
  			var node = $(this).jstree(true).get_node(this);
  			createBom('U');
  		}).on('copy_node.jstree', function(e, data) {
  			if (data.old_parent == data.parent){
  				alert("같은자리에는 복사할 수 없습니다.");
  				$('#deptTree').jstree(true).refresh();
  				return false;
  			}
  		    var copiedNodeId = data.original.id;
  		    var targetNodeId = data.parent;
  			var copiedNode = $("#deptTree").jstree(true).get_node(copiedNodeId);
  			var targetNode = $("#deptTree").jstree(true).get_node(targetNodeId);
  			if (confirm('"' + copiedNode.text + '" 를' + targetNode.text + '"에 복사 하시겠습니까?')) {

  				//console.log("노드 복사 완료: " + copiedNodeId);
	  			var nodeInfoArr = [];
	  			var nodeInfo = {};
	  			nodeInfo.coCd		= $('#coCd_S').val();
	  			nodeInfo.salesCd	= $('#salesCd_S').val();
	  			nodeInfo.salesCdTo	= $('#salesCd_S').val();  //Target sales Code 230720 추가
	  			nodeInfo.parentId	= targetNodeId;
	  			nodeInfo.upperCd	= targetNode.original.lowerCd;
	  			nodeInfo.upperKey	= targetNodeId;
	  			nodeInfo.childId	= copiedNodeId;
	  			nodeInfo.lowerCd	= copiedNode.original.lowerCd;
	  			nodeInfo.lowerKey	= copiedNodeId;
	  			nodeInfo.changeYn	= "N";    // 도면번호에 SalesCd 변경 여부임 변경없을경우 'N'
	  			nodeInfo.userId		= jwt.userId;
	  			nodeInfo.pgmId		= $('#pgmId').val();
	  			//백엔드 서비스단에서 재귀호출을 통합 하위 복사로 대체함
// 				var getAllChilds = getAllChildNodeIds(copiedNodeId); //재귀호출 기능을 백단으로 이동 처리함
				nodeInfoArr.push(nodeInfo);
// 				nodeInfoArr = nodeInfoArr.concat(getAllChilds);
		
	  			postAjax("/user/bm/bm14/copyBomTree", nodeInfoArr, null, function(data){
	  				alert(data.resultMessage);
	 				if(data.resultCode == 200){
		  				$('#deptTree').jstree(true).settings.core.data = selectDeptTree();
					} else {
						//오류처리 트리를 원복해야함
					}
	  				$('#deptTree').jstree(true).refresh();
	  			});  
  			}
  		    
  		    
  		}).on('move_node.jstree', function(e, data){
  		// 노드 이동완료 시
 
  			$('#deptTree').jstree(true).deselect_all();
  			$('#deptTree').jstree(true).select_node(data.node.id);
  			
  			var curParent = $('#deptTree').jstree(true).get_node(data.parent);
  			var oldParent = $('#deptTree').jstree(true).get_node(data.old_parent);
  		
  			// 정렬순서 변경 - 현재 부모의 자식
  			$.each(curParent.children, function(idx, item){
  				var childNode = $('#deptTree').jstree(true).get_node(item);
  				childNode.original.sortNo = idx + 1;
  			});
  			
  			// 정렬순서 변경 - 이전 부모의 자식
  			$.each(oldParent.children, function(idx, item){
  				var childNode = $('#deptTree').jstree(true).get_node(item);
  				childNode.original.sortNo = idx + 1;
  			});
  			
  			var deptInfoArr = [];
  			$.each(oldParent.children, function(idx, item){
  				var childNode = $('#deptTree').jstree(true).get_node(item);
  				var deptInfo = {};
  				deptInfo.deptId 	= childNode.id;
  				deptInfo.upDeptId 	= childNode.parent;
  				deptInfo.sortNo 	= childNode.original.sortNo;
  				deptInfo.upperCd 	= childNode.original.upperCd;
  				deptInfo.userId		= jwt.userId;
  				deptInfo.pgmId		= $('#pgmId').val();
  				
  				deptInfoArr.push(deptInfo);
  			});
  			
  			if(curParent != oldParent){
  				$.each(curParent.children, function(idx, item){
  					var childNode = $('#deptTree').jstree(true).get_node(item);
  					var deptInfo = {};
  					deptInfo.deptId 	= childNode.id;
  					deptInfo.upDeptId 	= childNode.parent;
  					deptInfo.sortNo 	= childNode.original.sortNo;
	  				deptInfo.upperCd 	= childNode.original.upperCd;
	  				deptInfo.userId		= jwt.userId;
	  				deptInfo.pgmId		= $('#pgmId').val();
	  				
  					deptInfoArr.push(deptInfo);
  				});				
  			}
  			
  			postAjax("/user/bm/bm14/moveBom", deptInfoArr, null, function(data){
//   				alert(data.resultMessage);
  				$('#deptTree').jstree(true).settings.core.data = selectDeptTree();
  				$('#deptTree').jstree(true).refresh();
  			});
  		});
  	}

	// BOM 정보 set
	function setBomInfo(node){
//         var paramObj = {
//                 "coCd" : $('#coCd_S').val(),
//                 "actionType" : 'C',
//                 "node" : node
//             };
//             openSecondModal("/static/html/user/bm/bm1401P01.html", 600, 400, "BOM 등록", paramObj, function (formData){
//                 var checkedId = formData.get_checked()[0];
//                 var checkedNode = formData.get_node(checkedId);
//             });
// 		var $deptTree = $("#deptTree").jstree(true);
		
	}
		
	// BOM 트리 데이터 select
	function selectDeptTree() {
		var deptTree = null;
		var paramObj = {
			"coCd": $("#coCd_S").val(),
			"salesCd": $("#salesCd_S").val()
		};
		postAjaxSync("/user/bm/bm14/selectBomTreeList", paramObj, null, function(data){
			deptTree = data.result;
		});
		return deptTree;
	}
		
	// Tree dnd check
	function checkOperation(operation, node, parent, position, more){
// 		console.log(operation, node, parent, position, "more:", more, "more.core:", more.core);
		if (more && more.core) { // 노드가 드랍되었을 때
			if(operation == "move_node"){
// 				console.log(operation, node, parent, position, "more:", more, "more.core:", more.core);
				
				if (!$("#bomUpdateBtn").length) return false; //수정버튼이 없는 사용자는 작업권한이 없어 수정 못함
				if(node.id == "new"){
					alert("신규로 추가한 BOM을 저장해 주세요.");
					return false;
				}else{
					// 자식노드중에 같은게 있는지 확인
					const result = isNodeNameExists(parent, node.text);
		    		if (result) {
		    			$("#deptTree").jstree().search(node.text,true,false,parent.id);
		    			alert("동일한 아이템이 존재합니다.");
		    			$('#deptTree').jstree(true).refresh();
		  				return false;
			   		} 	
		    		
					var confirmMessage = "BOM을 이동하시겠습니까?";
					if(!confirm(confirmMessage)){
						return false;
					}
				}
			} else if(operation == "create_node"){
			} else if(operation == "copy_node"){
// 				console.log(operation, node, parent, position, "more:", more, "more.core:", more.core);
				if (!$("#bomUpdateBtn").length) return false; //수정버튼이 없는 사용자는 작업권한이 없어 수정 못함

				// 노드가 드랍되었을 때
				// 자식노드중에 같은게 있는지 확인
				const result = isNodeNameExists(parent, node.text);
	    		if (result) {
	    			$("#deptTree").jstree().search(node.text,true,false,parent.id);
	    			alert("동일한 아이템이 존재합니다.");
	    			$('#deptTree').jstree(true).refresh();
	  				return false;
		   		} 			
			
			}
		} //if (more && more.core)
	}  	// function

	// BOM 생성, 수정
	function createBom(actionType){
		if (!$("#bomUpdateBtn").length) return false; //수정버튼이 없는 사용자는 작업권한이 없어 수정 못함
		var $deptTree = $("#deptTree").jstree(true);
		if(!$deptTree.get_node('new')){
			var bomId = $deptTree.get_selected()[0];
			var parentNode = $deptTree.get_node(bomId);
// 			$("#deptTree").jstree("open_all", bomId);  //해당노드 열기 실행
			if(parentNode){
		        var paramObj = {
		                "coCd" : $('#coCd_S').val(),
		                "actionType" : actionType,
		                "fromJob"   :  'tree',
		                "node" : parentNode,
		                "rowData" : '',
		            };
		            openSecondModal("/static/html/user/bm/bm14/BM1401P02.html", $('body').width(), $('body').height()-40, "BOM 등록", paramObj, function (formData){
						$('#deptTree').jstree(true).settings.core.data = selectDeptTree();
		            	$('#deptTree').jstree(true).refresh();
		            });				
			}else{
				alert("상위 BOM을 선택해 주세요.");
			}
			
		}else{
			alert("신규로 추가한 BOM을 저장해 주세요.");
		}
	}	


	// 신규조직 생성
	function gridFromCreateBom(selectRow){
		if(selectRow){
	        var paramObj = {
	                "coCd" : $('#coCd_S').val(),
	                "actionType" : 'U',
	                "fromJob"   :  'grid',
	                "node" : '',
	                "rowData" : selectRow,
	            };
	            openSecondModal("/static/html/user/bm/bm14/BM1401P02.html", $('body').width(), $('body').height()-40, "BOM 등록", paramObj, function (formData){
					$('#deptTree').jstree(true).settings.core.data = selectDeptTree();
	            	$('#deptTree').jstree(true).refresh();
	            });				
		}
	}	

	function  deleteBom() {
		if (!$("#bomDeleteBtn").length) return false; //삭제버튼이 없는 사용자는 작업권한이 없어 삭제 못함
		var node = $('#deptTree').jstree(true).get_selected()[0];
		var currNode = $("#deptTree").jstree(true).get_node(node);
		if (currNode.original.pchsBomCnt > 0) {
			alert("구매 BOM 등록이 완료되었습니다. 구매담당자에게 확인 바랍니다.")
			return false; 
		}
		if (confirm(currNode.text + "삭제하시겠습니까?")) {
			var paramObj = {
				"coCd"        : $('#coCd_S').val(),
				"salesCd"     : $('#salesCd_S').val(),
				"fileTrgtKey" : node,
				"upperKey"    : currNode.original.parent,
				"lowerKey"    : currNode.original.id
			}
			postAjax("/user/bm/bm14/deleteBom", paramObj, null, function(data) {
				if (data.resultCode == 200) {
					// alert(data.resultMessage);
					$('#deptTree').jstree(true).settings.core.data = selectDeptTree();
					$('#deptTree').jstree(true).refresh();
				} else {
  					alert(data.resultMessage);
  				}
  			});
		}
  	}
	
	//완료확인 (노드ID, Y or N)
	function  confirmBom(_node, _flag) {
		let msg = _flag == 'Y' ? "BOM 작업완료로 설정" : "BOM 작업완료 취소";
		let selText = _node.original.lowerCd + "(" + _node.original.matrNm + ") "
		if (confirm(selText + msg + " 하시겠습니까?")) {
			var paramObj = {
				"coCd"        : $('#coCd_S').val(),
				"salesCd"     : $('#salesCd_S').val(),
				"cnfCheck"    : _flag,
				"lowerKey"    : _node.id
			}
		
			postAjax("/user/bm/bm14/confirmBom", paramObj, null, function(data){
				if (data.resultCode == 200) {
					$('#deptTree').jstree(true).settings.core.data = selectDeptTree();
					$('#deptTree').jstree(true).refresh();
				} else {
  					alert(data.resultMessage);
  				}
			});
		}
	}
	
    //Sales Code (수주마스터, 수주상세테이블 조인) 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
                "coCd" : $('#coCd_S').val(),
                "salesCd": $('#salesCd_S').val(),
                "searchValue": $('#salesCd_S').val()
        };
	    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
	    	var row = grid.target.getList("selected")[0];
            $('#salesCd_S').val(row.salesCd);
            $('#ordrsNo').val(row.ordrsNo);
            $('#prdtCd').val(row.prdtCd);
            $('#prdtCdNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
            $('#eqpNm').val(row.eqpNm);
            $('#clntPjt').val(row.clntPjt);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#clntCd_S').val(row.ordrsClntCd);
            $('#clntNm_S').val(row.ordrsClntNm);
            
            initDeptTree();
        });
    }	
    
    function treeExpandClose(selector) {
    	selector = selector ? selector : "deptTree" ;
    	var node = $('#' + selector).jstree(true).get_selected()[0];
    	node = node ? node : "#" ;
    	// 특정 노드의 펼침/접힘 상태 확인
    	var isOpen = $('#' + selector).jstree("is_open", node);
    	if (isOpen) {
    	  //console.log("노드가 펼쳐져 있습니다.");
    	  $('#' + selector).jstree("close_all", node)
    	} else {
    	  //console.log("노드가 접혀 있습니다.");
    	  $('#' + selector).jstree("open_all", node)
    	}

    	var iconElement = $("#treeExpandBtn i");
    	var currentClass = iconElement.attr("class");
 	  
		if (currentClass == "fas fa-chevron-down") {
			iconElement.removeClass("fas fa-chevron-down");
			iconElement.addClass("fas fa-chevron-up");
		} else if (currentClass == "fas fa-chevron-up") {
			iconElement.removeClass("fas fa-chevron-up");
			iconElement.addClass("fas fa-chevron-down");
		}    	
    	
    }

    
	// 특정 노드 아래에 있는 자식 노드들 중에서 특정 노드명이 있는지 체크
    function isNodeNameExists(node, nodeName) {
		if (!node || !node.children.length) { // 해당 노드가 없거나 자식 노드가 없는 경우
			return false;
		}
		
		let result = false;
		node.children.forEach(childNodeId => {
		    const childNode = $("#deptTree").jstree(true).get_node(childNodeId);
		    if (childNode.text === nodeName) {
		      result = true;
		      return false; // break the loop
		    } 
		});
		
		return result;
	}    
    
//  	// 특정 노드의 모든 하위 노드 ID 구하기 ---백엔드에서 처리함
// 	function getAllChildNodeIds(nodeId) {
// 		var tree = $('#deptTree').jstree(true);
// 		var nodeInfo = [];
		
// 		var currNode = tree.get_node(nodeId);
// 		var childNodesArr = tree.get_node(nodeId).children;
		
// 		for (var i = 0; i < childNodesArr.length; i++) {
// 			var childNodeId = childNodesArr[i];
// 			var childNode = tree.get_node(childNodeId);
			
// 			var childInfo = {
// 				coCd: $('#coCd_S').val(),
// 				salesCd: $('#salesCd_S').val(),
// 				parentId: nodeId,
// 				upperCd: currNode.original.lowerCd,
// 				upperKey: currNode.original.fileTrgtKey,
// 				childId: childNodeId,
// 				lowerCd: childNode.original.lowerCd,
// 				lowerKey: childNode.original.fileTrgtKey
// 			};
		
// 			nodeInfo.push(childInfo);
// 			//재귀호출
// 			var grandChildNodeInfo = getAllChildNodeIds(childNodeId);
// 			nodeInfo = nodeInfo.concat(grandChildNodeInfo);
// 		}
		
// 		return nodeInfo;
//     }    
 	
 	function jsonToExcel (grid) {
 		const list = grid.target.getList();
 		const header = grid.target.colGroup;
 		exportJSONToExcel(list, header, '설계BOM(' + $('#salesCd_S').val() + ')', true);
 	}

 	//세일즈코드 단위로 복사할때 사용함
	function copyBom() {
		var paramObj = {
			"coCd"			: $('#coCd_S').val(),
			"salesCd_from"  : $('#salesCd_S').val()
		}
		openModal("/static/html/user/bm/bm14/BM1401P03.html", 600, 470, "", paramObj, (callbackObj) => {
			Object.assign(callbackObj, {
				bilgCertNoArr : '',
				userId : jwt.userId,
				userNm : jwt.userNm,
				deptId : jwt.deptId,
			});			
// 			postAjax("/user/ar/ar04/insertTaxHdUpdate", callbackObj, null, function(data){
// 				alert(data.resultMessage);
// 				if(data.resultCode == 200){
// 					gridView.setData(0);
	 				modalStack.close();
// 				}
// 			});
		});		
	}
 	
	//엑셀 업로드
	function excelUpload() {
        var paramObj;
        openModal("/static/html/user/bm/bm14/BM1401P04.html", 1600, 850, "", paramObj, function(grid) {
		});
	}

    function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}
    

	//Part List 출력
	function setReportMulti(_type = "") {
		var selectedNodeIds = $('#deptTree').jstree('get_selected');
		debugger;
		var targetPart = 'ALLPART';	//파트리스트 출력시 특정파트만 지정 가능하게 하기 위함.
		if (selectedNodeIds.length != 0 ) {
			//선택 노드중 첫번째 자료를 가져옴.		
			var selectedNode = $('#deptTree').jstree('get_node', selectedNodeIds[0]);
			/* Sample Data
				    "original": {
				        "parent": "#",
				        "id": "28616",
				        "upperCd": "#",
				        "lowerCd": "24000-00DUMMY",
			        
			        "original": {
			            "parent": "28616",
			            "id": "47211",
			            "upperCd": "24000-00DUMMY",
			            "lowerCd": "7000",
	        */
	        if (selectedNode.type == 'leaf') {
	        	selectedNode = $('#deptTree').jstree('get_node', selectedNode.parent);
	        }
			if (selectedNode.parent != '#') { //트리 top 노드임
				targetPart = selectedNode.original.lowerCd;
			}
		}
			     
          
	  	var fileName = "BM1401R01.jrf";
	  	var arg =  
	  		  "coCd#"		+  $('#coCd_S').val()
	  	    + "#salesCd#"	+  $("#salesCd_S").val()
	  	    + "#partCd#"	+  targetPart
	      	+ "#userId#"	+  jwt.userId
	      	+ "#";                 

	  	if (_type == '' || _type == undefined ) {
	  		callReport(fileName, arg, 1150, 720, 'PartList');
	  	} else { //Export 작업
	  		ubiExportAjax(fileName, arg, function(response) {
	  			if (response.resultCode === 200) {
	  				var base64FileData = response.base64FileData;
	  				var fileName = response.exportFileName;
	  				downloadPDFFromBase64(base64FileData, fileName);
	  			} else {
	  				alert('PDF 내보내기 실패: ' + response.resultText);
	  			}

	  		});
	  	}
	  }    


	function selectSalesCdSearchOrderInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"ordCoCd"	: $('#coCd_S').val(),
			"salesCd"	: $('#salesCd_S').val()
		}
		postAjax("/user/cr/cr02/salesCdSearchOrderInfo", formData, null, function(data) {
			if (data.result == undefined) {
				$('#clntNm_S').val("");
				$('#clntPjt').val("");
				$('#clntPjtNm').val("");
				$('#prdtCd').val("");
				$('#prdtCdNm').val("");
				$('#itemDiv').val("");
				$('#itemDivNm').val("");
				$('#ordrsNo').val("");
				$('#eqpNm').val("");
			} else {
				$('#clntNm_S').val(data.result.ordrsClntNm);
				$('#clntPjt').val(data.result.clntPjt);
				$('#clntPjtNm').val(data.result.clntPjtNm);
				$('#prdtCd').val(data.result.prdtCd);
				$('#prdtCdNm').val(data.result.prdtCdNm);
				$('#itemDiv').val(data.result.itemDiv);
				$('#itemDivNm').val(data.result.itemDivNm);
				$('#ordrsNo').val(data.result.clntPjtNm);
				$('#eqpNm').val(data.result.eqpNm);
			}
		});
	}
	  
	</script>
  </body>
</html>