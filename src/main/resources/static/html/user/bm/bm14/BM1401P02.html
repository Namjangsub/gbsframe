<style>
.highlight {
  color: red;
}
</style>
<body>
  <div class="container-fluid">
      <div class="row">
        <div class="popup_area">
          <form  id="popForm" onSubmit="return false;">
            <div  class="form-group popup_table">
		      <input type="hidden" id="coCd"  		name="coCd">
		      <input type="hidden" id="pgmId"     	name="pgmId" value="BM1401M01">
		      <input type="hidden" id="userId"     	name="userId" >
              <table>
		        <colgroup>
		          <col width="10%">
		          <col width="20%">
		          <col width="10%">
		          <col width="20%">
		          <col width="10%">
		          <col width="20%">
		          <col width="10%">
		          <col width="20%">
		        </colgroup>
 
                <tbody>
                  <tr>
						<th colspan= "1">SalesCode</th>
						<td>
							<input type="text" id="salesCd" name="salesCd"  readonly>
							</select>
						</td>
						<th colspan= "1">고객사</th>
						<td>
							<input type="text" id="clntNm" name="clntNm"  readonly>
						</td>
						<th colspan= "1">프로젝트</th>
						<td>
							<input type="text" id="prjctNm" name="prjctNm"  readonly>
							</select>
						</td>
						<th colspan= "1">fileTrgtKey</th>
						<td>
							<input type="text" id="fileTrgtKey" name="fileTrgtKey"  readonly>
						</td>
                  </tr>
                  <tr>
						<th colspan= "1">도면번호</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="upperDsgnNo" name="upperDsgnNo"  readonly>
							</div>
						</td>
						<th colspan= "1">형번</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="matrMno" name="matrMno"  readonly>
							</div>
						</td>
						<th colspan= "1">설비명</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="lowerEqpNm" name="lowerEqpNm"  readonly>
							</div>
						</td>
						<th colspan= "1">수주번호</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="ordrsNo" name="ordrsNo"  readonly>
							</div>
						</td>

				  </tr>
                  <tr>
						<th colspan= "1">품명</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="upperNm" name="upperNm"  readonly>
							</div>
						</td>
						<th rowspan="1">규격</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="matrSpec" name="matrSpec"  readonly>
							</div>
						</td>
						<th colspan= "1">제조사</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="matrMakrNm" name="matrMakrNm"  readonly>
							</div>
						</td>
						<th colspan= "1">BOM 코드</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="upperCd" name="upperCd"  readonly>
							</div>
						</td>
				  </tr>
                  <tr>
				  </tr>
                  <tr>
						<th colspan= "1">수량</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="lowerQty" name="lowerQty"  readonly>
							</div>
						</td>
						<th colspan= "1">단위</th>
						<td colspan= "1">
					   		<div class="search_form">
					    	  <input type="text" id="lowerUnit" name="lowerUnit"  readonly>
							</div>
						</td>
						<th colspan= "1">비고</th>
						<td colspan= "3">
					   		<div class="search_form">
					    	  <input type="text" id="matrRmk" name="matrRmk"   readonly>
							</div>
						</td>
				  </tr>
                  <tr>
						<td colspan= "8">
					   		<div class="search_form">
					    	  <input type=text readonly>
							</div>
						</td>
				  </tr>
                  <tr>
						<th rowspan="1" class="hit">하위 BOM 종류</th>
						<td >
							<div>
								<INPUT type=radio name="matrYn" value="N" checked> 도면 　　　　
								<INPUT type=radio name="matrYn" value="Y"> 자재품번
							</div>
						</td>
						<th colspan= "1" style="height:30px;">자동 채번 </th>
						<td colspan= "1">
							<div style="margin-left:50px; text-align: left; " >
								<INPUT type=radio  name="autoNo" value="Y" checked> 자동 　　　　
								<INPUT type=radio  name="autoNo" value="N"> 수동							
							</div>
						</td>
						<th colspan= "1" style="height:30px;">도번 자동 생성 </th>
						<td colspan= "1">
							<div style="margin-left:50px; text-align: left; " >
								<div>
								<INPUT type=radio  name="autoDrgNo" value="Y" checked> 자동 　
								<INPUT type=radio  name="autoDrgNo" value="N"> 수동
								</div>							
							</div>
						</td>　　
						<th colspan= "1" style="height:30px;">도면자동Prifix</th>
						<td colspan= "1">
					    		<input type="text" id="rptDrgNo_T" name="rptDrgNo_T">　
						</td>
				  </tr>
                </tbody>

              </table>
            </div>

          </form>

		<!-- 콘텐츠 -->
			<div class="contents">
			    <!-- 리스트 -->
			    <div class="ax5_grid">
	              <div class="table_list_tit">
	                  <h5 class="tit">BOM 하위 내용</h5>
	                  <div class="add_btn_small">
	                      <a onclick= "insertChildList()" style="width: 90px;" authchk><i class="fas fa-folder-plus"></i> BOM추가</a>
	                      <a onclick= "openMatListSearch();" style="width: 90px;" authchk><i class="fas fa-money-check"></i> 자재검색 </a>
	                      <a onclick= "deleteChildList()" style="width: 90px;" authchk><i class="fas fa-trash"></i> BOM삭제 </a>
	                  </div>
	              </div>
	              <div>
	              	<div data-ax5grid="parents-grid" data-ax5grid-config="{}" style="height:650px; width: 100%" ></div>
	              </div>
			  </div>
			</div>



        <div class ="popup_bottom_btn">
          <!--  <button id="checkBtn" type="button" class="bg_g fs-5" onclick="checkOverLap()">중복체크</button> -->
          <button type="button"  onclick="executeCallbackLast();" id ="actionBtn3" authchk></button>
          <button type="button"  onclick="modalStack.close();">닫기</button>

        </div>
        </div>
      </div>
    </div>
</body>

<script type="text/javascript">
	ax5.ui.grid.formatter["changeYn"] = function () {
		var color = this.value == "N" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E") {
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};

	function gridStyle(row) {
		if (!row) return "";
		if (row.updChk === "D")  return "grid-font-red";
		if (row.matrError === "E")  return "grid-no-msg-font-blue-bold";
		if (pasFloatChk(row.lowerQty) == 0)  return "grid-no-msg-font-blue-bold";
		if (pasFloatChk(row.pchsBomCnt) > 0)  return "grid-font-red";
		return "";
	}
	
	var paramActionType = modalStack.last().paramObj.actionType;
	var thisGridRow=0; // 선택된 행 정보 저장할 변수
	var thisGridCol=0; // 선택된 열 정보 저장할 변수
	var matModalOpen = false;  //형변 변경시 자재코드 자동 실행되게 처리함
	
	var childGridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: true,
				sortable: false,
				target: $('[data-ax5grid="parents-grid"]'),
				header: {
					align: "center",
					selector: true
				},
				body: {
					onClick: function (columnIndex, rowData) {
						this.self.clearSelect();
						this.self.select(this.dindex);
						prdtIdx = this.dindex;
						thisGridRow = this.dindex;   // 선택된 행 정보 가져오기
						thisGridCol = this.colIndex; // 선택된 열 정보 가져오기
						
						var clickedRowIndex = this.dindex;
						var clickedRowElement = this.self.bodyRowTable;
						
						// 선택된 행의 글자색을 변경
						$(clickedRowElement).addClass("highlight");
					},
					onDBLClick: function () {
						this.self.clearSelect();
						this.self.select(this.dindex);
						if (this.item.matrYn == 'Y')  {
							openMatListSearch();
						}
						if (this.column.key == "matrCd") {
							openMatListSearch();
						}
					},
					onDataChanged: function () {
						if (this.key == "lowerCd") {
							if($('input[name="autoNo"]:checked').val() == 'Y') {
								// 자동체번 체크했을 때,
								if (this.value.length < 4) {
									this.list[this.dindex].lowerCd	= (this.value).padStart(3, '0');
								}
							}
							
							if($('input[name="autoDrgNo"]:checked').val() == 'Y') {
								this.list[this.dindex].dsgnNo = creatDsgnNo(this.list[this.dindex]);
							}							
							childGridView.target.repaint();   //수정내용 적용하기
						} else if (this.key == "matrMno") {
							//같은창을 계속 open 하는데 처리방법은?
// 							if (!matModalOpen) openMatListSearch();
							this.list[this.dindex].matrCd = "";
							this.list[this.dindex].matrUnitCdNm = "";
							this.list[this.dindex].matrError = "";
							this.list[this.dindex].matrErrorText = "";
						}

						if (this.item.__selected__ == true) {
							prdtIdx = this.dindex;
						}
					},
				},
				columns : [
// 					{key : "updChk", 	label : "updChk", 			width : 60,},
					{key : "lowerCd", 	label : "하위코드", 			width : 80,						editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrNm", 	label : "품명", 				width : 240,	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrMno", 	label : "형번/규격", 			width : 220, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrMat", 	label : "소재/제조사", 		width : 100, 					editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "lowerUnit", label : "단위", 				width : 50, 					editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "lowerQty", 	label : "수량", 				width : 50, 					editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrSpec", 	label : "규격", 				width : 80, 					editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrRmk", 	label : "비고", 				width : 200, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrYn", 	label : "자재", 				width : 50, 					editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "dsgnNo", 	label : "도면번호", 			width : 210, 	align: "left", 	editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "matrCd", 	label : "자재코드", 			width : 90, 	styleClass: function () { return gridStyle(this.item); } },
					{key : "matrUnitCdNm", label : "단위", 			width : 50, 					editor: { type: "text", disabled: function () { return this.item.changeYn === "Y" || pasFloatChk(this.item.pchsBomCnt) > 0; } }, styleClass: function () { return gridStyle(this.item); } },
					{key : "changeYn", 	label : "구매수정", 			width : 80, 	formatter: "changeYn" },
		            {key: "pchsBomCnt", 	label: "BOM", 		width: 40,align: "center",  formatter: function () { return this.value > 0 ? "BOM" : ""}},
			        //    ,{key : "matrMakrNm",  	label : "제조사(Maker)",  width : 100,	hidden: true,  editor: {type: "text"},  styleClass: function () { return gridStyle(this.item); }}
			        //    ,{key : "matrUnitCd",  	label : "단위",    		width : 50,		hidden: true,  editor: {type: "text"}, 	styleClass: function () { return gridStyle(this.item); }}
			        //    ,{key : "avlbStrtDt", 	label : "유효시작",   		width : 100,	hidden: true,  editor: {type: "text"}, 	styleClass: function () { return gridStyle(this.item); }}
			        //    ,{key : "avlbEndDt", 	label : "유효종료",   		width : 100,	hidden: true,  editor: {type: "text"}, 	styleClass: function () { return gridStyle(this.item); }}
			        //    ,{key : "updChk", 		label : "수정구분",   		width : 100,	hidden: true, 	styleClass: function () { return gridStyle(this.item); }}
			        //    ,{key : "fileTrgtKey",  	label : "키값",   		width : 30,		hidden: true}
			        //    ,{key : "lowerKey",  	label : "하위코드",   		width : 30,		hidden: true}
		            {key : "matrErrorText", label : "오류내용", 			width : 120},
		            {key : "matrError", 	label : "구매수정", 			width : 80,  hidden: true},
				],
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 2, label: "줄추가"},
						// {type: 3, label: "내용 삭제"},
						{type: 4, label: "줄삭제"},
					],
					popupFilter: function (item, param) {
						//console.log(item, param);
						if(param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param) {
						// console.log(item, param);
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;
						
						if (item.label == "붙여넣기") {
							gridPaste(thisGridRow,thisGridCol);
						} else if (item.label == "줄추가") {
							// console.log('추가 인덱스 :', param.dindex);
							//.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
							//깊은 복사를 해야 값이 바뀌지 않음~~~~주의 필요
							let tempRow = JSON.parse(JSON.stringify(childGridView.target.list[param.dindex]));
							tempRow.updChk  		= "I";
							tempRow.fileTrgtKey  	= 0;
							tempRow.pchsBomCnt  	= 0;
							tempRow.lowerKey  		= "";
							tempRow.matrCd 		= "";
							tempRow.matrUnitCd	= "";
							tempRow.matrUnitCdNm	= "";
							tempRow.matrError	= "";
							tempRow.matrErrorText	= "";
// 							childGridView.target.addRow($.extend({}, childGridView.target.list[param.dindex], {__index: undefined}),param.dindex+1,);
							childGridView.target.addRow(tempRow,param.dindex+1,);
// 							childGridView.target.setValue(param.dindex+1, 'updChk', "I");
// 							childGridView.target.setValue(param.dindex+1, 'fileTrgtKey', 0);
// 							childGridView.target.setValue(param.dindex+1, 'pchsBomCnt', 0);
// 							childGridView.target.setValue(param.dindex+1, 'lowerKey', "");
							
							// } else if (item.label == "내용 삭제") {
							// 	console.log('내용삭제 인덱스 :', param.dindex);
							// 	childGridView.target.config.columns.forEach((column) => {
							// 		childGridView.target.setValue(param.dindex, column.key, '');
							// 		console.log('내용삭제 :', param.dindex, column.key);
							// 	});
							// 	childGridView.target.setValue(param.dindex, 'updcheck', "D");
						} else if (item.label == "줄삭제") {
							// console.log('삭제 인덱스 :', param.dindex);
							// var list = childGridView.target.getList("selected");
							// $.each(list, function(idx, obj){
								// 	childGridView.target.select(obj.__index);  //선택된 모든 row 선택 해제
								// });
							childGridView.target.clearSelect();	//선택된 모든 row 선택 해제
							childGridView.target.select(param.dindex);	//현재 클릭한 row 선택
							//삭제시에는 그리드에서 사라지므로 별도 처리 필요함  메모리에 담았다가 최종 DB단 삭제 로직 처리 해야함.
							// childGridView.target.removeRow(param.dindex);
							deleteChildList();
						}
						childGridView.target.contextMenu.close();
						//또는 return true;
					}
				},        // contextMenu
			});
			return this;
		},
		setData: function(chk) {
			var target = this.target;
			var formData = {
				"userId" 	: jwt.userId,
				"coCd" 		: $("#coCd").val(),
				"salesCd" 	: $("#salesCd").val(),
				"upperKey"	: $("#fileTrgtKey").val()
			}
			postAjax("/user/bm/bm14/selectBomlevelList", formData, null, function(data) {
				var list = data.result;
				if (list.some(obj => obj.matrYn == "Y")) {
					// 하위 BOM list 에서 matrYn의 값중에 "Y"가 하나라도 있으면 자재로 설정
					$('[name="matrYn"]').filter('[value="Y"]').prop("checked", true);
				}
				target.setData({
					list : list,
					page : {
						totalElements : list.length
					}
				});
			});
		} //setData
	}

	$(document).ready(function() {
		$("#userId").val(jwt.userId);
		$("#coCd").val(modalStack.last().paramObj.coCd);
		// $("#autoNo").prop("checked", true);  //하위코드 자동채번 설정
		
		if(paramActionType == 'U'){
			$('#actionBtn3').text("수정");
		}else if(paramActionType == 'C'){
			$('#actionBtn3').text("등록");
		}
		
		//상위코드 화면에 출력하기
		newPartInfo();
		
		childGridView.initView().setData();
		// childGridView.initView();
		
	    // 그리드 내용 붙여넣기 이벤트 처리-->간헐적 실행으로 오작동~~~ 원인을 모르겠음 아래이벤트로 대체
	    // Ctrl + V 단축키 이벤트 처리
		childGridView.target.$target.on("paste", function (e, a) {
			gridPaste(thisGridRow, thisGridCol);
		});
		$('#rptDrgNo_T').on('input', function(){
	        $(this).val($(this).val().toUpperCase());
	    });
		
		authChk("BM1401M01");
	});
	
	function newPartInfo(){
		var parentNode = "";
		if (modalStack.last().paramObj.fromJob == 'tree') {
			parentNode = modalStack.last().paramObj.node.original;
		} else {
			parentNode = modalStack.last().paramObj.rowData;
		}
		$('#salesCd').val(parentNode.salesCd);
		$('#popForm #ordrsNo').val(parentNode.ordrsNo);
		$('#upperCd').val(parentNode.lowerCd);
		$('#upperNm').val(parentNode.matrNm);
		$('#upperDsgnNo').val(parentNode.dsgnNo);
		$('#fileTrgtKey').val(parentNode.fileTrgtKey);
// 		$('#path').val(parentNode.path);
// 		$('#text').val(parentNode.text);
		$('#matrMno').val(parentNode.matrMno);
		$('#matrSpec').val(parentNode.matrSpec);
		$('#matrRmk').val(parentNode.matrRmk);
		$('#lowerUnit').val(parentNode.lowerUnit);
		$('#lowerQty').val(parentNode.lowerQty);
		$('#lowerCd').val('');
		$('#lowerNm').val('');
		$('#clntCd').val($('#clntCd_S').val()); //M01바닥화면에서 가져오기 M01
		$('#clntNm').val($('#clntNm_S').val()); //M01바닥화면에서 가져오기
		$('#prjctNm').val($('#clntPjtNm').val()); //M01바닥화면에서 가져오기
		$('#lowerEqpNm').val($('#eqpNm').val()); //M01바닥화면에서 가져오기

		if (parentNode.cnfCheck == 'Y') $('#actionBtn3').hide(); //작업완료 이면 수정 버튼 숨기기
		if (pasFloatChk(parentNode.pchsBomCnt) > 0) $('#actionBtn3').hide(); //구매BOM 생성된거면 수정 버튼 숨기기
	}

	function executeCallbackLast() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var noErr = true;
			var allRow = childGridView.target.getList();

			var duplicateValues = getDuplicateValues(allRow, 'lowerCd');
			if (duplicateValues.length > 0) {
				alert("하위코드가 값이 중복됩니다. \n\n" + duplicateValues);
				noErr = false;
			}
			let tempBomArr = childGridView.target.getList("modified");
			if (!tempBomArr.length) {
// 				alert("수정한 자료가 없습니다. ");
				noErr = false;
			}

			//**************************************************************
			//  구매품, 유공압품은 자재검색 필수 처리 Start
			//**************************************************************
			let chkDigit = /^[5-6][0-9]{2}.*/  //*  /^[5-6]\d{2}$/; */ //5 또는 6으로 시작하는 3자리 문자열인지 검사하는 정규식
			$.each(tempBomArr,function(rowIdx, list) {
				if (pasFloatChk(list.pchsBomCnt) > 0) {
					alert(list.lowerCd + "번은 구매BOM 작성 완료되어 수정할 수 없습니다.")
// 					noErr = false;
				}
				if (chkDigit.test(list.lowerCd)) {
// 					console.log("3자리 구매품");
					if (list.matrMno == undefined  || list.matrMno == ""){
// 						alert(list.lowerCd + "번은 구매품으로 형번/규격이 필요합니다.");
						childGridView.target.setValue(list.__index, 'matrError', 'E');
						childGridView.target.setValue(list.__index, 'matrErrorText', '형번/규격 없음');
						noErr = false;
					}

					if (list.matrError !="Y") { //자재검색 완료된것이 아니면 체크필요함
						//자재 형번/규격 검색처리
						var paramObj = { "matrMno" : list.matrMno };
						postAjaxSync("/user/bm/bm05/BOM_selectMatrMnoList", paramObj, null, function(data) {   
							if(data.resultList.length == 0 ) {	//형번규격이 검색되지 않음
// 								alert(list.lowerCd + "번은 구매품으로 형번/규격이 존재하지 않습니다. 확인 해 주세요.");
								childGridView.target.setValue(list.__index, 'matrError', 'E');
								childGridView.target.setValue(list.__index, 'matrErrorText', '형번/규격 없음');
								noErr = false;
							} else if(data.resultList.length == 1 ) {	//1건 정상 검색처리스
								childGridView.target.setValue(list.__index, 'matrCd', data.resultList[0].matrCd);
								childGridView.target.setValue(list.__index, 'matrMno', data.resultList[0].matrSpec);
								childGridView.target.setValue(list.__index, 'matrError', 'Y');
								childGridView.target.setValue(list.__index, 'matrErrorText', '');
							} else {	//1건이상 검색시 선택이 필요함
// 								alert(list.lowerCd + "번은 자재가 2개이상 중복됩니다. 자재코드를 선택해 주세요.");
								childGridView.target.setValue(list.__index, 'matrError', 'E');
								childGridView.target.setValue(list.__index, 'matrErrorText', '자재 2개이상 중복');
								noErr = false;
							}
					
						});   //자재 형번/규격 검색처리 end
					}
				}
			});
			//**************************************************************
			//  구매품, 유공압품은 자재검색 필수 처리 end
			//**************************************************************
			
			if (noErr) {
				var formData = makeFormData();
				filePostAjax("/user/bm/bm14/insertBomTree", formData ,function(data) {
					// alert(data.resultMessage);	
					if (data.resultCode == 200) {
						modalStack.last().callback(formData);
						modalStack.close();
					} else {
						alert(data.resultMessage);
					}
				});
			} else {
				childGridView.target.repaint();
			} 
		}
	}
	
	function makeFormData() {
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
// 		$.each($('.popup_area input[date]'), function(idx, elem) {
// 			deleteHyphen(elem);
// 		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//하위레벨 자료 수정된 자료만 arr 담기
		var modifyRow = childGridView.target.getList("modified");
		var updateRow = [];
		
		$.each(modifyRow,function(rowIdx, list) {
			list = escapeCha(list);
// 			for (var key in list) {
// 			    if (list.hasOwnProperty(key)) {
// 			        var value = list[key];
// 			        if ((typeof value) == "string") {
// 			        	value = value.replace(/%%C/g, "Ø"); //%%C --> Ø 문자로 대체하기
// 				        if ((value.indexOf("'") !== -1) || (value.indexOf('"') !== -1)) { // 문자열중에 '(작은따옴표) 또는 "(큰따옴표)문자가 있으면 /를 붙여서 쿼리 가능하게 수정
// 					        list[key] = value.replace(/'/g, "\'").replace(/"/g, '\"');
// 					        console.log(key + ": " + value, "After : " + list[key]);
// 				        }
// 			        }
// 			    }
// 			}
			
// 			list.lowerCd escapedQuery
			if (pasFloatChk(list.pchsBomCnt) > 0) {
				alert(list.lowerCd + "는 구매BOM 작성 완료되어 수정할 수 없습니다.")
			} else {
				if ((list.lowerCd == "") || (list.dsgnNo == "")) {
				} else {
				
					if (!list.updChk) {
						list.updChk = "U";
					}
					
					if (list.updChk == "D"  && list.fileTrgtKey == 0) {
	// 					console.log(list.updChk, list.fileTrgtKey)
					} else {
						if (list.updChk == "I") {
		        		 	if($('input[name="autoDrgNo"]:checked').val() == 'Y'){
		        		 		list.dsgnNo = creatDsgnNo(list);
		        		 	}
						}
						var dsgnNoDtl = dsgnNoSeparation(list.dsgnNo);	
						list.partNo =  dsgnNoDtl.parts;
						list.unitNo =  dsgnNoDtl.unitNo;
						list.revNo =  dsgnNoDtl.revNo;
						list.lowerQty = pasIntChk(list.lowerQty);
						updateRow.push(list);
					}
				}
			}
		});
		
		formData.append("updateRowArr", JSON.stringify(updateRow));
		formData.append("userId"		, jwt.userId);
		formData.append("coCd" 			, $("#coCd").val());
		formData.append("salesCd" 		, $("#salesCd").val());
		formData.append("matrNm" 		, $("#lowerNm").val());
		formData.append("upperCd" 		, $("#upperCd").val());
		formData.append("userId" 		, $("#userId").val());
		formData.append("pgmId" 		, $("#pgmId").val());
		formData.append("useYn" 		, "Y");
		formData.append("matrYn" 		, $('[name="matrYn"]:checked').val());
		formData.append("upperKey" 		, $("#fileTrgtKey").val());
		formData.append("ordrsNo" 		, $('#popForm #ordrsNo').val());
		return 	formData;
		
	}
	
	function insertChildList() {
		insertDetailGridRow();
		if ($('[name="matrYn"]:checked').val() == "Y") {
			openMatListSearch();
		}
	}	
	
	function insertDetailGridRow() {
		var newRow = childGridView.target.getList("selected")[0];
		if (!newRow) {
			newRow = childGridView.target.getList()[childGridView.target.list.length - 1];
		}
		
		if (!newRow) {
			newRow = {
			    "coCd"		: $("#coCd").val(),
			    "salesCd"	: $("#salesCd").val(),
			    "upperKey"	: $("#upperKey").val(),
			    "upperCd"	: $("#upperCd").val(),
			    "lowerCd"	: "000",
			    "dsgnNo"	: $("#upperDsgnNo").val(),
			    "partNo"	: "",
			    "unitNo"	: "",
			    "matrNm"	: "",
			    "useYn"		: "Y",
			    "matrYn"	: "N",
			    "creatId"	: $("#userId").val(),
			    "creatPgm"	: $("#pgmId").val(),
			    "lowerQty"	: 1,
			    "lowerUnit"	: "EA",
			    "matrCd"	: "",
			    "matrUnitCd": "",
			    "matrUnitCdNm"	: "",
			    "__original_index": 0
			}
		}
		newRow.updChk		= "I";
		newRow.fileTrgtKey 	= 0;
		newRow.pchsBomCnt 	= 0;
		newRow.lowerKey 	= "";
		newRow.matrCd 	= "";
		newRow.matrUnitCd	= "";
		newRow.matrUnitCdNm	= "";
		newRow.matrError	= "";
		newRow.matrErrorText	= "";
		
		if($('input[name="autoNo"]:checked').val() == 'Y'){ // 자동체번 체크했을 때,
			if (newRow.lowerCd.length == 3) {
				newRow.lowerCd	= (pasIntChk(newRow.lowerCd) + 1).toString().padStart(newRow.lowerCd.length, '0');
			} else {
				newRow.lowerCd	= (pasIntChk(newRow.lowerCd) + 1000).toString().padStart(newRow.lowerCd.length, '0');
			}
		}
		newRow.__index 		= "";
		newRow.dsgnNo = creatDsgnNo(newRow);
		var dsgnNoDtl = dsgnNoSeparation(newRow.dsgnNo);	
		newRow.partNo = dsgnNoDtl.parts;
		newRow.unitNo = dsgnNoDtl.unitNo;
		newRow.revNo  = dsgnNoDtl.revNo;
		
		childGridView.target.addRow($.extend({}, newRow), "last", {focus: "END"}); //focus 안먹힘??
		childGridView.target.focus("END");
	}	
	

	
	function pasIntChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseInt(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}

	function deleteChildList() {
		var delRow = childGridView.target.getList("selected");
		for(var i=delRow.length-1; i >= 0; i--){
			var list = delRow[i];
			if (list.fileTrgtKey) {
				childGridView.target.setValue(list.__index, "updChk", "D");
			} else {
				childGridView.target.removeRow(list.__index);
			}
		}		
// 		$.each(delRow,function(rowIdx, list) {
// 			if (list.fileTrgtKey) {
// 				childGridView.target.setValue(list.__index, "updChk", "D");
// 			} else {
// 				childGridView.target.removeRow(list.__index);
// 			}
// 		});
		childGridView.target.repaint();   //수정내용 적용하기
	}	

	
	
	//자재품번 검색
	function openMatListSearch(row) {
		if (!row) {
			// 해당 인덱스가 없으면 선택된 행의 인덱스 적용
			var gridRow = childGridView.target.getList("selected")[0];
			if (!gridRow) {
				return false;
			}
			row = gridRow.__index;
		}

		//선택행의 구매수정여부 지정
		var changeYn = childGridView.target.getList()[row].changeYn;
		if (changeYn == "Y") {
			return;
		}
		
		// if(gridDataValidation(bomGridView.target)) return;
		
		let tempSearchValue ="";
		if (gridRow) {
			if (gridRow.matrMno) { tempSearchValue = gridRow.matrMno == "-" ? "" : gridRow.matrMno; }  //형번 "BYGS10100-45H"
			else if (gridRow.matrMat) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (gridRow.matrMat == "-") ? "" : gridRow.matrMat;}  //소재 "SMC/부경금속"
// 			else if (gridRow.matrMno) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (gridRow.matrMno == "-") ? "" : gridRow.matrMno;}  //규격
			else if (gridRow.matrNm) {tempSearchValue = (tempSearchValue != "") ? tempSearchValue : (gridRow.matrNm == "-") ? "" : gridRow.matrNm;}  //자재명 "손잡이"
		}
		//자재 검색시 필드내용 전체 선택으로 변경 처리함
		var paramObj = {
			"coCd" : $('#coCd_S').val(),
			"searchValue" : tempSearchValue.replace(/ /g, '')
		}
		matModalOpen = true;	//자재형변변경시 한번만 실행되게 강제하기위함
		openThirdModal("/static/html/cmn/modal/multimatListSearch.html", 1200, 700, "자재 검색", paramObj, function (grid) {
			const allItm = grid.target.getList("selected");
			let index = 0;
			for (const newRow of allItm) {
				if (index) {
					insertDetailGridRow();
					const insertRow = childGridView.target.getList("selected")[0]
					row = insertRow.__index;
				}
				// childGridView.target.setValue(0, "a", "A-1");
				childGridView.target.setValue(row, "matrNm", newRow.matrNm);
				childGridView.target.setValue(row, "matrCd", newRow.matrCd);
				childGridView.target.setValue(row, "lowerUnit", newRow.matrUnitNm);
				childGridView.target.setValue(row, "matrUnitCd", newRow.matrUnit);
				childGridView.target.setValue(row, "matrUnitCdNm", newRow.matrUnitNm);
				childGridView.target.setValue(row, "matrMat", newRow.matrMat);
				childGridView.target.setValue(row, "matrMakrNm", newRow.matrMakrNm);
				childGridView.target.setValue(row, "matrMno", newRow.matrSpec);
				// childGridView.target.setValue(row, "matrSpec", newRow.matrSpec);
				childGridView.target.setValue(row, "matrYn", "N");
				if ($('[name="matrYn"]:checked').val() == "Y") {
					childGridView.target.setValue(row, "lowerCd", newRow.matrCd);
				}
				index=1;

				childGridView.target.setValue(row, 'matrError', 'Y');
				childGridView.target.setValue(row, 'matrErrorText', '');
			};	
			matModalOpen = false;	//자재형변변경시 한번만 실행되게 강제하기위함
		});
	}	
	
	//도면번호 자동 생성
	function creatDsgnNo(list) {
		if ($('[name="autoDrgNo"]:checked').val() == "N") {	//도번 수동 생성이면 패스
			return "";
		}
// 		if ($('[name="matrYn"]:checked').val() == "N") {	//하위코드가 도면이면  자재구분은 Clear 처리함
// 			list.matrYn = "";
// 		}
// 		let dsgnNo = (list.matrYn != "Y") ? "-" + list.lowerCd : "";

		let dsgnNo = "-" + list.lowerCd;
		let majorDsgnNo = $("#rptDrgNo_T").val();		//자동생성prifix
		if (majorDsgnNo == "")  majorDsgnNo = $("#upperDsgnNo").val(); 
		return majorDsgnNo + dsgnNo;
	}	
		
	//도면번호 분리
	function dsgnNoSeparation(str) {
		//ex) 23010-99TVFTE-1000-1100-1101, 
		//    23010-99TVFTE-1000-1100-1101-R1, 
		//    23010-99TVFTE-1000-1100-1101-501-R1
		//    23010-99TVFTE-1000-1100-1101-501-1-R1
		//    23010-99TVFTE-1000-1100-1101-501-2
		//	  2022-SEG-MX5A-NP00-HAFD1-1000-1100-1101
		//	  2022-SEG-MX5A-NP00-HAFD1-1000-1100-1101-R1
		//	  2022-SEG-MX5A-NP00-HAFD1-1000-1100-1101-501-R1
		//    23010-99TVFTE-1000-1100-1101-501-1-R1
		let parts = str.split("-");
// 		var unitNo = $.grep(parts, function(value) { return value.length === 3 && !value.includes("R");	})[0]; //3자리문자 중 'R'이 없는 문자 찾기
// 		var revNo = parts.filter(function(value) { return /^R/.test(value); })[0];  //R로 시작하는 문자 찾기
		let Rcode = str.match(/R[^-]{1,3}/g);  //R로 시작하는 문자 찾기
		let revNo = (Rcode == null) ? "" : Rcode[0];
		
	    let lastPartLen4 = "";
		let lastPartLen3 = "";
		
		for (let i = parts.length - 1; i >= 0; i--) {
			if (parts[i].length > 4) break;
			
		    if (parts[i].length == 4 && lastPartLen4 == "") {
		    	lastPartLen4 = parts[i];
		    } else if (parts[i].length == 3 && lastPartLen3 == "") {
		    	lastPartLen3 = parts[i];
		    } 
		
		    if (lastPartLen4 !== "" && lastPartLen3 !== "") {
		        break;
		    }
		}
		
		return {
			parts 	: lastPartLen4,
			unitNo	: lastPartLen3,
			revNo	: revNo
		}
	}


	function  gridPaste(thisGridRow,thisGridCol ) {
		var pasteData = "";
		
		navigator.clipboard.readText().then(pasteData => {
// 		    console.log('클립보드에 저장된 값:', pasteData);
				if (pasteData==undefined ||pasteData=="" || thisGridRow===undefined) {
						return;
				}
	
			  // 붙여넣기할 데이터를 배열로 변환한다.
			  pasteData = (pasteData.charAt(pasteData.length - 1) === "\n") ? pasteData : pasteData + "\n";
			  var pasteRows = pasteData.split("\n").map(function(row) {
			    	return row.split("\t");
			  });
			
			  // 붙여넣기를 시작할 셀의 인덱스를 구한다.
			  var startRowIndex = thisGridRow;
			  var startColIndex = thisGridCol;
				
			  // 붙여넣을 데이터의 행과 열 개수를 구한다.
			  var numRows = pasteRows.length;
			  var numCols = pasteRows[0].length;
			
			  // 붙여넣을 데이터가 그리드의 범위를 벗어나면 에러 메시지를 출력한다.
			//   if (startRowIndex + numRows > childGridView.target.getList().length || startColIndex + numCols > childGridView.target.config.columns.length) {
			//     alert("The pasted data is out of the grid's range.");
			//     return;
			//   }
			  var gridLength = childGridView.target.getList().length;
			  var gridColumns = childGridView.target.config.columns;
			  // 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
			  for (var i = 0; i < numRows-1; i++) {
			        if (startRowIndex + i >= gridLength) {
			        	childGridView.target.addRow($.extend({"updChk":"I"}, childGridView.target.list[thisGridRow], {__index: undefined}));
						childGridView.target.setValue(startRowIndex + i, 'matrError', '');
						childGridView.target.setValue(startRowIndex + i, 'matrErrorText', '');
			        	gridLength = childGridView.target.getList().length;
			        }
	
			        for (var j = 0; j < numCols; j++) {
			    		var calRow = startRowIndex + i;
				    	var calCol = startColIndex + j;
				    	//carriage return 문자 삭제
				    	var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');
			        
				    	if (calCol >= gridColumns.length) {
					    	childGridView.target.addColumn();
				    	}
			        
				    	childGridView.target.setValue(calRow, gridColumns[calCol].key, cellData);
				    }
			  }
			  childGridView.target.repaint();
	
		});	  
	};	
	
	
	function getDuplicateValues(arr, key) {
		const countMap = {};
		const duplicates = [];
		for (let i = 0; i < arr.length; i++) {
			if (arr[i]["updChk"] != "D") { 
				const value = arr[i][key];
				
				if (countMap[value]) {
					countMap[value]++;
					if (countMap[value] === 2) {
						duplicates.push(value);
					}
				} else {
					countMap[value] = 1;
				}
			}
		}
		
		return duplicates;
	}	

	//list 배열에서 특수 문자를 처리하기 '(싱글쿼테이션), "(더블쿼테이션), %%C --> Ø 문자 교체
	function escapeCha(list) {
		for (var key in list) {
		    if (list.hasOwnProperty(key)) {
		        var value = list[key];
		        if ((typeof value) == "string") {
		        	list[key] = value.replace(/%%C/g, "Ø"); //%%C --> Ø 문자로 대체하기
			        if ((value.indexOf("'") !== -1) || (value.indexOf('"') !== -1)) { // 문자열중에 '(작은따옴표) 또는 "(큰따옴표)문자가 있으면 /를 붙여서 쿼리 가능하게 수정
				        list[key] = value.replace(/'/g, "\'").replace(/"/g, '\'');
// 				        console.log(key + ": " + value, "After : " + list[key]);
			        }
		        }
		    }
		}	
		return list;
	}
	

    function pasFloatChk (ivalue) {
		let value = ivalue +' ';    	
		const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다. 
		return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
	}
</script>