<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">자재마스터 등록</h4>
	</div>
	
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
			<input type="hidden" id="userId"      name="userId">
			<input type="hidden" id="pgmId"       name="pgmId" value="BM0501P01">
			<table>
				<colgroup>
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
					<col width="11%">
					<col width="14%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th class="hit coCd">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" class="form-control input-sm" required msg="회사"></select>
					</td>

					<th>품번</th>
					<td>
						<input type="text" id="matrCd" name="matrCd" class="form-control" readonly="readonly">
					</td>

					<th class="hit">품명</th>
					<td colspan="3">
						<input type="text" id="matrNm" name="matrNm" class="form-control" required msg="품명">
					</td>
				</tr>
				
				<!-- 2행 -->
				<tr>
					<th class="hit">품목구분</th>
					<td>
						<select id="goodsDiv" name="goodsDiv" data-kind="GOODSDIV" class="form-control input-sm" required msg="품목구분">
							
						</select>
					</td>
					
					<th class="hit">자재분류</th>
					<td>
						<select id="matrClntDiv" name="matrClntDiv" data-kind="MATRCLNTDIV" class="form-control input-sm" required msg="자재분류"></select>
					</td>
					
					<th>자재유형</th>
					<td>
						<select id="matrDiv" name="matrDiv" data-kind="MATRDIV" class="form-control input-sm"></select>
					</td>
					
					<th>자재그룹</th>
					<td>
						<select id="matrGrp" name="matrGrp" data-kind="MATRGRP" class="form-control input-sm"></select>
					</td>
				</tr>
				
				<!-- 3행 -->
				<tr>
					<th>소재/Maker</th>
					<td>
						<input type="text" id="matrMat" name="matrMat" class="form-control">
					</td>

<!-- 					<th>Maker</th> -->
					<th>관리담당자</th>
					<td>
		                <div class="search_form">                  
							<input type="hidden" id="matrMngId" name="matrMngId"  data-search="matrMngId" msg="관리담당자ID" >
		                   	<input type="text"   id="matrMngIdNm" name="matrMngIdNm" data-search="matrMngIdNm" class="form-control" msg="관리담당자" 
		                   	       onkeyup="event.keyCode == 8 ? matrMngId.value = '' : ''">
		                	<a onclick="openUserSearch();"><i class="i_search_w" id="userIdBtn"></i></a>
		                </div>
					</td>
					
<!-- 					<th>규격</th> -->
					<th></th>
<!-- 					<td> -->
						<input type="hidden" id="matrMakrNm" name="matrMakrNm" class="form-control">
						<input type="hidden" id="matrMno" name="matrMno" class="form-control">
 					</td> 
					
					<!-- 기능버튼 -->
					<td colspan="3" style="text-align: left">
						<div>
							<button type="button" id="nrm_btn1" class="btn btn-default btn-sm" style="height: 25px; line-height: 15px;" onclick="NrmBtn(this.id);">Ø</button>
							<button type="button" id="nrm_btn2" class="btn btn-default btn-sm" style="height: 25px; line-height: 15px;" onclick="NrmBtn(this.id);">X</button>
							<button type="button" id="nrm_btn3" class="btn btn-default btn-sm" style="height: 25px; line-height: 15px;" onclick="NrmBtn(this.id);">T</button>
							<button type="button" id="nrm_btn4" class="btn btn-default btn-sm" style="height: 25px; line-height: 15px;" onclick="NrmBtn(this.id);">/</button>
							<button type="button" id="nrm_btn5" class="btn btn-default btn-sm" style="height: 25px; line-height: 15px;" onclick="NrmBtn(this.id);">-</button>
						</div>
					</td>
				</tr>
				
				<!-- 4행 -->
				<tr>
					<th>형번/규격</th>
					<td>
						<input type="text" id="matrSpec" name="matrSpec" class="form-control">
					</td>

					<th>관리단위</th>
					<td>
						<select id="matrUnit" name="matrUnit" data-kind="UNITDIV" class="form-control input-sm"></select>
					</td>

					<th>사이즈</th>
					<td>
						<input type="text" id="matrSize" name="matrSize" class="form-control">
					</td>

					<th>중량 (kg)</th>
					<td>
						<input type="text" id="matrWt" name="matrWt" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
				</tr>
				
				<!-- 5행 -->
				<tr>
					<th>구매업체1</th>
					<td><input type="hidden" id="pchsClntCd1" name="pchsClntCd1" msg="구매업체1">
						<div class="search_form" style="width: 100%;">
							<input type="text" id="pchsClntNm1" name="pchsClntNm1"
							 onkeyup="event.keyCode == 8 ? pchsClntCd1.value='' : event.keyCode == 13 ? ClntSearch('P', '1') : '' "> 
							<a onclick="ClntSearch('P', '1');"><i class="i_search_w"></i></a>
						</div>
					</td>

					<th>구매/외주</th>
					<td>
						<select id="matrPurcDiv" name="matrPurcDiv" data-kind="MATRPURCDIV" class="form-control input-sm"></select>
					</td>					

					<th>대표도번</th>
					<td>
						<input type="text" id="matrDrwNo" name="matrDrwNo" class="form-control">
					</td>					

					<th>2D설계소요일</th>
					<td>
						<input type="text" id="dsgn2dMd" name="dsgn2dMd" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
					
				</tr>

				<!-- 6행 -->
				<tr>
					<th>발주비율1</th>
					<td>
						<input type="text" id="pchsClntPct1" name="pchsClntPct1" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>					

					<th>재고관리여부</th>
					<td>
						<select id="matrStockCd" name="matrStockCd" class="form-control input-sm">
							<option value="Y">관리</option>
							<option value="N">미관리</option>
						</select>
					</td>

					<th>원산지</th>
					<td>
						<input type="text" id="originNm" name="originNm" class="form-control">
					</td>
					
					<th>2D평균소요일</th>
					<td>
						<input type="text" id="avrg2dMd" name="avrg2dMd" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>					
				</tr>

				<!-- 7행 -->
				<tr>
					<th>구매업체2</th>
					<td><input type="hidden" id="pchsClntCd2" name="pchsClntCd2" msg="구매업체2">
						<div class="search_form" style="width: 100%;">
							<input type="text" id="pchsClntNm2" name="pchsClntNm2"
							 onkeyup="event.keyCode == 8 ? pchsClntCd2.value='' : event.keyCode == 13 ? ClntSearch('P', '2') : '' "> 
							<a onclick="ClntSearch('P', '2');"><i class="i_search_w"></i></a>
						</div>
					</td>

					<th>입고검사구분</th>
					<td>
						<select id="matrTestDiv" name="matrTestDiv" data-kind="MATRTESTDIV" class="form-control input-sm"></select>
					</td>
					
					<th>최소발주량</th>
					<td>
						<input type="text" id="minOrdrgQty" name="minOrdrgQty" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>

					<th>3D설계소요일</th>
					<td>
						<input type="text" id="dsgn3dMd" name="dsgn3dMd" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
				</tr>

				<!-- 8행 -->
				<tr>
					<th>발주비율2</th>
					<td>
						<input type="text" id="pchsClntPct2" name="pchsClntPct2" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
					
					<th>설계대상구분</th>
					<td>
						<select id="dsgnTrgtYn" name="dsgnTrgtYn" class="form-control input-sm">
							<option value="Y">대상</option>
							<option value="N">미대상</option>
						</select>
					</td>
					<th>안전재고</th>
					<td>
						<input type="text" id="matrSaftQty" name="matrSaftQty" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
					
					<th>3D평균소요일</th>
					<td>
						<input type="text" id="avrg3dMd" name="avrg3dMd" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
				</tr>

				<!-- 9행 -->
				<tr>
					<th>구매업체3</th>
					<td><input type="hidden" id="pchsClntCd3" name="pchsClntCd3" msg="구매업체3">
						<div class="search_form" style="width: 100%;">
							<input type="text" id="pchsClntNm3" name="pchsClntNm3"
							 onkeyup="event.keyCode == 8 ? pchsClntCd3.value='' : event.keyCode == 13 ? ClntSearch('P', '3') : '' "> 
							<a onclick="ClntSearch('P', '3');"><i class="i_search_w"></i></a>
						</div>
					</td>

					<th class="hit">사용여부</th>
					<td>
						<select id="useYn" name="useYn" class="form-control input-sm" required msg="사용여부">
							<option value="Y">사용</option>
							<option value="N">미사용</option>
						</select>
					</td>

					<th>리드타임</th>
					<td>
						<input type="text" id="dlvrRqmDay" name="dlvrRqmDay" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>

					<th>최종생산소요일</th>
					<td>
						<input type="text" id="prdctnRqmMd" name="prdctnRqmMd" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
				</tr>

				<!-- 10행 -->
				<tr>
					<th>발주비율3</th>
					<td>
						<input type="text" id="pchsClntPct3" name="pchsClntPct3" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>

					<th>최종구매단가</th>
					<td>
						<input type="text" id="matrUpr" name="matrUpr" class="form-control" onkeyup="onlyNumber(this)" comma>
					</td>
					
					<th>최종거래일자</th>
					<td>
						<input type="text" id="matrLastTrstDt" name="matrLastTrstDt" class="form-control" >
					</td>

					<th>평균생산소요일</th>
					<td>
						<input type="text" id="prdctnAvrgMd" name="prdctnAvrgMd" class="form-control" comma onkeyup="onlyNumber(this);" >
					</td>
				</tr>
				<!-- 11행 -->
				<tr>
					<th>비고</th>
					<td colspan="7">
						<textarea rows="3" id="matrRmk" name="matrRmk" class="form-control"  msg="비고"></textarea>
					</td>
				</tr>
			</table>
		</form>
	</div>
	

	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
</div>

<!-- 하단 버튼 -->
<div class ="popup_bottom_btn">
	<button type="button" id="actionBtn" authChk>등록</button>
	<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
</div>

<script type="text/javascript">
	// debugger;
	var actionType = null;
	var fileTrgtKey = null;
	
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		// setByCoCd(modalStack.last().paramObj.coCd);
		setByCoCd('GUN');

		$("#popForm #userId").val(jwt.userId);
		
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		
		
		//수정 모드 데이터 가져오기  (목록에서 Row를선택하고 생성클릭시 기본 입력자료 공유)
		select_bm05_Info();
		
		if (actionType == "C") {
			
			$('#popForm .coCd').addClass('hit');
			$('#popForm input#coCd').attr('required', 'required');
			
			//버튼명 변경
			$("#actionBtn").text("등록");

			//버튼 클릭 시
			$('#actionBtn').on("click", function() {
				insert_bm05();
			});
		} else if (actionType == "U") {
			
			//타이틀명 변경
			$('.tit').text('자재마스터 수정')
			
			//회사
			//$("#coCd").prop("disabled", true);			
			$('#popForm .coCd').removeClass('hit');
			$('#coCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//품번
			$("#matrCd").prop("readonly", true);

			//수정 모드 데이터 가져오기
// 			select_bm05_Info();
			
			//버튼명 변경
			$('#actionBtn').text("수정");

			//버튼 클릭 시
			$('#actionBtn').on("click", function() {
				update_bm05();
			});
		}
		
		//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: $("#popForm #pgmId").val(),
			fileTrgtKey : fileTrgtKey
		}
		
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		authChk(); //권한체크
	});
	
	//입력정보
	function select_bm05_Info() {
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		
		postAjax("/user/bm/bm05/select_bm05_Info", formData, null, function(data) {
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
			});
			if (actionType == "C") {
				// 신규 입력시 초기필드 clear 
				$('#popForm #fileTrgtKey').val(''); //fileTrgtKey
				$('#popForm #matrCd').val(''); //품번
				$('#popForm #matrNm').val(); //품명
				$('#popForm #matrMngId').val(jwt.userId); //관리담당자
				$('#popForm #matrMngIdNm').val(jwt.userNm); //관리담당자
				$('#popForm #matrUpr').val(''); //최종구매단가
				$('#popForm #matrLastTrstDt').val(''); //최종거래일자
			}
		});
	}
	
	// 등록
	function insert_bm05() {
		if (inputValidation($('.popup_area [required]'))) {		// 필수 필드의 유효성 검사
			var formData = makeFormData();						// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			
			filePostAjax("/user/bm/bm05/insert_bm05", formData,	// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
			            function(data) {
							if (data.resultCode == 200) {		//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
// 								gridView.setData(0);
								modalStack.last().callback(data.resultCode);
								modalStack.close();				// 모달을 닫음
							} else {
								alert(data.resultMessage);			// 결과 메시지를 alert으로 출력
							}
						}
			);
		}
	}
	
	// 수정
	function update_bm05() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			
			filePostAjax("/user/bm/bm05/update_bm05", formData,function(data) {
				if (data.resultCode == 200) {
// 					gridView.setData(0);
					modalStack.last().callback(data.resultCode);
					modalStack.close();					
				} else {
					alert(data.resultMessage);
				}
					
			});
		}
	}
	
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
// 		console.log(formData);
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		//formData.append("clntCd", $('#vendCd').val());			//첨부화일용
		//formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		//formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		//formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------
		return formData;
	}

	// 버튼 클릭 시 규격값 + 처리
	// 규격 버튼
	function NrmBtn(buttonId) {
		const matrSize = $('#matrSize').val();
		
		if (buttonId === "nrm_btn1") {
			// ∅ 파이 : &#8709;
			//$('#matrSpec').val(matrSpec + '∅'); // ?로 들어감
			$('#matrSize').val(matrSize + "Ø");
		} else if(buttonId === "nrm_btn2") {
			// X
			$('#matrSize').val(matrSize + "X");
		} else if(buttonId === "nrm_btn3") {
			// T
			$('#matrSize').val(matrSize + "T");
		} else if(buttonId === "nrm_btn4") {
			// /
			$('#matrSize').val(matrSize + "/");
		} else if(buttonId === "nrm_btn5") {
			// -
			$('#matrSize').val(matrSize + "-");
		}
		$('#matrSize').focus();
	}

	// 거래처 검색
	function ClntSearch(openType, gbn) {
		var paramObj;
		//debugger;
		if (gbn == "1") {
			paramObj = {"searchValue" : $("#pchsClntNm1").val()}
		} else if (gbn == "2") {
			paramObj = {"searchValue" : $("#pchsClntNm2").val()}
		} else if (gbn == "3") {
			paramObj = {"searchValue" : $("#pchsClntNm3").val()}
		}
		
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			if(gbn == "1"){
				$('#pchsClntCd1').val(row.clntCd);
				$('#pchsClntNm1').val(row.clntNm);
			}else if(gbn == "2"){
				$('#pchsClntCd2').val(row.clntCd);
				$('#pchsClntNm2').val(row.clntNm);
			}else if(gbn == "3"){
				$('#pchsClntCd3').val(row.clntCd);
				$('#pchsClntNm3').val(row.clntNm);
			}
		});
	}
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	  
    // 관리담당자 검색 //  
    function openUserSearch() {
    	var tempId ="";
    	var tempNm ="";
    	
    	if ($('#matrMngId').val()=="") {
    		tempId = jwt.userId;
    		tempNm = jwt.userNm;
    	} else {
    		tempId = $('#matrMngId').val();
    		tempNm = $('#matrMngIdNm').val();
    	} 
    		
        var paramObj = {
             "coCd" : $('#coCd').val(),
           "userId" : tempId,
           "userNm" : tempNm,
           "useYn": "Y"
        };
        openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
                 var checkedId = tree.get_checked()[0];
                 var checkedNode = tree.get_node(checkedId);

                 $('#matrMngId').val(checkedNode.id);
                 $('#matrMngIdNm').val(checkedNode.text);
              });
    } 	
</script>