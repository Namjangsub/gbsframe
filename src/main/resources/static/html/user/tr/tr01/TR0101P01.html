<style>
    .checkbox-container input[type="checkbox"] {
        vertical-align: text-top;
        margin-left: 10px;/* 선택 박스와 텍스트 사이의 간격 조정 */
    }
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">배차관리 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="TR0101P01">
 		<table>

        <colgroup>
          <col width="10%">
          <col width="23%">
          <col width="11%">
          <col width="23%">
          <col width="10%">
          <col width="23%">
        </colgroup>

        <tr>
			<th class="hit">회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" class="form-control" required msg="회사">
				</select>
			</td>
            <th class="hit" title="담당자 정보를 확인합니다">담당자</th>
            <td>
                <div class="search_form">
                    <input type="text" id="transMngIdNm" name="transMngIdNm" onkeydown="if(event.keyCode==13)openUserTree( this.value);" required>
                    <input type="hidden" id="transMngId" name="transMngId" required msg="담당자"> <a onclick="openUserTree( document.getElementById('transMngIdNm').value);"><i class="i_search_w"></i></a>
                </div>
            </td>
			<th>등록번호</th>
			<td>
				<input type="text"  id="fileTrgtKey" name="fileTrgtKey" readonly="readonly">
			</td>
		</tr>
		<tr>
			<th class="hit">운송일자</th>
			<td>
				<input id="transDt" name="transDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date onchange="monthCloseChk(this.value,'', $('#coCd').val());">
			</td>
			<th class="hit">수주번호</th>
			<td>
				<div class="search_form" >
					<input type="hidden"  id="transOrdrsCoCd" name="transOrdrsCoCd" readonly>
					<input type="text"  id="transOrdrsNo" name="transOrdrsNo" readonly required msg="수주번호">
					<a onclick="popOpendOrdrsSearch($('#ordrsNo').val(), $('#coCd').val());"><i class="i_search_w" ></i></a>
				</div>
			</td>
			<th>프로젝트명</th>
			<td>
				<input type="text" id="ctrtNm" name="ctrtNm" msg="프로젝트명" class="form-control"> 
			</td>

        </tr>
        <tr>
        	<th></th>
        	<td></td>
			<th>고객사</th>
			<td>
				<input type="hidden" id="custCd" name="custCd" readonly msg="고객사"> 
				<input type="text" id="custNm" name="custNm" msg="고객사" class="form-control"> 
			</td>
			<th>고객사PJT</th>
			<td><input type="hidden" id="clntPjt" name="clntPjt" msg="고객사PJT">
				<input type="text" id="clntPjtNm" name="clntPjtNm" msg="고객사PJT" class="form-control"> 
			</td>
        </tr>

        <tr>
			<td colspan="6"></td>
        </tr>
        
			
        <tr>
			<th class="hit">출발지</th>
			<td>
				<div class="search_form">
					<input type="hidden" id="transFrom" name="transFrom" msg="출발지">
					<input type="text" id="transFromNm" name="transFromNm" onkeyup="event.keyCode == 8 ? transFrom.value = '' : event.keyCode == 13 ? clntSearch('F') : ''" required msg="출발지">
						<a onclick="clntSearch('F');"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th class="hit">운송구분</th>
			<td>
	            <select id="transType" name="transType" class="form-control"  data-kind="TRANSTYP" required msg="운송구분">
<!-- 	            	<option value="">선택</option> -->
	            </select>
			</td>
        	<th></th>
        	<td></td>
        </tr>
        <tr>
			<th class="hit">도착지</th>
			<td>
				<div class="search_form">
					<input type="hidden" id="transTo" name="transTo" msg="도착지">
					<input type="text" id="transToNm" name="transToNm"onkeyup="event.keyCode == 8 ? transTo.value = '' : event.keyCode == 13 ? clntSearch('T') : ''" required msg="도착지">
						<a onclick="clntSearch('T');"><i class="i_search_w"></i></a>
				</div>
			</td>
			<th class="hit">운송업체</th>
			<td>
				<div class="search_form">
				<input type="hidden" id="transClntCd" name="transClntCd" required msg="운송업체">
					<input type="text" id="transClntCdNm" name="transClntCdNm"  onkeyup="event.keyCode == 8 ? transClntCd.value = '' : event.keyCode == 13 ? clntSearch('V') : ''" required msg="운송업체">
						<a onclick="clntSearch('V');"><i class="i_search_w"></i></a>
				</div>
			</td>
        	<th></th>
        	<td></td>
<!-- 			<th>결제방법</th> -->
<!-- 			<td> -->
<!-- 	            <select id="ctrtClmnDivCd" name="ctrtClmnDivCd" class="form-control" msg="결제방법"> -->
<!-- 	            	<option value="CLMNDIV04" data-rprc="MON" data-etc="1" data-desc="수금조건" data-dz-code="undefined">익월</option> -->
<!-- 	            </select> -->
<!-- 			</td> -->
        </tr>

        <tr>
<!-- 			<th>지급조건</th> -->
<!-- 			<td> -->
<!-- 	            <select id="ctrtPmntMtdCd" name="ctrtPmntMtdCd" class="form-control" data-kind="PMNTMTD" msg="지급조건"> -->
<!-- 	            </select> -->
<!-- 			</td> -->
        </tr>

        <tr>
<!-- 			<th class="hit">결제일자</th> -->
<!-- 			<td> -->
<!-- 	            <select id="transClmnDay" name="transClmnDay" class="form-control" required msg="결제일자"> -->
<!-- 	            	<option value="10">10일 결제</option> -->
<!-- 	            	<option value="25" selected>25일 결제</option> -->
<!-- 	            </select> -->
<!-- 			</td> -->
        </tr>

        <tr>
			<td colspan="6"></td>
        </tr>
        <tr>
			<th class="hit">차량유형</th>
			<td>
	            <select id="transVehicle" name="transVehicle" class="form-control" data-kind="TRANSDIV" required msg="차량유형">
	            	<option value="">선택</option>
	            </select>
			</td>
			<th class="hit">운송금액</th>
			<td>
				<input type="text" id="transAmt" name="transAmt" class="form-control" onkeyup="chechChange(this);" comma  required msg="운송금액">
			</td>
			<th>화물중량<br>(kg)</th>
			<td>
				<input id="transWeight" name="transWeight" class="form-control" onkeyup="chechChange(this);" comma msg="화물중량">
			</td>
        </tr>
        
        <tr>
<!-- 			<th class="hit">지급일자</th> -->
<!-- 			<td> -->
<!-- 				<input id="transPmntDt" name="transPmntDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date> -->
<!-- 			</td> -->
        </tr>
        
        <tr>
        	<th>비고</th>
			<td colspan="7">
				<textarea class="form-control" id="transRmk" name="transRmk" msg="비고" style="height: 60px;" maxlength="1000"></textarea>
			</td>			
        </tr> 
        
      	
      </table>
    </form>
	</div>

	<!-- 콘텐츠1 -->
	<div class="contents_tit">
		<!-- 리스트 -->
		<div class="ax5_grid">
			<div id="turnKeyGrid" class="ax5_grid" data-ax5grid="transTarget-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
		</div>
	</div>
	
	<!-- 공통 파일 영역 -->
	<div id="fileList_area" style="margin-bottom: 30px;"></div>
	

    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">

	/***********전역변수****************/
	let actionType = null;
	let fileTrgtKey = null;


	var transTargetGridView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                target: $('[data-ax5grid="transTarget-grid"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    onDataChanged: function () {
                    },
                },
                page: {
                    navigationItemCount: 9,
                    height: 30,
                    display: true,
                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange: function () {
                        transTargetGridView.setData(this.page.selectPage);
                    }
                },
				columns : [
					{key : "coCd", 			  label : "회사",          hidden : true},
					{key : "coCdNm", 		  label : "회사명",        align : "center", 	width : 80, hidden : true},
					{key : "ordrsNo", 		  label : "수주번호",      align : "center", 	width : 60},
					{key : "salesCd", 		  label : "Sales Code",   align : "left", 	width : 170},
// 					{key : "eqpNm", 		  label : "설비명",        align : "center", width : 240},
					{key : "eqpNm", 		  label : "설비명",        align : "left", 	width : "*"},
					{key : "chkSaveCd" ,	  label : "턴키여부",		align: "center",	width: 60, align: "center", formatter: function () { return this.value =="Y" ? "대상":""; }},
					{key : "ordrsClntCd", 	  label : "고객사",        hidden : true},
					{key : "ordrsClntNm", 	  label : "고객사명",      align : "left", width : "*"},
					{key : "clntPjt", 		  label : "고객사 PJT",    align : "center", width : 100, hidden : true},
					{key : "clntPjtNm", 	  label : "프로젝트",    	align : "center", width : 80, hidden : false},
					{key : "ordrsDtlDiv20",   label : "신작구분",      hidden : true},
					{key : "ordrsDtlDiv20Nm", label : "신작구분",      align : "center", width : 60},
					{key : "prdtCd", 		  label : "제품구분",      hidden : true},
					{key : "prdtCdNm", 		  label : "제품",        align : "left", width : 180},
					{key : "itemDiv", 		  label : "아이템구분",    align : "center", width: 100, hidden : true},
					{key : "itemDivNm", 	  label : "아이템",    align : "left", width: 120},
					{key : "orgnSalesCd", 	  label : "원 Sales Code", align : "left", width : 140},
				]
            });
            return this;
        },
		setData : function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {};
			paramObj.pageNo = _pageNo + 1;
			paramObj.recordCnt = 999999;

			paramObj.coCd = $("#transOrdrsCoCd").val();		
			paramObj.ordrsNo = $("#transOrdrsNo").val();
			paramObj.fileTrgtKey = $("#fileTrgtKey").val();
			var searchValue = paramObj.searchValue;
			var searchType  = paramObj.searchType;
			postAjax("/user/tr/tr01/selectTransTargetSalesCodeList", paramObj, null, function(data) {
				try {
					var list = data.result;
					$.each(list, function (idx, elem) {
						list[idx].__selected__ = elem.chkSaveCd=="Y" ? true : false;	//저장된 salesCd 이면 선택되게 변경 처리함
					});
					targetObj.setData({
						list : list,
						page : {
							totalElements : list.length,
						}
					});
					localgridResize(list.length+1); //그리드 높이 조정
				} catch {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		}
    };

	$(document).ready(function() {

		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#popForm #userId").val(jwt.userId);
		$("#popForm #transMngId").val(jwt.userId);
		$("#popForm #transMngIdNm").val(jwt.userNm);

		//처리일자//
		$('#transDt').datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true }).datepicker("setDate", new Date());
		$('#transPmntDt').datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true }).datepicker("setDate", new Date());
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;

	    transTargetGridView.initView();
		if (actionType == "C") {
			$("#actionBtn").text("등록");
			//참조키값이 있으면 자료를 불러옴.
			if (fileTrgtKey){
				selectTransInfo(fileTrgtKey);
				transTargetGridView.setData(0);
			}
			
			$('#actionBtn').on("click", function() {
				insertTrans();
			});

		} else if (actionType == "U") {
			$('.tit').text('배차관리 수정')
			selectTransInfo(fileTrgtKey);
			transTargetGridView.setData(0);
			
			$('#actionBtn').text("수정");
			$('#actionBtn').on("click", function() {
				updateTrans();
			});
		}

		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey		:fileTrgtKey
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		authChk();						// 권한체크

	});

	function selectTransInfo(_fileTrgtKey) {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" 	: _fileTrgtKey,
		}
		postAjaxSync("/user/tr/tr01/selectTransInfo", formData, null, function(data) {
			if (actionType == "C") {
				data.result.fileTrgtKey = 0;
				data.result.transAmt = 0;
				delete data.result.creatId;
				delete data.result.creatNm;
				delete data.result.creatPgm;
				delete data.result.creatDttm;
				delete data.result.udtId;
				delete data.result.udtNm;
				delete data.result.udtPgm;
				delete data.result.udtDttm;

			}
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
			});

//             var contractDetails = data.result.details;
//             transTargetGridView.setData({
//                 list: contractDetails,
//                 page: {
//                     totalElements: contractDetails.length
//                 }
//             });
			//마감체크
			monthCloseChk($('#transDt').val(), '', $('#coCd').val());
				
		});
	}



	 // 등록
	function insertTrans() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			if (formData) {
				filePostAjax("/user/tr/tr01/insertTrans", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);
							modalStack.close();									// 모달을 닫음
						}
					});
			} else {
				$('#transDt').val($('#transDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
				$('#transAmt').val(addCommaStr($('#transAmt').val()));
			}
		}
	}

	// 수정
	function updateTrans() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			if (formData) {
	      		filePostAjax("/user/tr/tr01/updateTrans", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
			} else {
				$('#transDt').val($('#transDt').val().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
				$('#transAmt').val(addCommaStr($('#transAmt').val()));
			}
		}
	}

	//----------------------------------------------//
	
	function makeFormData() {
		if (gPasFloatChk($('#transAmt').val()) == 0 ) {
			alert("운송금액을 입력하세요!");
			$('#transAmt').focus();
			return false;
		}
		
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		
		//---------------------------------------------------------------  
        
		//턴키 등록용 그리드 Sales Code 정보 
		let turnKeyList = transTargetGridView.target.getList("selected");
		if (turnKeyList.length > 0 ) {
			$.each(turnKeyList, function (idx, elem) {
				// 선택된 정보만 저장
				if (idx==0) firstSalesCd = turnKeyList[idx].salesCd; //SalesCd는 상세내역에 있음. 대표 세일즈코드 (선택된것중에 첫번째)
	        });
			formData.append("detailArr", JSON.stringify(turnKeyList));
		}
        //---------------------------------------------------------------  
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		return formData;
	}

	
	//  업체명 검색 //
	function clntSearch(openType) {
		//openType : F-> 출발지  T -> 도착지,  V -> 운송사
		let search = '';
		let div = '';
		if (openType == "F") { 
			search = $("#transFromNm").val();
			div = 'CLNTDIV01';
		} else if (openType == "T") {
			search = $("#transToNm").val();
			div = 'CLNTDIV04';
		} else {	//'V' 운송사
			search = $('#transClntCdNm').val();
			div = 'CLNTDIV10';
		}
		var paramObj = {
				"searchValue" :  search
				, "clntDivCd" : div					/*거래처 검색 기본값 고객사로 세팅 */
				, "pchsClntCd" : "CLNTDIV10"		/*구매처 팝업일 경우 구분자 고객사 제외하고 세팅 */				
		}	
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			if (openType == "F") {
				$('#transFrom').val(row.clntCd);
				$('#transFromNm').val(row.clntNm);
			} else if (openType == "T") {
				$('#transTo').val(row.clntCd);
				$('#transToNm').val(row.clntNm);
			} else {	//'V' 운송사
				$('#transClntCd').val(row.clntCd);
				$('#transClntCdNm').val(row.clntNm);
			}
		});
	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#transMngId').val(),
			"userNm": $('#transMngIdNm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			let checkedId = tree.get_checked()[0];
			let checkedNode = tree.get_node(checkedId);
			$('#transMngId').val(checkedNode.id);
			$('#transMngIdNm').val(checkedNode.text);
		});
	}
	
		
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	
	//수주번호 검색
    function popOpendOrdrsSearch(inputValue, coCd) {
        var paramObj = {
            "searchValue" : inputValue,
            "coCd" : coCd
        };
    	
        openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];

            $('#transOrdrsCoCd').val(row.coCd);
            $('#transOrdrsNo').val(row.ordrsNo);
            $('#custCd').val(row.ordrsClntCd);
            $('#custNm').val(row.clntNm);
            $('#clntPjt').val(row.clntPjtCd);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#ctrtNm').val(row.ctrtNm);

    		transTargetGridView.initView().setData(0);
        });
    }

    function chechChange(elm) {
    	elm.value = addCommaStr(gPasIntChk(elm.value));
    }

    function localgridResize(size) {
            let tagHeight = (size) * 27 + 25 ;
            tagHeight = tagHeight > 750 ? 750 : tagHeight;
            tagHeight = tagHeight < 300 ? 300 : tagHeight;
            
            transTargetGridView.target.setHeight(tagHeight);
    }
    
</script>