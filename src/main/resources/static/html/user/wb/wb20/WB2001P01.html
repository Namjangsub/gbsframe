<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 id="todotit" class="tit">TODO 결재</h4>
	</div>
	<div id="approval_area">

<script type="text/javascript">
var btnApproval = null;
var kakaoErr = [];
//div area id
var htmlParam = {htmlArea:"approval_area"};
//to-do 에서 넘어온 param;
var popParam = modalStack.last().paramObj;
//추가로 넣어줄 param
var approvalParam = {
					coCd:   modalStack.last().paramObj.coCd,
					issNo:  modalStack.last().paramObj.issNo,
					todoDiv1CodeId: modalStack.last().paramObj.todoDiv1CodeId,
					todoDiv2CodeId: modalStack.last().paramObj.todoDiv2CodeId,
					pgmId: modalStack.last().paramObj.pgmId
					};
// 타이틀 설정
$('#todotit').text(popParam.todoDiv2CodeNm + ' 결재');
//삭제할 키가 있으면 쓴다.
delete popParam.sanctnSn;
delete popParam.pgmId;
var commApproval = new Approval(htmlParam, approvalParam, popParam);
commApproval.makeHtml();
$('#main_area').css('padding', '0px');

function approvalConfirm() {
	$('#appConfirmAnchor').hide();
	if (commApproval.confirmApproval()) {
		if (typeof gridView !== 'undefined') {
			gridView.setData(0);
		}
		modalStack.last().callback("승인완료");
		modalStack.close();
		if (typeof todoGridView !== 'undefined') todoGridView.setData();  //데시보드 to-do list 갱신
		return true;
	}
	$('#appConfirmAnchor').show();
}

function approvalMemoComment() {
	$('#appConfirmAnchor').hide();
	if (commApproval.approvalMemoComment()) {
		if (typeof gridView !== 'undefined') {
			gridView.setData(0);
		}
		modalStack.last().callback("승인완료");
		modalStack.close();
		if (typeof todoGridView !== 'undefined') todoGridView.setData();  //데시보드 to-do list 갱신
		return true;
	}
	$('#appConfirmAnchor').show();
}


//최종결재시 결재완료 최초작성자(1번)에게 전송
function sendTodoFinal(param) {
	//message load
	if (kakaoErr.length == 0) {
		var paramObj = {
			"userId" : jwt.userId
			, "codeKind" : "KAKAOMSG"
		};
		postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
			if(data.resultList.length > 0 ) {
				kakaoErr = data.resultList;
			}
		});
	}

	//TODO 결재완료 알림톡
	let paramSend = {
			"tmplatDiv"		  : "TMPLATDIV05"				//발송템플릿관리번호
			, "todoDiv1CodeId": param.todoDiv1CodeId		//공통코드 해당업무 - 결재
			, "todoDiv2CodeId": param.todoDiv2CodeId		//공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "결재"						//공통코드 해당업무 - 결재 - 발주서
			, "todoDiv2CodeNm": param.todoDiv2CodeNm  		//공통코드 해당업무 - 결재 - 발주서 -- 템플릿 승인 후에는 삭제요망
			, "sanctnDiv2"	  : "결재"						//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo"	   	  : param.todoNo
			, "clntCd"		  : "1"							//발신회사는 로그인사용자 회사
			, "creatPgm"	  : param.pgmId
			, "sanctnSn"	  : "1"							//결재순번 1번을 결재상신자로 본다
			, "todoKey"		  : param.todoKey				//결재 고유 등록번호
			, "todoTitl"	  : param.todoTitl
			, "bigo"		  : (param?.bigo ?? '').trim()	//list.bigo = "보완요청";  결제 버튼 보완요청 처리시에만 전달됨
	}
	commKaKaoSendTodo(paramSend);
}

//to-do결재완료 메세지 알림톡
function commKaKaoSendTodo(param) {
	//알림톡 API헤더 정보
	let talkParam = {
		authToken 	: "e/eDfZOFCsrBqadaECQ0+g==",
		serverName 	: "gyitt2400",
		paymentType : "P",
	};
	let talkBody = {
		service :"2310086157",		//서비스번호(1000000000 - 예시  real : 2310086157
		template: "10009",			//템플릿관리화면 템플릿ID	- 10004 번 결재완료시 템플릿으로 교체요망
// 		buttons : [{				//알림톡 타이틀, 버튼 설정 필수
// 		        name		: "웹링크버튼",
// 		        type		: "WL",
// 		        url_pc		: "http://pc.com/111",
// 		        url_mobile	: "http://moible.com/222"
// 		      }]
	};
	let sendCnt = 0;

	postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodoCompleted", param, null, function(data) {
		if (data.resultList.length == 1 ) {
			if( data.resultList[0].maxMessageId == "" ) {
				alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
				return false;
			}
			let sendObj = data.resultList[0]; 	//결재완료 통보대상자 정보

			let mobile = sendObj.telNo; 		//수신인 휴대전화번호
			if(mobile == "" || mobile == null) {
				return false;
			}

			//message 치환
			let message = sendObj.messageDesc;	//발송될 내용 template
			if(message == "" || message == null) {
				return false;
			}
// 			let title = sendObj.name + " " + param.todoDiv2CodeNm   //sendObj.todoTitl;
			let title = "[" + param.todoDiv2CodeNm + " " + param.todoNo + "]"   //sendObj.todoTitl;
			if (title.length > 50) {
				title = title.substring(0, 49); // 50자까지만 자르기
			}
			title += " " + param.sanctnDiv2;
			param.rcvId = sendObj.todoId;			//todo 수신id
			param.rcvNm = sendObj.name;				//todo 수신자명
			param.nameTo = jwt.userNm;				//from 발신자명
			param.sendDt = sendObj.sendDt;
			param.mobile = sendObj.telNo;			//수신번호
// 			param.bussinessCnts = sendObj.todoTitl + " " + param.cnts;
			param.bussinessCnts = `${(sendObj?.todoTitl ?? '').toString().trim()} ${(param?.cnts ?? '').toString().trim()}`.trim();
			param.cnts = title;

			const bigo = (param?.bigo ?? '').trim();	//보완요청건인지 체크하기 위함, "보완요청" --> 정상처리시 공백
			if (sendObj.todoCfOpn){
				if (bigo) {
					param.confirmCnts = `[${jwt.userNm} 보완요청 결재보류 코멘트: ${sendObj.todoCfOpn}]\n보류 확인`;
					param.cnts = title + " 보류 보완 요청";
				} else {
					param.confirmCnts = `[${jwt.userNm} 완료 코멘트: ${sendObj.todoCfOpn}]\n결재 확인`;
					param.cnts = title + " 확인 요청";
				}
			} else {
				param.confirmCnts = `[${jwt.userNm} ${param.sanctnDiv2} 완료 확인`;
				param.cnts = title + " 요청";
			}
			var todayDate = new Date().format('yyyy-MM-dd HH:mm');
			param.endDt = todayDate;
// 			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
// 			//loop
// 			$.each(splitStr, function (key, val) {
// 				let compKey = val.substring(1, val.length-1);
// 				if( compKey != "" && compKey != "undefined" ) {
// 					if( typeof(param[compKey]) != "undefined" ) {
// 						let val2 = '#'+val;
// 						message = message.replaceAll(val2, param[compKey]);
// 					}
// 				}
// 			});
			/*  내용 : #{cnts}
				업무 : #{bussinessCnts}
				요청일시 : #{sendDt}
				요청자 : #{rcvNm}
				#{confirmCnts} 바랍니다.
				(주)건양아이티티/051-312-2400
				
				내용 : [발주/출장요청 REQ2503169] 결재 요청 건
				업무 : 지상거래처,AK,출도(정상), 정상[발주/출장요청REQ2503169]
				요청일시 : 2025-10-31 14:46
				요청자 : 최지상
				[남장섭 보완요청 코멘트(결재보류):현재 대응상황 점검 확인후 별도 보고 바람.] 확인 바랍니다.
				(주)건양아이티티/051-312-2400
				*/
			// `{key}` 패턴을 찾아 `param` 객체에서 대응하는 값을 치환
			Array.from(message.matchAll(/\{(.*?)\}/g), match => match[1]).forEach(compKey => {
				if (compKey && param[compKey] !== undefined) {
					message = message.replaceAll(`#{${compKey}}`, param[compKey]);
				}
			});
			talkBody.messageId = sendObj.maxMessageId;			//고객사에서 관리하는 메시지No - 40byte (unique 값);
			talkBody.mobile = mobile;				//휴대전화번호
			talkBody.title = param.cnts;					//알림톡 타이틀 -
			talkBody.message = message;				//알림톡 메시지 (1000 byte)
// 			talkBody =  {"service": "2310086157","title":"[최지상 발주/출장요청REQ2503169] 자료보완 요청","message": "내용 : 최지상 지상거래처,AK,출도(정상), 정상[발주/출장요청REQ2503169] 요청 건\n업무 : 지상거래처,AK,출도(정상), 정상[발주/출장요청REQ2503169]\n\n요청일시 : 2025-10-31 14:46\n요청자 : 남장섭\n\n[최지상 보완요청 코멘트(결재보류):현재 대응상황 점검 확인후 별도 보고 바람.] 확인 바랍니다.\n\n(주)건양아이티티/051-312-2400","messageId":"KKO25053097","mobile": "01063393764","template": "10009","buttons":[{"name":"웹링크버튼","type":"WL","url_pc":"http://pc.com/111","url_mobile":"http://moible.com/222"}]}
			/*  최종 전대 메시지 JSON 형태
				{
				    "service": "2310086157",
				    "template": "10009",
				    "messageId": "KKO25053072",
				    "mobile": "01063393764",
				    "title": "자료보완 요청",
				    "message": "내용 : 최지상 지상거래처,AK,출도(정상), 정상[발주/출장요청REQ2503169] 요청 건\n업무 : 지상거래처,AK,출도(정상), 정상[발주/출장요청REQ2503169]\n\n요청일시 : 2025-10-31 14:46\n요청자 : 남장섭\n\n[최지상 보완요청 코멘트(결재보류):현재 대응상황 점검 확인후 별도 보고 바람.] 확인 바랍니다.\n\n(주)건양아이티티/051-312-2400",
				  }
			*/
			
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		}
		
	});	//user search ajax end
			
	//대상 loop end
	if( sendCnt > 0 ) {
// 		alert("알림톡 정상 발송되었습니다.");
	}
}

$(document).ready(function() {
})
</script>
