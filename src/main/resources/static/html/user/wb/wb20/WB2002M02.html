<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=no">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">

<script src="/static/js/jquery-latest.min.js"></script>
<script src="/static/js/jquery.serializeObject.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script src="/static/js/moment/moment-with-locales.js"></script>
<script src="/static/js/jstree/jstree.min.js"></script>
<script src="/static/js/ax5/ax5core.min.js"></script>
<script src="/static/js/ax5/ax5grid.min.js"></script>
<script src="/static/js/ax5/ax5mask.min.js"></script>
<script src="/static/js/ax5/ax5modal.min.js"></script>
<script src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5calendar.min.js"></script>
<script src="/static/js/ax5/ax5picker.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script src="/static/js/ax5/ax5formatter.min.js"></script>
<script src="/static/js/ax5/ax5combobox.min.js"></script>

<script src="/static/js/global.js"></script>
<script src="/static/js/jquery.blockUI.js"></script>
<!-- 도움말 팝업 -->
<script src="/static/js/manualPopup.js"></script>

<style>
	.add_btn_small {
		display: inline-block;
		padding: 0px;
	}

	.add_btn_small a {
		display: inline-block;
		width: 33px;
		height: 20px;
		line-height: 20px;
		text-align: center;
		color: #444;
		background: #ffffff;
		box-shadow: 1px 1px rgba(0, 0, 0, 0.15);
	}

	#userTree .jstree-open > .jstree-anchor > .jstree-checkbox,
	#userTree .jstree-closed > .jstree-anchor > .jstree-checkbox { display:none; }
	#userTree li[id^="GUN"] > .jstree-anchor > .jstree-checkbox,
	#userTree li[id^="TRN"] > .jstree-anchor > .jstree-checkbox { display: none !important; }

	/* 비활성화 셀 스타일 */
	.grid-cell-disabled {
		background-color: #e9e9e9 !important;
		color: #aaa !important;
		pointer-events: none;
	}
	.grid-cell-disabled input[type="checkbox"] {
		display: none !important;
	}
</style>
</head>
<body>
	<div id="head_area"></div>
    <div id="top_area"></div>
    <div id="main_area">
		<input type="hidden" id="pgmId"  name="pgmId" value="WB2002M01">
		<input type="hidden" id="userId" name="userId">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="gridView.setData();"><button class="bg_gray">검 색</button></a>
				</li>
			</ul>
		</div>
	<!-- 검색 콘텐츠 -->
	<div class="contents search">
		<div class="">
		<!-- 테이블 인풋 3분할 -->
		<table class="table_input type03">
			<tr>
				<th class="hit">회사</th>
				<td><select id="coCd_S" name="coCd_S" data-kind="CO" required="required" data-search="coCd" onchange="coCdChange();">
				</select></td>
				<th>사용자</th>
				<td>
					<input type="hidden" id="nodeId" name="nodeId" data-search="nodeId" style="width: 100%;">
					<input type="text" id="nodeName" name="nodeName" data-search="nodeName" onkeypress="if(event.keyCode == 13){searchUser();}">
					<a onclick="searchUser();">
						<i class="i_search_w"></i>
					</a>
				</td>
				<th></th>
				<td></td>
			</tr>
		</table>
		</div>
	</div>
	<!-- // 콘텐츠 -->

	<!-- 콘텐츠 -->
	<div class="contents no_bg">
		<!-- 콘텐츠 타이틀 -->
		<div class="contents_tit" style="margin: 0px;">
		<div class="add_btn_small pdl10" style="margin: 0px; padding: 0px;">
			<a onclick="toggleAllReceive();" style="height: 30px; line-height: 28px; width: 80px;"><i class="fas fa-check-square"></i> 전체선택</a>
			<a onclick="saveKakaoReceive();" style="height: 30px; line-height: 28px; width: 80px;" authchk><i class="fas fa-save"></i> 저장</a>
		</div>
		</div>
	</div>
	<!-- 콘텐츠 -->
	<div class="row" style="margin-top: 0px;">
	<div class="col-xs-2" style="padding-right: 5px;">
		<div class="contents" style="margin: 0px; padding: 0px; height: 755px; width: 100%; min-width: 200px">
		<h3 class="location">
			<span class="page_tit" style="text-align: left;"> 사용자</span>
		</h3>
			<div style="text-align: left;">
				<div id="userTree" style="overflow: auto; padding: 0 10px; height: 715px;"></div>
			</div>

		</div>
	</div>
	<div class="col-xs-10" style="padding-left: 0;">
		<div class="contents" style="margin:0px; padding:0px; height: 710px; width: 100%; min-width: 200px">
		<h3 class="location">
			<a class="name_tag" id="name_tag" style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
			<span class="page_tit" style="text-align: right;"> 카카오톡 수신차단여부 설정</span>
			<span style="color: #e74c3c; font-size: 12px; margin-left: 15px;">※ 체크 후 저장 시 해당 업무의 카카오톡 알림을 수신하지 않습니다.</span>
		</h3>
		<div class="contents" style="margin:0px;padding:0 5px;height:100%; width:100%; min-width:300px">
			<div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 100%;"></div>
		</div>
		</div>
	</div>
	</div>
<script type="text/javascript">

	var gridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showLineNumber: true,
				showRowSelector : false,
				multipleSelect : false,
				sortable : false,
				target: $('[data-ax5grid="first-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				columns: [
					{key: "taskNm", label: "업무명", width: 150, align: "left"},
					{
						key: undefined, 	label: "결재", columns: [
							{key: "apprReceiveYn", label: "수신", width: 60, align: "center",
								editor: { type: "checkbox", config: {height: 17, trueValue: "N", falseValue: "Y"}},
								styleClass: function() { return !this.item.apprCodeId ? "grid-cell-disabled" : ""; }
							},
							{key: "apprChkDttm", label: "변경일시", width: 140, align: "center",
								styleClass: function() { return !this.item.apprCodeId ? "grid-cell-disabled" : ""; }
							},
						]
					},
					{
						key: undefined, 	label: "공유", columns: [
							{key: "shareReceiveYn", label: "수신", width: 60, align: "center",
								editor: { type: "checkbox", config: {height: 17, trueValue: "N", falseValue: "Y"}},
								styleClass: function() { return !this.item.shareCodeId ? "grid-cell-disabled" : ""; }
							},
							{key: "shareChkDttm", label: "변경일시", width: 140, align: "center",
								styleClass: function() { return !this.item.shareCodeId ? "grid-cell-disabled" : ""; }
							},
						]
					},
					{key: "remark", label: "특이사항", width: 300, align: "left",
						editor: { type: "text" }
					},
					{key: "apprCodeId", label: "결재코드", width: 100, align: "center", hidden: true},
					{key: "shareCodeId", label: "공유코드", width: 100, align: "center", hidden: true}
				],
				body: {
					columnHeight: 28,
					onClick: function () {
						this.self.select(this.dindex);
					},
					onDataChanged: function () {
						// 결재 코드가 없는데 결재 수신을 변경하려고 하면 원복
						if (this.key == 'apprReceiveYn' && !this.item.apprCodeId) {
							this.self.setValue(this.dindex, 'apprReceiveYn', 'N');
							return;
						}
						// 공유 코드가 없는데 공유 수신을 변경하려고 하면 원복
						if (this.key == 'shareReceiveYn' && !this.item.shareCodeId) {
							this.self.setValue(this.dindex, 'shareReceiveYn', 'N');
							return;
						}
					}
				}
			});
			return this;
		},
		setData : function() {
			var targetObj = this.target;
			var searchId = $('#nodeId').val();

			if ($('#userTree').jstree('get_selected',true)[0] == undefined) {
				$("#name_tag").html("");
			} else {
				$("#name_tag").html($('#userTree').jstree('get_selected',true)[0].text);
			}

			var paramObj = {
				"coCd": $('#coCd_S').val(),
				"userId": searchId
			};

			if (searchId) {
				postAjax("/user/wb/wb20/selectKakaoReceiveList", paramObj, null, function(data){
					var list = data.resultList;
					targetObj.setData(list);
				});
			} else {
				targetObj.setData([]);
			}
		}
	};

	// 전체선택/해제
	function toggleAllReceive() {
		var list = gridView.target.getList();
		if (list.length == 0) {
			alert("데이터가 없습니다.");
			return;
		}

		// 현재 체크된 개수 확인 (코드가 있는 것만)
		var checkedCount = 0;
		var totalCount = 0;
		$.each(list, function(idx, item) {
			if (item.apprCodeId) {
				totalCount++;
				if (item.apprReceiveYn == 'N') checkedCount++;
			}
			if (item.shareCodeId) {
				totalCount++;
				if (item.shareReceiveYn == 'N') checkedCount++;
			}
		});

		// 전체 체크되어 있으면 해제, 아니면 체크
		var newValue = (checkedCount == totalCount) ? 'Y' : 'N';

		$.each(list, function(idx, item) {
			if (item.apprCodeId) {
				gridView.target.setValue(idx, 'apprReceiveYn', newValue);
			}
			if (item.shareCodeId) {
				gridView.target.setValue(idx, 'shareReceiveYn', newValue);
			}
		});
	}

	// 저장
	function saveKakaoReceive(){
		// 편집 중인 셀 완료 처리
		$(document.activeElement).blur();

		var rowList = gridView.target.getList();
		if(rowList.length == 0) {
			alert("저장할 데이터가 없습니다.");
			return;
		}

		var searchId = $('#nodeId').val();
		if (!searchId) {
			alert("사용자를 선택해주세요.");
			return;
		}

		var detailArr = [];
		$.each(rowList, function(idx, elem){
			var detailObj = {
				apprCodeId: elem.apprCodeId,
				apprReceiveYn: elem.apprReceiveYn || 'N',
				shareCodeId: elem.shareCodeId,
				shareReceiveYn: elem.shareReceiveYn || 'N',
				remark: elem.remark || ''
			};
			detailArr.push(detailObj);
		});

		var formData = {
			"coCd": $('#coCd_S').val(),
			"userId": searchId,
			"chkUserId": jwt.userId,
			"pgmId": "WB2002M01",
			"detailArr": JSON.stringify(detailArr)
		};

		putAjax("/user/wb/wb20/saveKakaoReceiveList", formData, null, function(data){
			if(data.resultCode == 200){
				alert(data.resultMessage);
				gridView.setData();
			} else if(data.resultCode == 500){
				alert(data.resultMessage);
			} else {
				alert(data.msg + "\n자료 저장 작업에 오류가 발생하였습니다.");
			}
		});
	}

	$(document.body).ready(function () {
		mainDefaultLoad("기준관리", "카카오톡 수신 차단여부 설정(관리자)");
		setCommonSelect($("#main_area select[data-kind]"));
		$("#coCd_S").val(jwt.coCd);

		//권한체크
		authChk();
		$('#nodeName').focus();

		gridView.initView();

		initUserTree();
	});

	// 초기화
	function initSearch() {
		$('#nodeId').val('');
		$('#nodeName').val('');
		$("#name_tag").html("");
		gridView.target.setData([]);
		initUserTree();
	}

	// 회사변경
	function coCdChange(){
		$('#nodeId').val('');
		$('#nodeName').val('');
		$("#name_tag").html("");
		gridView.target.setData([]);
		initUserTree();
	}

	// 트리 초기화
	function initUserTree(userTree) {
		$("#userTree").jstree("destroy");

		$("#userTree").jstree(
		{
			"plugins": ['types', 'checkbox', 'search', 'sort'],
			"core": {
				"multiple": false,
				"data": setUserTree(),
				"dblclick_toggle2": false
			},
			"types": {
				"person": {"icon" : "glyphicon glyphicon-user"},
				"unit": {"icon": "glyphicon glyphicon-folder-close"},
				"unit-open": {"icon": "glyphicon glyphicon-folder-open"}
			},
			"checkbox": {
				"keep_selected_style": false,
				"three_state": false
			},
			"search": {
				show_only_matches: false
			},
			"sort": function(a, b){
				var nodeA = this.get_node(a);
				var nodeB = this.get_node(b);
				if(nodeA.original.type=="person" && nodeB.original.type=="unit"){
					return -1;
				}
			}
		}).on("loaded.jstree", function() {
			selectNode();
		}).on("select_node.jstree", function(e, data) {
			executeCallback(data.node);
		}).on('dblclick.jstree', function(e, data) {
			executeCallback(data.node);
		}).on('open_node.jstree', function(e, data) {
			data.instance.set_type(data.node, 'unit-open');
		}).on('close_node.jstree', function(e, data) {
			data.instance.set_type(data.node, 'unit');
		});
	}

	// 트리 데이터 set
	function setUserTree() {
		var userTree = null;
		var paramObj = {coCd : '' };
		postAjaxSync("/admin/cm/cm06/selectUserTree", paramObj, null, function(data){
			userTree = data.userTree;
			for (let i = 0; i < userTree.length; i++) {
				if (userTree[i].type == 'person' && userTree[i].useYn != 'Y') {
					userTree[i].text = userTree[i].text + '(퇴사)';
				}
			}
		});
		return userTree;
	}

	// 트리 노드 select
	function selectNode() {
		var userId = '';
		if(userId){
			$('#userTree').jstree(true).select_node(userId);
		}else{
			$('#userTree').jstree(true).open_node($('#userTree li[aria-level=1]').eq(0).attr('id'));
		}
	}

	// 트리 노드 검색
	function searchUser(){
		var nodeName = $('#nodeName').val();
		$('#userTree').jstree(true).search(nodeName);
	}

	function executeCallback(node){
		if(!node.id){
			alert("선택된 데이터가 없습니다.");
			return false;
		}

		if(node.type != "person"){
			if (node.state.opened) {
				$('#userTree').jstree(true).close_node(node.id);
			} else {
				$('#userTree').jstree(true).open_node(node.id);
			}
			return false;
		}
		$('#nodeName').val(node.text);
		$('#nodeId').val(node.id);
		gridView.setData();
	}

</script>
</body>
</html>
