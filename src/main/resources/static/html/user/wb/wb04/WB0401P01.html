
<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">WBS 일정계획 조정</h4>
    </div>
    <div class="popup_table">               
        <table style="border:0px;width: 100%;">
            <tr>
                <td style="text-align: LEFT; border-right: 0px;">
                   <div data-ax5grid="first-grid1" data-ax5grid-config="{}" style="height: 750px; width: 100%"></div>
                </td>              
            </tr>
        </table>      
    </div>
    <!-- 하단 버튼 -->
    <div class ="popup_bottom_btn">
        <button type="button" id="actionBtn" onclick="updateWbsPlanDate();">수정</button>
        <button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
</div>


<script  type="text/javascript">
var coCd = modalStack.last().paramObj.coCd;
var salesCd = modalStack.last().paramObj.salesCd;
var codeId = modalStack.last().paramObj.codeId;
	
ax5.ui.grid.formatter["chkYn"] = function () {
    var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
    if (this.value == "E"){
        return ' ';
    } else {
        return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
    }
};

var gridView1 = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                sortable: false,
                target: $('[data-ax5grid="first-grid1"]'),
                header : {
                    align : "center",
                    selector : false
                },
               columns: [
                    {key: "rnum",  label: "NO.", hidden:true},
                    {key: "lvl",  label: "lvl", hidden:true},
                    {key: "codeId",  label: "codeId", align: "left", width: 200, hidden:true, treeControl: true},
                    {key: "codeKind",  label: "codeKind", hidden:true},
                    {key: "coCd",  label: "회사코드", hidden:true},
                    {key: "coCdNm",  label: "회사명", width: 80, hidden:true, align: "center"},
                    {key: "salesCd",  label: "SALES CD", width: 100, hidden:true, align: "center"},
                    {key: "codeNm",  label: "WBS 계획구분", align: "left", width: 200,  treeControl: true},

                    {key: "fileTreeKey",        label: "fileTreeKey", hidden:true},
                    {key: "wbsPlanNo",          label: "wbsPlanNo", hidden:true},
                    {key: "wbsPlanStsCodeId",   label: "계획상태코드",   hidden: true},
                    {key: "rsltsFileTrgtKey",   label: "rsltsFileTrgtKey", hidden:true},
                    {key: "rsltsWbsPlanNo",     label: "rsltsWbsPlanNo", hidden:true},
                    {key: "wbsPlanId",          label: "담당자",      hidden:true},
                    {key: "wbsPlanNm",            label: "담당자",      hidden:true},
                    {key: "wbsPlanDt",            label: "담당자",      hidden:true},
                    {key: "wbsPlanStsNm",       label: "계획상태",      hidden:true}, 
                    {key: "wbsPlanMngId",     label: "담당자",      hidden:true}, 
                    {key: "wbsPlanMngNm",     label: "담당자",      align: "center",   width: 80}, 
                    {key: "wbsPlanCnts",      label: "주요내용",      align: "left",   width: 200},
                    {key: "wbsPlanRmk",      label: "비고",      align: "left",   width: 150},    
                    {label: "계획", columns: [  
                        {key: "wbsPlanChkYn",       label: "계획",      align: "center",   width: 40, formatter: "chkYn"},  
                        {key: "wbsPlansDt",         label: "시작일자",      align: "center",   width: 80, 
                        	editor: {type: "date"
                                        , config: {
                                                content: {
                                                             config: { mode: "day", selectMode: "day" }
                                                         }
                                                   }
                        	        }
                        },
                        {key: "wbsPlaneDt",         label: "종료일자",      align: "center",   width: 80,
                            editor: {type: "date"
                                , config: {
                                        content: {
                                                     config: { mode: "day", selectMode: "day" }
                                                 }
                                           }
                            }
                        	
                        },
                        {key: "lockYn",             label: "잠금",      align: "center",   width: 40, formatter: "chkYn"},
                        {key: "closeYn",            label: "마감",      align: "center",   width: 40, formatter: "chkYn"},
                        ]},
                    {label: "실적", columns: [ 
                        {key: "wbsRsltsChkYn",      label: "실적",      align: "center",   width: 40, formatter: "chkYn"},  
                        {key: "wbsRsltsRate",       label: "진행율",      align: "center",   width: 60},                   
                        {key: "wbsRsltssDt",        label: "시작일자",      align: "center",   width: 80},
                        {key: "wbsRsltseDt",        label: "종료일자",      align: "center",   width: 80},
                        {key: "rsltsLockYn",        label: "잠금",      align: "center",   width: 40, formatter: "chkYn"},
                        {key: "rsltsCloseYn",       label: "마감",      align: "center",   width: 40, formatter: "chkYn"},
                        {key: "wbsPlanMh",          label: "계획공수",      align: "center",   width: 80},                   
                        {key: "wbsRsltsMh",         label: "실적공수",      align: "center",   width: 80},
                        {key: "wbsRsltsCnts",      label: "주요내용",      align: "left",   width: 100},
                        {key: "wbsRsltsRmk",      label: "비고",      align: "left",   width: 100},    
                    ]},
                    {key: "wbsRsltsId",         label: "담당자",      align: "center",   width: 80},                   
                    {key: "wbsRsltsDt",         label: "실적일자",      align: "center",   width: 80},
                    {key: "ordrsClntCd",      label: "고객사",     hidden: true},
                    {key: "ordrsClntNm",      label: "고객사",      align: "center",   width: 130},
                    {key: "clntPjt",      label: "고객사PJT",      align: "center",   width: 100},
                    {key: "ordrsDtlDiv20",      label: "신작구분",      hidden: true},
                    {key: "ordrsDtlDiv20Nm",      label: "신작",      align: "center",   width: 40},
                    {key: "prdtCd",      label: "제품구분",      hidden: true},
                    {key: "prdtCdNm",      label: "제품",      align: "center",   width: 130},
                    {key: "itemDiv",      label: "ITEM구분",      hidden: true},
                    {key: "itemDivNm",      label: "ITEM",      align: "center",   width: 100},  
                    
                    {key: "creatId",      label: "생성자", align: "center",   width: 80},
                    {key: "creatPgm",      label: "생성프로그램ID",      hidden: true},
                    {key: "creatDttm",      label: "생성일시",      align: "center",   width: 80},                   
                    {key: "udtId",      label: "최종변경자",      align: "center",   width: 80},
                    {key: "udtPgm",      label: "최종수정프로그램ID",      hidden: true},
                    {key: "udtDttm",      label: "최종변경일자",      align: "center",   width: 80},
                    
                    {key: "dsgnDifCodeId",      label: "설계난이도코드",      hidden: true},
                    {key: "dsgnDifCodeNm",      label: "설계난이드명",      hidden: true},
                    {key: "dsgnPlanHour",      label: "설계계획공수",      hidden: true},                   
                    {key: "prdctnDifCodeId",      label: "생산난이도코드",      hidden: true},
                    {key: "prdctnDifCodeNm",      label: "생산난이도명",      hidden: true},
                    {key: "prdctnPlanHour",      label: "생산계획공수",      hidden: true},                   
                    {key: "wbsPlanOsYn",      label: "계획외주코드",      hidden: true},
                    {key: "wbsPlanOsNm",      label: "계획외주유무",      hidden: true},   
                    {key: "wbsPlanCodeKind",      label: "WBS 상위코드",    hidden: true},
                    {key: "wbsPlanCodeId",      label: "WBS 코드",      hidden: true},
                    {key: "wbsPlanNo",      label: "WBS NO",      hidden: true},
                    {key: "isLeaf", label: "isLeaf", align: "left", width: 60, hidden: true },
               ],
                body: {
                    mergeCells : ["coCdNm","salesCd"],
                    columnHeight: 26,
                    onClick: function () {
                    	var list = gridView1.target.getList("selected");
                        $.each(list, function(idx, obj){
                        	gridView1.target.select(obj.__origin_index__, {__selected__: false});
                        });     
                    	this.self.select(this.dindex);
                    	if (this.item.closeYn == "Y" || this.item.lockYn == "Y") {
                            alert("WBS일정이 잠금 또는 마감되었습니다.");
                            return;
                        }
                    },
                    
                    onDBLClick: function () {
                    	var list = gridView1.target.getList("selected");
                        $.each(list, function(idx, obj){
                            gridView1.target.select(obj.__origin_index__, {__selected__: false});
                        });  
                        this.self.select(this.dindex);
                        if (this.item.closeYn == "Y" || this.item.lockYn == "Y") {
                            alert("WBS일정이 잠금 또는 마감되었습니다.");
                            return;
                        }
                    },
                    onDataChanged: function () {
                    	
                    	if(this.item.wbsPlansDt > this.item.wbsPlaneDt) { 
                    		alert("날짜를 확인해주세요");
                    		this.item.wbsPlansDt = this.item.wbsPlaneDt;
                    		return;
                    	}
                    },                    
               },
               page : {
                    navigationItemCount : 10,
                    height : 30,
                    use : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        gridView.setData(this.page.selectPage);
                    }
                },
                tree: {
                    use: true,
                    indentWidth: 15,
                    arrowWidth: 15,
                    iconWidth: 18,
                    icons: {
                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                        collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
                        itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
                    },
                   columnKeys: {
                       parentKey: "codeKind",
                       selfKey: "codeId",
                   }
               }
            });
            return this;
        },
        setData : function(_pageNo, coCd, paramSalesCode) {
            var targetObj = this.target;
            var paramObj = {"coCd": coCd,
                  "salesCd" : paramSalesCode,
                  "pageNo" : _pageNo + 1,
                  "recordCnt" : $('#recordCnt').val()};
            postAjaxSync("/user/wb/wb01/selectNewWbsPlanTreeList", paramObj, null, function(data){
                    var list = data.fileList;
                    targetObj.setData({
                        list : list,
                        page : {
                            totalElements : list.length,
                        }	                     
                    });
                    var rowList = gridView1.target.getList();
                    $.each(rowList, function(idx, obj){
                        if (obj.codeId == codeId) {
                            gridView1.target.select(obj.__origin_index__, {__selected__: true});
                        }                           
                    }); 
            });
        } 
        
    }

$(document).ready(function() {
    mainDefaultLoad("WBS", "일정조정관리");          // 페이지 타이틀 설정
    setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set
    gridView1.initView().setData(0, coCd, salesCd);
    authChk();
});


function updateWbsPlanDate() {
    var list = gridView1.target.getList();
    var rowListArr = [];
    if(list.length > 0) {
        if(confirm("일정 수정 하시겠습니까?")){
            var formData = new FormData();
            $.each(list, function(idx, elem){
                var row = gridView1.target.getList()[elem.__index];
                if (row != undefined && row.__modified__) {
                    const obj = {coCd: row.coCd, codeId: row.codeId, salesCd:row.salesCd, wbsPlansDt:row.wbsPlansDt, wbsPlaneDt:row.wbsPlaneDt};
                    rowListArr.push(obj);
                }               
            });
            formData.append("rowListArr", JSON.stringify(rowListArr));
            filePutAjax("/user/wb/wb04/updateWbsPlanDate", formData, function(data){
                if(data.resultCode == 200){
                    alert("일정변경처리 완료되었습니다.");       
                    gridView1.setData(0, coCd, salesCd);
                    //modal.close();
                    gantt(salesCd);
                }
            });  
        } 
    }
} 


</script>
