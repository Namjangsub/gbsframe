
<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">WBS 계획 공정 등록</h4>
    </div>    
    <div class="contents">
       <div class="ax5_grid" data-ax5grid="wbsPlan-grid" data-ax5grid-config="{}" style="height: 700px; width: 100%" ></div>
    </div>
    <br>
    <div class ="popup_bottom_btn">
        <button type="button" id="actionBtn" onclick="executeCallback();">등록</button>
        <button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
</div>    
<script type="text/javascript">
  var coCd = null
  var salesCd = null;
  var ordrsNo = null;

  var wbsGridView = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
            	showRowSelector: true,
                multipleSelect: true,
                sortable: false,
                target: $('[data-ax5grid="wbsPlan-grid"]'),
                header : {
                    align : "center",
                    selector : false
                },
               columns: [
            	    {key: "chk",  label: "chk", hidden:true},
                    {key: "rnum",  label: "NO.", hidden:true},
                    {key: "lvl",  label: "lvl", hidden:true},
                    {key: "codeId",  label: "codeId", align: "left", width: 200, hidden:true, treeControl: true},
                    {key: "codeKind",  label: "codeKind", hidden:true},
                    {key: "coCd",  label: "회사코드", hidden:true},
                    {key: "coCdNm",  label: "회사명", width: 80, hidden:true, align: "center"},
                    {key: "salesCd",  label: "SALES CD", width: 100, hidden:true, align: "center"},
                    {key: "codeNm",  label: "WBS 계획구분", align: "left", width: 200,  treeControl: true},

                    {key: "fileTreeKey",        label: "fileTreeKey", hidden:true},
                    {key: "wbsPlanNo",          label: "wbsPlanNo", hidden:true},
                    {key: "wbsPlanStsCodeId",   label: "계획상태코드",   hidden: true},
                    {key: "rsltsFileTrgtKey",   label: "rsltsFileTrgtKey", hidden:true},
                    {key: "rsltsWbsPlanNo",     label: "rsltsWbsPlanNo", hidden:true},
                    {key: "wbsPlanId",          label: "담당자",      hidden:true},
                    {key: "wbsPlanNm",            label: "담당자",      hidden:true},
                    {key: "wbsPlanDt",            label: "담당자",      hidden:true},
                    {key: "wbsPlanStsNm",       label: "계획상태",      hidden:true}, 
                    {key: "wbsPlanMngId",     label: "담당자",      hidden:true}, 
                    {key: "wbsPlanMngNm",     label: "담당자",      align: "center",   width: 80}, 
                    {key: "wbsPlanCnts",      label: "주요내용",      align: "left",   width: 100},
                    {key: "wbsPlanRmk",      label: "비고",      align: "left",   width: 100},    
                    {label: "계획", columns: [  
                        {key: "wbsPlanChkYn",       label: "계획",      align: "center",   width: 40, formatter: "chkYn"},  
                        {key: "wbsPlansDt",         label: "시작일자",      align: "center",   width: 80},
                        {key: "wbsPlaneDt",         label: "종료일자",      align: "center",   width: 80},
                        {key: "lockYn",             label: "잠금",      align: "center",   width: 40, formatter: "chkYn"},
                        {key: "closeYn",            label: "마감",      align: "center",   width: 40, formatter: "chkYn"},
                        ]},
                    {label: "실적", columns: [ 
                        {key: "wbsRsltsChkYn",      label: "실적",      align: "center",   width: 40, formatter: "chkYn"},  
                        {key: "wbsRsltsRate",       label: "진행율",      align: "center",   width: 60},                   
                        {key: "wbsRsltssDt",        label: "시작일자",      align: "center",   width: 80},
                        {key: "wbsRsltseDt",        label: "종료일자",      align: "center",   width: 80},
                        {key: "rsltsLockYn",        label: "잠금",      align: "center",   width: 40, formatter: "chkYn"},
                        {key: "rsltsCloseYn",       label: "마감",      align: "center",   width: 40, formatter: "chkYn"},
                        {key: "wbsPlanMh",          label: "계획공수",      align: "center",   width: 80},                   
                        {key: "wbsRsltsMh",         label: "실적공수",      align: "center",   width: 80},
                        {key: "wbsRsltsCnts",      label: "주요내용",      align: "left",   width: 100},
                        {key: "wbsRsltsRmk",      label: "비고",      align: "left",   width: 100},    
                    ]},
                    {key: "wbsRsltsId",         label: "담당자",      align: "center",   width: 80},                   
                    {key: "wbsRsltsDt",         label: "실적일자",      align: "center",   width: 80},
                    {key: "ordrsClntCd",      label: "고객사",     hidden: true},
                    {key: "ordrsClntNm",      label: "고객사",      align: "center",   width: 130},
                    {key: "clntPjt",      label: "고객사PJT",      align: "center",   width: 100},
                    {key: "ordrsDtlDiv20",      label: "신작구분",      hidden: true},
                    {key: "ordrsDtlDiv20Nm",      label: "신작",      align: "center",   width: 40},
                    {key: "prdtCd",      label: "제품구분",      hidden: true},
                    {key: "prdtCdNm",      label: "제품",      align: "center",   width: 130},
                    {key: "itemDiv",      label: "ITEM구분",      hidden: true},
                    {key: "itemDivNm",      label: "ITEM",      align: "center",   width: 100},  
                    
                    {key: "creatId",      label: "생성자", align: "center",   width: 80},
                    {key: "creatPgm",      label: "생성프로그램ID",      hidden: true},
                    {key: "creatDttm",      label: "생성일시",      align: "center",   width: 80},                   
                    {key: "udtId",      label: "최종변경자",      align: "center",   width: 80},
                    {key: "udtPgm",      label: "최종수정프로그램ID",      hidden: true},
                    {key: "udtDttm",      label: "최종변경일자",      align: "center",   width: 80},
                    
                    {key: "pTodoCfDt",      label: "TODO계획일자",      align: "center",   width: 110},
                    {key: "rTodoCfDt",      label: "TODO실적일자",      align: "center",   width: 110},
                                            
                    {key: "dsgnDifCodeId",      label: "설계난이도코드",      hidden: true},
                    {key: "dsgnDifCodeNm",      label: "설계난이드명",      hidden: true},
                    {key: "dsgnPlanHour",      label: "설계계획공수",      hidden: true},                   
                    {key: "prdctnDifCodeId",      label: "생산난이도코드",      hidden: true},
                    {key: "prdctnDifCodeNm",      label: "생산난이도명",      hidden: true},
                    {key: "prdctnPlanHour",      label: "생산계획공수",      hidden: true},                   
                    {key: "wbsPlanOsYn",      label: "계획외주코드",      hidden: true},
                    {key: "wbsPlanOsNm",      label: "계획외주유무",      hidden: true},   
                    {key: "wbsPlanCodeKind",      label: "WBS 상위코드",    hidden: true},
                    {key: "wbsPlanCodeId",      label: "WBS 코드",      hidden: true},
                    {key: "wbsPlanNo",      label: "WBS NO",      hidden: true},
                    {key: "isLeaf", label: "isLeaf", align: "left", width: 60, hidden: true },
               ],
                body: {
                    mergeCells : ["coCdNm","salesCd"],
                    columnHeight: 26,
                    onClick: function () {
                    	this.self.select(this.dindex);
                    	if (this.item.chk == 0) {
                    		this.item.chk = 1;
                    	}
                    	else {
                    		this.item.chk = 0;
                    	} 
                    		
                        if (this.item.lvl == 1) {
                            this.self.updateChildRows(this.dindex, {__selected__: false});
                            return;
                        }
                         else if (this.item.lvl > 1) {
                        	var list = this.self.getList();    
                        	var codeKind = this.item.codeKind;
                        	var chk = this.item.chk;
                            $.each(list, function(idx, obj){
                            	//debugger;
                            	if (obj.codeId == codeKind && obj.chk == 0) {     
                            		wbsGridView.target.select(idx, {selected: true});
                                }
                            });
                        } 
                        
                    },
                    onDataChanged: function () {
                    	if (this.key == 'isChecked') {
                            this.self.updateChildRows(this.dindex, {isChecked: this.item.isChecked});
                        }
                        else if(this.key == '__selected__'){
                            this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
                        }
                    	
                        
                    	/* if (this.item.lvl == 1) {
                            //alert("0레벨은 선택할 수 없습니다.");
                            this.self.updateChildRows(this.dindex, {__selected__: false});
                            return;
                        }
                        else if (this.item.lvl == 4) {
                            //alert("4레벨은 선택할 수 없습니다.");
                            this.self.updateChildRows(this.dindex, {__selected__: false});
                            return;
                        }
                        
                        this.self.updateChildRows(this.dindex, {isChecked: this.item.__selected__});
                        this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
                    	
                        var list = wbsGridView.target.getList("selected");
                        var chk = false;
                        $.each(list, function(idx, obj){
                            if (obj.wbsPlansDt) {
                                chk = true;
                                return false;
                            }
                        })
                        if (chk) {
                            alert("WBS 계획이  포함되어 있습니다.");
                            this.self.clearSelect();
                            return;
                        } */
                        
                    	/* var codeKind = this.item.codeKind;
                        var lvl = this.item.lvl;
                        var selected = this.item.__selected__;
                        if (lvl == 4) {
                            var list = wbsGridView.target.getList();
                            $.each(list, function(idx, elem){                               
                                if (elem.codeKind == codeKind || elem.codeId == codeKind) {                                    
                                	wbsGridView.target.updateRow($.extend({}, wbsGridView.target.list[idx], {__selected__: selected}), idx);
                                }
                            });
                        } */
                        
                    	/* var list = wbsGridView.target.getList("selected");
                    	var chk = false;
                        $.each(list, function(idx, obj){
                            if (obj.wbsPlansDt) {
                            	chk = true;
                            	return false;
                            }
                        })
                        if (chk) {
                        	alert("WBS 계획이  포함되어 있습니다.");
                        	this.self.clearSelect();
                        	return;
                        } */
                        //else {
                        	/* if (this.key == 'isChecked') {
                        		this.self.updateChildRows(this.dindex, {isChecked: this.item.isChecked});
                            }
                            else if(this.key == '__selected__'){
                            	this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
                            }
                        	var status = this.item.__selected__;  */
                        	
                        	/* if (this.item.lvl == 3) {                        		
                        		var codeId = this.item.codeId.substring(0,8);
                        		var chk = false;
                        		var objIdx = null;
                        		var list = wbsGridView.target.getList();                                
                                $.each(list, function(idx, obj){
                                	if (obj.lvl == 2 && obj.codeId == codeId) {
                                		objIdx = obj.__index;  
                                		return false;
                                	}
                                });
                                wbsGridView.target.select(objIdx, {selected: true});
                                if (!this.item.__selected__) {
	                                var list1 = wbsGridView.target.getList();                                
	                                $.each(list1, function(idx, obj){
	                                    if (obj.lvl == 3 && obj.codeId.substring(0,8) == codeId) {	                                    	
	                                    	if (obj.__selected__) {
	                                        	chk = true;
	                                        	return false;
	                                        }
	                                    }
	                                });
	                                if (chk) {
	                                    wbsGridView.target.select(objIdx, {selected: true});
	                                }
	                                else {
	                                    wbsGridView.target.select(objIdx, {selected: false});
	                                } 
                                }
                            }  */
                        //} 
                        
                        /* if (this.key == 'isChecked') {
                            this.self.updateChildRows(this.dindex, {isChecked: this.item.isChecked});
                        }
                        else if(this.key == '__selected__'){
                            this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
                        } */
                    }
               },
               page : {
                    navigationItemCount : 10,
                    height : 30,
                    use : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                    	wbsGridView.setData(this.page.selectPage, salesCd, ordrsNo);
                    }
                },
                tree: {
                    use: true,
                    indentWidth: 15,
                    arrowWidth: 15,
                    iconWidth: 18,
                    icons: {
                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                        collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
                        itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
                    },
                   columnKeys: {
                       parentKey: "codeKind",
                       selfKey: "codeId",
                   }
               }
            });
            return this;
        },
        setData : function(_pageNo) {
            var targetObj = this.target;
            var paramObj = {"coCd": coCd,
                  "salesCd" : salesCd,
                  "ordrsNo" : ordrsNo,
                  "pageNo" : _pageNo + 1,
                  "recordCnt" : 100};
            var url = "";
            url = "/user/wb/wb01/selectNewWbsPlanTreeList";
            postAjax(url, paramObj, null, function(data){
                var list = data.fileList;
                    targetObj.setData({
                        list : list,
                        page : {
                            totalElements : list.length,
                        }
                    });
            });
        } 
        
    }
  
    $(document).ready(function() {
    	coCd = modalStack.last().paramObj.coCd;
    	salesCd = modalStack.last().paramObj.salesCd;
    	ordrsNo = modalStack.last().paramObj.ordrsNo;    	
    	wbsGridView.initView().setData(0);    	
    });
  
    function executeCallback(){
/*     	var list = wbsGridView.target.getList("selected");
    	
    	$.each(list, function(idx, obj){
    		var codeKind = obj.codeKind;
            var codeId = obj.codeId;
            var lvl = obj.lvl;
            var list1 = wbsGridView.target.getList();                                
            $.each(list1, function(idx, elem) {
            	debugger;
                
            	if (elem.codeKind.includes(codeKind) && elem.lvl < lvl && !elem.__selected__) {
                	wbsGridView.target.updateRow($.extend({}, wbsGridView.target.list[idx], {__selected__: true}));
                }
            });
        });
 */
		 var list = wbsGridView.target.getList("selected");
		 var rowChk = 0;
		 $.each(list, function(idx, elem){
		     var codeKind = elem.codeId;
		     var lvl = elem.lvl;
		     var list1 = wbsGridView.target.getList();                   
		     if (list1) {
		         $.each(list1, function(idx, elem){
		             if (elem.codeKind.includes(codeKind) && elem.lvl > lvl && !elem.__selected__) {
		                 rowChk++;
		             }
		         });
		     }     
		 });

		 if (rowChk > 0) {
		     alert("선택한 데이터의 하위 레벨이 존재합니다.");
		     return;
		 }
 
	    modalStack.last().callback(wbsGridView);
	    modalStack.close();
	}
  
</script>
