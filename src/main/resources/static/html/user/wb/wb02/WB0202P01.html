<div id="wbsPopup1" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">공유/결재라인 팝업</h4>
    </div>
    
    <div class="popup_table">
        <div class="form-group">
            <form id="popFormApp">
                <table class="popup_table">
                    <colgroup>
                         <col width="8%">
                         <col width="11%">
                         <col width="8%">
                         <col width="11%">
                         <col width="8%">
                         <col width="11%">
                         <col width="8%">
                         <col width="11%">
                    </colgroup>
                    
                    <thead>
                        <tr>
                           <td colspan="8" style="height:30px;text-align: left;">기본정보</td>                                                
                        </tr>
                    </thead>
                    
                    <tbody>
                        <!-- 1행 -->
                        <tr>
                            <th class="hit">회사</th>
                            <td>
                                <select  id="coCd" data-kind="CO" data-search="coCd" required="required">
                                   <option value="">전체</option>
                                </select>
                            </td>
                             <th class="hit">작성자</th>
                            <td>
                                <div class="search_form">
                                    <input type="hidden" id="userId_S" name="userId_S">
                                    <input type="text" id="userName_S" name="userName_S" msg="작성자" required>
                                    <a onclick="openFirstWbsPlanUserSearch2();" id="userId_S_Btn">
                                        <i class="i_search_w"></i>
                                    </a>
                                </div>
                            </td>
                            <th class="hit">결재선 구분</th>
                            <td>
                                <select  id="appDiv" name="appDiv" data-kind="APPDIV" style="width: 100%;">
                                  <option value="">선택</option>
                                </select>
                            </td>
                          </th>
                        </tr>
                   </tbody>   
                </table>    
            </form>
        </div>
    </div>
    
    <div class="contents">
        <!-- 결재선 리스트 -->
        <div data-ax5grid="approval-grid" data-ax5grid-config="{}" style="height: 600px; width: 100%"></div>
    </div>
     <button type="button" id="actionBtn" onclick="executeCallback();" authchk>등록</button>
     <button type="button" onclick="modalStack.close();">닫기</button>
</div>   
    
<script type="text/javascript">

var ApprovalGridView1 = {
        initView: function(){
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                sortable: true,
                target: $('[data-ax5grid="approval-grid"]'),
                header: {
                  align: "center",
                  selector: false
                },
                body: {
                    onClick: function () {
                        
                        this.self.select(this.dindex); 
                        var rowList = this.self.list;
                        if(rowList.length == 0) {
                            return;
                        }
                        this.self.clearSelect();
                        var chk = false;
                        //체크 해제이면 
                        if( this.item.check == "N" ) {
							chk = false;
                        } else if( this.item.check == "Y" ){
                        	chk = true;
                        }
                        //선택행 값
                        var appNo = this.item.appNo;
                        //ApprovalGridView1.target.clearSelect();
                        $.each(rowList, function(idx, elem){

                           	if( chk ) {
                           		if( elem.appNo == appNo ) {
                               		ApprovalGridView1.target.setValue(idx, 'check', 'Y');
                               		ApprovalGridView1.target.select(idx);
                           		} else {
                           			ApprovalGridView1.target.setValue(idx, 'check', 'N');
                           		}
                           	} else {
                               	ApprovalGridView1.target.setValue(idx, 'check', 'N');                            		
                           	}
                        });
                        
                    },
                    onDBLClick: function () {
                        this.self.clearSelect();
                        this.self.select(this.dindex);
                    },
               },
               columns: [
                     {key: "rn",      label: "No.",      align: "center",   width: 60},
                     {key: "check",      label: "",      align: "center",   width: 60, editor: {
                       type: "checkbox", config: {height: 17, trueValue: "Y", falseValue: "N"}}},
                     {key: "appDiv",      label: "결재선구분",      align: "center",   width: 130,      hidden: true},
                     {key: "appNo",      label: "appNo",      align: "center",   width: 100,      hidden: true},
                     {key: "appDivNm",      label: "결재선구분",      align: "center",   width: 100},
                     {key: "appLineNm",      label: "결재선명",      align: "left",   width: 150},
                     {key: "appId",      label: "결재자",      hidden: true},
                     {key: "usrNm",      label: "결재자명",      align: "center",   width: 110},
                     {key: "appSeq",      label: "순번",      align: "center",   width: 50},
                     {key: "useYn",      label: "사용여부",      align: "center",   width: 50},
                     {key: "coCd",      label: "회사",          hidden: true},
                     {key: "coCdNm",      label: "회사명",      align: "left",   width: 130},
                     {key: "deptId",      label: "부서",      hidden: true},
                     {key: "deptNm",      label: "부서명",      align: "left",   width: 130},
                     {key: "levelCd",      label: "직급",      align: "left",   width: 130,      hidden: true},
                     {key: "levelNm",      label: "직급",      align: "left",   width: 90},                     
                     {key: "telNo",      label: "전화번호",      align: "left",   width: 130},
                     {key: "offTelNo",      label: "회사번호",      align: "left",   width: 130},
                     {key: "faxNo",      label: "FAX번호",      align: "left",   width: 130},
                     {key: "creatId",      label: "생성자",      hidden: true},
                     {key: "creatNm",      label: "생성자명",      align: "left",   width: 130},
                     {key: "creatDttm",      label: "생성일시",      align: "left",   width: 130,      hidden: true},
                     {key: "udtId",      label: "변경자",      hidden: true},
                     {key: "udtNm",      label: "변경자명",      align: "left",   width: 130,      hidden: true},
                     {key: "udtDttm",      label: "변경일시",      align: "left",   width: 130,      hidden: true},
                     ]
            });
            return this;
          },
          setData: function() {   
				var targetObj = this.target;
	       	    var userId = $("#popFormApp #userId_S").val();
				var userName_S = $("#popFormApp #userName_S").val();	
				var formData = {
	     	    		   "userId" : userId,	//userId - 작성자
	     	    		   "userNm" : userName_S,		//작성자명 검색
	     	               "coCd" : $("#popFormApp #coCd").val(), //회사코드
	     	               "appId" : $("#popFormApp #appId_S").val(), //결재자id
	     	               "appName" : $("#popFormApp #appName_S").val(), //결재자이름검색시 활용
							"appDiv" : $("#popFormApp #appDiv").val()	     	               
				}
	              postAjax("/user/wb/wb02/selectApprovalList", formData, null, function(data){
	                  var list = data.resultList;
	                  targetObj.setData({
	                       list : list,
	                       page : {
	                           totalElements : list.length
	                       }
	                   });
	                  
	              }); 
         } 
     }
     

$(document).ready(function() {
    setCommonSelect($("#wbsPopup1 select[data-kind]"));
    	
    // 접속자 회사 등 set
    $("#popFormApp #coCd").val(modalStack.last().paramObj.coCd);
	//공통결재시 SELECT SEL
	appDiv = modalStack.last().paramObj.appDiv;
	if( appDiv ) {
		$("#popFormApp #appDiv").val(appDiv);
	}
	$("#popFormApp #userId_S").val(modalStack.last().paramObj.userId);
    $("#popFormApp #userName_S").val(modalStack.last().paramObj.userNm);
	
    ApprovalGridView1.initView().setData();
    
    // 검색조건 이벤트 bind
	$('[data-search], #appDiv').on("change", function(){
		ApprovalGridView1.setData(0);
	});    
    
	//작성자 결재자 keyup 이벤트
	$("#popFormApp #userName_S").on("keyup", function () {
		if(event.keyCode == 8) {
			$("#popFormApp #userName_S").val('');
			$("#popFormApp #userId_S").val('');
			ApprovalGridView1.setData(0); 
		} else if(event.keyCode == 13) { 
			ApprovalGridView1.setData(0); 
		}		
	});    
    //관리자일경우만 작성자 검색을 사용할지 결정
    if( jwt.authInfo.indexOf('AUTH001') > -1 ) {
	
    } else {
    	$("#popFormApp #userName_S").attr('readonly', true);
		$("#popFormApp #userId_S_Btn").hide();
		$("#popFormApp #userId_S_Btn").removeAttr("onclick");        	
    }
});


//작성자 검색
function openFirstWbsPlanUserSearch2() {
    var paramObj = {
        "coCd" : $('#coCd').val(),
        "userId": $('#userId_S').val(),
        "useYn": "Y"
    };
    
    openThirdModal("/static/html/cmn/modal/userSearch.html", 300, 500, "작성자 검색", paramObj, function (tree){
        var checkedId = tree.get_checked()[0];
        var checkedNode = tree.get_node(checkedId);
        $('#userId_S').val(checkedNode.id);
        $('#userName_S').val(checkedNode.text);
        if( checkedNode.id && checkedNode.text) ApprovalGridView1.setData(0);
    });
}


function executeCallback(){
    //if(selectGridValidation(ApprovalGridView1.target)) return;
    modalStack.last().callback(ApprovalGridView1);
    modalStack.close();
}

</script>
