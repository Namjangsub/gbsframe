<div id="wbsPopupIss" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">WBS 계획 문제</h4>
    </div>
    <div class="popup_table">
        <div class="form-group">
            <form id="popForm_S">
                <input type="hidden" id="actionType"   name="actionType">
                <input type="hidden" id="coCd"   name="coCd">
                <input type="hidden" id="userId" name="userId">
                <input type="hidden" id="pgmId"  name="pgmId" value="WB2401P01">
                <input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
                <input type="hidden" id="salesCd" name="salesCd">
                <input type="hidden" id="wbsPlanNo" name="wbsPlanNo">
                <input type="hidden" id="wbsRsltsNo" name="wbsRsltsNo">
                <input type="hidden" id="wbsPlanCodeKind" name="wbsPlanCodeKind">
                <input type="hidden" id="wbsPlanCodeId" name="wbsPlanCodeId">
                <input type="hidden" id="issNo" name="issNo">
                <input type="hidden" id="issFileTrgtKey" name="issFileTrgtKey">
                <input type="hidden" id="clntPjtNm" name="clntPjtNm">
                <input type="hidden" id="clntNm" name="clntNm">
                <input type="hidden" id="telNo"   name="telNo">
                
                <table class="popup_table">
                    <colgroup>
                        <col width="15%">
                        <col width="35%">
                        <col width="15%">
                        <col width="35%">
                    </colgroup>
                    
					<thead>
						<tr>
							<td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;">▣ 과제정보</td>
						</tr>
					</thead>
					<tr style="text-align: left;">
						<th>과제번호</th>
						<td>
							<input type="text" id="sjNo" name="sjNo" readonly >
						</td>
						<th>과제명</th>
						<td>
							<input type="text" id="sjNm" name="sjNm" readonly>
						</td>
					</tr>
					
					<tr style="text-align: left;">
						<th>고객사</th>
						<td>
							<input type="text"   id="clntNm" name="clntNm" readonly >
						</td>
						<th >SALES CODE</th>
						<td>
							<input type="text" id="salesCd" name="salesCd" required readonly msg="salesCd">
						</td>
					</tr>
					
					<tr style="text-align: left;">
						<th>제작처 구분</th>
						<td>
							<input type="text" id="mkerDivNm" name="mkerDivNm" readonly>
						</td>
						<th>차종</th>
						<td>
							<input type="text"   id="clntPjtNm" name="clntPjtNm" readonly >
						</td>
					</tr>
					
					<tr style="text-align: left;">
						<th>제품</th>
						<td>
							<input type="text" id="prdtNm" name="prdtNm" readonly >
						</td>
						<th><div>총괄PM</th>
						<td>
							<input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly>
						</td>
					</tr>
					
					<tr style="text-align: left;">
						<th>제작업체</th>
						<td>
							<input type="text" id="mkerNm" name="mkerNm" readonly>
						</td>
						<th style="color: blue;">확정</th>
						<td>
							<input type="hidden" id="closeYn" name="closeYn" style="color: blue;" readonly><div id="close"></div>
						</td>
					</tr>
					
					<tr style="text-align: left;">
						<th>시작일</th>
						<td>
							<input id="beginDt" name="beginDt" readonly>
						</td>
						<th>출고일</th>
						<td>
							<input id="deDt" name="deDt" readonly>
						</td>
					</tr>
					
					<tr style="text-align: left;">
						<th>완료검수일</th>
						<td>
							<input id="acptncDt" name="acptncDt" readonly>
						</td>
						<th></th>
						<td>
						</td>
					</tr>
                    <thead>
                        <tr>
                            <td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;">▣ TASK 정보</td>
                        </tr>
                    </thead>
                    
                    <tr style="text-align: left;">
                        <th>TASK명</th>
                        <td colspan="1">
                            <input type="text" id="wbsPlanCodeNm" name="wbsPlanCodeNm" readonly>
                        </td>
                        <th>문제번호</th>
                        <td  colspan="1">
                            <input type="text" id="issNo" name="issNo" readonly>
                        </td>
                    </tr>
                    
                    <tr>
                        <th>시작일자</th>
                        <td>
                            <input type="text" id="wbsPlansDt" name="wbsPlansDt" readonly>
                        </td>
                        <th>종료일자</th>
                        <td>
                            <input type="text" id="wbsPlaneDt" name="wbsPlaneDt" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th>문제등록</th>
                        <td>
                            <input type="text" id="creatIdNm" name="creatIdNm" readonly>
                        </td>
                        <th>등록일</th>
                        <td>
                            <input type="text" id="creatDt" name="creatDt" readonly>
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan="4" bgcolor="gray" style="height:2px;"></td>
                    </tr>
                    
                    <thead>
                        <tr>
                            <td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;">▣ 문제정보</td>
                        </tr>
                    </thead>
                    
                    <tr style="text-align: left;">
                        <th class="hit">유형</th>
                        <td>
                            <select id="issDiv" name="issDiv" required data-kind="ISSDIV"  msg="문제유형">
                                <option value="">선택</option>
                            </select>
                        </td>
                        <th class="hit">진행상태</th>
                        <td>
                            <select id="issSts" name="issSts" required data-kind="ISSSTS" msg="진행상태">
                                <option value="">선택</option>
                            </select>
                        </td>
                    </tr>
                    
                    <tr style="text-align: left;">
                        <th class="hit">제목</th>
                        <td colspan="3">
                            <input type="text" id="issSj" name="issSj" required msg="문제제목">
                        </td>
                    </tr>
                    <tr style="text-align: left;">
                        <th class="hit">조치담당자</th>
                        <td>
                            <div class="search_form">
                                <input type="hidden" id="actId" name="actId" required msg="조치담당자">
                                <input type="text" id="actNm" name="actNm" onkeyUp="if(window.event.keyCode == 8){actId.value = ''};" readonly>
                                <a onclick="openUserSearch(1);"><i class="i_search_w"></i></a>
                            </div>
                        </td>
                        <th>발주요청번호</th>
                        <td>
                            <input type="text" id="reqNo" name="reqNo"  msg="발주요청번호" readonly>
                        </td>
                    </tr>
                    
                    <tr>
         <th class="hit">등록 사유</th>
         <td colspan= "1" style="text-align:left; vertical-align:top;">   
            <div id="COBGB-checkboxContainer"></div>         
         </td>
         <td colspan="2" style="vertical-align: text-top;">
                            <table style="border:0px;">
                                <tr style="height:30px;">
                                    <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 문제정보 공유 및 결재</td>
                                    <td>
                                        <div class="add_btn_small pdl10">
                                            <a id="btn_plus1" onclick="insertShareUserModal();" style="height: 30px; line-height: 28px; width: 30px;"> + </a>
                                            <a id="btn_minus1" onclick="deleteShareUser();" style="height: 30px; line-height: 28px; width: 30px;"> - </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <div>
                                            <div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
         </td>
         
                    </tr>
                    
                    <tr style="text-align: left;">
                        <th class="hit">내용</th>
                        <td colspan="3">
                            <textarea id="issCnts" name="issCnts" cols="100%" rows="4" required msg="문제내용"> </textarea>
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan="4" bgcolor="gray" style="height:2px;"></td>
                    </tr>
                    
                    <thead>
                        <tr>
                            <td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;color:blue;">▣ 조치내역</td>
                        </tr>
                    </thead>
                    
                    <tbody  class="issAct">
                        <tr style="text-align: left;">
                            <th style="color:blue;">시작일자</th>
                            <td>
                                <div class="date_input">
                                    <input type="text" class="input_calendar form-control" style="width: 100% !important; display: inline-block !important;" id="actsDt" name="actsDt" autocomplete="off" date onkeyup="dateMask(this);">
                                </div>
                            </td>
                            <th style="color:blue;">종료일자</th>
                            <td>
                                <div class="date_input">
                                    <input type="text" class="input_calendar form-control" style="width: 100% !important; display: inline-block !important;" id="acteDt" name="acteDt" autocomplete="off" date onkeyup="dateMask(this);">
                                </div>
                            </td>
                        </tr>
                        <tr style="text-align: left;">
                            <th style="color:blue;">조치자 투입공수</th>
                            <td>
                                <input type="text" id="actMh" name="actMh" comma onkeyup="onlyNumber(this)"  msg="투입공수" >
                            </td>
                            <th></th>
                            <td>
                            </td>
<!--                             <th style="color:blue;">비용유형</th> -->
<!--                             <td> -->
<!-- <!--                            <input type="text" id="actAmt" name="actAmt" comma  onkeyup="onlyNumber(this)"  msg="투입비용" > --> -->
<!-- 	                            <select id="actAmtSts" name="actAmtSts" data-kind="ACTAMTSTS" msg="비용유형"> -->
<!-- 	                                <option value="">선택</option> -->
<!-- 	                            </select> -->
<!--                             </td> -->
                        </tr>
<!--                         <tr style="text-align: left;"> -->
<!--                             <th style="color:blue;">담당위험도평가</th> -->
<!--                             <td> -->
<!-- 	                            <select id="actDng" name="actDng" data-kind="ACTDNG" msg="담당위험도평가"> -->
<!-- 	                                <option value="">선택</option> -->
<!-- 	                            </select> -->
<!--                             </td> -->
<!--                             <th style="color:blue;">발주요청번호</th> -->
<!--                             <td> -->
<!--                                 <div class="search_form"> -->
<!--                                     <input type="text" id="reqNo" name="reqNo" readonly  msg="발주요청번호" > -->
<!--                                     <a onclick="openPurchaseSearch();"><i class="i_search_w"></i></a> -->
<!--                                 </div> -->
<!--                             </td> -->
<!--                         </tr> -->
<!--                         <tr id="actDngEvalTr" style="text-align: left; display:none"> -->
<!--                             <th style="color:blue;">팀장위험도평가</th> -->
<!--                             <td> -->
<!-- 	                            <select id="actDngEval" name="actDngEval" data-kind="ACTDNG" msg="팀장 위험도평가"> -->
<!-- 	                                <option value="">팀장평가전</option> -->
<!-- 	                            </select> -->
<!--                             </td> -->
<!--                             <th></th> -->
<!--                             <td> -->
<!--                             </td> -->
<!--                         </tr> -->
                        <tr style="text-align: left;">
                            <th style="color:blue;">원인</th>
                            <td colspan=3>
                                <textarea id="measRst" name="measRst" cols="87" rows="4" msg="원인" ></textarea>
                            </td>
                        </tr>
                        <tr style="text-align: left;">
                            <th style="color:blue;">조치결과</th>
                            <td colspan=3>
                                <textarea id="actCnts" name="actCnts" cols="87" rows="4" msg="조치결과" ></textarea>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <table style="border:0px;" class="issAct">
                    <tr style="height:30px;">
                        <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;color:blue;">※ 조치정보 공유 및 결재</td>
                        <td>
                            <div class="add_btn_small pdl10">
                                <a id="btn_plus2" onclick="insertShareUserModal2();" style="height: 30px; line-height: 28px; width: 30px; display: none;""> + </a>
                                <a id="btn_minus2" onclick="deleteShareUser2();" style="height: 30px; line-height: 28px; width: 30px; display: none;""> - </a>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <div>
                                <div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
                            </div>
                        </td>
                    </tr>
                </table>
            </form>                 
        </div>
    </div>
    
    <div class="contents">
        <!-- 공통 파일 영역 -->
        <div id="fileList_area" style="width:100%;"></div>
    </div>
    
    <br>
    <div class="col-xs-2" style="height: 70px;"></div>
    <div class ="popup_bottom_btn">
        <button type="button" id="actionBtn" >등록</button>
        <button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
</div>

<script type="text/javascript">
    var actionType = null;
    var coCd = null;
    var evlCloseChk = "N";
    var issFileTrgtKey = null;
    var clntPjtNm = null;
    var clntNm = null;
    var salesCd = null;
    var wbsPlanNo = null;
    var wbsRsltsNo = null;
    var wbsPlanCodeKind = null;
    var wbsPlanCodeId = null;
    var wbsPlanCodeNm = null;
    var wbsPlanMngNm = null;
    var wbsMngNm = null;
    var wbsPlansDt = null;
    var wbsPlaneDt = null;
    var wbsRsltssDt = null;
    var wbsRsltseDt = null;
    var approval_Yn = 'N';
    var act_approval_Yn = 'N';
    
    setCommonSelect($(".popup_area select[data-kind]"));
    
    // 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
    
    // 문제 공유 결재 리스트
    var gridViewPop = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $('[data-ax5grid="first-grid-modal"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        gridView.setData(this.page.selectPage);
                    }
                },
                columns : [
                    {key: "gb",                 label: "구분",        align: "center",   width: 40},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                    {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                    {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                    {key: "name",               label: "성명",        align: "center",   width: 80},
                    {key: "jik",                label: "직위",        align: "center",   width: 60},
                    {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
                    {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
                    {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
//                     {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                    {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                ]
            });
            return this;
        },
        setData : function(_pageNo) {
            var targetObj = this.target;
            var formData = {
                "fileTrgtKey" : $("#popForm_S #issFileTrgtKey").val(),
                "reqNo" :  $("#popForm_S #issNo").val(),
                "flag" :  "Y1",
                "pageNo" : _pageNo + 1
            }
            postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data) {
                // 기존 결재선 데이터 있는경우 자동 로딩
                var list = data.result;
                targetObj.setData({
                    list : list,
                    page : {
                        totalElements :  data.paginationInfo.totalRecordCount,
                    }
                });
                
            });
            gridResize(); //그리드 높이 조정
        },
        setData2 : function(_list) {
            this.target.setData({
                list : _list,
                page : {
                    totalElements :  _list.length,
                }
            });
            gridResize(); //그리드 높이 조정
        }
    }
    
    //조치 공유 결재 리스트
    var gridViewPop2 = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $('[data-ax5grid="second-grid-modal"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                    onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                        
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        gridView.setData(this.page.selectPage);
                    }
                },
                columns : [
                    {key: "gb",                 label: "구분",        align: "center",   width: 40},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                    {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                    {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                    {key: "name",               label: "성명",        align: "center",   width: 80},
                    {key: "jik",                label: "직위",        align: "center",   width: 60},
                    {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
                    {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
                    {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
//                     {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                    {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                ]
            });
            return this;
        },
        setData : function(_pageNo) {
            var targetObj = this.target;
            var formData = {
                "fileTrgtKey" : $("#popForm_S #issFileTrgtKey").val(),
                "reqNo"       :  $("#popForm_S #issNo").val(),
                "flag"        :  "Y2",
                "pageNo"      : _pageNo + 1
            }
            postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data) {
                // 기존 결재선 데이터 있는경우 자동 로딩
                var list = data.result;
                targetObj.setData({
                    list : list,
                    page : {
                        totalElements :  data.paginationInfo.totalRecordCount,
                    }
                });
                gridResize2(); //그리드 높이 조정
                
            });
        },
        setData2 : function(_list) {
            this.target.setData({
                list : _list,
                page : {
                    totalElements :  _list.length,
                }
            });
            gridResize2(); //그리드 높이 조정
        }
    }

    function createCheckBox(deptCode) {
        if (deptCode == 'TRN30') deptCode = 'TRN50';	//트루넷직접매출
        if (deptCode == 'GUN70') deptCode = 'GUN60';	//생산관리
        if (deptCode == 'GUN90') deptCode = 'TRN50';	//구매협력업체
        if (deptCode == 'GUN50') deptCode = 'TRN50';	//구매외주팀 (건양ITT)
        if (deptCode == 'GUN95') deptCode = 'TRN50';	//실적관리용 (건양ITT)
        if (deptCode == 'GUN80') deptCode = 'GUN40';	//전산실
        $('#COBGB-checkboxContainer').empty();
        var param = {
        	"userDept" : deptCode,
       		"codeEtc"  : 'ISS'		//문제 선택 옵션
        };

        postAjaxSync("/admin/cm/cm05/selectCheckboxList", param , null,  function(data){
          var codeList = data.childCodeList;
          var container = $('#COBGB-checkboxContainer');
          var lastKind = '';
          const table = $('<table>').appendTo('#COBGB-checkboxContainer')
          var tableRow = '';   
          $.each(codeList, function (index, item){
             if (lastKind != item.codeKind) {
                tableRow = $('<tr>').appendTo(table);
                var trElement = $('<tr>');
                $('<th>').attr('rowspan', item.rowCnt).css('width', '90').text(item.codeDesc).appendTo(tableRow);
                lastKind = item.codeKind;
             } else {
                tableRow = $('<tr>').appendTo(table);
                var trElement = $('<tr>');
             }
             const comboName= "CODECOBGB";
             const iHtml = 
               '<input type="radio" id="' + item.codeId + 
                             '" name="' + comboName + 
                            '" value="' + item.codeId + 
                         '" data-label="' + item.codeNm + 
                  '" onchange="fnc(this)" style="margin-left:20px"> ' + item.codeNm + '\n';

             const tdElement  = $('<td>').attr('style', 'text-align:left;height:20px;').text('').appendTo(tableRow);
             tdElement.append(iHtml);

          });
       })   
       const grdiHeight = $('#COBGB-checkboxContainer').height()-35;
       gridViewPop.target.setHeight(grdiHeight< 162 ? 162 : grdiHeight);
    }

    function fnc(thisButton) {
       const inputType = $(thisButton).attr('type');
         
       if (inputType === 'radio') {
//           console.log(thisButton.dataset.label + ' radio button. = ' + $("input[name='COBTP']:checked").val() + ' 선택');
       } else if (inputType === 'checkbox') {
//           console.log(thisButton.dataset.label + ' checkbox. = ' + thisButton.value + '의 상태는 ' + thisButton.checked);
       }
       if (thisButton.id == 'COBTP99') {
          $("#COBGB9999").prop("checked", $("#COBTP99")[0].checked);  
       }
    }

    
    $(document).ready(function() {
        actionType = modalStack.last().paramObj.actionType;
        if (actionType == undefined) actionType = "I";
        
        coCd = modalStack.last().paramObj.coCd;
        
        $('#popForm_S #actionType').val(actionType);
        $('#popForm_S #coCd').val(coCd);
        $('#popForm_S #salesCd').val(modalStack.last().paramObj.salesCd)
        $("#popForm_S #userId").val(jwt.userId);

		//진행상태가 완료일 경우 투입공수, 투입비용, 조치내용은 필수 입력임  actAmtSts actDng
		$('#issSts').change(function () {
			if ($("#issSts").val() == 'ISSSTS03') {
				$("#actsDt").closest('td').prev('th').addClass("hit");
        		$('#actsDt').attr('required', 'true');
        		$('#acteDt').closest('td').prev('th').addClass("hit");
        		$('#acteDt').attr('required', 'true');
        		$('#actMh').parent('td').prev('th').addClass('hit');
        		$('#actMh').attr('required', 'true');
        		$('#actAmt').parent('td').prev('th').addClass('hit');
        		$('#actAmt').attr('required', 'true');
        		$('#measRst').parent('td').prev('th').addClass('hit');
        		$('#measRst').attr('required', 'true');
        		$('#actCnts').parent('td').prev('th').addClass('hit');
        		$('#actCnts').attr('required', 'true');
        		$('#actAmtSts').parent('td').prev('th').addClass('hit');
        		$('#actAmtSts').attr('required', 'true');
        		$('#actDng').parent('td').prev('th').addClass('hit');
        		$('#actDng').attr('required', 'true');
        		$('#btn_plus2').show();
        		$('#btn_minus2').show();
        		
        		if (act_approval_Yn == 'Y') {
        			$('#actionBtn').hide();
        		} else {
        			$('#actionBtn').show();
        		}
            	$('.issAct').removeClass('no-click');
        		
        	} else {
        		$('#actsDt').closest('td').prev('th').removeClass('hit');
        		$('#actsDt').removeAttr('required', 'true');
        		$('#acteDt').closest('td').prev('th').removeClass('hit');
        		$('#acteDt').removeAttr('required', 'true');
        		$('#actMh').parent('td').prev('th').removeClass('hit');
        		$('#actMh').removeAttr('required', 'true');
        		$('#actAmt').parent('td').prev('th').removeClass('hit');
        		$('#actAmt').removeAttr('required', 'true');
        		$('#measRst').parent('td').prev('th').removeClass('hit');
        		$('#measRst').removeAttr('required', 'true');
        		$('#actCnts').parent('td').prev('th').removeClass('hit');
        		$('#actCnts').removeAttr('required', 'true');
        		$('#actAmtSts').parent('td').prev('th').removeClass('hit');
        		$('#actAmtSts').removeAttr('required', 'true');
        		$('#actDng').parent('td').prev('th').removeClass('hit');
        		$('#actDng').removeAttr('required', 'true');
        		$('#btn_plus2').hide();
        		$('#btn_minus2').hide();
        		if (approval_Yn == 'Y') {
        			$('#actionBtn').hide();
        		} else {
        			$('#actionBtn').show();
        		}
            	$('.issAct').addClass('no-click');
        	}
		})

		//진행상태가 완료일 경우 투입공수, 투입비용, 조치내용은 필수 입력임  actAmtSts actDng
		$('#actAmtSts').change(function () {
			if ($("#actAmtSts").val() == 'ACTAMTSTS01') {
				$("#reqNo").closest('td').prev('th').addClass("hit");
        		$('#reqNo').attr('required', 'true');
        	} else {
        		$('#reqNo').closest('td').prev('th').removeClass('hit');
        		$('#reqNo').removeAttr('required', 'true');
        	}
		})
		
        //등록시 조치내역 입력 못하게
        /****************************************************************************
        ** actionType 작업 분류
        **   C1,C2 : 일정관리에서 계획문제 등록시 
        **   C3,C4 : 이슈관리화면에서 계획문제 등록시
        **   U3,U4 : 이슈관리화면에서 계획문제 수정시
        **    I : To-Do List에서 결재확인을 위한 실행시
        ****************************************************************************/
        
        if (actionType == "U3") {
            // 조치 시작일자, 종료일자 세팅
            $('#actsDt').datepicker({
                format : "yyyy-mm-dd",
                language : "ko",
                autoclose : true
            })
            .datepicker("setDate", moment(new Date()).startOf("month").toDate())
            .on("changeDate", function(){
                //조치 시작일자 종료일자 체크
                //1. 조치시작일자는 계획 시작일자 이전일 수 없다.
                if($('#actsDt').val() != undefined && $('#actsDt').val() < $('#wbsPlansDt').val()) {
                    alert("조치 시작일은 계획 시작일 이전일 수 없습니다.");
                    $('#actsDt').datepicker("setDate", new Date($('#wbsPlansDt').val()));
                    return;
                }
                
                //2. 조치 시작일자는 조치 종료일자 이후 일 수 없다. 하지만 종료일자가 없으면 체크 안해야지
                if($('#actsDt').val() != undefined && $('#acteDt').val() != undefined && $('#actsDt').val() > $('#acteDt').val()) {
                    alert("조치 시작일은 조치 종료일 이전일 수 없습니다.");
                    $('#acteDt').datepicker("setDate", $('#actsDt').val());
                    return;
                }
            });
            
            $('#acteDt').datepicker({
                format : "yyyy-mm-dd",
                language : "ko",
                autoclose : true
            })
            .datepicker("setDate",  moment(new Date()).endOf("month").toDate())
            .on("changeDate", function(){
                if( $('#actsDt').val() != undefined && $('#acteDt').val() != undefined && $('#actsDt').val() > $('#acteDt').val()) {
                    alert("조치 종료일은 조치 시작일 이전일 수 없습니다.");
                    $('#actsDt').datepicker("setDate", $('#acteDt').val());
                }
            });
        } else {
//             $("#actsDt, #acteDt, #actMh, #actAmt, #actCnts").prop('readonly', true);
			//class="issAct"  --> 조치내역 전체 class 명임
        	$('.issAct').addClass('no-click');
        }


        gridViewPop.initView();

        $("#popForm_S #actsDt").val("");
        $("#popForm_S #acteDt").val("");
        
        selectSjInfo();  //수주정보 화면에 표시

    	if (actionType == "U3" || actionType == "I")  {  //  actionType == "U3"  or "I"
            //등록된 모드 데이터 가져오기
			select_wb2401p01_Info();
        	$('.issAct').addClass('no-click');
        	
        	//결재에서 들어온경우 수정 불가로 수정 버튼 제거함
        	if (actionType == "I") {
        		$('#actionBtn').remove();
        	}
    	}

        $("#popForm_S #wbsPlanNo").val(modalStack.last().paramObj.wbsPlanNo);
        $("#popForm_S #wbsRsltsNo").val(modalStack.last().paramObj.wbsRsltsNo)
        
        // 구분자 "C1": WBS 일정계획화면 -> 계획문제 등록 시 사용, "C3":WBS 문제 관리 화면 -> 계획문제 등록 시 사용
        if (actionType == "C1" || actionType == "C3") {
            var paramObj = {
            		"userId" 	: jwt.userId,
            		"wbsPlanNo" : modalStack.last().paramObj.wbsPlanNo,
            		"wbsRsltsNo" : modalStack.last().paramObj.wbsRsltsNo,
                };
                postAjaxSync("/user/wb/wb24/select_wb2401p01_planInfo", paramObj, null, function(data) {
        			$.each(data.result, function(key, value) {
        				if ($('#popForm_S #' + key)[0]) {
        					$('#popForm_S #' + key).val(value);
        					
        					if ($('#popForm_S #' + key).is('[comma]')) {
        						onlyNumber($('#popForm_S #' + key)[0]);
        					}
        				}
        			});
                });
	            
            $('#actionBtn').text("등록");
            $('#actionBtn').on("click", function() {
                insertWbsIssue();
            });
        } else if (actionType == "U3")  {  //  actionType == "U3"
            $('#actionBtn').text("수정");
            $('#actionBtn').on("click", function() {
                updateWbsIssue();
            });
        }
        
        gridViewPop.initView().setData(0);
        gridViewPop2.initView().setData(0);
        
        //---------------------------------------------------------------
        //첨부 화일 처리 시작
        //---------------------------------------------------------------
        fileParam = {
            fileTrgtTyp : $("#popForm_S #pgmId").val(),
            fileTrgtKey : $("#popForm_S #issFileTrgtKey").val()
        }
        treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
        //---------------------------------------------------------------
        //첨부 화일 처리 끝
        //---------------------------------------------------------------
        
        authChk();
        
        // 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
        var paramObj = {
            "coCd" : $("#popForm_S #coCd").val(),
            "salesCd" : $("#popForm_S #salesCd").val(),
        };
        postAjaxSync("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data) {
            if (data.result[0].closeChk == "Y") {
                evlCloseChk = data.result[0].closeChk;
                $('#actionBtn').hide();
            }
        });
        // ----------------------------------
    });
    
    //수주정보
    function selectSjInfo (){
		var paramObj = {
				"coCd"		: coCd,
				"salesCd"	: modalStack.last().paramObj.salesCd,
		};
		postAjaxSync("/user/wb/wb22/selectSjInfo", paramObj, null, function(data){
			var row = data.resultList;
			if (row != undefined) {
				$.each(row, function (key, val) {
					$("#popForm_S #" + key).val(val);
					if (key == "closeYn") {   
						var color = val == "Y" ? "color-circle_02.png" : "color-circle_01.png";
						var html = '<img src="/static/img/'+color+'" align="center" style="width: 10px;height: 10px;"></img>';
						$("#popForm_S #close").html(html)
					}
					
				});
			}
		});
    }
    
    function insertWbsIssue() {
        if (inputValidation($('.popup_area [required]'))) {
			if($("input[name='CODECOBGB']:checked").val() == undefined || $("input[name='CODECOBGB']:checked").val() == ""){
                alert("등록사유를 선택해주세요");  
			} else {
	            var formData = makeFormData();
	            filePostAjax("/user/wb/wb24/wbsIssueInsert", formData, function(data) {
	                alert(data.resultMessage);
	                if (data.resultCode == 200) {
	                    kakaoTodo();
                    	if (typeof gridView !== "undefined") gridView.setData(0);
                    	if (typeof gridView2 !== "undefined") gridView2.setData(0);
                    	if (typeof salesGridView !== "undefined") salesGridView.setData(0);
                    	if (typeof issueGridView !== 'undefined') issueGridView.setData(0); 
	                    modalStack.close();
	                }
	            });
			}
        }
    }
    
    function updateWbsIssue() {
        if (inputValidation($('.popup_area [required]'))) {
			if($("input[name='CODECOBGB']:checked").val() == undefined || $("input[name='CODECOBGB']:checked").val() == ""){
                alert("등록사유를 선택해주세요");  
			} else {
	            var formData = makeFormData();
	            filePostAjax("/user/wb/wb24/wbsIssueUpdate", formData, function(data) {
	                alert(data.resultMessage);
	                if (data.resultCode == 200) {
	                    kakaoTodo();
                    	if (typeof gridView !== "undefined") gridView.setData(0);
                    	if (typeof gridView2 !== "undefined") gridView2.setData(0);
                    	if (typeof salesGridView !== "undefined") salesGridView.setData(0);
                    	if (typeof issueGridView !== 'undefined') issueGridView.setData(0); 
	                    modalStack.close();
	                }
	            });
			}
        }
    }
    
    function makeFormData() {
        $.each($('.popup_area input[comma]'), function(idx, elem) {
            deleteComma(elem);
        });
        
        if (actionType == "C1" || actionType == "U1" || actionType == "C3" || actionType == "U3") {
            $('#popForm_S #wbsRsltsNo').val("");
        }
        else if (actionType == "C2" || actionType== "U2" || actionType == "C4" || actionType == "U4") {
            $('#popForm_S #wbsPlanNo').val("");
        }
        
		//1. 조치담당자 결재 자동등록 처리하기
		//2. 조치담당자 팀장 결재 자동등록 처리하기
		//3. 문제 등록자 담당팀장 결재 자동 등록 처리하기
		selectTeamManagerApprovalAdd();  //($("#issSts").val() == 'ISSSTS03')에 따라 등록인지 결과인지 판단함
        
        // 폼데이터 생성
        var formData = new FormData($("#popForm_S")[0]);
        //-------itemarr  --첨부화일 처리를 위한 부분 시작
        formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용
        formData.append("approvalYnCnt", approvalYn());
        formData.append("approvalYnCnt2", approvalYn2());
        formData.append("issNo", $("#popForm_S #issNo").val());
        formData.append("issFileTrgtKey", $("#popForm_S #fileTrgtKey").val());
        
        var fileUploadArr = [];
        var tempArr = [];
        tempArr = treeModule.getFileArr();
        $.each(tempArr, function(idx, obj) {
            if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
            }
        });
        
        formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
        //---------------------------------------------------------------
        //--첨부화일 처리를 위한 부분 끝
        //---------------------------------------------------------------
        
        // 문제정보 공유 결재 리스트 저장 넘김
        var rowSharngList = gridViewPop.target.list;
        var ParamObj = modalStack.last().paramObj.ParamObj;
        
        if(rowSharngList.length > 0) {
            var rowSharngListArr = []; //공유정보
            var rowApprovalListArr = []; //결재정보
            $.each(rowSharngList, function(idx, elem){
                var rowSharngListObj = elem;
                var rowApprovalListObj = elem;
                
                if (elem.gb == '공유'){
                    rowSharngListObj["gb"] = elem.gb;
                    rowSharngListObj["coCd"] = $('#coCd').val();
                    rowSharngListObj["salesCd"] = $('#salesCd').val();
                    rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
                    rowSharngListObj["todoDiv2CodeId"] = "TODODIV1030"; // WBS문제
                    rowSharngListObj["todoId"] = elem.usrNm;
                    rowSharngListObj["todoCoCd"] = elem.coCd;
                    rowSharngListObj["empNo"] = elem.empNo;
                    rowSharngListObj["name"] = elem.name;
                    rowSharngListObj["telNo"] = elem.telNo;
                    rowSharngListObj["email"] = elem.eMail;
                    rowSharngListObj["pgPath"] = "/user/wb/wb24/WB2401P01.html";
                    rowSharngListArr.push(rowSharngListObj);
                }
                else if (elem.gb == '결재'){
                    rowApprovalListObj["gb"] = elem.gb;
                    rowApprovalListObj["coCd"] = $('#coCd').val();
                    rowApprovalListObj["salesCd"] = $('#salesCd').val();
                    rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
                    rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2060"; // WBS문제
                    rowApprovalListObj["todoId"] = elem.usrNm;
                    rowApprovalListObj["todoCoCd"] = elem.coCd;
                    rowApprovalListObj["empNo"] = elem.empNo;
                    rowApprovalListObj["name"] = elem.name;
                    rowApprovalListObj["telNo"] = elem.telNo;
                    rowApprovalListObj["email"] = elem.eMail;
                    rowApprovalListObj["pgPath"] = "/user/wb/wb24/WB2401P01.html";
                    rowApprovalListArr.push(rowApprovalListObj);
                }
            });
            
            formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
            formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
        }
        
        // 조치정보 공유 결재 리스트 저장 넘김
        var rowSharngList2 = gridViewPop2.target.list;
        var ParamObj2 = modalStack.last().paramObj.ParamObj;
        
        if(rowSharngList2.length > 0) {
            var rowSharngListArr2 = []; //공유정보
            var rowApprovalListArr2 = []; //결재정보
            
            $.each(rowSharngList2, function(idx, elem){
                var rowSharngListObj2 = elem;
                var rowApprovalListObj2 = elem;
                
                if (elem.gb == '공유'){
                    rowSharngListObj2["gb"] = elem.gb;
                    rowSharngListObj2["coCd"] = $('#coCd').val();
                    rowSharngListObj2["salesCd"] = $('#salesCd').val();
                    rowSharngListObj2["todoDiv1CodeId"] = "TODODIV10";
                    rowSharngListObj2["todoDiv2CodeId"] = "TODODIV1090"; // WBS조치
                    rowSharngListObj2["todoId"] = elem.usrNm;
                    rowSharngListObj2["todoCoCd"] = elem.coCd;
                    rowSharngListObj2["empNo"] = elem.empNo;
                    rowSharngListObj2["name"] = elem.name;
                    rowSharngListObj2["telNo"] = elem.telNo;
                    rowSharngListObj2["email"] = elem.eMail;
                    rowSharngListObj2["pgPath"] = "/user/wb/wb24/WB2401P01.html";
                    rowSharngListArr2.push(rowSharngListObj2);
                }
                else if (elem.gb == '결재'){
                    rowApprovalListObj2["gb"] = elem.gb;
                    rowApprovalListObj2["coCd"] = $('#coCd').val();
                    rowApprovalListObj2["salesCd"] = $('#salesCd').val();
                    rowApprovalListObj2["todoDiv1CodeId"] = "TODODIV20";
                    rowApprovalListObj2["todoDiv2CodeId"] = "TODODIV2090"; // WBS조치
                    rowApprovalListObj2["todoId"] = elem.usrNm;
                    rowApprovalListObj2["todoCoCd"] = elem.coCd;
                    rowApprovalListObj2["empNo"] = elem.empNo;
                    rowApprovalListObj2["name"] = elem.name;
                    rowApprovalListObj2["telNo"] = elem.telNo;
                    rowApprovalListObj2["email"] = elem.eMail;
                    rowApprovalListObj2["pgPath"] = "/user/wb/wb24/WB2401P01.html";
                    rowApprovalListArr2.push(rowApprovalListObj2);
                }
            });
            
            formData.append("rowSharngListArr2", JSON.stringify(rowSharngListArr2));
            formData.append("rowApprovalListArr2", JSON.stringify(rowApprovalListArr2));
        }
        return formData;
    }
    
    //작성자, 담당자  검색
    function openUserSearch(type) {
        if (approval_Yn == "Y") {
            return;
        }

        var userID = null;
        var paramObj = {};
        paramObj["coCd"] = jwt.coCd;
        paramObj["userId"] = $('#popForm_S #actId').val();
        paramObj["useYn"] =  "Y";
        openModal("/static/html/cmn/modal/userSearch.html", 450, 650, "작성자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            userID = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            
            //부서별 발주요청서 등록사유 자동 생성하기
            createHtmlCode1(checkedNode.parent.slice(0,5))
            
            $('#popForm_S #actId').val(checkedNode.id);
            $('#popForm_S #actNm').val(checkedNode.text);
            
            var paramObj = {"coCd" : $('#coCd').val(), "userId" : userID};
            postAjaxSync("/user/wb/wb24/selectRsltsMemberList", paramObj, null, function(data) {
                var chk = false;
                var rowList = gridViewPop.target.getList();
                $.each(rowList, function(idx, elem){
                    if (elem.usrNm == data.resultList[0].usrNm) {
                        chk = true;
                    }
                });
                
                if (chk == false) {
                    gridViewPop.target.addRow($.extend({}, "last", false));
                    var row = gridViewPop.target.getList().length - 1;
                    gridViewPop.target.setValue(row, "gb", '결재');
                    gridViewPop.target.setValue(row, "wbsPlancoCdNm", data.resultList[0].wbsPlancoCdNm);
                    gridViewPop.target.setValue(row, "usrNm", data.resultList[0].usrNm); //ID
                    gridViewPop.target.setValue(row, "empNo", data.resultList[0].empNo); // 사원번호
                    gridViewPop.target.setValue(row, "name",data.resultList[0].name); // 성명
                    gridViewPop.target.setValue(row, "jik", data.resultList[0].jik); // 직위
                    gridViewPop.target.setValue(row, "reqDate", data.resultList[0].reqDate); // 요청일자
                    gridViewPop.target.setValue(row, "todoCfDt",""); // 확인일자
                    gridViewPop.target.setValue(row, "todoCfOpn",""); // 확인의견  
                    gridViewPop.target.setValue(row, "telNo",data.resultList[0].telNo); // 핸드폰번호
                } else {
                    alert("중복 공유를 지정할 수 없습니다.");
                    return;
                }
            });
        });
    }

    
    function createHtmlCode1(workDept){
		//등록사유 자동생성 코드
        if (workDept == 'TRN30') workDept = 'TRN50';	//트루넷직접매출
        if (workDept == 'GUN70') workDept = 'GUN60';	//생산관리
        if (workDept == 'GUN90') workDept = 'TRN50';	//구매협력업체
        if (workDept == 'GUN50') workDept = 'TRN50';	//구매외주팀 (건양ITT)
        if (workDept == 'GUN95') workDept = 'TRN50';	//실적관리용 (건양ITT)
        if (workDept == 'GUN80') workDept = 'GUN40';	//전산실
     	createCheckBox(workDept);   //부서별 장애원인 자동 생성
    }
    
    //문제  공유, 결재 대상자 추가//
    function insertShareUserModal() {
        if (evlCloseChk == "Y") {
            alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }
        
        if( approvalYn() ) {
            alert("결재가 이미 진행중입니다.");
            return;
        }
        
        var paramObj = {};
        var appshaList = gridViewPop.target.list;
        
        paramObj["coCd"] = $('#coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $('#ordrgId').val();
        paramObj["userNm"] =  $('#ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
            return {
                gb: "결재",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
            return {
                gb: "공유",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        openModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid) {
            // console.log('결재라인 : ', approvalGrid.target.list);
            // console.log('공유라인 : ', shareGrid.target.list);
            
            var appArray = approvalGrid.target.list.map(function(item) {
                return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });
            var shaArray = shareGrid.target.list.map(function(item) {
                return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });
            gridViewPop.setData2(appArray.concat(shaArray));
        });
    }
    
    //문제  공유, 결재 대상자 삭제//
    function deleteShareUser() {
        if (evlCloseChk == "Y") {
            alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }
        
        // 문제 결재 대상차 추가 시 관련 결재 진행건이 있는경우 알림처리 리턴
        if( approvalYn() ) {
            alert("결재가 이미 진행중입니다.");
            return;
        }
        
        var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
        if( isNaN(selRow) ) {
//             alert("선택된 행이 없습니다.");
            return;
        } else {
            if( selRow > -1 ) {
                gridViewPop.target.removeRow(selRow);
            }
        }
    }
    
    //조치  공유, 결재 대상자 추가//
    function insertShareUserModal2() {
        if (evlCloseChk == "Y") {
            alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }
        
        // 조치 결재 대상차 추가 시 관련 결재 진행건이 있는경우 알림처리 리턴
        if( approvalYn2() ) {
            alert("결재가 이미 진행중입니다.");
            return;
        }
        
        var paramObj = {};
        var appshaList = gridViewPop2.target.list;
        paramObj["coCd"] = $('#coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $('#ordrgId').val();
        paramObj["userNm"] =  $('#ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재"; }).map(function(item) {
            return {
                gb: "결재",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
            return {
                gb: "공유",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        openModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid) {
            // console.log('결재라인 : ', approvalGrid.target.list);
            // console.log('공유라인 : ', shareGrid.target.list);
            
            var appArray = approvalGrid.target.list.map(function(item) {
                return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });
            var shaArray = shareGrid.target.list.map(function(item) {
                return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });
            gridViewPop2.setData2(appArray.concat(shaArray));
        });
    }
    
    //조치  공유, 결재 대상자 삭제//
    function deleteShareUser2() {
        if (evlCloseChk == "Y") {
            alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }
        
        if( approvalYn2() ) {
            alert("결재가 이미 진행중입니다.");
            return;
        }
        
        var selRow = parseInt(gridViewPop2.target.selectedDataIndexs);
        if( isNaN(selRow) ) {
//             alert("선택된 행이 없습니다.");
            return;
        } else {
            if( selRow > -1 ) {
                gridViewPop2.target.removeRow(selRow);
            }
        }
    }
    
    // 문제관련 결재 진행건이 있는지 체크
    function approvalYn() {
        var gridList = gridViewPop.target.getList();
        var inCnt = 0;
        if( gridList.length > 0 ) {
            var msgArr = [];
            $.each(gridList, function (idx, elem) {
                //결재자가 본인이 아니면서 상태가 Y인 경우
                if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
            })
        }
        return inCnt;
    }
    
    //조치관련 결재 진행건이 있는지 체크
    function approvalYn2() {
        var gridList = gridViewPop2.target.getList();
        var inCnt = 0;
        
        if( gridList.length > 0 ) {
            var msgArr = [];
            $.each(gridList, function (idx, elem) {
                //결재자가 본인이 아니면서 상태가 Y인 경우
                if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
            })
        }
        return inCnt;
    }
    
    //요인별요청번호 검색
    function openPurchaseSearch() {
        if (act_approval_Yn == "Y") {
            return;
        }

        var paramObj = {
            "coCd" : $("#popForm_S #coCd").val(),
            "searchValue" : $("#popForm_S #salesCd").val(),
            "orderFlag" : "Y"
        }
        openThirdModal("/static/html/cmn/modal/purchaseSearch.html", 1200, 680, "요인별요청번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $("#popForm_S #reqNo").val(row.reqNo);
        });
    }

    //입력정보
	function select_wb2401p01_Info() {
		if(modalStack.last().paramObj.issFileTrgtKey == '' || modalStack.last().paramObj.issFileTrgtKey == undefined) {
            return;
		} else {
            issFileTrgtKey = modalStack.last().paramObj.issFileTrgtKey;
		}

        var formData = {
            "fileTrgtKey" : issFileTrgtKey
        }
        postAjaxSync("/user/wb/wb24/select_wb2401p01_Info", formData, null, function(data) {

            //부서별 발주요청서 등록사유 자동 생성하기
			let tempDeptId = data.result.actDeptId.slice(0,5);
			if (!tempDeptId) tempDeptId = data.result.creatDeptId.slice(0,5);
            createHtmlCode1(tempDeptId);
            
            $.each(data.result, function(key, value) {
				if ($('#popForm_S #' + key)[0]) {
					$('#popForm_S #' + key).val(value);
					
					if ($('#popForm_S #' + key).is('[comma]')) {
						onlyNumber($('#popForm_S #' + key)[0]);
					}
				}
				if (key == 'subCd'){//등록사유체크하기
					$('#'+value).prop("checked", true);
  				}
			});

            //결재카운트 기준 문제정보 입력 제어
            if (data.result.appCnt == "0") {
                approval_Yn = 'N';
            } else {
                approval_Yn = 'Y';
                $("#actionBtn").hide();
            }

            // 문제정보 입력제어
            iss_edit_chk(approval_Yn);

            if (data.result.actAppCnt == "0") {
                act_approval_Yn = 'N';
            } else {
                act_approval_Yn = 'Y';
            }

            // 조치정보 입력제어
            act_edit_chk(act_approval_Yn);

            // 문제 결재, 조치 결재가 있는 경우 수정버튼 안보이게
//             if (approval_Yn == "Y" && act_approval_Yn == "Y") {
//                 $("#actionBtn").hide();
//             }
			//진행상태가 완료(ISSSTS03) 이면서 결재완료이면 수정버튼 숨김
            if (act_approval_Yn == "Y" || $('#issSts').val() == 'ISSSTS03') {
            	iss_edit_chk('Y');
                act_edit_chk('Y');
                $("#actionBtn").hide();
                $("#actDngEvalTr").show();
            }
            //결재카운트 기준 문제정보 입력 제어 끝

	        $('.tit').text(data.result.salesCd + " " + data.result.wbsPlanCodeKindNm +"단계 WBS 계획 문제");
		  	  txtareaHeightResize($('#issCnts'));  //문제현황 크기 조절하기
		  	  txtareaHeightResize($('#actCnts'));  //조치내용 크기 조절하기
		  	  txtareaHeightResize($('#measRst'));  //조치내용 크기 조절하기
		});
		// ModalgridView.setData(0);
	}

    function iss_edit_chk(approval_Yn) {
        if (approval_Yn == "Y") {
            //유형 비활성화
			// $('#popForm_S .issDiv').removeClass('hit');
			$('#issDiv').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

            //상태 비활성화
// 			$('#issSts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//제목 비활성화
			$('#issSj').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			
			//내용 비활성화
			$('#issCnts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//조치담당자
			$('#actNm').prop('disabled', true);

			//등록사유 radio 비활성화
// 			$('input[name="CODECOBGB"]').attr('disabled', true);
// 			$('input[name="CODECOBGB"]').prop('disabled', true);
            $('input[name="CODECOBGB"]').addClass('no-click').each(function() {
                $(this).on('click', function(e) {
                    e.preventDefault();
                });
            });
            
            $("#popForm_S #btn_plus1").hide();
            $("#popForm_S #btn_minus1").hide();
            
        } 
    }

    function act_edit_chk(act_approval_Yn) {
        if (act_approval_Yn == "Y") {
            //상태 비활성화
			$('#issSts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
            //시작일 비활성화
			$('#actsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
            //종료일 비활성화
			$('#acteDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//투입공수 비활성화
			$('#actMh').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//투입비용 비활성화
			$('#actAmt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
            //조치내용 비활성화
			$('#measRst').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$('#actCnts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$('#reqNo').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$('#actDng').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$('#actAmtSts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$('#actDngEval').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

			$('#reqNo').prop('disabled', true);
            
            $("#popForm_S #btn_plus2").hide();
            $("#popForm_S #btn_minus2").hide();
        }
    }
    
    function kakaoTodo() {
        let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
        

        // 1. 문제 공유, 결재 프로세스 진행상태(ISSSTS03 != 완료가 아닌경우)인 경우에 조치정보 공유 및 결재자 알림 처리
        if ($('#issSts').val() != 'ISSSTS03') {
	        var rowList = gridViewPop.target.getList();
	        var sharChk = 0;
	        var appChk = 0;
	
	        $.each(rowList, function(idx, elem){
	            if (elem.gb == "공유") {
	                sharChk++;
	            }
	            else if (elem.gb == "결재") {
	                appChk++;
	            }
	        });
	        
	        // 1-1. WBS 계획 문제 공유 알림톡 처리
	        if (sharChk > 0) {
	            kakaoSendBody('TODODIV10','TODODIV1030', 'WBS문제','WBS계획문제','공유');
	        }
	        
	        // 1-2. WBS 계획 문제 결재 알림톡 처리
	        if (appChk > 0) {
	            kakaoSendBody('TODODIV20','TODODIV2060', 'WBS문제','WBS계획문제','결재');
	        }
        }
        
        // 조치 공유, 결재 프로세스 진행상태(ISSSTS03 = 완료)인 경우에 조치정보 공유 및 결재자 알림 처리
        if ($('#issSts').val() == 'ISSSTS03') {
	        var rowList2 = gridViewPop2.target.getList();
	        var sharChk2 = 0;
	        var appChk2 = 0;
	        
	        $.each(rowList2, function(idx, elem){
	            if (elem.gb == "공유") {
	                sharChk2++;
	            }
	            else if (elem.gb == "결재") {
	                appChk2++;
	            }
	        });
	        
	        // 2-1. WBS 계획 조치 공유 알림톡 처리
	        if (sharChk2 > 0) {
	            kakaoSendBody('TODODIV10','TODODIV1090', 'WBS조치','WBS계획조치','공유');
	        }
	        
	        // 2-2. WBS 계획 조치 결재 알림톡 처리
	        if (appChk2 > 0) {
	            kakaoSendBody('TODODIV20','TODODIV2090', 'WBS조치','WBS계획조치','결재');
	        }
        }
        
        if (kakaoCnt > 0) {
            kakaoCnt = 0;
            // alert("알림톡이 정상 발송되었습니다.");
        }
    }

    // KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
    function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
        let param = {
            "tmplatDiv": "TMPLATDIV02"
            , "coCd": $("#popForm_S #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": todoDiv1CodeId //"TODODIV10"                 //공통코드 해당업무 - 결재
            , "todoDiv2CodeId": todoDiv2CodeId // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv1CodeNm": todoDiv1CodeNm // "WBS문제"                        //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv2CodeNm": todoDiv2CodeNm // "WBS계획문제"                       //공통코드 해당업무 - 결재 - 발주서
            , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $("#popForm_S #issNo").val()
            , "clntCd": "1"                 //발신회사는 로그인사용자 회사
            , "clntNm": $("#popForm_S #clntNm").val()              //로그의 수신거래처명
            , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
            , "ordrgMngTelNo": $("#popForm_S #telNo").val()       //담당자전화번호    
            , "creatPgm": "WB2401P01"
        }
        commKaKaoSendTodo(param);
    }
    
    //to-do결재요청 알림톡
    function commKaKaoSendTodo(param) {
        // console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

        //알림톡수신번호 채번
        var maxMessageId = null;            //message id(unique key)
        var talkMessage = null              //발송될 내용 template
        var mobile = null                   //수신인 휴대전화번호
        var title = null                    //todo title
        var sendList = [];
        let talkParam = {};
        let talkBody = {};
        let sendCnt = 0;
        // postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null, function(data) {
        postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo_kakao", param, null, function(data) {
            if(data.resultList.length > 0 ) {
                if( data.resultList[0].maxMessageId != "" ) {
                    sendList = data.resultList;
                } else {
                    alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                    return;
                }
            }
        });
        //user search ajax end
        
        //대상 loop
        $.each(sendList, function (key, sendObj) {
            maxMessageId = sendObj.maxMessageId;
            talkMessage = sendObj.messageDesc;
            mobile =  sendObj.telNo;
            //로그용
            param.rcvId = sendObj.todoId;           //todo 수신id
            param.rcvNm = sendObj.name;             //todo 수신자명
            param.nameTo = sendObj.name;                //todo 수신자명
            
            // 알림톡 Title 자리수 제한 문자열 자르기
            if (sendObj.todoTitl.length > 30) {
                title = sendObj.todoTitl.substring(0,25);
            } else {
                title = sendObj.todoTitl;
            }
            
            param.title = title;                                //요청내용제목
            param.sendDt = sendObj.sendDt;
            
            if(mobile == "" || mobile == null) {
                alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
                return;
            }

            if(talkMessage == "" || talkMessage == null) {
                alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
                return;
            }
            
            //message 치환
            let message = talkMessage;
            let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`); 
            //loop
            $.each(splitStr, function (key, val) {      
                let compKey = val.substring(1, val.length-1);
                if( compKey != "" && compKey != "undefined" ) {
                    if( typeof(param[compKey]) != "undefined" ) {
                        let val2 = '#'+val;
                        message = message.replaceAll(val2, param[compKey]);
                    }
                }
            });
            talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
            talkParam.serverName = "gyitt2400";
            talkParam.paymentType = "P";
            talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
            talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값); 
    		if (title.length > 50) {
    			title = title.substring(0, 49); // 50자까지만 자르기
    		}
            talkBody.title = title;                 //알림톡 타이틀 -
            talkBody.message = message;             //알림톡 메시지 (1000 byte) 
            talkBody.mobile = mobile;               //휴대전화번호
            talkBody.template = "10003";            //템플릿관리화면 템플릿ID - 발주서 V2
            let talkJson = JSON.stringify(talkBody);
            sendCnt = kakaoSendReal(talkJson, talkParam, param);
        });
        //대상 loop end

        if( sendCnt > 0 ) {
            //alert("알림톡 정상 발송되었습니다.");
            kakaoCnt++;
        }
        
        //한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄
        // talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
        // talkBody.mobile = "01063893764"
        // talkJson = JSON.stringify(talkBody);
        //kakaoSendReal(talkJson, talkParam, param);
    }
    
    var kakaoErr = [];
    //message load
    var paramObj = {
        "userId" : jwt.userId,
        "codeKind" : "KAKAOMSG"
    };
    postAjax("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
        if(data.resultList.length > 0 ) {
            kakaoErr = data.resultList;
        }
    });
    //user search ajax end

	function txtareaHeightResize(obj) {
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 4)
			obj.css('height', "52px");
		else
			obj.css('height', (rowCount * 17) + "px");
	}

    
    //조치담당자 팀장 정보 가져오기
	function selectTeamManagerApprovalAdd() {
    	//------------------------------------------------
    	//문제등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
    	//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
    	//------------------------------------------------
    	let appshaList = [];
		if ($("#issSts").val() != 'ISSSTS03') { //문제생성시 조치자 팀장
			//문제생성시 등록담당자의 팀장 정보 가져오기 gridViewPop
	        appshaList = gridViewPop.target.getList();
    	} else {
			//처리결과 등록 결재자 정보 가져오기 gridViewPop2
	        appshaList = gridViewPop2.target.getList();
    	}
		 
		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		var tempActId = $("#actId").val();
        $.each(appshaList, function(idx, item){
            if (item.gb === "결재") {
            	appArray.push(item);
            } else {
            	//공유일경우 조치담당자가 공유에 있으면 제외처리함.
            	if (item.usrNm != tempActId) {
            		shaArray.push(item);
            	}
            }
        });
		//------------------------------------------------
		//문제등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------
     
		//조치결과자 결재정보 추가
		if ($("#issSts").val() != 'ISSSTS03') {  //결과처리인지? 확인
			appArray = approvalUserInfoData(tempActId, appArray);
		}
		appArray = approvalTeamManagerInfoData(tempActId, appArray);
		appArray = approvalTeamManagerInfoData(jwt.userId, appArray);
		

		if ($("#issSts").val() != 'ISSSTS03') {  //문제생성시 조치자 팀장
			gridViewPop.setData2(appArray.concat(shaArray));
		} else {
        	gridViewPop2.setData2(appArray.concat(shaArray));
		}
	}
    
    //조치담당자정보 자동 추가하기
	function approvalUserInfoData (appUserId, appArray) {
	    var formData = {
	        "userId" : appUserId,
	    }
	    postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
	    	if (data.resultList != '' && data.resultList!=null) { 
	    		//조치결과 결자자 정보 가져오기
	    		let list = data.resultList[0];
	    		if (appArray.some(item => item.usrNm === list.usrNm)) {
	    			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
	    		} else {
	    			appArray.push({
		                        gb: "결재",
		                        usrNm: list.usrNm,
		                        name: list.name,
		                        jik: list.jik,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                    });
	    		}
	    	}
		});
		return appArray;
	}
	
	

    //담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) { 
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
				               
		                    });
        		}
        	}
		});
		return appArray;
	}

	
    function gridResize() {
        const grdiHeight = $('#COBGB-checkboxContainer').height()-35;
        gridViewPop.target.setHeight(grdiHeight< 162 ? 162 : grdiHeight);
    }
    function gridResize2() {
    	let size = gridViewPop2.target.list.length;
        let tagHeight = (size) * 28 + 50 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 100 ? 100 : tagHeight;
        gridViewPop2.target.setHeight(tagHeight);
    }
</script>
