<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">WBS 계획 이슈</h4>
    </div>
    <div class="popup_table">
        <div class="form-group">            
            <form id="popForm_S">
                 <input type="hidden" id="actionType"   name="actionType">
                 <input type="hidden" id="coCd"   name="coCd">
                 <input type="hidden" id="userId" name="userId">
                 <input type="hidden" id="pgmId"  name="pgmId" value="WB2401P01">
                 <input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
                 <input type="hidden" id="salesCd" name="salesCd">
                 <input type="hidden" id="wbsPlanNo" name="wbsPlanNo">
                 <input type="hidden" id="wbsRsltsNo" name="wbsRsltsNo">
                 <input type="hidden" id="wbsPlanCodeKind" name="wbsPlanCodeKind">
                 <input type="hidden" id="wbsPlanCodeId" name="wbsPlanCodeId">
                 <input type="hidden" id="issNo" name="issNo">    
                 <input type="hidden" id="issFileTrgtKey" name="issFileTrgtKey">  
                 <input type="hidden" id="clntPjtNm" name="clntPjtNm"> 
                 <input type="hidden" id="clntNm" name="clntNm">         
                 
                 <table class="popup_table">
                     <colgroup>
                          <col width="25%">
                          <col width="30%">
                          <col width="25%">
                          <col width="25%">
                     </colgroup>
                     
                     <thead>
                         <tr>
                            <td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;">▣ TASK 정보</td>                                                
                         </tr>
                     </thead>
                        <tr style="text-align: left;">                         
                             <th>TASK명</th>
                             <td colspan="3"> 
                                <input type="text" id="wbsPlanCodeNm" name="wbsPlanCodeNm" readonly>                                
                             </td>                          
                        </tr>
                        <tr>
                             <th>시작일자</th>
                             <td> 
                               <input type="text" id="wbsPlansDt" name="wbsPlansDt" readonly>
                              
                             </td>                               
                             <th>종료일자</th>
                             <td>   
                                <input type="text" id="wbsPlaneDt" name="wbsPlaneDt" readonly>
                             </td>  
                         </tr>
                         
                         <tr>
                            <td colspan="4" bgcolor="gray" style="height:2px;"></td>                                                
                         </tr>
                         
                    <thead>
                         <tr>
                            <td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;">▣ 이슈정보</td>                                                
                         </tr>
                     </thead> 
                    <tr style="text-align: left;">   
                         <th class="hit">유형</th>
                         <td> 
                            <select id="issDiv" name="issDiv" required data-kind="ISSDIV"  msg="이슈유형">
                                        <option value="">선택</option>
                            </select>
                         </td> 
                                                  
                         <th class="hit">진행상태</th>
                         <td> 
                            <select id="issSts" name="issSts" required data-kind="ISSSTS" msg="진행상태">
                                <option value="">선택</option>
                            </select>
                         </td> 
                        
                                                      
                     </tr>
                     <tr style="text-align: left;">                            
                         <th class="hit">제목</th>
                         <td colspan="3"> 
                            <input type="text" id="issSj" name="issSj" required msg="이슈제목">
                         </td> 
                                                      
                     </tr>
                     <tr style="text-align: left;">                            
                         <th class="hit">내용</th>
                         <td colspan="3"> 
                            <textarea id="issCnts" name="issCnts" cols="87" rows="4"   style="border-width:1px;border-color:red;" required msg="이슈내용"> </textarea> 
                         </td> 
                                                      
                     </tr>
                     <tr style="text-align: left;">
                        <th>조치담당자</th>
                            <td>
                            <div class="search_form">
                               <input type="hidden" id="actId" name="actId">
                               <input type="text" id="actNm" name="actNm" onkeyUp="if(window.event.keyCode == 8){actId.value = ''};" readonly>
                               <a onclick="openUserSearch(1);">
                                   <i class="i_search_w"></i>
                               </a>
                               </div>
                            </td>
                            <td colspan="2">                            
                            </td>

                    </tr>
                 
                     <tr>
                      <td colspan="4" >
                           <table style="border:0px;">
			                   <tr style="height:30px;">
			                     <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 이슈정보 공유 및 결재</td>
			                     <td>
			                         <div class="add_btn_small pdl10">       
			                             <a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;" >+</a>
			                             <a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;" >-</a>    
			                         </div>
			                     </td>
			                   </tr>
			                   <tr>
			                     <td colspan="2">
			                      <div>
			                        <div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
			                      </div>
			                     </td> 
			                   </tr>  
			               </table>         
                      </td>                                                
                   </tr>
                 
                 
                    <tr>
                            <td colspan="4" bgcolor="gray" style="height:2px;"></td>                                                
                         </tr>
                     <thead>
                         <tr>
                            <td colspan="4" style="height:30px;text-align: left;font-weight:bold;font-size:14px;color:blue;">▣ 조치내역</td>                                                
                         </tr>
                     </thead>
                     <tbody>
                    <tr style="text-align: left;">
                        <th style="color:blue;">시작일자</th>
                        <td>
                        <div class="date_input">                            
                             <input type="text" class="input_calendar form-control" style="width: 100% !important; display: inline-block !important;" id="actsDt" name="actsDt" autocomplete="off" date onkeyup="dateMask(this);">
                             
                        </div>
                        </td>
                        <th style="color:blue;">종료일자</th>
                        <td>
                        <div class="date_input">
                            <input type="text" class="input_calendar form-control" style="width: 100% !important; display: inline-block !important;" id="acteDt" name="acteDt" autocomplete="off" date onkeyup="dateMask(this);"> 
                        </div>
                        </td>
                    </tr> 
                    <tr style="text-align: left;">
                     <th style="color:blue;">투입공수</th>
                        <td> 
                        <div class="search_form"  style="width: 100%;">
                            <input type="text" id="actMh" name="actMh" comma onkeyup="onlyNumber(this)"  >
                        </div>
                        </td>
                        
                        <th style="color:blue;">투입비용</th>
                        <td>
                        <div class="search_form">
                           <input type="text" id="actAmt" name="actAmt" comma  onkeyup="onlyNumber(this)"  >
                        </div>
                        </td>   
                    </tr>   
                    <tr style="text-align: left;">
                     <th style="color:blue;">발주요청번호</th>
                        <td> 
                        <div class="search_form">
                               <input type="text" id="reqNo" name="reqNo" readonly>
                               <a onclick="openPurchaseSearch();">
                                   <i class="i_search_w"></i>
                               </a>
                               </div>
                        </td>                        
                        <td colspan="2">                            
                        </td>
                    </tr>                    
                    <tr style="text-align: left;">
                        <th style="color:blue;">조치내용</th>
                        <td colspan=3>
                            <textarea id="actCnts" name="actCnts" cols="90" rows="4" msg="주요내용"  style="border:none;outline: none;"></textarea> 
                        </td>
                    </tr>     
                    </tbody>      
                 </table>  
                 <table style="border:0px;">
                     <tr style="height:30px;">
                       <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;color:blue;">※ 조치정보 공유 및 결재</td>
                       <td>
                           <div class="add_btn_small pdl10">       
                               <a onclick="insertShareUserModal2();" style="height: 30px; line-height: 28px;" >+</a>
                               <a onclick="deleteShareUser2();" style="height: 30px; line-height: 28px;" >-</a>    
                           </div>
                       </td>
                     </tr>
                     <tr>
                       <td colspan="2">
                        <div>
                          <div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
                        </div>
                       </td> 
                     </tr>  
                 </table>                  
               </form>                 
        </div>
    </div>
    

    <div class="contents"> 
    <!-- 공통 파일 영역 -->
         <div id="fileList_area" style="width:850px;"></div>       
    </div>
    
     <br>
    <div class="col-xs-2" style="height: 70px;">
    </div>

<div class ="popup_bottom_btn">
        <button type="button" id="actionBtn" >등록</button>
        <button type="button" class="close_btn"
            onclick="modalStack.close();">닫기</button>
    </div>
 </div>
    
<script type="text/javascript">
var actionType = null;
var evlCloseChk = "N";
setCommonSelect($(".popup_area select[data-kind]"));


// 이슈 공유 결재 리스트 
var gridViewPop = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $('[data-ax5grid="first-grid-modal"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                     onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        gridView.setData(this.page.selectPage);
                    }
                },
                columns : [
                        {key: "gb",                 label: "구분",        align: "center",   width: 40},
                        {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                        //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                        {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                        {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                        {key: "name",               label: "성명",        align: "center",   width: 80},
                        {key: "jik",                label: "직위",        align: "center",   width: 60},
                        {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
                        {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
                        {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
                        {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                        {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                      ]
                    });
                    return this;
                },

                setData : function(_pageNo) {
                    var targetObj = this.target;
                    var formData = {
                            "fileTrgtKey" : $("#popForm_S #issFileTrgtKey").val(),
                            "reqNo" :  $("#popForm_S #issNo").val(), 
                            "flag" :  "Y1",
                            "pageNo" : _pageNo + 1
                    }
                    postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data){
                    	//if (data.result.length > 0) {
		                    var list = data.result;
	                        targetObj.setData({
	                            list : list,
	                            page : {
	                                  totalElements :  data.paginationInfo.totalRecordCount,
	                            } 
	                        });		                       
                        //}
                        /* else {
                        	var paramObj = { 
                                    "userId": jwt.userId
                                    ,"appDiv": 'APPDIV05'
                            };
                            postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
                            var list = data.result;
                                targetObj.setData({
                                    list : list,
                                    page : { totalElements : list.length } 
                                });
                            });
                        } */
                    });
                },

                setData2 : function(_list) {
                    this.target.setData({
                            list : _list,
                            page : {
                                        totalElements :  _list.length,
                            } 
                        });
                }
    }
    
    
//조치 공유 결재 리스트 
	var gridViewPop2 = {
	        initView : function() {
	            this.target = new ax5.ui.grid();
	            this.target.setConfig({
	                showRowSelector: true,
	                multipleSelect: false,
	                sortable: false,
	                target: $('[data-ax5grid="second-grid-modal"]'),
	                header: {
	                    align: "center",
	                    selector: true
	                },
	                body: {
	                     onClick: function () {
	                        this.self.select(this.dindex);
	                    },
	                    onDBLClick: function () {
	                    },
	                    mergeCells : ["gb"],
	                },
	                page : {
	                    navigationItemCount : 10,
	                    height : 30,
	                    display : true,
	                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
	                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
	                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
	                    onChange : function() {
	                        gridView.setData(this.page.selectPage);
	                    }
	                },
	                columns : [
	                        {key: "gb",                 label: "구분",        align: "center",   width: 40},
	                        {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
	                        //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
	                        {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
	                        {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
	                        {key: "name",               label: "성명",        align: "center",   width: 80},
	                        {key: "jik",                label: "직위",        align: "center",   width: 60},
	                        {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
	                        {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
	                        {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
	                        {key: "telNo",              label: "H.P",       align: "center",   width: 130},
	                        {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
	                      ]
	                    });
	                    return this;
	                },
	
	                setData : function(_pageNo) {
	                    var targetObj = this.target;
	                    var formData = {
	                            "fileTrgtKey" : $("#popForm_S #issFileTrgtKey").val(),
	                            "reqNo" :  $("#popForm_S #issNo").val(),
	                            "flag" :  "Y2",
	                            "pageNo" : _pageNo + 1
	                    }
	                    postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data){
	                        //if (data.result.length > 0) {
	                            var list = data.result;
	                            targetObj.setData({
	                                list : list,
	                                page : {
	                                      totalElements :  data.paginationInfo.totalRecordCount,
	                                } 
	                            });                            
	                        //}
	                        /* else {
	                            var paramObj = { 
	                                    "userId": jwt.userId
	                                    ,"appDiv": 'APPDIV05'
	                            };
	                            postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
	                            var list = data.result;
	                                targetObj.setData({
	                                    list : list,
	                                    page : { totalElements : list.length } 
	                                });
	                            });
	                        } */
	                    });
	                },
	
	                setData2 : function(_list) {
	                    this.target.setData({
	                            list : _list,
	                            page : {
	                                        totalElements :  _list.length,
	                            } 
	                        });
	                }
	    }    
	       

$(document).ready(function() {
    actionType = modalStack.last().paramObj.actionType;
    $('#actionType').val(actionType);
    //등록시 조치내역 입력 못하게
    if (actionType == "C1" || actionType == "C3") {
    	$("#actsDt, #acteDt, #actMh, #actAmt, #actCnts").prop('readonly', true);
    // -----------------------------------	
    }else{
    	// 조치 시작일자, 종료일자 세팅
    	$('#actsDt').datepicker({
	        format : "yyyy-mm-dd",
	        language : "ko",
	        autoclose : true
	      })
	     .datepicker("setDate", moment(new Date()).startOf("month").toDate())
	     .on("changeDate", function(){
	         //조치 시작일자 종료일자 체크
	         //1. 조치시작일자는 계획 시작일자 이전일 수 없다.
	         
	         if($('#actsDt').val() < $('#wbsPlansDt').val()){
	             alert("조치 시작일은 계획 시작일 이전일 수 없습니다.");
	             $('#actsDt').datepicker("setDate", new Date($('#wbsPlansDt').val()));
	             return;
	         }
	         //2. 조치 시작일자는 조치 종료일자 이후 일 수 없다. 하지만 종료일자가 없으면 체크 안해야지
	         if($('#acteDt').val() && $('#actsDt').val() > $('#acteDt').val()){
	             alert("조치 시작일은 조치 종료일 이전일 수 없습니다.");
	             $('#actsDt').datepicker("setDate", new Date($('#wbsPlansDt').val()));
	             return;
	         }
	      });
	    
	     $('#acteDt').datepicker({
	        format : "yyyy-mm-dd",
	        language : "ko",
	        autoclose : true
	      })
	     .datepicker("setDate",  moment(new Date()).endOf("month").toDate())
	     .on("changeDate", function(){
	        if($('#actsDt').val() > $('#acteDt').val()){
	            alert("조치 시작일은 조치 종료일 이전일 수 없습니다.");
	            $('#acteDt').datepicker("setDate", new Date($('#wbsPlaneDt').val()));
	        }
	     });
    }
     
     $("#popForm_S #userId").val(jwt.userId);
     
     // 구분자 "C1": WBS 일정계획화면 -> 계획이슈 등록 시 사용, "C3":WBS 이슈 관리 화면 -> 계획이슈 등록 시 사용 
     if (actionType == "C1" || actionType == "C3") {
         //$('.tit1').text('WBS 이슈 등록')
         $('#actionBtn').text("등록");
         
         // 이슈번호 채번
         var strYear = new Date().toISOString().substring(2, 4);
         var planData = {
                 "coCd" : modalStack.last().paramObj.coCd,
                 "year" : "ISS" + strYear
             }; 
          postAjaxSync("/user/wb/wb24/selectMaxWbsIssueNo", planData, null, function(data){
        	    
              $("#popForm_S #issNo").val(data.result[0].issNo); 
          }); 
     }
     
     if (actionType == "C1" || actionType == "C3") {
         $('#actionBtn').text("등록");
          $('#actionBtn').on("click", function() {
             insertWbsIssue();
         }); 
     }
     else if (actionType == "U1" || actionType == "U3") {
         //$('.tit').text('WBS 이슈 수정')
         $('#actionBtn').text("수정");
         $('#actionBtn').on("click", function() {
             updateWbsIssue();
         });        
     }


    if (actionType == "C1" || actionType == "U1") { //C1:계획이슈 등록 U1:계획이슈 수정
        var row = gridView2.target.getList("selected")[0];
        if (row != undefined) {
            if (actionType == "C1") {
                $("#popForm_S #coCd").val(row.coCd);
                $("#popForm_S #salesCd").val(row.salesCd);
                $("#popForm_S #wbsPlanNo").val(row.wbsPlanNo);
                $("#popForm_S #wbsRsltsNo").val(row.wbsRsltsNo);
                $("#popForm_S #wbsPlanCodeKind").val(row.wbsPlanCodeKind);
                $("#popForm_S #wbsPlanCodeId").val(row.wbsPlanCodeId);
                $("#popForm_S #wbsPlanCodeNm").val(row.wbsPlanCodeNm);
                $("#popForm_S #wbsMngNm").val(row.wbsPlanMngNm);
                $("#popForm_S #wbsPlansDt").val(row.wbsPlansDt);
                $("#popForm_S #wbsPlaneDt").val(row.wbsPlaneDt); 
                
                $("#popForm_S #clntPjtNm").val(modalStack.last().paramObj.clntPjtNm); 
                $("#popForm_S #clntNm").val(modalStack.last().paramObj.clntNm); 
                
                
            }
            else if (actionType == "U1") {
                $.each(row, function (key, val) { 
                	$("#popForm_S #" + key).val(val);
                    if ($('#popForm_S #' + key).is('[comma]')) {
                        onlyNumber($('#popForm_S #' + key)[0]);
                    }
                });
                
                $("#popForm_S #clntPjtNm").val(modalStack.last().paramObj.clntPjtNm); 
                $("#popForm_S #clntNm").val(modalStack.last().paramObj.clntNm); 
                
                $("#popForm_S #issFileTrgtKey").val(row.pIssFileTrgtKey );
                $("#popForm_S #issDiv").val(row.pIssDiv         );
                $("#popForm_S #actId").val(row.pActId           );
                $("#popForm_S #issNo").val(row.pIssNo           );
                $("#popForm_S #issSts").val(row.pIssSts         );
                $("#popForm_S #issStsNm").val(row.pIssStsNm     );
                $("#popForm_S #issSj").val(row.pIssSj           );
                $("#popForm_S #issDivNm").val(row.pIssDivNm     );
                $("#popForm_S #issCnts").val(row.pIssCnts       );
                $("#popForm_S #actNm").val(row.pActNm           );
                $("#popForm_S #actsDt").val(row.pActsDt         );
                $("#popForm_S #acteDt").val(row.pActeDt         );
                $("#popForm_S #actMh").val(row.pActMh           );
                $("#popForm_S #actAmt").val(row.pActAmt         );
                onlyNumber($('#popForm_S #actAmt')[0]);
                $("#popForm_S #actCnts").val(row.pActCnts       );
            }
        }
    }
    else if (actionType == "C3" || actionType == "U3" ) {//C3:이슈 - 계획이슈 등록 U3:이슈-계획이슈 수정
    
        
        var row = salesGridView.target.getList("selected")[0];
        if (row != undefined) {
            if (actionType == "C3") { 
            	$("#popForm_S #coCd").val(row.coCd);
                $("#popForm_S #salesCd").val(row.salesCd);
                $("#popForm_S #wbsPlanNo").val(row.pPlanNo);
                $("#popForm_S #wbsRsltsNo").val(row.pRsltsNo);
                $("#popForm_S #wbsPlanCodeKind").val(row.wbsPlanCodeKind);
                $("#popForm_S #wbsPlanCodeId").val(row.wbsPlanCodeId);
                $("#popForm_S #wbsPlanCodeNm").val(row.wbsPlanCodeNm);
                $("#popForm_S #wbsMngNm").val(row.wbsMngNm);
                $("#popForm_S #wbsPlansDt").val(row.wbsPlansDt);
                $("#popForm_S #wbsPlaneDt").val(row.wbsPlaneDt);  
                
                $("#popForm_S #clntPjtNm").val(row.clntPjtNm); 
                $("#popForm_S #clntNm").val(row.clntNm); 
                
                
            }
            else if (actionType == "U3"){
                $.each(row, function (key, val) { 
                	
                	if (key == "pPlanNo") {
                		$("#popForm_S #wbsPlanNo").val(row.pPlanNo);
                	}
                	else if (key == "pRsltsNo") {
                		$("#popForm_S #wbsRsltsNo").val(row.pRsltsNo);
                	}
                	else {
                		$("#popForm_S #" + key).val(val);                        
                	}
                    if ($('#popForm_S #' + key).is('[comma]')) {
                        onlyNumber($('#popForm_S #' + key)[0]);
                    }                
                });  
            }                               
        }
    }
    

    gridViewPop.initView().setData(0);
    
    gridViewPop2.initView().setData(0);
        
    
    //---------------------------------------------------------------  
      //첨부 화일 처리 시작 
      //---------------------------------------------------------------
      fileParam = {
              fileTrgtTyp : $("#popForm_S #pgmId").val(),
              fileTrgtKey     :$("#popForm_S #issFileTrgtKey").val()
      }
      treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
      //---------------------------------------------------------------  
      //첨부 화일 처리 끝
      //---------------------------------------------------------------  
      
      authChk();
      
      
      // 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
      var paramObj = {
              "coCd" : $("#popForm_S #coCd").val(),
              "salesCd" : $("#popForm_S #salesCd").val(),
          }; 
       postAjaxSync("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data){
    	   if (data.result[0].closeChk == "Y") {
    		   evlCloseChk = data.result[0].closeChk;
    		   $('#actionBtn').hide();
    	    }
       });        
       // ----------------------------------
});

function insertWbsIssue() {    
    if (inputValidation($('.popup_area [required]'))) { 
        var formData = makeFormData();                                      
        filePostAjax("/user/wb/wb24/wbsIssueInsert", formData,             
                function(data) {
                    alert(data.resultMessage);                              
                    if (data.resultCode == 200) { 
                        if (actionType == "C1" || actionType == "U1") {
                            gridView2.setData(0);
                        }
                        else if (actionType == "C3" || actionType == "U3"){
                            salesGridView.setData(0);                            
                        }
                        modalStack.close();                              
                    }
                });                                
    }
}

function updateWbsIssue() {    
    if (inputValidation($('.popup_area [required]'))) { 
        var formData = makeFormData();  
        filePostAjax("/user/wb/wb24/wbsIssueUpdate", formData,             
                function(data) {
                    alert(data.resultMessage);                              
                    if (data.resultCode == 200) {                          
                        if (actionType == "C1" || actionType == "U1") {
                            gridView2.setData(0);
                        }
                        else if (actionType == "C3" || actionType == "U3"){
                            salesGridView.setData(0);                            
                        }
                        modalStack.close();                              
                    }
                });                                
    }
}



function makeFormData() {  
    $.each($('.popup_area input[comma]'), function(idx, elem) {
        deleteComma(elem);
    });
    if (actionType == "C1" 
        || actionType == "U1"
        || actionType == "C3"
        || actionType == "U3"
       ) {
        $('#popForm_S #wbsRsltsNo').val("");                 
    }
    else if (actionType == "C2" 
            || actionType== "U2"
            || actionType == "C4"
            || actionType == "U4"
            ) {
        $('#popForm_S #wbsPlanNo').val(""); 
    }
    
    
    // 폼데이터 생성
    var formData = new FormData($("#popForm_S")[0]);
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
    formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용

    
    formData.append("approvalYnCnt", approvalYn());
    
    formData.append("approvalYnCnt2", approvalYn2());
    
    
    var fileUploadArr = [];
    var tempArr = [];
    
    tempArr = treeModule.getFileArr();
    $.each(tempArr, function(idx, obj) {
        if (obj.fileKey == 0) {
            formData.append("files", obj.file);
            obj.file = '';
            fileUploadArr.push(obj);
        }
    });

    formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
    formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
    //---------------------------------------------------------------  
    //--첨부화일 처리를 위한 부분 끝
    //--------------------------------------------------------------- 

    
   // 이슈정보 공유 결재
   var rowSharngList = gridViewPop.target.list;
   var ParamObj = modalStack.last().paramObj.ParamObj;

   if(rowSharngList.length > 0) {
       var rowSharngListArr = []; //공유정보
       var rowApprovalListArr = []; //결재정보
       $.each(rowSharngList, function(idx, elem){
           var rowSharngListObj = elem;
           var rowApprovalListObj = elem;

           if (elem.gb == '공유'){
               rowSharngListObj["gb"] = elem.gb;
               rowSharngListObj["coCd"] = $('#coCd').val();
               rowSharngListObj["salesCd"] = $('#salesCd').val();
               rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
               rowSharngListObj["todoDiv2CodeId"] = "TODODIV1030"; // WBS이슈
               rowSharngListObj["todoId"] = elem.usrNm;
               rowSharngListObj["todoCoCd"] = elem.coCd;
               rowSharngListObj["empNo"] = elem.empNo;
               rowSharngListObj["name"] = elem.name;
               rowSharngListObj["telNo"] = elem.telNo;
               rowSharngListObj["email"] = elem.eMail;    
               rowSharngListObj["pgPath"] = "/user/wb/wb24/WB2401P02.html";
               rowSharngListArr.push(rowSharngListObj);

           }
           else if (elem.gb == '결재'){
               rowApprovalListObj["gb"] = elem.gb;
               rowApprovalListObj["coCd"] = $('#coCd').val();
               rowApprovalListObj["salesCd"] = $('#salesCd').val();
               rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
               rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2060"; // WBS이슈
               rowApprovalListObj["todoId"] = elem.usrNm;
               rowApprovalListObj["todoCoCd"] = elem.coCd;
               rowApprovalListObj["empNo"] = elem.empNo;
               rowApprovalListObj["name"] = elem.name;
               rowApprovalListObj["telNo"] = elem.telNo;
               rowApprovalListObj["email"] = elem.eMail;    
               rowApprovalListObj["pgPath"] = "/user/wb/wb24/WB2401P02.html";
               rowApprovalListArr.push(rowApprovalListObj);
           }
       });
       formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
       formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
       
   }
   
   
   
   // 조치정보 공유 결재
   var rowSharngList2 = gridViewPop2.target.list;
   var ParamObj2 = modalStack.last().paramObj.ParamObj;

   if(rowSharngList2.length > 0) {
	   
       var rowSharngListArr2 = []; //공유정보
       var rowApprovalListArr2 = []; //결재정보
       
       $.each(rowSharngList2, function(idx, elem){
    	   
           var rowSharngListObj2 = elem;
           var rowApprovalListObj2 = elem;

           if (elem.gb == '공유'){
               rowSharngListObj2["gb"] = elem.gb;
               rowSharngListObj2["coCd"] = $('#coCd').val();
               rowSharngListObj2["salesCd"] = $('#salesCd').val();
               rowSharngListObj2["todoDiv1CodeId"] = "TODODIV10";
               rowSharngListObj2["todoDiv2CodeId"] = "TODODIV1090"; // WBS조치
               rowSharngListObj2["todoId"] = elem.usrNm;
               rowSharngListObj2["todoCoCd"] = elem.coCd;
               rowSharngListObj2["empNo"] = elem.empNo;
               rowSharngListObj2["name"] = elem.name;
               rowSharngListObj2["telNo"] = elem.telNo;
               rowSharngListObj2["email"] = elem.eMail;    
               rowSharngListObj2["pgPath"] = "/user/wb/wb24/WB2401P02.html";
               rowSharngListArr2.push(rowSharngListObj2);

           }
           else if (elem.gb == '결재'){
               rowApprovalListObj2["gb"] = elem.gb;
               rowApprovalListObj2["coCd"] = $('#coCd').val();
               rowApprovalListObj2["salesCd"] = $('#salesCd').val();
               rowApprovalListObj2["todoDiv1CodeId"] = "TODODIV20";
               rowApprovalListObj2["todoDiv2CodeId"] = "TODODIV2090"; // WBS조치
               rowApprovalListObj2["todoId"] = elem.usrNm;
               rowApprovalListObj2["todoCoCd"] = elem.coCd;
               rowApprovalListObj2["empNo"] = elem.empNo;
               rowApprovalListObj2["name"] = elem.name;
               rowApprovalListObj2["telNo"] = elem.telNo;
               rowApprovalListObj2["email"] = elem.eMail;    
               rowApprovalListObj2["pgPath"] = "/user/wb/wb24/WB2401P02.html";
               rowApprovalListArr2.push(rowApprovalListObj2);
           }
       });
       formData.append("rowSharngListArr2", JSON.stringify(rowSharngListArr2));
       formData.append("rowApprovalListArr2", JSON.stringify(rowApprovalListArr2));
       
   }
   
   
   return formData;
}


//작성자, 담당자  검색
function openUserSearch(type) {
	var userID = null;
    var paramObj = {};
    paramObj["coCd"] = jwt.coCd;
    paramObj["userId"] = $('#popForm_S #actId').val();
    paramObj["useYn"] =  "Y";
    openModal("/static/html/cmn/modal/userSearch.html", 300, 500, "작성자 검색", paramObj, function (tree){
        var checkedId = tree.get_checked()[0];
        userID = tree.get_checked()[0];
        var checkedNode = tree.get_node(checkedId);
        
        $('#popForm_S #actId').val(checkedNode.id);
        $('#popForm_S #actNm').val(checkedNode.text);
        
        
        var paramObj = {"coCd" : $('#coCd').val(), "userId" : userID};   
        postAjaxSync("/user/wb/wb24/selectRsltsMemberList", paramObj, null, function(data){
                var chk = false;
                var rowList = gridViewPop.target.getList();
                $.each(rowList, function(idx, elem){
                    if (elem.usrNm == data.resultList[0].usrNm) {
                        chk = true;
                    }
                });     
                if (chk == false) { 
                    gridViewPop.target.addRow($.extend({}, "last", false));                                                     
                    var row = gridViewPop.target.getList().length - 1;
                    gridViewPop.target.setValue(row, "gb", '공유');
                    gridViewPop.target.setValue(row, "wbsPlancoCdNm", data.resultList[0].wbsPlancoCdNm);
                    gridViewPop.target.setValue(row, "usrNm", data.resultList[0].usrNm); //ID
                    gridViewPop.target.setValue(row, "empNo", data.resultList[0].empNo); // 사원번호
                    gridViewPop.target.setValue(row, "name",data.resultList[0].name); // 성명
                    gridViewPop.target.setValue(row, "jik", data.resultList[0].jik); // 직위
                    gridViewPop.target.setValue(row, "reqDate", data.resultList[0].reqDate); // 요청일자
                    gridViewPop.target.setValue(row, "todoCfDt",""); // 확인일자
                    gridViewPop.target.setValue(row, "todoCfOpn",""); // 확인의견  
                    gridViewPop.target.setValue(row, "telNo",data.resultList[0].telNo); // 핸드폰번호 
    
                }
                else {
                    alert("중복 공유를 지정할 수 없습니다.");
                    return;
                }
        });                
    });  
}


//공유대상자 추가//  
function insertShareUserModal() {    
	if (evlCloseChk == "Y") {
		alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
        return;
	}
	
	if( approvalYn() ) {
        alert("결재가 이미 진행중입니다.");
        return;
    }
    var paramObj = {};
    var appshaList = gridViewPop.target.list;
    paramObj["coCd"] = $('#coCd').val();
    paramObj["useYn"] =  "Y";
    paramObj["userId"] =  $('#ordrgId').val();
    paramObj["userNm"] =  $('#ordrgNm').val();
    paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";   
            }).map(function(item) {
                    return {
                        gb: "결재",
                        id: item.usrNm,
                        text: item.name,
                        parent: item.jik,
                        deptNm: item.dtNm,
                        telNo: item.telNo,
                        offTelNo: item.offTelNo,
                        email: item.email
                    };
            });
    paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
            }).map(function(item) {
                    return {
                        gb: "공유",
                        id: item.usrNm,
                        text: item.name,
                        parent: item.jik,
                        deptNm: item.dtNm,
                        telNo: item.telNo,
                        offTelNo: item.offTelNo,
                        email: item.email
                    };
            });
    openModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
        console.log('결재라인 : ', approvalGrid.target.list);
        console.log('공유라인 : ', shareGrid.target.list);
        
        var appArray = approvalGrid.target.list.map(function(item) {
              return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
        });
        var shaArray = shareGrid.target.list.map(function(item) {
          return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
        });
        gridViewPop.setData2(appArray.concat(shaArray));
        
    });
    
}   

function deleteShareUser(){ 
	if (evlCloseChk == "Y") {
        alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
        return;
    }
	
	if( approvalYn() ) {
        alert("결재가 이미 진행중입니다.");
        return;
    }
    var selRow = parseInt(gridViewPop.target.selectedDataIndexs);    
    if( isNaN(selRow) ) {
        alert("선택된 행이 없습니다.");
        return;
    } else {            
            if( selRow > -1 ) {
                gridViewPop.target.removeRow(selRow);                   
            }
    }
}


//공유대상자 추가//  
function insertShareUserModal2() {  
	if (evlCloseChk == "Y") {
        alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
        return;
    }
	
	if( approvalYn2() ) {
        alert("결재가 이미 진행중입니다.");
        return;
    }
    var paramObj = {};
    var appshaList = gridViewPop2.target.list;
    paramObj["coCd"] = $('#coCd').val();
    paramObj["useYn"] =  "Y";
    paramObj["userId"] =  $('#ordrgId').val();
    paramObj["userNm"] =  $('#ordrgNm').val();
    paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";   
            }).map(function(item) {
                    return {
                        gb: "결재",
                        id: item.usrNm,
                        text: item.name,
                        parent: item.jik,
                        deptNm: item.dtNm,
                        telNo: item.telNo,
                        offTelNo: item.offTelNo,
                        email: item.email
                    };
            });
    paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
            }).map(function(item) {
                    return {
                        gb: "공유",
                        id: item.usrNm,
                        text: item.name,
                        parent: item.jik,
                        deptNm: item.dtNm,
                        telNo: item.telNo,
                        offTelNo: item.offTelNo,
                        email: item.email
                    };
            });
    openModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
        console.log('결재라인 : ', approvalGrid.target.list);
        console.log('공유라인 : ', shareGrid.target.list);
        
        var appArray = approvalGrid.target.list.map(function(item) {
              return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
        });
        var shaArray = shareGrid.target.list.map(function(item) {
          return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
        });
        gridViewPop2.setData2(appArray.concat(shaArray));
        
    });
    
}   

function deleteShareUser2(){    
	if (evlCloseChk == "Y") {
        alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
        return;
    }
	
	if( approvalYn2() ) {
        alert("결재가 이미 진행중입니다.");
        return;
    }
    var selRow = parseInt(gridViewPop2.target.selectedDataIndexs);    
    if( isNaN(selRow) ) {
        alert("선택된 행이 없습니다.");
        return;
    } else {            
            if( selRow > -1 ) {
                gridViewPop2.target.removeRow(selRow);                   
            }
    }
}

function approvalYn() {
    var gridList = gridViewPop.target.getList();
    var inCnt = 0;
    if( gridList.length > 0 ) {
        var msgArr = [];            
        $.each(gridList, function (idx, elem) { 
            //결재자가 본인이 아니면서 상태가 Y인 경우
            if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
        })
    }
    return inCnt;
}

function approvalYn2() {
    var gridList = gridViewPop2.target.getList();
    var inCnt = 0;
    if( gridList.length > 0 ) {
        var msgArr = [];            
        $.each(gridList, function (idx, elem) { 
            //결재자가 본인이 아니면서 상태가 Y인 경우
            if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
        })
    }
    return inCnt;
}


//요인별요청번호 검색
function openPurchaseSearch() {
    var paramObj = {
            "coCd" : $("#popForm_S #coCd").val(),
            "searchValue" : $("#popForm_S #salesCd").val(),
            "orderFlag" : "Y"
    }       
    openThirdModal("/static/html/cmn/modal/purchaseSearch.html", 1200, 420, "요인별요청번호 검색", paramObj, function (grid) {
        var row = grid.target.getList("selected")[0];
        $("#popForm_S #reqNo").val(row.reqNo);
    });
} 

 </script>
 
