<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5select.css">
    <link rel="stylesheet" href="/static/css/jstree/style.min.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
    <link rel="stylesheet" href="/static/css/gnb.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/sub.css">
    <link rel="stylesheet" href="/static/css/common.css">

    <script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
    <script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
    <script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
	<script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>
    <script type="text/javascript" src="/static/js/global.js"></script>
    <script type="text/javascript" src="/static/js/fileTree.js"></script>

    <!-- 도움말 팝업 -->
    <script src="/static/js/manualPopup.js"></script>
</head>

<body>
    <div id="head_area"></div>
	<div id="top_area"></div>
    <div id="main_area">
        <!-- 페이지 상단 -->
		<div class="contents no_bg">
            <ul class="btn_ul">
                <li class="btn_r">
                    <a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
                    <a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
                    <a onclick="salesGridView.setData(0);"><button class="bg_gray">검 색</button></a>
                </li>
            </ul>
        </div>
        
        <!-- 검색 콘텐츠 -->
        <div class="contents search">
			<div class="">
				<!-- 테이블 인풋 3분할 -->
				<table class="table_input type04">
                    <!-- 검색조건 1행 -->
                    <tr>
                        <th class="hit" style="width:80px;">회사</th>
                        <td style="width:200px;">
                            <select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사" onChange="salesGridView.setData(0);changeCocd();">
                            </select>
                        </td>
                        <th style="width:100px;">계획 시작일</th>
                        <td >
                            <div style="width:400px;">
                                <input type="text" class="input_calendar" id="wbsRsltssDt_S" name="wbsRsltssDt_S" data-search="wbsRsltssDt_S" autocomplete="off" date data-search="wbsRsltssDt" onkeyup="dateMask(this);">
                                <span>~</span>
                                <input type="text" class="input_calendar" id="wbsRsltseDt_S" name="wbsRsltseDt_S" data-search="wbsRsltseDt_S"  autocomplete="off" date data-search="wbsRsltseDt" onkeyup="dateMask(this);">
                            </div>
                        </td>
                        <th style="width:100px;">진행상태</th>
                        <td>
                            <select id="issSts_S" name="issSts_S" data-search="issSts_S" data-kind="ISSSTS" onChange="salesGridView.setData(0);">
                                <option value="">선택</option>
                            </select>
                        </td>
                    </tr>
                    
                    <!-- 검색조건 2행 -->
					<tr>
                        <th class= "hit" style="width:90px;">Sales Code</th>
                        <td style="width:300px;">
                            <div class="search_form">
                                <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? salesGridView.setData(0) : ''">
                                <a onclick="wbsSalesCodeSearch('S');"><i class="i_search_w"></i></a>
                            </div>
                            <input type="hidden" id="salesNm_S" name="salesNm_S" >
                        </td>
                        <th>고객사PJT</th>
                        <td>
                            <select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt" onchange="salesGridView.setData(0);">
                                <option value="">전체</option>
                            </select>
                        </td>
                        <th class="">고객사</th>
						<td>
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm" onkeyup="event.keyCode == 8 ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? DataSearch() : ''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
                    </tr>
                    <!-- 검색조건 END -->
                </table>
                <input type="hidden" id="userId" name="userId">
                <input type="hidden" id="pgmId"  name="pgmId" value="WB2401M01">
            </div>
        </div>
        
        <div class="contents no_bg">
            <div class="contents_tit">
                <div class="add_btn_small pdl10">
					<a onclick="wbsIssueDelete();" style="height: 30px; line-height: 28px;" authchk>-</a>
                    <a id="cretPlanIss" onclick="wbsIssPlanModal();" style="height: 30px; line-height: 28px; width: 90px;"><i class="far fa-comment-dots"></i> 계획이슈등록</a>
                    <a id="cretRsltsIss" onclick="wbsIssRsltsModal();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-comment-medical"></i> 실적이슈등록</a>
                    <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
                </div>
                <!-- <select id="recordCnt" class="prae_select" onchange="salesGridView.setData(0);">
                  <option value="25" >25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="9999999" selected>전체</option>
                </select>  -->
            </div>
            
			<!-- 그리드1 -->
			<div class="contents">
				<div class="ax5_grid">
	                <div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 725px;  min-height:200px;"></div>
	                <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
				</div>
			</div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
    var isFirst = true;
    var coCd = null;
    var salesCd = null;
    var mEvlCloseChk = "N";
    
    ax5.ui.grid.formatter["chkYn"] = function () {
//         var color = this.value == "Y" ? "color-circle_02.png" : "";
        if (this.value == "Y"){
            return '<img src="/static/img/color-circle_02.png" style="width: 10px;height: 10px;"></img>';
        } else {
            return ' ';
        }
    };
    
    var salesGridView = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showLineNumber  : false,
                showRowSelector : true,
                // multipleSelect  : true,
                sortable : false,
                target : $('[data-ax5grid="first-grid"]'),
                header : {
                    align : "center",
                    selector : false
                },
                body: {
                    mergeCells : ["clntNm","clntPjtNm","sjNm","salesCd"],
                    columnHeight: 26,
                    onClick: function () {
                        var list = salesGridView.target.getList("selected");
                        $.each(list, function(idx, obj) {
                            salesGridView.target.select(obj.__origin_index__, {selected: false});
                        });
                        this.self.select(this.dindex);
                        // 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
                        var paramObj = {
                            "coCd" : this.item.coCd,
                            "salesCd" : this.item.salesCd,
                        };
                        postAjax("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data) {
                            mEvlCloseChk = data.result[0].closeChk;
                        });
                        // ----------------------------------
                    },
                    onDBLClick: function () {
                        var list = salesGridView.target.getList("selected");
                        $.each(list, function(idx, obj) {
                            salesGridView.target.select(obj.__origin_index__, {selected: false});
                        })
                        this.self.select(this.dindex);
                        wbsIssModal();
                    },
                    onDataChanged: function () {
                        
                    }
                },
                columns: [
                    {key: "coCd",                label: "회사코드",          hidden:true},
                    {key: "clntCd",              label: "고객코드",          hidden:true},
                    {key: "clntPjt",             label: "고객사프로젝트",      hidden:true},
                    {key: "clntNm",              label: "고객명",           width: 110,  align: "left"},
                    {key: "clntPjtNm",           label: "프로젝트명",        width: 80,   align: "left"},
                    {key: "sjNm",                label: "과제명",           width: 200,   align: "left" },
                    {key: "salesCd",             label: "SALES CODE",     width: 130,   align: "center"},
                    {key: "ordrsNo",             label: "수주번호",          hidden:true},
                    {key: "verNo",               label: "Ver.",           hidden:true},
                    {key: "wbsPlanCodeKind",     label: "상위코드",         hidden:true},
                    {key: "wbsPlanCodeId",       label: "TASK",           hidden:true},
                    {key: "wbsMngNm",            label: "담당자",           hidden:true},
                    {key: "pid",             label: "상위코드",          hidden:true},
                    {key: "id",             label: "하위코드",          hidden:true},
                    {key: "lvl",                 label: "lvl",            hidden:true},
                    {key: "wbsPlanCodeNm",       label: "TASK명",         width: 300,   align: "left", hidden:false, treeControl: true},
                    {key: "wbsPlansDt",          label: "시작일",          width: 100,   align: "center"},
                    {key: "wbsPlaneDt",          label: "종료일",          width: 100,   align: "center"},
                    {label: "등록여부",
                        columns: [
                            {key: "planYn",          label: "계획",           width: 40, align: "center", formatter: "chkYn"},
                            {key: "rsltsYn",         label: "실적",           width: 40, align: "center", formatter: "chkYn"},
                        ]
                    },
                    {label: "이슈정보",
                        columns: [
                            {key: "gubun",           label: "구분",           width: 60,   align: "center" },
                            {key: "issStsNm",        label: "진행상태",        width: 60,   align: "center"},
                            {key: "issSj",           label: "제목",           width: 200,   align: "left"},
                            {key: "issDivNm",        label: "유형",           width: 80,   align: "center"},
                            {key: "issCnts",         label: "내용",           width: 230,   align: "left"},
                        ]
                    },
                    {label: "조치내역",
                        columns: [
                            {key: "actNm",           label: "담당자",         width: 70,   align: "center"},
                            {key: "actsDt",          label: "시작일",         width: 80,   align: "center"},
                            {key: "acteDt",          label: "종료일",         width: 80,   align: "center"},
                            {key: "reqNo",           label: "발주요청번호",     width: 90,   align: "center"},
                            {key: "actMh",           label: "투입공수",        width: 70,   align: "right", formatter: "money"},
                            {key: "actAmt",          label: "투입비용",        width: 70,   align: "right", formatter: "money"},
                            {key: "actCnts",         label: "조치내용",        width: 150,   align: "left"}
                        ]
                    },
                    {key: "wbsRsltssDt",         label: "시작일",         hidden:true},
                    {key: "wbsRsltseDt",         label: "종료일",         hidden:true},
                    {key: "issDiv",              label: "이슈유형",       hidden:true},
                    {key: "actId",               label: "담당자",        hidden:true},
                    {key: "issSts",              label: "진행상태",       hidden:true},
                    {key: "issNo",               label: "이슈번호",       hidden:true},
                    {key: "wbsPlanNo",           label: "이슈계획번호",    hidden:true},
                    {key: "wbsRsltsNo",          label: "이슈실적번호",    hidden:true},
                    {key: "pPlanNo",             label: "계획번호",       hidden:true},
                    {key: "pRsltsNo",            label: "실적번호",       hidden:true},
                    {key: "pPlanTrgtKey",        label: "계획타겟키",      hidden:true},
                    {key: "pRsltsTrgtKey",       label: "실적타겟키",      hidden:true},
                    {key: "issFileTrgtKey",      label: "ISS_FILE_TRGT_KEY", hidden:true},
                    {key: "path",                label: "path", hidden:true}
                ],
                tree: {
                    use: true,
                    indentWidth: 15,
                    arrowWidth: 15,
                    iconWidth: 18,
                    icons: {
                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                        collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
                        itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
                    },
                    columnKeys: {
                        parentKey: "pid",
                        selfKey: "id",
                        //collapse:"pid"
                    },
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    /* firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        //salesGridView.setData(this.page.selectPage);
                    } */
                },
            });
            return this;
        },
        setData : function(_pageNo) {
            if (isFirst) return;
            var targetObj = this.target;
            var paramObj = {
                "coCd": $('#coCd_S').val(),
                "ordrsClntNm" : $('#ordrsClntNm_S').val(),
                "salesCd": $('#salesCd_S').val(),
                "clntPjt": $('#clntPjt_S').val(),
                "wbsRsltssDt": $('#wbsRsltssDt_S').val(),
                "wbsRsltseDt": $('#wbsRsltseDt_S').val(),
                "issSts": $('#issSts_S').val()
            };
            // debugger;
            postAjax("/user/wb/wb24/selectWbsIssueList", paramObj, null, function(data) {
                var list = data.fileList;
                // debugger;
                targetObj.setData({
                    list : list,
                    page : {
                        //currentPage   : _pageNo,
                        //pageSize      : data.paginationInfo.pageSize,
                        //totalElements : data.paginationInfo.totalRecordCount,
                        //totalPages    : data.paginationInfo.totalPageCount\
                        totalElements : list.length
                    }
                });
                gridHeightResize(salesGridView, 194); // 194 = 919 - 725 : 화면 Body 높이 - 그리드 기본크기 725
            });
        }
    }
    
    var excelView = {
        initView: function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                target: $('[data-ax5grid="excel-grid"]'),
                columns: [
                    {key: "coCd",                label: "회사코드",          hidden:false},
                    {key: "clntCd",              label: "고객코드",          hidden:false},
                    {key: "clntPjt",             label: "고객사프로젝트",      hidden:false},
                    {key: "clntNm",              label: "고객명",           width: 110,  align: "left"}, 
                    {key: "clntPjtNm",           label: "프로젝트명",        width: 80,   align: "left"},
                    {key: "sjNm",                label: "과제명",           width: 200,   align: "left"},
                    {key: "salesCd",             label: "SALES CODE",     width: 130,   align: "center"}, 
                    {key: "ordrsNo",             label: "수주번호",          hidden:false},
                    {key: "verNo",               label: "Ver.",           hidden:false},
                    {key: "wbsPlanCodeKind",     label: "상위코드",         hidden:false},
                    {key: "wbsPlanCodeId",       label: "TASK",           hidden:false},
                    {key: "wbsMngNm",            label: "담당자",           hidden:false},
                    {key: "upperCd",             label: "상위코드",          hidden:false},
                    {key: "lowerCd",             label: "하위코드",          hidden:false},
                    {key: "lvl",                 label: "lvl",            hidden:false},
                    {key: "wbsPlanCodeNm",       label: "TASK명",         width: 300,   align: "left", hidden:false, treeControl: true},
                    {key: "wbsPlansDt",          label: "시작일",          width: 100,   align: "center"},
                    {key: "wbsPlaneDt",          label: "종료일",          width: 100,   align: "center"},
                    {label: "등록여부",
                        columns: [
                            {key: "planYn",          label: "계획",           width: 40, align: "center", formatter: "chkYn"},
                            {key: "rsltsYn",         label: "실적",           width: 40, align: "center", formatter: "chkYn"},
                        ]
                    },
                    {label: "이슈정보",
                        columns: [
                            {key: "gubun",           label: "구분",           width: 60,   align: "center" },
                            {key: "issStsNm",        label: "진행상태",        width: 60,   align: "center"},
                            {key: "issSj",           label: "제목",           width: 200,   align: "left"},
                            {key: "issDivNm",        label: "유형",           width: 80,   align: "center"},
                            {key: "issCnts",         label: "내용",           width: 230,   align: "left"},
                        ]
                    },
                    {label: "조치내역",
                        columns: [
                            {key: "actNm",           label: "담당자",         width: 70,   align: "center"},
                            {key: "actsDt",          label: "시작일",         width: 80,   align: "center"},
                            {key: "acteDt",          label: "종료일",         width: 80,   align: "center"},
                            {key: "reqNo",           label: "발주요청번호",     width: 90,   align: "center"},
                            {key: "actMh",           label: "투입공수",        width: 70,   align: "right", formatter: "money"},
                            {key: "actAmt",          label: "투입비용",        width: 70,   align: "right", formatter: "money"},
                            {key: "actCnts",         label: "조치내용",        width: 150,   align: "left"}
                        ]
                    },
                    {key: "wbsRsltssDt",         label: "시작일",         hidden:false},
                    {key: "wbsRsltseDt",         label: "종료일",         hidden:false},
                    {key: "issDiv",              label: "이슈유형",       hidden:false},
                    {key: "actId",               label: "담당자",        hidden:false},
                    {key: "issSts",              label: "진행상태",       hidden:false},
                    {key: "issNo",               label: "이슈번호",       hidden:false},
                    {key: "wbsPlanNo",           label: "이슈계획번호",    hidden:false},
                    {key: "wbsRsltsNo",          label: "이슈실적번호",    hidden:false},
                    {key: "pPlanNo",             label: "계획번호",       hidden:false},
                    {key: "pRsltsNo",            label: "실적번호",       hidden:false},
                    {key: "pPlanTrgtKey",        label: "계획타겟키",      hidden:false},
                    {key: "pRsltsTrgtKey",       label: "실적타겟키",      hidden:false},
                    {key: "issFileTrgtKey",      label: "ISS_FILE_TRGT_KEY", hidden:false},
                    {key: "path",                label: "path", hidden:false}
                ],
            });
            return this;
        }
    }
    
    // WBS 계획화면에서 이슈 최초 등록 후 추가 등록 시 이슈관리 메인화면으로 이동 시 salesCd를 넘김,
    // get으로 넘기기 때문에 URL 부분에서 salesCd를 추출하여 가져오는 함수
    function getParams() {
        var url = window.location.search.replace('?','');
	    var params = {};
	    var urlArray = url.split('&');
	    for(var i in urlArray)
        {
            var param = urlArray[i].split('=');
            params[param[0]] = param[1];
        }
        return params;
    }
    // ----------------------------------------------------------
    
    $(document).ready(function() {
        mainDefaultLoad("실행계획", "이슈관리");          // 페이지 타이틀 설정
        setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set
        
        isFirst = false;
        
        $("#coCd_S").val(jwt.coCd);
        
        // WBS 일정계획관리에서 이슈 등록 후 추가 등록 시 이슈관리 메인화면으로 이동 시 salesCd를 넘김,
        // salesCd 존재할 경우 검색조건 salesCd 입력란에 자동입력 후 검색
        const params = getParams();
        
        if (params['salesCd'] != undefined) {
            $('#salesCd_S').val(params['salesCd']);
        }
        //---------------------------------------------
        

    	// 시작일 (현재날짜의 이전월 첫일)
    	const snow = moment().startOf("month");
    	var beDay = snow.add(-4, "M").format("YYYY-MM-DD");
        // WBS 계획 시작일, 종료일 세팅
        $('#wbsRsltssDt_S').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true
        })
//         .datepicker("setDate", moment(new Date()).startOf("year").toDate())
   	    .datepicker("setDate", beDay)
        .on("changeDate", function(){
            if($('#wbsRsltssDt_S').val() > $('#wbsRsltseDt_S').val()){
                alert("시작일과 종료일를 확인해주세요");
                $('#wbsRsltssDt_S').datepicker("setDate", new Date($('#wbsRsltseDt_S').val()));
            }
            salesGridView.setData(0);
        });
        
        let now = new Date();
        $('#wbsRsltseDt_S').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true
        })
        .datepicker("setDate", moment(now.setMonth(now.getMonth()+2)).endOf("month").toDate())
        .on("changeDate", function(){
            if($('#wbsRsltssDt_S').val() > $('#wbsRsltseDt_S').val()){
                alert("시작일과 종료일를 확인해주세요");
                $('#wbsRsltssDt_S').datepicker("setDate", new Date($('#wbsRsltseDt_S').val()));
            }
            salesGridView.setData(0);
        });
        
        // 메인화면 리스트 조회
        salesGridView.initView().setData(0);
        
        // 엑셀 그리드 초기화
        excelView.initView()
        
        //권한체크
        authChk();
    });
    
    // 초기화 버튼용
    function initSearch() {
        $('[data-search]').off("change");   //바인딩기능 오프
        $('.contents.search select, .contents.search input').val("");
        $("#wbsRsltssDt_S").val(dateToStr(moment(new Date()).startOf("month").toDate()));
        $("#wbsRsltseDt_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
        $("#coCd_S").val(jwt.coCd);

        salesGridView.initView().setData(0);
    }
    
    // 엑셀 다운로드
    function excelDown() {
        var paramObj = {
            "coCd": $('#coCd_S').val(),
            "salesCd": $('#salesCd_S').val(),
            "wbsRsltssDt": $('#wbsRsltssDt_S').val(),
            "wbsRsltseDt": $('#wbsRsltseDt_S').val(),
            "actCloseYn": $('#actCloseYn_S').val(),
            //"pageNo" : _pageNo + 1,
            "recordCnt": 99999999
        };
        postAjax("/user/wb/wb24/selectWbsIssueList", paramObj, null, function(data) {
            var list = data.fileList;
            excelView.target.setData({
                list : list,
                page : {
                    totalElements : list.length,
                }
            });
            var todayDate = new Date().format('yyyyMMddHHmmss');
            excelView.target.exportExcel("WBS_이슈관리 리스트"+todayDate+".xls");
        });
    }
    
    // 이슈 등록은 WBS TASK 계획이슈와 실적이슈로 구분
    // WBS 계획 이슈 등록 방법은 WBS 일정계획 (구분자:C1)화면과 이슈 관리 화면(구분자:C2) 에서 등록 (2가지 방법)
    function wbsIssPlanModal() {
        var row = salesGridView.target.getList("selected")[0];
        
        // 이슈관리 메인화면에서 salesCd를 선택하지 않고 이슈 등록 버튼을 누른경우 알림 처리
        if (row == undefined) {
            alert("리스트에 SALES CODE를 선택하세요");
            return;
        }
        else {
            // WBS는 회사코드, salesCd를 선택 후 최초 과제를 등록 후 관리하기 때문에 해당 salesCd와 연계된 과제가 평가 완료시
            // 알림처리
            if (mEvlCloseChk == "Y") {
                alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
                return;
            }
            
            // 이슈관리 메인화면에서 트리구조형태로 되어 있어 맨상위 1,2레벨은 이슈 등록 불가 알림처리,
            // TASK 정보부분에 이슈 등록 가능(맨마지막 레벨-파란색 동그라미 부분)
            if (row.lvl == "1" || row.lvl == "2") {
                alert("이슈등록은 계획에 등록 가능합니다.");
                return;
            }
            else {
                // 이슈관리에서 계획 이슈 등록 구분자는 "C3"
                var paramObj = {
                    "actionType"      : "C3",
                    "coCd"            : row.coCd,
					"clntPjtNm"       : row.clntPjtNm,
					"clntNm"          : row.clntNm,
					"salesCd"         : row.salesCd,
					"wbsPlanNo"       : row.pPlanNo,
					"wbsRsltsNo"      : row.pRsltsNo,
					"wbsPlanCodeKind" : row.wbsPlanCodeKind,
					"wbsPlanCodeId"   : row.wbsPlanCodeId,
					"wbsPlanCodeNm"   : row.wbsPlanCodeNm,
					"wbsMngNm"        : row.wbsMngNm,
					"wbsPlansDt"      : row.wbsPlansDt,
					"wbsPlaneDt"      : row.wbsPlaneDt,
                };
                // debugger;
                openSecondModal("/static/html/user/wb/wb24/WB2401P01.html", 1200, 870, "WBS 계획이슈등록", paramObj, function () {
                    
                });
            }
        }
    }
    
    // WBS 실적 이슈 등록 방법은 WBS 일정계획 (구분자:C3)화면과 이슈 관리 화면(구분자:C4) 에서 등록 (2가지 방법)
    function wbsIssRsltsModal() {
        var row = salesGridView.target.getList("selected")[0];
        if (row == undefined) {
            alert("리스트에 SALES CODE를 선택하세요");
            return;
        }
        else {
            // WBS는 회사코드, salesCd를 선택 후 최초 과제를 등록 후 관리하기 때문에 해당 salesCd와 연계된 과제가 평가 완료시
            // 알림처리
            if (mEvlCloseChk == "Y") {
                alert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
                return;
            }

        	// 이슈관리 메인화면에서 트리구조형태로 되어 있어 맨상위 1,2레벨은 이슈 등록 불가 알림처리, 
            // TASK 정보부분에 이슈 등록 가능(맨마지막 레벨-파란색 동그라미 부분)
            if (row.lvl == "1" || row.lvl == "2") {
                alert("이슈등록은 실적에 등록 가능합니다.");
                return;
            }
        	else if (row.pRsltsNo == undefined) {
                // 실적번호 (실적정보)가 존재하지 않는경우 알림 처리
            	alert("실적 정보가 존재하지 않습니다.");
                return;
            }
            else {
                // 이슈관리에서 실적 이슈 등록 구분자는 "C4"
            	var paramObj = {
                    "actionType"      : "C4",
                    "coCd"            : row.coCd,
					"clntPjtNm"       : row.clntPjtNm,
					"clntNm"          : row.clntNm,
					"salesCd"         : row.salesCd,
					"wbsPlanNo"       : row.pPlanNo,
					"wbsRsltsNo"      : row.pRsltsNo,
					"wbsPlanCodeKind" : row.wbsPlanCodeKind,
					"wbsPlanCodeId"   : row.wbsPlanCodeId,
					"wbsPlanCodeNm"   : row.wbsPlanCodeNm,
					"wbsMngNm"        : row.wbsMngNm,
					"wbsRsltssDt"     : row.wbsRsltssDt,
					"wbsRsltseDt"     : row.wbsRsltseDt,
                };
                // debugger;
                openSecondModal("/static/html/user/wb/wb24/WB2401P11.html", 1200, 870, "WBS 실적이슈등록", paramObj, function () {
                    
                });
            }
        }
    }
    
    // WBS 계획 이슈 수정 방법은 이슈 관리 화면(구분자:U3) 에서 등록 (1가지 방법), 기존 WBS 일정계획 (구분자:U1)은 사용하지 않고 이슈관리 화면으로 이동    
    // WBS 실적 이슈 수정 방법은 이슈 관리 화면(구분자:U4) 에서 등록 (1가지 방법), 기존 WBS 일정계획 (구분자:U2)은 사용하지 않고 이슈관리 화면으로 이동
    function wbsIssModal() {
        var row = salesGridView.target.getList("selected")[0];
        if (row == undefined) {
            alert("리스트에 SALES CODE를 선택하세요");
            return;
        } else {
            // 이슈관리에서 계획 이슈 수정 구분자는 "U3"
            if (row.gubun == "계획" && row.issNo != undefined) {
                var paramObj = {
                    "actionType"     : "U3",
                    "coCd"           : row.coCd,
                    "issFileTrgtKey" : row.issFileTrgtKey,
					"wbsPlanNo"      : row.pPlanNo,
					"wbsRsltsNo"     : row.pRsltsNo,
                };
                // debugger;
                openSecondModal("/static/html/user/wb/wb24/WB2401P01.html", 1200, 870, "WBS 계획이슈수정", paramObj, function (){
                    
                });
            }
    		else if (row.gubun == "실적" && row.issNo != undefined) {
                // 이슈관리에서 등록 이슈 수정 구분자는 "U4"
                var paramObj = {
                    "actionType"     : "U4",
                    "coCd"           : row.coCd,
                    "issFileTrgtKey" : row.issFileTrgtKey,
                    "wbsPlanNo"      : row.pPlanNo,
					"wbsRsltsNo"     : row.pRsltsNo,
                };
                // debugger;
                openSecondModal("/static/html/user/wb/wb24/WB2401P11.html", 1200, 870, "WBS 실적이슈수정", paramObj, function (){
                    
                });
            }
        }
    }
        	
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd_S').val(),
           "salesCd": $('#salesCd_S').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $('#salesCd_S').val(row.salesCd);
            salesGridView.setData(0);
        });
    }
    
	// 거래처 검색 함수
	function opendClntSearch(inputValue) {
		var paramObj = {
	            "searchValue" : inputValue,
	            "clntDivCd"   : "CLNTDIV12"
	        };
		openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsClntCd_S').val(row.clntCd);
			$('#ordrsClntNm_S').val(row.clntNm);
			salesGridView.setData(0);
		});
	}
	
	
	//회사 변경시 등록 기능 잠금
	function changeCocd() {
// 	    if($("#coCd_S").val() == jwt.coCd){
// 	        $("#cretPlanIss").show();
// 	        $("#cretRsltsIss").show();
// 	    }else{
// 	    	$("#cretPlanIss").hide();
//             $("#cretRsltsIss").hide();
// 	    }
	}
	


	/*삭제 버튼 클릭 시*/
	function wbsIssueDelete() {
        var row = salesGridView.target.getList("selected")[0];
        
        if( !row ) {
        	return false;
        }
        debugger;
        if( !row.issNo) {
        	return false;
        }
        if (row.actCnts && row.actCnts != '') {
        	alert("조치결과가 있는 자료는 삭제할 수 없습니다.");
        	return false;
        }
		var formData = {
				"fileTrgtKey" 	: row.issFileTrgtKey,
		       	"fileTrgtTyp"   : row.issFileTrgtTyp,
				"issNo" 	   	: row.issNo,
				"coCd" 	   		: row.coCd,
				"salesCd" 	   	: row.salesCd,
		       	"userId"   		: jwt.userId,
		}
// 		if(!monthCloseChk(row.ctrtDt, 'D', row.coCd)) return;  //마감일통제
		if (confirm("삭제하시겠습니까?")) {
			putAjax("/user/wb/wb24/wbsIssueDelete", formData, null, function(data) {
				if (data.resultCode == 200) {
					salesGridView.setData(0);
				} else {
		        	alert("삭제오류 확인바랍니다.\n" + data.resultMessage);
				}
			});
		}
	}
</script>
