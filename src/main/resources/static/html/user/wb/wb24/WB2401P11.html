<style>
.issHidden {
	display: none;
}

.issVisible {
	display: block;
}
</style>
<div id="wbsPopupIss" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">WBS 실적 문제</h4>
	</div>
	<div class="popup_table">
		<div class="form-group">
			<form id="popForm_SP11">
				<input type="hidden" id="actionType" name="actionType">
				<input type="hidden" id="coCd" name="coCd">
				<input type="hidden" id="userId" name="userId">
				<input type="hidden" id="pgmId" name="pgmId" value="WB2401P11">
				<input type="hidden" id="rsltsFileTrgtKey" name="rsltsFileTrgtKey">
				<input type="hidden" id="wbsPlanNo" name="wbsPlanNo">
				<input type="hidden" id="wbsRsltsNo" name="wbsRsltsNo">
				<input type="hidden" id="wbsPlanCodeKind" name="wbsPlanCodeKind">
				<input type="hidden" id="wbsPlanCodeId" name="wbsPlanCodeId">
				<input type="hidden" id="issNo" name="issNo">
				<input type="hidden" id="ordrsNo" name="ordrsNo">
				<input type="hidden" id="issFileTrgtKey" name="issFileTrgtKey">
				<input type="hidden" id="clntPjtNm" name="clntPjtNm">
				<input type="hidden" id="clntNm" name="clntNm">
				<input type="hidden" id="telNo" name="telNo">
				<input type="hidden" id="actDeptId" name="actDeptId">

				<table class="popup_table">
					<colgroup>
						<col width="15%">
						<col width="35%">
						<col width="15%">
						<col width="35%">
					</colgroup>

					<thead>
						<tr>
							<td colspan="4" style="height: 30px; text-align: left; font-weight: bold; font-size: 14px;">▣ 과제정보</td>
						</tr>
					</thead>
					<tr>
						<th>과제번호</th>
						<td><input type="text" id="sjNo" name="sjNo" readonly></td>
						<th>과제명</th>
						<td><input type="text" id="sjNm" name="sjNm" readonly></td>
					</tr>

					<tr>
						<th>고객사</th>
						<td><input type="text" id="clntNm" name="clntNm" readonly></td>
						<th>SALES CODE</th>
						<td><input type="text" id="salesCd" name="salesCd" required readonly msg="salesCd"></td>
					</tr>

					<tr>
						<th>제작처 구분</th>
						<td><input type="text" id="mkerDivNm" name="mkerDivNm" readonly></td>
						<th>차종</th>
						<td><input type="text" id="clntPjtNm" name="clntPjtNm" readonly></td>
					</tr>

					<tr>
						<th>제품</th>
						<td><input type="text" id="prdtNm" name="prdtNm" readonly></td>
						<th><div>총괄PM</th>
						<td><input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly></td>
					</tr>

					<tr>
						<th>제작업체</th>
						<td><input type="text" id="mkerNm" name="mkerNm" readonly></td>
						<th style="color: blue;">확정</th>
						<td><input type="hidden" id="closeYn" name="closeYn" style="color: blue;" readonly>
						<div id="close"></div></td>
					</tr>

					<tr>
						<th>시작일</th>
						<td><input id="beginDt" name="beginDt" readonly></td>
						<th>출고일</th>
						<td><input id="deDt" name="deDt" readonly></td>
					</tr>

					<tr>
						<th>완료검수일</th>
						<td><input id="acptncDt" name="acptncDt" readonly></td>
						<th></th>
						<td></td>
					</tr>

					<thead>
						<tr>
							<td colspan="4" class="fs-14" style="height: 30px; text-align: left; font-weight: bold">▣ TASK 실적정보</td>
						</tr>
					</thead>
					<tr>
						<th>TASK명</th>
						<td colspan="1"><input type="text" id="wbsPlanCodeNm" name="wbsPlanCodeNm" readonly></td>
						<th>문제번호</th>
						<td colspan="1"><input type="text" id="issNo" name="issNo" readonly></td>
					</tr>
					<tr>
						<th>시작일자</th>
						<td><input type="text" id="wbsRsltssDt" name="wbsRsltssDt" readonly></td>
						<th>종료일자</th>
						<td><input type="text" id="wbsRsltseDt" name="wbsRsltseDt" readonly></td>
					</tr>
					<tr>
						<th>문제등록</th>
						<td><input type="hidden" id="creatId" name="creatId" readonly>
							<input type="text" id="creatIdNm" name="creatIdNm" readonly></td>
						<th>등록일</th>
						<td><input type="text" id="creatDt" name="creatDt" readonly></td>
					</tr>
					<tr>
						<td colspan="4" bgcolor="gray" style="height: 2px;"></td>
					</tr>
					<thead>
						<tr>
							<td colspan="4" style="height: 30px; text-align: left; font-weight: bold; font-size: 14px;">▣ 문제정보</td>
						</tr>
					</thead>
					<tr>
						<th class="hit">분류</th>
						<td><select id="issDiv" name="issDiv" required data-kind="ISSDIV" msg="문제분류">
								<option value="">선택</option>
						</select></td>
						<th class="hit">진행상태</th>
						<td>
							<div class="reqMessageOn issHidden" style="color: red;" onclick="openResultPopup();">발주요청서에서 결과처리할것</div>
							<div class="reqMessageOff issVisible">
								<select id="issSts" name="issSts" required data-kind="ISSSTS" msg="진행상태" title="발주요청번호가 있는 결과처리는 요인별 발주요청서에서 처리가능합니다.">
									<option value="">선택</option>
								</select>
							</div>
						</td>
					</tr>
					<tr>
						<th class="hit">제목</th>
						<td colspan="1"><input type="text" id="issSj" name="issSj" required msg="문제제목"></td>
						<th>발주요청번호</th>
						<td>
							<div id="createQualityReq" class="reqMessageOff issVisible" style="color: red;" onclick="createQualityReqModal();">요인별 발주요청서 작성</div>
							<div class="reqMessageOn issHidden">
								<input type="text" id="reqNo" name="reqNo" msg="발주요청번호" readonly></div>
						</td>
					</tr>
					<tr>
						<th class="hit">조치담당자</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="actId" name="actId" required msg="조치담당자"> <input type="text" id="actNm" name="actNm" onkeyUp="if(window.event.keyCode == 8){actId.value = ''};" readonly> 
								<a onclick="openUserSearch(1);"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th class="hit">사내 완료일</th>
						<td>
							<input id="reqDt" name="reqDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"    msg="사내 완료일"  date  required >
						</td>
					</tr>
					<tr>
						<th>발생공급업체
                            <button id="updateVendCdBtn" type="button" style="transform: scale(0.8); transform-origin: center; padding: 0; margin: 0; display: none; height: 23px;" onclick="updateVendCd();">저장</button>
                        </th>
						<td>
                            <input type="hidden" id="vendCd" name="vendCd" data-search="vendCd" msg="발생공급업체">
							<div class="search_form">
								<input type="text" id="vendCdNm" name="vendCdNm" data-search="vendCdNm" onkeyup="(event.keyCode == 8 || event.keyCode == 46)? vendCd.value='' : '' ">
								<a onclick="openClntSearch();"><i class="i_search_w"></i></a>
							</div>
                        </td>
						<th class="hit">고객 조치완료일</th>
						<td>
							<input id="custReqDt" name="custReqDt" class="input_calendar form-control" autocomplete="off" msg="고객 조치완료일" date  required>
						</td>
					</tr>
					<tr>
						<th class="hit">장애유형</th>
						<td colspan="1" style="text-align: left; vertical-align: top;">
							<div id="COBGB-checkboxContainer-P11"></div>
						</td>
						<td colspan="2" style="vertical-align: text-top;">
							<table style="border: 0px;">
							
						
					<colgroup>
						<col width="15%">
						<col width="35%">
					</colgroup>
								<tr>
									<th class="hit">기계분류</th>
									<td colspan="1">
										<div >
											<select id="mcPartCd" name="mcPartCd" data-kind="MCPARTCD" required msg="기계분류">
												<option value="">선택(필수)</option>
											</select>
										</div>
									</td>
								</tr>
								<tr>
									<th class="hit">중요도</th>
									<td colspan="1">
										<div>
											<select id="importantCd" name="importantCd" data-kind="IMPORTANTCD" required msg="중요도">
												<option value="">선택(필수)</option>
											</select>
										</div>
									</td>
								</tr>
								<tr>
									<th class="hit">영향도</th>
									<td colspan="1">
										<div>
											<select id="impactCd" name="impactCd" data-kind="IMPACTCD" required msg="영향도">
												<option value="">선택(필수)</option>
											</select>
										</div>
									</td>
								</tr>
							
							
								<tr style="height: 30px;">
									<td style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold;">※ 문제정보 공유 및 결재</td>
									<td>
										<div class="add_btn_small pdl10">
											<a id="btn_plus1" onclick="insertShareUserModal();" style="height: 30px; line-height: 28px; width: 30px;"> + </a> <a id="btn_minus1"
												onclick="deleteShareUser();" style="height: 30px; line-height: 28px; width: 30px;"
											> - </a>
										</div>
									</td>
								</tr>
								<tr>
									<td colspan="2">
										<div>
											<div class="ax5_grid" data-ax5grid="first-grid-modal-P11" data-ax5grid-config="{}" style="height: 150px; width: 100%;"></div>
										</div>
									</td>
								</tr>
							</table>
						</td>

					</tr>
					<tr>
						<th class="hit">작성자 문제등록</th>
						<td colspan="3">
							<div class="aiContainer">
								<textarea id="issCnts" name="issCnts" rows="4" required msg="내용"></textarea>
								<div class="ai-mark" onclick="openapi('issCnts');">AI</div>
							</div>
						</td>
					</tr>
					<tr>
						<td colspan="4"></td>
					</tr>
					<tr>
						<td colspan="4" bgcolor="gray" style="height: 2px;"></td>
					</tr>
					<thead>
						<tr>
							<td colspan="4" style="height: 30px; text-align: left; font-weight: bold; font-size: 14px; color: blue;">▣ 조치내역</td>
						</tr>
					</thead>
					<tbody class="issAct">
						<tr>
							<th style="color: blue;">시작일자</th>
							<td>
								<div class="date_input">
									<input type="text" class="input_calendar form-control" style="width: 100% !important; display: inline-block !important;" id="actsDt"
										name="actsDt" autocomplete="off" date onkeyup="dateMask(this);" msg="시작일자"
									>
								</div>
							</td>
				            <th rowspan="4" style="color:blue;">조치 파일 저장명</th>
				            <td rowspan="4">
				               <textarea  class="form-control" id="actCompDgnFileNm" name="actCompDgnFileNm" rows="5" maxlength="1000" msg="조치  파일 저장명" placeholder="예: 24011-01NVFIP-1230-001R1.dwg
24011-01NVFIP-2530-001R1.dwg처럼 저장된 도면명을 입력하세요.
도면수정이 없거나 관련 없으면  '해당 사항 없음'으로 입력하세요."></textarea>
				            </td>
                        </tr>
                        <tr>
							<th style="color: blue;">종료일자</th>
							<td>
								<div class="date_input">
									<input type="text" class="input_calendar form-control" style="width: 100% !important; display: inline-block !important;" id="acteDt"
										name="acteDt" autocomplete="off" date onkeyup="dateMask(this);" msg="종료일자"
									>
								</div>
							</td>
						</tr>
						<tr>
							<th style="color: blue;">조치자 투입공수</th>
							<td><input type="text" id="actMh" name="actMh" comma onkeyup="onlyNumber(this)" msg="조치자 투입공수"></td>
							<!--                             <th style="color:blue;">비용유형</th> -->
							<!--                             <td> -->
							<!-- 	                            <select id="actAmtSts" name="actAmtSts" data-kind="ACTAMTSTS" msg="비용유형"> -->
							<!-- 	                                <option value="">선택</option> -->
							<!-- 	                            </select> -->
							<!--                             </td> -->
						</tr>
						<!--                         <tr> -->
						<!--                             <th style="color:blue;">담당위험도평가</th> -->
						<!--                             <td> -->
						<!-- 	                            <select id="actDng" name="actDng" data-kind="ACTDNG" msg="담당위험도평가"> -->
						<!-- 	                                <option value="">선택</option> -->
						<!-- 	                            </select> -->
						<!--                             </td> -->
						<!--                             <th style="color:blue;">발주요청번호</th> -->
						<!--                             <td> -->
						<!--                                 <div class="search_form"> -->
						<!--                                     <input type="text" id="reqNo" name="reqNo" readonly  msg="발주요청번호" > -->
						<!--                                     <a onclick="openPurchaseSearch();"><i class="i_search_w"></i></a> -->
						<!--                                 </div> -->
						<!--                             </td> -->
						<!--                         </tr> -->
						<!--                         <tr id="actDngEvalTr" style="text-align: left; display:none"> -->
						<!--                             <th style="color:blue;">팀장위험도평가</th> -->
						<!--                             <td> -->
						<!-- 	                            <select id="actDngEval" name="actDngEval" data-kind="ACTDNG" msg="팀장 위험도평가"> -->
						<!-- 	                                <option value="">팀장평가전</option> -->
						<!-- 	                            </select> -->
						<!--                             </td> -->
						<!--                             <th></th> -->
						<!--                             <td> -->
						<!--                             </td> -->
						<!--                         </tr> -->
						<tr>
							<th style="color:blue;">지연일수</th>
						<td>
								<input type="text" id="delayDay" name="delayDay" comma onkeyup="onlyNumber(this)"  msg="지연일수">
							</td>
						</tr>
						<tr>
							<th style="color: blue;">조치자 원인등록</th>
							<td colspan=3>
								<div class="aiContainer">
									<textarea id="measRst" name="measRst" rows="4" msg="조치자원인"></textarea>
									<div class="ai-mark" onclick="openapi('measRst');">AI</div>
								</div>
							</td>
						</tr>
						<tr>
							<th style="color: blue;">조치자 결과등록</th>
							<td colspan=3>
								<div class="aiContainer">
									<textarea id="actCnts" name="actCnts" rows="4" msg="조치자결과"></textarea>
									<div class="ai-mark" onclick="openapi('actCnts');">AI</div>
								</div>
							</td>
						</tr>
						<tr class="issActApproval">
                            <th style="color:blue;">근본원인</th>
							<td colspan=3 style="text-align:left;">
								<div id="FDMTSOLUT-radioButtonContainer" msg="근본원인"></div>
								<!-- <select id="fdmtSolutCd" name="fdmtSolutCd" data-kind="FDMTSOLUT" msg="근본원인">
									<option value="">선택하세요</option>
								</select> -->
							</td>
                        </tr>
						<tr class="issActApproval">
							<th style="color:blue;">근본예방대책<br><span style="font-size:11px;">(핵심목적이므로 책임자가 목적에 맞게 기록 요망)</span></th>
							<td colspan="3">
								<textarea	class="form-control" id="fdmtSolutCnt" name="fdmtSolutCnt" rows="2" maxlength="500" msg="근본대책(세부실행 대책)"></textarea>
							</td>
						</tr>
					</tbody>
				</table>
				<table style="border: 0px;" class="issAct">
					<tr style="height: 30px;">
						<td style="text-align: LEFT; border-right: 0px;; font-size: 13px; font-weight: bold; color: blue;">※ 조치정보 공유 및 결재</td>
						<td>
							<div class="add_btn_small pdl10">
								<a id="btn_plus2" onclick="insertShareUserModal2();" style="height: 30px; line-height: 28px; width: 30px; display: none;"> + </a> <a
									id="btn_minus2" onclick="deleteShareUser2();" style="height: 30px; line-height: 28px; width: 30px; display: none;"
								> - </a>
							</div>
						</td>
					</tr>
					<tr>
						<td colspan="2">
							<div>
								<div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;"></div>
							</div>
						</td>
					</tr>
				</table>
			</form>
		</div>
	</div>

	<div class="contents">
		<!-- 공통 파일 영역 -->
		<div id="fileList_area_SP11" style="width: 100%;"></div>
	</div>

	<br>
	<div class="col-xs-2" style="height: 70px;"></div>

	<div class="popup_bottom_btn">
		<button type="button" id="actionBtn">등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
    var actionType = null;
    var coCd = null;
    var salesCd = null;
    var evlCloseChk = "N";
    var issFileTrgtKey = null;
    var clntPjtNm = null;
    var clntNm = null;
    var salesCd = null;
    var wbsPlanNo = null;
    var wbsRsltsNo = null;
    var wbsPlanCodeKind = null;
    var wbsPlanCodeId = null;
    var wbsPlanCodeNm = null;
    var wbsPlanMngNm = null;
    var wbsMngNm = null;
    var wbsPlansDt = null;
    var wbsPlaneDt = null;
    var wbsRsltssDt = null;
    var wbsRsltseDt = null;
    var approval_Yn = 'N';
    var act_approval_Yn = 'N';
	var teamManagerFlag = false;
    const currFormId = "#popForm_SP11";	//현재화면의 Form ID,  poup 화면을 중복으로 Call 할시 필드명 중복으로 구분 안됨
    const currDivId = "#wbsPopupIss";		//현재화면의 Form ID,  poup 화면을 중복으로 Call 할시 필드명 중복으로 구분 안됨

    //현재일자
	var todayStr = (new Date()).toISOString().slice(0,10); // 'YYYY-MM-DD'
    var rowData = {};

	// 코칭 수정 변수
	var originActCnts = null;	// 기존 원인 값
	var originMeasRst = null;	// 기존 결과 값
	let kakaoDiff = null;		// 변경된 원인, 결과 값 알림 메세지 삽입 변수

	// 크기 조절할 textarea ID 리스트
	const textAreas = [
	    '#issCnts', 			// 내용
	    '#measRst',  			// 원인
	    '#actCnts'  			// 결과
	];
	const textAreas2 = [
	    '#actCompDgnFileNm'  	// 조치 도면 저장명
	];

    setCommonSelect($(currDivId + " select[data-kind]"));

    //카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
	var kakaoErr = [];

	var fileListInfo= []; 	// 사진업로드 
	var selectedPm50List = [];

    // 문제 공유 결재 리스트
    var gridViewApprovalSP11 = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $(currFormId + ' [data-ax5grid="first-grid-modal-P11"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
					onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                    	gridViewApprovalSP11.setData(this.page.selectPage);
                    }
                },
                columns : [
                    {key: "gb",                 label: "구분",        align: "center",   width: 40},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                    {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                    {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                    {key: "name",               label: "성명",        align: "center",   width: 60},
                    {key: "jik",                label: "직위",        align: "center",   width: 60},
                    {key: "reqDate",            label: "요청일자",  align: "center",   width: 80},
                    {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 80},
                    {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
//                     {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                    {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                ]
            });
            return this;
        },
        setData : function(_pageNo) {
            var targetObj = this.target;
            var formData = {
                "fileTrgtKey" : $(currFormId + " #issFileTrgtKey").val(),
                "reqNo" :  $(currFormId + " #issNo").val(),
                "flag" :  "Y1",
                "pageNo" : _pageNo + 1
            }

            postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data) {
                try {
                    var list = data.result;
                    targetObj.setData({
                        list : list,
                        page : {
                            totalElements :  data.paginationInfo.totalRecordCount,
                        }
                    });
                    gridResize1(); //그리드 높이 조정
                } catch (error) {
                    customAlert("오류 발생!! 전산실 연락 바랍니다", error.message);
                    return null; // 오류 발생 시 null 반환
                } finally {
                    // console.log("함수 실행 완료.");
                }
            });
        },
        setData2 : function(_list) {
            this.target.setData({
                list : _list,
                page : {
                    totalElements :  _list.length,
                }
            });
            gridResize1(); //그리드 높이 조정
        }
    }

    //조치 공유 결재 리스트
    var gridViewPop2P11 = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $(currFormId + ' [data-ax5grid="second-grid-modal"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
					onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                    	gridViewPop2P11.setData(this.page.selectPage);
                    }
                },
                columns : [
                    {key: "gb",                 label: "구분",        align: "center",   width: 40},
                    {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                    //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                    {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                    {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                    {key: "name",               label: "성명",        align: "center",   width: 80},
                    {key: "jik",                label: "직위",        align: "center",   width: 60},
                    {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
                    {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
					{key: "etcField1",			label: "투입공수",	align: "center",	width: 60},
                    {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
//                     {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                    {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                ]
            });
            return this;
        },
        setData : function(_pageNo) {
            var targetObj = this.target;
            var formData = {
                "fileTrgtKey" : $(currFormId + " #issFileTrgtKey").val(),
                "reqNo" :  $(currFormId + " #issNo").val(),
                "flag" :  "Y2",
                "pageNo" : _pageNo + 1
            }

            postAjaxSync("/user/qm/qm01/selectShareUserlst", formData, null, function(data) {
                try {
                    var list = data.result;
                    targetObj.setData({
                        list : list,
                        page : {
                            totalElements :  data.paginationInfo.totalRecordCount,
                        }
                    });

					// 결재자가 해당 작성자의 부서 팀장여부 확인 
					// teamManagerFlag == true 이면 근본원인, 근본예방대책 필드 필수입력 및 활성화 2025-08-06 최지상
					list.forEach(function(item){
						if (item.deptId.slice(0,5) === $("#actDeptId").val().slice(0,5) && item.teamManager === 'Y' && item.todoId === jwt.userId) {
							teamManagerFlag = true;
						}
					});
					if (teamManagerFlag && !['COBTP01', 'COBTP04', 'COBTP06', 'COBTP08', 'COBTP09'].includes($("#partCd").val())) {
						$('#FDMTSOLUT-radioButtonContainer').closest('td').prev('th').addClass('hit');
						$('#fdmtSolutCnt').closest('td').prev('th').addClass('hit');
						$('#fdmtSolutCnt').attr('required', 'true');
						$('.teamManagerApproval').removeClass('no-click');
					} else {
						$('#FDMTSOLUT-radioButtonContainer').addClass('disabled-area').find(':radio, :checkbox').on('click', function(e){e.preventDefault();});
					}

                    gridResize2(); //그리드 높이 조정
                } catch (error) {
                    customAlert("오류 발생!! 전산실 연락 바랍니다", error.message);
                    return null; // 오류 발생 시 null 반환
                } finally {
                    // console.log("함수 실행 완료.");
                }
            });
        },
        setData2 : function(_list) {
            this.target.setData({
                list : _list,
                page : {
                    totalElements :  _list.length,
                }
            });
            gridResize2(); //그리드 높이 조정
        }
    }

	function createRadioOptions(groupName, _type) {
		let codeEtc = '';
		var param = {
			"codeKind" : groupName,
			"codeEtc"	: codeEtc
		};
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", param , null,	function(data){
			const codeList = data.childCodeList;
			var container = $(currFormId  + ' #' + groupName + '-radioButtonContainer');
			container.empty().css({
				display: 'flex',
				'flex-wrap': 'wrap',
				gap: '12px',
				'align-items': 'center'
			});
			var typeStr = _type =="radio" ? "radio" : "checkbox";
			codeList.forEach(item => {
				const iHtml = $(`
					<div style="margin-right:12px;">
						<input
							type="${typeStr}"
							id="${item.codeId}"
							name="${item.codeKind}"
							value="${item.codeId}"
							data-label="${item.codeNm}"
							onchange="fnc(this)"
						>
						${item.codeNm}
					</div>
				`);
				container.append(iHtml);
			});
		})
	}

    function createCheckBox(deptCode) {
        if (deptCode == 'TRN30') deptCode = 'TRN50';	//트루넷직접매출
        if (deptCode == 'GUN70') deptCode = 'GUN60';	//생산관리
        if (deptCode == 'GUN90') deptCode = 'TRN50';	//구매협력업체
        if (deptCode == 'GUN50') deptCode = 'TRN50';	//구매외주팀 (건양ITT)
        if (deptCode == 'GUN95') deptCode = 'TRN50';	//실적관리용 (건양ITT)
        if (deptCode == 'GUN80') deptCode = 'GUN40';	//전산실
        $(currFormId + ' #COBGB-checkboxContainer-P11').empty();
        var param = {
        	"userDept" : deptCode,
       		"codeEtc"  : 'ISS'  //문제 선택 옵션
        };

        postAjaxSync("/admin/cm/cm05/selectCheckboxList", param , null,  function(data){
          var codeList = data.childCodeList;
          var container = $(currFormId + ' #COBGB-checkboxContainer-P11');
          var lastKind = '';
          const table = $('<table>').appendTo(currFormId + ' #COBGB-checkboxContainer-P11')
          var tableRow = '';
          $.each(codeList, function (index, item){
             if (lastKind != item.codeKind) {
                tableRow = $('<tr>').appendTo(table);
                var trElement = $('<tr>');
                $('<th>').attr('rowspan', item.rowCnt).css('width', '90').text(item.codeDesc).appendTo(tableRow);
                lastKind = item.codeKind;
             } else {
                tableRow = $('<tr>').appendTo(table);
                var trElement = $('<tr>');
             }
             const comboName= "CODECOBGB";
             const iHtml =
               '<input type="radio" id="' + item.codeId +
                             '" name="' + comboName +
                            '" value="' + item.codeId +
                         '" data-label="' + item.codeNm +
                  '" onchange="fnc(this)" style="margin-left:20px"> ' + item.codeNm + '\n';
             let etcInput = '';
             if (item.codeId.length > 2) {
	             if (item.codeId.slice(-2) =='99'){
	            	 etcInput =
	            		 '<span id="etcInputWrapper" style="display:none; margin-left:5px;">' +
	            	     '<input type="text" id="etcInput" name="etcInput" msg="기타사유" placeholder="기타사유" style="width:150px;">' +
	            	     '</span>\n';
	             }
             }

             const tdElement  = $('<td>').attr('style', 'text-align:left;height:20px;').text('').appendTo(tableRow);
             tdElement.append(iHtml + etcInput);

          });
       })
       const grdiHeight = $(currFormId + ' #COBGB-checkboxContainer-P11').height()-35;
       gridViewApprovalSP11.target.setHeight(grdiHeight< 162 ? 162 : grdiHeight);
    }

    function fnc(thisButton) {
        const inputType = thisButton.type;
        const inputName = thisButton.name;
        const inputvalue = thisButton.value;

//        if (inputType === 'radio') {
//           console.log(thisButton.dataset.label + ' radio button. = ' + $(currFormId + ' input[name='COBTP']:checked").val() + ' 선택');
//        } else if (inputType === 'checkbox') {
//           console.log(thisButton.dataset.label + ' checkbox. = ' + thisButton.value + '의 상태는 ' + thisButton.checked);
//        }
       if (thisButton.id == 'COBTP99') {
          $(currFormId + " #COBGB9999").prop("checked", $(currFormId + " #COBTP99")[0].checked);
       }
       
       if (inputName === 'CODECOBGB' && inputvalue.length > 2) {
			const etcField = inputvalue.slice(-2); 
      
			if (etcField == '99') {
				$('#etcInputWrapper').show();
				$('#etcInput').focus().attr('required', true).closest('td').prev('th').addClass('hit');
			} else {
				$('#etcInputWrapper').hide();
				$('#etcInput').val('').removeAttr('required').closest('td').prev('th').removeClass('hit');
				// COBGB4301 : 외주가공 장애
				// COBGB4302 : 외주설계 장애
				// COBGB4303 : 외주제작 장애
// 				if (inputvalue.includes('COBGB4301') || inputvalue.includes('COBGB4302') || inputvalue.includes('COBGB4303')) {
// 					$('#vendCdNm').val('').focus().attr('required', true).closest('td').prev('th').addClass('hit');
// 					$('#vendCd').val('').attr('required', true);
// 				} else { 
// 					$('#vendCdNm').removeAttr('required').closest('td').prev('th').removeClass('hit');
// 					$('#vendCd').removeAttrr('required');
// 				}
			}
		}
    }
    $(document).ready(function() {
        
        actionType = modalStack.last().paramObj.actionType;
        if (actionType == undefined) actionType = "I";
    	//결재에서 들어온경우 수정 불가로 수정 버튼 제거함
    	if (actionType == "I") {
    		$(currDivId + '  #actionBtn').remove();
    	}
        coCd = modalStack.last().paramObj.coCd;
        salesCd = modalStack.last().paramObj.salesCd;

		fileListInfo = modalStack.last().paramObj.fileListInfo; // 출장자 사진업로드에서 가져온 파일 리스트
		selectedPm50List = modalStack.last().paramObj.selectedPm50List; // 출장자 사진업로드에서 가져온 파일 메타데이터

        $(currFormId + ' #actionType').val(actionType);
        $(currFormId + ' #coCd').val(coCd);
        $(currFormId + ' #salesCd').val(salesCd)
        $(currFormId + ' #userId').val(jwt.userId);

		//진행상태가 완료일 경우 투입공수, 투입비용, 조치내용은 필수 입력임  actAmtSts actDng FDMTSOLUT
		$(currFormId + ' #issSts').change(function () {
			if ($(currFormId + ' #issSts').val() == 'ISSSTS03') {
				$(currFormId + ' #actsDt').closest('td').prev('th').addClass("hit");
        		$(currFormId + ' #actsDt').attr('required', true);
        		$(currFormId + ' #acteDt').closest('td').prev('th').addClass("hit");
        		$(currFormId + ' #acteDt').attr('required', true);
        		$(currFormId + ' #actMh').parent('td').prev('th').addClass('hit');
        		$(currFormId + ' #actMh').attr('required', true);
//         		$(currFormId + ' #actAmt').parent('td').prev('th').addClass('hit');
//         		$(currFormId + ' #actAmt').attr('required', true);
        		$(currFormId + ' #measRst').closest('td').prev('th').addClass('hit');
        		$(currFormId + ' #measRst').attr('required', true);
        		$(currFormId + ' #actCnts').closest('td').prev('th').addClass('hit');
        		$(currFormId + ' #actCnts').attr('required', true);
//         		$(currFormId + ' #actAmtSts').parent('td').prev('th').addClass('hit');
//         		$(currFormId + ' #actAmtSts').attr('required', true);
//         		$(currFormId + ' #actDng').parent('td').prev('th').addClass('hit');
//         		$(currFormId + ' #actDng').attr('required', true);
        		$('#actCompDgnFileNm').parent('td').prev('th').addClass('hit');
        		$('#actCompDgnFileNm').attr('required', 'true');
				// $('#fdmtSolutCd').closest('td').prev('th').addClass('hit');
				// $('#fdmtSolutCd').attr('required', 'true');
				// $('#FDMTSOLUT-radioButtonContainer').closest('td').prev('th').addClass('hit');
				// $('#fdmtSolutCnt').closest('td').prev('th').addClass('hit').attr('required', 'true');

				// 조치내용 입력시 문제정보의 유형이 일정이면 지연일수 필드 필수 입력
				if ($(currFormId + ' #issDiv').val() == 'ISSDIV10') {
					$(currFormId + ' #delayDay').closest('td').prev('th').addClass("hit");
					$(currFormId + ' #delayDay').attr('required', true);
				} else {
					$(currFormId + ' #delayDay').closest('td').prev('th').removeClass('hit');
					$(currFormId + ' #delayDay').removeAttr('required', 'true');
				}

        		$(currFormId + ' #btn_plus2').show();
        		$(currFormId + ' #btn_minus2').show();
        		if (act_approval_Yn == 'Y') {
        			$(currDivId).find('#actionBtn').hide();
        		} else {
        			$(currDivId).find('#actionBtn').show();
        		}
            	$(currDivId).find('.issAct').removeClass('no-click');
            	$(currDivId).find('.issActApproval').addClass('no-click');	// 근본원인,근본예방대책 필드는 결재시 팀장만 입력하겠끔

        	} else {
        		$(currFormId + ' #actsDt').closest('td').prev('th').removeClass('hit');
        		$(currFormId + ' #actsDt').removeAttr('required', 'true');
        		$(currFormId + ' #acteDt').closest('td').prev('th').removeClass('hit');
        		$(currFormId + ' #acteDt').removeAttr('required', 'true');
        		$(currFormId + ' #actMh').parent('td').prev('th').removeClass('hit');
        		$(currFormId + ' #actMh').removeAttr('required', 'true');
//         		$(currFormId + ' #actAmt').parent('td').prev('th').removeClass('hit');
//         		$(currFormId + ' #actAmt').removeAttr('required', 'true');
        		$(currFormId + ' #measRst').closest('td').prev('th').removeClass('hit');
        		$(currFormId + ' #measRst').removeAttr('required', 'true');
        		$(currFormId + ' #actCnts').closest('td').prev('th').removeClass('hit');
        		$(currFormId + ' #actCnts').removeAttr('required', 'true');
//         		$(currFormId + ' #actAmtSts').parent('td').prev('th').removeClass('hit');
//         		$(currFormId + ' #actAmtSts').removeAttr('required', 'true');
//         		$(currFormId + ' #actDng').parent('td').prev('th').removeClass('hit');
//         		$(currFormId + ' #actDng').removeAttr('required', 'true');
        		$('#actCompDgnFileNm').parent('td').prev('th').removeClass('hit');
        		$('#actCompDgnFileNm').removeAttr('required', 'true');
				// $('#fdmtSolutCd').closest('td').prev('th').removeClass('hit');
				// $('#fdmtSolutCd').removeAttr('required', 'true');
				// $('#FDMTSOLUT-radioButtonContainer').closest('td').prev('th').removeClass('hit');
				// $('#fdmtSolutCnt').closest('td').prev('th').removeClass('hit').removeAttr('required', 'true');
				
				// 조치내용 입력시 문제정보의 유형이 일정이면 지연일수 필드 필수 입력
				if ($(currFormId + ' #issDiv').val() == 'ISSDIV10') {
					$(currFormId + ' #delayDay').closest('td').prev('th').addClass("hit");
					$(currFormId + ' #delayDay').attr('required', true);
				} else {
					$(currFormId + ' #delayDay').closest('td').prev('th').removeClass('hit');
					$(currFormId + ' #delayDay').removeAttr('required', 'true');
				}

        		$(currFormId + ' #btn_plus2').hide();
        		$(currFormId + ' #btn_minus2').hide();
        		if (approval_Yn == 'Y') {
        			$(currDivId).find('#actionBtn').hide();
        		} else {
        			$(currDivId).find('#actionBtn').show();
        		}
            	$(currDivId).find('.issAct').addClass('no-click');
        	}
		})

		// 근본원인 change이벤트에 따른 내용입력 필드 필수여부
		// $(currFormId + ' #fdmtSolutCd').change(function () {
		// 	if ($(currFormId + ' #fdmtSolutCd').val() != '') {
		// 		$(currDivId + ' #fdmtSolutCnt').closest('td').prev('th').addClass('hit');
		// 		$(currDivId + ' #fdmtSolutCnt').attr('required', 'true');
		// 	} else {
		// 		$(currDivId +' #fdmtSolutCnt').closest('td').prev('th').removeClass('hit');
		// 		$(currDivId +' #fdmtSolutCnt').removeAttr('required', 'true');
		// 	}
		// })

		//진행상태가 완료일 경우 투입공수, 투입비용, 조치내용은 필수 입력임  actAmtSts actDng
// 		$(currFormId + ' #actAmtSts').change(function () {
// 			if ($(currFormId + ' #actAmtSts').val() == 'ACTAMTSTS01') {
// 				$(currFormId + ' #reqNo').closest('td').prev('th').addClass("hit");
//         		$(currFormId + ' #reqNo').attr('required', 'true');
//         	} else {
//         		$(currFormId + ' #reqNo').closest('td').prev('th').removeClass('hit');
//         		$(currFormId + ' #reqNo').removeAttr('required', 'true');
//         	}
// 		})
         // 조치 시작일자, 종료일자 세팅
        $(currFormId + ' #actsDt').datepicker({
            format    : "yyyy-mm-dd",
            language  : "ko",
            autoclose : true
        })
        .datepicker("setDate", moment(new Date()).startOf("month").toDate())
        .on("changeDate", function() {
            //조치 시작일자 종료일자 체크
            //1. 조치시작일자는 계획 시작일자 이전일 수 없다.
            if( $(currFormId + ' #actsDt').val() != undefined && $(currFormId + ' #actsDt').val() < $(currFormId + ' #wbsRsltssDt').val()) {
                customAlert("조치 시작일은 계획 시작일 이전일 수 없습니다.");
                $(currFormId + ' #actsDt').datepicker("setDate", new Date($(currFormId + ' #wbsRsltssDt').val()));
                return;
            }

            //2. 조치 시작일자는 조치 종료일자 이후 일 수 없다. 하지만 종료일자가 없으면 체크 안해야지
            if( $(currFormId + ' #actsDt').val() != undefined && $(currFormId + ' #acteDt').val() != undefined && $(currFormId + ' #actsDt').val() > $(currFormId + ' #acteDt').val()) {
                customAlert("조치 시작일은 조치 종료일 이전일 수 없습니다.");
                $(currFormId + ' #acteDt').datepicker("setDate", $(currFormId + ' #actsDt').val());
                return;
            }
        });

        $(currFormId + ' #acteDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true
        })
        .datepicker("setDate",  moment(new Date()).endOf("month").toDate())
        .on("changeDate", function(){
            if( $(currFormId + ' #actsDt').val() != undefined && $(currFormId + ' #acteDt').val() != undefined && $(currFormId + ' #actsDt').val() > $(currFormId + ' #acteDt').val()) {
                customAlert("조치 종료일은 조치 시작일 이전일 수 없습니다.");
                $(currFormId + ' #actsDt').datepicker("setDate", $(currFormId + ' #acteDt').val());
            }
        });
        

		//요구일정//
		$(currFormId + " #reqDt").datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true})
								 .datepicker("setDate", '');
		//요구일정//
		$(currFormId + " #custReqDt").datepicker({format : "yyyy-mm-dd", language : "ko", autoclose : true})
								 .datepicker("setDate", '');
		
        //등록시 조치내역 입력 못하게
        /****************************************************************************
        ** actionType 작업 분류
        **   C1,C2 : 일정관리에서 계획문제 등록시
        **   C3,C4 : 이슈관리화면에서 계획문제 등록시
        **   U3,U4 : 이슈관리화면에서 계획문제 수정시
        **    I : To-Do List에서 결재확인을 위한 실행시
        ****************************************************************************/

        if (actionType == "U3" || actionType == "U4") {
			$(currDivId).find('#issDiv').addClass('no-click');
        } else {
//          $("#actsDt, #acteDt, #actMh, #actAmt, #actCnts").prop('readonly', true);
			//class="issAct"  --> 조치내역 전체 class 명임
     		$(currDivId).find('.issAct').addClass('no-click');
     	}


        gridViewApprovalSP11.initView();

        $(currFormId + ' #actsDt').val("");
        $(currFormId + ' #acteDt').val("");

        selectSjInfo();  //수주정보 화면에 표시

		createRadioOptions('FDMTSOLUT', 'checkbox') // 근본원인 구분

    	if (actionType == "U3" || actionType == "U4" || actionType == "I")  {  //  actionType == "U3" or "U4"  or "I"
            //등록된 모드 데이터 가져오기
			select_wb2401p01_Info();
			$(currDivId).find('.issAct').addClass('no-click');

    	}

        $(currFormId + ' #wbsPlanNo').val(modalStack.last().paramObj.wbsPlanNo);
        $(currFormId + ' #wbsRsltsNo').val(modalStack.last().paramObj.wbsRsltsNo);

        if (actionType == "C1" || actionType == "C3" || actionType == "C2" || actionType == "C4") {
			// 계획, 실적 문제등록 시 유형필드 기타 선택칸 제거
			$('select[data-kind="ISSDIV"] option[value="ISSDIV90"]').remove();
            var paramObj = {
            		"userId" 	: jwt.userId,
            		"wbsPlanNo" : modalStack.last().paramObj.wbsPlanNo,
            		"wbsRsltsNo" : modalStack.last().paramObj.wbsRsltsNo,
            		};
        	var execPgm = "";
        	if (actionType == "C1" || actionType == "C3") {
        		execPgm = "select_wb2401p01_planInfo";		//계획이슈
        	} else {
        		execPgm = "select_wb2401p01_rsltInfo";		//실적이슈
        	}
            postAjaxSync("/user/wb/wb24/" + execPgm, paramObj, null, function(data) {
    			$.each(data.result, function(key, value) {
    				if ($(currFormId + ' #' + key)[0]) {
    					$(currFormId + ' #' + key).val(value);

    					if ($(currFormId + ' #' + key).is('[comma]')) {
    						onlyNumber($(currFormId + ' #' + key)[0]);
    					}
    				}
    			});
            });

        	$(currFormId + ' #createQualityReq').hide();
            $(currDivId + ' #issSts').val('ISSSTS01');	//처음 등록은 접수로 설정하기
    		$(currFormId + ' #issSts').prop('disabled', true); //상태 수정금지 처리
            $(currDivId + ' #actionBtn').text("등록");
            $(currDivId + ' #actionBtn').on("click", function() {
                insertWbsIssue();
            });
        } else if (actionType == "U3" || actionType == "U4") {
        	$(currDivId + ' #actionBtn').text("수정");
            $(currDivId + ' #actionBtn').on("click", function() {
                updateWbsIssue();
            });
        }

        
        gridViewApprovalSP11.initView().setData(0);
        gridViewPop2P11.initView().setData(0);

        if ($(currFormId + ' #issSts').val() == "ISSSTS03") {
        	$(currFormId + ' #createQualityReq').hide();
        }

        //---------------------------------------------------------------
        //첨부 화일 처리 시작
        //---------------------------------------------------------------
        fileParam = {
            fileTrgtTyp : $(currFormId + ' #pgmId').val(),
            fileTrgtKey : $(currFormId + ' #issFileTrgtKey').val(),
            todoNo		: $(currFormId + ' #issNo').val(),
        }
        treeModule.initAll('deptTreeOrdarsSP11', 'file-gridSP11', 'FILETREE', fileParam, 'fileList_area_SP11');
        //---------------------------------------------------------------
        //첨부 화일 처리 끝
        //---------------------------------------------------------------

		// 출장자 사진업로드에서 가져온 파일첨부 내용 등록 시 처리 루트
		$('#deptTreeOrdarsSP11').on('loaded.jstree', function () {
			// if (actionType == "C") {
				if (fileListInfo && fileListInfo.length) {
					const tree = $(this).jstree(true);
					// 부모(루트)도 확실히 열어 주고
					tree.open_node('FILETREE', function () {
						// FITR05(사진, 미디어) 선택
						tree.deselect_all();
						tree.select_node('FITR05');
						// 데이터 강제 로드
						treeModule.getAllFilesForNodes('FITR05');
						// 그리고 파일리스트 영역 표시
						$('#fileList_area_SP11 #fileAttachTxt').hide();
						$('#fileList_area_SP11 #fileAttachCnts').show();
					});
					// 1) 파일 input 요소 찾기
					const input = document.getElementById('fileList_area_SP11').querySelector('input[type="file"]');
					if (input) {
						// 2) DataTransfer 생성하고 파일 추가
						const dt = new DataTransfer();
						fileListInfo.forEach(f => dt.items.add(f));
						// 3) input에 할당
						input.files = dt.files;
						// 4) change 이벤트 트리거
						const evt = new Event('change', { bubbles: true });
						input.dispatchEvent(evt);
					}
				}
				if (selectedPm50List && selectedPm50List.length) {
					const text = selectedPm50List
						.map(item => item.bfuCnts || '')
						.join('\n');
					$('#issCnts').val(text);
				}
			// } else return false;
			
		});

		// 크기 조절할 textarea ID 리스트
		$(textAreas.join(',')).on('input paste drop change', function () {
			// 각 textarea에 대해 크기 조절 함수 호출
			txtareaHeightResize($(this));
		});

		// 크기 조절할 textarea ID 리스트2
		$(textAreas2.join(',')).on('input paste drop change', function () {
			// 각 textarea에 대해 크기 조절 함수 호출
			txtareaHeightResize2($(this));
		});


		// 결재시 수정하면 change 이벤트 적용
		$(currFormId).on('input paste drop change', '#measRst, #actCnts, #FDMTSOLUT-radioButtonContainer input[type=checkbox], #fdmtSolutCnt, #COBGB-checkboxContainer-P11 input[type=radio]',function() {
			if ($(currDivId + ' #commentBtn').length === 0 && actionType === 'I' && teamManagerFlag) {
				const callCmdBtn = '<button id="commentBtn">코칭수정</button>';
				$(currDivId + ' .popup_bottom_btn').first().prepend(callCmdBtn);
				$(currDivId + ' #commentBtn').on('click', () => updateIssueComment('결과수정'));
			}
		});

		// if (fileInfo.length > 0) {

		// }
		
        
        
        authChk();

        // 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
        var paramObj = {
            "coCd" : coCd,
            "salesCd" : salesCd,
        };
        postAjaxSync("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data) {
            if (data.result[0].closeChk == "Y") {
                evlCloseChk = data.result[0].closeChk;
                $(currDivId + ' #actionBtn').hide();
            }
        });
        // ----------------------------------
    });



	// 결재시 코멘트 추가 수정
	function updateIssueComment(){
		if (inputValidation($('.popup_area [required]'))) {
			if ($("input[name='FDMTSOLUT']:checked").val() == undefined) {
				customAlert("근본원인을 선택해주세요.");
				return false;
			} else {
				var formData = makeFormData();
				filePostAjax("/user/wb/wb24/updateIssueComment", formData, function(data) {
					if (data.resultCode == 200) {
						$(currDivId + ' #commentBtn').remove();
		
						// 카카오톡 메세지 문구 추가 설정
						// 원인
						const newMeasRaw = formData.get("measRst");
						const originMeasRaw = originMeasRst;
						const newMeasClean    = newMeasRaw.replace(/\r\n/g, "\n");
						const originMeasClean = originMeasRaw.replace(/\r\n/g, "\n");
		
						let diffMeas = "";
						if (newMeasClean.startsWith(originMeasClean)) {
							diffMeas = newMeasClean.slice(originMeasClean.length);
						} else if (newMeasClean.includes(originMeasClean)) {
							diffMeas = newMeasClean.split(originMeasClean)[1];
						}
						diffMeas = diffMeas.replace(/^[\r\n]+/, "");
		
						// 결과
						const newActRaw    = formData.get("actCnts");
						const originActRaw = originActCnts;
						const newActClean    = newActRaw.replace(/\r\n/g, "\n");
						const originActClean = originActRaw.replace(/\r\n/g, "\n");
		
						let diffAct = "";
						if (newActClean.startsWith(originActClean)) {
							diffAct = newActClean.slice(originActClean.length);
						} else if (newActClean.includes(originActClean)) {
							diffAct = newActClean.split(originActClean)[1];
						}
						diffAct = diffAct.replace(/^[\r\n]+/, "");
		
						// 전역 kakaoDiff 설정
						kakaoDiff = { cause: diffMeas, result: diffAct };
		
						// diff가 있으면 카톡 발송
						if (diffMeas || diffAct) {
							kakaoTodo();
						}
					}
				});
				return true;
			}
		} else { return false;}
	}
				
		
    //수주정보
    function selectSjInfo (){
		var paramObj = {
			"coCd"		: coCd,
			"salesCd"	: salesCd,
		};
		postAjaxSync("/user/wb/wb22/selectSjInfo", paramObj, null, function(data){
			var row = data.resultList;
			if (row != undefined) {
				$.each(row, function (key, val) {
					$(currFormId + ' #' + key).val(val);
					if (key == "closeYn") {
						var color = val == "Y" ? "color-circle_02.png" : "color-circle_01.png";
						var html = '<img src="/static/img/'+color+'" align="center" style="width: 10px;height: 10px;"></img>';
						$(currFormId + ' #close').html(html)
					}
					
					//과제마스터에 등록된 출고일자
					if (key == 'deDt') {
						//출고일자가 현재일자 이전이면 사내조치완료일, 고객조치완료일은 필요 없음
    					if (val < todayStr && row.creatDtTemp > '2025-06-20') {
							//사내조치완료일, 고객조치완료일 필수 입력
    						$('#reqDt').focus().attr('required', true).closest('td').prev('th').addClass('hit');
    						$('#custReqDt').focus().attr('required', true).closest('td').prev('th').addClass('hit');
						} else {
							//사내조치완료일, 고객조치완료일 선택 입력
							$('#reqDt').removeAttr('required').closest('td').prev('th').removeClass('hit');
							$('#custReqDt').removeAttr('required').closest('td').prev('th').removeClass('hit');
						}
					}

				});
			}
		});
    }

    function insertWbsIssue() {
        if (inputValidation($(currFormId).find('[required]'))) {
        	 if($(currFormId + " input[name='CODECOBGB']:checked").val() == undefined || $(currFormId + " input[name='CODECOBGB']:checked").val() == ""){
                 customAlert("장애유형을 선택해주세요");
            } else {

				if (inputValidationCheck()) {
	            	$(currFormId + ' #issSts').val('ISSSTS01');
		            var formData = makeFormData();
		            filePostAjax("/user/wb/wb24/wbsIssueInsert", formData, function(data) {
		                customAlert(data.resultMessage);
		                if (data.resultCode == 200) {
		                	$(currFormId + ' #issNo').val(data.resultIssNo);
		                    kakaoTodo();
	                    	if (typeof gridView !== "undefined") gridView.setData(0);
	                    	if (typeof gridView2 !== "undefined") gridView2.setData(0);
	                    	if (typeof salesGridView !== "undefined") salesGridView.setData(0);
	                    	if (typeof issueGridView !== 'undefined') issueGridView.setData(0);

							// 출장자 사진 업로드 프로그램에 문제등록 정보 업데이트
							update_issue_pm50_d01(data.resultIssNo);
		                    modalStack.close();
		                }
		            });
				}
	        }
        }
    }

    function updateWbsIssue() {
        if (inputValidation($(currFormId).find('[required]'))) {
			if($(currFormId + " input[name='CODECOBGB']:checked").val() == undefined || $(currFormId + " input[name='CODECOBGB']:checked").val() == ""){
                customAlert("장애유형을 선택해주세요");
			} 
			// else if ($("#issSts").val() == 'ISSSTS03' && $("input[name='FDMTSOLUT']:checked").val() == undefined) {
			// 	customAlert("근본원인을 선택해주세요.");
			// } 
			else {
				if (inputValidationCheck()) {
		            var formData = makeFormData();
		            filePostAjax("/user/wb/wb24/wbsIssueUpdate", formData, function(data) {
		                customAlert(data.resultMessage);
		                if (data.resultCode == 200) {
		                    kakaoTodo();
	                    	if (typeof gridView !== "undefined") gridView.setData(0);
	                    	if (typeof gridView2 !== "undefined") gridView2.setData(0);
	                    	if (typeof salesGridView !== "undefined") salesGridView.setData(0);
	                    	if (typeof issueGridView !== 'undefined') issueGridView.setData(0);
		                    modalStack.close();
		                }
		            });
				}
			}
        }
    }

    // 사내작업일, 고객요구일 추가 및 오류 수정
    function inputValidationCheck() {
    	if ($(currFormId + '#creatDt').val() < '20250621') { //조건적용 기준일자 20250620이전자료는 입력필드 없었음.
    		return true;
    	} 
    	
    	var reqDt = $(currFormId + ' #reqDt').val();
    	var custReqDt = $(currFormId + ' #custReqDt').val();
    	var deDt = $('#popForm_S #deDt').val();
    	
    	if (deDt < todayStr) {
	    	if (reqDt < todayStr) {
	    		customAlert('사내요구일자가 현재일보다 작을수 없습니다.');
	    		$(currFormId + ' #reqDt').focus();
	    		return false;
	    	} 
	    	if (custReqDt < todayStr) {
	    		customAlert('고객요구일자가 현재일보다 작을수 없습니다.')
	    		$(currFormId + ' #custReqDt').focus();
	    		return false;
	    	} 
    	}

		
// 		var selectedVal = $('input[name="CODECOBGB"]:checked').val();
// 		if (selectedVal.includes('COBGB4301') || selectedVal.includes('COBGB4302') || selectedVal.includes('COBGB4303')) {
// 			alert('등록사유가 외주가공장애, 외주설계장애, 외주제작장애는 발생공급업체를 검색으로 등록바랍니다.')
// 			$(currFormId + ' #vendCdNm').focus();
// 			return false;
// 		} 
		
// 		if ($(currFormId + ' #vendCdNm').val() != '' && $(currFormId + ' #vendCd').val() == '') {
// 			alert('발생공급업체를 검색으로 등록바랍니다.')
// 			$(currFormId + ' #vendCdNm').focus();
// 			return false;
// 		} 
    	
		return true;
    }
    
    function makeFormData() {
        $.each($(currFormId).find('[comma]'), function(idx, elem) {
            deleteComma(elem);
        });

        if (actionType == "C1" || actionType == "U1" || actionType == "C3" || actionType == "U3") {
            $(currFormId + ' #wbsRsltsNo').val("");
        }
        else if (actionType == "C2" || actionType== "U2" || actionType == "C4" || actionType == "U4") {
            $(currFormId + ' #wbsPlanNo').val("");
        }
		// 근본원인 체크된 객체들 배열로 변환하고 조인
		const rootCauses = $('#FDMTSOLUT-radioButtonContainer input[type="checkbox"]:checked')
					.map(function() { return this.value; })
					.get()   // jQuery 객체 -> 일반 배열
					.join(',');  // ["A","B","C"] -> "A,B,C"

		//1. 조치담당자 결재 자동등록 처리하기
		//2. 조치담당자 팀장 결재 자동등록 처리하기
		//3. 문제 등록자 담당팀장 결재 자동 등록 처리하기
		selectTeamManagerApprovalAdd();  //($("#issSts").val() == 'ISSSTS03')에달 등록인지 결과인지 판단함

        // 폼데이터 생성
        var formData = new FormData($("#popForm_SP11")[0]);

		formData.set('FDMTSOLUT', rootCauses);

        //-------itemarr  --첨부화일 처리를 위한 부분 시작
        formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용
        formData.append("approvalYnCnt", approvalYn());
        formData.append("approvalYnCnt2", approvalYn2());
        formData.append("issNo", $(currFormId + ' #issNo').val());
        formData.append("issFileTrgtKey", $(currFormId + ' #fileTrgtKey').val());
        formData.set("issSts", $(currFormId + ' #issSts').val());	//해당키가 있으면 수정, 없으면 추가

        var fileUploadArr = [];
        var tempArr = [];
        tempArr = treeModule.getFileArr();
        $.each(tempArr, function(idx, obj) {
            if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
            }
        });

        formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
        //---------------------------------------------------------------
        //--첨부화일 처리를 위한 부분 끝
        //---------------------------------------------------------------
        var rowSharngList = gridViewApprovalSP11.target.list;
        var ParamObj = modalStack.last().paramObj.ParamObj;

        if(rowSharngList.length > 0) {
            var rowSharngListArr = []; //공유정보
            var rowApprovalListArr = []; //결재정보

            $.each(rowSharngList, function(idx, elem) {
                var rowSharngListObj = elem;
                var rowApprovalListObj = elem;

                if (elem.gb == '공유') {
                    rowSharngListObj["gb"] = elem.gb;
                    rowSharngListObj["coCd"] = coCd;
                    rowSharngListObj["salesCd"] = salesCd;
                    rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
                    rowSharngListObj["todoDiv2CodeId"] = "TODODIV1030";
                    rowSharngListObj["todoId"] = elem.usrNm;
                    rowSharngListObj["todoCoCd"] = elem.coCd;
                    rowSharngListObj["empNo"] = elem.empNo;
                    rowSharngListObj["name"] = elem.name;
                    rowSharngListObj["telNo"] = elem.telNo;
                    rowSharngListObj["email"] = elem.eMail;
                    rowSharngListObj["pgPath"] = "/user/wb/wb24/WB2401P11.html";
                    rowSharngListArr.push(rowSharngListObj);
                }
                else if (elem.gb == '결재') {
                    rowApprovalListObj["gb"] = elem.gb;
                    rowApprovalListObj["coCd"] = coCd;
                    rowApprovalListObj["salesCd"] = salesCd;
                    rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
                    rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2060";
                    rowApprovalListObj["todoId"] = elem.usrNm;
                    rowApprovalListObj["todoCoCd"] = elem.coCd;
                    rowApprovalListObj["empNo"] = elem.empNo;
                    rowApprovalListObj["name"] = elem.name;
                    rowApprovalListObj["telNo"] = elem.telNo;
                    rowApprovalListObj["email"] = elem.eMail;
                    rowApprovalListObj["pgPath"] = "/user/wb/wb24/WB2401P11.html";
                    rowApprovalListArr.push(rowApprovalListObj);
                }
            });
            formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
            formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
        }
        // 조치정보 공유 결재
        var rowSharngList2 = gridViewPop2P11.target.list;
        var ParamObj2 = modalStack.last().paramObj.ParamObj;

        if(rowSharngList2.length > 0) {
            var rowSharngListArr2 = []; //공유정보
            var rowApprovalListArr2 = []; //결재정보

            $.each(rowSharngList2, function(idx, elem) {
                var rowSharngListObj2 = elem;
                var rowApprovalListObj2 = elem;

                if (elem.gb == '공유') {
                    rowSharngListObj2["gb"] = elem.gb;
                    rowSharngListObj2["coCd"] = coCd;
                    rowSharngListObj2["salesCd"] = salesCd;
                    rowSharngListObj2["todoDiv1CodeId"] = "TODODIV10";
                    rowSharngListObj2["todoDiv2CodeId"] = "TODODIV1090"; // WBS조치
                    rowSharngListObj2["todoId"] = elem.usrNm;
                    rowSharngListObj2["todoCoCd"] = elem.coCd;
                    rowSharngListObj2["empNo"] = elem.empNo;
                    rowSharngListObj2["name"] = elem.name;
                    rowSharngListObj2["telNo"] = elem.telNo;
                    rowSharngListObj2["email"] = elem.eMail;
                    rowSharngListObj2["pgPath"] = "/user/wb/wb24/WB2401P11.html";
                    rowSharngListArr2.push(rowSharngListObj2);
                }
                else if (elem.gb == '결재') {
                    rowApprovalListObj2["gb"] = elem.gb;
                    rowApprovalListObj2["coCd"] = coCd;
                    rowApprovalListObj2["salesCd"] = salesCd;
                    rowApprovalListObj2["todoDiv1CodeId"] = "TODODIV20";
                    rowApprovalListObj2["todoDiv2CodeId"] = "TODODIV2090"; // WBS조치
                    rowApprovalListObj2["todoId"] = elem.usrNm;
                    rowApprovalListObj2["todoCoCd"] = elem.coCd;
                    rowApprovalListObj2["empNo"] = elem.empNo;
                    rowApprovalListObj2["name"] = elem.name;
                    rowApprovalListObj2["telNo"] = elem.telNo;
                    rowApprovalListObj2["email"] = elem.eMail;
                    rowApprovalListObj2["pgPath"] = "/user/wb/wb24/WB2401P11.html";
                    rowApprovalListArr2.push(rowApprovalListObj2);
                }
            });
            formData.append("rowSharngListArr2", JSON.stringify(rowSharngListArr2));
            formData.append("rowApprovalListArr2", JSON.stringify(rowApprovalListArr2));
        }
        return formData;
    }

    //작성자, 담당자  검색
    function openUserSearch(type) {
        if (approval_Yn == "Y") {
            return;
        }

        var userID = null;
        var paramObj = {};
        paramObj["coCd"] = jwt.coCd;
        paramObj["userId"] = $(currFormId + ' #actId').val();
        paramObj["useYn"] =  "Y";
        paramObj["pgmId"] = $('#pgmId').val(); // 계획 및 실적 문제 등록 시 조치담당자 실적관리용 제외하기 위한 용도
        openThirdModal("/static/html/cmn/modal/userSearch.html", 450, 650, "작성자 검색", paramObj, function (tree){
            var checkedId = tree.get_checked()[0];
            userID = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);

            //부서별 발주요청서 등록사유 자동 생성하기
            createHtmlCode1(checkedNode.parent.slice(0,5))


            $(currFormId + ' #actId').val(checkedNode.id);
            $(currFormId + ' #actNm').val(checkedNode.text);
            var paramObj = {"coCd" : $(currFormId + ' #coCd').val(), "userId" : userID};
            postAjaxSync("/user/wb/wb24/selectRsltsMemberList", paramObj, null, function(data) {
                var chk = false;
                var rowList = gridViewApprovalSP11.target.getList();
                $.each(rowList, function(idx, elem) {
                    if (elem.usrNm == data.resultList[0].usrNm) {
                        chk = true;
                    }
                });

                if (chk == false) {
                    gridViewApprovalSP11.target.addRow($.extend({}, "last", false));
                    var row = gridViewApprovalSP11.target.getList().length - 1;
                    gridViewApprovalSP11.target.setValue(row, "gb", '결재');
                    gridViewApprovalSP11.target.setValue(row, "wbsPlancoCdNm", data.resultList[0].wbsPlancoCdNm);
                    gridViewApprovalSP11.target.setValue(row, "usrNm", data.resultList[0].usrNm); //ID
                    gridViewApprovalSP11.target.setValue(row, "empNo", data.resultList[0].empNo); // 사원번호
                    gridViewApprovalSP11.target.setValue(row, "name",data.resultList[0].name); // 성명
                    gridViewApprovalSP11.target.setValue(row, "jik", data.resultList[0].jik); // 직위
                    gridViewApprovalSP11.target.setValue(row, "reqDate", data.resultList[0].reqDate); // 요청일자
                    gridViewApprovalSP11.target.setValue(row, "todoCfDt",""); // 확인일자
                    gridViewApprovalSP11.target.setValue(row, "todoCfOpn",""); // 확인의견
                    gridViewApprovalSP11.target.setValue(row, "telNo",data.resultList[0].telNo); // 핸드폰번호
                } else {
                    customAlert("중복 공유를 지정할 수 없습니다.");
                    return;
                }
            });
        });
    }

    function createHtmlCode1(workDept){
		//등록사유 자동생성 코드
        if (workDept == 'TRN30') workDept = 'TRN50';	//트루넷직접매출
        if (workDept == 'GUN70') workDept = 'GUN60';	//생산관리
        if (workDept == 'GUN90') workDept = 'TRN50';	//구매협력업체
        if (workDept == 'GUN50') workDept = 'TRN50';	//구매외주팀 (건양ITT)
        if (workDept == 'GUN95') workDept = 'TRN50';	//실적관리용 (건양ITT)
        if (workDept == 'GUN80') workDept = 'GUN40';	//전산실
     	createCheckBox(workDept);   //부서별 장애원인 자동 생성
    }

    //공유대상자 추가//
    function insertShareUserModal() {
        if (evlCloseChk == "Y") {
            customAlert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }

        if( approvalYn() ) {
            customAlert("결재가 이미 진행중입니다.");
            return;
        }

        var paramObj = {};
        var appshaList = gridViewApprovalSP11.target.list;
        paramObj["coCd"] = $(currFormId + ' #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $(currFormId + ' #ordrgId').val();
        paramObj["userNm"] =  $(currFormId + ' #ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
            return {
                gb: "결재",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
            return {
                gb: "공유",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        openThirdModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid) {
//             console.log('결재라인 : ', approvalGrid.target.list);
//             console.log('공유라인 : ', shareGrid.target.list);

            var appArray = approvalGrid.target.list.map(function(item) {
                return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });

            var shaArray = shareGrid.target.list.map(function(item) {
                return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });
            gridViewApprovalSP11.setData2(appArray.concat(shaArray));
        });
    }

    function deleteShareUser() {
        if (evlCloseChk == "Y") {
            customAlert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }

        if( approvalYn() ) {
            customAlert("결재가 이미 진행중입니다.");
            return;
        }

        var selRow = parseInt(gridViewApprovalSP11.target.selectedDataIndexs);
        if( isNaN(selRow) ) {
//             alert("선택된 행이 없습니다.");
            return;
        } else {
            if( selRow > -1 ) {
                gridViewApprovalSP11.target.removeRow(selRow);
            }
        }
    }

    //공유대상자 추가//
    function insertShareUserModal2() {
        if (evlCloseChk == "Y") {
            customAlert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }

        if( approvalYn2() ) {
            customAlert("결재가 이미 진행중입니다.");
            return;
        }

        var paramObj = {};
        var appshaList = gridViewPop2P11.target.list;
        paramObj["coCd"] = $(currFormId + ' #coCd').val();
        paramObj["useYn"] =  "Y";
        paramObj["userId"] =  $(currFormId + ' #ordrgId').val();
        paramObj["userNm"] =  $(currFormId + ' #ordrgNm').val();
        paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재"; }).map(function(item) {
            return {
                gb: "결재",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
            return {
                gb: "공유",
                id: item.usrNm,
                text: item.name,
                parent: item.jik,
                deptNm: item.dtNm,
                telNo: item.telNo,
                offTelNo: item.offTelNo,
                email: item.email
            };
        });
        openThirdModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid) {
//             console.log('결재라인 : ', approvalGrid.target.list);
//             console.log('공유라인 : ', shareGrid.target.list);

            var appArray = approvalGrid.target.list.map(function(item) {
                return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });

            var shaArray = shareGrid.target.list.map(function(item) {
                return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
            });
            gridViewPop2P11.setData2(appArray.concat(shaArray));
        });
    }

    function deleteShareUser2() {
        if (evlCloseChk == "Y") {
            customAlert("해당 SALES CODE 과제는 평가 완료 되었습니다.");
            return;
        }

        if( approvalYn2() ) {
            customAlert("결재가 이미 진행중입니다.");
            return;
        }

        var selRow = parseInt(gridViewPop2P11.target.selectedDataIndexs);
        if( isNaN(selRow) ) {
//             alert("선택된 행이 없습니다.");
            return;
        } else {
            if( selRow > -1 ) {
                gridViewPop2P11.target.removeRow(selRow);
            }
        }
    }

    function approvalYn() {
        var gridList = gridViewApprovalSP11.target.getList();
        var inCnt = 0;

        if( gridList.length > 0 ) {
            var msgArr = [];
            $.each(gridList, function (idx, elem) {
                //결재자가 본인이 아니면서 상태가 Y인 경우
                if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
            })
        }
        return inCnt;
    }

    function approvalYn2() {
        var gridList = gridViewPop2P11.target.getList();
        var inCnt = 0;
        if( gridList.length > 0 ) {
            var msgArr = [];
            $.each(gridList, function (idx, elem) {
                //결재자가 본인이 아니면서 상태가 Y인 경우
                if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
            })
        }
        return inCnt;
    }

    //요인별요청번호 검색
    function openPurchaseSearch() {
        if (act_approval_Yn == "Y") {
            return;
        }

        var paramObj = {
            "coCd"        : coCd,
            "searchValue" : salesCd,
            "orderFlag"   : "Y"
        }
        openThirdModal("/static/html/cmn/modal/purchaseSearch.html", 1200, 680, "요인별요청번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $(currFormId + ' #reqNo').val(row.reqNo);
        });
    }

    //입력정보
	function select_wb2401p01_Info() {
		if(modalStack.last().paramObj.issFileTrgtKey == '' || modalStack.last().paramObj.issFileTrgtKey == undefined) {
            return;
		} else {
            issFileTrgtKey = modalStack.last().paramObj.issFileTrgtKey;
		}

        var formData = {
            "fileTrgtKey" : issFileTrgtKey
        }
        postAjaxSync("/user/wb/wb24/select_wb2401p01_Info", formData, null, function(data) {

            //부서별 발주요청서 등록사유 자동 생성하기
            if (data.result) {
				let tempDeptId = data.result.actDeptId.slice(0,5);
				if (!tempDeptId) tempDeptId = data.result.creatDeptId.slice(0,5);
	            createHtmlCode1(tempDeptId);

				$.each(data.result, function(key, value) {
					if ($(currFormId + ' #' + key)[0]) {
						$(currFormId + ' #' + key).val(value);

						if ($(currFormId + ' #' + key).is('[comma]')) {
							onlyNumber($(currFormId + ' #' + key)[0]);
						}
					}
					if (key == 'subCd'){//등록사유체크하기
						$(currFormId + ' #'+value).prop("checked", true);
	  				}
					if (key == 'reqNo' && value != '' ){//발주요청서 생성시 완료처리는 발주요청서에서 입력하므로 진행상테 제어
	// 	            	$(currFormId + ' #issSts').addClass('no-click');
		            	$(currFormId + ' .reqMessageOn').removeClass('issHidden').addClass('issVisible');
		                $(currFormId + ' .reqMessageOff').removeClass('issVisible').addClass('issHidden');
	  				}

					if (key == 'fdmtSolutCd') {	// 근본원인 체크하기
						const codes = value.split(',');
						codes.forEach(code => {
							$(`input[name="FDMTSOLUT"][value="${code}"]`).prop('checked', true);
						});
					}

				});

				originMeasRst = data.result.measRst;	// 원인
				originActCnts =  data.result.actCnts;	// 결과

	            //결재카운트 기준 문제정보 입력 제어
	            if (data.result.appCnt == "0" || data.result.appCnt == undefined) {
	                approval_Yn = 'N';
	            } else {
	                approval_Yn = 'Y';
	                $(currDivId + ' #actionBtn').hide();
	            }

	            // 문제정보 입력제어
				if (data.result.subCd) { //등록사유가 없으면 입력금지 활성화 않음.
	            	iss_edit_chk(approval_Yn, '');
				} else {
	            	iss_edit_chk(approval_Yn, 'CHANGE');
				}

				//문제등록사유 코드의 끝 2자리가 99이면 기타 이며, 기타인경우 사유가 있음
				if (data.result.subCd && data.result.subCd.slice(-2) === '99') {
					$('#etcInputWrapper').show();
					$('#etcInput').val(data.result.etcInput).attr('required', true);
				} else {
					$('#etcInputWrapper').hide();
					$('#etcInput').val('').removeAttr('required');
				}
				
	            if (data.result.actAppCnt == "0" || data.result.appCnt == undefined) {
	                act_approval_Yn = 'N';
	            } else {
	                act_approval_Yn = 'Y';
	            }

	            // 조치정보 입력제어
	            act_edit_chk(act_approval_Yn);
//             // 문제 결재, 조치 결재가 있는 경우 수정버튼 안보이게
//             if (approval_Yn == "Y" && act_approval_Yn == "Y") {
//                 $(currDivId + ' #actionBtn').hide();
//             }

				//진행상태가 완료(ISSSTS03) 이면서 결재완료이면 수정버튼 숨김
	            if (act_approval_Yn == "Y" || $(currFormId + ' #issSts').val() == 'ISSSTS03') {
	            	iss_edit_chk('Y');
	                // act_edit_chk('Y');
	                $(currDivId + ' #actionBtn').hide();
// 	                $(currDivId + ' #actDngEvalTr').show();
	            }
	            //결재카운트 기준 문제정보 입력 제어 끝

				rowData = data.result; //발주요처 결과처리를 위한 임시저장
				
		        $(currFormId + ' .tit').text(data.result.salesCd + " " + data.result.wbsPlanCodeKindNm +"단계 WBS 실적 문제");
			  	  txtareaHeightResize($(currFormId + ' #issCnts'));  //문제현황 크기 조절하기
			  	  txtareaHeightResize($(currFormId + ' #actCnts'));  //조치내용 크기 조절하기
			  	  txtareaHeightResize($(currFormId + ' #measRst'));  //조치내용 크기 조절하기

            }
		});
		// ModalgridView.setData(0);
	}

    function iss_edit_chk(approval_Yn, addFlag='') {
        if (approval_Yn == "Y") {
            //유형 비활성화
			// $(currFormId + ' .issDiv').removeClass('hit');
			$(currFormId + ' #issDiv').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

            //상태 비활성화
// 			$(currFormId + ' #issSts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

			//제목 비활성화
			$(currFormId + ' #issSj').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//제목 비활성화
			$(currFormId + ' #vendCdNm').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

			//내용 비활성화
			$(currFormId + ' #issCnts').css({'background-color':'#e6e6e6'});
			//조치담당자
			$(currFormId + ' #actNm').prop('disabled', true);

			//등록사유 radio 비활성화
// 			$('input[name="CODECOBGB"]').attr('disabled', true);
// 			$('input[name="CODECOBGB"]').prop('disabled', true);

			if (addFlag != 'CHANGE') {
	            $(currFormId + 'input[name="CODECOBGB"]').addClass('no-click').each(function() {
	                $(this).on('click', function(e) {
	                    e.preventDefault();
	                });
	            });
			}

            $(currFormId + ' #btn_plus1').hide();
            $(currFormId + ' #btn_minus1').hide();
        }
    }

    function act_edit_chk(act_approval_Yn) {
        if (act_approval_Yn == "Y") {
            //상태 비활성화
			$(currFormId + ' #issSts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
            //시작일 비활성화
			$(currFormId + ' #actsDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
            //종료일 비활성화
			$(currFormId + ' #acteDt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//투입공수 비활성화
			$(currFormId + ' #actMh').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//투입비용 비활성화
			$(currFormId + ' #actAmt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			//지연일수 비활성화
			$(currFormId + ' #delayDay').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
            //조치내용 비활성화
			$(currFormId + ' #measRst').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$(currFormId + ' #actCnts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$(currFormId + ' #reqNo').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			// 근본원인 비화성화
			// $(currFormId + ' #fdmtSolutCd').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			$(currFormId + ' #FDMTSOLUT-radioButtonContainer').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
			// 내용입력 비활성화
			$(currFormId + ' #fdmtSolutCnt').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 			$(currFormId + ' #actDng').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 			$(currFormId + ' #actAmtSts').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
// 			$(currFormId + ' #actDngEval').css({'background-color':'#e6e6e6', 'pointer-events':'none'});

			$(currFormId + ' #reqNo').prop('disabled', true);

            $(currFormId + ' #btn_plus2').hide();
            $(currFormId + ' #btn_minus2').hide();
        }
    }

    //KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
    function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
        let param = {
            "tmplatDiv": "TMPLATDIV02"
            , "coCd": $(currFormId + ' #coCd').val()             //해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": todoDiv1CodeId //"TODODIV10"                 //공통코드 해당업무 - 결재
            , "todoDiv2CodeId": todoDiv2CodeId // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv1CodeNm": todoDiv1CodeNm // "WBS문제"                        //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv2CodeNm": todoDiv2CodeNm // "WBS계획문제"                       //공통코드 해당업무 - 결재 - 발주서
            , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $(currFormId + ' #issNo').val()
            , "clntCd": "1"                 //발신회사는 로그인사용자 회사
            , "clntNm": $(currFormId + ' #clntNm').val()              //로그의 수신거래처명
            , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
            , "ordrgMngTelNo": $(currFormId + ' #telNo').val()       //담당자전화번호
            , "creatPgm": "WB2401P11"
        }
        commKaKaoSendTodo(param);
    }

    function kakaoTodo() {

        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	            "userId" : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });
        }

        let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

        // 1. 문제 공유, 결재 프로세스 진행상태(ISSSTS03 != 완료가 아닌경우)인 경우에 조치정보 공유 및 결재자 알림 처리
        if ($(currFormId + ' #issSts').val() != 'ISSSTS03') {
	        var rowList = gridViewApprovalSP11.target.getList();
	        var sharChk = 0;
	        var appChk = 0;

	        $.each(rowList, function(idx, elem) {
	            if (elem.gb == "공유") {
	                sharChk++;
	            }
	            else if (elem.gb == "결재") {
	                appChk++;
	            }
	        });

	        // 1-1. WBS 계획 문제 공유 알림톡 처리
	        if (sharChk > 0) {
	            kakaoSendBody('TODODIV10','TODODIV1030', 'WBS문제','WBS실적문제','공유');
	        }

	        // 1-2. WBS 계획 문제 결재 알림톡 처리
	        if (appChk > 0) {
	            kakaoSendBody('TODODIV20','TODODIV2060', 'WBS문제','WBS실적문제','결재');
	        }
        }


        // 조치 공유, 결재 프로세스 진행상태(ISSSTS03 = 완료)인 경우에 조치정보 공유 및 결재자 알림 처리
        if ($(currFormId + ' #issSts').val() == 'ISSSTS03') {
            var rowList2 = gridViewPop2P11.target.getList();
            var sharChk2 = 0;
            var appChk2 = 0;

            $.each(rowList2, function(idx, elem) {
                if (elem.gb == "공유") {
                    sharChk2++;
                }
                else if (elem.gb == "결재") {
                    appChk2++;
                }
            });

        	// 2-1. WBS 계획 조치 공유 알림톡 처리
	        if (sharChk2 > 0) {
	            kakaoSendBody('TODODIV10','TODODIV1090', 'WBS조치','WBS실적조치','공유');
	        }

	        // 2-2. WBS 계획 조치 결재 알림톡 처리
	        if (appChk2 > 0) {
	            kakaoSendBody('TODODIV20','TODODIV2090', 'WBS조치','WBS실적조치','결재');
	        }
        }

        if (kakaoCnt > 0) {
            kakaoCnt = 0;
            // alert("알림톡이 정상 발송되었습니다.");
        }
    }

    //to-do결재요청 알림톡
    function commKaKaoSendTodo(param) {
//         console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

        //알림톡수신번호 채번
        var maxMessageId = null;            //message id(unique key)
        var talkMessage = null              //발송될 내용 template
        var mobile = null                   //수신인 휴대전화번호
        var title = null                    //todo title
        var sendList = [];
        let talkParam = {};
        let talkBody = {};
        let sendCnt = 0;
        // postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null , function(data) {
        postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo_kakao", param, null , function(data) {
            if(data.resultList.length > 0 ) {
                if( data.resultList[0].maxMessageId != "" ) {
                    sendList = data.resultList;
                } else {
                    customAlert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                    return;
                }
            }
        });
        //user search ajax end

        //대상 loop
        $.each(sendList, function (key, sendObj) {
            maxMessageId = sendObj.maxMessageId;
            talkMessage = sendObj.messageDesc;
            mobile =  sendObj.telNo;

			if (kakaoDiff) {
				// 변경내용 추가
				let insertLines = "";
				if (kakaoDiff.cause)  insertLines += `원인 : ${kakaoDiff.cause}\n`;
				if (kakaoDiff.result) insertLines += `결과 : ${kakaoDiff.result}\n`;

				// 변경된 게 있으면 “요청업무” 바로 아래에 삽입
				if (insertLines) {
					talkMessage = talkMessage.replace(
					/(요청업무\s*:[^\r\n]*)(\r?\n)/,
					`$1$2${insertLines}`
					);
				}
			}

            //로그용
            param.rcvId = sendObj.todoId; //todo 수신id
            param.rcvNm = sendObj.name;   //todo 수신자명
            param.nameTo = sendObj.name;  //todo 수신자명

            // 알림톡 Title 자리수 제한 문자열 자르기
            title = (sendObj.todoTitl.length > 30) ? title = sendObj.todoTitl.substring(0,29) : sendObj.todoTitl;

            param.title = title;                                //요청내용제목
            param.sendDt = sendObj.sendDt;

            if(mobile == "" || mobile == null) {
                customAlert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
                return;
            }

            if(talkMessage == "" || talkMessage == null) {
                customAlert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
                return;
            }

            //message 치환
            let message = talkMessage;
            let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);

            //loop
            $.each(splitStr, function (key, val) {
                let compKey = val.substring(1, val.length-1);
                if( compKey != "" && compKey != "undefined" ) {
                    if( typeof(param[compKey]) != "undefined" ) {
                        let val2 = '#'+val;
                        message = message.replaceAll(val2, param[compKey]);
                    }
                }
            });

            talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
            talkParam.serverName = "gyitt2400";
            talkParam.paymentType = "P";
            talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
            talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값);
    		if (title.length > 50) {
    			title = title.substring(0, 49); // 50자까지만 자르기
    		}
            talkBody.title = title;                 //알림톡 타이틀 -
            talkBody.message = message;             //알림톡 메시지 (1000 byte)
            talkBody.mobile = mobile;               //휴대전화번호
            talkBody.template = "10003";            //템플릿관리화면 템플릿ID - 발주서 V2
            let talkJson = JSON.stringify(talkBody);
            sendCnt = kakaoSendReal(talkJson, talkParam, param);
        });

        //대상 loop end
        if( sendCnt > 0 ) {
            //alert("알림톡 정상 발송되었습니다.");
            kakaoCnt++;
        }

    }


	function txtareaHeightResize(obj) {
		let rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 3) {
			obj.css('height', "60px");
		} else {
			if (rowCount > 24)  rowCount = 23;
			obj.css('height', (rowCount * 21) + "px");
		}
	}

	function txtareaHeightResize2(obj) {
		let rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 5)
			obj.css('height', "95px");
		else
			obj.css('height', (rowCount * 21) + "px");
	}


    //조치담당자 팀장 정보 가져오기
	function selectTeamManagerApprovalAdd() {
    	//------------------------------------------------
    	//문제등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
    	//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
    	//------------------------------------------------
    	let appshaList = [];
		if ($(currFormId + ' #issSts').val() != 'ISSSTS03') { //문제생성시 조치자 팀장
			//문제생성시 등록담당자의 팀장 정보 가져오기 gridViewApprovalSP11
	        appshaList = gridViewApprovalSP11.target.getList();
    	} else {
			//처리결과 등록 결재자 정보 가져오기 gridViewPop2P11
	        appshaList = gridViewPop2P11.target.getList();
    	}

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		let tempActId = $(currFormId + ' #actId').val();		//조치 담당자 ID
		let tempCreatId = $(currFormId + ' #creatId').val();	//문제 등록담당 ID

        $.each(appshaList, function(idx, item){
        	if (item.usrNm.includes('gyrsult') || item.usrNm == tempCreatId) {
        		//퇴사자인경우 제외 처리함
        		//작성자는 결제 제외처리
        	} else {
	            if (item.gb === "결재") {
	            	appArray.push(item);
	            } else {
	            	//공유일경우 조치담당자가 공유에 있으면 제외처리함.
	            	if (item.usrNm != tempActId) {
	            		shaArray.push(item);
	            	}
	            }
        	}
        });
		//------------------------------------------------
		//문제등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------

		//조치결과자 결재정보 추가
		if ($(currFormId + ' #issSts').val() != 'ISSSTS03') {  //결과처리인지? 확인
			appArray = approvalUserInfoData(tempActId, appArray);
		}
		//조치자, 등록자 팀장 결재추가하기
		appArray = approvalTeamManagerInfoData(tempActId, appArray);
		appArray = approvalTeamManagerInfoData(jwt.userId, appArray);

		// 실적 문제 등록 시 영업 및 연구소가 등록 시 해당 특정 유저 결재권자 자동 추가
		if (jwt.deptId.slice(0, 5) == 'GUN30') {
			appArray = approvalTeamManagerSpecialInfoData('EMJ8105', appArray);		// 영업이 등록 시 김태호 부사장님 추가
		} else if (jwt.deptId.slice(0, 5) == 'GUN40') {
			appArray = approvalTeamManagerSpecialInfoData('kimjhv', appArray);		// 연구소가 등록 시 김재현 전무님 추가
		}

		//문제생성시 조치자 팀장추가 정보 refresh
		if ($(currFormId + ' #issSts').val() != 'ISSSTS03') {
			gridViewApprovalSP11.setData2(appArray.concat(shaArray));
		} else {
        	gridViewPop2P11.setData2(appArray.concat(shaArray));
		}
	}

    //조치담당자정보 자동 추가하기
	function approvalUserInfoData (appUserId, appArray) {
	    var formData = {
	        "userId" : appUserId,
	    }
	    postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
	    	if (data.resultList != '' && data.resultList!=null) {
	    		//조치결과 결자자 정보 가져오기
	    		let list = data.resultList[0];
	    		if (appArray.some(item => item.usrNm === list.usrNm)) {
	    			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
	    		} else {
	    			appArray.push({
		                        gb: "결재",
		                        usrNm: list.usrNm,
		                        name: list.name,
		                        jik: list.jik,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,
		                    });
	    		}
	    	}
		});
		return appArray;
	}

	//특정담당자 정보 가져오기
	function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

    //담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
	    var formData = {
		        "userId" : appUserId,
		}
        postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
        	if (data.result != '' && data.result!=null) {
        		//결자자 정보 가져오기
        		let list = data.result;
        		if (appArray.some(item => item.usrNm === list.id)) {
        			//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
        		} else {
        			appArray.push({
		                        gb: "결재",
		                        usrNm: list.id,
		                        name: list.name,
		                        jik: list.levelNm,
		                        dtNm: list.deptNm,
		                        telNo: list.telNo,
		                        offTelNo: list.offTelNo,
		                        email: list.email,

		                    });
        		}
        	}
		});
		return appArray;
	}

    function gridResize1() {
        let grdiHeight = $(currFormId + ' #COBGB-checkboxContainer-P11').height()-35;

    	let size = gridViewApprovalSP11.target.list.length
        let tagHeight = (size) * 28 + 61 ;
        if (grdiHeight > tagHeight) tagHeight=grdiHeight-80;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 100 ? 100 : tagHeight;
        gridViewApprovalSP11.target.setHeight(tagHeight);
    }
    function gridResize2() {
    	let size = gridViewPop2P11.target.list.length;
        let tagHeight = (size) * 28 + 50 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 100 ? 100 : tagHeight;
        gridViewPop2P11.target.setHeight(tagHeight);
    }


	// 거래처 검색
	function openClntSearch() {
		var paramObj = {
				"searchValue" :  $(currFormId + ' #vendCdNm').val(),
				"clntDivCd"   : ""
		}
		openThirdModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$(currFormId + ' #vendCd').val(row.clntCd);
			$(currFormId + ' #vendCdNm').val(row.clntNm);

            if ($(currDivId + ' #actionBtn').is(':hidden') && jwt.deptId == "TRN30" || jwt.deptId == "TRN50" || jwt.deptId == "TRN5010" || jwt.deptId == "TRN5020" || jwt.deptId == "GUN80") {
                $(currFormId + ' #updateVendCdBtn').show();
            }
		});
	}

	function openResultPopup() {
		// REQST 접수상태 - REQST01 : 접수, REQST02:진행, REQST03:완료
		// const reqSt = rowData.reqSt;
		const resltSubCd = rowData.resltSubCd;

		// if(reqSt == "REQST02" || reqSt == "REQST03"){  //접수 상태(결제후 진행상태,결과 결제후 완료상태)에서만 등록,수정
		modalStack.close();	//문제 모달 popup닫기
		let paramObj = {
				"fileTrgtKey" 	: rowData.reqFileTrgtKey,
				"coCd" 	   		: rowData.coCd,
				"userId"   		: jwt.userId,
				"userName" 		: jwt.userNm,
				"empNo"    		: jwt.empNo,
				"deptId"   		: jwt.deptId,
				"levelCd"  		: jwt.levelCd,
				"issNo"    		: rowData.issNo,
				"rsltYn"   		: rowData.rsltYn,   //결과등록여부
				"reqSt"    		: rowData.reqSt,    //todo진행상태
				"reqNo"    		: rowData.reqNo,     //관리번호, 요청번호
				"midCd"    		: rowData.reqMidCd,
				"rsltNo"   		: rowData.rsltNo,   //실적결과번호
				"rsltSubCd" 	: rowData.resltSubCd, //결과테이블 소분류 코드
		}
		if (resltSubCd == "" || resltSubCd == undefined ){//결과 등록할떄 체크
				paramObj.actionType  = "C";
		} else if (resltSubCd != "" ){//결과 수정할떄 체크
			paramObj.actionType  = "U";
		}
		if (rowData.sameTimeResult == "Y") {
			openFourthModal("/static/html/user/qm/qm01/QM0101P01.html", 1600, 870, "", paramObj, function(data) {
				//gridView.setData(0);           
			});
		} else {
			openFourthModal("/static/html/user/qm/qm01/QM0101P03.html", 1600, 870, "", paramObj, function(data) {
				//gridView.setData(0);           
			});
		}
		// }else if(reqSt == "REQST01"){
		// 	alert("결재 승인후 결과 등록할 수 있습니다.");
		// }
	}

	function createQualityReqModal() {
		if ($('#issNo').val() == '신규등록') {
			customAlert('문제신규등록 완료 후 발주요청서 작성이 가능합니다.')			
			return false;
		}
		modalStack.close();	//문제 모달 popup닫기
		//발주요청서 신규 생성업무 시작
		var paramObj = JSON.parse(JSON.stringify(rowData));
		paramObj.fromJobType = "ISS";	//발주요청서 자체 실행은 "REQ", 문제에서 전달하는것은 "ISS"
		paramObj.actionType  = "C";	//발주요청서 신규 생성
		paramObj.workRptNo  = rowData.issNo;	//이슈등록번호
		paramObj.issueTitle  = rowData.issSj;
		paramObj.workRptRmk  = rowData.issCnts;
		paramObj.actIdNm  = rowData.actNm;
		
		paramObj.callRoute  = "대시보드문제현황에서실행하면이슈번호링크제거하기";
		openFourthModal("/static/html/user/qm/qm01/QM0101P01.html", 1600, 870, "요인별 발주 및 출장요청서 작성", paramObj, function (){
			if (typeof salesGridView !== "undefined") salesGridView.setData(0);
			if (typeof issueGridView !== "undefined") issueGridView.setData(0);
		});
	}
	
    // 발생공급업체 Update
    function updateVendCd() {
        // 직접매출(TRN30), 팀장(TRN50), 기계/구매(TRN5010), 전기/제어(TRN5020), 전산실(GUN80)/관리용
        if (jwt.deptId !== "TRN30" && jwt.deptId !== "TRN50" && jwt.deptId !== "TRN5010" && jwt.deptId !== "TRN5020" && jwt.deptId !== "GUN80") {
            return;
        }

        var paramObj =  {
            "issNo"  : $('#issNo').val(),
            "vendCd" : $('#vendCd').val()
        }
            putAjax("/user/wb/wb24/updateVendCd", paramObj, null, function(data) {
                if (data.resultCode == 200) {
                    customAlert("저장되었습니다.");
                    modalStack.close();
                }
            });
    }

	function update_issue_pm50_d01(issuNo) {
		// 출장자 사진 업로드 프로그램에서 넘어온 경우 일때만 update 처리
		if (selectedPm50List) {
			paramObj = {
				"pm50Info" 	: selectedPm50List,
				"issuNo"	: issuNo,
				"userId"	: jwt.userId,
				"pgmId"		: $("#pgmId").val()
			}
			postAjax("/user/pm/pm50/update_issue_pm50_d01", paramObj, null, function(data) { 
				gridView.setData(0);
			})
		} else {
			return false;
		}
	}
</script>
