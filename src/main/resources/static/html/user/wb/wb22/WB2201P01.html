<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">WBS 계획 관리</h4>
    </div>
    <div class="popup_table">
        <div class="form-group">
            <form id="popForm">
		         <input type="hidden" id="coCd"   name="coCd">
		         <input type="hidden" id="userId" name="userId">
		         <input type="hidden" id="pgmId"  name="pgmId" value="WB2201P01">
		         
		         <table class="popup_table">
		             <colgroup>
		                  <col width="19%">
		                  <col width="20%">
		                  <col width="20%">
		                  <col width="20%">
		                  <col width="18%">
		                  <col width="17%">
		                  <col width="18%">
		                  <col width="20%">
		                  <col width="18%">
		             </colgroup>
		             
		             <thead>
		                 <tr>
		                    <td colspan="9" style="height:30px;text-align: left;">▣ 과제정보</td>                                                
		                 </tr>
		             </thead>
		                <tr style="text-align: left;" rowspan="2">
		                     <th>과제기본정보</th>                            
		                     <th>과제번호</th>
		                     <td> 
		                        <input type="text" id="sjNo" name="sjNo" readonly >
		                     </td>
		                     <th>과제명</th>
		                     <td colspan="3"> 
		                        <input type="text" id="sjNm" name="sjNm" readonly>
		                     </td>                               
		                     <th>Ver.</th>
		                     <td>   
		                        <input type="text" id="verNo" name="verNo" readonly>
		                     </td>
		
		                 </tr>
		                  <tr style="text-align: left;" rowspan="2">
		                     <th>고객기본정보</th> 
		                     <th>고객사</th>
                             <td> 
                                <input type="hidden" id="clntCd" name="clntCd" >
                                <input type="text" id="clntNm" name="clntNm" readonly >
                             </td>                           
		                     <th >SALES CODE</th>
		                     <td> 
		                        <div class="search_form">
		                         <input type="text" id="salesCd" name="salesCd" required readonly msg="salesCd">
		                     </div>
		                     </td>		                     
		                     <th>제품</th>
		                     <td>
		                         <input type="hidden" id="prdtCd" name="prdtCd" >
		                         <input type="text" id="prdtNm" name="prdtNm" readonly >
		                     </td>
		                     <th>차종</th>
		                     <td>   
		                        <input type="hidden" id="clntPjt" name="clntPjt">
		                        <input type="text" id="clntPjtNm" name="clntPjtNm" readonly >
		                     </td>
		                 </tr>
		                 <tr  style="text-align: left;">
		                     <th>실행정보</th>                            
		                     <th>제작처 구분</th>
		                     <td>
		                         <input type="hidden" id="mkerDiv" name="mkerDiv">
		                         <input type="text" id="mkerDivNm" name="mkerDivNm" readonly>
		                     </td>
		                     <th>제작업체</th>
		                     <td> 
		                        <input type="hidden" id="mkerCd" name="mkerCd">
		                         <div class="search_form" style="width: 100%;">
		                             <input type="text" id="mkerNm" name="mkerNm" readonly> 
		                         </div>
		                     </td>
		                     <th>
		                                                              총괄PM
		                     </th>
		                     <td>
		                     <div class="search_form">
		                     <input type="hidden" id="smrizeId" name="smrizeId" msg="총괄PM" >
		                     <input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly>
		                     </div>    
		                     </td>
		                     <th style="color: blue;">
		                                                              확정
		                     </th>                                
		                     <td>
		                     	<input type="hidden" id="closeYn" name="closeYn" style="color: blue;" readonly><div id="close"></div>
		                     </td>
		                 </tr>
		                 <tr style="text-align: left;">
		                     <th>납기정보</th>                            
		                     <th>시작일</th>
		                     <td>        
		                     <input id="beginDt" name="beginDt" readonly>                            
		                     </td>
		                     <th>출고일</th>
		                     <td>                   
		                     <input id="deDt" name="deDt" readonly>                 
		                     </td>
		                     <th>완료검수일</th>
		                     <td>                   
		                     <input id="acptncDt" name="acptncDt" readonly>                    
		                     </td>
		                     <th>소요일수</th>
		                     <td>                   
		                     <input id="reqreDaycnt" name="reqreDaycnt" readonly >                    
		                     </td>
		                 </tr>
		               <thead>
		                 <tr>
		                    <td colspan="9" style="height:30px;text-align: left;">▣ 계획정보
		                     <div id="addrow1" class="add_btn_small pdl10">
                            <a id="btn1" onclick="wbsLevel1Insert();" data-grid-control="row-add1" style="width:60px;height: 30px; line-height: 28px;">저장</a>
<!--                             <a id="btn2" onclick="wbsLevel1confirm('N');" data-grid-control="row-add2" style="width:60px;height: 30px; line-height: 28px;">미확정</a> -->
                            <a id="btn3" onclick="wbsLevel1confirm('Y');" data-grid-control="row-add3" style="width:60px;height: 30px; line-height: 28px;">확정</a>
                            <a id="btn4" onclick="createVerUp();" data-grid-control="row-add3" style="width:60px;height: 30px; line-height: 28px;">Ver. Up</a>                            
                           </div>
		                    </td>                                                
		                 </tr>
		               </thead>
		                 <tr style="text-align: left;">
		                     <th>계획기본정보</th>
		                     <th>Ver.</th>
		                     <td>   
		                        <input type="text" id="wbsPlanVerNo" name="wbsPlanVerNo" readonly>
		                     </td>
		                     <th style="color: blue;">
		                                                              확정
		                     </th>                                
		                     <td>
		                     	<input type="hidden" id="wbsPlanCloseYn" name="wbsPlanCloseYn" style="color: blue;" readonly><div id="wbsPlanClose"></div>
		                     </td>
		                 </tr>
		                 <tr>
		                    <td colspan="9">
		                    <div class="ax5_grid" data-ax5grid="popup-grid1" data-ax5grid-config="{}" style="height: 420px; width: 100%" ></div> 
		                    </td>                                                
		                 </tr>
		                 <thead>
		                 <tr>
		                    <td colspan="9" style="height:30px;text-align: left;">▣ TASK
		                    <div id="addrow2" class="add_btn_small pdl10">
                            <a id="btn5" onclick="" data-grid-control="row-add" style="height: 30px; line-height: 28px;">+</a>
                            <a id="btn6" onclick="" data-grid-control="row-remove" style="height: 30px; line-height: 28px;">-</a>
                            <a id="btn7" onclick="wbsLevel2Insert();" data-grid-control="row-add4" style="width:60px;height: 30px; line-height: 28px;"  >저장</a>
                            <!-- <a id="btn8" onclick="wbsLevel2confirm('N');" data-grid-control="row-add5" style="width:60px;height: 30px; line-height: 28px;" >미확정</a>
                            <a id="btn9" onclick="wbsLevel2confirm('Y');" data-grid-control="row-add6" style="width:60px;height: 30px; line-height: 28px;" >확정</a>    -->
                            <a id="btn10" onclick="wbsRsltsInsertModal();" data-grid-control="row-add7" style="width:60px;height: 30px; line-height: 28px;" >실적등록</a>
                            <a id="btn11" onclick="wbsRsltsconfirm('Y');" data-grid-control="row-add8" style="width:60px;height: 30px; line-height: 28px;" >실적확정</a> 
                            <a id="btn12" onclick="wbsRsltsconfirm('N');" data-grid-control="row-add8" style="width:80px;height: 30px; line-height: 28px;" >확정취소</a>
                            <a id="btn13" onclick="wbsPlanIssuePopUp();" data-grid-control="row-add3" style="width:90px;height: 30px; line-height: 28px;">계획 이슈등록</a>
                            <a id="btn14" onclick="wbsRsltsIssuePopUp();" style="width:95px; height: 30px; line-height: 28px;">실적 이슈등록</a>                                                         
                           </div>
		                    </td>                                                
		                 </tr>
		               </thead>
	                   <tr>
	                     <td colspan="9">
	                     	<div class="ax5_grid" data-ax5grid="popup-grid2" data-ax5grid-config="{}" style="height: 200px; width: 100%" ></div> 
	                     </td>                                                
	                   </tr>
		         </table>                    
		       </form>                 
        </div>
    </div>

    <div class ="popup_bottom_btn">
        <button type="button" class="close_btn"
            onclick="modalStack.close();">닫기</button>
    </div>
 </div>
    
<script type="text/javascript">
 var isFirst = true;
 var coCd = null;
 var salesCd = null;
 var wbsPlanCodeKind = null;
 var deleteRowArr = [];
 var addRowArr = [];
 
 ax5.ui.grid.formatter["chkYn"] = function () {
     var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
     if (this.value == "E"){
         return ' ';
     } else {
         return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
     }
 };
 
 
 var wbsPlanStsCodeId = [];
 var paramObj = {codeKind : "WBSPLANSTS"};
 postAjaxSync("/user/wb/wb21/selectCodeList", paramObj, null, function(data){
     wbsPlanStsCodeId = data.resultList; 
 });
 
 var gridView1 = {
            initView: function(){
                this.target = new ax5.ui.grid();
                this.target.setConfig({
                    showRowSelector: false,
                    multipleSelect: false,
                    sortable: false,
                    target: $('[data-ax5grid="popup-grid1"]'),
                    header: {
                      align: "center",
                      selector: false
                    },
                    page : {
                         navigationItemCount : 10,
                         height : 0,
                         use : false,
                     },
                    body: {
                        onClick: function () {                        	
                            this.self.select(this.dindex);
                            var idx = this.dindex;                            
                            wbsPlanCodeKind = this.item.wbsPlanCodeId; 
                            if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
                                alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
                                return;
                            }
                            gridView2.setData(0);
                            /*
                            // Validation 체크 총괄PM이 아니면 자기담당인TASK만 조회가능
			                var smrizeId = $('#smrizeId').val();
			                var row = gridView1.target.getList("selected")[0];
                            
                            // 1. 총괄 PM인 경우 조회만 됨
                            if(smrizeId == jwt.userId){
                            	gridView2.setData(0);
                            }else if(row != undefined && row.wbsPlanMngId == jwt.userId){
                            // 2. 자신이 담당자인 TASK 조회
                            	gridView2.setData(0);
                            }
			                */
                            if (this.item.closeYn == "Y") {
                                //alert("확정된 상태입니다.");
                                return;
                            }
                            ////////////////////////////////////////////
                            
                            
                        },
                        onDBLClick: function () {
                        	var idx = this.dindex;
                        	// Validation 체크                             
                        	if (this.item.closeYn == "Y") {
                                //alert("확정된 상태입니다.");
                                return;
                            }
                        	/////////////////
                        	
                        	if (this.column.key=='wbsPlanMngNm') {
                                var paramObj = {
                                        "coCd" : coCd,
                                        "userId": '',
                                        "useYn": "Y"
                                };
                                openThirdModal("/static/html/cmn/modal/userSearch.html", 300, 500, "담당자 검색", paramObj, function (tree){
                                    var checkedId = tree.get_checked()[0];
                                    var checkedNode = tree.get_node(checkedId);
                                    gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
                                    gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngNm : checkedNode.text}), idx);                                   
                                });
                            }
                        	
                        	
                        },
                        onDataChanged: function () {
                        	// Validation 체크   
                        	if (this.item.closeYn == "Y") {
                                //alert("확정된 상태입니다.");
                                return;
                            }
                             const fDate = new Date(this.item.wbsPlansDt);
                             const tDate = new Date(this.item.wbsPlaneDt);
                             
                             //시작일
                             const beginDt = new Date($('#beginDt').val());
                             //완료검수일
                             const acptncDt = new Date($('#acptncDt').val());
                             
                             //1. 시작일자가 시작일 이전이면 안됨
                             if(fDate < beginDt){
                            	 alert("시작일자는 시작일 이전 일 수 없습니다.");
                            	 this.self.setValue(this.dindex, "wbsPlansDt", $('#beginDt').val());
                            	 return false;
                             }
                             
                             //2. 종료일자가 완료검수일 이후면 안됨
                             if(tDate > acptncDt){
                            	 alert("종료일자는 완료검수일 이후 일 수 없습니다.");
                            	 this.self.setValue(this.dindex, "wbsPlaneDt", $('#acptncDt').val());
                            	 return false;
                             }
                             
                             //3. 시작일자는 종료일자 이후일 수 없다.
                             if(fDate > tDate) {
                            	 alert("시작일자는 종료일자 이후 일 수 없습니다.");
                            	 this.self.setValue(this.dindex, "wbsPlansDt", $('#beginDt').val());
                            	 this.self.setValue(this.dindex, "wbsPlaneDt", $('#acptncDt').val());
                            	 return false;
                             }
                             
                           	 this.self.setValue(this.dindex, "daycnt", calculateHolidayCnt(this.item.wbsPlansDt, this.item.wbsPlaneDt).workingDays);
                           	 
                           	
                        },
                   },
                   columns: [
                         {key: "rn",            label: "No.",              align: "center",   width: 40},
                         {key: "fileTrgtKey",   label: "FILE TRGT KEY",    hidden:true},
                         {key: "coCd",          label: "회사",    hidden:true},  
                         {key: "salesCd",       label: "SALES CODE",    hidden:true},                            
                         {key: "wbsPlanNo",     label: "계획번호",   hidden:true},
                         {key: "wbsPlanCodeId", label: "계획코드",    hidden:true},
                         {key: "wbsPlanCodeNm", label: "계획명",    align: "left",   width: 260},
                         {key: "verNo",         label: "Ver.",    align: "center",   width: 100,      hidden: true},
                         {key: "wbsPlanMngId",  label: "담당자",    hidden:true},
                         {key: "wbsPlanMngNm",  label: "<span style='color: red;'>*</span>담당자명",    align: "center",   width: 140},
                         {key: "wbsPlansDt",    label: "<span style='color: red;'>*</span>시작일자",      align: "center",   width: 180, 
                             editor: {type: "date"
                                         , config: {
                                                 content: {
                                                              config: { mode: "day", selectMode: "day" }
                                                          }
                                                    },                                                    
                                         disabled: function () {
                                             if (this.item.closeYn == "Y") {
                                                 //alert("확정된 상태입니다.");
                                                 return true;
                                             }                                            
                                         },
                             },
                         },
                         {key: "wbsPlaneDt",    label: "<span style='color: red;'>*</span>종료일자",      align: "center",   width: 180,
                             editor: {type: "date"
                                 , config: {
                                         content: {
                                                      config: { mode: "day", selectMode: "day" },                                                      
                                                  }
                                            },
                                   disabled: function () {
                                	   // Validation 체크   
                                       if (this.item.closeYn == "Y") {
                                           //alert("확정된 상태입니다.");
                                           return true;
                                       }else{
                                    	   return false;
                                       }
                                	   /////////////////
                                       //return false;
                                   },
                                   
                             }
                             
                         },
                         {key: "daycnt",  label: "소요일수",    align: "center",   width: 140},
                         /* {key: "wbsPlanStsCodeId",  label: "계획상태", align: "center",   width: 130, editor: {type: "select",
                             config: {
                                 columnKeys: {optionValue: 'cd',optionText: 'nm'},
                                 options: wbsPlanStsCodeId
                             },
                             disabled: function () {
                            	// Validation 체크   
                                 if (this.item.closeYn == "Y") {
                                     //alert("확정된 상태입니다.");
                                     return true;
                                 }
                            	/////////////////
                                 //return false;
                             },                                                      
                         }
                          , formatter: function () { 
                             var result_text = "";
                             var itemValue = this.item.wbsPlanStsCodeId;
                             $.each(wbsPlanStsCodeId, function (idx, elem) {
                                 if(itemValue == elem.cd)
                                 {
                                     result_text = elem.nm;
                                 }
                             });
                             return result_text;
                         } }, */
                         {key: "wbsPlanStsCodeIdNm",      hidden: true},
                         {key: "closeYn",      label: "확정",   width: 80, align: "center" , formatter: "chkYn",      hidden: true},
                         {key: "creatId",      label: "생성자",      hidden: true},
                         {key: "creatNm",      label: "생성자명",      hidden: true},
                         {key: "creatDttm",      label: "생성일시",      hidden: true},                   
                         {key: "udtId",      label: "최종변경자",      hidden: true},
                         {key: "udtNm",      label: "최종변경자명",      hidden: true},
                         {key: "udtDttm",      label: "최종변경일자",     hidden: true}
                         ]
                });

                return this;
              },
              
              setData: function() {
                  var targetObj = this.target;
                  var formData = {
                          "coCd" : coCd,
                          "salesCd" : salesCd,
                          "beginDt" : $('#beginDt').val(),
                          "acptncDt" : $('#acptncDt').val()
                  }
                  
                  postAjax("/user/wb/wb22/selectWBS1Level", formData, null, function(data){
                      var list = data.fileList;
                      var i = 0;
                      if (list != undefined) {
                    	  $.each(list, function(idx, obj){
                    		  list[i].daycnt = calculateHolidayCnt(obj.wbsPlansDt, obj.wbsPlaneDt).workingDays;
                    		  if(i == 0){
                    			  console.log(list[i]);
                    			  var ver = list[i].verNo;
                                  $("#popForm #wbsPlanVerNo").val(ver);
                                  
                                  var val2 = list[i].closeYn;
                                  $("#popForm #wbsPlancloseYn").val(val2);
                            	  var color2 = val2 == "Y" ? "color-circle_02.png" : "color-circle_01.png";
                                  var html2 = '<img src="/static/img/'+color2+'" align="center" style="width: 10px;height: 10px;"></img>';
                                  $("#popForm #wbsPlanClose").html(html2);
                    		  }
                    		  i++;
                          });
                    	  
                    	  targetObj.setData({
                               list : list,
                                page : {
                                  // totalElements : list.length
                               } 
                          });
                           
                          // debugger;
                          gridView1.target.select(0, {selected: true});
                          var row = gridView1.target.getList("selected")[0];
                          if (row != undefined && row.wbsPlanMngId == jwt.userId) {
                        	  wbsPlanCodeKind = row.wbsPlanCodeId;
                        	  gridView2.setData(0);
                          }
                  	  }
                      
                  });
                  /*
                  // Validation 체크 총괄PM이 아니면 자기담당인TASK만 조회가능
                  var smrizeId = $('#smrizeId').val();
                  
                  // 1. 총괄 PM인 경우만 수정
                  if(smrizeId == jwt.userId){
                	  $("#popForm #addrow1").show();
                  }else{
                	  $("#popForm #addrow1").hide();
                  }
                  
                  // 조회 후 동작 자기담당인TASK만 수정 가능
                  var row = gridView1.target.getList("selected")[0];
                  if(row != undefined && row.wbsPlanMngId != jwt.userId){
                	  $("#popForm #addrow2").show();
                  }else{
                	  $("#popForm #addrow2").hide();
                  }
	              */
             } 
         }


 var gridView2 = {
         initView: function(){
             this.target = new ax5.ui.grid();
             this.target.setConfig({
                 showRowSelector: false,
                 multipleSelect: false,
                 sortable: false,
                 target: $('[data-ax5grid="popup-grid2"]'),
                 header: {
                   align: "center",
                   selector: false
                 },
                 page : {
                      navigationItemCount : 10,
                      height : 30,
                      use : false,
                  },
                 body: {
                     mergeCells : ["salesCd"],
                     onClick: function () {
                    	 //debugger;
                         this.self.select(this.dindex);
                         var idx = this.dindex;
                         
                         // Validation 체크  
                         if (this.item.rsltsCloseYn == "Y" ) {
                             //alert("확정된 상태입니다.");
                             return;
                         }
                         
                         
                         /////////////////
                         
                         if (this.column.key=='wbsPlanMngNm') {
                             var paramObj = {
                                     "coCd" : coCd,
                                     "userId": '',
                                     "useYn": "Y"
                             };
                             openThirdModal("/static/html/cmn/modal/userSearch.html", 300, 500, "담당자 검색", paramObj, function (tree){
                                 var checkedId = tree.get_checked()[0];
                                 var checkedNode = tree.get_node(checkedId);
                                 gridView2.target.updateRow($.extend({}, gridView2.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
                                 gridView2.target.updateRow($.extend({}, gridView2.target.list[idx], {wbsPlanMngNm : checkedNode.text}), idx);                                   
                             });
                         }
                     },
                     onDBLClick: function () {
                    	 //debugger;
                    	 this.self.select(this.dindex);
                    	 // Validation 체크
                    	 //if (this.item.rsltsCloseYn == "Y") {
                             //alert("확정된 상태입니다.");
                         //    return;                             
                         //}
//                     	 wbsRsltsUpdateModal(this.dindex);
                    	 wbsRsltsInsertModal();
                    	/////////////////
                     },
                    
                     onDataChanged: function () {  
                    	 // Validation 체크  
                    	 if (this.item.rsltsCloseYn == "Y") {
                             //alert("확정된 상태입니다.");
                             return;
                         }
                        
                         var row = gridView1.target.getList("selected")[0];
                         if (row != undefined) {
                        	// Validation 체크
                             const fDate = new Date(this.item.wbsPlansDt);
                             const tDate = new Date(this.item.wbsPlaneDt);
                                                         
                             const beginDt = new Date(row.wbsPlansDt);
                             const acptncDt = new Date(row.wbsPlaneDt);
                             
                             //1. 시작일자가 시작일 이전이면 안됨
//                              if(fDate < beginDt){
//                             	 alert("시작일자는 계획 시작일자 이전 일 수 없습니다.");
//                             	 this.self.setValue(this.dindex, "wbsPlansDt", row.wbsPlansDt);
//                             	 return false;
//                              }
                             
                             //2. 종료일자가 완료검수일 이후면 안됨
//                              if(tDate > acptncDt){
//                             	 alert("종료일자는 계획 종료일자 이후 일 수 없습니다.");
//                             	 this.self.setValue(this.dindex, "wbsPlaneDt", row.wbsPlaneDt);
//                             	 return false;
//                              }
                             
                             //3. 시작일자는 종료일자 이후일 수 없다.
                             if(fDate > tDate) {
                            	 alert("시작일자는 종료일자 이후 일 수 없습니다.");
                            	 this.self.setValue(this.dindex, "wbsPlansDt", row.wbsPlansDt);
                            	 this.self.setValue(this.dindex, "wbsPlaneDt", row.wbsPlaneDt);
                            	 return false;
                             }
                           
                         }
                                                                          
                         this.self.setValue(this.dindex, "daycnt", calculateHolidayCnt(this.item.wbsPlansDt, this.item.wbsPlaneDt).workingDays);
                         
                     },
                },
                columns: [
                      {key: "fileTrgtKey",   label: "FILE TRGT KEY",    hidden:true},
                      {key: "coCd",          label: "회사",    hidden:true},  
                      {key: "salesCd",       label: "SALES CODE",    hidden:true},                            
                      {key: "wbsPlanNo",     label: "계획번호",   hidden:true},
                      {key: "wbsPlanCodeKind", label: "상위계획코드",    hidden:true},
                      {key: "wbsPlanCodeKindNm", label: "상위계획명",   hidden:true},
                      {key: "wbsPlanCodeId", label: "계획코드",    hidden:true},
                      {key: "seq", label: "순번",    hidden:true},
                      {key: "verNo",         label: "Ver.",   hidden:true},
                      {label: "계획", columns: [ 
	                      {key: "wbsPlanCodeNm", label: "<span style='color: red;'>*</span>TASK명",    align: "left",   width: 300, 
	                    	  editor: {type: "text",
	                    	  disabled: function () {
	                              // Validation 체크   
	                               if (this.item.rsltsCloseYn == "Y") {
	                                   //alert("확정된 상태입니다.");
	                                   return true;
	                               }
	                              /////////////////
	                               //return false;
	                           },}},
	                      {key: "wbsPlanMngId",  label: "담당자",    hidden:true},
	                      {key: "wbsPlanMngNm",  label: "담당자명",    hidden:true},
	                      {key: "wbsPlansDt",    label: "<span style='color: red;'>*</span>시작일자",      align: "center",   width: 100, 
	                          editor: {type: "date"
	                                      , config: {
	                                              content: {
	                                                           config: { mode: "day", selectMode: "day" }
	                                                       }
	                                                 },
					                      disabled: function () {
					                    	  // Validation 체크
					                          if (this.item.rsltsCloseYn == "Y") {
					                              //alert("확정된 상태입니다.");
					                              return true;
					                          }
					                          //return false;
					                          /////////////////////
					                      },
	                                  }
	                      },
	                      {key: "wbsPlaneDt",    label: "<span style='color: red;'>*</span>종료일자",      align: "center",   width: 100,
	                          editor: {type: "date"
	                              , config: {
	                                      content: {
	                                                   config: { mode: "day", selectMode: "day" }
	                                               }
	                                         },
	                                disabled: function () {
	                                    // Validation 체크   
	                                     if (this.item.rsltsCloseYn == "Y") {
	                                         //alert("확정된 상태입니다.");
	                                         return true;
	                                     }
	                                    /////////////////
	                                     //return false;
	                                 },              
	                          }
	                          
	                      },
	                      {key: "daycnt",    label: "소요일수",    align: "center",   width: 60},
	                      {key: "pIssStsNm", label: "이슈",    align: "center",   width: 60},
	                  ]},   
                      /* {key: "wbsPlanStsCodeId",  label: "계획상태", align: "center",   width: 60, editor: {type: "select",
                          config: {
                              columnKeys: {optionValue: 'cd',optionText: 'nm'},
                              options: wbsPlanStsCodeId
                          },
                          disabled: function () {
                              // Validation 체크   
                               if (this.item.closeYn == "Y") {
                                   //alert("확정된 상태입니다.");
                                   //return true;
                               }
                              /////////////////
                               //return false;
                           }, 
                      }
                       , formatter: function () {
                          var result_text = "";
                          var itemValue = this.item.wbsPlanStsCodeId;
                          $.each(wbsPlanStsCodeId, function (idx, elem) {
                              if(itemValue == elem.cd)
                              {
                                  result_text = elem.nm;
                              }
                          });
                          return result_text;
                      } }, */
                      {key: "wbsPlanStsCodeIdNm",      label: "계획상태명",  hidden: true},
                      /* {key: "closeYn",      label: "계획확정",   width: 60, align: "center" , formatter: "chkYn"}, */
                      {key: "rsltsFileTrgtKey",      label: "파일키",   hidden:true},
                      {key: "wbsRsltsNo",      label: "실적번호",   hidden:true},
                      {key: "wbsRsltsId",      label: "담당자",   hidden:true},
                      {key: "wbsRsltsNm",      label: "담당자명",   hidden:true},
                      {label: "실적", columns: [	                      
	                      {key: "wbsRsltssDt",      label: "시작일자",   width: 100, align: "center"},
	                      {key: "wbsRsltseDt",      label: "종료일자",   width: 100, align: "center"},
	                      {key: "rsltsDaycnt",      label: "소요일수",   width: 60, align: "center"},
	                      {key: "wbsRsltsRate",      label: "진척율",   width: 60, align: "center"},
	                      {key: "wbsRsltsPlanMh",      label: "계획공수",   hidden:true},
	                      {key: "wbsRsltsMh",      label: "투입공수",   width: 70, align: "center"},
	                      {key: "wbsRsltsCnts",      label: "주요내용",  hidden:true},
	                      {key: "rsltsCloseYn",      label: "실적확정",   width: 70, align: "center", formatter: "chkYn"},
	                      {key: "rIssStsNm",          label: "이슈",   width: 60, align: "center"},
                      ]},
                      
                      {key: "pIssFileTrgtKey",          label: "issFileTrgtKey",   hidden:true},
                      {key: "pIssDiv",          label: "이슈유형",       hidden:true},
                      {key: "pActId",          label: "담당자",       hidden:true},
                      {key: "pIssNo",          label: "이슈번호",   hidden:true},                               
                      {key: "pIssSts",          label: "진행상태",       hidden:true},
//                       {key: "pIssStsNm",          label: "진행상태",       hidden:true},                               
                      {key: "pIssSj",           label: "제목",      hidden:true},
                      {key: "pIssDivNm",          label: "유형",       hidden:true},
                      {key: "pIssCnts",          label: "내용",       hidden:true},  
                      {key: "pActNm",          label: "담당자",       hidden:true},                                                              
                      {key: "pActsDt",          label: "시작일",  hidden:true},
                      {key: "pActeDt",          label: "종료일",      hidden:true},
                      {key: "pActMh",          label: "투입공수",       hidden:true},
                      {key: "pActAmt",          label: "투입비용",       hidden:true},
                      {key: "pActCnts",          label: "조치내용",      hidden:true},                 
                      
                      {key: "rIssFileTrgtKey",          label: "issFileTrgtKey",   hidden:true},
                      {key: "rIssDiv",          label: "이슈유형",       hidden:true},
                      {key: "rActId",          label: "담당자",       hidden:true},
                      {key: "rIssSts",          label: "진행상태",       hidden:true},
                      {key: "rIssNo",          label: "이슈번호",   hidden:true},                               
                      {key: "rIssStsNm",          label: "진행상태",       hidden:true},                               
                      {key: "rIssSj",           label: "제목",      hidden:true},
                      {key: "rIssDivNm",          label: "유형",       hidden:true},
                      {key: "rIssCnts",          label: "내용",       hidden:true},  
                      {key: "rActNm",          label: "담당자",       hidden:true},                                                              
                      {key: "rActsDt",          label: "시작일",  hidden:true},
                      {key: "rActeDt",          label: "종료일",      hidden:true},
                      {key: "rActMh",          label: "투입공수",       hidden:true},
                      {key: "rActAmt",          label: "투입비용",       hidden:true},
                      {key: "rActCnts",          label: "조치내용",      hidden:true},                
                      
                      
                  ],
             });

             return this;
           },
           
           setData: function() {
               var targetObj = this.target;
               var formData = {
                       "coCd" : coCd,
                       "salesCd" : salesCd,
                       "wbsPlanCodeKind" : wbsPlanCodeKind
               }
               postAjax("/user/wb/wb22/selectWBS2Level", formData, null, function(data){  
                   var list = data.fileList;
                   if (list != undefined) {
                       targetObj.setData({
                            list : list,
                            page : {
                                totalElements : list.length
                            }
                        });
                       
                       gridView2.target.select(0, {selected: true});
                   }
               });
               /*
               // Validation 체크 - 2레벨 담당자 체크 버튼 보임 처리
               var row = gridView1.target.getList("selected")[0];
               if (row != undefined && row.wbsPlanMngId != jwt.userId) {
                   $("#popForm #addrow2").hide();
               }
               else {
                   $("#popForm #addrow2").show();
               }
               */
          } 
      }
 
$(document).ready(function() {
	setCommonSelect($(".popup_area select[data-kind]"));
	isFirst = false;    
	coCd = modalStack.last().paramObj.coCd;
    salesCd = modalStack.last().paramObj.salesCd;
    
    gridView1.initView();
	gridView2.initView();
	
    var paramObj = {
            "coCd": coCd,
            "salesCd": salesCd,
    };
    
    postAjaxSync("/user/wb/wb22/selectSjInfo", paramObj, null, function(data){
		var row = data.resultList;
		if (row != undefined) {
		 	$.each(row, function (key, val) {
		    	$("#popForm #" + key).val(val);
		    	if (key == "closeYn") {   
		        	var color = val == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		            var html = '<img src="/static/img/'+color+'" align="center" style="width: 10px;height: 10px;"></img>';
		            $("#popForm #close").html(html)
		        }
		    	  
		  	});
		 	
		    // Validation 체크
	        if ($('#popForm #closeYn').val() == "N") {
	            alert("과제정보가 미확정입니다. 확정 후 입력 가능합니다.");
	        } else {
	            gridView1.setData(0);                                  
	        }
		    
		 }
    });
     
// 	var row = salesGridView.target.getList("selected")[0];
// 	if (row != undefined) {
// 	 	$.each(row, function (key, val) {
// 	    	$("#popForm #" + key).val(val);
// 	    	if (key == "sjCloseYn") {   
// 	        	var color = val == "Y" ? "color-circle_02.png" : "color-circle_01.png";
// 	            var html = '<img src="/static/img/'+color+'" align="center" style="width: 10px;height: 10px;"></img>';
// 	            $("#popForm #close").html(html)
// 	        }
	    	  
// 	  	});
	 	
// 	    // Validation 체크
//         if ($('#closeYn').val() == "N") {
//             alert("과제정보가 미확정입니다. 확정 후 입력 가능합니다.");
//         } else {
//             gridView1.setData(0);                                  
//         }
	    
// 	 }
	  
	 //권한체크
	 authChk();

});

function calcDate(fDate, tDate) {
// 	console.log("calcDate ||| fDate : " + fDate + " tDate : " + tDate);
	var count = 0;
	if (fDate != undefined && tDate != undefined) {
		 var date1 = new Date(fDate.substr(0,4), fDate.substr(5,2), fDate.substr(8,2));
	     var date2 = new Date(tDate.substr(0,4), tDate.substr(5,2), tDate.substr(8,2));
	     if (fDate == tDate) {
	    	 count = 1;
	     }
	     else {
	    	 while(true) {   
	             var temp_date = date1;
	             if(temp_date.getTime() > date2.getTime()) {
// 	                 console.log("count : " + count);
	                 break;
	             } else {
	                 var tmp = temp_date.getDay();
	                 if(tmp == 0 || tmp == 6) {
	                 } else {
	                     count++;         
	                 }
	                 temp_date.setDate(date1.getDate() + 1); 
	             }
	         }
	     }	     
	}	 
	return count;
}


function wbsLevel1Insert() {	
	
	if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
        alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
        return;
    }
	
	//Validation 체크
	var row = gridView1.target.getList()[0];
    if (row != undefined) {             
    	if (row.closeYn == "Y") {
            alert("확정된 상태입니다.");
            return;
        }
    }
    ////////////////
    
	var rowList = gridView1.target.getList();
	var formData = new FormData(); 
	var actionType = null;
	
	formData.append("coCd", jwt.coCd);
	formData.append("year", $('#beginDt').val().substring(0,4));
	if(rowList.length > 0) {
	    var rowListArr = [];
	    $.each(rowList, function(idx, elem){   
	        if (elem.fileTrgtKey != undefined) {
	            actionType = "U";
	        }
	        else {
	            actionType = "C";
	        }
	        var row = gridView1.target.getList()[idx];
	        var rowListObj = elem;
	        
	        rowListObj["actionType"] = actionType;
	        
	        rowListObj["coCd"] = elem.coCd;
	        rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
	        rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
	        if (actionType == "U") {
	            rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
	            rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
	        }
	        rowListObj["salesCd"] = elem.salesCd;
	        if (elem.verNo != undefined) {
	            rowListObj["verNo"] = elem.verNo;   
	        }
	        else {
	            rowListObj["verNo"] = "1";
	        } 
	            
	        if (elem.wbsPlanMngId != undefined) {
	            rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;             
	        }
	        else {
	            rowListObj["wbsPlanMngId"] = "";
	        }
	        
	        rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
	        rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
	        rowListObj["daycnt"] = elem.daycnt;
	        var wbsPlanStsCodeId = "";
	        
	        if (elem.wbsPlanStsCodeId != undefined) {
	            wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
	        }
	        
	        rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;
	        rowListObj["creatId"] = jwt.userId;
	        rowListObj["creatPgm"] = "WB2201M01";
	        rowListArr.push(rowListObj);         
	    });
	    formData.append("rowListArr", JSON.stringify(rowListArr));
    }    

	filePostAjax("/user/wb/wb22/wbsLevel1Insert", formData, function(data) {
	    alert(data.resultMessage);                              
	    if (data.resultCode == 200) {                          
	        gridView1.setData(0);                  
	    }
	});
	
}


function wbsLevel2Insert() {
	//Validation 체크
    var row = gridView2.target.getList()[0];
    if (row != undefined) {
        if (row.closeYn == "Y") {
            alert("확정된 상태입니다.");
            return;
        }
    }
    
    var rowList = gridView2.target.getList();
    var chk = 0;
    if (rowList.length > 0) {
        $.each(rowList, function(idx, elem){
        	if(chk < 1){
        		if (elem.wbsPlanCodeNm == undefined || elem.wbsPlanCodeNm == "") {
            		alert("계획명이 없습니다.");
            		chk++;
                	return;
            	}
            	if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
            		alert("담당자가 없습니다.");
            		chk++;
                	return;
            	}
            	else if (elem.daycnt > 5) {
            		alert(" TASK별 일정은 5일이 기준입니다.");
                	return;            
                }
        	}
        });
        if (chk > 0) {
        	return false;
        }
    }
    else {
    	alert("TASK 내역이 존재하지 않습니다.");
    	return;
    }
    //////////////////////
    
    var formData = new FormData(); 
    var actionType = null;
    
    formData.append("coCd", jwt.coCd);
    formData.append("year", $('#beginDt').val().substring(0,4));
    formData.append("wbsPlanCodeKind", wbsPlanCodeKind);
    formData.append("salesCd", salesCd);
    actionType = "C";
    if(rowList.length > 0) {    
        var rowListArr = [];
        $.each(rowList, function(idx, elem){ 
            var row = gridView1.target.getList()[idx];
            var rowListObj = elem;
            rowListObj["coCd"] = elem.coCd;
            if (elem.fileTrgtKey != "" ) {
                //rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
                //rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
                rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
            }
            rowListObj["salesCd"] = elem.salesCd;
            rowListObj["verNo"] = row.verNo;
            if (elem.wbsPlanCodeNm != "") {
            	rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
            }
            else {
                rowListObj["wbsPlanCodeNm"] = "";                
            }
            
            
            if (elem.wbsPlanMngId != "") {
                rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;  
            }
            else {
                rowListObj["wbsPlanMngId"] = "";
            }
            
            rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
            rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
            rowListObj["daycnt"] = elem.daycnt;
            var wbsPlanStsCodeId = "";
            if (elem.wbsPlanStsCodeId != "") {
                wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
            }
            rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;
            rowListObj["creatId"] = jwt.userId;
            rowListObj["creatPgm"] = "WB2201M01";
            rowListArr.push(rowListObj);         
        });
        formData.append("rowListArr", JSON.stringify(rowListArr));
    }
    
    formData.append("deleteRowArr", JSON.stringify(deleteRowArr));
    filePostAjax("/user/wb/wb22/wbsLevel2Insert", formData,             
            function(data) {
                alert(data.resultMessage);                              
                if (data.resultCode == 200) {                          
                    gridView2.setData(0); 
                    deleteRowArr.length = 0;
                    addRowArr.length = 0;
                }
            });   
 }
 
function AddDays(date, days) {
    var result = new Date(date);
    result.setDate(result.getDate() + days);
    var strDate = result.getFullYear()+"-"+('0'+(result.getMonth()+1)).slice(-2)+"-"+('0'+result.getDate()).slice(-2);
    return strDate;
}

 $('[data-grid-control]').click(function () {
     switch (this.getAttribute("data-grid-control")) {  
     case "row-add":  
    	 // Validation 체크
    	 var row = gridView1.target.getList("selected")[0];
         if (row == undefined) {
             alert("계획정보를 선택하세요");
             return;
         }
         else if (row.closeYn == "N"){
        	 alert("미확정 상태입니다. 확정 후 등록 가능합니다.");
        	 return;
         }
         /////////////////
         
         var newRow = {};
         newRow = {
                 rn:"", 
                 fileTrgtKey: "", 
                 coCd: jwt.coCd, 
                 salesCd: salesCd, 
                 wbsPlanNo: "",
                 wbsPlanCodeKind: row.wbsPlanCodeId,                    
                 wbsPlanCodeKindNm: row.wbsPlanCodeNm,
                 wbsPlanCodeId: "",
                 wbsPlanCodeNm: "",
                 verNo: row.verNo,
                 wbsPlanMngId: row.wbsPlanMngId,
                 wbsPlanMngNm: row.wbsPlanMngNm,
                 wbsPlansDt: row.wbsPlansDt,                 
                 wbsPlaneDt: row.wbsPlaneDt,
                 daycnt: calculateHolidayCnt(row.wbsPlansDt, row.wbsPlaneDt).workingDays,
                 wbsPlanStsCodeId: "WBSPLANSTS10",
                 closeYn: "N"
                 };
         gridView2.target.addRow($.extend({}, newRow), "last"); 
         addRowArr.push(newRow); 
       break;
     case "row-remove":
    	 // Validation 체크         
    	 var row = gridView1.target.getList("selected")[0];
         if (row == undefined) {
             alert("계획정보를 선택하세요");
             return;
         }
         else if (row.closeYn == "N"){
             alert("미확정 상태입니다. 확정 후 등록 가능합니다.");
             return;
         }
    	 //////////////////
    	 
         var rowList = gridView2.target.getList("selected");
         if (rowList != undefined) {
             $.each(rowList, function(idx, elem){
                 var rowListObj = elem;
                 deleteRowArr.push(rowListObj);         
             });
             gridView2.target.deleteRow("selected");
         }
       break;
    }    
 });
 
 function createVerUp() {
	 if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
         alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
         return;
     }
     
	 // Validation 체크
     var row = gridView1.target.getList()[0];
     if (row.closeYn == "N") {
         alert("미확정 상태입니다. 신규 버전을 생성할 수 없습니다.");
         return;
     }
     var rowList = gridView1.target.getList();
     var chk = 0;
     if (rowList.length > 0) {
         $.each(rowList, function(idx, elem){
             if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
                 chk++;
             }
         });
         if (chk > 0) {
             alert("담당자명을 입력하세요");
             return;
         }
     }
    //////////////////
        
     
     if(confirm("기존 데이터를 버전 변경 하시겠습니까?")){
         var formData = new FormData(); 
         formData.append("coCd", coCd);
         formData.append("salesCd", salesCd);
         formData.append("verNo", row.verNo);
         
         var strYear = new Date().toISOString().substring(2, 4);
         var planData = {
                  "coCd" : coCd,
                  "salesCd" : salesCd
              }; 
         postAjaxSync("/user/wb/wb22/selectVerNoNext", planData, null, function(data){
             formData.append("newVerNo", data.result[0].verNo);
           });  
         
         
         var rowList = gridView1.target.getList();
         var rowListArr = [];
            $.each(rowList, function(idx, elem){ 
                var row = gridView1.target.getList()[idx];
                var rowListObj = elem;
                rowListObj["coCd"] = elem.coCd;
                rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
                rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
                rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
                rowListObj["salesCd"] = elem.salesCd;
                rowListObj["verNo"] = elem.verNo;
                if (elem.wbsPlanCodeNm != undefined) {
                    rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;             
                }
                else {
                    rowListObj["wbsPlanCodeNm"] = "";
                }
                
                if (elem.wbsPlanMngId != undefined) {
                    rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;             
                }
                else {
                    rowListObj["wbsPlanMngId"] = "";
                }
                
                rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
                rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
                rowListObj["daycnt"] = elem.daycnt;
                rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
                rowListObj["closeYn"] = elem.closeYn;
                rowListObj["creatId"] = jwt.userId;
                rowListObj["creatPgm"] = "WB2201M01";
                rowListArr.push(rowListObj);         
            });
            formData.append("rowListArr", JSON.stringify(rowListArr));
        }
        
        filePostAjax("/user/wb/wb22/wbsVerUpInsert", formData, function(data) {
            alert(data.resultMessage);                              
            if (data.resultCode == 200) {                          
                gridView1.setData(0);                  
            }
        });   
     
 }
 
 function wbsLevel1confirm(flag) {
	 if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
         alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
         return;
     }
     
	 
	    // Validation 체크     
	    var rowList = gridView1.target.getList();
	    var chk = 0;
	    if (rowList.length > 0) {
	        $.each(rowList, function(idx, elem){
	            if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
	                chk++;
	            }
	        });
	        if (chk > 0) {
	            alert("담당자명을 입력하세요");
	            return;
	        }
	    }
	    //////////////////
	    
	    var row = gridView1.target.getList()[0];
	    if (row != undefined && row.fileTrgtKey != undefined) { 	    	
	        if (flag == "N") {
	        	// Validation 체크     
	        	if (row.closeYn == "N") {
	                alert("미확정된 상태입니다.");
	                return;
	            }	               
	        	/////////////////
	        	
	            if(confirm("미확정하시겠습니까?")){
	                var formData = new FormData(); 
	                var rowList = gridView1.target.getList();
	                if(rowList.length > 0) {    
	                    var rowListArr = [];
	                    $.each(rowList, function(idx, elem){   
	                        var rowListObj = elem;
	                        rowListObj["coCd"] = elem.coCd;
	                        rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
	                        rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
	                        rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
                            rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
	                        rowListObj["salesCd"] = elem.salesCd;
	                        rowListObj["verNo"] = elem.verNo;
	                        rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
	                        rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
	                        rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
	                        rowListObj["daycnt"] = elem.daycnt;
	                        rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
	                        rowListObj["flag"] = flag;
	                        rowListObj["creatId"] = jwt.userId;
	                        rowListObj["creatPgm"] = "WB2201M01";
	                        rowListArr.push(rowListObj);         
	                    });
	                    formData.append("rowListArr", JSON.stringify(rowListArr));
	                }   
	                
	                filePostAjax("/user/wb/wb22/wbsLevel1confirm", formData, function(data){
	                    if(data.resultCode == 200){
	                        alert("미확정 되었습니다.");       
	                        gridView1.setData(0);
	                    }
	                }); 
	            }
	        }	        
	        else {
	        	// Validation 체크                     
	        	if (flag == "Y" && row.closeYn == "Y") {
	                alert("확정된 상태입니다.");
	                return;
	            }
	        	/////////////////
	        	
	        	if(confirm("확정하시겠습니까?")){
	        		var formData = new FormData(); 
	        		var rowList = gridView1.target.getList();
                    if(rowList.length > 0) {    
                        var rowListArr = [];
                        $.each(rowList, function(idx, elem){   
                            var rowListObj = elem;
                            rowListObj["coCd"] = elem.coCd;
                            rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
                            rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
                            rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
                            rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
                            rowListObj["salesCd"] = elem.salesCd;
                            rowListObj["verNo"] = elem.verNo;
                            rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
                            rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
                            rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
                            rowListObj["daycnt"] = elem.daycnt;
                            rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
                            rowListObj["flag"] = flag;
                            rowListObj["creatId"] = jwt.userId;
                            rowListObj["creatPgm"] = "WB2201M01";
                            rowListArr.push(rowListObj);         
                        });
                        formData.append("rowListArr", JSON.stringify(rowListArr));
                    }   
                    filePostAjax("/user/wb/wb22/wbsLevel1confirm", formData, function(data){
                        if(data.resultCode == 200){
                            alert("확정 되었습니다.");       
                            gridView1.setData(0);
                        }
                     }); 
                }
	        }
	    }
	}
 
	 function wbsLevel2confirm(flag) {
		 if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
             alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
             return;
         }
         
		 
		 // Validation 체크    
		 var lvl1 = gridView1.target.getList("selected")[0];
		 if (lvl1 == undefined) {
			 alert("TASK 확정 시 계획정보를 먼저 선택하세요");
			 return;
		 }
		 else {
			 if (lvl1.closeYn == "N") {
				 alert("계획정보 확정 후 TASK를 확정하세요");
				 return;
			 }
		 }
		 
		 var rowList = gridView2.target.getList();
		 var chk = 0;
         if (rowList.length > 0) {
            $.each(rowList, function(idx, elem){
                if (elem.wbsPlanMngId == undefined 
                    || elem.wbsPlanMngId == ""	
                	|| elem.wbsPlanCodeNm == undefined
                	|| elem.wbsPlanCodeNm == ""
                	) {
                    chk++;
                }
            });
            if (chk > 0) {
                alert("계획명 또는 담당자명을 입력하세요");
                return;
            }
         }
         else {
        	 alert("TASK 내역이 존재하지 않습니다.");
             return;
         }
         
         if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
        	 alert("추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
        	 return;
         }
         ////////////////////
         
	     var row = gridView2.target.getList()[0];
	     if (row != undefined && row.fileTrgtKey != undefined) {       
	         if (flag == "N") {
	        	 // Validation 체크  
	             if (row.closeYn == "N") {
	                 alert("미확정된 상태입니다.");
	                 return;
	             }
	        	 	        	 
	             // Validation 체크 : 미확정 처리 시 실적에 확정된 데이터 유무 체크
	        	 var rsltsChk = gridView2.target.getList("selected")[0];
	        	 //////////////////
	        	 
	             if(confirm("미확정하시겠습니까?")){
	                 var formData = new FormData(); 
	                 var rowList = gridView2.target.getList();
	                    if(rowList.length > 0) {    
	                        var rowListArr = [];
	                        $.each(rowList, function(idx, elem){   
	                            var rowListObj = elem;
	                            rowListObj["coCd"] = elem.coCd;
	                            rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
	                            rowListObj["wbsPlanCodeKind"] = elem.wbsPlanCodeKind;	                            
	                            rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
	                            rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
	                            rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
	                            rowListObj["salesCd"] = elem.salesCd;
	                            rowListObj["verNo"] = elem.verNo;
	                            rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
	                            rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
	                            rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
	                            rowListObj["daycnt"] = elem.daycnt;
	                            rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
	                            rowListObj["flag"] = flag;
	                            rowListObj["creatId"] = jwt.userId;
	                            rowListObj["creatPgm"] = "WB2201M01";
	                            rowListArr.push(rowListObj);         
	                        });
	                        formData.append("rowListArr", JSON.stringify(rowListArr));
	                    }   
	                 filePostAjax("/user/wb/wb22/wbsLevel2confirm", formData, function(data){
	                     if(data.resultCode == 200){
	                         alert("미확정 되었습니다.");       
	                         gridView2.setData(0);
	                     }
	                  }); 
	             }
	         }           
	         else {
	        	 // Validation 체크                   
	             if (flag == "Y" && row.closeYn == "Y") {
	                 alert("확정된 상태입니다.");
	                 return;
	             }
	        	 //////////////////
	        	 
	             if(confirm("확정하시겠습니까?")){
	                 var formData = new FormData(); 
	                 var rowList = gridView2.target.getList();
                     if(rowList.length > 0) {    
                         var rowListArr = [];
                         $.each(rowList, function(idx, elem){   
                             var rowListObj = elem;
                             rowListObj["coCd"] = elem.coCd;
                             rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
                             rowListObj["wbsPlanCodeKind"] = elem.wbsPlanCodeKind;                               
                             rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
                             rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
                             rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
                             rowListObj["salesCd"] = elem.salesCd;
                             rowListObj["verNo"] = elem.verNo;
                             rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
                             rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
                             rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
                             rowListObj["daycnt"] = elem.daycnt;
                             rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
                             rowListObj["flag"] = flag;
                             rowListObj["creatId"] = jwt.userId;
                             rowListObj["creatPgm"] = "WB2201M01";
                             rowListArr.push(rowListObj);         
                         });
                         formData.append("rowListArr", JSON.stringify(rowListArr));
                     }   
	                 filePostAjax("/user/wb/wb22/wbsLevel2confirm", formData, function(data){
	                     if(data.resultCode == 200){
	                         alert("확정 되었습니다.");       
	                         gridView2.setData(0);
	                     }
	                  }); 
	             }
	         }
	     }
	 }
	 
	 function wbsRsltsInsertModal() {	
		 if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
             alert("추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
             return;
         }
		 
		 if (gridView2.target.getList("selected").length > 1 ){
             alert("여러행이 선택되었습니다. 한개의 행을 선택하세요");
             return;
         } 	 
         var row = gridView2.target.getList("selected")[0];
         if (row != undefined) {
        	 if (row.wbsPlanCodeNm == undefined) {
        		 alert("TASK명이 존재하지 않습니다. TASK 저장 후 실적 등록이 가능합니다.");
        		 return;
        	 }
        	 var $inputs = $('#popForm :input');        	 
        	 var paramObj = {};        	 
        	 $inputs.each(function (index)
   	         {
        		 paramObj[$(this).attr('id')+"_P"] = $(this).val();
   	         });
        	 
        	 if (row.rsltsFileTrgtKey != undefined) {
        		 paramObj["actionType"] = "U";
        	 }
        	 else {
        		 paramObj["actionType"] = "C";	 
        	 }        	 
             openThirdModal("/static/html/user/wb/wb22/WB2201P02.html", 1200,700, "WBS 실적등록", paramObj, function (){                    
             });
         }
         else {
             alert("계획정보 항목을 선택하세요");
         }
     }
	 
	 function wbsRsltsUpdateModal(idx) {  
		 var row = gridView2.target.getList()[idx];
         if (row != undefined) {
        	 if (row.wbsRsltssDt == undefined) {
        		 wbsRsltsInsertModal();
        	 }
             if (row.closeYn == "N") {
                 //alert("미확정 상태입니다. 확정 후 등록 가능합니다.");
                 //return;
             }
             
             var $inputs = $('#popForm :input');             
             var paramObj = {};          
             $inputs.each(function (index)
             {
                 paramObj[$(this).attr('id')+"_P"] = $(this).val();
             });
             
             paramObj["actionType"] = "U"; 
             //debugger;
             openThirdModal("/static/html/user/wb/wb22/WB2201P02.html", 1200,700, "WBS 실적수정", paramObj, function (){                    
             });         
             
         }
         else {
             alert("계획정보 항목을 선택하세요");
         }
     }
	 
	 
	 function wbsRsltsconfirm(flag) {
         // Validation 체크    
         var row = gridView2.target.getList("selected")[0];
         if (row == undefined) {
        	 alert("대상을 선택하세요");
        	 return;
         }
         else {
        	 if (flag == "Y" && row.rsltsFileTrgtKey == undefined) {
        		 alert("실적정보가 존재하지 않습니다.");
        		 return;
        	 }
        	 else if (flag == "Y" && row.closeYn == "N") {
                 //alert("계획이 미확정 상태입니다.");
                 //return;  
             }
        	 else if (flag == "Y" && row.rsltsCloseYn == "Y") {
        		 alert("확정상태입니다.");
                 return;  
        	 }
        	 else if (flag == "N" && row.rsltsCloseYn == "N") {
                 alert("미확정상태입니다.");
                 return;  
             }

        	 if (flag == "Y") {
        		 if (parseInt(row.wbsRsltsRate) < 100) {
                     alert("진척율이 100 이하일 경우 실적 확정이 불가합니다.");
                     return;  
                 }
        		 if(confirm("확정하시겠습니까?")){
                     var formData = new FormData();
                     formData.append("flag", flag);
                     formData.append("rsltsFileTrgtKey", row.rsltsFileTrgtKey);  
                     formData.append("userId", $("#userId").val());        
                     formData.append("pgmId", $("#pgmId").val());   
                     filePostAjax("/user/wb/wb22/wbsRsltsconfirm", formData, function(data){
                         if(data.resultCode == 200){
                             alert("확정 되었습니다.");       
                             gridView2.setData(0);
                         }
                      }); 
                 }
        	 }
        	 else if (flag == "N") {
                 if(confirm("확정 취소하시겠습니까?")){
                     var formData = new FormData();
                     formData.append("flag", flag);
                     formData.append("rsltsFileTrgtKey", row.rsltsFileTrgtKey);   
                     formData.append("userId", $("#userId").val());        
                     formData.append("pgmId", $("#pgmId").val());        
                     
                     filePostAjax("/user/wb/wb22/wbsRsltsconfirm", formData, function(data){
                         if(data.resultCode == 200){
                             alert("확정 취소되었습니다.");       
                             gridView2.setData(0);
                         }
                      }); 
                 }
             }
         }
 
     }
	 
	 // 계획이슈등록
	 function wbsPlanIssuePopUp() {
		 var row = gridView2.target.getList("selected")[0];
		 if (row != undefined && row.wbsPlanNo != undefined) {
			 //기존등록내용일 있으면
			 if(row.pIssFileTrgtKey){
				 var paramObj = {
						 "actionType": "U1"
						 };       	 
			 }else{
				 var paramObj = {
						 "actionType": "C1"
						 };         
			 }
			 console.log(row);
             openThirdModal("/static/html/user/wb/wb24/WB2401P01.html", 700, 700, "계획이슈등록", paramObj, function (){                    
             }); 
		 }
		 else {
			 alert("선택한 행에 저장된 계획정보가 없습니다.");
		 }
	 }
	 
	 // 실적이슈등록
	 function wbsRsltsIssuePopUp() {
		 var row = gridView2.target.getList("selected")[0];
         if (row != undefined && row.wbsRsltsNo != undefined) {
        	 //기존등록내용일 있으면
			 if(row.rIssFileTrgtKey){
				 var paramObj = {
						 "actionType": "U2"
						 };       	 
			 }else{
				 var paramObj = {
						 "actionType": "C2"
						 };         
			 }
             openThirdModal("/static/html/user/wb/wb24/WB2401P11.html", 700, 700, "실적이슈등록", paramObj, function (){                    
             }); 
         }
         else {
             alert("선택한 행에 저장된 계획정보가 없습니다.");
         }
	 }
 </script>
 
