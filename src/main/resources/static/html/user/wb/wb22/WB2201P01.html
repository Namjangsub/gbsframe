
<!-- AX5-grid body영역의 Cell Style변경처리 해당화면의 모든 그리드 셀 포멧이 바뀌게 됩니다. -->
<style type="text/css">
	[data-ax5grid] [data-ax5grid-container="root"] [data-ax5grid-container="body"] [data-ax5grid-panel] table tr td [data-ax5grid-cellHolder] {
	    display: block;
	    box-sizing: border-box;
	    padding: 3px 3px;
	    font-size: 12px;
	    line-height: 1;
	    white-space: nowrap;
	    overflow: hidden;
	    text-overflow: ellipsis
	}
</style>
<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">▣ 과제정보</h4>
	</div>
	<div class="popup_table">
		<div class="form-group">
			<form id="popForm">
				<input type="hidden" id="coCd"   name="coCd">
				<input type="hidden" id="userId" name="userId">
				<input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
				<input type="hidden" id="pgmId"  name="pgmId" value="WB2201P01">
				<select id="prdMngChk" data-kind="SPECRTS" hidden></select>

				<table class="popup_table">
					<colgroup>
						<col width="15%">
						<col width="12%">
						<col width="25%">
						<col width="16%">
						<col width="24%">
						<col width="15%">
						<col width="23%">
						<col width="12%">
						<col width="23%">
					</colgroup>

					<thead>
						<tr>
							<td colspan="9" style="height:30px;text-align: left;">
								<div id="ordrsDivNm" style="font-weight: bold; color: blue;">
									▣ 과제정보 [aaaaaaa] - 정상
								</div>
							</td>
						</tr>
					</thead>
					<tr style="text-align: left;" rowspan="2">
						<th>과제기본정보</th>
						<th>과제번호</th>
						<td>
							<input type="text" id="sjNo" name="sjNo" readonly >
						</td>
						<th>과제명</th>
						<td colspan="3">
							<input type="text" id="sjNm" name="sjNm" readonly>
						</td>
						<th>Ver.</th>
						<td>
							<input type="text" id="verNo" name="verNo" readonly>
						</td>
					</tr>

					<tr style="text-align: left;" rowspan="2">
						<th>고객기본정보</th>
						<th>고객사</th>
						<td>
							<input type="hidden" id="clntCd" name="clntCd" >
							<input type="text"   id="clntNm" name="clntNm" readonly >
						</td>
						<th >SALES CODE</th>
						<td>
							<div class="search_form">
								<input type="text" id="salesCd" name="salesCd" required readonly msg="salesCd">
							</div>
						</td>
						<th>제작처 구분</th>
						<td>
							<input type="hidden" id="mkerDiv" name="mkerDiv">
							<input type="text" id="mkerDivNm" name="mkerDivNm" readonly>
						</td>
						<th>차종</th>
						<td>
							<input type="hidden" id="clntPjt"   name="clntPjt">
							<input type="text"   id="clntPjtNm" name="clntPjtNm" readonly >
						</td>
					</tr>

					<tr style="text-align: left;">
						<th>실행정보</th>
						<th>제품</th>
						<td>
							<input type="hidden" id="prdtCd" name="prdtCd" >
							<input type="text" id="prdtNm" name="prdtNm" readonly >
						</td>
						<th><div>총괄PM</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="smrizeId" name="smrizeId" msg="총괄PM" >
								<input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly>
							</div>
						</td>
						<th>제작업체<a id="PlanMkerNm" style="color:red; display: none;" onclick="savePlanMkerNm();"><i class="fas fa-edit"></a></th>
						<td>
							<input type="hidden" id="mkerCd" name="mkerCd">
							<div class="search_form" style="width: 100%;">
								<input type="text" id="mkerNm" name="mkerNm" onkeyUp="removePlanMkerNm();">
								<a onclick="openClntSearch_D();"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th style="color: blue;">확정</th>
						<td>
							<input type="hidden" id="closeYn" name="closeYn" style="color: blue;" readonly><div id="close"></div>
						</td>
					</tr>

					<tr style="text-align: left;">
						<th>납기정보</th>
						<th>시작일</th>
						<td>
							<input id="beginDt" name="beginDt" readonly>
						</td>
						<th>출고일</th>
						<td>
							<input id="deDt" name="deDt" readonly>
						</td>
						<th>완료검수일</th>
						<td>
							<input id="acptncDt" name="acptncDt" readonly>
						</td>
						<th>소요일수</th>
						<td>
							<input id="reqreDaycnt" name="reqreDaycnt" readonly >
						</td>
					</tr>

					<thead>
						<tr>
							<td colspan="9" style="height:30px;text-align: left;">▣ 일정계획정보 
								<div id="addrow1" class="add_btn_small pdl10">
									<a id="btn15" onclick="copyAllPlanPopUp();" data-grid-control="row-add1" style="width:60px;height: 30px; line-height: 28px;">복사</a>
									<a id="btn1" onclick="wbsLevel1Insert();" data-grid-control="row-add1" style="width:60px;height: 30px; line-height: 28px;">저장</a>
									<a id="btn2" onClick="updateWbsChanges();" data-grid-control="row-add1" style="width:100px;height: 30px; line-height: 28px;">변경요청 저장</a>
									<!-- <a id="btn2" onclick="wbsLevel1confirm('N');" data-grid-control="row-add2" style="width:60px;height: 30px; line-height: 28px;">미확정</a> -->
									<a id="btn3" onclick="wbsLevel1confirm('Y');" data-grid-control="row-add3" style="width:60px;height: 30px; line-height: 28px;">확정</a>
									<a id="btn4" onclick="createVerUp();" data-grid-control="row-add3" style="width:60px;height: 30px; line-height: 28px;">Ver. Up</a>
								</div>
							</td>
						</tr>
					</thead>

					<tr style="text-align: left;">
						<th>계획기본정보</th>
						<th>Ver.</th>
						<td>
							<input type="text" id="wbsPlanVerNo" name="wbsPlanVerNo" readonly>
						</td>
						<td colspan="2">
							<input type="text" id="wbsPlanVerUpReason" name="wbsPlanVerUpReason" readonly>
						</td>
						<th>일정예외사항</th>
						<td colspan="1">
							
							<select id="planExcept" name="planExcept" data-kind="PLANEXCEPT" class="form-control" onchange="onPlanExceptChange(this.value)">
						</select>
					
							<!-- <input type="hidden" id="planExcept" name="planExcept" readonly> -->
							
							<input type="text" id="planExceptNm" name="planExceptNm" style="color: blue;" readonly>
						</td>
						<th style="color: blue;">확정</th>
						<td>
							<input type="hidden" id="wbsPlanCloseYn" name="wbsPlanCloseYn" style="color: blue;" readonly><div id="wbsPlanClose"></div>
						</td>
					</tr>

					<tr>
						<td colspan="9">
							<div class="ax5_grid" data-ax5grid="popup-grid1" data-ax5grid-config="{}" style="height: 445px; width: 100%" ></div>
						</td>
					</tr>

					<thead>
						<tr>
							<td colspan="9" style="height:33px;">
								<div style="float: left;">▣ TASK</div>
								<div id="addrow2" class="add_btn_small pdl20">
									<a id="btn5" onclick="" data-grid-control="row-add" style="height: 30px; line-height: 28px;">+</a>
									<a id="btn6" onclick="" data-grid-control="row-remove" style="height: 30px; line-height: 28px;">-</a>
									<a id="btn7" onclick="wbsLevel2Insert();" data-grid-control="row-add4" style="width:60px;height: 30px; line-height: 28px;">저장</a>
									<a id="btn16" onclick="taskMngPopup();" data-grid-control="row-add4" style="width:60px;height: 30px; line-height: 28px; margin-right: 320px;">템플릿</a>
									<!-- <a id="btn8" onclick="wbsLevel2confirm('N');" data-grid-control="row-add5" style="width:60px;height: 30px; line-height: 28px;" >미확정</a>
									<a id="btn9" onclick="wbsLevel2confirm('Y');" data-grid-control="row-add6" style="width:60px;height: 30px; line-height: 28px;" >확정</a>    -->
									<a id="btn10" onclick="wbsRsltsInsertModal();" data-grid-control="row-add7" style="width:60px;height: 30px; line-height: 28px;" >실적등록</a>
									<a id="btn11" onclick="wbsRsltsconfirm('Y');" data-grid-control="row-add8" style="width:60px;height: 30px; line-height: 28px;" >실적확정</a>
									<a id="btn12" onclick="wbsRsltsconfirm('N');" data-grid-control="row-add8" style="width:80px;height: 30px; line-height: 28px; margin-right: 130px;" >확정취소</a>
									<a id="btn13" onclick="wbsPlanIssuePopUp();" data-grid-control="row-add3" style="width:90px;height: 30px; line-height: 28px;">계획 문제등록</a>
									<a id="btn14" onclick="wbsRsltsIssuePopUp();" style="width:95px; height: 30px; line-height: 28px;">실적 문제등록</a>
								</div>
							</td>
						</tr>
					</thead>

					<tr>
						<td colspan="9">
							<div class="ax5_grid" data-ax5grid="popup-grid2" data-ax5grid-config="{}" style="height: 220px; width: 100%;" ></div>
						</td>
					</tr>
				</table>
			</form>
		</div>
	<div><br><br></div>

	<div class="contents" style="display: none;">
<!--     공통 파일 영역 -->
		 <div id="fileList_area"></div>
	</div>

	 <br>
	<div class ="popup_bottom_btn"  style="margin-bottom: 25px;">
		<!-- <button type="button" class="close_btn" onclick="modalStack.close();">닫기</button> -->
		<button type="button"  onclick="executeCallbackM();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	var lastGridView1Rownum = null;
	var lastPlanExcept = "";
	var coCd = null;
	var salesCd = null;
	var planVerNo;
	var histYn;
	var wbsPlanCodeKind = null;
	var deleteRowArr = [];
	var addRowArr = [];
	var level__index = 0;
	var firstCol = '';
	var firstRow = '';
	var thisGridRow = 0;
	var thisGridCol = 0;

	var beforeGridSize = 0; //수주상세그리드의 갯수용 그리드컨텐츠 높이조절용
	//카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];


	ax5.ui.grid.formatter["chkYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
	};
	//---------------------------------------------------
	/*  WBSPLANSTS10	미진행
		WBSPLANSTS20	진행중
		WBSPLANSTS30	지연
		WBSPLANSTS40	지연완료
		WBSPLANSTS50	정상완료 */
	var wbsPlanStsCodeId = [];
	var paramObj = {codeKind : "WBSPLANSTS"};

	postAjaxSync("/user/wb/wb21/selectCodeList", paramObj, null, function(data) {
		wbsPlanStsCodeId = data.resultList;
	});
	//---------------------------------------------------

	function gridColor(item) {
		let rtnColor = "";
		if (item.wbsPlanMngId == jwt.userId) {
			rtnColor = "grid-row-yellow";
		}
		return rtnColor;
	}
	var gridView1 = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="popup-grid1"]'),
				header: {
					align: "center",
					selector: false,
				},
				page : {
					navigationItemCount : 10,
					height : 0,
					use : false,
				},
				body: {
					onClick: function (event, e) {
						this.self.select(this.dindex);
						var idx = this.dindex;
						firstCol = this.colIndex;
						firstRow = this.dindex;
						if(this.item.closeYn == "Y" && histYn == "N") {
							if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
								if (confirm("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요?")) {
									gridView1.target.select(lastGridView1Rownum);
									return;
								}
							}
							deleteRowArr = [];
							addRowArr = [];
							
							wbsPlanCodeKind = this.item.wbsPlanCodeId;
							
							// Validation 체크 총괄PM이 아니면 자기담당인TASK만 조회가능
							var smrizeId = $('#smrizeId').val();
							var row = gridView1.target.getList("selected")[0];
							level__index = row.__index;
							// 1. 총괄 PM인 경우 조회만 됨
							//  총괄PM 또는 일정관리 담당자 한동주 가능-->
							// 등록내용은 전체 조회가 되고,  수정권한만 제거 함. 남장섭 231215 확인
							// Validation 체크 - 2레벨 담당자 체크 버튼 보임 처리
							if (row != undefined && row.wbsPlanMngId != jwt.userId) {
								$("#popForm #addrow2").hide();
							}else {
								$("#popForm #addrow2").show();
							}
// 							if(jwt.userId == smrizeId || jwt.userId == 'ycy'){
// 								gridView2.setData(0);
// 							}else if(row != undefined && row.wbsPlanMngId == jwt.userId){
// 								// 2. 자신이 담당자인 TASK 조회
// 								gridView2.setData(0);
// 							}else{
// 								gridView2.setData(0);
// 							}

							gridView2.setData(0);
						}

					},
					onDBLClick: function () {
						var idx = this.dindex;
						// Validation 체크
						if (this.item.closeYn == "Y") {
							//alert("확정된 상태입니다.");
							return;
						}

						if (this.column.key=='wbsPlanMngNm') {
							var paramObj = {
								"coCd" : coCd,
								"userId": '',
								"useYn": "Y"
							};
							openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function (tree){
								var checkedId = tree.get_checked()[0];
								var checkedNode = tree.get_node(checkedId);
								gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
								gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngNm : checkedNode.text}), idx);

								$("#popForm #btn1").show();  //저장버튼
							});
						}

					},
					onDataChanged: function () {

						//하나라도 수정되면 저장버튼 활성화,
						//   setValue는 onDataChanged 이벤트 없음.--> 해당함수에서 처리해야함

						// Validation 체크
						if (this.item.closeYn == "Y") {
							$("#popForm #btn1").hide();  //  '저장' 버튼 숨기기
							$("#popForm #btn2").show();  //  '변경요청 저장' 버튼 활성화
						} else {
							$("#popForm #btn1").show();
							$("#popForm #btn2").hide();
						}

						const fDate = new Date(this.item.wbsPlansDt);
						const tDate = new Date(this.item.wbsPlaneDt);

						//시작일
						const beginDt = new Date($('#beginDt').val());
						//완료검수일
						const acptncDt = new Date($('#acptncDt').val());

						//1. 시작일자가 시작일 이전이면 안됨
// 						if(this.item.wbsPlansDt != undefined && fDate < beginDt){
// 							alert("시작일자는 시작일 이전 일 수 없습니다.");
// 							this.self.setValue(this.dindex, "wbsPlaneDt", null);
// 							return false;
// 						}

						//2. 종료일자가 완료검수일 이후면 안됨
// 						if(this.item.wbsPlaneDt != undefined && tDate > acptncDt){
// 							alert("종료일자는 완료검수일 이후 일 수 없습니다.");
// 							this.self.setValue(this.dindex, "wbsPlaneDt", null);
// 							return false;
// 						}

						//3. 시작일자는 종료일자 이후일 수 없다.
// 						if(this.item.wbsPlansDt != undefined && this.item.wbsPlaneDt != undefined && fDate > tDate) {
// 							// alert("시작일자는 종료일자 이후 일 수 없습니다.");
// 							let dtSelect = confirm("시작일자는 종료일자 이후 일 수 없습니다.");
// 							if (dtSelect) {
// 								//확인이면 종료일자를 시작일자로 설정
// 								this.self.setValue(this.dindex, "wbsPlaneDt", this.item.wbsPlansDt);
// 							} else {
// 								this.self.setValue(this.dindex, "wbsPlansDt", null);
// 							}
// 							return false;
// 						}

						if(this.item.wbsPlansDt != undefined && this.item.wbsPlaneDt != undefined){
							this.self.setValue(this.dindex, "daycnt", calculateCalendarCnt(this.item.wbsPlansDt, this.item.wbsPlaneDt));
						}else{
							this.self.setValue(this.dindex, "daycnt", 0);
						}

					},
				},
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 1, label: "내용삭제"},
					],
					popupFilter: function (item, param) {
						//console.log(item, param);
						if (param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param, e) {
// 						console.log("contextMenu onPaste");
						//하나라도 수정되면 저장버튼 활성화
						$("#popForm #btn1").show();  //저장버튼
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;

						if (item.label == "붙여넣기") {
							gridPaste(gridView1.target, thisGridRow, thisGridCol);
						} else if (item.label == "내용삭제") {
							let fromRowNo = param.dindex;
							if (firstRow != "")  fromRowNo = firstRow;
							for (var i = fromRowNo; i <= param.dindex; i++) {
								gridView1.target.setValue(i, 'wbsPlanMngId', '');
								gridView1.target.setValue(i, 'wbsPlanMngNm', '');
								gridView1.target.setValue(i, 'wbsPlansDt', '');
								gridView1.target.setValue(i, 'wbsPlaneDt', '');
								gridView1.target.setValue(i, 'daycnt', '');
							}
						}

						gridView1.target.contextMenu.close();
					}
				},
				columns: [
					{key: "rn",            label: "No."				,    align: "center",   width: 40},
					{key: "fileTrgtKey",   label: "FILE TRGT KEY"	,    hidden:true},
					{key: "coCd",          label: "회사"				,    hidden:true},
					{key: "salesCd",       label: "SALES CODE"		,    hidden:true},
					{key: "wbsPlanNo",     label: "계획번호"			,    hidden:true},
					{key: "wbsPlanCodeId", label: "계획코드"			,    hidden:true},
					{key: "wbsCodeDesc",   label: "코드설명"			,    hidden:true},
					{key: "verNo",         label: "Ver."			,    align: "center",   width: 100,      hidden: true},
					{key: "wbsPlanCodeNm", label: "계획명"			,    align: "left",   width: 170, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlanMngId",  label: "담당자 ID"			,    align: "center",   width: 80, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlanMngNm",  label: "<span style='color: red;'>*</span>담당자명",    align: "center",   width: 80, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlansDt",    label: "<span style='color: red;'>*</span>시작일자",      align: "center",   width: 120,
						editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" } } },
						disabled: function () { if (this.item.closeYn == "Y") { return true; } }, }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlaneDt",    label: "<span style='color: red;'>*</span>종료일자",      align: "center",   width: 120,
						editor: { type: "date", config: { content: { config: { mode: "day", selectMode: "day" }, } },
						disabled: function () { if (this.item.closeYn == "Y") { return true; }else{ return false; } }, }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "daycnt",  label: "소요일수",    align: "center",   width: 80,  
						formatter: function () {
							const n = Number(this.value);
							return Number.isFinite(n) ? String(n) : "0";
						},
						styleClass: function () {return gridColor(this.item);}},
					{key: "rsltssDt", label: "<span style='color: #0000FF;'>실적시작일</span>", align: "center", width: 120,
						formatter: function () { return '<div style="color: #0000FF">' + (this.value||'') + '</div>'; }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "rsltseDt", label: "<span style='color: #0000FF;'>실적종료일</span>", align: "center", width: 120,
						formatter: function () { return '<div style="color: #0000FF">' + (this.value||'') + '</div>'; }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "rsltDaycnt",  label: "<span style='color: #0000FF;'>실적소요일수</span>",    align: "center",   width: 80 ,
						formatter: function () { return '<div style="color: #0000FF">' + (calculateCalendarCnt(this.item.rsltssDt, this.item.rsltseDt)||'') + '</div>'; }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "chgReason",    label: "변경사유",   	   width: 150, align: "center", editor: {type: "text"}},
					{key: "closeYn",      label: "확정"			,  width: 80, align: "center" , formatter: "chkYn",      hidden: true},
					{key: "wbsPlanStsCodeIdNm"					,  hidden: true},
					{key: "creatId",      label: "생성자"			,  hidden: true},
					{key: "creatNm",      label: "생성자명"		,  hidden: true},
					{key: "creatDttm",    label: "생성일시"		,  hidden: true},
					{key: "udtId",        label: "최종변경자"		,  hidden: true},
					{key: "udtNm",        label: "최종변경자명"		,  hidden: true},
					{key: "udtDttm",      label: "최종변경일자"		,  hidden: true}
				]
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			var formData = {
				"coCd" : coCd,
				"salesCd" : salesCd,
				"beginDt" : $('#beginDt').val(),
				"acptncDt" : $('#acptncDt').val(),
				"reqreDaycnt" : $('#reqreDaycnt').val(),
				"planVerNo" : planVerNo,
				"userId" : $('#smrizeId').val(),
				"histYn" : histYn
			}
			var ajaxUrl;
			if(histYn == "N"){
				ajaxUrl = "/user/wb/wb22/selectWBS1Level";
			}else{
				ajaxUrl = "/user/wb/wb22/selectHistWBS1Level";

				$('.tit').text('과제관리 이력조회');
				$('#actionBtn').hide();
				$("#popForm #addrow1").hide();
				$("#popForm #addrow2").hide();
			}

			postAjax(ajaxUrl, formData, null, function(data){
				try {
					var list = data.fileList;
					var i = 0;
					if (list != undefined) {
						$.each(list, function(idx, obj){
							list[i].daycnt = calculateCalendarCnt (obj.wbsPlansDt, obj.wbsPlaneDt);
							if(i == 0){
	// 							console.log(list[i]);
								var ver = list[i].verNo;
								var reason = list[i].verUpReason;
								$("#popForm #wbsPlanVerNo").val(ver);
								$("#popForm #wbsPlanVerUpReason").val(reason);

								var val2 = list[i].closeYn;
								if (val2 == "Y") {
									$("#popForm #btn4").show();  //Ver.Up버튼
									$("#popForm #btn3").hide();  //확정버튼
									$("#popForm #btn1").hide();  //저장버튼
								} else {
									$("#popForm #btn4").hide();
									$("#popForm #btn3").show();
									$("#popForm #btn1").hide();
									$("#popForm #addrow2").hide();	// 일정미확정일경우 Task 버튼영역 숨김
								}
								$("#popForm #wbsPlancloseYn").val(val2);
								var color2 = val2 == "Y" ? "color-circle_02.png" : "color-circle_01.png";
								var html2 = '<img src="/static/img/'+color2+'" align="center" style="width: 10px;height: 10px;"></img>';
								$("#popForm #wbsPlanClose").html(html2);
								
							    if (val2 === 'Y') {
							        $('#planExcept').hide();        // select 숨김
							        $('#planExceptNm').show();      // input 표시
							    } else if (val2 === 'N') {
							        $('#planExcept').show();        // select 표시
							        $('#planExceptNm').hide();      // input 숨김
							    }
								
							}
							i++;
						});
						targetObj.setData({
							list : list,
							page : {
								// totalElements : list.length
							}
						});
						// gridView1.target.select(0, {selected: true});
						// var row = gridView1.target.getList("selected")[0];
						// if (row != undefined && row.wbsPlanMngId == jwt.userId) {
						// 	wbsPlanCodeKind = row.wbsPlanCodeId;
						// 	gridView2.setData(0);
						// }

						// if (row != undefined && row.wbsPlanMngId != jwt.userId) {
						// 	$("#popForm #addrow2").hide();
						// }else {
						// 	$("#popForm #addrow2").show();
						// }
						gridView1.target.select(level__index, {selected: true});
					}
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
			// Validation 체크 총괄PM이 아니면 자기담당인TASK만 조회가능
			var smrizeId = $('#smrizeId').val();

			// 1. 총괄 PM인 경우만 수정 +  생산관리권한 있는사람만
			if(smrizeId == jwt.userId || $('#prdMngChk option').attr('data-etc').replace(/\s/g,'').split(',').includes(jwt.userId) || jwt.userId == 'js.nam' || jwt.userId == 'ssj'){
				$("#popForm #addrow1").show();
			}else{
				$("#popForm #addrow1").hide();
			}
		}
	}

	var gridView2 = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="popup-grid2"]'),
				header: {
					align: "center",
					selector: false
				},
				page : {
					navigationItemCount : 10,
					height : 30,
					use : false,
				},
				body: {
					mergeCells : ["salesCd"],
					onClick: function () {
						this.self.select(this.dindex);
						var idx = this.dindex;

						// Validation 체크
						if (this.item.rsltsCloseYn == "Y" ) {
							//alert("확정된 상태입니다.");
							return;
						}

						if (this.column.key=='wbsPlanMngNm') {
							var paramObj = {
								"coCd" : coCd,
								"userId": '',
								"useYn": "Y"
							};
							openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function (tree){
								var checkedId = tree.get_checked()[0];
								var checkedNode = tree.get_node(checkedId);
								gridView2.target.updateRow($.extend({}, gridView2.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
								gridView2.target.updateRow($.extend({}, gridView2.target.list[idx], {wbsPlanMngNm : checkedNode.text}), idx);
							});
						}
					},
					onDBLClick: function () {
						this.self.select(this.dindex);
						// Validation 체크
						// if (this.item.rsltsCloseYn == "Y") {
						// 	alert("확정된 상태입니다.");
						// 	return;
						// }
						// wbsRsltsUpdateModal(this.dindex);
						if (this.column.key=='rIssCnt') {
							wbsRsltsIssuePopUp();
						} else  if (this.column.key=='pIssCnt') {
							wbsPlanIssuePopUp();
						} else {
							wbsRsltsInsertModal();
						}
					},
					onDataChanged: function () {
						// Validation 체크
						if (this.item.rsltsCloseYn == "Y") {
							 //alert("확정된 상태입니다.");
							 return;
						}

						var row = gridView1.target.getList("selected")[0];
						if (row != undefined) {
							// Validation 체크
							const fDate = new Date(this.item.wbsPlansDt);
							const tDate = new Date(this.item.wbsPlaneDt);

							const beginDt = new Date(row.wbsPlansDt);
							const acptncDt = new Date(row.wbsPlaneDt);

							//1. 시작일자가 시작일 이전이면 안됨
							if(fDate < beginDt){
								alert("시작일자는 계획 시작일자 이전 일 수 없습니다.");
								this.self.setValue(this.dindex, "wbsPlansDt", row.wbsPlansDt);
								return false;
							}

							//2. 종료일자가 완료검수일 이후면 안됨
							if(tDate > acptncDt){
								alert("종료일자는 계획 종료일자 이후 일 수 없습니다.");
								this.self.setValue(this.dindex, "wbsPlaneDt", row.wbsPlaneDt);
								return false;
							}

							//3. 시작일자는 종료일자 이후일 수 없다.
							if(fDate > tDate) {
								alert("시작일자는 종료일자 이후 일 수 없습니다.");
								this.self.setValue(this.dindex, "wbsPlansDt", row.wbsPlansDt);
								return false;
							}
						}
						this.self.setValue(this.dindex, "daycnt", calculateCalendarCnt(this.item.wbsPlansDt, this.item.wbsPlaneDt));
					},
				},
				columns: [
					{key: "fileTrgtKey",   label: "FILE TRGT KEY",    hidden:true},
					{key: "coCd",          label: "회사",    hidden:true},
					{key: "salesCd",       label: "SALES CODE",    hidden:true},
					{key: "wbsPlanNo",     label: "계획번호",   hidden:true},
					{key: "wbsPlanCodeKind", label: "상위계획코드",    hidden:true},
					{key: "wbsPlanCodeKindNm", label: "상위계획명",   hidden:true},
					{key: "wbsPlanCodeId", label: "계획코드",    hidden:true},
					{key: "seq", label: "순번",    hidden:true},
					{key: "verNo",         label: "Ver.",   hidden:true},
					{label: "계획",
						columns: [
							{key: "wbsPlanCodeNm", label: "<span style='color: red;'>*</span>TASK명",    align: "left",   width: 300,
								editor: {type: "text",
									disabled: function () {
										// Validation 체크
										if (this.item.rsltsCloseYn == "Y") {
											//alert("확정된 상태입니다.");
											return true;
										}
										//return false;
									},
								}
							, styleClass: function () {return gridColor(this.item);}},
							{key: "wbsPlanMngId",  label: "담당자",    hidden:true},
							{key: "wbsPlanMngNm",  label: "담당자명",    hidden:true},
							{key: "wbsPlansDt",    label: "<span style='color: red;'>*</span>시작일자",      align: "center",   width: 80,
								editor: {
									type: "date", config: {
										content: {
											config: { mode: "day", selectMode: "day" }
										}
									},
									disabled: function () {
										// Validation 체크
										if (this.item.rsltsCloseYn == "Y") {
											//alert("확정된 상태입니다.");
											return true;
										}
										//return false;
									},
								}
							, styleClass: function () {return gridColor(this.item);}},
							{key: "wbsPlaneDt",    label: "<span style='color: red;'>*</span>종료일자",      align: "center",   width: 80,
								editor: {
									type: "date", config: {
										content: {
											config: { mode: "day", selectMode: "day" }
										}
									},
									disabled: function () {
										// Validation 체크
										if (this.item.rsltsCloseYn == "Y") {
											//alert("확정된 상태입니다.");
											return true;
										}
										//return false;
									},
								}
							, styleClass: function () {return gridColor(this.item);}},
							{key: "daycnt",    label: "소요일수",    align: "center",   width: 60, styleClass: function () {return gridColor(this.item);}},
							{key: "expectMh",  label: "예상공수",    align: "center",   width: 60, editor: {type: "number"}, styleClass: function () {return gridColor(this.item);}},
							// {key: "pIssStsNm", label: "문제",    align: "center",   width: 60, styleClass: function () {return gridColor(this.item);}},
							{key: "pIssCnt", label: "문제횟수",    align: "center",   width: 60, styleClass: function () {return gridColor(this.item);}},
						]
					},

					{key: "wbsPlanStsCodeIdNm",      label: "계획상태명",  hidden: true},
					// {key: "closeYn",      label: "계획확정",   width: 60, align: "center" , formatter: "chkYn"},
					{key: "rsltsFileTrgtKey",      label: "파일키",   hidden:true},
					{key: "wbsRsltsNo",      label: "실적번호",   hidden:true},
					{key: "wbsRsltsId",      label: "담당자",   hidden:true},
					{key: "wbsRsltsNm",      label: "담당자명",   hidden:true},
					{label: "실적",
						columns: [
							{key: "wbsRsltssDt",      label: "시작일자",   width: 80, align: "center", styleClass: function () {return gridColor(this.item);}},
							{key: "wbsRsltseDt",      label: "종료일자",   width: 80, align: "center", styleClass: function () {return gridColor(this.item);}},
							{key: "rsltsDaycnt",      label: "소요일수",   width: 60, align: "center", styleClass: function () {return gridColor(this.item);}},
							{key: "wbsRsltsRate",      label: "진척율",   width: 60, align: "center", styleClass: function () {return gridColor(this.item);}},
							{key: "wbsRsltsPlanMh",      label: "계획공수",   hidden:true},
							{key: "wbsRsltsMh",      label: "투입공수",   width: 70, align: "center", styleClass: function () {return gridColor(this.item);}},
							{key: "wbsRsltsCnts",      label: "주요내용",  hidden:true},
							{key: "rsltsCloseYn",      label: "실적확정",   width: 70, align: "center", formatter: "chkYn", styleClass: function () {return gridColor(this.item);}},
							// {key: "rIssStsNm",          label: "문제",   width: 60, align: "center"},
							{key: "rIssCnt", label: "문제횟수",    align: "center",   width: 60, styleClass: function () {return gridColor(this.item);}},
						]
					},
					{key: "pIssFileTrgtKey",          label: "issFileTrgtKey",   hidden:true},
					{key: "pIssDiv",          label: "문제유형",       hidden:true},
					{key: "pActId",          label: "담당자",       hidden:true},
					{key: "pIssNo",          label: "문제번호",   hidden:true},
					{key: "pIssSts",          label: "진행상태",       hidden:true},
					// {key: "pIssStsNm",          label: "진행상태",       hidden:true},
					{key: "pIssSj",           label: "제목",      hidden:true},
					{key: "pIssDivNm",          label: "유형",       hidden:true},
					{key: "pIssCnts",          label: "내용",       hidden:true},
					{key: "pActNm",          label: "담당자",       hidden:true},
					{key: "pActsDt",          label: "시작일",  hidden:true},
					{key: "pActeDt",          label: "종료일",      hidden:true},
					{key: "pActMh",          label: "투입공수",       hidden:true},
					{key: "pActAmt",          label: "투입비용",       hidden:true},
					{key: "pActCnts",          label: "조치내용",      hidden:true},
					{key: "rIssFileTrgtKey",          label: "issFileTrgtKey",   hidden:true},
					{key: "rIssDiv",          label: "문제유형",       hidden:true},
					{key: "rActId",          label: "담당자",       hidden:true},
					{key: "rIssSts",          label: "진행상태",       hidden:true},
					{key: "rIssNo",          label: "문제번호",   hidden:true},
					{key: "rIssStsNm",          label: "진행상태",       hidden:true},
					{key: "rIssSj",           label: "제목",      hidden:true},
					{key: "rIssDivNm",          label: "유형",       hidden:true},
					{key: "rIssCnts",          label: "내용",       hidden:true},
					{key: "rActNm",          label: "담당자",       hidden:true},
					{key: "rActsDt",          label: "시작일",  hidden:true},
					{key: "rActeDt",          label: "종료일",      hidden:true},
					{key: "rActMh",          label: "투입공수",       hidden:true},
					{key: "rActAmt",          label: "투입비용",       hidden:true},
					{key: "rActCnts",          label: "조치내용",      hidden:true},
				],
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			let row = gridView1.target.getList("selected")[0];
			var formData = {
				"coCd" : coCd,
				"salesCd" : salesCd,
				"wbsPlanCodeKind" : row.wbsPlanCodeId
			}
			postAjaxSync("/user/wb/wb22/selectWBS2Level", formData, null, function(data){
				try {
					var list = data.fileList;
					if (list != undefined) {
						targetObj.setData({
							list : list,
							page : {
								totalElements : list.length
							}
						});
					}
					// Validation 체크 - 2레벨 담당자 체크 버튼 보임 처리
	// 				var row = gridView1.target.getList("selected")[0];
					if (row != undefined && row.wbsPlanMngId != jwt.userId) {
						$("#popForm #addrow2").hide();
					}else {
						$("#popForm #addrow2").show();
						// noGrid2List(list);
					}

					//전산실 관리용
					if (jwt.userId == 'js.nam' || jwt.userId == 'ssj')  $("#popForm #addrow2").show();
					gridResize(gridView2.target.list.length); //그리드 높이 조정
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
		},
		clearRow : function() {
			//안나올 값으로 클리어링
			var targetObj = this.target;
			var formData = {
				"coCd" : "XXX",
				"salesCd" : salesCd,
				"wbsPlanCodeKind" : wbsPlanCodeKind
			}
			postAjaxSync("/user/wb/wb22/selectWBS2Level", formData, null, function(data){
				var list = data.fileList;
				if (list != undefined) {
					targetObj.setData({
						list : list,
						page : {
							totalElements : list.length
						}
					});
				}
				return true;
			});
		}
	}


	$(document).ready(function() {

		//---------------------------------------------------------------
		//첨부 화일 처리 시작
// 		  //---------------------------------------------------------------
// 		  fileParam = {
// 		          fileTrgtTyp : $("#popForm #pgmId").val(),
// 		          fileTrgtKey     :$("#popForm #fileTrgtKey").val()
// 		  }
// 		  treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		let UserId = jwt.userId;
		setCommonSelect($(".popup_area select[data-kind]"));
		coCd = modalStack.last().paramObj.coCd;
		salesCd = modalStack.last().paramObj.salesCd;
		planVerNo = modalStack.last().paramObj.planVerNo;
		histYn = modalStack.last().paramObj.histYn;
		
		//권한처리하면 기본적으로  버튼은 숨겨야함
		$("#popForm #addrow1").hide();
		// $("#popForm #addrow2").hide();
		$("#popForm #btn2").hide(); // 위 코드가 작동을 안해서 넣어둠
		//저장, 확정, Ver.Up 버튼 숨김 처리
// 		$("#popForm #btn1").hide();
// 		$("#popForm #btn3").hide();
// 		$("#popForm #btn4").hide();

		gridView1.initView();
		gridView2.initView();

		var paramObj = {
			"coCd": coCd,
			"salesCd": salesCd,
		};

		postAjaxSync("/user/wb/wb22/selectSjInfo", paramObj, null, function(data){
			var row = data.resultList;
			if (row != undefined) {
				$.each(row, function (key, val) {
					$("#popForm #" + key).val(val);
					if (key == "closeYn") {
						var color = val == "Y" ? "color-circle_02.png" : "color-circle_01.png";
						var html = '<img src="/static/img/'+color+'" align="center" style="width: 10px;height: 10px;"></img>';
						$("#popForm #close").html(html)
					}else if(key == "planExcept"){
						lastPlanExcept = val;
					}
				});

				// Validation 체크
				if ($('#popForm #closeYn').val() == "N") {
					alert("과제정보가 미확정입니다. 확정 후 입력 가능합니다.");
				} else {
					gridView1.setData(0);
				}
				$('#wbsPopup .tit').text($('#wbsPopup .tit').text() + ' [' + row.salesCd + '] - ' + row.ordrsDivNm );
				$("#popForm #ordrsDivNm").text('▣ 과제정보 [' + row.salesCd + '] - ' + row.ordrsDivNm );
			}
		});

		// 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
		var paramObj = {
			"coCd" : $("#popForm #coCd").val(),
			"salesCd" : $("#popForm #salesCd").val(),
		};
		postAjaxSync("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data){
			if (data.result[0].closeChk == "Y") {
				$('.tit').text('과제관리 이력조회');
				$('#actionBtn').hide();
				$("#popForm #addrow1").hide();
				$("#popForm #addrow2").hide();
			}
		});
		// ----------------------------------

	//---------------------------------------------------------------
	//첨부 화일 처리 시작
	//---------------------------------------------------------------
	fileParam = {
			  fileTrgtTyp : $("#popFormRslts #pgmId").val(),
			  fileTrgtKey     :$("#popFormRslts #rsltsFileTrgtKey").val()
	}

	treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
	//---------------------------------------------------------------
	//첨부 화일 처리 끝
	//---------------------------------------------------------------

		$('#mkerNm').on('change', function () {
			$('#PlanMkerNm').css('display', 'inline');
		});

		//권한체크
		authChk();

		//복사버튼 설정
		setCopyButton();
	
		
		const wbsPlanCloseYn = $("#wbsPlancloseYn").val();

	    if (wbsPlanCloseYn === 'Y') {
	        $('#planExcept').hide();        // select 숨김
	        $('#planExceptNm').show();      // input 표시
	    } else if (wbsPlanCloseYn === 'N') {
	        $('#planExcept').show();        // select 표시
	        $('#planExceptNm').hide();      // input 숨김
	    }
		
	});


	function noGrid2List(list){
		//조회결과 저장된 게 없다면
		if(list.length == 0 && confirm("저장된 내용이 없습니다. TASK 템플릿을 불러오겠습니까?")){
			var formData = {
				"wbsPlanCodeId" : wbsPlanCodeKind,
				"pageNo" : 0 + 1
			}
			postAjaxSync("/user/wb/wb22/selectWbsTaskTempletList", formData, null, function(data){
				var list = data.result;
				$.each(list, function(idx, elem){
					var row = gridView1.target.getList("selected")[0];
					var rowListObj = elem;
					var newRow = {};
					newRow = {
						rn:"",
						fileTrgtKey: "",
						coCd: jwt.coCd,
						salesCd: salesCd,
						wbsPlanNo: "",
						wbsPlanCodeKind: row.wbsPlanCodeId,
						wbsPlanCodeKindNm: row.wbsPlanCodeNm,
						wbsPlanCodeId: rowListObj.codeId,
						wbsPlanCodeNm: rowListObj.codeNm,
						verNo: row.verNo,
						wbsPlanMngId: row.wbsPlanMngId,
						wbsPlanMngNm: row.wbsPlanMngNm,
						wbsPlansDt: row.wbsPlansDt,
						wbsPlaneDt: row.wbsPlaneDt,
						daycnt: calculateCalendarCnt(row.wbsPlansDt, row.wbsPlaneDt),
						wbsPlanStsCodeId: "WBSPLANSTS10",
						closeYn: "N"
					};
					gridView2.target.addRow($.extend({}, newRow), "last");
					addRowArr.push(newRow);
				});
				gridView2.target.select(0, {selected: true});
			});
		}
	}
	function wbsLevel1Insert(fromConfirm) {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다.\n 저장 후 처리하세요");
			return;
		}
		

		//Validation 체크
		var row = gridView1.target.getList()[0];
		if (row != undefined) {
			if (row.closeYn == "Y") {
				alert("확정된 상태입니다.");
				return;
			}
		}
		////////////////

		var rowList = gridView1.target.getList();
		var formData = new FormData();
		var actionType = null;

		formData.append("coCd", jwt.coCd);
		formData.append("year", $('#beginDt').val().substring(0,4));
		if(rowList.length > 0) {
			var rowListArr = [];

			$.each(rowList, function(idx, elem){
				if (elem.fileTrgtKey != undefined) {
					actionType = "U";
				}
				else {
					actionType = "C";
				}
				var row = gridView1.target.getList()[idx];
				var rowListObj = elem;

				rowListObj["actionType"] = actionType;

				rowListObj["coCd"] = elem.coCd;
				rowListObj["salesCd"] = $('#popForm #salesCd').val();
				rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
				rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
				if (actionType == "U") {
					rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
					rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
				}
				rowListObj["salesCd"] = elem.salesCd;
				if (elem.verNo != undefined) {
					rowListObj["verNo"] = elem.verNo;
				}
				else {
					//신규 등록시 동일버젼 내에서 버전번호 최대값 추출
					const largestValue = rowList.reduce((maxObject, currentObject) => {
						return currentObject["verNo"] > maxObject["verNo"] ? currentObject : maxObject;
						}, rowList[0]);

					rowListObj["verNo"] = (largestValue["verNo"] == undefined) ? 1 : largestValue["verNo"] ;
				}

				if (elem.wbsPlanMngId != undefined) {
					rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
				}
				else {
					rowListObj["wbsPlanMngId"] = "";
				}

				rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
				rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
				rowListObj["daycnt"] = elem.daycnt;
				var wbsPlanStsCodeId = "";

				if (elem.wbsPlanStsCodeId != undefined) {
					wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
				}

				rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;
				rowListObj["creatId"] = jwt.userId;
				rowListObj["creatPgm"] = "WB2201M01";
				rowListObj["chgReason"] = elem.chgReason;		// 변경사유

				rowListArr.push(rowListObj);
			});
			formData.append("rowListArr", JSON.stringify(rowListArr));
		}

		//예외사항 변경부분 저장
		createWb21VerUp();
		
		
		filePostAjax("/user/wb/wb22/wbsLevel1Insert", formData, function(data) {

			if(!fromConfirm){
				alert(data.resultMessage);
			}
			
			if (data.resultCode == 200) {
				gridView1.setData(0);
				if(fromConfirm){
					
					getGrid1RowList();
					
				}
			}
		});

	}


	function wbsLevel2Insert() {
		var rowList = gridView2.target.getList();
		var chk = 0;
		if (rowList.length > 0 || deleteRowArr.length > 0) {
			$.each(rowList, function(idx, elem){
				if(chk < 1){
					if (elem.wbsPlanCodeNm == undefined || elem.wbsPlanCodeNm == "") {
						alert("계획명이 없습니다.");
						chk++;
						return;
					}
					// if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
					// 	alert("담당자가 없습니다.");
					// 	chk++;
					// 	return;
					// }
// 					if (elem.daycnt > 5) {
// 						alert(" TASK별 소요일수는 5일을 초과할 수 없습니다.");
// 						chk++;
// 						return;
// 					}
				}
			});
			if (chk > 0) {
				return false;
			}
		}
		else {
			alert("TASK 내역이 존재하지 않습니다.");
			return;
		}
		//////////////////////
		var row1 = gridView1.target.getList("selected")[0];
		var formData = new FormData();
		var actionType = null;
		if (wbsPlanCodeKind == '' || wbsPlanCodeKind == undefined) {
			var row = gridView1.target.getList("selected")[0]
			wbsPlanCodeKind = row.wbsPlanCodeId
		}

		formData.append("coCd", $('#coCd').val());
		formData.append("year", $('#beginDt').val().substring(0,4));
		formData.append("wbsPlanCodeKind", wbsPlanCodeKind);
		formData.append("salesCd", salesCd);
		formData.append("sjVerNo", $('#verNo').val());		//과제버전
		formData.append("verNo", $('#wbsPlanVerNo').val());	//일정버전
		actionType = "C";
		if(rowList.length > 0) {
			var rowListArr = [];
			let row = gridView1.target.getList("selected")[0];
			$.each(rowList, function(idx, elem){
				var rowListObj = elem;
				if (elem.fileTrgtKey != "" ) {
					//rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
					//rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
					rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
				}
				rowListObj["verNo"] = row.verNo;

				var wbsPlanStsCodeId = "";
				if (elem.wbsPlanStsCodeId != "") {
					wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
				}
				rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;

				// 전산관리자가 Task 수정시 해당 Task의 담당자 id,nm이 들어가겠끔
				if (jwt.userId == 'js.nam' || jwt.userId == 'ssj') {
					rowListObj["wbsPlanMngId"] = row1.wbsPlanMngId;
					rowListObj["wbsPlanMngNm"] = row1.wbsPlanMngNm;
				} else {
					rowListObj["wbsPlanMngId"] = jwt.userId;
					rowListObj["wbsPlanMngNm"] = jwt.userNm;
				}
				rowListObj["creatId"] = jwt.userId;
				rowListObj["creatPgm"] = "WB2201M01";
				rowListArr.push(rowListObj);
			});
			formData.append("rowListArr", JSON.stringify(rowListArr));
		}
		formData.append("deleteRowArr", JSON.stringify(deleteRowArr));
		filePostAjax("/user/wb/wb22/wbsLevel2Insert", formData, function(data) {
				if (data.resultCode !=200) {
					customAlert(data.resultMessage);
					$("#popForm #addrow2").hide();
				}
				deleteRowArr.length = 0;
				addRowArr.length = 0;
				gridView1.setData(0);
				gridView2.setData(0);
		});
	}

	function AddDays(date, days) {
		var result = new Date(date);
		result.setDate(result.getDate() + days);
		var strDate = result.getFullYear()+"-"+('0'+(result.getMonth()+1)).slice(-2)+"-"+('0'+result.getDate()).slice(-2);
		return strDate;
	}

	$('[data-grid-control]').click(function () {
		switch (this.getAttribute("data-grid-control")) {
			case "row-add":
				// Validation 체크
				var row = gridView1.target.getList("selected")[0];
// 				console.log(row);
				if (row == undefined) {
					alert("계획정보를 선택하세요");
					return;
				}
				lastGridView1Rownum = row.__index;
// 				var newRow = {};
				var newRow = gridView2.target.getList("selected")[0];
				if (newRow == undefined ) {
					newRow = {
						rn:"",
						fileTrgtKey: "",
						coCd: jwt.coCd,
						salesCd: salesCd,
						wbsPlanNo: "",
						wbsPlanCodeKind: row.wbsPlanCodeId,
						wbsPlanCodeKindNm: row.wbsPlanCodeNm,
						wbsPlanCodeId: "",
						wbsPlanCodeNm: "",
						verNo: row.verNo,
						wbsPlanMngId: "",
						wbsPlanMngNm: "",
						wbsPlansDt: row.wbsPlansDt,
						wbsPlaneDt: row.wbsPlaneDt,
						daycnt: calculateCalendarCnt(row.wbsPlansDt, row.wbsPlaneDt),
						wbsPlanStsCodeId: "WBSPLANSTS10",
						closeYn: "N"
					};
					gridView2.target.addRow($.extend({}, newRow), "last");
				} else {
					newRow["rn"] = "";
					newRow["fileTrgtKey"] = "";
					newRow["wbsPlanCodeId"] = "";
					newRow["wbsPlanCodeNm"] = "";
					newRow["wbsPlanStsCodeId"] = "WBSPLANSTS10";
					newRow["wbsPlanStsCodeIdNm"] =  "미진행";
					newRow["closeYn"] = "N";
					newRow["rsltsFileTrgtKey"] = "";
					newRow["wbsRsltsNo"] = "";
					newRow["wbsRsltsId"] = "";
					newRow["wbsRsltsNm"] = "";
					newRow["wbsRsltsRate"] = "";
					newRow["wbsRsltsMh"] = "";
					newRow["wbsRsltsCnts"] = "";
					newRow["wbsRsltssDt"] = "";
					newRow["wbsRsltseDt"] = "";
					newRow["rsltsDaycnt"] = "";
					newRow["rsltsCloseYn"] = "";
					let addIndex = newRow.__index + 1;
					gridView2.target.addRow($.extend({}, newRow, {__index: undefined}), addIndex,);
// 					gridView2.target.setValue(addIndex, "wbsPlanCodeId", "");
					gridView2.target.focus(addIndex);
				}
				addRowArr.push(newRow);

				gridResize(gridView2.target.list.length); //그리드 높이 조정
				break;
			case "row-remove":
				// Validation 체크
				var row = gridView1.target.getList("selected")[0];
				if (row == undefined) {
					alert("계획정보를 선택하세요");
					return;
				}
				//  else if (row.closeYn == "N"){
				//      alert("미확정 상태입니다. 확정 후 등록 가능합니다.");
				//      return;
				//  }

				lastGridView1Rownum = row.__index;
				var rowList = gridView2.target.getList("selected");
				//  console.log(rowList);
				if (rowList.length > 0) {
					//문제획수가 없거나, 실적확정이 이뤄지지 않은 데이터들만 삭제가능
					if (rowList[0].rIssCnt == undefined && (rowList[0].rsltsCloseYn == 'N' || rowList[0].rsltsCloseYn == '' || rowList[0].rsltsCloseYn == undefined)){
						//조회 된 로우만 삭제대상에 적재
						if(rowList[0].fileTrgtKey != ""){
							$.each(rowList, function(idx, elem){
								var rowListObj = elem;
								deleteRowArr.push(rowListObj);
							});
						}else{
							//적제 안하면 addRowArr 에서 해당 행 빼야함.
// 							console.log(addRowArr);
							// wbsPlanCodeId 값이 같은 요소를 제거
							addRowArr = addRowArr.filter(function(item) {
								return item.wbsPlanCodeId !== rowList[0].wbsPlanCodeId;
							});
							// 제거된 결과를 확인
// 							console.log(addRowArr);
						}
						gridView2.target.deleteRow("selected");
					} else {
						alert("문제가 등록되었거나 실적이 확정된 경우\n삭제 할 수 없습니다.");
						return;
					}
				}
				break;
		}
	});

	function createVerUp() {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}
		// Validation 체크
		var row = gridView1.target.getList()[0];
		if (row.closeYn == "N") {
			alert("미확정 상태입니다. 신규 버전을 생성할 수 없습니다.");
			return;
		}

		var rowList = gridView1.target.getList();
		var chk = 0;
		if (rowList.length > 0) {
			$.each(rowList, function(idx, elem){
				if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
					chk++;
				}
			});
			//  if (chk > 0) {
			//      alert("담당자명을 입력하세요");
			//      return;
			//  }
		}

		// 버전업 클릭시 버전업 사유 입력받고 진행
		verUpReason($('#wbsPlanVerNo').val(), '').then(function(reason) {
			if (!reason || reason.status !== 'ok') {
				return false; // alert 없음
			}

			// 버전업 사유 Validation 체크
			const verUpReasonValue = String(reason.value || '').trim();
			if (!verUpReasonValue) {
				customAlert('Ver.Up 사유를 입력하세요.');
				return false;
			}

			var formData = new FormData();
			formData.append("coCd", coCd);
			formData.append("salesCd", salesCd);
			formData.append("verNo", row.verNo);
			formData.append("verUpReason", verUpReasonValue);

			var strYear = new Date().toISOString().substring(2, 4);
			var planData = {
				"coCd" : coCd,
				"salesCd" : salesCd
			};
			postAjaxSync("/user/wb/wb22/selectVerNoNext", planData, null, function(data){
				formData.append("newVerNo", data.result[0].verNo);
			});

			var rowList = gridView1.target.getList();
			var rowListArr = [];
			$.each(rowList, function(idx, elem){
				var row = gridView1.target.getList()[idx];
				var rowListObj = elem;
				if (elem.fileTrgtKey != undefined) {
					rowListObj["coCd"] = elem.coCd;
					rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
					rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
					rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
					rowListObj["salesCd"] = elem.salesCd;
					rowListObj["verNo"] = elem.verNo;
					if (elem.wbsPlanCodeNm != undefined) {
						rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
					}
					else {
						rowListObj["wbsPlanCodeNm"] = "";
					}

					if (elem.wbsPlanMngId != undefined) {
						rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
					}
					else {
						rowListObj["wbsPlanMngId"] = "";
					}

					rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
					rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
					rowListObj["daycnt"] = elem.daycnt;
					rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
					rowListObj["closeYn"] = elem.closeYn;
					rowListObj["creatId"] = jwt.userId;
					rowListObj["creatPgm"] = "WB2201M01";
					rowListObj["verUpReason"] = verUpReasonValue;
					rowListArr.push(rowListObj);
				}
			});
			formData.append("rowListArr", JSON.stringify(rowListArr));

			filePostAjax("/user/wb/wb22/wbsVerUpInsert", formData, function(data) {
				if (data.resultCode == 200) {
// 					alert(data.resultMessage);
					gridView1.setData(0);
				} else {
					alert("미확정 상태입니다.")
					gridView1.setData(0);
				}
			});
		}).catch(function(err){
			return false;
		});
	}

	//확정 버튼클릭시 처리 함수
	function wbsLevel1confirm(flag) {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}

		//전체일정중 일부일정만 등록되어도 저장 가능하게 수정-남장섭 2023.11.20  start
		// Validation 체크
		var rowList = gridView1.target.getList();
		var chk = 0;
		var chkError = "";
		var chk2 = 0;
		var chk2Error = "";
		var chk3 = 0;
		var chk3Error = "";
		var chk4 = 0;
		if (rowList.length > 0) {
			let planExceptCd = $('#planExcept').val();  //일정관리 예외 사항 코드 PLANEXCEPT01 : 예외사항없음
			let wbsCodeArr = [];
			if (planExceptCd == 'PLANEXCEPT01') {
				wbsCodeArr = ["WBSCODE01","WBSCODE02","WBSCODE11","WBSCODE12","WBSCODE13","WBSCODE14"];
			} else {
				wbsCodeArr = ["WBSCODE01","WBSCODE02"];
			}
			$.each(rowList, function(idx, elem){
				if (wbsCodeArr.indexOf(elem.wbsPlanCodeId) !== -1) {
					if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
						chk++;
						chkError += chk==1 ? "" : ", "
						chkError += idx+1
					}
					if (elem.wbsPlansDt == undefined || elem.wbsPlansDt == "") {
						chk2++;
						chk2Error += chk2==1 ? "" : ", "
						chk2Error += idx+1
					}
					if (elem.wbsPlaneDt == undefined || elem.wbsPlaneDt == "") {
						 chk3++;
						chk3Error += chk3==1 ? "" : ", "
						chk3Error += idx+1
					 }
				}

				chkwbsPlanMngId = elem.wbsPlanMngId == undefined ? "" : elem.wbsPlanMngId;
				chkwbsPlansDt = elem.wbsPlansDt == undefined ? "" : elem.wbsPlansDt;
				chkwbsPlaneDt = elem.wbsPlaneDt == undefined ? "" : elem.wbsPlaneDt;
				if (chkwbsPlanMngId != "" ||
					chkwbsPlansDt != "" ||
					chkwbsPlaneDt != "") {
					if (chkwbsPlanMngId == undefined || chkwbsPlanMngId == "") {
						chk4++;
						alert(elem.wbsPlanCodeNm + " 업무 담당자를 입력하세요.");
						return false;
					}
					if (chkwbsPlansDt == undefined || chkwbsPlansDt == "") {
						chk4++;
						alert(elem.wbsPlanCodeNm + " 시작일자를 입력하세요.");
						return false;
					}
					if (chkwbsPlaneDt == undefined || chkwbsPlaneDt == "") {
						chk4++;
						alert(elem.wbsPlanCodeNm + " 종료일자를 입력하세요");
						return false;
					 }
				}
			});

			if (chk4 > 0 ) { //담당자, 시작일, 종류일 하나라도 입력되면 전체를 입력해야 함.
				return;
			}
			if (chk > 0) {
				alert(chkError + " 담당자명은 지정되어야 확정 가능합니다.");
				return;
			}
			if (chk2 > 0 || chk3 > 0) {
				alert(chk2Error +" 계획시작일자를 입력해야 확정 가능합니다.");
				return;
			}
			if (chk2 > 0 || chk3 > 0) {
				alert(chk2Error+ " 계획시작일자" +chk3Error+ " 계획종료일자를 입력해야 확정 가능합니다.");
				return;
			}

		}
		//////////////////
		//전체일정중 일부일정만 등록되어도 저장 가능하게 수정-남장섭 2023.11.20  end
		//전체 일정 입력 완료에서 하나의 일저이라도 등록되면 확정 가능하게 수정,  이후 카톡알림, 일정현황 그래프출력 프로그램 수정해야함.
		var wbsPlanVerNo = $("#popForm #wbsPlanVerNo").val();
		if(wbsPlanVerNo == "" || wbsPlanVerNo == null || wbsPlanVerNo == undefined){
			wbsLevel1Insert(true);
		}else{
			createWb21VerUp();
			wbsLevel1Submit(flag);
		}
			
		
		
	}

	function wbsLevel2confirm(flag) {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}

		// Validation 체크
		var lvl1 = gridView1.target.getList("selected")[0];
		if (lvl1 == undefined) {
			alert("TASK 확정 시 계획정보를 먼저 선택하세요");
			return;
		} else {
			if (lvl1.closeYn == "N") {
				alert("계획정보 확정 후 TASK를 확정하세요");
				return;
			}
		}

		var rowList = gridView2.target.getList();
		var chk = 0;
		if (rowList.length > 0) {
			$.each(rowList, function(idx, elem){
				if (elem.wbsPlanMngId == undefined
				|| elem.wbsPlanMngId == ""
				|| elem.wbsPlanCodeNm == undefined
				|| elem.wbsPlanCodeNm == ""
				) {
					chk++;
				}
			});

			if (chk > 0) {
				alert("계획명 또는 담당자명을 입력하세요");
				return;
			}
		} else {
			alert("TASK 내역이 존재하지 않습니다.");
			return;
		}

		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}

		var row = gridView2.target.getList()[0];
		if (row != undefined && row.fileTrgtKey != undefined) {
			if (flag == "N") {
				// Validation 체크
				if (row.closeYn == "N") {
					alert("미확정된 상태입니다.");
					return;
				}

				// Validation 체크 : 미확정 처리 시 실적에 확정된 데이터 유무 체크
				var rsltsChk = gridView2.target.getList("selected")[0];

				if(confirm("미확정하시겠습니까?")){
					var formData = new FormData();
					var rowList = gridView2.target.getList();
					if(rowList.length > 0) {
						var rowListArr = [];
						$.each(rowList, function(idx, elem){
							var rowListObj = elem;
							rowListObj["coCd"] = elem.coCd;
							rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
							rowListObj["wbsPlanCodeKind"] = elem.wbsPlanCodeKind;
							rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
							rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
							rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
							rowListObj["salesCd"] = elem.salesCd;
							rowListObj["verNo"] = elem.verNo;
							rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
							rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
							rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
							rowListObj["daycnt"] = elem.daycnt;
							rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
							rowListObj["flag"] = flag;
							rowListObj["creatId"] = jwt.userId;
							rowListObj["creatPgm"] = "WB2201M01";
							rowListArr.push(rowListObj);
						});
						formData.append("rowListArr", JSON.stringify(rowListArr));
					}
					filePostAjax("/user/wb/wb22/wbsLevel2confirm", formData, function(data){
						if(data.resultCode == 200){
// 							alert("미확정 되었습니다.");
							gridView2.setData(0);
						}
					});
				}
			} else {
				// Validation 체크
				if (flag == "Y" && row.closeYn == "Y") {
					alert("확정된 상태입니다.");
					return;
				}

				if(confirm("확정하시겠습니까?")){
					var formData = new FormData();
					var rowList = gridView2.target.getList();
					if(rowList.length > 0) {
						var rowListArr = [];
						$.each(rowList, function(idx, elem){
							var rowListObj = elem;
							rowListObj["coCd"] = elem.coCd;
							rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
							rowListObj["wbsPlanCodeKind"] = elem.wbsPlanCodeKind;
							rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
							rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
							rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
							rowListObj["salesCd"] = elem.salesCd;
							rowListObj["verNo"] = elem.verNo;
							rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
							rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
							rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
							rowListObj["daycnt"] = elem.daycnt;
							rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
							rowListObj["flag"] = flag;
							rowListObj["creatId"] = jwt.userId;
							rowListObj["creatPgm"] = "WB2201M01";
							rowListArr.push(rowListObj);
						});
						formData.append("rowListArr", JSON.stringify(rowListArr));
					}
					filePostAjax("/user/wb/wb22/wbsLevel2confirm", formData, function(data){
						if(data.resultCode == 200){
// 							alert("확정 되었습니다.");
							gridView2.setData(0);
						}
					});
				}
			}
		}
	}

	function wbsRsltsInsertModal() {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}
		if (gridView2.target.getList("selected").length > 1 ){
			alert("여러행이 선택되었습니다. 한개의 행을 선택하세요");
			return;
		}
		var row = gridView2.target.getList("selected")[0];
		//TASK 하나일경우 선택하지 않아도 첫번째 자료 자동 선택되게
		if (row == undefined) {
			let rowCnt =  gridView2.target.list.length;
			if (rowCnt == 1) {
				gridView2.target.select(0);
				row = gridView2.target.list[0];
			}
		}
		if (row != undefined) {
			if (row.wbsPlanCodeNm == undefined) {
				alert("TASK명이 존재하지 않습니다. TASK 저장 후 실적 등록이 가능합니다.");
				return;
			}
			var $inputs = $('#popForm :input');
			var paramObj = {};
			$inputs.each(function (index)
			{
				paramObj[$(this).attr('id')+"_P"] = $(this).val();
			});

			if (row.rsltsFileTrgtKey != undefined) {
				paramObj["actionType"] = "U";
			} else {
				paramObj["actionType"] = "C";
			}
			openSecondModal("/static/html/user/wb/wb22/WB2201P02.html", 1200,700, "WBS 실적등록", paramObj, function (){
				
			});
		} else {
			alert("TASK 항목을 선택하세요");
		}
	}

	function wbsRsltsUpdateModal(idx) {
		var row = gridView2.target.getList()[idx];
		if (row != undefined) {
			if (row.wbsRsltssDt == undefined) {
				wbsRsltsInsertModal();
			}

			if (row.closeYn == "N") {
				//alert("미확정 상태입니다. 확정 후 등록 가능합니다.");
				//return;
			}

			var $inputs = $('#popForm :input');
			var paramObj = {};
			$inputs.each(function (index)
			{
				paramObj[$(this).attr('id')+"_P"] = $(this).val();
			});

			paramObj["actionType"] = "U";
			openSecondModal("/static/html/user/wb/wb22/WB2201P02.html", 1200,700, "WBS 실적수정", paramObj, function (){

			});
		} else {
			alert("TASK 항목을 선택하세요");
		}
	}

	function wbsRsltsconfirm(flag) {
		// Validation 체크
		var row = gridView2.target.getList("selected")[0];
		//TASK 하나일경우 선택하지 않아도 첫번째 자료 자동 선택되게
		if (row == undefined) {
			let rowCnt =  gridView2.target.list.length;
			if (rowCnt == 1) {
				gridView2.target.select(0);
				row = gridView2.target.list[0];
			}
		}
		if (row == undefined) {
			alert("대상을 선택하세요");
			return;
		} else {
			if (flag == "Y" && row.rsltsFileTrgtKey == undefined) {
				alert("실적정보가 존재하지 않습니다.");
				return;
			}else if (flag == "Y" && row.closeYn == "N") {
				//alert("계획이 미확정 상태입니다.");
				//return;
			}else if (flag == "Y" && row.rsltsCloseYn == "Y") {
				alert("확정상태입니다.");
				return;
			}else if (flag == "N" && row.rsltsCloseYn == "N") {
				alert("미확정상태입니다.");
				return;
			}

			if (flag == "Y") {
				if (parseInt(row.wbsRsltsRate) < 100) {
					alert("진척율이 100 이하일 경우 실적 확정이 불가합니다.");
					return;
				}

				if(confirm("확정하시겠습니까?")){
					var formData = new FormData();
					formData.append("flag", flag);
					formData.append("rsltsFileTrgtKey", row.rsltsFileTrgtKey);
					formData.append("userId", $("#userId").val());
					formData.append("pgmId", $("#pgmId").val());
					filePostAjax("/user/wb/wb22/wbsRsltsconfirm", formData, function(data){
						if(data.resultCode == 200){
//                             alert("확정 되었습니다.");
							gridView2.setData(0);
						}
					});
				}
			}else if (flag == "N") {
				if(confirm("확정 취소하시겠습니까?")){
					var formData = new FormData();
					formData.append("flag", flag);
					formData.append("rsltsFileTrgtKey", row.rsltsFileTrgtKey);
					formData.append("userId", $("#userId").val());
					formData.append("pgmId", $("#pgmId").val());

					filePostAjax("/user/wb/wb22/wbsRsltsconfirm", formData, function(data){
						if(data.resultCode == 200){
//                             alert("확정 취소되었습니다.");
							gridView2.setData(0);
						}
					});
				}
			}
		}
	}

	// 복사대상 팝업
	function copyPlanPopUp() {
// 		console.log("복사대상팝업");

		//Validation 체크
		var row = gridView1.target.getList()[0];
		if (row != undefined) {
			if (row.closeYn == "Y") {
				alert("확정된 상태입니다.");
				return;
			}
		}

		var paramObj = {
			"salesCd": $("#salesCd").val()
		};
		//복사대상 선정
		openSecondModal("/static/html/user/wb/wb22/WB2201P04.html", 1200, 400, "일정계획조회", paramObj, function (grid){
			var row = grid.target.getList("selected")[0];
			var formData = {
				"coCd" : coCd,
				"salesCd" : row.salesCd,
				"beginDt" : $('#beginDt').val(),
				"acptncDt" : $('#acptncDt').val()
			}
			postAjax("/user/wb/wb22/selectWBS1Level", formData, null, function(data){
				var list = data.fileList;
				var i = 0;
				if (list != undefined) {
					$.each(list, function(idx, obj){
						list[i].daycnt = calculateCalendarCnt(obj.wbsPlansDt, obj.wbsPlaneDt);
						list[i].verNo = $("#popForm #wbsPlanVerNo").val();
						list[i].closeYn = $("#popForm #wbsPlancloseYn").val();
						i++;
					});

					gridView1.target.setData({
						list : list,
						page : {
							// totalElements : list.length
						}
					});
// 					console.log(list);
				}
			});
			// var paramObj = {
			// 	coCd : $("#coCd").val()
			// 	, targetSalesCd : $("#salesCd").val()
			// 	, copySalesCd : row.salesCd
			// 	, pgmId : $("#pgmId").val()
			// 	, userId : jwt.userId
			// };
			// postAjaxSync("/user/wb/wb22/callCopyWbsPlan", paramObj, null, function(data){
			// 	gridView1.setData(0);
			// });
		});
	}

	// 계획문제등록
	function wbsPlanIssuePopUp() {

		var row = gridView2.target.getList("selected")[0];
		if (row == undefined || row.wbsPlanNo == undefined) {
			let rowCnt = gridView2.target.list.length;
			if (rowCnt == 1) {
				row = gridView2.target.list[0];
			} else {
				alert("TASK 항목을 선택하세요.");
				return false;
			}
		}
		if (row != undefined && row.wbsPlanNo != undefined) {
			//기존 등록된 문제가 있으면 문제관리로 이동
			if(row.pIssCnt) {
				if(confirm("이미 등록된 문제가 있습니다. 문제관리 화면으로 이동하시겠습니까?")) {
// 					console.log("이동!");
					var targetURL = "/static/html/user/wb/wb24/WB2401M01.html?salesCd="+row.salesCd; // 리다이렉션할 대상 URL : 문제관리 URL
					window.location.href = targetURL;
				}
			} else {
				//등록된 문제가 없으면 바로 문제 등록
				var paramObj = {
					"actionType"      : "C1",
					"coCd"            : $("#coCd").val(),
					"clntPjtNm"       : $("#clntPjtNm").val(),
					"clntNm"          : $("#clntNm").val(),
					"salesCd"         : row.salesCd,
					"wbsPlanNo"       : row.wbsPlanNo,
					"wbsRsltsNo"      : row.wbsRsltsNo,
					"wbsPlanCodeKind" : row.wbsPlanCodeKind,
					"wbsPlanCodeId"   : row.wbsPlanCodeId,
					"wbsPlanCodeNm"   : row.wbsPlanCodeNm,
					"wbsPlanMngNm"    : row.wbsPlanMngNm,
					"wbsPlansDt"      : row.wbsPlansDt,
					"wbsPlaneDt"      : row.wbsPlaneDt,
				};
				openSecondModal("/static/html/user/wb/wb24/WB2401P01.html", 1200, $('body').height()-41, "계획문제등록", paramObj, function () {

				});
			}
		}
	}

	// 실적문제등록
	function wbsRsltsIssuePopUp() {
		var row = gridView2.target.getList("selected")[0];
		if (row == undefined || row.wbsRsltsNo == undefined) {
			let rowCnt = gridView2.target.list.length;
			if (rowCnt == 1) {
				row = gridView2.target.list[0];
			} else {
				alert("TASK 항목을 선택하세요.");
				return false;
			}
		}

		if (row != undefined && row.wbsRsltsNo != undefined) {
			//기존등록내용일 있으면
			if(row.rIssCnt) {
				if(confirm("이미 등록된 문제가 있습니다. 문제관리 화면으로 이동하시겠습니까?")) {
// 					console.log("이동!");
					var targetURL = "/static/html/user/wb/wb24/WB2401M01.html?salesCd="+row.salesCd; // 리다이렉션할 대상 URL : 문제관리 URL
					window.location.href = targetURL;
				}
			} else {
				var paramObj = {
					"actionType"      : "C2",
					"coCd"            : $("#coCd").val(),
					"clntPjtNm"       : $("#clntPjtNm").val(),
					"clntNm"          : $("#clntNm").val(),
					"salesCd"         : row.salesCd,
					"wbsPlanNo"       : row.wbsPlanNo,
					"wbsRsltsNo"      : row.wbsRsltsNo,
					"wbsPlanCodeKind" : row.wbsPlanCodeKind,
					"wbsPlanCodeId"   : row.wbsPlanCodeId,
					"wbsPlanCodeNm"   : row.wbsPlanCodeNm,
					"wbsPlanMngNm"    : row.wbsPlanMngNm,
					"wbsPlansDt"      : row.wbsPlansDt,
					"wbsPlaneDt"      : row.wbsPlaneDt,
					"wbsRsltssDt"     : row.wbsRsltssDt,
					"wbsRsltseDt"     : row.wbsRsltseDt,
				};
				openSecondModal("/static/html/user/wb/wb24/WB2401P11.html", 1200, $('body').height()-41, "실적문제등록", paramObj, function (){

				});
			}
		} else {
			alert("TASK 항목을 선택하세요.");
		}
	}

	// TASK 템플릿 관리 팝업
	function taskMngPopup() {
		var row = gridView1.target.getList("selected")[0];
		if (row != undefined && row.wbsPlanCodeId != undefined) {
			var paramObj = {
				"wbsPlanCodeId" : row.wbsPlanCodeId
				, "wbsPlanCodeNm" : row.wbsPlanCodeNm
				, "userId" : row.wbsPlanMngId
			};
			openSecondModal("/static/html/user/wb/wb22/WB2201P05.html", 400, 400, "TASK 템플릿 관리", paramObj, function (){

			});
		} else {
			alert("선택된 계획이 없습니다.");
		}
	}

	function gridPaste(thisGrid, thisGridRow, thisGridCol ) {
		var pasteData = "";
		navigator.clipboard.readText()
		.then(pasteData => {
// 			console.log('클립보드에 저장된 값:', pasteData);
			if (pasteData == undefined || pasteData == "" || thisGridRow == undefined) {
				console.error('클립보드에 데이터가 없습니다.');
				return;
			}

			// 붙여넣기할 데이터를 배열로 변환한다.
			var pasteRows = pasteData.split("\n").map(function(row) {
				return row.split("\t");
			});

			//복사대상의 마지막 배열의 값이 없으면 제외
			if (pasteRows[pasteRows.length - 1] == "") pasteRows.splice(pasteRows.length - 1, 1);

			// 붙여넣기를 시작할 셀의 인덱스를 구한다.
			var startRowIndex = thisGridRow;
			var startColIndex = thisGridCol;

			// 붙여넣을 데이터의 행과 열 개수를 구한다.
			var numRows = pasteRows.length;
			var numCols = pasteRows[0].length;

			// 16개 행 이상 안들어가게 차단 WBS계획등록 내용은 16개까지만 동록함
			numRows = 16 - startRowIndex;
			//그리드 컬럼정보를 가져와서 붙여넣기할때 위치정보로 사용한다.
			tempColumns = thisGrid.colGroup;
			for (var i = tempColumns.length - 1; i >= 0; i--) {
				if (tempColumns[i].hidden) {
					tempColumns.splice(i, 1);
				}
			}

			var currGridData = thisGrid.list;
// 			console.log(currGridData);
			//마지막자료와 같은 값으로 추가하고 ordrsSeq는 0으로 설정
			//참조복사를 방지하기 위함
			var tempData = JSON.parse(JSON.stringify(currGridData[thisGridRow]));
			tempData.ordrsSeq = "0";

			// 붙여넣기할 셀을 한 개씩 돌면서 값을 설정한다.
			for (var i = 0; i < numRows; i++) {
				for (var j = 0; j < numCols; j++) {
					//carriage return 문자 삭제
					var cellData = pasteRows[i][j].replace(new RegExp('\r', 'ig'), '');

					calRow = startRowIndex + i;
					calCol = startColIndex + j;

					if (calRow >= currGridData.length) {
						//참조복사를 방지하기 위함
						let tempDataCopy = JSON.parse(JSON.stringify(tempData));
						currGridData.push(tempDataCopy);
					}
					var tkey = tempColumns[calCol].key;
					currGridData[calRow][tkey] = cellData;
				}
			}
			thisGrid.repaint();
		})
		.catch(error => {
			thisGrid.repaint();
// 			console.log('클립보드 읽기 오류 발생:', error);
		});
	};

	
		// KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
	function kakaoTodo_wbs22() {
		if ($('#wbsPlanVerNo').val() != '1') {
			return false;
		}
		//message load
		if (kakaoErr.length == 0) {
			var paramObj = {
				"userId" : jwt.userId
				, "codeKind" : "KAKAOMSG"
			};
			postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
				if(data.resultList.length > 0 ) {
					kakaoErr = data.resultList;
				}
			});
		}

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
		kakaoSendBody_wbs22('','', 'WBS 일정계획','WBS 일정계획 확정','일정확인');
		if (kakaoCnt > 0) {
			kakaoCnt = 0;
			alert("알림톡이 정상 발송되었습니다.");
		}
	}

	function kakaoSendBody_wbs22(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
		let param = {
			"tmplatDiv": "TMPLATDIV02"
			, "coCd": $("#popForm #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
			, "salesCd": $("#popForm #salesCd").val()             //해당업무의 coCd(트르넷발주 TRN )
			, "verNo": $("#popForm #wbsPlanVerNo").val()             //해당업무의 coCd(트르넷발주 TRN )
			, "todoDiv1CodeId": "" //"TODODIV10"                 //공통코드 해당업무 - 결재
			, "todoDiv2CodeId": "" // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv1CodeNm": "" // "WBS문제"                        //공통코드 해당업무 - 결재 - 발주서
			, "todoDiv2CodeNm": "" // "WBS계획문제"                       //공통코드 해당업무 - 결재 - 발주서
			, "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
			, "todoNo": $("#popForm #sjNo").val() // 과제 번호
			, "clntCd": "1"                 //발신회사는 로그인사용자 회사
			, "clntNm": ""             //로그의 수신거래처명
			, "ordrgMngNm": jwt.userNm        //확정한 사람 이름
			, "creatPgm": "WB2201P01"
			, "userId": jwt.userId
			, "todoTitle": "WBS확정-" + $("#popForm #salesCd").val()
		}
		commKaKaoSendTodo_wbs22(param);
	}

	//to-do결재요청 알림톡
	function commKaKaoSendTodo_wbs22(param) {
// 		console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

		//알림톡수신번호 채번
		var maxMessageId = null;            //message id(unique key)
		var talkMessage = null              //발송될 내용 template
		var mobile = null                   //수신인 휴대전화번호
		var title = null                    //todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;

		// verNo 1인 경우와 1보다 큰 경우 분기
		if ($('#wbsPlanVerNo').val() == "1") {
			postAjaxSync("/user/bm/bm18/selectWbsPlanMaxMessageIdTodo", param, null, function(data) {
				if(data.resultList.length > 0 ) {
					if( data.resultList[0].maxMessageId != "" ) {
						sendList = data.resultList;
					} else {
						alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
						return;
					}
				}
			});
		}
		else {
			postAjaxSync("/user/bm/bm18/selectWbsPlanUpdateMaxMessageIdTodo", param, null, function(data) {
				if(data.resultList.length > 0 ) {
					if( data.resultList[0].maxMessageId != "" ) {
						sendList = data.resultList;
					} else {
						alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
						return;
					}
				}
			});
		}


		//user search ajax end

		//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			title = sendObj.todoTitl + "[" + sendObj.todoDiv2CodeNm + "]";

			//로그용
			param.rcvId = sendObj.todoId;           //todo 수신id
			param.rcvNm = sendObj.name;             //todo 수신자명
			param.nameTo = sendObj.name;                //todo 수신자명
			param.sendDt = sendObj.sendDt;
			param.title = sendObj.todoTitl;
			param.todoDiv1CodeNm = "일정확인";
			param.todoDiv2CodeNm = sendObj.todoDiv2CodeNm + " 계획 등록";
			param.ordrgMngNm = sendObj.ordrgMngNm;
			param.sanctnDiv2 = sendObj.sanctnDiv2;
			param.ordrgMngTelNo = sendObj.telNo;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}

			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}

			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
					if( typeof(param[compKey]) != "undefined" ) {
						let val2 = '#'+val;
						message = message.replaceAll(val2, param[compKey]);
					}
				}
			});
			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값);
			if (title.length > 50) {
				title = title.substring(0, 49); // 50자까지만 자르기
			}
			talkBody.title = title;                 //알림톡 타이틀 -
			talkBody.message = message;             //알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;               //휴대전화번호
			talkBody.template = "10003";            //템플릿관리화면 템플릿ID - 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			sendCnt = kakaoSendReal(talkJson, talkParam, param);
		});
		//대상 loop end

		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}

		//한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄
		/*  talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
		talkBody.mobile = "01063893764"
		talkJson = JSON.stringify(talkBody); */
		//kakaoSendReal(talkJson, talkParam, param);
	}

	// 복사대상 팝업
	function copyAllPlanPopUp() {
		var paramObj = {};
		paramObj["coCd"] = $('#coCd_S').val();
		paramObj["pgmId"] = "WB2201M02";
		var tempCode = $("#popForm #salesCd").val();
		paramObj["searchValue"] = tempCode.substring(0,5);
		openSecondModal("/static/html/cmn/modal/wbsPlanConfirmSearch.html", 1200, 870, "일정계획 일괄 대상 검색", paramObj);
	}

	// 복사대상 버튼
	function setCopyButton() {
// 		if(jwt.userId == $('#smrizeId').val() || jwt.userId == 'ycy' || jwt.userId == 'js.nam'|| jwt.userId == 'ssj'){  //윤치영부장
			$("#btn15").show();
			$('#mkerNm').prop('readonly', false);
// 		}else{
// 			$("#btn15").hide();
// 			$('#mkerNm').prop('readonly', true);
// 		}
	}

	function makeFormData() {
		var formData = new FormData($("#popForm_S")[0]);
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"salesCd" : $('#salesCd').val(),
			"verNo" : $('#wbsPlanVerNo').val(),
			"histYn" : histYn,
			"userId" : jwt.userId
		}
		var rowSharngListArr = [];

		var changedData = gridView1.target.getList().filter(function(row) {
			return row.__modified__;
		});
		// verNo가 1인 경우와 1보다 큰 경우 분기
		if ($('#wbsPlanVerNo').val() == "1") {
			postAjaxSync("/user/wb/wb22/selectWbcPlanTodoList", paramObj, null, function(data){
				var list = data.resultList;
				if (list != undefined) {
					$.each(list, function(idx, obj){
						var rowSharngListObj = obj;
						rowSharngListObj["coCd"] = obj.coCd;
						rowSharngListObj["salesCd"] = obj.salesCd;
						rowSharngListObj["todoDiv1CodeId"] = obj.todoDiv1CodeId;
						rowSharngListObj["todoDiv2CodeId"] = obj.todoDiv2CodeId;
						rowSharngListObj["usrNm"] = obj.todoId;
						rowSharngListObj["todoCoCd"] = obj.todoCoCd;
						rowSharngListObj["empNo"] = obj.empNo;
						rowSharngListObj["name"] = obj.name;
						rowSharngListObj["telNo"] = obj.telNo;
						rowSharngListObj["email"] = obj.email;
						rowSharngListObj["pgPath"] = "/user/wb/wb22/WB2201P01.html";
						rowSharngListObj["verNo"] = $('#wbsPlanVerNo').val();
						rowSharngListObj["histYn"] = histYn;
						rowSharngListObj["fileTrgtKey"] = obj.fileTrgtKey;
						rowSharngListObj["todoCodeKind"] = obj.wbsPlanCodeKind;
						rowSharngListObj["todoCodeId"] = obj.wbsPlanCodeId;
						rowSharngListObj["reqNo"] = obj.wbsPlanNo;
						rowSharngListObj["sanctnSttus"] = obj.sanctnSttus;
						var tempCunt = (obj.levelCnt== 1) ? " 공유" : " 외 " + (obj.levelCnt-1) + "건 공유"
						rowSharngListObj["todoTitle"] = $('#sjNm').val() + " (" + obj.salesCd + ") WBS 계획 확정 :" + obj.wbsPlanCodeNm + tempCunt;
						rowSharngListObj["pgmId"] = "WB2201P01";
						rowSharngListObj["userId"] = jwt.userId;
						rowSharngListArr.push(rowSharngListObj);
					});
					formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
					filePostAjax("/user/wb/wb22/wbcPlanTodoInsert", formData, function(data) {
						//alert(data.resultMessage);
					});
				}
			});
		}
		else {
			postAjaxSync("/user/wb/wb22/selectWbcPlanUpdteTodoList", paramObj, null, function(data){
				var list = data.resultList;
				if (list != undefined) {
					$.each(list, function(idx, obj){
						var rowSharngListObj = obj;
						rowSharngListObj["coCd"] = obj.coCd;
						rowSharngListObj["salesCd"] = obj.salesCd;
						rowSharngListObj["todoDiv1CodeId"] = obj.todoDiv1CodeId;
						rowSharngListObj["todoDiv2CodeId"] = obj.todoDiv2CodeId;
						rowSharngListObj["usrNm"] = obj.todoId;
						rowSharngListObj["todoCoCd"] = obj.todoCoCd;
						rowSharngListObj["empNo"] = obj.empNo;
						rowSharngListObj["name"] = obj.name;
						rowSharngListObj["telNo"] = obj.telNo;
						rowSharngListObj["email"] = obj.email;
						rowSharngListObj["pgPath"] = "/user/wb/wb22/WB2201P01.html";
						rowSharngListObj["verNo"] = $('#wbsPlanVerNo').val();
						rowSharngListObj["histYn"] = histYn;
						rowSharngListObj["fileTrgtKey"] = obj.fileTrgtKey;
						rowSharngListObj["todoCodeKind"] = obj.wbsPlanCodeKind;
						rowSharngListObj["todoCodeId"] = obj.wbsPlanCodeId;
						rowSharngListObj["reqNo"] = obj.wbsPlanNo;
						rowSharngListObj["sanctnSttus"] = obj.sanctnSttus;
						var tempCunt = (obj.levelCnt== 1) ? " 공유" : " 외 " + (obj.levelCnt-1) + "건 수정 공유"
						rowSharngListObj["todoTitle"] = $('#sjNm').val() + " (" + obj.salesCd + ") WBS 계획 확정 :" + obj.wbsPlanCodeNm + tempCunt;
						rowSharngListObj["pgmId"] = "WB2201P01";
						rowSharngListObj["userId"] = jwt.userId;
						rowSharngListArr.push(rowSharngListObj);
					});
					formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
					filePostAjax("/user/wb/wb22/wbcPlanTodoInsert", formData, function(data) {
						//alert(data.resultMessage);
					});
				}
			});
		}

	}

	function gridResize(size) {
		if (size < 6) return;
		if (beforeGridSize != size) {
			var tagHeight = (size) * 27 + 123 ;
			tagHeight = tagHeight > 750 ? 750 : tagHeight;
			tagHeight = tagHeight < 220 ? 220 : tagHeight;

			gridView2.target.setHeight(tagHeight);
			beforeGridSize = size;
		}
	}

	function executeCallbackM() {
		if (modalStack.last().callback != undefined) {
			modalStack.last().callback(gridView1);
		}
		modalStack.close();
	}


	// 제작사 검색
	function openClntSearch_D() {
		var paramObj = {
			"searchValue" :  $("#mkerNm").val(),
			"clntDivCd"   : "CLNTDIV06"
		}
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "제작사 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#mkerCd').val(row.clntCd);
			$('#mkerNm').val(row.clntNm);
			$('#mkerDiv').val('MAKERDIV20');
			$('#mkerDivNm').val('외작');
			$('#PlanMkerNm').css('display', 'inline');
		});
	}


	// 제작사 검색
	function savePlanMkerNm() {
		var formData = new FormData();
		formData.append("mkerCd", $("#popForm #mkerCd").val());
		formData.append("fileTrgtKey", $("#popForm #fileTrgtKey").val());
		formData.append("userId", $("#popForm #userId").val());
		formData.append("pgmId", $("#popForm #pgmId").val());
		filePostAjax("/user/wb/wb21/planMkerCdChange", formData, function(data){
			if(data.resultCode == 200){
				$('#PlanMkerNm').css('display', 'none');

			} else {
				alert("외부제작업체 수정 오류입니다.!!!");
			}
		});
	}


	// 제작사 clear
	function removePlanMkerNm() {
		if ($('#mkerNm').val() =="") {
			 $('#PlanMkerNm').css('display', 'none');
			 $('#mkerDiv').val('MAKERDIV10');
			 $('#mkerDivNm').val('내작');
			$('#mkerCd').val('');
			$('#mkerNm').val('');
			$('#PlanMkerNm').css('display', 'inline');
		}
	}

	function updateWbsChanges() {
		// 그리드에서 변경된 데이터만 필터링 (수정된 행을 찾아낸다)
		var changedData = gridView1.target.getList().filter(function(row) {
			return row.__modified__;  // 수정된 행만 반환
		});

		if (changedData.length === 0) {
			alert('변경된 내용이 없습니다.');
			return;  // 변경된 데이터가 없으면 함수 종료
		}

		// FormData 객체 생성
		var formData = new FormData();

		// 기본 필드 추가 (회사 코드, SALES 코드 등)
		formData.append("coCd", $('#coCd').val());
		formData.append("salesCd", $('#salesCd').val());

		// 필요한 데이터만 추출 (필터링 후 배열로)
		var filteredData = changedData.map(function(row) {
			return {
				coCd: row.coCd,
				salesCd: $('#salesCd').val(),
				fileTrgtKey: row.fileTrgtKey,
				chgReason: row.chgReason
			};
		});

		// 변경된 데이터를 JSON으로 변환하여 추가
		formData.append("changedData", JSON.stringify(filteredData));

		filePostAjax("/user/wb/wb22/updateWbsChanges", formData, function(data) {
			if (data.resultCode == 200) {
				gridView1.setData(0);
			} else {
				alert(data.resultMessage);
			}
		});
	}
	
	
	function onPlanExceptChange(value){
		
		
		
		$("#popForm #btn1").show();
		//alert($("#popForm #fileTrgtKey").val());
		sjVerUpMakeFromData();
		var rowList = gridView1.target.getList();
		if (value != 'PLANEXCEPT01') {
			$.each(rowList, function(idx, elem) {
				if (["WBSCODE11", "WBSCODE12", "WBSCODE13", "WBSCODE14"].includes(elem.wbsPlanCodeId)) {
					
					
					//console.log(elem);
					elem.wbsPlanMngId = "";
					elem.wbsPlanMngNm = "";
					elem.daycnt = "";
					elem.wbsPlansDt = "";
					elem.wbsPlaneDt = "";
				}
			});
			gridView1.target.setData(rowList);
			
		}	
	}
	
	function createWb21VerUp() {
		
		
		var planExcept = $('#popForm #planExcept').val();
	
		if(lastPlanExcept==planExcept){
			
			return;
			
		}	
		
		
		var planData = {
			"coCd" : $("#popForm #coCd").val(),
			"sjNo" : $("#popForm #sjNo").val(),
			"salesCd" : $("#popForm #salesCd").val(),
		};
		var newVerNo;
		var aftCnt;
		var aftText = "";
		postAjaxSync("/user/wb/wb21/selectSjVerNoNext", planData, null, function(data) {
			newVerNo = data.result[0].verNo
			aftCnt = data.result[0].aftCnt
		});

		if(aftCnt > 0) {
			aftText = "\n진행중인 WBS계획이 있습니다!\n버전 변경 시 확정 전까지 일정수정이 불가합니다!";
		}

		
			$("#verNo").val(newVerNo);
				var codeId = null;
				var formData = sjVerUpMakeFromData();
				
				
				 filePostAjax("/user/wb/wb21/sjVerUpInsert", formData, function(data) {
					//alert(data.resultMessage);
					if (data.resultCode == 200) {
						var salesCd = $("#popForm #salesCd").val();
						var verNo = $("#popForm #verNo").val();
						fileTrgtKey = data.fileTrgtKey;
						lastPlanExcept = planExcept;
						$('.popup_area #confirm').show();
						return;
					} else {
						alert("예외사항 변경 작업 실패했습니다." + data );
						return;
					}
				}); 

		
	}
	
	function sjVerUpMakeFromData(){
		
		
		var formData = new FormData($("#popForm")[0]);
		var paramData = {
				"fileTrgtKey" : $("#popForm #fileTrgtKey").val()
			};
		
		
		postAjaxSync("/user/wb/wb21/selectSjInfo", paramData, null, function(data) {
			
			const resultList = data.resultList;
			for (let key in resultList) {
				  if (resultList.hasOwnProperty(key)) {
				    const value = resultList[key];
				    formData.append(key, value);
				  }
				}
				if (!formData.has("sjRmk")) {
					  formData.append("sjRmk", null);  // 또는 '', '없음', etc.
					}

		});
		
		formData.append("fileTrgtKey", fileTrgtKey);
		formData.append("verNo", $("#verNo").val());
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
        formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용

        var fileUploadArr = [];
        var tempArr = [];
        tempArr = treeModule.getFileArr();
        $.each(tempArr, function(idx, obj) {
            if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
            }
        });
		
        formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));

		return formData;
		
		
		
	}
	
	function wbsLevel1Submit(flag,list){
		
		
		var row = gridView1.target.getList()[0];
		var rowList = gridView1.target.getList();
		if (list){
			
			row = list[0];
			rowList = list;
		}
		if (row != undefined && row.fileTrgtKey != undefined) {
			if (flag == "N") {
				// Validation 체크
				if (row.closeYn == "N") {
					alert("미확정된 상태입니다.");
					return;
				}
				/////////////////

				if(confirm("미확정하시겠습니까?")){
					var formData = new FormData();
					//var rowList = gridView1.target.getList();
					if(rowList.length > 0) {
						var rowListArr = [];
						$.each(rowList, function(idx, elem){
							if (elem.fileTrgtKey != undefined) {
								var rowListObj = elem;
								rowListObj["coCd"] = elem.coCd;
								rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
								rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
								rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
								rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
								rowListObj["salesCd"] = elem.salesCd;
								rowListObj["verNo"] = elem.verNo;
								rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
								rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
								rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
								rowListObj["daycnt"] = elem.daycnt;
								rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
								rowListObj["flag"] = flag;
								rowListObj["creatId"] = jwt.userId;
								rowListObj["creatPgm"] = "WB2201M01";
								rowListArr.push(rowListObj);
							}
						});
						formData.append("rowListArr", JSON.stringify(rowListArr));
					}

					filePostAjax("/user/wb/wb22/wbsLevel1confirm", formData, function(data){
						if(data.resultCode == 200){
// 							alert("미확정 되었습니다.");
							gridView1.setData(0);
						} else {
							alert("오류가 있습니다.\n" + data.resultMessage);
						}
					});
				}
			} else {
				// Validation 체크
				if (flag == "Y" && row.closeYn == "Y") {
					alert("확정된 상태입니다.");
					return;
				}
				/////////////////

				if(confirm("확정하시겠습니까?")){
					var formData = new FormData();
					//var rowList = gridView1.target.getList();
					if(rowList.length > 0) {
						var rowListArr = [];
						$.each(rowList, function(idx, elem){
							if (elem.fileTrgtKey != undefined) {
								var rowListObj = elem;
								rowListObj["coCd"] = elem.coCd;
								rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
								rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
								rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
								rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
								rowListObj["salesCd"] = elem.salesCd;
								rowListObj["verNo"] = elem.verNo;
								rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
								rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
								rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
								rowListObj["daycnt"] = elem.daycnt;
								rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
								rowListObj["flag"] = flag;
								rowListObj["creatId"] = jwt.userId;
								rowListObj["creatPgm"] = "WB2201M01";
								rowListArr.push(rowListObj);
							}
						});
						formData.append("rowListArr", JSON.stringify(rowListArr));
					}
								
					 filePostAjax("/user/wb/wb22/wbsLevel1confirm", formData, function(data){ 
						if(data.resultCode == 200){
// 							alert("확정 되었습니다.");
							makeFormData();
							kakaoTodo_wbs22();
							gridView1.setData(0);
						} else {
							alert("오류가 있습니다.\n" + data.resultMessage);
						}
					}); 
				}
			}
		}
		
		
	}
	
	function getGrid1RowList(){
		var formData = {
				"coCd" : coCd,
				"salesCd" : salesCd,
				"beginDt" : $('#beginDt').val(),
				"acptncDt" : $('#acptncDt').val(),
				"reqreDaycnt" : $('#reqreDaycnt').val(),
				"planVerNo" : planVerNo,
				"userId" : $('#smrizeId').val(),
				"histYn" : histYn
			}
			var ajaxUrl;	
				ajaxUrl = "/user/wb/wb22/selectWBS1Level";
		
		
		postAjax(ajaxUrl, formData, null, function(data){
			try {
				var list = data.fileList;
				var i = 0;
				$.each(list, function(idx, obj){
					list[i].daycnt = calculateCalendarCnt(obj.wbsPlansDt, obj.wbsPlaneDt);
					i++;
				});
				
				
				wbsLevel1Submit('Y',list);
				//gridView1.setData(0);
			} catch (error) {
				alert("오류 발생!! 전산실 연락 바랍니다", error.message);
				return null; // 오류 발생 시 null 반환
			} finally {
				// console.log("함수 실행 완료.");
			}
		});
	}

	// 버전업 사유를 입력받는 프롬프트 생성
	async function verUpReason(preVer , defaultReason ="") {
		const result  = customPrompt(
			`Ver Up 사유를 입력해주세요.`,
			defaultReason ,
			`Ver.${preVer}에 대한 변경 사유`
			
		);
		// customPrompt 최소 사이즈 변경
		requestAnimationFrame(() => {
			const $dlg = $('#custom-prompt-overlay > div').first();
			if ($dlg.length) {
				$dlg.css('min-width', '350px'); // 최소 가로 크기 지정
			}
		});
		
		return await result;
	}

	// 캘린더 데이 계산 함수 (종료일 - 시작일)
	function calculateCalendarCnt(startDate, endDate) {
		if (!startDate || !endDate) return 0;

		const toUTC = (d) => {
			if (d instanceof Date) {
				return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
			}
			if (typeof d === 'string') {
				const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(d);
				if (!m) return NaN;
				return Date.UTC(+m[1], +m[2] - 1, +m[3]);
			}
			return NaN;
		};

		const startDay = toUTC(startDate);
		const endDay   = toUTC(endDate);
		if (!Number.isFinite(startDay) || !Number.isFinite(endDay)) return NaN;

		if (endDay < startDay) return 0; // 역순 보호

		return Math.floor((endDay - startDay) / 86400000) + 1; // 양끝 포함
	}
	
</script>
