<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">

<script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
<script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
<script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5calendar.min.js"></script>
<script src="/static/js/ax5/ax5picker.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script src="/static/js/ax5/ax5formatter.min.js"></script>
<script src="/static/js/ax5/ax5combobox.min.js"></script>
<script src="/static/js/ax5/ax5select.min.js"></script>
<script src="/static/js/exceljs.min.js"></script>

<script type="text/javascript" src="/static/js/global.js"></script>
<script type="text/javascript" src="/static/js/fileTree.js"></script>
<script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
<script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="/static/js/jquery.blockUI.js"></script>

<!-- 도움말 팝업 -->
<script src="/static/js/manualPopup.js"></script>

</head>

<body>
    <div id="head_area"></div>
	<div id="top_area"></div>
    <div id="main_area">
        <!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="salesGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div>

        <!-- 검색 콘텐츠 -->
		<div class="contents search">
            <div class="">
                <!-- 테이블 인풋 3분할 -->
				<table class="table_input type04">
                    <!-- 검색조건 1행 -->
                    <tr>
                        <th class="hit" style="width:80px;">회사</th>
                        <td style="width:200px;">
                            <select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사" onChange="salesGridView.setData(0);changeCocd();">

                            </select>
                        </td>
                        <th style="width:100px;">시작일</th>
                        <td>
                            <div style="width:400px;">
                                <input type="text" class="input_calendar" id="beginDt_S" name="beginDt_S" data-search="beginDt_S" autocomplete="off" date data-search="beginDt" onkeyup="dateMask(this);">
                                <span>~</span>
                                <input type="text" class="input_calendar" id="deDt_S" name="deDt_S" data-search="deDt_S"  autocomplete="off" date data-search="deDt" onkeyup="dateMask(this);">
                            </div>
                        </td>

                        <th >과제명</th>
                        <td style="width:260px;">
                            <input type="text" id="sjNm_S" name="sjNm_S" data-search="sjNm" onChange="salesGridView.setData(0);">
                        </td>
                        <th style="width:100px;">계획확정</th>
                        <td>
                            <select id="closeYn_S" name="closeYn_S" data-search="closeYn" onChange="salesGridView.setData(0);">
                                <option value="" selected>전체</option>
                                <option value="Y">확정</option>
                                <option value="N">미확정</option>
                            </select>
                        </td>
                    </tr>

                    <!-- 검색조건 2행 -->
                    <tr>

                        <th class= "hit" style="width:90px;">Sales Code</th>
                        <td style="width:200px;">
                            <div class="search_form">
                                <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? salesGridView.setData(0) : ''">
                                <a onclick="wbsSalesCodeSearch('S');"><i class="i_search_w"></i></a>
                            </div>
                            <input type="hidden" id="salesNm_S" name="salesNm_S">
                        </td>

                        <th>고객사PJT</th>
                        <td>
                            <select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt" onchange="salesGridView.setData(0);">
                                <option value="">전체</option>
                            </select>
                        </td>
                        <th class="">고객사</th>
                        <td>
                            <input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
                            <div class="search_form">
                                <input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm" onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? opendClntSearch(this.value) : ''">
                                <a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
                            </div>
                        </td>

                        <th style="width:100px;">이력보기</th>
                        <td>
                            <select id="histYn_S" name="histYn_S" data-search="closeYn" onChange="salesGridView.setData(0);">
                                <option value="N">계획버전</option>
                                <option value="">이력포함</option>
                            </select>
                        </td>
                    </tr>
                    <!-- 검색조건 END -->
                </table>
                <input type="hidden" id="userId" name="userId">
                <input type="hidden" id="pgmId"  name="pgmId" value="WB2201M02">
            </div>
        </div>

        <div class="contents no_bg">
            <div class="contents_tit">
                <div class="add_btn_small pdl10">
					<a onclick="qr_generation();" style="height: 30px; line-height: 28px; width: 100px;">QR생성</a>
                    <a id="wb22confirmBtn" onclick="wb22confirmSearch();" style="height: 30px; line-height: 28px; width: 90px;">일괄확정</a>
                    <a id="wbsPlanInsertModal" onclick="wbsPlanInsertModal();" style="height: 30px; line-height: 28px; width: 100px;">WBS계획등록</a>
                    <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
                </div>

                <select id="recordCnt" class="prae_select" onchange="salesGridView.setData(0);">
                    <option value="25" >25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="9999999" selected>전체</option>
                </select>
            </div>

            <div class="contents" style="margin: 0px; padding: 0px; height: 100%; width: 100%; min-width: 750px;">
                <div class="ax5_grid" data-ax5grid="sales-grid" data-ax5grid-config="{}" style="width: 100%; height: 725px;"></div>
                <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
            </div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
    var isFirst = true;
    var coCd = null;
    var salesCd = null;

    ax5.ui.grid.formatter["chkYn"] = function () {
        var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
        if (this.value == "E") {
            return ' ';
        } else {
            return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
        }
    };

	function salesGridColor(dataValue) {
		let rtnColor = "";
		let row = dataValue.item;

		if (row.histYn == "Y") {
			rtnColor = "grid-cell-orange";
		} else  {
			rtnColor = "";
		}

		return rtnColor;
	}
    var salesGridView = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: true,
                sortable          : true,
                target: $('[data-ax5grid="sales-grid"]'),
                header : {
                    align : "center",
                    selector : true
                },
                body: {
                    mergeCells : ["clntNm","ordrsNo","clntPjtNm","sjNm"],
                    columnHeight: 26,
                    onClick: function () {
//                         var list = salesGridView.target.getList("selected");
//                         $.each(list, function(idx, obj) {
//                             salesGridView.target.select(obj.__origin_index__, {selected: false});
//                         });
						salesGridView.target.clearSelect();
                        this.self.select(this.doindex);
                        coCd = this.item.coCd;
                        salesCd = this.item.salesCd;
                    },
                    onDBLClick: function () {
//                         var list = salesGridView.target.getList("selected");
//                         $.each(list, function(idx, obj) {
//                             salesGridView.target.select(obj.__origin_index__, {selected: false});
//                         });

						salesGridView.target.clearSelect();
                        this.self.select(this.doindex);
                        coCd = this.item.coCd;
                        salesCd = this.item.salesCd;
                        wbsPlanInsertModal();
                    },
                    onDataChanged: function () {

                    }
                },
                columns: [
                    {key: "clntNm",           label: "고객명",           width: 140,  align: "left"},
                    {key: "ordrsNo",          label: "수주번호",          width: 70,  align: "center", hidden: false},
                    {key: "clntPjtNm",        label: "PJT",     	width: 80,  align: "center"},
                    {key: "sjNo",             label: "과제번호",          hidden:true},
                    {key: "sjNm",             label: "과제명",           width: 280,   align: "left"},
                    {key: "salesCd",          label: "SALES CODE",     width: 120,   align: "center", styleClass: function () {return salesGridColor(this);}},
                    {key: "ordrsDivNm",       label: "수주구분",     	   width: 80,   align: "center", styleClass: function () {return salesGridColor(this);}},
	    		    {key : undefined, label : "일정계획", columns: [
	                    {key: "planCloseYn",      label: "확정",   	width: 60,   align: "center", formatter: "chkYn", styleClass: function () {return salesGridColor(this);}},
	                    {key: "planVerNo",        label: "Ver.",    width: 60,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "verUpReason",      label: "Ver.Up사유",    width: 100,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                ]},
                    {key: "histYn",           label: "이력여부",          width: 60,   align: "center",hidden:true},
                    {key: "planCodeCnt",      label: "1레벨 계획수량",  hidden:true},
	    		    {key : undefined, label : "제작", columns: [
	                    {key: "mkerDivNm",        label: "구분",       width: 60,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "mkerDiv",          label: "제작구분",         hidden:true},
	                    {key: "mkerCd",           label: "제작처코드",        hidden:true},
	                    {key: "mkerNm",           label: "업체",       width: 100,   align: "left", styleClass: function () {return salesGridColor(this);}},
		            ]},
                    {key: "smrizeId",         label: "총괄PM",        hidden:true},
                    {key: "smrizeNm",         label: "총괄PM",       width: 70,   align: "center", styleClass: function () {return salesGridColor(this);}},
                    {key: "ordrsQty",   	  label: "대수",       width: 60,   align: "center", styleClass: function () {return salesGridColor(this);}},
                    {key: "sjRmk",            label: "비고",       hidden:true},
	    		    {key : undefined, label : "과제 계획 일정", columns: [
                    	{key: "verNo",            label: "Ver.",          width: 60,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "beginDt",          label: "시작일",       width: 80,  align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "deDt",             label: "출고일",       width: 80,  align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "acptncDt",         label: "완료검수일",    width: 80,  align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "reqreDaycnt",      label: "소요일",       width: 60,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "dsgnDifCodeId",    label: "설계난이도",       hidden:true},
	                    {key: "dsgnDifCodeNm",    label: "설계난이도",       width: 80,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "dsgnPlanHour",     label: "설계공수",       width: 80,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "prdctnDifCodeId",  label: "생산난이도",       hidden:true},
	                    {key: "prdctnDifCodeNm",  label: "생산난이도",       width: 80,   align: "center", styleClass: function () {return salesGridColor(this);}},
	                    {key: "prdctnPlanHour",   label: "생산공수",       width: 80,   align: "center", styleClass: function () {return salesGridColor(this);}},
	    		    ]},
                    {key: "sjCloseYn",        label: "과제확정",       width: 60,   align: "center", formatter: "chkYn",  hidden:true},
	    		    {key : undefined, label : "계획일정", columns: [
		    		       {key: "wbscode01",	   label: "수주확정",		    width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode02",	   label: "목표원가및PFU",     width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode03",	   label: "설계완료",			width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode17",	   label: "모델링완료",		width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode04",	   label: "구매완료",		    width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode18",	   label: "제품(샘플)공급완료",	width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode05",	   label: "기계조립완료",	    width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode06",	   label: "전기완료",	        width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode07",	   label: "자체시운전완료",		width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
// 			    		   {key: "wbscode08",	   label: "조건작업완료",	    width: 140,	sortable: false, 	align: "center", styleClass: function () {return gridColor(this);}},
			    		   {key: "wbscode16",	   label: "외부제작검수",	    width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode09",	   label: "고객검수",		    width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode10",	   label: "포장",			width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode11",	   label: "출고",		    width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode12",	   label: "도착",	        width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode13",	   label: "설치시운전(출발일)",  width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
			    		   {key: "wbscode14",	   label: "설치시운전(복귀일)",	width: 140,	sortable: false, 	align: "center", styleClass: function () {return salesGridColor(this);}},
	    		    ]},
                    {key: "fileTrgtKey",      	label: "FLIE TRGT KEY",    hidden:true},
                    {key: "insertUpdateId",     label: "등록/수정 담당자", hidden:true},
                    {key: "insertUpdateNm",     label: "등록/수정 담당자",width: 100, align: "center", sortable: false, styleClass: function () {return salesGridColor(this);}},
                    {key: "insertUpdateDttm",   label: "등록/수정 일자", width: 90, align: "center", sortable: false, styleClass: function () {return salesGridColor(this);}}
                ],
                page : {
                    navigationItemCount: 10,
                    height: 30,
                    display: true,
                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange: function () {
                        salesGridView.setData(this.page.selectPage);
                    }
                },
            });
            return this;
        },
        setData : function(_pageNo) {
            if (isFirst) return;
            var targetObj = this.target;
            var paramObj = {
                "coCd": $('#coCd_S').val(),
                "salesCd": $('#salesCd_S').val(),
                "beginDt": $('#beginDt_S').val(),
                "ordrsClntNm": $('#ordrsClntNm_S').val(),
                "clntPjt": $('#clntPjt_S').val(),
                "deDt": $('#deDt_S').val(),
                "sjNm": $('#sjNm_S').val(),
                "closeYn": $('#closeYn_S').val(),
                "pageNo" : _pageNo + 1,
                "recordCnt": $('#recordCnt').val(),
                "histYn": $('#histYn_S').val()
            };
            postAjax("/user/wb/wb22/selectWbsSjList", paramObj, null, function(data) {
                try {
                    var list = data.fileList;
                    targetObj.setData({
                        list : list,
                        page : {
                            currentPage   : _pageNo,
                            pageSize      : data.paginationInfo.pageSize,
                            totalElements : data.paginationInfo.totalRecordCount,
                            totalPages    : data.paginationInfo.totalPageCount
                        }
                    });
                    gridHeightResize(salesGridView, 194); // 194 = 919 - 725 : 화면 Body 높이 - 그리드 기본크기 725
                } catch (error) {
                    alert("오류 발생!! 전산실 연락 바랍니다", error.message);
                    return null; // 오류 발생 시 null 반환
                } finally {
                    // console.log("함수 실행 완료.");
                }
            });
        }
    }

    var excelView = {
        initView: function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                target: $('[data-ax5grid="excel-grid"]'),
                columns: [
                    {key: "clntNm",           label: "고객명",           width: 160,  align: "left"},
                    {key: "clntPjtNm",        label: "고객사 프로젝트명",     width: 100,  align: "center"},
                    {key: "sjNm",             label: "과제명",           width: 280,   align: "left"},
                    {key: "salesCd",          label: "SALES CODE",     width: 120,   align: "center"},
                    {key: "ordrsDivNm",       label: "수주구분",     	   width: 80,   align: "center"},
                    {key: "ordrsQty",   	  label: "대수",       width: 60,   align: "center"},
                    {key: "verNo",            label: "과제Ver.",          width: 60,   align: "center"},
                    {key: "planCloseYn",      label: "계획확정",   width: 60,   align: "center"},
                    {key: "planVerNo",        label: "계획Ver.",          width: 60,   align: "center"},
                    {key: "verUpReason",      label: "Ver.Up사유.",          width: 60,   align: "center"},
                    {key: "mkerDivNm",        label: "제작구분",       width: 60,   align: "center"},
                    {key: "mkerNm",           label: "제작처",       width: 160,   align: "left"},
                    {key: "smrizeNm",         label: "총괄PM",       width: 80,   align: "center"},
                    {key: "beginDt",          label: "시작일",       width: 80,   align: "center"},
                    {key: "deDt",             label: "출고일",       width: 80,   align: "center"},
                    {key: "acptncDt",         label: "완료검수일",       width: 80,   align: "center"},
                    {key: "reqreDaycnt",      label: "소요일수",       width: 60,   align: "center"},
                    {key: "dsgnDifCodeNm",    label: "설계난이도",       width: 80,   align: "center"},
                    {key: "dsgnPlanHour",     label: "설계계획공수",       width: 80,   align: "center"},
                    {key: "prdctnDifCodeNm",  label: "생산난이도",       width: 80,   align: "center"},
                    {key: "prdctnPlanHour",   label: "생산계획공수",       width: 80,   align: "center"},
	    		    {key : undefined, label : "계획일정", columns: [
		    		       {key: "wbscode01",	   label: "수주확정",		    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode02",	   label: "목표원가및PFU",     width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode03",	   label: "설계완료",			width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode17",	   label: "모델링완료",		width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode04",	   label: "구매완료",		    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode18",	   label: "제품(샘플)공급완료",	width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode05",	   label: "기계조립완료",	    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode06",	   label: "전기완료",	        width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode07",	   label: "자체시운전완료",		width: 140,	sortable: false, 	align: "center"},
// 			    		   {key: "wbscode08",	   label: "조건작업완료",	    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode16",	   label: "외부제작검수",	    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode09",	   label: "고객검수",		    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode10",	   label: "포장",			width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode11",	   label: "출고",		    width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode12",	   label: "도착",	        width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode13",	   label: "설치시운전(출발일)",  width: 140,	sortable: false, 	align: "center"},
			    		   {key: "wbscode14",	   label: "설치시운전(복귀일)",	width: 140,	sortable: false, 	align: "center"},
	    		    ]},
                ]
            });
            return this;
        }
    }

	$(document).ready(function() {
		mainDefaultLoad("실행계획", "일정계획관리");          // 페이지 타이틀 설정
		setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set

		isFirst = false;

		$("#coCd_S").val(jwt.coCd);

		// 시작일 (현재날짜의 이전월 첫일)
		const now = moment().startOf("month");
		var beDay = now.add(-2, "M").format("YYYY-MM-DD");
		$('#beginDt_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
//         .datepicker("setDate", moment(new Date()).startOf("year").toDate())
		.datepicker("setDate", beDay)
		.on("changeDate", function() {
			if($('#beginDt_S').val() > $('#deDt_S').val()) {
				customAlert("날짜를 확인해주세요");
				$('#deDt_S').datepicker("setDate", new Date($('#beginDt_S').val()));
			}
			salesGridView.setData(0);
		});

		// 종료일 (현재날짜의 월 말일)
		$('#deDt_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate",  moment(new Date()).endOf("month").toDate())
		.on("changeDate", function() {
			if($('#beginDt_S').val() > $('#deDt_S').val()) {
				customAlert("날짜를 확인해주세요");
				$('#beginDt_S').datepicker("setDate", new Date($('#deDt_S').val()));
			}
			salesGridView.setData(0);
		});

		salesGridView.initView().setData(0);

		excelView.initView();

		//권한체크
		authChk();
	});

    // 초기화 버튼용
    function initSearch() {
        $('[data-search]').off("change");   //바인딩기능 오프
        $('.contents.search select, .contents.search input').val("");
        $("#beginDt_S").val(dateToStr(moment(new Date()).startOf("month").toDate()));
        $("#deDt_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
        $("#coCd_S").val(jwt.coCd);

        salesGridView.initView().setData(0);
    }

    function excelDown() {
        var paramObj = {
            "coCd": $('#coCd_S').val(),
            "salesCd": $('#salesCd_S').val(),
            "beginDt": $('#beginDt_S').val(),
            "deDt": $('#deDt_S').val(),
            "sjNm": $('#sjNm_S').val(),
            "closeYn": $('#closeYn_S').val(),
            "recordCnt": 99999999,

            "ordrsClntNm": $('#ordrsClntNm_S').val(),
            "clntPjt": $('#clntPjt_S').val(),
            "histYn": $('#histYn_S').val()
        };
        postAjax("/user/wb/wb22/selectWbsSjList", paramObj, null, function(data) {
            var list = data.fileList;
            excelView.target.setData({
                list : list,
                page : {
                    totalElements : list.length,
                }
            });
            var todayDate = new Date().format('yyyyMMddHHmmss');
            excelView.target.exportExcel("WBS_일정계획 리스트"+todayDate+".xls");
        });
    }

    function wbsPlanInsertModal() {
        var row = salesGridView.target.getList("selected")[0];
        if (row != undefined && row.salesCd != undefined) {
            var paramObj = {
                "coCd": row.coCd,
                "salesCd": row.salesCd,
                "planVerNo": row.planVerNo,
                "histYn": row.histYn,
            };
            openModal("/static/html/user/wb/wb22/WB2201P01.html", 1200, 900, "WBS 계획등록", paramObj, function () {
                salesGridView.setData(0);
            });
            // //if (row.smrizeId == jwt.userId || row.smrizeId == jwt.userId) {
			// 	 var paramObj = {"coCd": row.coCd,
            //              "salesCd": row.salesCd,
            //              "planVerNo": row.planVerNo,
            //              "histYn": row.histYn,
            //             };
		    //      openModal("/static/html/user/wb/wb22/WB2201P01.html", 1200, 900, "WBS 계획등록", paramObj, function (){
		    //      });
			// //}
			// //else {
			// //	alert("선택한 과제의 담당자만 등록이 가능합니다.");
	        // //    return;
			// //}
        } else {
            alert("SALES CODE을 선택하세요");
        }
    }

    function wbsSalesCodeSearch() {
        var paramObj = {
            "coCd" : $('#coCd_S').val(),
            "salesCd": $('#salesCd_S').val()
        };
        openModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#salesCd_S').val(row.salesCd);
            salesGridView.setData(0);
        });
    }

    // 거래처 검색 함수
    function opendClntSearch(inputValue) {
        var paramObj = {
            "searchValue" : inputValue,
            "clntDivCd"   : "CLNTDIV12"
        };
        openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
            var row = grid.target.getList("selected")[0];
            $('#ordrsClntCd_S').val(row.clntCd);
            $('#ordrsClntNm_S').val(row.clntNm);
            salesGridView.setData(0);
        });
    }

    function wb22confirmSearch() {
        var paramObj = {};
        var row = salesGridView.target.getList("selected")[0];
        if (row != undefined) {
            // 리스트 선택 시
            paramObj["coCd"] = $('#coCd_S').val();
            // paramObj["searchValue"] = row.smrizeNm;
            paramObj["searchValue"] = jwt.userNm;
            paramObj["pgmId"] = "WB2201M02";
        } else {
            // 리스트 미 선택 시
            paramObj["coCd"] = $('#coCd_S').val();
            paramObj["searchValue"] = jwt.userNm;
            paramObj["pgmId"] = "WB2201M02";
        }
        openModal("/static/html/cmn/modal/wb22confirmSearch.html", 1200, 650, "일괄확정 대상 검색", paramObj, function (grid) {
            salesGridView.setData(0);
        });
    }

    //회사 변경시 과제등록 기능 잠금
    function changeCocd() {
        if($("#coCd_S").val() == jwt.coCd) {
            $("#wbsPlanInsertModal").show();
        } else {
            $("#wbsPlanInsertModal").hide();
        }
    }

	function qr_generation() {
		var selectedRows = salesGridView.target.getList("selected");
		var salesCd      = selectedRows.map(r => r.salesCd);
		var sjNm         = selectedRows.map(r => r.sjNm);

		if (!salesCd.length) {
			alert("먼저 하나 이상의 SALES CODE를 선택해주세요.");
			return;
		}

		// QR 설정
		const QR_W      = 200;  // 한 QR 가로/세로
		const GAP_X     = 40;   // 열 간격
		const GAP_Y     = 20;   // 행 간격
		const BASE_W    = 400;  // 1개일 때 최소 팝업 너비
		const HEADER_H  = 180;  // 제목+패딩+닫기영역 높이 대략
		const maxCols   = 4;

		// 열 수, 너비 계산
		const cols      = Math.min(salesCd.length, maxCols);
		const extraCols = cols - 1;
		const popupW    = BASE_W + (extraCols > 0 ? extraCols * (QR_W + GAP_X) : 0) - 20*extraCols;

		// 행 수, 높이 계산 (최대 2행까지)
		const rows      = Math.ceil(salesCd.length / maxCols);
		const useRows   = Math.min(rows, 2);
		const popupH    = HEADER_H
							+ QR_W * useRows
							+ GAP_Y * (useRows - 1) + 110*(useRows - 1);

		var paramObj = {
			"salesCd" 	: salesCd,
			"sjNm"		: sjNm
		}
		openModal("/static/html/cmn/modal/qrGeneration.html", popupW, popupH, "QR 코드 생성", paramObj, function(data) {
		});
	}

</script>