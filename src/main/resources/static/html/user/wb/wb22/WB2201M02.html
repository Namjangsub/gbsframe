<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5select.css">
    <link rel="stylesheet" href="/static/css/jstree/style.min.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
    <link rel="stylesheet" href="/static/css/gnb.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/sub.css">
    <link rel="stylesheet" href="/static/css/common.css">

    <script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
    <script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
    <script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" ></script>
    <script type="text/javascript" src="/static/js/global.js"></script>
    <script type="text/javascript" src="/static/js/fileTree.js"></script>
    <script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
    <script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>

    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-calendar/master/dist/ax5calendar.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-picker/master/dist/ax5picker.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-menu/master/dist/ax5menu.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-formatter/master/dist/ax5formatter.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-combobox/master/dist/ax5combobox.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-select/master/dist/ax5select.min.js"></script>

	<!-- 도움말 팝업 -->
	<script src="/static/js/manualPopup.js"></script>
	
</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	
	<div id="main_area">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="salesGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div>
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 3분할 -->
				<table class="table_input type04">
				
					<!-- 검색조건 1행 -->
					 <tr>
                        <th class="hit" style="width:80px;">회사</th>
                        <td style="width:200px;">
                           <select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사" onChange="salesGridView.setData(0);">
                           </select>
                        </td>
                        <th class="">고객사</th>
						<td>
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm" onkeyup="event.keyCode == 8 ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? DataSearch() : ''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>고객사PJT</th>
						<td>
                            <select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt" onchange="salesGridView.setData(0);">
								<option value="">전체</option>
							</select>
						</td>
                        <th class= "hit" style="width:90px;">Sales Code</th>
                        <td style="width:200px;">
                            <div class="search_form">
                                <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? salesGridView.setData(0) : ''">
                                <a onclick="wbsSalesCodeSearch('S');"><i class="i_search_w"></i></a>
                            </div>
                            <input type="hidden" id="salesNm_S" name="salesNm_S" >
                        </td>
                    </tr>
                    <!-- 검색조건 2행 -->
					<tr>
						<th style="width:100px;">시작일</th>
                        <td >
                        <div style="width:400px;">
                          <input type="text" class="input_calendar" id="beginDt_S" name="beginDt_S" data-search="beginDt_S" autocomplete="off" date data-search="beginDt" >
                          <span>~</span>
                          <input type="text" class="input_calendar" id="deDt_S" name="deDt_S" data-search="deDt_S"  autocomplete="off" date data-search="deDt" >
                        </div>
                        </td>
                        <td>
                        </td>
                        <td>
                        </td>
                        <th >과제명</th>
                        <td style="width:260px;">
                        <input type="text" id="sjNm_S" name="sjNm_S" data-search="sjNm" onChange="salesGridView.setData(0);">
                        </td>   
                        <th style="width:100px;">계획확정</th>
                        <td>
                        <select id="closeYn_S" name="closeYn_S" data-search="closeYn" onChange="salesGridView.setData(0);">
                            <option value="" selected>전체</option>
                            <option value="Y">확정</option>
                            <option value="N">미확정</option>
                        </select>
                        </td>
					</tr>
		            <!-- 검색조건 END -->
	            </table>
	            <input type="hidden" id="userId"    name="userId">
                <input type="hidden" id="pgmId"     name="pgmId" value="WB2201M01">
            </div>
        </div>

    <div class="contents no_bg">
              <div class="contents_tit">
                <div class="add_btn_small pdl10">
                  <a onclick="wbsPlanInsertModal();" style="height: 30px; line-height: 28px; width: 100px;">WBS계획등록</a>
                  <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
                  
                </div>
                <select id="recordCnt" class="prae_select" onchange="salesGridView.setData(0);">
                  <option value="25" >25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="9999999" selected>전체</option>
                </select> 
    </div>
        
     <div class="contents" style="margin: 0px; padding: 0px; height: 100%; width: 100%; min-width: 750px;">
         <div class="ax5_grid" data-ax5grid="sales-grid" data-ax5grid-config="{}" style="width: 100%; height: 750px;"></div>
         <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>            
     </div>
    </div>		         
</body>
</html>

<script type="text/javascript">
 var isFirst = true;
 var coCd = null;
 var salesCd = null;

 ax5.ui.grid.formatter["chkYn"] = function () {
	    var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
	    if (this.value == "E"){
	        return ' ';
	    } else {
	        return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
	    }
	};
	var salesGridView = {
		    initView : function() {
		        this.target = new ax5.ui.grid();
		        this.target.setConfig({
		        	showRowSelector: true,
                    multipleSelect: true,
	                sortable          : false,
		            target: $('[data-ax5grid="sales-grid"]'),
		            header : {
		                align : "center",
		                selector : false
		            },
		            body: {
		            	mergeCells : ["clntNm","title", "sjNo","sjNm","salesCd"],
		            	columnHeight: 26,
		                onClick: function () {	
 		                	var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                                salesGridView.target.select(obj.__origin_index__, {selected: false});
                            });
		                	this.self.select(this.doindex);
		                	
		                	coCd = this.item.coCd;
		                	salesCd = this.item.salesCd; 
		                },
		                onDBLClick: function () {
		                	var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                                salesGridView.target.select(obj.__origin_index__, {selected: false});
                            });
                            this.self.select(this.doindex);
                            
                            coCd = this.item.coCd;
                            salesCd = this.item.salesCd; 
                            wbsPlanInsertModal();                            
		                },
		                onDataChanged: function () {
                        }
		           },
		           columns: [
		        	   {key: "clntNm",           label: "고객명",           width: 160,  align: "center"},                       
			       	   {key: "upperCd",          label: "상위코드",          hidden:true},
                       {key: "lowerCd",          label: "하위코드",          hidden:true},
                       {key: "coCd",             label: "회사코드",          hidden:true},
                       {key: "title",            label: "수주번호",          hidden:true },
                       {key: "ordrsNo",          label: "수주번호",          width: 80,  align: "center", hidden: false, treeControl: false},                       
			       	   {key: "clntCd",           label: "고객코드",          hidden:true},
			       	   {key: "clntPjt",          label: "고객사프로젝트",      hidden:true},
			       	   {key: "clntPjtNm",        label: "고객사 프로젝트명",     width: 130,  align: "center"},
			       	   {key: "sjNo",             label: "과제번호",          hidden:true},
			       	   {key: "sjNm",             label: "과제명",           width: 280,   align: "left"},
			       	   {key: "verNo",            label: "과제Ver.",          width: 60,   align: "center"},
			       	   {key: "sjCloseYn",        label: "과제확정",       width: 60,   align: "center", formatter: "chkYn",          hidden:true},
			       	   {key: "planCloseYn",      label: "계획확정",   width: 60,   align: "center", formatter: "chkYn"},
			       	   {key: "salesCd",          label: "SALES CODE",     width: 120,   align: "center"},
			       	   {key: "planVerNo",        label: "계획Ver.",          width: 50,   align: "center"},
			       	   {key: "planCodeCnt",      label: "1레벨 계획수량",  hidden:true},
			       	   {key: "mkerDiv",          label: "제작처 구분",        hidden:true},
			           {key: "mkerDivNm",        label: "제작처 구분",       width: 100,   align: "center"},
			           {key: "mkerCd",           label: "제작처코드",        hidden:true},
                       {key: "mkerNm",           label: "제작처",       width: 160,   align: "center"},
                       {key: "smrizeId",         label: "총괄PM",        hidden:true},
                       {key: "smrizeNm",         label: "총괄PM",       width: 80,   align: "center"},
                       {key: "beginDt",          label: "시작일",       width: 80,   align: "center"},
                       {key: "deDt",             label: "출고일",       width: 80,   align: "center"},
                       {key: "acptncDt",         label: "완료검수일",       width: 80,   align: "center"},
                       {key: "reqreDaycnt",      label: "소요일수",       width: 60,   align: "center"},
                       {key: "dsgnDifCodeId",    label: "설계난이도",       hidden:true},
                       {key: "dsgnDifCodeNm",    label: "설계난이도",       width: 80,   align: "center"},
                       {key: "dsgnPlanHour",     label: "설계계획공수",       width: 80,   align: "center"},
                       {key: "prdctnDifCodeId",  label: "생산난이도",       hidden:true},
                       {key: "prdctnDifCodeNm",  label: "생산난이도",       width: 80,   align: "center"},
                       {key: "prdctnPlanHour",   label: "생산계획공수",       width: 80,   align: "center"},
                       {key: "sjRmk",            label: "비고",       hidden:true},
                       {key: "fileTrgtKey",      label: "FLIE TRGT KEY",    hidden:true}
                       
		           ],
		           page : {
		        	   navigationItemCount: 10,
	                    height: 30,
	                    display: true,
	                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
	                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
	                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
	                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
	                    onChange: function () {
	                    	salesGridView.setData(this.page.selectPage);
	                    }
	                },
	                tree: {
	                	use: true,
                        indentWidth: 15,
                        arrowWidth: 15,
                        iconWidth: 18,
                        icons: {
                        	openedArrow        : '<i class="fa fa-caret-down"  aria-hidden="true"></i>',
                            collapsedArrow     : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                            groupIcon          : '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                            collapsedGroupIcon : '<i class="fa fa-folder"      aria-hidden="true"></i>',
                            itemIcon           : '<i class="fa fa-file"        aria-hidden="true"></i>'
                        },
                       columnKeys: {
                           parentKey: "upperCd",
                           selfKey: "lowerCd",
                       }
		           }
		        });
		        return this;
		    },
		    setData : function(_pageNo) {
		    	if (isFirst) return;
	            var targetObj = this.target;
    			var paramObj = {
    					"coCd": $('#coCd_S').val(),
    					"salesCd": $('#salesCd_S').val(),
    					"beginDt": $('#beginDt_S').val(),
    					"ordrsClntNm": $('#ordrsClntNm_S').val(),
    					"clntPjt": $('#clntPjt_S').val(),
    					"deDt": $('#deDt_S').val(),
    					"sjNm": $('#sjNm_S').val(),
    					"closeYn": $('#closeYn_S').val(),
    					"pageNo" : _pageNo + 1,
                        "recordCnt": $('#recordCnt').val()
    			};
	            postAjax("/user/wb/wb22/selectWbsSjList", paramObj, null, function(data){
	            	 var list = data.fileList;
	                    targetObj.setData({
	                        list : list,
	                        page : {
	                        	currentPage   : _pageNo,
	                            pageSize      : data.paginationInfo.pageSize,
	                            totalElements : data.paginationInfo.totalRecordCount,
	                            totalPages    : data.paginationInfo.totalPageCount
	                        }
	                    });
	            });
	        } 
		    
		}
	
	var excelView = {
            initView: function(){
            this.target = new ax5.ui.grid();
            this.target.setConfig({
            target: $('[data-ax5grid="excel-grid"]'),
            columns: [
            	 {key: "clntNm",           label: "고객명",           width: 130,  align: "left"},                       
                 {key: "upperCd",          label: "상위코드",          hidden:true},
                 {key: "lowerCd",          label: "하위코드",          hidden:true},
                 {key: "coCd",             label: "회사코드",          hidden:true},
                 {key: "ordrsNo",          label: "수주번호",          hidden:true},
                 {key: "title",            label: "수주번호",          width: 130,  align: "left", hidden: false, treeControl: true},
                 {key: "clntCd",           label: "고객코드",          hidden:true},
                 {key: "clntPjt",          label: "고객사프로젝트",      hidden:true},
                 {key: "clntNm",           label: "고객사프로젝트명",     width: 130,  align: "left"},
                 {key: "sjNo",             label: "과제번호",          width: 80,   align: "center"},
                 {key: "sjNm",             label: "과제명",           width: 200,   align: "left"},
                 {key: "verNo",            label: "과제버전",          width: 60,   align: "center"},
                 {key: "sjCloseYn",        label: "과제확정유무",       width: 80,   align: "center"},
                 {key: "salesCd",          label: "SALES CODE",     width: 120,   align: "center"},
                 /* {key: "planCodeCnt",      label: "WBS 1레벨 계획수량",  width: 130,   align: "center"}, */
                 {key: "planCloseYn",      label: "WBS 계획 마감",   width: 90,   align: "center"},
                 {key: "makerDiv",         label: "제작처 구분",        hidden:true},
                 {key: "makerDivNm",       label: "제작처 구분명",       width: 130,   align: "center"},
                 {key: "makerCd",          label: "제작처코드",        hidden:true},
                 {key: "makerNm",          label: "제작처명",       width: 130,   align: "center"},
                 {key: "smrizeId",         label: "총괄PM",        hidden:true},
                 {key: "smrizeNm",         label: "총괄PM",       width: 80,   align: "center"},
                 {key: "beginDt",          label: "시작일",       width: 80,   align: "center"},
                 {key: "deDt",             label: "출고일",       width: 80,   align: "center"},
                 {key: "actptncDt",        label: "완료검수일",       width: 80,   align: "center"},
                 {key: "reqreDaycnt",      label: "소요일수",       width: 80,   align: "center"},
                 {key: "dsgnDifCodeId",    label: "설계난이도",       hidden:true},
                 {key: "dsgnDifCodeNm",    label: "설계난이도",       width: 80,   align: "center"},
                 {key: "dsgnPlanHour",     label: "설계계획공수",       width: 80,   align: "center"},
                 {key: "prdctnDifCodeId",  label: "생산난이도",       hidden:true},
                 {key: "prdctnDifCodeNm",  label: "생산난이도",       width: 80,   align: "center"},
                 {key: "prdctnPlanHour",   label: "생산계획공수",       width: 80,   align: "center"},
                 {key: "sjRmk",            label: "비고",       width: 200,   align: "center"},
                 {key: "fileTrgtKey",      label: "FLIE TRGT KEY",    hidden:true}
               ]
            });
            return this;
        }
    }        
	
	$(document).ready(function() {

		 mainDefaultLoad("WBS", "일정계획관리");          // 페이지 타이틀 설정
		 setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set

		 isFirst = false;    
		 
		 $("#coCd_S").val(jwt.coCd);
		 
		 $('#beginDt_S').datepicker({
		        format : "yyyy-mm-dd",
		        language : "ko",
		        autoclose : true
		      })
		     .datepicker("setDate", moment(new Date()).startOf("month").toDate())
		     .on("changeDate", function(){
		         if($('#beginDt_S').val() > $('#deDt_S').val()){
		             alert("시작일과 출고일를 확인해주세요");
		             $('#beginDt_S').datepicker("setDate", new Date($('#deDt_S').val()));
		         }
		         salesGridView.setData(0);
		      });
		     
	     $('#deDt_S').datepicker({
	        format : "yyyy-mm-dd",
	        language : "ko",
	        autoclose : true
	      })
	     .datepicker("setDate",  moment(new Date()).endOf("month").toDate())
	     .on("changeDate", function(){
                 if($('#beginDt_S').val() > $('#deDt_S').val()){
                     alert("시작일과 출고일를 확인해주세요");
                     $('#beginDt_S').datepicker("setDate", new Date($('#deDt_S').val()));
                 }
                 salesGridView.setData(0);
              });
		     
		     
		 salesGridView.initView().setData(0);
		 
		 excelView.initView()
		 
		 
		 //권한체크
		 authChk();

		});
	// 초기화 버튼용
    function initSearch() {
        $('[data-search]').off("change");   //바인딩기능 오프
        $('.contents.search select, .contents.search input').val("");
        $("#beginDt_S").val(dateToStr(moment(new Date()).startOf("month").toDate()));
        $("#deDt_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
        $("#coCd_S").val(jwt.coCd);

        salesGridView.initView().setData(0);
    }
	
    function excelDown() {
    	var paramObj = {
                "coCd": $('#coCd_S').val(),
                "salesCd": $('#salesCd_S').val(),
                "beginDt": $('#beginDt_S').val(),
                "deDt": $('#deDt_S').val(),
                "sjNm": $('#sjNm_S').val(),
                "closeYn": $('#closeYn_S').val(),
                "recordCnt": 99999999
        };
        postAjax("/user/wb/wb22/selectWbsSjList", paramObj, null, function(data){
            var list = data.fileList;
            excelView.target.setData({
               list : list,
               page : {
                         totalElements : list.length,
               }
            });
            var todayDate = new Date().format('yyyyMMddHHmmss');
            excelView.target.exportExcel("WBS_일정계획 리스트"+todayDate+".xls");
         });   
    }       
    
	function wbsPlanInsertModal() {
		var row = salesGridView.target.getList("selected")[0];
		if (row != undefined && row.salesCd != undefined) {
			//if (row.smrizeId == jwt.userId || row.smrizeId == jwt.userId) {
				 var paramObj = {"coCd": row.coCd,
                         "salesCd": row.salesCd
                        };
		         openSecondModal("/static/html/user/wb/wb22/WB2201P01.html", 1200, 900, "WBS 계획등록", paramObj, function (){                    
		         });
			//}
			//else {
			//	alert("선택한 과제의 담당자만 등록이 가능합니다.");
	        //    return;
			//}
		}
		else {
            alert("SALES CODE을 선택하세요");
        }
	}
	
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd_S').val(),
           "salesCd": $('#salesCd_S').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $('#salesCd_S').val(row.salesCd);
            salesGridView.setData(0);
        });
    }
    
	// 거래처 검색 함수
	function opendClntSearch(inputValue) {
		openModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue : inputValue}, function(grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsClntCd_S').val(row.clntCd);
			$('#ordrsClntNm_S').val(row.clntNm);
			salesGridView.setData(0);
		});
	}
	
</script>
