<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5select.css">
    <link rel="stylesheet" href="/static/css/jstree/style.min.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
    <link rel="stylesheet" href="/static/css/gnb.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/sub.css">
    <link rel="stylesheet" href="/static/css/common.css">

    <script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
    <script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
    <script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
    <script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" ></script>
    <script type="text/javascript" src="/static/js/global.js"></script>
    <script type="text/javascript" src="/static/js/fileTree.js"></script>

    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-calendar/master/dist/ax5calendar.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-picker/master/dist/ax5picker.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-menu/master/dist/ax5menu.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-formatter/master/dist/ax5formatter.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-combobox/master/dist/ax5combobox.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-select/master/dist/ax5select.min.js"></script>

</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	
	<div id="main_area">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					 <a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					 <a onclick="salesGridView.setData(0);"><button class="bg_gray">검 색</button></a>
	            </li>
            </ul>
        </div>
    
		<!-- 검색 콘텐츠 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 3분할 -->
				<table class="table_input type04">
				
					<!-- 검색조건 1행 -->
					<tr>
						<th class= "hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사" onChange="salesGridView.setData(0);">
						      </select>
						</td>
						
						<th class= "hit">Sales Code</th>
						<td>
	                         <div class="search_form">
                                <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? salesGridView.setData(0) : ''">
                                <a onclick="wbsSalesCodeSearchM();"><i class="i_search_w"></i></a>
                            </div>
                            <input type="hidden" id="salesNm_S" name="salesNm_S" >
						</td>
						
						<th>&nbsp;</th>
						<td>&nbsp;</td>
						
						<th></th>
						<td>
						   
						</td>
					</tr>
		            <!-- 검색조건 END -->
	            </table>
	            <input type="hidden" id="userId"    name="userId">
                <input type="hidden" id="pgmId"     name="pgmId" value="WB0111M01">
            </div>
        </div>
        <!-- 콘텐츠 -->
		<div class="contents no_bg">
		      <div class="contents_tit">
		        <div class="add_btn_small pdl10">
		          <!-- <a onclick="wbsPlanProcInsertModal();" style="height: 30px; line-height: 28px; width: 100px;">WBS계획공정(+)</a>
		          <a onclick="deleteWbsPlanList();" style="height: 30px; line-height: 28px; width: 100px;">WBS계획공정(-)</a>
                  <a onclick="lockYn();" style="height: 30px; line-height: 28px; width: 60px;">계획잠금</a>
                  <a onclick="unLockYn();" style="height: 30px; line-height: 28px; width: 70px;">계획잠금취소</a>
                  <a onclick="deleteWbsPlan();" style="height: 30px; line-height: 28px; width: 60px;">계획삭제</a>
                  <a onclick="closeYn();" style="height: 30px; line-height: 28px; width: 60px;">실적마감</a>
                  <a onclick="unCloseYn();" style="height: 30px; line-height: 28px; width: 70px;">실적마감취소</a>
                  <a onclick="deleteWbsRslts();" style="height: 30px; line-height: 28px; width: 60px;">실적삭제</a>
		          <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a> -->
		          
		        </div>
        </div>

		
		<!-- 콘텐츠 -->

    <div class="row" style="margin-top: 15px;">
      <div class="col-xs-4" style="padding-right: 5px;">
        <div class="contents" style="margin: 0px; padding: 0px; height: 100%; width: 100%; min-width: 300px">
		      <div class="ax5_grid" data-ax5grid="sales-grid" data-ax5grid-config="{}" style="width: 100%; height: 750px;"></div>            
        </div>
      </div>
      <div class="col-xs-8" style="padding-left: 0;">
		<div class="contents">
		<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 750px;">
                  <form id="popForm">
                    <input type="hidden" id="coCd"   name="coCd">
                    <input type="hidden" id="userId" name="userId">
                    <input type="hidden" id="pgmId"  name="pgmId" value="WB2201M01">
                    <input type="hidden" id="closeYn" name="closeYn">
                    
                    <table class="popup_table">
                        <colgroup>
                             <col width="19%">
                             <col width="20%">
                             <col width="20%">
                             <col width="20%">
                             <col width="18%">
                             <col width="17%">
                             <col width="18%">
                             <col width="20%">
                             <col width="18%">
                        </colgroup>
                        
                        <thead>
                            <tr>
                               <td colspan="9" style="height:30px;text-align: left;">▣ 과제정보</td>                                                
                            </tr>
                        </thead>
                           <tr style="text-align: left;" rowspan="2">
                                <th>과제기본정보</th>                            
                                <th>과제번호</th>
                                <td> 
                                   <input type="text" id="sjNo" name="sjNo" readonly >
                                </td>
                                <th>과제명</th>
                                <td colspan="3"> 
                                   <input type="text" id="sjNm" name="sjNm" readonly>
                                </td>                               
                                <th>Ver.</th>
                                <td>   
                                   <input type="text" id="verNo" name="verNo" readonly>
                                </td>

                            </tr>
                             <tr style="text-align: left;" rowspan="2">
                                <th>고객기본정보</th>                            
                                <th >SALES CODE</th>
                                <td> 
                                   <div class="search_form">
                                    <input type="text" id="salesCd" name="salesCd" required readonly msg="salesCd">
                                </div>
                                </td>
                                <th>고객사</th>
                                <td> 
                                   <input type="hidden" id="clntCd" name="clntCd" >
                                   <input type="text" id="clntNm" name="clntNm" readonly >
                                </td>
                                <th>제품</th>
                                <td>
                                    <input type="hidden" id="prdtCd" name="prdtCd" >
                                    <input type="text" id="prdtNm" name="prdtNm" readonly >
                                </td>
                                <th>차종</th>
                                <td>   
                                   <input type="hidden" id="clntPjt" name="clntPjt">
                                   <input type="text" id="clntPjtNm" name="clntPjtNm" readonly >
                                </td>
                            </tr>
                            <tr  style="text-align: left;">
                                <th>실행정보</th>                            
                                <th>제작처 구분</th>
                                <td>
                                    <select id="mkerDiv" name="mkerDiv" data-kind="MAKERDIV" readonly>
                                    </select>
                                </td>
                                <th>제작업체</th>
                                <td> 
                                   <input type="hidden" id="mkerCd" name="mkerCd">
                                    <div class="search_form" style="width: 100%;">
                                        <input type="text" id="mkerNm" name="mkerNm" readonly> 
                                    </div>
                                </td>
                                <th>
                                                                         총괄PM
                                </th>
                                <td>
                                <div class="search_form">
                                <input type="hidden" id="smrizeId" name="smrizeId" msg="총괄PM" >
                                <input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly>
                                </div>    
                                </td>
                                <th style="color: blue;">
                                                                         확정여부
                                </th>                                
                                <td>
                                <input type="text" id="closeYn" name="closeYn" style="color: blue;" readonly>
                                </td>                               
                            </tr>
                             <tr style="text-align: left;">
                                <th>납기정보</th>                            
                                <th>시작일</th>
                                <td>        
                                <input id="beginDt" name="beginDt" readonly>                            
                                </td>
                                <th>출고일</th>
                                <td>                   
                                <input id="deDt" name="deDt" readonly>                 
                                </td>
                                <th>완료검수일</th>
                                <td>                   
                                <input id="acptncDt" name="acptncDt" readonly>                    
                                </td>
                                <th>소요일수</th>
                                <td>                   
                                <input id="reqreDaycnt" name="reqreDaycnt" readonly >                    
                                </td>
                            </tr>
                            <tr  style="text-align: left;">
                                <th>참조정보</th>                            
                                <th>설계난이도</th>
                                <td>        
                                <select id="dsgnDifCodeId" name="dsgnDifCodeId" data-kind="DSGNDIF" readonly> 
                                </select>                    
                                </td>
                                <th>설계계획공수</th>
                                <td>                   
                                <input type="text" class="form-control" id="dsgnPlanHour" name="dsgnPlanHour" readonly>            
                                </td>
                                <th>생산난이도</th>
                                <td>                   
                                <select id="prdctnDifCodeId" name="prdctnDifCodeId" data-kind="PRDCTNDIF" readonly>
                                </select>                
                                </td>
                                <th>생산계획공수</th>
                                <td>                   
                                <input type="text" class="form-control" id="prdctnPlanHour" name="prdctnPlanHour" readonly>                  
                                </td>
                            </tr>
                          <thead>
                            <tr>
                               <td colspan="9" style="height:30px;text-align: left;">▣ 1레벨</td>                                                
                            </tr>
                          </thead>
                             <tr>
                             <td colspan="9">
                              <div id="addrow" class="add_btn_small pdl10">
                               <a id="btn1" onclick="wbsLevel1Insert();" data-grid-control="row-add1" style="width:60px;height: 30px; line-height: 28px;">저장</a>
                               <a id="btn2" onclick="" data-grid-control="row-add2" style="width:60px;height: 30px; line-height: 28px;">미확정</a>
                               <a id="btn3" onclick="" data-grid-control="row-add3" style="width:60px;height: 30px; line-height: 28px;">확정</a>
                              </div>
                             </td>
                             </tr>
                             <tr>
                               <td colspan="9">
                               <div class="ax5_grid" data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 250px; width: 100%" ></div> 
                               </td>                                                
                            </tr>
                            <thead>
                            <tr>
                               <td colspan="9" style="height:30px;text-align: left;">▣ 2레벨</td>                                                
                            </tr>
                          </thead>
                             <tr>
                             <td colspan="9">
                              <div id="addrow" class="add_btn_small pdl10">
                               <a onclick="" data-grid-control="row-add" style="height: 30px; line-height: 28px;">+</a>
                               <a onclick="" data-grid-control="row-remove" style="height: 30px; line-height: 28px;">-</a>
                               <a onclick="wbsLevel2Insert();" data-grid-control="row-add4" style="width:60px;height: 30px; line-height: 28px;"  >저장</a>
                               <a onclick="" data-grid-control="row-add5" style="width:60px;height: 30px; line-height: 28px;" >미확정</a>
                               <a onclick="" data-grid-control="row-add6" style="width:60px;height: 30px; line-height: 28px;" >확정</a>   
                               <a onclick="" data-grid-control="row-add7" style="width:60px;height: 30px; line-height: 28px;" >실적등록</a>                                                         
                              </div>
                             </td>
                             </tr>
                             <tr>
                               <td colspan="9">
                               <div class="ax5_grid" data-ax5grid="second-grid" data-ax5grid-config="{}" style="height: 300px; width: 100%" ></div> 
                               </td>                                                
                            </tr>
                    </table>                    
                  </form>                 
                </div>                                        
            </div>
		</div>
      </div>
    </div>		
		
		
		
		
    </div>
                    
</body>
</html>

<script type="text/javascript">
 var isFirst = true;
 var coCd = null;
 var salesCd = null;
 var wbsPlanCodeKind = null;
 var deleteRowArr = [];
 
	ax5.ui.grid.formatter["chkYn"] = function () {
	    var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
	    if (this.value == "E"){
	        return ' ';
	    } else {
	        return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
	    }
	};
	var salesGridView = {
		    initView : function() {
		        this.target = new ax5.ui.grid();
		        this.target.setConfig({
			        showLineNumber: false,
					showRowSelector : true,
					multipleSelect : true,
					sortable : false,
		            target: $('[data-ax5grid="sales-grid"]'),
		            header : {
		                align : "center",
		                selector : true
		            },
		            body: {
		            	mergeCells : ["ordrsClntNm","ordrsNo","salesCd"],
		            	columnHeight: 26,
		                onClick: function () {	
		                	var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                                salesGridView.target.select(obj.__origin_index__, {selected: false});
                            });
		                	this.self.select(this.doindex);
		                	coCd = this.item.coCd;
		                	salesCd = this.item.salesCd;
		                    var paramObj = {
		                    		"coCd" : coCd,                                  
	                                "salesCd": salesCd
	                        };  
		                	postAjaxSync("/user/wb/wb22/selectSjInfo", paramObj, null, function(data){
		                		var row = data.resultList;
		                		if (row != undefined) {
		                			$.each(row, function (key, val) {
	                                    if (key == "mkerDiv") {
	                                        $('#mkerDiv option[value!="' + val + '"]').remove();
	                                    }
	                                    else if (key == "dsgnDifCodeId") {
	                                        $('#dsgnDifCodeId option[value!="' + val + '"]').remove();
	                                    }
	                                    else if (key == "prdctnDifCodeId") {
	                                        $('#prdctnDifCodeId option[value!="' + val + '"]').remove();
	                                    }
	                                    else {
	                                        $("#popForm #" + key).val(val);
	                                    }
	                                    
	                                });
		                			if ($('#closeYn').val() == "N") {
		                				alert("과제정보가 미확정입니다. 확정 후 입력 가능합니다.");
		                				
		                			}
		                			else {
		                				gridView1.setData(0);
		                			}
		                			
		                		}
		                    });
		                	
		                },
		                onDBLClick: function () {
		                },
		                onDataChanged: function () {
                        }
		           },
		           columns: [
		        	   {key: "pid",  			label: "pid", 		hidden: true},
		               {key: "id",  			label: "id", 		width: 160, hidden: true},
		               {key: "coCd",            label: "회사",       hidden: true},                       
		               {key: "ordrsClntNm",		label: "고객사",		width: 100, align: "left"},
		               {key: "ordrsNo",  		label: "오더번호", 	width: 100, hidden: true, align: "left"},
		               {key: "salesCd",  		label: "SALES CD", 	width: 200, hidden: false, align: "left",  treeControl: true},
		               {key: "planCnt",  		label: "계획/실적", 	width: 60, hidden: false, align: "center", formatter: function () {
		            	   return this.item.dataGbn=='D' ? this.value + '/'+this.item.rsultCnt : ''}},
// 		               {key: "rsultCnt",  		label: "실적", 	width: 100, hidden: false, align: "center"},
					   {label: "계획", columns: [  
				               {key: "planLockYn",  		label: "잠금", 	width: 35, align: "center", formatter: "chkYn"},  
				               {key: "planCloseYn",  		label: "마감", 	width: 35, align: "center", formatter: "chkYn"},
				       ]},
					   {label: "실적", columns: [  
				               {key: "rsultLockYn",  		label: "잠금", 	width: 35, align: "center", formatter: "chkYn"},  
				               {key: "rsultCloseYn",  		label: "마감", 	width: 35, align: "center", formatter: "chkYn"},  
				       ]},
		               {key: "dataGbn",  		label: "원시구분",  hidden: true},
		           ],
		           page : {
	                    navigationItemCount : 10,
	                    height : 30,
	                    display : true,
	                },
	                tree: {
	                	use: true,
                        indentWidth: 15,
                        arrowWidth: 15,
                        iconWidth: 18,
                        icons: {
                            openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                            collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                            groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                            collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
                            itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
                        },
                       columnKeys: {
                           parentKey: "pid",
                           selfKey: "id",
                       }
		           }
		        });
		        return this;
		    },
		    setData : function(_pageNo) {
		    	if (isFirst) return;
	            var targetObj = this.target;
    			var paramObj = {
    					"coCd": $('#coCd_S').val(),
    					"salesCd": $('#salesCd_S').val()
    			};
	            postAjax("/user/wb/wb22/selectWbsLeftSalesCodeList", paramObj, null, function(data){
	            	 var list = data.fileList;
	                    targetObj.setData({
	                        list : list,
	                        page : {
                                totalElements : list.length
	                        }
	                    });
	            });
	        } 
		    
		}
	
	var wbsPlanStsCodeId = [];
	var paramObj = {codeKind : "WBSPLANSTS"};
	postAjaxSync("/user/wb/wb21/selectCodeList", paramObj, null, function(data){
		wbsPlanStsCodeId = data.resultList; 
	});
	
    var gridView1 = {
		       initView: function(){
		           this.target = new ax5.ui.grid();
		           this.target.setConfig({
		               showRowSelector: true,
		               multipleSelect: false,
		               sortable: false,
		               target: $('[data-ax5grid="first-grid"]'),
		               header: {
		                 align: "center",
		                 selector: false
		               },
		               page : {
	                        navigationItemCount : 10,
	                        height : 30,
	                        use : false,
	                    },
		               body: {
		            	   //mergeCells : ["salesCd"],
		                   onClick: function () {
		                       this.self.select(this.dindex); 
		                       wbsPlanCodeKind = this.item.wbsPlanCodeId;
		                       var idx = this.dindex;
		                       if (this.column.key=='wbsPlanMngNm') {
		                    	   var paramObj = {
		                                   "coCd" : $('#coCd_S').val(),
		                                   "userId": '',
		                                   "useYn": "Y"
		                           };
		                    	   openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "담당자 검색", paramObj, function (tree){
		                               var checkedId = tree.get_checked()[0];
		                               var checkedNode = tree.get_node(checkedId);
		                               gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
		                               gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngNm : checkedNode.text}), idx);	                               
		                    	   });
		                       }
		                       else {
		                    	   gridView2.setData(0);
		                       }
		                   },
		                   onDBLClick: function () {
		                   },
		                  
		                   onDataChanged: function () {
		                	    const fDate = new Date(this.item.wbsPlansDt);
		                	    const tDate = new Date(this.item.wbsPlaneDt);
		                	    
		                	    const beginDt = new Date($('#beginDt').val());
		                	    const acptncDt = new Date($('#acptncDt').val());
		                	    
		                	    
		                	    if (fDate < beginDt) {
	                                alert("계획 시작일이 과제 시작일보다 이전일입니다.");
	                                this.self.setValue(this.dindex, "wbsPlansDt", $('#beginDt').val());
	                                return;
	                            }
	                            else if (tDate > acptncDt) {
	                            	alert("계획 종료일이 과제 완료검수일보다 이후일입니다.");
	                            	this.self.setValue(this.dindex, "wbsPlaneDt", $('#acptncDt').val());
                                    return;
	                            }
	                            else if (this.item.wbsPlansDt > this.item.wbsPlaneDt) {
                                    alert("시작일자와 종료일자가 맞지 않습니다.");
                                    this.self.setValue(this.dindex, "wbsPlansDt", this.item.wbsPlaneDt);
                                    return;
                                }
		                	    	                            
		                	    this.self.setValue(this.dindex, "daycnt", calcDate(this.item.wbsPlansDt, this.item.wbsPlaneDt));
		                	    
		                   },
		              },
		              columns: [
		                    {key: "rn",            label: "No.",              align: "center",   width: 40},
		                    {key: "fileTrgtKey",   label: "FILE TRGT KEY",    hidden:true},
		                    {key: "coCd",          label: "회사",    hidden:true},  
		                    {key: "salesCd",       label: "SALES CODE",    hidden:true},                            
		                    {key: "wbsPlanNo",     label: "계획번호",   hidden:true},
		                    {key: "wbsPlanCodeId", label: "계획코드",    hidden:true},
		                    {key: "wbsPlanCodeNm", label: "계획명",    align: "left",   width: 150},
		                    {key: "wbsPlanMngId",  label: "담당자",    hidden:true},
		                    {key: "wbsPlanMngNm",  label: "담당자명",    align: "center",   width: 120},
		                    {key: "wbsPlansDt",    label: "시작일자",      align: "center",   width: 120, 
	                            editor: {type: "date"
	                                        , config: {
	                                                content: {
	                                                             config: { mode: "day", selectMode: "day" }
	                                                         }
	                                                   }
	                                    }		                    
	                        },
	                        {key: "wbsPlaneDt",    label: "종료일자",      align: "center",   width: 120,
	                            editor: {type: "date"
	                                , config: {
	                                        content: {
	                                                     config: { mode: "day", selectMode: "day" }
	                                                 }
	                                           }
	                            }
	                            
	                        },
	                        {key: "daycnt",  label: "소요일수",    align: "center",   width: 60},
		                    {key: "wbsPlanStsCodeId",  label: "계획상태", align: "center",   width: 130, editor: {type: "select",
	                            config: {
	                                columnKeys: {optionValue: 'cd',optionText: 'nm'},
	                                options: wbsPlanStsCodeId
	                            },
	                            disabled: function () {
	                                return false;
	                            }
	                        }
	                         , formatter: function () {
	                            var result_text = "";
	                            var itemValue = this.item.wbsPlanStsCodeId;
	                            $.each(wbsPlanStsCodeId, function (idx, elem) {
	                                if(itemValue == elem.cd)
	                                {
	                                    result_text = elem.nm;
	                                }
	                            });
	                            return result_text;
	                        } },
		                    {key: "closeYn",      label: "마감",   width: 60, align: "center" , formatter: "chkYn"},
		                    {key: "creatId",      label: "생성자",      hidden: true},
                            {key: "creatNm",      label: "생성자명",      hidden: true},
                            {key: "creatDttm",      label: "생성일시",      hidden: true},                   
                            {key: "udtId",      label: "최종변경자",      hidden: true},
                            {key: "udtNm",      label: "최종변경자명",      hidden: true},
                            {key: "udtDttm",      label: "최종변경일자",     hidden: true}
                            ]
		           });

		           return this;
		         },
		         
		         setData: function() {
		             var targetObj = this.target;
		             var formData = {
		                     "coCd" : coCd,
		                     "salesCd" : salesCd,
	                         "beginDt" : $('#beginDt').val(),
	                         "acptncDt" : $('#acptncDt').val()
		             }
		             postAjax("/user/wb/wb22/selectWBS1Level", formData, null, function(data){  
		                 var list = data.fileList;
		                 if (list != undefined) {
		                     targetObj.setData({
		                          list : list,
		                          page : {
		                              totalElements : list.length
		                          }
		                      });
		                     $.each(list, function(idx, obj){
		                    	 if (obj.daycnt == undefined) {
		                    		 gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {daycnt : calcDate(obj.wbsPlansDt, obj.wbsPlaneDt)}), idx);
		                    	 }	                                
	                         })  
		                 }
		                 
		             }); 
		        } 
		    }
	

    var gridView2 = {
            initView: function(){
                this.target = new ax5.ui.grid();
                this.target.setConfig({
                    showRowSelector: true,
                    multipleSelect: true,
                    sortable: false,
                    target: $('[data-ax5grid="second-grid"]'),
                    header: {
                      align: "center",
                      selector: false
                    },
                    page : {
                         navigationItemCount : 10,
                         height : 30,
                         use : false,
                     },
                    body: {
                        mergeCells : ["salesCd"],
                        onClick: function () {
                            this.self.select(this.dindex); 
                            var idx = this.dindex;
                            if (this.column.key=='wbsPlanMngNm') {
                                var paramObj = {
                                        "coCd" : $('#coCd_S').val(),
                                        "userId": '',
                                        "useYn": "Y"
                                };
                                openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "담당자 검색", paramObj, function (tree){
                                	var checkedId = tree.get_checked()[0];
                                    var checkedNode = tree.get_node(checkedId);
                                    gridView2.target.updateRow($.extend({}, gridView2.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
                                    gridView2.target.updateRow($.extend({}, gridView2.target.list[idx], {wbsPlanMngNm : checkedNode.text}), idx);                                   
                                });
                            }
                        },
                        onDBLClick: function () {
                        },
                       
                        onDataChanged: function () {
                        	var row = gridView1.target.getList("selected")[0];
                            if (row != undefined) {
	                        	const fDate = new Date(this.item.wbsPlansDt);
	                            const tDate = new Date(this.item.wbsPlaneDt);
	                                                        
	                            const beginDt = new Date(row.wbsPlansDt);
	                            const acptncDt = new Date(row.wbsPlaneDt);
	                            	                            
	                            if (fDate < beginDt) {
	                                alert("계획 시작일이 과제 시작일보다 이전일입니다.");
	                                this.self.setValue(this.dindex, "wbsPlansDt", $('#beginDt').val());
	                                return;
	                            }
	                            else if (tDate > acptncDt) {
	                                alert("계획 종료일이 과제 완료검수일보다 이후일입니다.");
	                                this.self.setValue(this.dindex, "wbsPlaneDt", $('#acptncDt').val());
	                                return;
	                            }
	                            else if (this.item.wbsPlansDt > this.item.wbsPlaneDt) {
                                    alert("시작일자와 종료일자가 맞지 않습니다.");
                                    this.self.setValue(this.dindex, "wbsPlansDt", this.item.wbsPlaneDt);
                                    return;
                                }
	                            this.self.setValue(this.dindex, "daycnt", calcDate(this.item.wbsPlansDt, this.item.wbsPlaneDt));
                            }                            
                        },
                   },
                   columns: [
                         {key: "fileTrgtKey",   label: "FILE TRGT KEY",    hidden:true},
                         {key: "coCd",          label: "회사",    hidden:true},  
                         {key: "salesCd",       label: "SALES CODE",    hidden:true},                            
                         {key: "wbsPlanNo",     label: "계획번호",   hidden:true},
                         {key: "wbsPlanCodeKind", label: "상위계획코드",    hidden:true},
                         {key: "wbsPlanCodeKindNm", label: "상위계획명",    align: "left",   width: 150},
                         {key: "wbsPlanCodeId", label: "계획코드",    hidden:true},
                         {key: "seq", label: "순번",    hidden:true},
                         {key: "wbsPlanCodeNm", label: "계획명",    align: "left",   width: 150, editor: {type: "text"}},
                         {key: "wbsPlanMngId",  label: "담당자",    hidden:true},
                         {key: "wbsPlanMngNm",  label: "담당자명",    align: "center",   width: 120},
                         {key: "wbsPlansDt",    label: "시작일자",      align: "center",   width: 120, 
                             editor: {type: "date"
                                         , config: {
                                                 content: {
                                                              config: { mode: "day", selectMode: "day" }
                                                          }
                                                    }
                                     }
                         },
                         {key: "wbsPlaneDt",    label: "종료일자",      align: "center",   width: 120,
                             editor: {type: "date"
                                 , config: {
                                         content: {
                                                      config: { mode: "day", selectMode: "day" }
                                                  }
                                            }
                             }
                             
                         },
                         {key: "daycnt",  label: "소요일수",    align: "center",   width: 60},
                         {key: "wbsPlanStsCodeId",  label: "계획상태", align: "center",   width: 130, editor: {type: "select",
                             config: {
                                 columnKeys: {optionValue: 'cd',optionText: 'nm'},
                                 options: wbsPlanStsCodeId
                             },
                             disabled: function () {
                                 return false;
                             }
                         }
                          , formatter: function () {
                             var result_text = "";
                             var itemValue = this.item.wbsPlanStsCodeId;
                             $.each(wbsPlanStsCodeId, function (idx, elem) {
                                 if(itemValue == elem.cd)
                                 {
                                     result_text = elem.nm;
                                 }
                             });
                             return result_text;
                         } },
                         {key: "closeYn",      label: "마감",   width: 60, align: "center" , formatter: "chkYn"}
                         ]
                });

                return this;
              },
              
              setData: function() {
                  var targetObj = this.target;
                  var formData = {
                          "coCd" : coCd,
                          "salesCd" : salesCd,
                          "wbsPlanCodeKind" : wbsPlanCodeKind
                  }
                  postAjax("/user/wb/wb22/selectWBS2Level", formData, null, function(data){  
                      var list = data.fileList;
                      if (list != undefined) {
                          targetObj.setData({
                               list : list,
                               page : {
                                   totalElements : list.length
                               }
                           });
                      }
                  }); 
             } 
         }
    
$(document).ready(function() {

    mainDefaultLoad("WBS", "일정계획관리1");          // 페이지 타이틀 설정
    setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set

    isFirst = false;    
    
    $("#coCd_S").val(jwt.coCd);

    salesGridView.initView().setData(0);
    gridView1.initView();
    gridView2.initView();
    
    //권한체크
    authChk();

});

function calcDate(fDate, tDate) {
    var date1 = new Date(fDate.substr(0,4), fDate.substr(5,2), fDate.substr(8,2));
    var date2 = new Date(tDate.substr(0,4), tDate.substr(5,2), tDate.substr(8,2));
    var count = 0;
    while(true) {   
        var temp_date = date1;
        if(temp_date.getTime() > date2.getTime()) {
            console.log("count : " + count);
            break;
        } else {
            var tmp = temp_date.getDay();
            if(tmp == 0 || tmp == 6) {
            } else {
                count++;         
            }
            temp_date.setDate(date1.getDate() + 1); 
        }
    }
    return count;
}

$('[data-grid-control]').click(function () {
	var row = gridView1.target.getList("selected")[0];
	if (row != undefined) {
		switch (this.getAttribute("data-grid-control")) {  
        case "row-add":       
            var newRow = {};
            newRow = {
                    rn:"", 
                    fileTrgtKey: "", 
                    coCd: jwt.coCd, 
                    salesCd: salesCd, 
                    wbsPlanNo: "",
                    wbsPlanCodeKind: row.wbsPlanCodeId,                    
                    wbsPlanCodeKindNm: row.wbsPlanCodeNm,
                    wbsPlanCodeId: "",
                    wbsPlanCodeNm: "",
                    wbsPlanMngId: "",
                    wbsPlanMngNm: "",
                    wbsPlansDt: row.wbsPlansDt,
                    wbsPlaneDt: row.wbsPlaneDt,
                    daycnt: calcDate($('#beginDt').val(), $('#acptncDt').val()),
                    wbsPlanStsCodeId: "WBSPLANSTS10",
                    closeYn: "N"
                    };
            gridView2.target.addRow($.extend({}, newRow), "last");        
          break;
        case "row-remove":
        	deleteRowArr.push(row.fileTrgtKey);
            gridView2.target.deleteRow("selected");
          break;
       }	
	}    
});
  
function wbsLevel1Insert() {
   var rowList = gridView1.target.list;
   var formData = new FormData(); 
   var actionType = null;
   
   formData.append("coCd", jwt.coCd);
   formData.append("year", $('#beginDt').val().substring(0,4));
   if(rowList.length > 0) {    
       var rowListArr = [];
       $.each(rowList, function(idx, elem){    	   
    	   if (elem.fileTrgtKey != undefined) {
    		   actionType = "U";
    	   }
    	   else {
    		   actionType = "C";
    	   }
           var row = gridView1.target.getList()[idx];
           var rowListObj = elem;
           rowListObj["coCd"] = elem.coCd;
           rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
           rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
           if (actionType == "U") {
        	   rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
        	   rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
           }
           rowListObj["salesCd"] = elem.salesCd;
           rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
           rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
           rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
           rowListObj["daycnt"] = elem.daycnt;
           var wbsPlanStsCodeId = "";
           if (elem.wbsPlanStsCodeId != undefined) {
        	   wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
           }
           rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;
           rowListObj["creatId"] = jwt.userId;
           rowListObj["creatPgm"] = "WB2201M01";
           rowListArr.push(rowListObj);         
       });
       debugger;
       
       formData.append("deleteRowArr", JSON.stringify(deleteRowArr));
   }    

   if (actionType == "C") {
	   filePostAjax("/user/wb/wb22/wbsLevel1Insert", formData,             
	            function(data) {
	                alert(data.resultMessage);                              
	                if (data.resultCode == 200) {                          
	                    gridView1.setData(0);                  
	                }
	            });   
   }
   else {
	   filePostAjax("/user/wb/wb22/wbsLevel1Update", formData,             
               function(data) {
                   alert(data.resultMessage);                              
                   if (data.resultCode == 200) {                          
                       gridView1.setData(0);                  
                   }
               });   
   } 
}


function wbsLevel2Insert() {
	   var rowList = gridView2.target.list;
	   var formData = new FormData(); 
	   var actionType = null;
	   
	   formData.append("coCd", jwt.coCd);
	   formData.append("year", $('#beginDt').val().substring(0,4));
	   formData.append("wbsPlanCodeKind", wbsPlanCodeKind);
	   formData.append("salesCd", salesCd);
	   if(rowList.length > 0) {    
	       var rowListArr = [];
	       $.each(rowList, function(idx, elem){   
	           if (elem.fileTrgtKey != "") {
	               actionType = "U";
	           }
	           else {
	               actionType = "C";
	           }
	           var row = gridView1.target.getList()[idx];
	           var rowListObj = elem;
	           rowListObj["coCd"] = elem.coCd;
	           rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
	           if (actionType == "U") {
	               //rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
	               //rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
	               rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
	           }
	           rowListObj["salesCd"] = elem.salesCd;
	           rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
	           rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
	           rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
	           rowListObj["daycnt"] = elem.daycnt;
	           var wbsPlanStsCodeId = "";
	           if (elem.wbsPlanStsCodeId != undefined) {
	               wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
	           }
	           rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;
	           rowListObj["creatId"] = jwt.userId;
	           rowListObj["creatPgm"] = "WB2201M01";
	           rowListArr.push(rowListObj);         
	       });
	       formData.append("rowListArr", JSON.stringify(rowListArr));
	   }    
	   formData.append("rowListArr", JSON.stringify(rowListArr));
	   
	   if (actionType == "C") {
	       filePostAjax("/user/wb/wb22/wbsLevel2Insert", formData,             
	                function(data) {
	                    alert(data.resultMessage);                              
	                    if (data.resultCode == 200) {                          
	                        gridView2.setData(0);                  
	                    }
	                });   
	   }
	   else {
	       filePostAjax("/user/wb/wb22/wbsLevel2Update", formData,             
	               function(data) {
	                   alert(data.resultMessage);                              
	                   if (data.resultCode == 200) {                          
	                       gridView2.setData(0);                  
	                   }
	               });   
	   } 
	}
	
	
</script>
