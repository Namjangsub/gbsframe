<html lang="ko">
<head>
<meta charset="utf-8" />
<title>SVG 레이어 간트 (그룹/세로타이틀/툴팁/중앙라벨/겹침팔레트/DnD/줌)</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	
	<script type="text/javascript" src="/static/js/jquery-latest.min.js"></script>
	<script type="text/javascript" src="/static/js/jquery.serializeObject.js"></script>
	<script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script type="text/javascript" src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script type="text/javascript" src="/static/js/moment/moment-with-locales.js"></script>
	<script type="text/javascript" src="/static/js/jstree/jstree.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5core.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5grid.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5mask.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5modal.min.js"></script>
	<script type="text/javascript" src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5calendar.min.js"></script>
	<script src="/static/js/ax5/ax5picker.min.js"></script>
	<script src="/static/js/ax5/ax5menu.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5combobox.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	
	<script type="text/javascript" src="/static/js/global.js"></script>
	<script type="text/javascript" src="/static/js/fileTree.js"></script>
	<script type="text/javascript" src="/static/js/workingDayCalc.js"></script>
	<script type="text/javascript" src="/static/js/korean-lunar-calendar.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<!-- 도움말 팝업 -->
  	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">
 	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
    <script src="/static/js/manualPopup.js"></script>
<style>
	:root{
		--px-per-day: 24px;
		--lane-height: 22px;
		--track-vpad: 3px;
		
		--label-width: 180px;            /* 좌측 라벨/헤더 '구분' 폭(동일) */
		--badge-col-width: 46px;         /* PM/PLAN/DO/계획 배지 열 폭(동일) */
		--badge-radius: 14px;
		
		--label-font-size: 14px;
		--ruler-font-size: 12px;
		--bar-font-size: 12px;
		
		--col-gap: 8px; /* .header-right/.row-group의 좌우 gap 값과 동일하게 */
		--grid-line-color: #e9eef8;     /* 그리드선 공통색 */
	}

/*    body{ font:12px/1.45 system-ui,"맑은 고딕"; color:#222; background:#f6f8fb; margin:16px; } */
	.toolbar{ display:flex; gap:12px; align-items:center; margin-bottom:10px; }
	.timeline{ 
		border:1px solid #cfd9ee; border-radius:12px; background:#fff; padding:8px, 0px; overflow-x:auto; white-space:nowrap;  height: calc(100vh - 165px); /* 뷰포트 전체 높이에서 상단 영역 200px 뺀 값 */
		position: relative;
		overflow: auto; 
	}
  
	/* 공통: 좌→우 방향으로 1px 라인 + (px/day-1px) 빈칸 반복 */
	.day-grid {
		background-image: repeating-linear-gradient(
		  to right,
		  var(--grid-line-color) 0 1px,
		  transparent 1px var(--px-per-day)
		);
		background-repeat: repeat;
		background-position: left top;   /* 기준점 통일(phase 고정) */
		background-size: auto 100%;
	}


	/* 고정 요소는 마스크보다 위로 */
	.header-gutter{ position: sticky; left:0; top:0; z-index: 14; background:#0b0b0b; }
	.plan-badge-col{ position: sticky; left: var(--label-width); margin-left: 0;  top:0; z-index: 13; background:#f7f9fe; }



	.line-badge{ position: sticky; left: var(--label-width); z-index: 11; background:#2b6cb0; }



	/* ── 헤더 ─────────────────────────────────────────── */
	.header{
	  position: sticky;
	  top: 0;                   /* ↑ 세로 고정 */
	  z-index: 30;
	  background: #f7f9fe;      /* 아래 컨텐츠 가림 */
/* 	  box-shadow: 0 2px 0 rgba(0,0,0,.04); */
	  display: flex;
	}
  
	/* 좌상단 코너: 가로/세로 모두 고정 */
	.header-gutter{
		flex: 0 0 var(--label-width);
		position: sticky;
		top: 0;                   /* ↑ 세로 고정 */
		left: 0;                  /* ← 가로 고정 */
		z-index: 40;
		background:#2b6cb0; color:#e5e7eb;
		border-radius: 12px;
		display:flex;align-items:center;justify-content:center;
	}

	/* 헤더 오른쪽(계획 배지 + 룰러) */
	.header-right{
		flex: 1 1 auto;
		padding-left: calc( var(--col-gap));
	}

	/* 헤더의 '계획' 배지: 가로 고정 + 세로 고정(헤더에 붙어있게) */
	.plan-badge-col{
		position: sticky;
		top: 0;
		padding-left: 16px; 
		padding-right: 6px;
		left: calc(var(--label-width)); /* 라벨 끝 바로 오른쪽에 붙임 */
		z-index: 35;                    /* 룰러/마스크 위에 */
		width: var(--badge-col-width);
		height: auto;                   /* 높이는 JS에서 rulers 높이에 맞춰 갱신 */
		background: transparent;
	}

	.cat-badge{
		position: sticky;
		top: 0;
		left: calc(var(--label-width) + var(--col-gap));
		z-index: 35;
		background:#f7f9fe;
		width: var(--badge-col-width);
		
		height: calc(var(--lane-height) + var(--track-vpad)*2);
		border-radius: var(--badge-radius);
		display:flex;align-items:center;justify-content:center;
		color:#fff; 
		background:#2b6cb0;
		padding-left: 6px;
		padding-right: 6px;
		width: 46px;
		font: 12px / 1.4 system-ui, "맑은 고딕";
	}



	/* 룰러는 가로로만 스크롤됨(폭은 JS로 totalW 지정) */
	.header-rulers{ position: relative; z-index: 1; display:flex; flex-direction:column; padding-left: 18px;}
	.ruler-row{ height:26px; display:flex; align-items:center; font-size: var(--ruler-font-size) !important;}
	.ruler-month .cell{ font-weight:700; background:#2274C6; color:white; border-right:1px solid #e6ecff; }
	.ruler-week  .cell{ background:#f6f8ff; color:#333; border-right:1px solid #eef2ff; }
	.cell{ width:var(--px-per-day); min-width:var(--px-per-day); text-align:center; box-sizing:border-box; }
/* 	.ruler-day{background: repeating-linear-gradient(to right, #f0f2f7 0 1px, #fff 1px var(--px-per-day));} */
/* 	.ruler-day .cell{ background:none !important; } */
	.ruler-day{position: relative;  z-index: 1; background: none !important;}
	.ruler-day::before{
		content:"";
		position: absolute; left:0; right:0; top:0; bottom:0;
		pointer-events:none;
		/* 공통 그리드 */
		background-image: repeating-linear-gradient(to right, var(--grid-line-color) 0 1px, transparent 1px var(--px-per-day));
		z-index: 0;
	}
	.ruler-day .cell{
	}
	.day-weekend{ background:#fff6f6 !important; }

	/* ── 본문(그룹) ───────────────────────────────────── */
	.rows{ margin-top:8px; }
	/* 한 행 레이아웃: [라벨]|[배지]|[트랙] */
  
	.row-group{
		display: grid;
		grid-template-columns: var(--label-width) var(--badge-col-width) 1fr;
		align-items: start;
		gap: var(--col-gap);
		margin: 10px 0;
	}

	/* 좌측 라벨: 가로 고정 */
	.group-label{
		position: sticky;
		left: 0;                                 /* ← 가로 고정 */
		z-index: 20;
		background:#768ea5; color:#e5e7eb;
		border-radius:12px;
		height: 100%;            /* ⬅ grid 셀 전체 높이 */
		display: flex;           /* ⬅ 텍스트 중앙 정렬 */
		flex-direction: column;  /* 여러 줄 표시 */
		justify-content: center;
		margin-left: 0px;
		padding-left: 10px;
		padding-right: 10px;
	}

	/* PM/PLAN/DO 배지: 가로 고정 (라벨 너머로) */
	.line-badge{
		position: sticky;
		left: calc(var(--label-width) + var(--col-gap));  /* ✅ gap 포함 */
		z-index: 15;
		background:#2b6cb0; color:#fff; border-radius: var(--badge-radius);
		display:flex; align-items:center; justify-content:center;
		width: var(--badge-col-width);
	}
	.group-label span {
		display: block;                /* <span>도 줄바꿈 유지 */
	}

  .group-box{
/*     flex:0 0 auto; border:1px solid #cfe0ff; border-radius:16px; background:#fff; */
/*     padding:8px; display:flex; flex-direction:column; gap:1px; */
    
     grid-column: 2 / -1;
     border:1px solid #cfe0ff; border-radius:16px; background:#fff;
     padding:8px; display:flex; flex-direction:column; gap:1px;
      box-sizing: border-box;      /* 패딩/보더 포함해 영역 맞춤 */
  }

  .group-line{ display:flex; gap:8px; align-items:flex-start; }
  .line-badge{
	  flex:0 0 var(--badge-col-width);
	  min-width:var(--badge-col-width);
	  height: calc(var(--lane-height) + var(--track-vpad) * 2); padding:0 6px; border-radius:var(--badge-radius);
	  background:#768EA5; color:white;
	  display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; letter-spacing:.5px;
	  box-shadow:0 1px 2px rgba(0,0,0,.08) inset;
	  
	  font: 10px / 1.4 system-ui, "맑은 고딕";
  }

	/* 트랙은 스크롤되며, 폭은 기간 totalW와 동일해야 함 */
	.row-track{
		position: relative;
		z-index: 1;
		min-height: calc(var(--lane-height) + var(--track-vpad)*2);
		border:1px solid #cfe0ff; border-radius:12px; padding:var(--track-vpad) 0;
		background: #fff;
	}
	.row-track::before{
		content:"";
		position:absolute; left:0; right:0; top:0; bottom:0;
		pointer-events:none;
		
		background-image: repeating-linear-gradient(
		  to right,
		  var(--grid-line-color) 0 1px,
		  transparent 1px var(--px-per-day)
		);
		z-index: 0; /* SVG/라벨/핸들(.handle)보다 뒤 */
	}

  
	/* ⬅ 좌측 흰색 마스크: 라벨폭 + 간격 + 배지폭 만큼 덮어쓰기 */
	.timeline::before{
		content:"";
		position: sticky; left:0; top:0; bottom:0;
		width: calc(var(--label-width) + var(--col-gap) + var(--badge-col-width));  /* ✅ */
		background: #fff;
		z-index: 8;
		pointer-events: none;
	}

	.row-track .shade{
		position:absolute; top:0; bottom:0;
		pointer-events:none; z-index:1;     /* 바/핸들이 위에 오게 */
	}
	
	.row-track svg{ position:relative; z-index:2; }
	.today-line{ position:absolute; top:0; bottom:0; width:1px; background:#ff4d4f; pointer-events:none; }
	.shade.weekend{ background:#FFEEEE; }                /* 주말 */
	.shade.today  { background:rgba(255,0,0,.50) }      /* 오늘 */
	/* ── SVG 막대 ─────────────────────────────────────── */
	svg{ display:block; }
	.bar{ fill:#BAD9F8; stroke:#8bb6ff; opacity:.5; }
	/* 겹침 팔레트 */
 	.bar.overlap.ci-0{ fill:#4e79a7; stroke:#3b638c; opacity:.50; } 
 	.bar.overlap.ci-1{ fill:#f28e2b; stroke:#cf741b; opacity:.50; } 
 	.bar.overlap.ci-2{ fill:#59a14f; stroke:#45823e; opacity:.50; } 
 	.bar.leader.overlap.ci-0{ fill:#4e79a7; stroke:#3b638c; opacity:.50; } 
 	.bar.leader.overlap.ci-1{ fill:#f28e2b; stroke:#cf741b; opacity:.50; } 
 	.bar.leader.overlap.ci-2{ fill:#59a14f; stroke:#45823e; opacity:.40; } 
/* 	.bar.expired { background: white !important; } */
	.bar.expired {
    fill: white !important; /* SVG 사각형 색상 */
    stroke: #ccc;           /* 테두리 색상도 필요시 변경 */
    opacity: 1;             /* 투명도 제거 */
}
	
	
	.bar-label{
		font-size:var(--bar-font-size); 
		dominant-baseline:middle;
		text-anchor:middle; /* 중앙정렬 */
		pointer-events:none;
		fill:#203040;
	}
	.handle{ fill:rgba(0,0,0,.15); cursor:ew-resize; }

	/* 드래깅 */
	.dragging .bar{ opacity:.85; }
	.dragging, .dragging * { user-select: none; }
	
	/* 툴팁 */
	#ganttTooltip{
		position:fixed; z-index:9999; pointer-events:none; display:none;
		padding:6px 8px; border-radius:6px; background:rgba(17,17,17,.92); color:#fff;
		font-size:12px; line-height:1.3; white-space:nowrap;
		box-shadow:0 4px 12px rgba(0,0,0,.18);
	}
	
	  
	/* 헤더 Day 라인에서 주말/오늘 칸을 확실히 칠한다 */
	.ruler-day .cell.day-weekend{
		background: #FFEEEE !important;      /* 연분홍 */
	}
	.ruler-day .cell.day-today{
		background: rgba(255,0,0,.50) !important;  /* 반투명 빨강 */
	}

	.group-line > .line-badge{
		position: sticky;   /* 셀 자체를 sticky */
		left: 0; /* ← sticky는 0 기준으로만 */
		left: calc(var(--label-width) + var(--col-gap));
		z-index: 15;
		display:flex; 
		align-items:center; 
		justify-content:center;
	}
	/* 배지 버튼 스타일은 그대로 유지 (position/static로 동작해도 무방) */
	/* .group-line > .line-badge{ display:flex; align-items:center; justify-content:center; } */


	.contents.no_bg {
	    display: flex;
	    align-items: center;   /* 수직 중앙 정렬 */
	    justify-content: space-between; /* 좌우 끝 배치 (옵션) */
	}
	.toolbar {
	    display: flex;
	    align-items: center;
	    gap: 8px; /* 요소 간 간격 */
	}
	.btn_ul {
	    display: flex;
	    gap: 6px;
	    list-style: none;
	    margin: 0;
	    padding: 0;
	}
	.btn_ul li {
	    display: flex;
	    gap: 6px;
	}
	
	.datepicker-dropdown,
	.datepicker {
		z-index: 12000 !important;   /* 필요시 9999 이상 */
	}
	
	/* 드래그 패닝 UX 개선 */
	#timeline { cursor: grab; }
	#timeline.panning { cursor: grabbing; }
	#timeline.panning, #timeline.panning * { user-select: none; }

</style>
</head>
<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area">
        	<input type="hidden" id="pgmId"  name="pgmId" value="WB0601M01">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<div class="toolbar">
			  <label>줌(px/day): <input id="zoom" type="range" min="2" max="26" step="1" value="6"></label>
			  <span id="zoomVal">6</span>
			  <span style="color:#667085">Ctrl + 마우스휠도 지원</span>
			</div>
			<ul class="btn_ul">
				<li class="btn_r">
                	<a onclick="manualPopup();"> <button type="button" class="bg_gray" onclick="manualPopup();">도움말</button> </a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="searchData();"><button class="bg_gray">검 색</button></a>
				</li>
			</ul>
		</div>

		<!-- 검색조건 -->
		<div class="contents search">
			<div class="">
				<!-- 테이블 인풋 5분할 -->
				<table class="table_input type04">
					<!-- 검색조건 1행 -->
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사">
							</select>
						</td>

						<th class="hit">수주일자</th>
						<td>
							<div class="date_input">
								<input type="text" id="strtDt_S" name="strtDt_S" class="input_calendar" onkeyup="dateMask(this);" autocomplete="off" required data-search="strtDt">
								<span>~</span>
								<input type="text" id="endDt_S" name="endDt_S" class="input_calendar" onkeyup="dateMask(this);" autocomplete="off" required data-search="endDt">
							</div>
						</td>
						
						<th class="">기계종류</th>
						<td>
							<div class="">
							    <select id="multiple-checkboxes-prdtGrp" multiple="multiple">
							    </select>
							</div>
						</td>
						
						<th></th>
						<td>
						</td>

					</tr>

					<!-- 검색조건 2행 -->
					<tr>
						<th>SalesCode</th>
						<td>
						    <div class="search_form">
						     <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? searchData() : ''">
						    	<a onclick="wbsSalesCodeSearch($('#salesCd_S').val());"><i class="i_search_w"></i></a>
						    </div>
						</td>
						<th>고객사PJT</th>
						<td>
                            <select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt">
								<option value="">전체</option>
							</select>
						</td>

						<th class="">고객사</th>
						<td>
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm"
								onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? ordrsClntCd_S.value = '' : event.keyCode == 13 ? searchData() : ''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						
						<th>PM계획상태</th>
						<td>
							<select id="scdStatus_S" name="scdStatus_S" data-search="scdStatus">
								<option value="">전체</option>
								<option value="진행중" selected>진행중인상태</option>
								<option value="완료된">완료된 상태</option>
								<option value="미도래">미도래 상태</option>
							</select>
						</td>
					</tr>

				</table>
			</div>
		</div>
		<!-- 검색조건 END -->

		<!-- 그리드1 -->

		
		<div class="timeline" id="timeline">
		  <div class="header">
		    <div class="header-gutter">SalesCd / 구분</div>
		
		    <!-- 오른쪽: [계획 세로캡슐] | [룰러] -->
		      <div class="plan-badge-col">
		        <div class="cat-badge" id="planBadge">구분</div>
		      </div>
		      <div class="header-right">
			      <div class="header-rulers" id="headerRulers">
			        <div class="ruler-month ruler-row" id="rulerMonth"></div>
			        <div class="ruler-week  ruler-row" id="rulerWeek"></div>
			        <div class="ruler-day   ruler-row" id="rulerDay"></div>
			      </div>
		     </div>
		  </div>
		
		  <div class="rows" id="rowsContainer"></div>
		</div>


	</div>
	
<!-- Tooltip -->
<div id="ganttTooltip"></div>

<script>

	// ===== 유틸 =====
	const MS=86400000;
	const SVGNS='http://www.w3.org/2000/svg';
	const sod = d=>{ const x=new Date(d); x.setHours(0,0,0,0); return x; };
	const fmt = d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
	const parse = s=>sod(new Date(s));
	const clamp = (d,s,e)=> new Date(Math.min(Math.max(+d,+s),+e));
	const days = (a,b)=> Math.round((+sod(b)-+sod(a))/MS);
	const xFromDate = d => days(state.viewStart, sod(d)) * state.pxPerDay;
	const dateFromX = x => sod(new Date(+state.viewStart + Math.round(x/state.pxPerDay)*MS));


	// ===== SVG 유틸 =====
	const make = (name, attrs={})=>{
		const el=document.createElementNS(SVGNS, name);
		for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
		return el;
	};

	// ===== 툴팁 유틸 =====
	const $tt = $('#ganttTooltip');
	const tipPad = 14;
	function fmtRange(s, e, name){ return `${name} : ${fmt(s)} ~ ${fmt(e)} (${days(s,e)+1}일)`; }
	function showTip(x, y, text){ $tt.text(text).css({ left:x+tipPad, top:y+tipPad, display:'block' }); }
	function moveTip(x, y, text){ $tt.text(text).css({ left:x+tipPad, top:y+tipPad }); }
	function hideTip(){ $tt.hide(); }


	// ===== 렌더 =====
	function renderAll(){

		buildHeader();
		buildRows();
		$('.row-track').each(function(){
			const rowKey = $(this).data('row');
			const cat    = $(this).data('cat');
			const items  = state.rowsData?.[rowKey]?.[cat] || [];
			renderRowSVG($(this), items);
		});
		drawTodayLine();
		paintTrackShading();  

		syncTimelineWidths();
		try { openProgress(false); } catch(e){}
	}


	// ===== 상태 =====
	var state = {
		viewStart: new Date('2025-04-24'),
		viewEnd:   new Date('2025-07-01'),
		pxPerDay:  6,
		
		// 표시 행 정의 (label은 화면용, key는 데이터 식별자)
		rowDefs: [],
		
		// 카테고리 표시 순서
		categories: ['PM','PLAN','DO'],
		
		// 각 행별 카테고리 데이터
		rowsData: {}
	};

	function syncTimelineWidths(){
		const totalDays = days(sod(state.viewStart), sod(state.viewEnd)) + 1;
		const totalW = totalDays * state.pxPerDay;
		
		// 헤더(월/주/일)
		$('#rulerMonth, #rulerWeek, #rulerDay').css('width', totalW + 'px');
		
		// 모든 라인의 트랙
		$('.row-track').css('width', totalW + 'px');
	}
  
  
	//화면로드시
	$(document).ready(function() {
		mainDefaultLoad("실행계획", "기계별 WBS현황"); // 페이지 타이틀 설정
		setCommonSelect($("#main_area select[data-kind]")); // 공통코드 set

		setZoom(state.pxPerDay);
		//메뉴 숨기기
		$('#head_area').toggleClass('off');
		$('#top_area').toggleClass('on');
		$('#main_area').toggleClass('on');
		//회사 기본값지정
		$("#coCd_S").val(jwt.coCd);
	
		// 시작일 (현재날짜의 월 첫일)
		$('#strtDt_S').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true
		})
		.datepicker("setDate", moment().subtract(6, "months").startOf("month").toDate())
		.on("changeDate", function(){
			if($('#strtDt_S').val() > $('#endDt_S').val()){
				alert("날짜를 확인해주세요");
				$('#strtDt_S').datepicker("setDate", new Date($('#endDt_S').val()));
			}
		});
	
		// 종료일 (현재날짜의 월 말일)
		$('#endDt_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", moment(new Date()).endOf("month").toDate())
		.on("changeDate", function(){
			if($('#strtDt_S').val() > $('#endDt_S').val()){
				alert("날짜를 확인해주세요");
				$('#endDt_S').datepicker("setDate", new Date($('#strtDt_S').val()));
			}
		});
	
	
		// 초기 렌더
		searchData ();
	
				
		$(document).on('dblclick', '.group-box', function (e) {
		    const salesCd = $(this).closest('.row-group').find('.row-track').data('row');
// 		    const $badge = $(e.target).closest('.group-line').find('.line-badge');
	
// 		    if ($badge.length) {
// 		        const badgeText = $badge.text().trim();
// 		        alert(`행: ${salesCd}\n배지: ${badgeText}`);
		        
				var paramObj = {
						"coCd"		: $('#coCd_S').val(),
						"salesCd"	: salesCd,
						"histYn"	: 'N',
				};
				openModal("/static/html/user/wb/wb22/WB2201P01.html", 1200, 900, "WBS 계획등록", paramObj, function () { });
// 		    }
		});
	
		$('#zoom').on('change', function(){ setZoom(+this.value); });
		$('#timeline').on('wheel', function(e){
			if (e.ctrlKey){ e.preventDefault(); setZoom(state.pxPerDay + (e.originalEvent.deltaY>0 ? -2 : 2)); }
		});
		  
		// 검색조건 이벤트 bind
		$('[data-search]').on("change", function(){ searchData(); });
		$('#multiple-checkboxes-prdtGrp').multiselect({includeSelectAllOption: true,});
		prdrGrpMutiSelectAddIn(); //기계종류 추가하기
		$('#multiple-checkboxes-prdtGrp').on("change", function(){ searchData(); });
			
		//권한체크
		authChk();
		
		// 드래그로 스크롤 (좌/우만 또는 상/하만 - 축 고정)
		(function enableFreePan(){
			const $viewport = $('#timeline');
			let panning=false, id=null, sx=0, sy=0, sl0=0, st0=0;
			
			$(document).on('pointerdown', '.group-box', function(e){
				const isLeft = e.pointerType === 'mouse' ? e.button === 0 : true;
				if (!isLeft) return;
				if ($(e.target).closest('.bar, .handle').length) return;
				
				panning = true; id = e.pointerId || 1;
				sx = e.clientX; sy = e.clientY;
				sl0 = $viewport.scrollLeft(); st0 = $viewport.scrollTop();
				e.target.setPointerCapture?.(id);
				$viewport.addClass('panning');
				e.preventDefault();
			});
			
			$(document).on('pointermove', function(e){
				if (!panning) return;
				const dx = e.clientX - sx;
				const dy = e.clientY - sy;
				$viewport.scrollLeft(sl0 - dx);  // 좌우
				$viewport.scrollTop(st0 - dy);   // 상하
			});
			
			$(document).on('pointerup pointercancel', function(){
				if (!panning) return;
				panning=false; id=null; $viewport.removeClass('panning');
			});
		})();
	});

	function searchData () {
		if (inputValidation($('input[required]'))) {

			try { openProgress(true); } catch(e){}
			
			var formData = {};
			$.each($('[data-search]'), function(idx, elem){
				// class에 input_calendar가 포함된 경우에만 '-' 제거
			    if ($(elem).hasClass("input_calendar") ) {
			    	formData[$(elem).data("search")] = $(elem).val().replace(/\-/g, '');
			    } else {
			    	formData[$(elem).data("search")] = $(elem).val();
			    }
			});
			formData["pageNo"]    =1;
			formData["recordCnt"] = $('#recordCnt').val();
			
			//기계종류 multi selec
			let selectPrdtGrp = $('#multiple-checkboxes-prdtGrp').val();
			if (!selectPrdtGrp) { //nul이면
				formData["prdtGrp"]    = "";
			} else {
				formData["prdtGrp"]    =  selectPrdtGrp.join(","); 		//['PRJCT115', 'PRJCT135'] --> "PRJCT115,PRJCT135" 변환해서 쿼리 in 조건에 맞게 변환
			}

			postAjax("/user/wb/wb26/select_wb2604_List", formData, null, function(data) {
				try {
					var list = data.result;

					// 1) 오늘/끝일 입력값 문자열 준비 (YYYY-MM-DD 가정)
					//    - list의 wbsPlansDtFm/wbsPlaneDtFm 도 동일 포맷 가정
					const today = new Date();
					const pad = n => (n < 10 ? '0' + n : '' + n);
					const todayStr = today.getFullYear() + '-' + pad(today.getMonth() + 1) + '-' + pad(today.getDate());
					
					// endDt_S는 한 번만 읽기
					const $endInput = $('#endDt_S');
					const endDtS = ($endInput && $endInput.length) ? String($endInput.val() || '') : '';

					// 정렬(시작일 오름차순, 같으면 종료일)
					const sorter = (a, b) =>
						(a.start < b.start ? -1 : a.start > b.start ? 1 :
						 a.end   < b.end   ? -1 : a.end   > b.end   ? 1 : 0);


					// PLAN_TYPE → 카테고리 매핑
					// 'PM계획' → PM, '담당실적'/'실적' → DO, 나머지 → PLAN (필요 시 규칙 추가)
					const catFrom = (planType='') => {
						const t = planType.toUpperCase();
						if (t.includes('PM')) return 'PM';
						if (t.includes('실적')) return 'DO';
						return 'PLAN';
					};
					
					// ───────── 변환 본체 ─────────
					/**
					 * @param {Array<Object>} rows - DB 결과 배열
					 *  - 필수 컬럼 예: salesCd, planType, wbsPlansDt(시작), wbsPlaneDt(종료),
					 *                 wbsPlanCodeId(키 후보), wbsPlanCodeNm(라벨)
					 * @returns {Object} { [salesCd]: { PM:[], PLAN:[], DO:[] } }
					 */

					const rowsData = Object.create(null);         // { [salesCd]: { PM:[], PLAN:[], DO:[] } }
					const metaMap  = new Map();                   // salesCd -> meta
					let minDate = null;                           // 문자열 비교용(YYYY-MM-DD)
					let maxDate = null;
					
					
					for (let i = 0; i < list.length; i++) {
						const r = list[i];
						
						// salesCd 필수
						const sales = (r && r.salesCd) ? String(r.salesCd).trim() : '';
						if (!sales) continue;
						
						// 날짜(문자열) 준비: 파싱 없이 그대로 사용
						const start = r.wbsPlansDtFm || '';
						const end   = r.wbsPlaneDtFm || '';
						
						// 레코드 구성(라벨 가공은 최소화)
						const rec = {
							key:   r.wbsPlanCodeId,
							label: r.wbsPlanCodeNm ? String(r.wbsPlanCodeNm).trim() : (r.wbsPlanCodeId || ''),
							start,
							end
						};
						
						
						// 버킷 지연 생성
						let bucket = rowsData[sales];
						if (!bucket) {
							bucket = rowsData[sales] = { PM: [], PLAN: [], DO: [] };
						}
						bucket[catFrom(r.planType)].push(rec);
						
						
						// 메타는 최초 1회만
						if (!metaMap.has(sales)) {
							metaMap.set(sales, {
								label: sales,
								key: sales,
								기계종류: (r['기계종류'] || '').toString().trim(),
								mngIdNm: (r.mngIdNm || '').toString().trim(),
								eqpNm:   (r.eqpNm || '').toString().trim().slice(0, 20),
								수주구분: (r['수주구분'] || '').toString().trim(),
								아이템구분: (r['아이템구분'] || '').toString().trim(),
								기계구분: (r['기계구분'] || '').toString().trim(),
								clntPjtNm: (r['clntPjtNm'] || '').toString().trim(),
								clntNm: (r['clntNm'] || '').toString().trim()
							});
						}
						
						
						// min/max 갱신: 유효한 날짜만 비교 (YYYY-MM-DD 문자열 비교)
						if (start) {
							if (!minDate || start < minDate) minDate = start;
							if (!maxDate || start > maxDate) maxDate = start;
						}
						if (end) {
							if (!minDate || end < minDate) minDate = end;
							if (!maxDate || end > maxDate) maxDate = end;
						}
					}
					
					
					const rowDefs = Array.from(metaMap.values());
					
					// 6) view 구간 계산: 문자열→Date 변환은 마지막 1회만
					//    타임존 이슈 방지를 위해 'T00:00:00' 명시
					const toDate = (s) => s ? new Date(s + 'T00:00:00') : null;
					
					const viewStart = toDate(minDate || todayStr);
					
					// maxDate와 endDt_S 비교: 둘 다 문자열이므로 날짜형식 동일 시 문자열 비교 OK
					const endBoundStr = (endDtS && endDtS.length === 10) ? endDtS : (maxDate || todayStr);
					const viewEnd = toDate((maxDate && endDtS && endDtS > maxDate) ? endDtS : (maxDate || todayStr));
					
					// 7) 상태 갱신(한 번에) + 렌더
					state.rowDefs  = rowDefs;
					state.rowsData = rowsData;
					state.viewStart = viewStart || new Date();
					state.viewEnd   = viewEnd   || new Date();
					      
					 
					 renderAll();
					 
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			}, false);
			
		}
	}  
  
	function weekOfYear(d){
		const y0=new Date(d.getFullYear(),0,1);
		return String(Math.floor((days(y0,d)+y0.getDay())/7)+1).padStart(2,'0');
	}


	function cssVarPx(name){
		const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
		return parseFloat(v); // '180px' -> 180
	}
  	
  
	// ===== 헤더 =====
	function buildHeader(){
		const start = sod(state.viewStart);
		const end   = sod(state.viewEnd);
		const totalDays = days(start, end) + 1;
		
		// 폭/높이 동기화
		const totalW = totalDays * state.pxPerDay;
		
		
		const labelW = cssVarPx('--label-width');
		const badgeW = cssVarPx('--badge-col-width');
		const gapW   = cssVarPx('--col-gap');
		const leftRailW = labelW + gapW + badgeW; // 좌측 라벨+갭+배지 폭
		
		// 헤더 자체의 가로폭을 좌측레일 + 타임라인 총폭으로 확장
		$('.header').css('width', (leftRailW + totalW) + 'px');
		
		const $m = $('#rulerMonth').empty();
		const $w = $('#rulerWeek').empty();
		const $d = $('#rulerDay').empty();
		
		// Month
		let cur = new Date(start);
		while (cur <= end){
			const endOfMonth = new Date(cur.getFullYear(), cur.getMonth()+1, 0);
			const segEnd = end < endOfMonth ? end : endOfMonth;
			const len = days(cur, segEnd) + 1;
			$('<div class="cell"></div>')
			.css('width', (len * state.pxPerDay) + 'px')
			.text(`${cur.getFullYear()}년 ${cur.getMonth()+1}월`)
			.appendTo($m);
			cur = new Date(segEnd); cur.setDate(cur.getDate()+1);
		}
		
		// Week (일요일 시작)
		cur = new Date(start);
		while (cur <= end){
			const deltaToNextSun = (7 - cur.getDay()) % 7;
			const nextSun = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate() + deltaToNextSun);
			const blockEnd = (deltaToNextSun === 0) ? cur : new Date(+nextSun - MS);
			const segEnd = end < blockEnd ? end : blockEnd;
			const len = days(cur, segEnd) + 1;
			$('<div class="cell"></div>')
			.css('width', (len * state.pxPerDay) + 'px')
			.text('W' + weekOfYear(cur))
			.appendTo($w);
			cur = new Date(segEnd); cur.setDate(cur.getDate()+1);
		}
		
		// Day
		const todayStr = sod(new Date()).getTime(); // 오늘 날짜(시/분/초 제거)
		for (let i = 0; i < totalDays; i++){
			const dt = new Date(+start + i*MS);
			const $c = $('<div class="cell"></div>').text(dt.getDate());
			if ([0,6].includes(dt.getDay())) $c.addClass('day-weekend');
			
			// 오늘 날짜 칸이면 붉은 배경 적용
			if (sod(dt).getTime() === todayStr) {  $c.addClass('day-today'); }
			
			$d.append($c);
		}
		
		
		$('.ruler-row').css('width', totalW + 'px');
		$('#headerRulers').css('width', totalW + 'px');
		$('.header-right').css('width', `calc(${totalW}px + var(--badge-col-width))`);
		
		// '계획' 세로배지 높이를 rulers 총 높이에 맞춤
		const rulersH = document.getElementById('headerRulers').offsetHeight;
		$('#planBadge').css('height', rulersH + 'px');
	}

	// ===== 그룹 DOM 생성 =====
	function buildRows(){
	    const $container = $('#rowsContainer').empty();
	    const totalDays = days(state.viewStart, state.viewEnd) + 1;
	    const totalW = totalDays * state.pxPerDay;
	    
	    const labelW = cssVarPx('--label-width');
	    const badgeW = cssVarPx('--badge-col-width');
	    const gapW   = cssVarPx('--col-gap');
	    const leftRailW = labelW + gapW + badgeW;
	    
	    state.rowDefs.forEach(row=>{
			const $group = $('<div class="row-group"></div>)');
			
			$('<div class="group-label"></div>')
			.html('<span style="color:white;">'+row.label+'</span><span style="color:yellow;">'
			                                   +row.기계종류+'</span><span style="color:white;">'
			                                   +row.eqpNm+'</span><span style="color:yellow;">'
			                                   +row.mngIdNm + ' - ' + row.수주구분 +'</span><span style="color:white;">'
			                                   +row.기계구분+'</span><span style="color:white;">'
			                                   +row.clntNm+'('+row.clntPjtNm+')</span>')
			.appendTo($group);
			
			$group.css('width', (leftRailW + totalW) + 'px'); // ★ 포인트
			
			
			const $box = $('<div class="group-box"></div>').css('width', (badgeW + gapW + totalW + 16) + 'px');  // ✅ 전체 폭 반영
			$group.append($box);
	
			state.categories.forEach(cat=>{
				const items = state.rowsData?.[row.key]?.[cat] || [];
				const $line = $('<div class="group-line"></div>');
				$('<div class="line-badge"></div>').text(cat).appendTo($line);
				
				$('<div class="row-track"></div>')
					.attr('data-row', row.key)
					.attr('data-cat', cat)
					.appendTo($line);
				$box.append($line);
			});
	
			$container.append($group);
		});
	}

	// ===== 겹침 분석 + 색 인덱스 =====
	function layoutOneLine(raw){
		const arr = raw.map(it=>{
			const s = clamp(parse(it.start), state.viewStart, state.viewEnd);
			const e = clamp(parse(it.end),   state.viewStart, state.viewEnd);
			return {...it, s, e, overlapped:false, leader:false, colorIdx:0};
		}).filter(it=> it.e>=state.viewStart && it.s<=state.viewEnd)
	      .sort((a,b)=> a.s-b.s || a.e-b.e);

	    const active=[]; let clusterSeq=0;
		for(const cur of arr){
			for(let i=active.length-1;i>=0;i--) if(+active[i].e < +cur.s) active.splice(i,1);
		
			if (active.length){
				cur.overlapped = true; active.forEach(a=> a.overlapped=true);
				const leader = active.reduce((m,x)=> (+x.s < +m.s ? x:m), active[0]);
				leader.leader = true;
				cur.colorIdx = clusterSeq % 3; clusterSeq++;
			} else {
				clusterSeq = 0; cur.colorIdx = 0; clusterSeq++;
			}
			active.push(cur);
		}
	    return arr;
	}

	function paintTrackShading(){
		const start = sod(state.viewStart);
		const end   = sod(state.viewEnd);
		const total = days(start, end) + 1;
		const today = +sod(new Date());
		
		// 모든 트랙에서 기존 음영 제거
		$('.row-track').each(function(){
			$(this).find('.shade').remove();
		});
		
		// 하루씩 스캔해서 필요 시 음영 div 추가
		for (let i=0; i<total; i++){
			const dt = new Date(+start + i*MS);
			const left = i * state.pxPerDay;
			const w = state.pxPerDay;
			
			const wknd = [0,6].includes(dt.getDay());
			const isToday = (+sod(dt) === today);
			
			if (!wknd && !isToday) continue;
			
			const cls = isToday ? 'today' : 'weekend';
			// 각 트랙에 동일 위치에 오버레이 추가
			$('.row-track').each(function(){
				$('<div class="shade '+cls+'"></div>')
					.css({ left:left, width:w })
					.appendTo(this);
			});
		}
	}

  
  
	function renderRowSVG($track, items){
// 	    $track.empty(); // ❌ 트랙의 모든 자식 삭제 → 음영/오늘선 사라짐
	    $track.children('svg').remove() //  바를 담은 SVG만 교체
	
	    const totalDays = days(state.viewStart, state.viewEnd)+1;
	    const w = totalDays*state.pxPerDay;
	    const h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--lane-height'));
	    const svg = make('svg', { width:w, height:h });
	    $track.css('width', w+'px').append(svg);
	
	    const laid = layoutOneLine(items);
	
	    const today = sod(new Date()); // 오늘 00:00
	    
		// 시작 이른 것이 "위"로 보이도록 역순 append
		laid.slice().reverse().forEach(it=>{
			const x0 = xFromDate(it.s);
			const bw = Math.max(12, (days(it.s, it.e)+1)*state.pxPerDay);
			const y  = 0;
			
			// 종료일이 오늘보다 이전이면 expired 클래스 추가
			const isExpired = it.e < today;
	        const rectClass = `bar${it.overlapped?' overlap':''}${it.leader?' leader':''} ci-${it.colorIdx}${isExpired?' expired':''}`;

			const rect = make('rect', {
				x:x0, y:y, width:bw, height:h, rx:8, ry:8,
				class:rectClass,
				'data-key':it.key
			});
			
			// 중앙 정렬 라벨
			const label = make('text', {
				x: x0 + bw/2, y: h/2, class:'bar-label'
			});
			label.textContent = it.label;
			
			// 좌/우 핸들
			const handleW = 6;
			const lh = make('rect', { x:x0,            y:0, width:handleW, height:h, class:'handle', 'data-dir':'w', 'data-key':it.key });
			const rh = make('rect', { x:x0 + bw - handleW, y:0, width:handleW, height:h, class:'handle', 'data-dir':'e', 'data-key':it.key });
			
			svg.appendChild(rect);
			svg.appendChild(label);
			svg.appendChild(lh);
			svg.appendChild(rh);
			
			enableDragResize(svg, rect, label, lh, rh, it);
		});
	}

	// ===== 드래그/리사이즈 (Pointer Events) =====
	let dragState=null; // {mode,key,startX,origStart,origEnd,widthDays,svg,rect,label,lh,rh,pointerId,target,name}
	function enableDragResize(svg, rect, label, lh, rh, it){
		const startDrag = (mode) => (ev) => {
			ev.preventDefault();
			const target = ev.target;
			if (target.setPointerCapture) target.setPointerCapture(ev.pointerId || 1);
			dragState = {
				mode, key: it.key,
				startX: pageX(ev),
				origStart: it.s, origEnd: it.e,
				widthDays: days(it.s, it.e),
				svg, rect, label, lh, rh,
				pointerId: ev.pointerId || 1,
				target, name: it.label
			};
			svg.classList.add('dragging');
			showTip(ev.clientX, ev.clientY, fmtRange(it.s, it.e, it.label));
	    };

		rect.style.cursor='move';
		rect.addEventListener('pointerdown', startDrag('move'));
		rh.addEventListener('pointerdown', startDrag('e'));
		lh.addEventListener('pointerdown', startDrag('w'));
		
		const onPointerMove = (e) => {
			if (!dragState) return;
			const dx = pageX(e) - dragState.startX;
			const dd = Math.round(dx / state.pxPerDay);

			if (dragState.mode === 'move'){
				const newStart = dateFromX(xFromDate(dragState.origStart) + dd*state.pxPerDay);
				const newEnd   = new Date(+newStart + dragState.widthDays*MS);
				syncBarVisual(dragState, newStart, newEnd);
				moveTip(e.clientX, e.clientY, fmtRange(
					clamp(newStart, state.viewStart, state.viewEnd),
					clamp(newEnd,   state.viewStart, state.viewEnd),
					dragState.name
				));
			} else if (dragState.mode === 'e'){
				let newEnd = new Date(+dragState.origEnd + dd*MS);
				if (newEnd < dragState.origStart) newEnd = dragState.origStart;
					syncBarVisual(dragState, dragState.origStart, newEnd);
					moveTip(e.clientX, e.clientY, fmtRange(
						clamp(dragState.origStart, state.viewStart, state.viewEnd),
						clamp(newEnd,              state.viewStart, state.viewEnd),
						dragState.name
					));
			} else if (dragState.mode === 'w'){
				let newStart = new Date(+dragState.origStart + dd*MS);
				if (newStart > dragState.origEnd) newStart = dragState.origEnd;
				syncBarVisual(dragState, newStart, dragState.origEnd);
				moveTip(e.clientX, e.clientY, fmtRange(
					clamp(newStart,              state.viewStart, state.viewEnd),
					clamp(dragState.origEnd,     state.viewStart, state.viewEnd),
					dragState.name
				));
			}
		};
	
	    const onPointerUp = (e) => {
			if (!dragState) return;
			const nowX = parseFloat(dragState.rect.getAttribute('x'));
			const nowW = parseFloat(dragState.rect.getAttribute('width'));
			const s = dateFromX(nowX);
			const spanDays = Math.max(0, Math.round(nowW / state.pxPerDay) - 1);
			const eDate = new Date(+s + spanDays * MS);
			
			applyItemChange(dragState.svg, dragState.key, s, eDate);
			
			if (dragState.target && dragState.target.releasePointerCapture){
				try { dragState.target.releasePointerCapture(dragState.pointerId); } catch {}
			}
			dragState.svg.classList.remove('dragging');
			dragState = null;
			hideTip();
	    };
	
	    svg.addEventListener('pointermove', onPointerMove);
	    svg.addEventListener('pointerup', onPointerUp);
	    svg.addEventListener('pointercancel', onPointerUp);
	}

	// 드래그 중 시각 좌표만 갱신
	function syncBarVisual(ds, s, e){
		s = clamp(s, state.viewStart, state.viewEnd);
		e = clamp(e, state.viewStart, state.viewEnd);
		const h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--lane-height'));
		const x = xFromDate(s);
		const w = Math.max(12, (days(s,e)+1)*state.pxPerDay);
		const handleW = 6;
		
		ds.rect.setAttribute('x', x);
		ds.rect.setAttribute('width', w);
		ds.label.setAttribute('x', x + w/2);
		ds.label.setAttribute('y', h/2);
		ds.lh.setAttribute('x', x);
		ds.rh.setAttribute('x', x + w - handleW);
	}

	function pageX(e){
		const oe = e.originalEvent || e;
		return oe.touches ? oe.touches[0].pageX : oe.pageX;
	}

	function applyItemChange(svg, itemKey, newStart, newEnd){
		const $track = $(svg).closest('.row-track');
		const rowKey = $track.data('row');
		const cat    = $track.data('cat');
		const arr = state.rowsData[rowKey][cat];
		const idx = arr.findIndex(x=>x.key===itemKey);
		if (idx<0) return;
		
		newStart = clamp(newStart, state.viewStart, state.viewEnd);
		newEnd   = clamp(newEnd,   state.viewStart, state.viewEnd);
		
		arr[idx].start = fmt(newStart);
		arr[idx].end   = fmt(newEnd);
		
		renderRowSVG($track, arr); // 겹침/팔레트/라벨 중앙 재계산
//     console.log('[change]', { rowKey, cat, itemKey, startDate:fmt(newStart), endDate:fmt(newEnd) });
	}

	function drawTodayLine(){
		const t = sod(new Date());
		if (t < state.viewStart || t > state.viewEnd) return;
		const left = xFromDate(t);
		$('.row-track').each(function(){
			$(this).append($('<div class="today-line"/>').css({left}));
		});
	}

	// === 줌 ===
	function updateFontSizes(pxPerDay){
		const ratio = pxPerDay/24;
		const clamp = v => Math.min(14, Math.max(8, Math.round(v)));
		
		const labelFont = clamp(14*ratio);
		const rulerFont = clamp(12*ratio);
		const barFont   = clamp(12*ratio);
		
		document.documentElement.style.setProperty('--label-font-size', labelFont+'px');
		document.documentElement.style.setProperty('--ruler-font-size', rulerFont+'px');
		document.documentElement.style.setProperty('--bar-font-size',   barFont  +'px');
	}
  
  
	function setZoom(px){
		openProgress(true);
		px = Math.max(2, Math.min(64, px|0));
		state.pxPerDay = px;
		document.documentElement.style.setProperty('--px-per-day', px+'px');
		$('#zoom').val(px); $('#zoomVal').text(px);
		updateFontSizes(px);
		renderAll();
	}




	// 초기화 버튼
	function initSearch() {
		$('[data-search]').off("change");	//바인딩기능 오프
		$('.contents.search select, .contents.search input').val("");
		// 회사 선택 상자 값 설정
		$("#coCd_S").val(jwt.coCd);
		// 날짜 필드 값 설정
		$("#strtDt_S").val(dateToStr(moment().subtract(6, "months").startOf("month").toDate()));
		$("#endDt_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
	
		// 검색조건 이벤트 bind
		$('[data-search]').on("change", function(){
			searchData ();
		});
	
	}

	// 검색 버튼
	function DataSearch() {
		searchData ();
	}

	// 거래처 검색 함수
	function opendClntSearch(inputValue) {
		var paramObj = {
	            "searchValue" : inputValue,
	            "clntDivCd"   : "CLNTDIV12"
	        };
		openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsClntCd_S').val(row.clntCd);
			$('#ordrsClntNm_S').val(row.clntNm);
			//gridView.setData(0);
			DataSearch();
		});
	}

	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
	function wbsSalesCodeSearch() {
	    var paramObj = {
	       "coCd" : $('#coCd_S').val(),
	       "searchValue": $('#salesCd_S').val()
	    };
	    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
	        var row = grid.target.getList("selected")[0];
	        $('#salesCd_S').val(row.salesCd);
	        DataSearch();
	    });
	}

	// 판매법인 set
	function setByCoCd(value) {
	    $('#main_area #taxivcCoprt').data("rprc", value);
	    $('#main_area #taxivcCoprt option:not([value=""])').remove()
	    setCommonSelect($('#main_area #taxivcCoprt'));
	}
	
	
	function prdrGrpMutiSelectAddIn() {
		var paramObj = {
			"codeKind" : 'PRDTDIV',
		};
		postAjaxSync("/user/sm/sm03/selectMultiPrdtGrpCodeList", paramObj, null, function(data) {
			var list = data.prdtGrpCodeList;
			multiPrjctSelectHtml(list, $('#multiple-checkboxes-prdtGrp'));  //기계종류 코드를 multi select 자동 생성
		})
	}
</script>
</body>
</html>
