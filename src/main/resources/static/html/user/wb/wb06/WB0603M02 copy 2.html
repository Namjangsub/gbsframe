<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹¤í–‰ê³„íš > ê¸°ê³„ë³„ WBSí˜„í™© (HTML5 + jQuery)</title>

  <!-- CDN (ì‚¬ë‚´ë§/ì˜¤í”„ë¼ì¸ì´ë©´ íŒŒì¼ë¡œ ë‚´ë ¤ë°›ì•„ ë¡œì»¬ ê²½ë¡œë¡œ êµì²´) -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f4f6fa;
      --panel:#ffffff;
      --line:#e5e9f2;
      --text:#1f2a37;
      --muted:#6b7280;

      --leftW: 350px;     /* ì¢Œì¸¡ ê³ ì • ì»¬ëŸ¼ í­ */
      --rightW: 180px;    /* ìš°ì¸¡ Remarks í­ */
      --cellW: 28px;      /* íƒ€ì„ë¼ì¸ 1ì¼ í­ */
      --rowH: 30px;

      --btn:#2f3a4a;
      --btn2:#475569;
      --primary:#1d4ed8;

      --shadow: 0 6px 18px rgba(16,24,40,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", sans-serif;
      color:var(--text);
      background:var(--bg);
    }

    /* ìƒë‹¨ ê³ ì • ê²€ìƒ‰ ì˜ì—­ */
    .topbar{
      position:sticky;
      top:0;
      z-index:100;
      background:linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
      border-bottom:1px solid var(--line);
      box-shadow: 0 2px 12px rgba(16,24,40,.06);
    }
    .topbar-inner{
      padding:14px 16px 10px;
      max-width: 1920px;
      margin:0 auto;
    }
    .title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:-.2px;
    }
    .title .crumb{
      font-weight:700;
      color:#0f172a;
    }
    .title .crumb small{
      font-weight:700;
      color:var(--muted);
    }

    .btns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      border:1px solid rgba(255,255,255,.15);
      background:var(--btn2);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      -webkit-user-select:none;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.dark{background:var(--btn)}
    .btn.primary{background:var(--primary)}
    .btn.ghost{
      background:#fff;
      color:#111827;
      border:1px solid var(--line);
    }

    .search-grid{
      display:grid;
      grid-template-columns: 1.1fr 1.1fr 1.2fr 1fr 1.2fr 1fr 1fr 1fr;
      gap:10px 12px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:700;
    }
    .control{
      display:flex;
      gap:8px;
      align-items:center;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      height:38px;
    }
    .control input, .control select{
      width:100%;
      border:0;
      outline:0;
      font-size:13px;
      background:transparent;
      color:#0f172a;
    }
    .icon-btn{
      width:28px;height:28px;
      border-radius:8px;
      border:1px solid var(--line);
      background:#f8fafc;
      cursor:pointer;
      font-weight:900;
      color:#334155;
    }
    .icon-btn:hover{background:#eef2ff;border-color:#c7d2fe}

    .search-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      align-items:center;
      grid-column: 1 / -1;
      padding-top:2px;
    }

    /* ë ˆì „ë“œ */
    .legend{
      max-width: 1900px;
      margin:2px auto 0;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      gap:0px;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      color:#0f172a;
    }
    .dot{
      width:10px;height:10px;border-radius:3px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }

    /* í•˜ë‹¨ WBS */
    .page{
      max-width: 1920px;
      margin:0 auto;
      padding:5px 5px 5px;
    }

    .wbs-card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .wbs-toolbar{
      display:flex;
      justify-content:flex-end;
      gap:1px;
      padding:2px 2px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff, #fbfcff);
    }
    .wbs-toolbar .btn{
      border-radius:10px;
      padding:8px 14px;
      font-size:12px;
    }
    .wbs-toolbar .btn.primary{background:#2563eb}
    .wbs-toolbar .btn.ghost{background:#fff}

    .wbs-scroll{
      height: calc(100vh - 220px);
      overflow:auto;
      background:#fff;
    }

    /* ê³µí†µ Row */
    .wbs-row{
      display:flex;
      min-height:var(--rowH);
      border-bottom:1px solid var(--line);
      position:relative;
    }

    /* Header Row sticky */
    .wbs-row.header{
      position:sticky;
      top:0;
      z-index:50;
      background:#f8fafc;
      border-bottom:1px solid #dbe2ee;
    }
    .wbs-row.header .cell{
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:#f8fafc;
    }

    /* ì¢Œì¸¡/ìš°ì¸¡ sticky pane */
    .pane-left{
      width:var(--leftW);
      flex:0 0 var(--leftW);
      display:flex;
      position:sticky;
      left:0;
      z-index:30;
      background:#fff;
      border-right:1px solid var(--line);
    }
    .wbs-row.header .pane-left{background:#f8fafc}
    .pane-right{
      width:var(--rightW);
      flex:0 0 var(--rightW);
      position:sticky;
      right:0;
      z-index:30;
      background:#fff;
      border-left:1px solid var(--line);
    }
    .wbs-row.header .pane-right{background:#f8fafc}

    .pane-timeline{
      flex:1 1 auto;
      position:relative;
      background:#fff;
      z-index:29;
    }

    .cell{
      padding:8px 10px;
      display:flex;
      align-items:center;
      border-right:1px solid var(--line);
      height:100%; /*var(--rowH);*/
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ì¢Œì¸¡ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ */
    .c-machine{width:70px; flex:0 0 70px; justify-content:center; font-weight:900; color:#0f172a;}
    .c-machine.merged{ color: transparent; }
    .machine-merge-overlay{
      position:absolute;
      left:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#0f172a;
      background: #fff;
      border-right:1px solid var(--line);
      z-index:20;
      pointer-events:none;
    }
    .c-project{width:210px; flex:0 0 210px; font-weight:800;}
    .c-equip{width:170px; flex:0 0 170px; color:#111827; font-weight:800; font-size:12px;}
    .c-code{width:110px; flex:0 0 110px; color:#334155; font-weight:900; font-size:12px;}
    .c-owner{width:140px; flex:0 0 140px; display:flex; flex-direction:column; gap:2px;}
    .owner-badges{display:flex; gap:6px; font-size:11px; color:var(--muted); font-weight:800;}
    .owner-badges b{color:#0f172a}
    .c-modeling{width:150px; flex:0 0 150px; display:flex; flex-direction:column; gap:2px; font-size:12px; color:#0f172a;}
    .c-purchase{width:70px; flex:0 0 70px; justify-content:center; font-weight:800; color:#0f172a;}

    /* Remarks */
    .remarks{
      height:var(--rowH);
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      color:#b91c1c;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .remarks small{
      color:#64748b;
      font-weight:800;
    }

    /* ê·¸ë£¹ ë¼ë²¨ í–‰ */
    .group-sep{
      background:#f3f6fb;
      font-weight:900;
      color:#0f172a;
    }
    .group-sep .pane-timeline{
      background:#f3f6fb;
    }
    .group-sep .pane-right{
      background:#f3f6fb;
    }
    .group-sep .cell{
      border-right:1px solid #dfe6f4;
      background:#f3f6fb;
      height:36px;
    }
    .group-sep .pane-left{background:#f3f6fb}

    /* íƒ€ì„ë¼ì¸ í—¤ë” */
    .timeline-header{
      position:sticky;
      top:0;
      z-index:60;
      background:#f8fafc;
    }
    .timeline-months, .timeline-days{
      display:flex;
      width:fit-content;
      border-bottom:1px solid #dbe2ee;
    }
    .timeline-month{
      height:26px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      border-right:1px solid #dbe2ee;
      background:#f8fafc;
      position:relative;
    }
    .timeline-day{
      width:var(--cellW);
      height:26px;
      display:flex;
      align-items:center;
      justify-content:center;
      /* scale with cell width but cap at 14px */
      font-size: clamp(10px, calc(var(--cellW) * 0.72), 14px);
      font-weight:900;
      color:#64748b;
      border-right:1px solid #e6ebf5;
      background:#ffffff;
    }
    .timeline-day.label{
      background:#f8fafc;
    }

    /* íƒ€ì„ë¼ì¸ ìº”ë²„ìŠ¤(í–‰ë³„) */
    .timeline-canvas{
      position:relative;
      height:100%; /*var(--rowH);*/
      width:fit-content;
      background:
        linear-gradient(to right, rgba(229,233,242,1) 1px, transparent 1px) 0 0 / var(--cellW) 100%;
    }
    .timeline-canvas.alt{
      background:
        linear-gradient(to right, rgba(229,233,242,1) 1px, transparent 1px) 0 0 / var(--cellW) 100%,
        linear-gradient(to bottom, rgba(248,250,252,1) 50%, rgba(255,255,255,1) 50%);
      background-size: var(--cellW) 100%, 100% 100%;
    }

    /* TODAY ë¼ì¸ */
    .today-line{
      position:absolute;
      top:0;
      bottom:0;
      width:0;
      border-left:4px dashed #dc2626;
      z-index:25;
      pointer-events:none;
    }
    .today-badge{
      position:absolute;
      top:2px;
      transform:translateX(-50%);
      background:#dc2626;
      color:#fff;
      font-weight:900;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      z-index:70;
      pointer-events:none;
      box-shadow:0 6px 12px rgba(220,38,38,.25);
    }

    /* ë°”(ì„¸ê·¸ë¨¼íŠ¸) */
    .bar{
      position:absolute;
      top:2px;
      height:26px;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      color:#0f172a;
      box-shadow:0 6px 14px rgba(16,24,40,.10);
      border:1px solid rgba(15,23,42,.10);
      cursor:move;
      -webkit-user-select:none;
      user-select:none;
      overflow:hidden;
    }
    .bar .txt{
      padding:0 8px;
      letter-spacing:-.2px;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    .dirty-dot{
      display:none;
      margin-left:6px;
      width:8px;height:8px;border-radius:50%;
      background:#f59e0b;
      box-shadow:0 0 0 2px rgba(245,158,11,.18);
    }
    .row-dirty .dirty-dot{display:inline-block}

    /* jQuery UI í•¸ë“¤ */
    .ui-resizable-e, .ui-resizable-w{
      width:10px;
      top:0; bottom:0;
      background:rgba(255,255,255,.0);
    }
    .ui-resizable-e{right:-6px}
    .ui-resizable-w{left:-6px}
    .ui-resizable-handle:hover{background:rgba(15,23,42,.08)}

    /* ë¶€ì„œ ìƒ‰ìƒ(ë ˆì „ë“œì™€ ë™ì¼ ë§¤í•‘) */
    .dept-S01 { background:#c4b5fd; }  /* ì˜ì—… */
    .dept-S02 { background:#fbcfe8; }  /* ì—°êµ¬ì†Œ */
    .dept-S03 { background:#fdba74; }  /* êµ¬ë§¤ */
    .dept-S04 { background:#a7f3d0; }  /* ìƒì‚° */
    .dept-S12 { background:#fecaca; }  /* ì˜/ì—° */
    .dept-S23 { background:#d9f99d; }  /* ì—°/êµ¬ */
    .dept-S34 { background:#99f6e4; }  /* êµ¬/ìƒ */
    .dept-S41 { background:#BDB8D3; }  /* ìƒ/ì˜ */

    /* Toast / Modal */
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:200;
      background:#0f172a;
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-weight:800;
      box-shadow:0 12px 26px rgba(0,0,0,.22);
      display:none;
      max-width: 360px;
    }
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.55);
      z-index:300;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(920px, 100%);
      background:#fff;
      border-radius:14px;
      border:1px solid var(--line);
      box-shadow:0 22px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal .m-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:#f8fafc;
      font-weight:900;
    }
    .modal .m-body{
      padding:12px 14px;
      max-height: 62vh;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:#0f172a;
      background:#ffffff;
      white-space:pre-wrap;
    }
    .modal .m-foot{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background:#fbfcff;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title-row">
        <div class="title">
          <span style="font-size:18px;">âš™ï¸</span>
          <span class="crumb">ì‹¤í–‰ê³„íš <small>&gt;</small> ê¸°ê³„ë³„ WBSí˜„í™©</span>
        </div>
        <div class="btns">
          <button class="btn dark" id="btnHelp">ë„ì›€ë§ (Help)</button>
          <button class="btn" id="btnReset">ì´ˆê¸°í™” (Reset)</button>
          <button class="btn primary" id="btnSearch">ê²€ìƒ‰ (Search)</button>
        </div>
      </div>

      <div class="search-grid">
        <div class="field">
          <label>* íšŒì‚¬ (Company)</label>
          <div class="control">
            <select id="fCompany">
              <option value="ê±´ì–‘TT">ê±´ì–‘TT</option>
              <option value="ê±´ì–‘IT">ê±´ì–‘IT</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>SalesCode</label>
          <div class="control">
            <input id="fSalesCode" placeholder="SalesCode ì…ë ¥" />
            <button class="icon-btn" id="btnSalesSearch" title="SalesCode ê²€ìƒ‰">ğŸ”</button>
          </div>
        </div>

        <div class="field">
          <label>* ìˆ˜ì£¼ì¼ì (From~To)</label>
          <div class="control">
            <input id="fFrom" type="date" />
            <span style="color:#94a3b8;font-weight:900;">~</span>
            <input id="fTo" type="date" />
          </div>
        </div>

        <div class="field">
          <label>ê³ ê°ì‚¬PJT</label>
          <div class="control">
            <select id="fPjt">
              <option value="">ì „ì²´</option>
              <option value="PJT-A">PJT-A</option>
              <option value="PJT-B">PJT-B</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>ê¸°ê³„ì¢…ë¥˜</label>
          <div class="control">
            <select id="fMachine">
              <option value="">ì „ì²´</option>
              <option value="NX5E">NX5E</option>
              <option value="BC4i">BC4i</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>ê³ ê°ì‚¬</label>
          <div class="control">
            <input id="fCustomer" placeholder="ê³ ê°ì‚¬ ì…ë ¥" />
            <button class="icon-btn" id="btnCustomerSearch" title="ê³ ê°ì‚¬ ê²€ìƒ‰">ğŸ”</button>
          </div>
        </div>

        <div class="field">
          <label>ìˆ˜ì£¼êµ¬ë¶„</label>
          <div class="control">
            <select id="fOrderType">
              <option value="">ì „ì²´</option>
              <option value="ì‹ ê·œ">ì‹ ê·œ</option>
              <option value="ê°œì¡°">ê°œì¡°</option>
              <option value="AS">AS</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>PMê³„íšìƒíƒœ</label>
          <div class="control">
            <select id="fPmStatus">
              <option value="">ì „ì²´</option>
              <option value="ê³„íš">ê³„íš</option>
              <option value="ì§„í–‰">ì§„í–‰</option>
              <option value="ì™„ë£Œ">ì™„ë£Œ</option>
              <option value="ì§€ì—°">ì§€ì—°</option>
            </select>
          </div>
        </div>

      </div>
    </div>
		<div class="legend">
	    	<div id="legend"></div>
	      <div class="wbs-toolbar">
	          <span style="color:var(--muted);font-weight:800;font-size:12px;">
	            * ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆë¡œ ì¼ì • ë³€ê²½ ê°€ëŠ¥ (SAVE CHANGESë¡œ ë³€ê²½ë¶„ í™•ì¸)
	          </span>
	        <button class="btn primary" id="btnSave">SAVE CHANGES</button>
	        <button class="btn ghost" id="btnExport">EXPORT EXCEL</button>
	        <button class="btn ghost" id="btnPrint">PRINT</button>
	      </div>
	      
	      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
	          <span style="color:var(--muted);font-weight:800;font-size:12px;">(ì¤Œ: ìŠ¬ë¼ì´ë” ë˜ëŠ” Ctrl+ë§ˆìš°ìŠ¤íœ )</span>
	        <label style="font-size:11px;color:#64748b;">ì¤Œ(px/day):</label>
	        <input id="zoomSlider" type="range" min="4" max="30" value="16"/>
	        <span id="zoomVal">16</span>
	      </div>
	  </div>
  </div>

  <div class="page">
    <div class="wbs-card">

      <div class="wbs-scroll" id="wbsScroll">
        <!-- WBS ë Œë”ë§ ì˜ì—­ -->
        <div id="wbs"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <div class="m-head">
        <div id="modalTitle">ë‚´ìš©</div>
        <button class="btn ghost" id="modalClose">ë‹«ê¸°</button>
      </div>
      <div class="m-body" id="modalBody"></div>
      <div class="m-foot">
        <button class="btn dark" id="modalCopy">ë³µì‚¬</button>
        <button class="btn primary" id="modalOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 1) ìƒ˜í”Œ ë°ì´í„°/ì„¤ì •
     ************************/
    // íƒ€ì„ë¼ì¸ 1ì¼ í­(px) â€” ëŸ°íƒ€ì„ì— CSS ë³€ìˆ˜(--px-per-day ë˜ëŠ” --cellW)ì—ì„œ ì´ˆê¸°ê°’ì„ ì½ì–´ì˜¨ë‹¤
    let CELL_W = (function(){
      try{
        const cs = getComputedStyle(document.documentElement);
        const v1 = cs.getPropertyValue('--px-per-day') || cs.getPropertyValue('--cellW');
        if(v1){
          return Math.max(4, Math.round(parseFloat(v1))); // ìµœì†Œ 4px
        }
      }catch(e){}
      return 28;
    })();
    const VIEW_START = "2026-01-01";    // íƒ€ì„ë¼ì¸ ì‹œì‘
    const VIEW_END   = "2026-04-30";    // íƒ€ì„ë¼ì¸ ë
    const DEMO_TODAY = "2026-01-27";    // ìŠ¤í¬ë¦°ìƒ· ìœ ì‚¬ TODAY í‘œì‹œ(ë°ëª¨)
    const sod = d => { const x = new Date(d); x.setHours(0, 0, 0, 0); return x; };
    const fmt = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    const parse = s => sod(new Date(s));
    const days = (a, b) => Math.round((+sod(b) - +sod(a)) / MS);

    const jwt = { coCd: 'ê±´ì–‘TT', userId: 'USER001' };
    const DEPTS = [
      {code:"S01", name:"ì˜ì—…",         colorClass:"dept-S01"},
      {code:"S02", name:"ì—°êµ¬ì†Œ",       colorClass:"dept-S02"},
      {code:"S03", name:"êµ¬ë§¤",         colorClass:"dept-S03"},
      {code:"S04", name:"ìƒì‚°",         colorClass:"dept-S04"},
      {code:"S12", name:"ì˜/ì—°",        colorClass:"dept-S12"},
      {code:"S23", name:"ì—°/êµ¬",        colorClass:"dept-S23"},
      {code:"S34", name:"êµ¬/ìƒ",        colorClass:"dept-S34"},
      {code:"S41", name:"ìƒ/ì˜",        colorClass:"dept-S41"}
    ];

    // ì´ˆê¸° ë°ì´í„°(Resetìš©)
    const INITIAL = {
      viewStart: VIEW_START,
      viewEnd: VIEW_END,
      today: DEMO_TODAY,
      rows: [
        // ê·¸ë£¹: NX5E
        {type:"group", machine:"NX5E", title:"NX5E"},
        {
          id:"R1", machine:"NX5E", salesCode:"SC-25204",
          project:"FRT UPR(IMG) LH/RH", equip:"ê°ì‹¸ê¸° MOLD",
          code:"25204-01FBFUP",
          ownerDesign:"ê¹€ì˜ì¬", ownerModel:"ì„±ì›",
          modelingStart:"2026-01-19", modelingEnd:"2026-02-01",
          buyer:"í—ˆìƒë ¬",
          remarks:"â˜… ì¶œê³  ì§€ì—° ì˜ˆìƒ",
          segments:[
            {id:"R1-S1", dept:"S01", label:"ì˜",    start:"2026-01-02", end:"2026-01-15"},
            {id:"R1-S2", dept:"S02", label:"ì—°",    start:"2026-01-25", end:"2026-01-26"},
            {id:"R1-S3", dept:"S23", label:"ì—°/êµ¬", start:"2026-01-27", end:"2026-01-28"},
            {id:"R1-S4", dept:"S04", label:"ìƒ",    start:"2026-01-29", end:"2026-01-29"},
            {id:"R1-S5", dept:"S03", label:"êµ¬",    start:"2026-02-03", end:"2026-02-06"},
            {id:"R1-S6", dept:"S34", label:"êµ¬/ìƒ", start:"2026-02-07", end:"2026-02-10"}
          ]
        },
        {
          id:"R2", machine:"NX5E", salesCode:"SC-25204",
          project:"RR UPR(IMG) (CURTAIN)", equip:"LH/RH ê°ì‹¸ê¸°",
          code:"25204-02FBRUP",
          ownerDesign:"í•˜í˜„ë ¨", ownerModel:"ì„±ì›",
          modelingStart:"2026-01-27", modelingEnd:"2026-02-10",
          buyer:"",
          remarks:"â˜… ì¶œê³  ì§€ì—° ì˜ˆìƒ",
          segments:[
            {id:"R2-S1", dept:"S01", label:"ì˜",    start:"2026-01-05", end:"2026-01-21"},
            {id:"R2-S2", dept:"S02", label:"ì—°",    start:"2026-01-27", end:"2026-01-27"},
            {id:"R2-S3", dept:"S23", label:"ì—°/êµ¬", start:"2026-01-28", end:"2026-01-29"},
            {id:"R2-S4", dept:"S04", label:"ìƒ",    start:"2026-01-30", end:"2026-01-31"}
          ]
        },
        {
          id:"R3", machine:"NX5E", salesCode:"SC-25204",
          project:"RR A/REST LWR(IMG)", equip:"LH/RH ê°ì‹¸ê¸°",
          code:"25204-05FBRAR",
          ownerDesign:"í—ˆìƒí˜", ownerModel:"ë„¤ì˜¤",
          modelingStart:"2026-01-27", modelingEnd:"2026-02-10",
          buyer:"",
          remarks:"â˜… ì¶œê³  ì§€ì—° ì˜ˆìƒ",
          segments:[
            {id:"R3-S1", dept:"S01", label:"ì˜",    start:"2026-01-04", end:"2026-01-27"},
            {id:"R3-S2", dept:"S02", label:"ì—°",    start:"2026-01-29", end:"2026-01-30"},
            {id:"R3-S3", dept:"S23", label:"ì—°/êµ¬", start:"2026-02-01", end:"2026-02-03"},
            {id:"R3-S4", dept:"S34", label:"êµ¬/ìƒ", start:"2026-02-05", end:"2026-02-08"},
            {id:"R3-S5", dept:"S41", label:"ìƒ",    start:"2026-02-10", end:"2026-02-12"}
          ]
        },
        {
          id:"R4", machine:"NX5E", salesCode:"SC-25204",
          project:"CONSOLE", equip:"GARNISH(IMG) LHD/RHD",
          code:"25204-06FBNGA",
          ownerDesign:"ê¹€ì •ë¯¼", ownerModel:"ê¹€ì§€ì—°",
          modelingStart:"2026-01-08", modelingEnd:"2026-01-25",
          buyer:"",
          remarks:"â€»ë„ë©´ ì¶œë„ í›„ ì™¸ì£¼ì œì‘ í•´ì•¼í•¨",
          segments:[
            {id:"R4-S1", dept:"SE", label:"AB/ì¼", start:"2026-01-18", end:"2026-01-31"}
          ]
        },

        // ì „ì²´ ì¼ì •(í† íƒˆ) í–‰
        {type:"total", machine:"NX5E", title:"ì „ì²´ ì¼ì •" , code: "(Total Progress)",
         segments:[
           {id:"T1", dept:"S01", label:"ì˜ì—…",   start:"2026-01-07", end:"2026-01-31"},
           {id:"T2", dept:"S02", label:"ì—°êµ¬ì†Œ", start:"2026-02-01", end:"2026-02-28"},
           {id:"T3", dept:"S03", label:"êµ¬ë§¤",  start:"2026-03-01", end:"2026-03-25"},
           {id:"T4", dept:"S04", label:"ìƒì‚°",  start:"2026-03-26", end:"2026-04-10"},
           {id:"T5", dept:"S34", label:"ì‹œìš´ì „", start:"2026-04-11", end:"2026-04-30"}
         ],
         remarks:""
        },

        // ê·¸ë£¹: BC4i
        {type:"group", machine:"BC4i", title:"BC4i"},
        {
          id:"R5", machine:"BC4i", salesCode:"SC-25206",
          project:"FRT UPR ê°ì‹¸ê¸°", equip:"MOLD(2CAV)",
          code:"25206-01FBFUP",
          ownerDesign:"ê¹€ì¢…ì„±", ownerModel:"í¬ì¸",
          modelingStart:"2026-01-27", modelingEnd:"2026-02-10",
          buyer:"",
          remarks:"â˜… ì¶œê³  ì§€ì—° ì˜ˆìƒ",
          segments:[
            {id:"R5-S1", dept:"S01", label:"ì˜",    start:"2026-01-06", end:"2026-02-08"},
            {id:"R5-S2", dept:"S02", label:"ì—°",    start:"2026-02-09", end:"2026-02-10"},
            {id:"R5-S3", dept:"S23", label:"ì—°/êµ¬", start:"2026-02-11", end:"2026-02-13"},
            {id:"R5-S4", dept:"S41", label:"ìƒ",    start:"2026-02-14", end:"2026-02-15"}
          ]
        },

        // ì „ì²´ ì¼ì •(í† íƒˆ) í–‰
        {type:"total", machine:"BC4i", title:"ì „ì²´ ì¼ì •" , code: "(Total Progress)",
         segments:[
           {id:"T1", dept:"S01", label:"ì˜ì—…",   start:"2026-01-06", end:"2026-02-08"},
           {id:"T2", dept:"S02", label:"ì—°êµ¬ì†Œ", start:"2026-02-09", end:"2026-02-10"},
           {id:"T3", dept:"S03", label:"êµ¬ë§¤",  start:"2026-02-11", end:"2026-02-13"},
           {id:"T4", dept:"S41", label:"ìƒì‚°",  start:"2026-02-14", end:"2026-02-15"},
         ],
         remarks:""
        },
      ]
    };

    let STATE = deepClone(INITIAL);    // í˜„ì¬ ìƒíƒœ(ê²€ìƒ‰/ë“œë˜ê·¸ ë°˜ì˜)
    let ORIGINAL = deepClone(INITIAL); // Reset ê¸°ì¤€

    // STATE.todayë¥¼ ëŸ°íƒ€ì„ì˜ ì‹¤ì œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë®ì–´ì¨ì„œ TODAY ì„ ì„ ì‹¤ì œ ë‚ ì§œì— í‘œì‹œ
    (function setTodayToNow(){
      try{
        const d = new Date();
        const yy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        STATE.today = `${yy}-${mm}-${dd}`;
      }catch(e){
        // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ê°’ ìœ ì§€
        console.warn('setTodayToNow failed', e);
      }
    })();

    /***********************
     * 2) ìœ í‹¸
     ************************/
    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
    function ymd(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    function parseYMD(s){
      const [y,m,d] = s.split('-').map(Number);
      return new Date(y, m-1, d);
    }
    // business-day aware: count only weekdays (Mon-Fri)
    function daysBetween(a, b){
      const da = parseYMD(a);
      const db = parseYMD(b);
      if(da.getTime() === db.getTime()) return 0;
      let start = new Date(da), end = new Date(db);
      let sign = 1;
      if(start > end){ sign = -1; [start, end] = [end, start]; }

      // count weekdays strictly after start up to and including end
      let cnt = 0;
      const cur = new Date(start);
      cur.setDate(cur.getDate() + 1);
      while(cur <= end){
        const wd = cur.getDay(); // 0=Sun,6=Sat
        if(wd !== 0 && wd !== 6) cnt++;
        cur.setDate(cur.getDate() + 1);
      }
      return sign * cnt;
    }

    // add business days (Mon-Fri) to a yyyy-mm-dd date string
    function addDays(ymdStr, n){
      const d = parseYMD(ymdStr);
      if(n === 0) return ymd(d);
      const step = n > 0 ? 1 : -1;
      let remaining = Math.abs(n);
      while(remaining > 0){
        d.setDate(d.getDate() + step);
        const wd = d.getDay();
        if(wd !== 0 && wd !== 6) remaining--;
      }
      return ymd(d);
    }
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    // ì¼ì •ì—ì„œ ì‹¤ì œ ìµœì†Œ ì‹œì‘ì¼ / ìµœëŒ€ ì¢…ë£Œì¼ì„ ê³„ì‚°
    function computeProjectRange(){
      let minDate = null;
      let maxDate = null;
      (STATE.rows||[]).forEach(r=>{
        // ëª¨ë¸ë§ ì¼ì •
        if(r.modelingStart){
          const d = parseYMD(r.modelingStart);
          if(minDate===null || d < minDate) minDate = d;
        }
        if(r.modelingEnd){
          const d = parseYMD(r.modelingEnd);
          if(maxDate===null || d > maxDate) maxDate = d;
        }
        // ì„¸ê·¸ë¨¼íŠ¸ ì¼ì •
        (r.segments||[]).forEach(s=>{
          if(s.start){ const ds = parseYMD(s.start); if(minDate===null || ds < minDate) minDate = ds; }
          if(s.end  ){ const de = parseYMD(s.end  ); if(maxDate===null || de > maxDate) maxDate = de; }
        });
      });

      // fallback to current view if no dates found
      if(minDate===null || maxDate===null){
        return null;
      }

      // return in yyyy-mm-dd
      return { start: ymd(minDate), end: ymd(maxDate) };
    }

    function toast(msg){
      const $t = $("#toast");
      $t.stop(true,true).text(msg).fadeIn(120);
      setTimeout(()=> $t.fadeOut(280), 1600);
    }

    function openModal(title, body){
      $("#modalTitle").text(title);
      $("#modalBody").text(body);
      $("#modal").fadeIn(120).css("display","flex");
    }
    function closeModal(){ $("#modal").fadeOut(120); }

    /***********************
     * 3) ë ˆì „ë“œ/ê¸°ë³¸ ì„¸íŒ…
     ************************/
    function renderLegend(){
      const $l = $("#legend").empty();
      DEPTS.forEach(d=>{
        const $chip = $(`
          <span class="chip">
            <span class="dot ${d.colorClass}"></span>
            <span>${d.name}</span>
          </span>
        `);
        $l.append($chip);
      });
    }

    function initDates(){
      // ê²€ìƒ‰ ê¸°ë³¸ê°’(ìƒ˜í”Œ)
      const today = sod(new Date());
      const startOfMonth = new Date(today.getFullYear(), today.getMonth() - 6, 1);
      const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      $('#fFrom').val(fmt(startOfMonth));
      $('#fTo').val(fmt(endOfMonth));
      $('#fCompany').val(jwt.coCd);
    }

    /***********************
     * 4) íƒ€ì„ë¼ì¸ í—¤ë” ìƒì„±
     ************************/
    function buildTimelineHeader(viewStart, viewEnd){
      const start = parseYMD(viewStart);
      const end   = parseYMD(viewEnd);

      // ì›” ê·¸ë£¹ ê³„ì‚° (ì£¼ë§ì€ ê±´ë„ˆë›°ê³  í‰ì¼ë§Œ ì§‘ê³„)
      const months = [];
      let iter = parseYMD(viewStart);
      let currentKey = `${iter.getFullYear()}-${iter.getMonth()}`;
      let count = 0;

      const allDays = [];
      while(iter <= end){
        const key = `${iter.getFullYear()}-${iter.getMonth()}`;
        if(key !== currentKey){
          // ì´ì „ ì›” ë§ˆê°(í‰ì¼ë§Œ ì¹´ìš´íŠ¸)
          const [y,m] = currentKey.split('-').map(Number);
          months.push({y, m, days: count});
          currentKey = key;
          count = 0;
        }

        const wd = iter.getDay(); // 0=Sun,6=Sat
        const isWeekend = (wd === 0 || wd === 6);
        if(!isWeekend){
          allDays.push(new Date(iter));
          count++;
        }

        iter.setDate(iter.getDate()+1);
      }
      // ë§ˆì§€ë§‰ ì›”
      {
        const [y,m] = currentKey.split('-').map(Number);
        months.push({y, m, days: count});
      }

      // DOM ìƒì„± (ì›”ì€ í‰ì¼ ìˆ˜ê°€ 0ì¸ ê²½ìš° ìƒëµ)
      const $wrap = $(`<div class="timeline-header"></div>`);
      const $months = $(`<div class="timeline-months"></div>`);
      months.forEach(m=>{
        if(m.days <= 0) return; // í‰ì¼ì´ ì—†ëŠ” ì›”ì€ ê±´ë„ˆëœ€
        const w = m.days * CELL_W;
        const label = `${m.y}ë…„ ${m.m+1}ì›”`;
        $months.append(`<div class="timeline-month" style="width:${w}px">${label}</div>`);
      });

      const $days = $(`<div class="timeline-days"></div>`);
      // compute font-size in px based on current CELL_W (fallback to computed CSS var)
      let currentCellW = CELL_W;
      try{
        const cs = getComputedStyle(document.documentElement).getPropertyValue('--cellW');
        if(cs) currentCellW = parseFloat(cs);
      }catch(e){}
      // double the previous ratio (0.36 * 2 = 0.72) but cap font at 14px
      const fontPx = Math.max(10, Math.min(14, Math.round(currentCellW * 0.72)));

      allDays.forEach((d)=>{
        const day = d.getDate();
        $days.append(`<div class="timeline-day" style="font-size:${fontPx}px">${String(day).padStart(2,'0')}</div>`);
      });

      $wrap.append($months).append($days);
      return { $wrap, totalDays: allDays.length, totalWidth: allDays.length * CELL_W };
    }

    /***********************
     * 5) WBS ë Œë”ë§
     ************************/
    function renderWbs(){
      const $wbs = $("#wbs").empty();

      // í—¤ë”(ì¢Œì¸¡/íƒ€ì„ë¼ì¸/ìš°ì¸¡)
      // compute project-wide min/max and set view range so header and bars align with actual schedule
      const computedRange = computeProjectRange();
      if(computedRange){
        STATE.viewStart = computedRange.start;
        STATE.viewEnd = computedRange.end;
      }

      const head = buildTimelineHeader(STATE.viewStart, STATE.viewEnd);

      // precompute renderRows (exclude group rows) and spans for identical machines
      const renderRows = STATE.rows.filter(r=> r.type !== 'group');
      const spans = [];
      let runStart = 0;
      for(let i=0;i<renderRows.length;i++){
        if(i===0){ runStart = 0; continue; }
        const prev = renderRows[i-1];
        const cur = renderRows[i];
        if(cur.machine === prev.machine && cur.machine){
          // continue run
        } else {
          const len = i - runStart;
          if(len > 1 && renderRows[runStart].machine) spans.push({machine: renderRows[runStart].machine, start: runStart, length: len});
          runStart = i;
        }
      }
      // tail
      const tailLen = renderRows.length - runStart;
      if(tailLen > 1 && renderRows[runStart] && renderRows[runStart].machine) spans.push({machine: renderRows[runStart].machine, start: runStart, length: tailLen});

      const $headerRow = $(`
        <div class="wbs-row header">
          <div class="pane-left">
            <div class="cell c-machine">ê¸°ê³„</div>
            <!-- <div Class="cell C-project">í”„ë¡œì íŠ¸ëª…</div> -->
            <div class="cell c-equip">ì„¤ë¹„ëª…</div>
            <div class="cell c-code">CODE</div>
            <!-- <div class="cell c-owner">ë‹´ë‹¹ì <span class="dirty-dot"></span></div>
           <div class="cell c-modeling">ëª¨ë¸ë§ ì¼ì •</div>
             <div class="cell c-purchase">êµ¬ë§¤</div> -->
          </div>
          <div class="pane-timeline"></div>
          <div class="pane-right">
            <div class="cell" style="border-right:0; justify-content:center;">ë¹„ê³  (Remarks)</div>
          </div>
        </div>
      `);
      $headerRow.find(".pane-timeline").append(head.$wrap);
      $wbs.append($headerRow);

      // TODAY ë¼ì¸(ì „ì²´ íƒ€ì„ë¼ì¸ ê¸°ì¤€) - header ë° body ëª¨ë‘ì— ê³µí†µìœ¼ë¡œ ë³´ì´ë„ë¡ sticky ì˜ì—­ì— ë³„ë„ í‘œê¸°
      const todayOffset = daysBetween(STATE.viewStart, STATE.today);
      const showToday = (todayOffset >= 0 && todayOffset <= head.totalDays-1);

      // ë°”ë”” ë Œë”
      let zebra = 0;
      let lastMachine = null;
      STATE.rows.forEach((r, idx)=>{
        const showMachine = (r.machine && r.machine !== lastMachine);
        if(r.type === "group"){
//           const $g = $(`
//             <div class="wbs-row group-sep">
//               <div class="pane-left">
//                 <div class="cell c-machine">${r.title}</div>
//                 <div class="cell" style="flex:1 1 auto; border-right:0; font-weight:900;">&nbsp;</div>
//               </div>
//               <div class="pane-timeline">
//                 <div class="timeline-canvas" style="width:${head.totalWidth}px; height:36px; background:none;"></div>
//               </div>
//               <div class="pane-right">
//                 <div class="cell" style="border-right:0; height:36px;"></div>
//               </div>
//             </div>
//           `);
//           $wbs.append($g);
          return;
        }

        if(r.type === "total"){
          // Total Progress í–‰
          const $row = $(`
            <div class="wbs-row total-row" data-rowid="${r.machine}-TOTAL">
              <div class="pane-left">
                <div class="cell c-machine ${showMachine ? '' : 'merged'}">${showMachine ? r.machine : ''}</div>
                <!-- <div class="cell c-project" style="font-weight:900;">${r.title}</div> -->
                <div class="cell c-equip">${r.title}</div>
                <div class="cell c-code">${r.code}</div>
                <!-- <div class="cell c-owner"><span class="owner-badges"><b> </b></span><span class="dirty-dot"></span></div>
                <div class="cell c-modeling"> </div>
                 <div class="cell c-purchase"> </div> -->
              </div>
              <div class="pane-timeline">
                <div class="timeline-canvas ${zebra%2?'alt':''}" style="width:${head.totalWidth}px;"></div>
              </div>
              <div class="pane-right">
                <div class="remarks">${r.remarks ? r.remarks : '<small>&nbsp;</small>'}</div>
              </div>
            </div>
          `);

          const $canvas = $row.find(".timeline-canvas");
          // TODAY ë¼ì¸ ì¶”ê°€
          if(showToday){
            $canvas.append(`<div class="today-line" style="left:${todayOffset*CELL_W}px"></div>`);
          }

          // segment ê·¸ë¦¬ê¸°(ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆëŠ” totalì€ ì ê¸ˆ)
          (r.segments || []).forEach(seg=>{
            const left = daysBetween(STATE.viewStart, seg.start) * CELL_W;
            const w = (daysBetween(seg.start, seg.end) + 1) * CELL_W;
            const cls = deptClass(seg.dept);
            const $bar = $(`
              <div class="bar ${cls}" style="left:${left}px;width:${w}px; cursor:default;">
                <div class="txt">${seg.label}</div>
              </div>
            `);
            $bar.attr("title", `${seg.label} | ${seg.start} ~ ${seg.end}`);
            $canvas.append($bar);
          });

          $wbs.append($row);
          lastMachine = r.machine || lastMachine;
          zebra++;
          return;
        }

        // ì¼ë°˜ í–‰
        const $row = $(`
          <div class="wbs-row data-row" data-rowid="${r.id}">
            <div class="pane-left">
              <div class="cell c-machine ${showMachine ? '' : 'merged'}">${showMachine ? r.machine : ''}</div>
              <!-- <div class="cell c-project">${escapeHtml(r.project)}</div>-->
              <div class="cell c-equip">${escapeHtml(r.equip)}</div>
              <div class="cell c-code">${escapeHtml(r.code)}</div>
              <!-- <div class="cell c-owner">
                <div class="owner-badges">ì„¤ê³„ <b>${escapeHtml(r.ownerDesign||'')}</b> Â· ëª¨ë¸ <b>${escapeHtml(r.ownerModel||'')}</b></div>
                <div style="font-size:11px; color:var(--muted); font-weight:800;">(ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥)</div>
                <span class="dirty-dot"></span>
              </div>
              <div class="cell c-modeling">
                <div>START <b>${r.modelingStart}</b></div>
                <div>END&nbsp;&nbsp;&nbsp;&nbsp;<b>${r.modelingEnd}</b></div>
              </div>
               <div class="cell c-purchase">${escapeHtml(r.buyer||'')}</div> -->
            </div>

            <div class="pane-timeline">
              <div class="timeline-canvas ${zebra%2?'alt':''}" style="width:${head.totalWidth}px;"></div>
            </div>

            <div class="pane-right">
              <div class="remarks">${r.remarks ? escapeHtml(r.remarks) : '<small>&nbsp;</small>'}</div>
            </div>
          </div>
        `);

        const $canvas = $row.find(".timeline-canvas");

        // TODAY ë¼ì¸(ê° í–‰ ìº”ë²„ìŠ¤ì— ë™ì¼ ìœ„ì¹˜ë¡œ)
        if(showToday){
          $canvas.append(`<div class="today-line" style="left:${todayOffset*CELL_W}px"></div>`);
        }

        // ì„¸ê·¸ë¨¼íŠ¸ ë Œë”ë§
        (r.segments || []).forEach(seg=>{
          const left = daysBetween(STATE.viewStart, seg.start) * CELL_W;
          const w = (daysBetween(seg.start, seg.end) + 1) * CELL_W;
          const cls = deptClass(seg.dept);
          const $bar = $(`
            <div class="bar ${cls}" data-row="${r.id}" data-seg="${seg.id}" style="left:${left}px;width:${w}px;">
              <div class="txt">${escapeHtml(seg.label)}</div>
            </div>
          `);
          $bar.attr("title", `${seg.label} | ${seg.start} ~ ${seg.end}`);
          $canvas.append($bar);
        });

        $wbs.append($row);
        lastMachine = r.machine || lastMachine;
        zebra++;
      });

      // í—¤ë”ì— TODAY ë°°ì§€ í‘œì‹œ
      if(showToday){
        // íƒ€ì„ë¼ì¸ í—¤ë”ì˜ month/ì¼ ë¼ë²¨ ì˜ì—­ ìœ„ì— í‘œì‹œ
        const $badge = $(`<div class="today-badge">TODAY</div>`);
        $badge.css("left", (todayOffset*CELL_W) + "px");
        $headerRow.find(".pane-timeline").append($badge);
        // í—¤ë”ì— ë¼ì¸ í‘œì‹œ(ìƒë‹¨ì—ì„œë„ ë³´ì´ë„ë¡)
        $headerRow.find(".pane-timeline").append(
          `<div class="today-line" style="left:${todayOffset*CELL_W}px; top:0; bottom:0; position:absolute;"></div>`
        );
      }

      // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ë°”ì¸ë”©
      bindBars();

      // remove existing overlays
      $wbs.find('.machine-merge-overlay').remove();
      // create overlays for spans
      try{
        const $bodyRows = $wbs.find('.wbs-row').not('.header').not('.group-sep');
        spans.forEach(sp => {
          const $first = $($bodyRows.get(sp.start));
          if(!$first || $first.length===0) return;
          // compute top and total height
          const top = $first.position().top;
          let totalH = 0;
          for(let i=0;i<sp.length;i++){
            const $r = $($bodyRows.get(sp.start + i));
            totalH += $r.outerHeight();
          }
          const width = $first.find('.c-machine').outerWidth() || 70;
          const $ov = $(`<div class="machine-merge-overlay">${sp.machine}</div>`);
          $ov.css({ top: top + 'px', height: (totalH - 1) + 'px', width: width + 'px', left: '6px', zIndex: 50 });
          $wbs.append($ov);
        });
      }catch(e){ console.warn('machine overlay error', e); }
    }

    function deptClass(code){
      const m = DEPTS.find(x=>x.code===code);
      return m ? m.colorClass : "dept-RD";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * 6) ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ(ì¼ì • ìˆ˜ì •)
     ************************/
    function bindBars(){
      // ê¸°ì¡´ ë°”ì¸ë”© ì œê±° í›„ ì¬ì ìš©
      $(".bar").each(function(){
        const $b = $(this);
        const segId = $b.data("seg");
        const rowId = $b.data("row");
        if(!segId || !rowId) return; // total ë“±ì€ ì œì™¸

        // draggable
        $b.draggable({
          axis:"x",
          containment:"parent",
          grid:[CELL_W, 1],
          start: function(){ $(this).addClass("dragging"); },
          stop: function(e, ui){
            $(this).removeClass("dragging");
            applyBarChange($(this));
          }
        });

        // resizable (ì¢Œ/ìš°)
        $b.resizable({
          handles: "e,w",
          grid: [CELL_W, 0],
          containment:"parent",
          minWidth: CELL_W,
          start: function(){ $(this).addClass("resizing"); },
          stop: function(e, ui){
            $(this).removeClass("resizing");
            applyBarChange($(this));
          }
        });
      });
    }

    function applyBarChange($bar){
      const rowId = $bar.data("row");
      const segId = $bar.data("seg");
      const leftPx = parseInt($bar.css("left"), 10) || 0;
      const widthPx = Math.max(CELL_W, parseInt($bar.css("width"), 10) || CELL_W);

      const startOffset = Math.round(leftPx / CELL_W);
      const daysLen = Math.round(widthPx / CELL_W);

      const newStart = addDays(STATE.viewStart, startOffset);
      const newEnd   = addDays(newStart, daysLen-1);

      // ë·° ë²”ìœ„ í´ë¨í”„
      const minStart = STATE.viewStart;
      const maxEnd   = STATE.viewEnd;
      let s = newStart;
      let e = newEnd;

      if(daysBetween(minStart, s) < 0) s = minStart;
      if(daysBetween(e, maxEnd) < 0) e = maxEnd;

      // ë°ì´í„° ì—…ë°ì´íŠ¸
      const row = STATE.rows.find(x=>x.id===rowId);
      if(!row) return;
      const seg = (row.segments||[]).find(x=>x.id===segId);
      if(!seg) return;

      seg.start = s;
      seg.end = e;
      $bar.attr("title", `${seg.label} | ${seg.start} ~ ${seg.end}`);

      // row dirty í‘œì‹œ
      const $row = $bar.closest(".wbs-row");
      $row.addClass("row-dirty");

      toast(`ì¼ì • ë³€ê²½: ${seg.label} (${seg.start} ~ ${seg.end})`);
    }

    /***********************
     * 7) ê²€ìƒ‰/ì´ˆê¸°í™”/ì €ì¥/ì—‘ì…€
     ************************/
    function applySearch(){
      const m = $("#fMachine").val().trim();
      const sc = $("#fSalesCode").val().trim();
      const cust = $("#fCustomer").val().trim();

      // ë°ëª¨: machine/salesCode/customer 3ê°€ì§€ë¡œ í•„í„°
      // (customerëŠ” ìƒ˜í”Œ ë°ì´í„°ì— ì—†ì–´ì„œ, ì…ë ¥ ì‹œ í”„ë¡œì íŠ¸ëª…ì— í¬í•¨ ê²€ìƒ‰ìœ¼ë¡œ ëŒ€ì²´)
      STATE = deepClone(ORIGINAL);

      if(m){
        STATE.rows = STATE.rows.filter(r=>{
          if(r.type==="group" || r.type==="total") return true; // ê·¸ë£¹/í† íƒˆì€ ìœ ì§€
          return r.machine === m;
        });
      }
      if(sc){
        STATE.rows = STATE.rows.filter(r=>{
          if(r.type==="group" || r.type==="total") return true;
          return (r.salesCode||"").toLowerCase().includes(sc.toLowerCase()) ||
                 (r.code||"").toLowerCase().includes(sc.toLowerCase());
        });
      }
      if(cust){
        STATE.rows = STATE.rows.filter(r=>{
          if(r.type==="group" || r.type==="total") return true;
          return (r.project||"").includes(cust) || (r.equip||"").includes(cust);
        });
      }

      // ê·¸ë£¹ ë¼ì¸ ì •ë¦¬(í•„í„° ê²°ê³¼ì— í–‰ì´ ì—†ìœ¼ë©´ ê·¸ë£¹ ì œê±°)
      pruneEmptyGroups();
      renderWbs();
      toast("ê²€ìƒ‰ ì¡°ê±´ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function pruneEmptyGroups(){
      const rows = STATE.rows;
      const out = [];
      let currentGroup = null;
      let buffer = [];
      for(const r of rows){
        if(r.type==="group"){
          if(currentGroup){
            if(buffer.some(x=>x.type!=="group")) out.push(currentGroup, ...buffer);
            buffer = [];
          }
          currentGroup = r;
        }else{
          buffer.push(r);
        }
      }
      if(currentGroup){
        if(buffer.some(x=>x.type!=="group")) out.push(currentGroup, ...buffer);
      }else{
        out.push(...buffer);
      }
      STATE.rows = out;
    }

    function doReset(){
      STATE = deepClone(ORIGINAL);
      $("#fMachine").val("");
      $("#fSalesCode").val("");
      $("#fCustomer").val("");
      renderWbs();
      toast("ì´ˆê¸°í™” ì™„ë£Œ");
    }

    function collectChanges(){
      const changes = [];
      $(".wbs-row.row-dirty").each(function(){
        const rowId = $(this).data("rowid");
        const row = STATE.rows.find(x=>x.id===rowId);
        if(!row) return;
        changes.push({
          rowId: row.id,
          machine: row.machine,
          project: row.project,
          code: row.code,
          segments: row.segments
        });
      });
      return changes;
    }

    function doSave(){
      const changes = collectChanges();
      if(!changes.length){
        toast("ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      openModal("ë³€ê²½ì‚¬í•­(JSON)", JSON.stringify(changes, null, 2));
    }

    function doExport(){
      // CSV (Excelì—ì„œ ë°”ë¡œ ì—´ë¦¼)
      const lines = [];
      lines.push([
        "MACHINE","PROJECT","EQUIP","CODE","OWNER_DESIGN","OWNER_MODEL",
        "MODEL_START","MODEL_END","BUYER","SEG_ID","DEPT","LABEL","START","END","REMARKS"
      ].join(","));

      STATE.rows.forEach(r=>{
        if(r.type==="group") return;
        if(r.type==="total"){
          (r.segments||[]).forEach(seg=>{
            lines.push([
              escCsv(r.machine), escCsv(r.title||""),
              "", "", "", "",
              "", "", "",
              escCsv(seg.id), escCsv(seg.dept), escCsv(seg.label),
              escCsv(seg.start), escCsv(seg.end), escCsv(r.remarks||"")
            ].join(","));
          });
          return;
        }

        (r.segments||[]).forEach(seg=>{
          lines.push([
            escCsv(r.machine), escCsv(r.project), escCsv(r.equip), escCsv(r.code),
            escCsv(r.ownerDesign||""), escCsv(r.ownerModel||""),
            escCsv(r.modelingStart||""), escCsv(r.modelingEnd||""),
            escCsv(r.buyer||""),
            escCsv(seg.id), escCsv(seg.dept), escCsv(seg.label),
            escCsv(seg.start), escCsv(seg.end),
            escCsv(r.remarks||"")
          ].join(","));
        });
      });

      const blob = new Blob(["\ufeff"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `WBS_${STATE.viewStart}_${STATE.viewEnd}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("CSV(Excel) ë‚´ë³´ë‚´ê¸° ì™„ë£Œ");
    }

    function escCsv(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    // page ì˜ì—­ì„ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜í•´ì„œ ì¸ì‡„ (í™”ë©´ ëª¨ì–‘ ê·¸ëŒ€ë¡œ)
    function doPrint(){
      const page = document.querySelector(".page");
      if(!page){
        toast("ì¶œë ¥í•  í˜ì´ì§€ ì˜ì—­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      // í˜„ì¬ ì¤Œ ê°’ ì €ì¥
      const originalCellW = CELL_W;
      const originalZoomVal = parseInt($('#zoomSlider').val(), 10);
      
      // VIEW_STARTë¶€í„° VIEW_ENDê¹Œì§€ì˜ ì¼ìˆ˜ ê³„ì‚°
      const MS = 86400000; // í•˜ë£¨ì˜ ë°€ë¦¬ì´ˆ
      const startDate = parse(STATE.viewStart || VIEW_START);
      const endDate = parse(STATE.viewEnd || VIEW_END);
      const totalDays = Math.ceil((endDate - startDate) / MS) + 1;
      
      // í˜„ì¬ íƒ€ì„ë¼ì¸ ì‹¤ì œ ë„ˆë¹„ ê³„ì‚°
      const currentTimelineWidth = totalDays * originalCellW;
      
      // ì¶œë ¥ ê°€ëŠ¥í•œ ë„ˆë¹„ ê³„ì‚°: ì‹¤ì œ pane-timeline ì˜ì—­ í­ì„ ìš°ì„  ì‚¬ìš©
      const pane = document.querySelector(".pane-timeline");
      const paneWidth = pane ? pane.clientWidth : (window.innerWidth - 350 - 180);
      const availableWidth = Math.min(paneWidth, 1900); // ìµœëŒ€ ë„ˆë¹„ ì œí•œ
      
      // pane-timelineì˜ ëª¨ë“  ë°ì´í„°ê°€ ë³´ì´ë„ë¡ CELL_W ì¡°ì •
      let printCellW = originalCellW;
      if(currentTimelineWidth > availableWidth){
        printCellW = Math.max(4, Math.floor(availableWidth / totalDays));
        // ì¡°ì •ëœ CELL_Wë¡œ ì¤Œ ê°’ ê³„ì‚°
        const basePxPerDay = 16;
        const newZoomVal = Math.max(4, Math.min(30, Math.round(printCellW * basePxPerDay / 16)));
        CELL_W = printCellW;
        // CSS ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        document.documentElement.style.setProperty('--cellW', printCellW + 'px');
        document.documentElement.style.setProperty('--px-per-day', printCellW + 'px');
        // WBS ë‹¤ì‹œ ë Œë”ë§
        renderWbs();
        bindBars();
        // DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸°
        setTimeout(() => {
          captureAndPrint(page, originalCellW, originalZoomVal);
        }, 100);
      } else {
        captureAndPrint(page, originalCellW, originalZoomVal);
      }
    }
    
    function captureAndPrint(page, originalCellW, originalZoomVal){
      // ê°„íŠ¸ ì˜ì—­ ì „ì²´ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ í•´ì œ
      const scrollEl = document.getElementById("wbsScroll");
      const prev = scrollEl ? {
        height: scrollEl.style.height,
        maxHeight: scrollEl.style.maxHeight,
        overflow: scrollEl.style.overflow
      } : null;
      if(scrollEl){
        scrollEl.style.height = "auto";
        scrollEl.style.maxHeight = "none";
        scrollEl.style.overflow = "visible";
      }

      // html2canvasë¡œ í™”ë©´ ê·¸ëŒ€ë¡œ ìº¡ì²˜
      html2canvas(page, {
        scale: window.devicePixelRatio || 2,
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: document.documentElement.clientWidth,
        windowHeight: document.documentElement.clientHeight
      }).then(canvas => {
        // ì›ë˜ ìŠ¤í¬ë¡¤ ìŠ¤íƒ€ì¼ ë³µì›
        if(scrollEl && prev){
          scrollEl.style.height = prev.height;
          scrollEl.style.maxHeight = prev.maxHeight;
          scrollEl.style.overflow = prev.overflow;
        }
        
        // ì›ë˜ ì¤Œ ê°’ìœ¼ë¡œ ë³µì›
        CELL_W = originalCellW;
        document.documentElement.style.setProperty('--cellW', originalCellW + 'px');
        document.documentElement.style.setProperty('--px-per-day', originalCellW + 'px');
        $('#zoomSlider').val(originalZoomVal);
        $('#zoomVal').text(originalZoomVal);
        renderWbs();
        bindBars();

        const dataUrl = canvas.toDataURL("image/png");
        const w = window.open("", "_blank");
        if(!w){
          toast("íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
          return;
        }
        w.document.write(`<!doctype html><html lang="ko"><head>
  <meta charset="utf-8" />
  <title>WBS Print</title>
  <style>
    body{margin:0;padding:0;background:#fff;text-align:center;}
    img{max-width:100%;height:auto;}
    @media print{
      body{margin:0;padding:0;}
      img{max-width:100%;height:auto;}
    }
  </style>
</head><body><img src="${dataUrl}"></body></html>`);
        w.document.close();
        w.focus();
        w.onload = ()=> {
          w.print();
          w.close();
        };
      }).catch(err => {
        if(scrollEl && prev){
          scrollEl.style.height = prev.height;
          scrollEl.style.maxHeight = prev.maxHeight;
          scrollEl.style.overflow = prev.overflow;
        }
        // ì›ë˜ ì¤Œ ê°’ìœ¼ë¡œ ë³µì›
        CELL_W = originalCellW;
        document.documentElement.style.setProperty('--cellW', originalCellW + 'px');
        document.documentElement.style.setProperty('--px-per-day', originalCellW + 'px');
        $('#zoomSlider').val(originalZoomVal);
        $('#zoomVal').text(originalZoomVal);
        renderWbs();
        bindBars();
        console.error(err);
        toast("ì¶œë ¥ ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    }


    function setZoom(val) {
      $('#zoomVal').text(val);
      $('#zoomSlider').val(val);

      // Calculate zoom scale ratio based on base px-per-day of 12
      const basePxPerDay = 16;
      const zoomScale = val / basePxPerDay;

      // Compute new pixel-per-day and apply to CSS vars used by layout/CSS
      const pxPerDay = Math.max(4, Math.round(basePxPerDay * zoomScale));
      document.documentElement.style.setProperty('--zoom-scale', zoomScale);
      document.documentElement.style.setProperty('--px-per-day', pxPerDay + 'px');
      document.documentElement.style.setProperty('--cellW', pxPerDay + 'px');

      // update runtime CELL_W and re-render timeline
      CELL_W = pxPerDay;
      // Re-render WBS (header + body) and rebind draggable/resizable handlers
      try{ renderWbs(); }catch(e){ console.warn('renderWbs failed', e); }
      try{ bindBars(); }catch(e){ /* ignore */ }
    }
    
    /***********************
     * 8) ë„ì›€ë§
     ************************/
    function showHelp(){
      const msg =
`[ì¡°ì‘ ë°©ë²•]
1) íƒ€ì„ë¼ì¸ì˜ ì»¬ëŸ¬ ë°”ë¥¼ ë§ˆìš°ìŠ¤ë¡œ ì¢Œìš° ë“œë˜ê·¸ â†’ ì‹œì‘ì¼ ì´ë™(1ì¼ ë‹¨ìœ„)
2) ë°”ì˜ ì¢Œ/ìš° ëì„ ë“œë˜ê·¸(ë¦¬ì‚¬ì´ì¦ˆ) â†’ ê¸°ê°„ ë³€ê²½(1ì¼ ë‹¨ìœ„)
3) ë³€ê²½ëœ í–‰ì€ ë…¸ë€ ì (â—) í‘œì‹œ â†’ SAVE CHANGES í´ë¦­ ì‹œ ë³€ê²½ JSON í™•ì¸
4) EXPORT EXCEL â†’ CSVë¡œ ë‹¤ìš´ë¡œë“œ(Excelì—ì„œ ì—´ê¸° ê°€ëŠ¥)

[êµ¬í˜„ í¬ì¸íŠ¸]
- ì¢Œì¸¡(ê¸°ê³„~êµ¬ë§¤) / ìš°ì¸¡(Remarks) Sticky ì²˜ë¦¬
- íƒ€ì„ë¼ì¸ì€ Day Grid(1ì¼ ë‹¨ìœ„) + ì›” ë¼ë²¨ + TODAY ë¼ì¸ í‘œì‹œ
- jQuery UI draggable/resizableë¡œ ì¼ì • ìˆ˜ì •
- ì‹¤ì„œë²„ ì—°ë™ ì‹œ: SAVE ì‹œì ì— ë³€ê²½ë¶„ë§Œ ë°±ì—”ë“œ APIë¡œ ì „ì†¡ ê¶Œì¥`;
      openModal("ë„ì›€ë§", msg);
    }

    /***********************
     * 9) ì´ë²¤íŠ¸ ë°”ì¸ë”©
     ************************/
    $(function(){
      renderLegend();
      initDates();
      renderWbs();

      $("#btnSearch").on("click", applySearch);
      $("#btnReset").on("click", doReset);
      $("#btnSave").on("click", doSave);
      $("#btnExport").on("click", doExport);
      $("#btnPrint").on("click", doPrint);
      $("#btnHelp").on("click", showHelp);

      $("#btnSalesSearch").on("click", ()=> toast("ë°ëª¨: SalesCode ê²€ìƒ‰ íŒì—…ì€ ì—°ë™ ì „ ë‹¨ê³„ì…ë‹ˆë‹¤."));
      $("#btnCustomerSearch").on("click", ()=> toast("ë°ëª¨: ê³ ê°ì‚¬ ê²€ìƒ‰ íŒì—…ì€ ì—°ë™ ì „ ë‹¨ê³„ì…ë‹ˆë‹¤."));


      $('#zoomSlider').on('input', e => setZoom(parseInt(e.target.value, 10)));
      // apply initial zoom from slider on load
      try{ setZoom(parseInt($('#zoomSlider').val(), 10)); }catch(e){ console.warn('initial setZoom failed', e); }
      
      $("#modalClose, #modalOk").on("click", closeModal);
      $("#modal").on("click", function(e){
        if(e.target === this) closeModal();
      });
      $("#modalCopy").on("click", async function(){
        try{
          await navigator.clipboard.writeText($("#modalBody").text());
          toast("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }catch(err){
          toast("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸ í•„ìš”)");
        }
      });
    });
  </script>
</body>
</html>
