<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<title>SVG 레이어 간트 (그룹/세로타이틀/툴팁/중앙라벨/겹침팔레트/DnD/줌)</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">

	<!-- 기존 CSS 그대로 -->
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5picker.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5select.css">
	<link rel="stylesheet" href="/static/css/jstree/style.min.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
	<link rel="stylesheet" href="/static/css/gnb.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/sub.css">
	<link rel="stylesheet" href="/static/css/common.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-multiselect.css">

	<style>
		/* === 기존 스타일 그대로 (생략 없이 유지) === */
		:root{ --px-per-day:24px; --lane-height:22px; --track-vpad:3px; --label-width:180px; --badge-col-width:46px; --badge-radius:14px; --label-font-size:14px; --ruler-font-size:12px; --bar-font-size:12px; --col-gap:8px; --grid-line-color:#e9eef8; }
		.toolbar{ display:flex; gap:12px; align-items:center; margin-bottom:10px; }
		.timeline{ border:1px solid #cfd9ee; border-radius:12px; background:#fff; padding:8px, 0px; overflow-x:auto; white-space:nowrap; height:calc(100vh - 165px); position:relative; overflow:auto; }
		.day-grid{ background-image:repeating-linear-gradient(to right, var(--grid-line-color) 0 1px, transparent 1px var(--px-per-day)); background-repeat:repeat; background-position:left top; background-size:auto 100%; }
		.header-gutter{ position:sticky; left:0; top:0; z-index:14; background:#0b0b0b; }
		.plan-badge-col{ position:sticky; left:var(--label-width); margin-left:0; top:0; z-index:13; background:#f7f9fe; }
		.line-badge{ position:sticky; left:var(--label-width); z-index:11; background:#2b6cb0; }
		.header{ position:sticky; top:0; z-index:30; background:#f7f9fe; display:flex; }
		.header-gutter{ flex:0 0 var(--label-width); position:sticky; top:0; left:0; z-index:40; background:#2b6cb0; color:#e5e7eb; border-radius:12px; display:flex; align-items:center; justify-content:center; }
		.header-right{ flex:1 1 auto; padding-left:calc(var(--col-gap)); }
		.plan-badge-col{ position:sticky; top:0; padding-left:16px; padding-right:6px; left:calc(var(--label-width)); z-index:35; width:var(--badge-col-width); height:auto; background:transparent; }
		.cat-badge{ position:sticky; top:0; left:calc(var(--label-width) + var(--col-gap)); z-index:35; background:#f7f9fe; width:var(--badge-col-width); height:calc(var(--lane-height) + var(--track-vpad)*2); border-radius:var(--badge-radius); display:flex; align-items:center; justify-content:center; color:#fff; background:#2b6cb0; padding-left:6px; padding-right:6px; width:46px; font:12px/1.4 system-ui,"맑은 고딕"; }
		.header-rulers{ position:relative; z-index:1; display:flex; flex-direction:column; padding-left:18px; }
		.ruler-row{ height:26px; display:flex; align-items:center; font-size:var(--ruler-font-size)!important; }
		.ruler-month .cell{ font-weight:700; background:#2274C6; color:white; border-right:1px solid #e6ecff; }
		.ruler-week .cell{ background:#f6f8ff; color:#333; border-right:1px solid #eef2ff; }
		.cell{ width:var(--px-per-day); min-width:var(--px-per-day); text-align:center; box-sizing:border-box; }
		.ruler-day{ position:relative; z-index:1; background:none!important; }
		.ruler-day::before{ content:""; position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none; background-image:repeating-linear-gradient(to right, var(--grid-line-color) 0 1px, transparent 1px var(--px-per-day)); z-index:0; }
		.day-weekend{ background:#fff6f6!important; }
		.rows{ margin-top:8px; }
		.row-group{ display:grid; grid-template-columns:var(--label-width) var(--badge-col-width) 1fr; align-items:start; gap:var(--col-gap); margin:10px 0; }
		.group-label{ position:sticky; left:0; z-index:20; background:#768ea5; color:#e5e7eb; border-radius:12px; height:100%; display:flex; flex-direction:column; justify-content:center; margin-left:0; padding:0 10px; }
		.line-badge{ flex:0 0 var(--badge-col-width); min-width:var(--badge-col-width); height:calc(var(--lane-height) + var(--track-vpad) * 2); padding:0 6px; border-radius:var(--badge-radius); background:#768EA5; color:white; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; letter-spacing:.5px; box-shadow:0 1px 2px rgba(0,0,0,.08) inset; font:10px/1.4 system-ui,"맑은 고딕"; }
		.group-box{ grid-column:2 / -1; border:1px solid #cfe0ff; border-radius:16px; background:#fff; padding:8px; display:flex; flex-direction:column; gap:1px; box-sizing:border-box; }
		.group-line{ display:flex; gap:8px; align-items:flex-start; }
		.row-track{ position: relative; z-index: 1; height: calc(var(--lane-height) + var(--track-vpad)*2); /* 정확히 lane + 여백*2 */ padding-block: var(--track-vpad); border: 1px solid #cfe0ff; border-radius: 12px; background: #fff; display: flex; align-items: center; }
		.row-track::before{ content:""; position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none; background-image:repeating-linear-gradient(to right, var(--grid-line-color) 0 1px, transparent 1px var(--px-per-day)); z-index:0; }
		.timeline::before{ content:""; position:sticky; left:0; top:0; bottom:0; width:calc(var(--label-width) + var(--col-gap) + var(--badge-col-width)); background:#fff; z-index:8; pointer-events:none; }
		.row-track .shade{ position:absolute; top:0; bottom:0; pointer-events:none; z-index:1; }
		.row-track svg{ position:relative; z-index:2; }
		.today-line{ position:absolute; top:0; bottom:0; width:1px; background:#ff4d4f; pointer-events:none; }
		.shade.weekend{ background:#FFEEEE; }
		.shade.today{ background:rgba(255,0,0,.60) }
		svg{ display:block; }
		.bar{ fill:#BAD9F8; stroke:#8bb6ff; opacity:.6; }
		.bar.overlap.ci-0{ fill:#4e79a7; stroke:#3b638c; opacity:.60; }
		.bar.overlap.ci-1{ fill:#f28e2b; stroke:#cf741b; opacity:.60; }
		.bar.overlap.ci-2{ fill:#59a14f; stroke:#45823e; opacity:.60; }
		.bar.leader.overlap.ci-0{ fill:#4e79a7; stroke:#3b638c; opacity:.60; }
		.bar.leader.overlap.ci-1{ fill:#f28e2b; stroke:#cf741b; opacity:.60; }
		.bar.leader.overlap.ci-2{ fill:#59a14f; stroke:#45823e; opacity:.60; }
		.bar.expired{ fill:green!important; stroke:#ccc; opacity:.6; }
		.bar.locked{ opacity:.35; filter:grayscale(0.3) contrast(0.9); }
		.bar-label{ font-size:var(--bar-font-size); dominant-baseline:middle; text-anchor:middle; pointer-events:none; fill:#203040; }
		.handle{ fill:rgba(0,0,0,.15); cursor:ew-resize; }
		.dragging .bar{ opacity:.85; }
		.dragging, .dragging *{ user-select:none; }
		#ganttTooltip{ position:fixed; z-index:9999; pointer-events:none; display:none; padding:6px 8px; border-radius:6px; background:rgba(17,17,17,.92); color:#fff; font-size:12px; line-height:1.3; white-space:nowrap; box-shadow:0 4px 12px rgba(0,0,0,.18); }
		.ruler-day .cell.day-weekend{ background:#FFEEEE!important; }
		.ruler-day .cell.day-today{ background:rgba(255,0,0,.50)!important; }
		.contents.no_bg{ display:flex; align-items:center; justify-content:space-between; }
		.toolbar{ display:flex; align-items:center; gap:8px; }
		.btn_ul{ display:flex; gap:6px; list-style:none; margin:0; padding:0; }
		.btn_ul li{ display:flex; gap:6px; }
		.datepicker-dropdown,.datepicker{ z-index:12000!important; }
		#timeline{ cursor:grab; }
		#timeline.panning{ cursor:grabbing; }
		#timeline.panning, #timeline.panning *{ user-select:none; }
		#barContextMenu{ min-width:160px; background:#111; color:#fff; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.25); padding:6px 0; user-select:none; }
		#barContextMenu .ctx-list{ list-style:none; margin:0; padding:0; }
		#barContextMenu .ctx-list > li{ padding:8px 12px; cursor:pointer; font-size:13px; line-height:1.2; }
		#barContextMenu .ctx-list > li:hover{ background:#1e293b; }
		#barContextMenu .ctx-list > li.danger:hover{ background:#7f1d1d; }
		.handle, .bar { pointer-events: all; } 
		
		/* 4-space indent */
		#barContextMenu { position: fixed; z-index: 10050; }
		#barContextMenu .submenu {
		    position: absolute;
		    min-width: 200px;
		    max-height: 260px;
		    overflow: auto;
		    background: #0f172a;
		    color: #e5e7eb;
		    border-radius: 8px;
		    box-shadow: 0 8px 24px rgba(0,0,0,.35);
		    display: none;
		    padding: 6px 0;
		}
		#barContextMenu .submenu .submenu-item {
		    padding: 8px 12px;
		    cursor: pointer;
		    font-size: 13px;
		    line-height: 1.2;
		    white-space: nowrap;
		}
		#barContextMenu .submenu .submenu-item:hover {
		    background: #1f2937;
		}
		#barContextMenu .submenu .empty {
		    padding: 8px 12px;
		    color: #94a3b8;
		    cursor: default;
		}
		.row-track.drop-target{ outline: 2px dashed #60a5fa; outline-offset:-2px; }
		
		/* 바 색상: 담당자 본인 업무 */
		.bar.own { fill: #FFD54F; stroke: #B8860B; }
		
		/* 노란 바의 라벨은 검정/굵게 */
		.bar.own + text.bar-label { fill: #000; font-weight: 700; }
		
		.group-line .line-badge { cursor: pointer; }
		
		.group-line.pm-stacked .line-badge { background:#334155; color:#ffd54f; }
		
		/* 선택: 겹침일 때 라벨 투명도 조절 */
		.row-track svg .bar-label { opacity: .9; }
		.row-track svg:first-child[data-stacked="true"] .bar-label { opacity: .7; } /* 필요 시 data-attr로 제어 */

	</style>
</head>
<body>
	<div id="head_area"></div>
	<div id="top_area"></div>

	<div id="main_area">
		<input type="hidden" id="pgmId" name="pgmId" value="WB0602M01">

		<div class="contents no_bg">
			<div class="toolbar">
				<label>줌(px/day): <input id="zoom" type="range" min="2" max="26" step="1" value="6"></label>
				<span id="zoomVal">6</span>
				<span style="color:#667085">Ctrl + 마우스휠도 지원</span>
			</div>
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="manualPopup();"><button type="button" class="bg_gray">도움말</button></a>
					<a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
					<a onclick="DataSearch();"><button class="bg_gray">검 색</button></a>
				</li>
			</ul>
		</div>

		<!-- 검색조건 -->
		<div class="contents search">
			<div>
				<table class="table_input type04">
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사"></select>
						</td>
						<th class="hit">수주일자</th>
						<td>
							<div class="date_input">
								<input type="text" id="strtDt_S" name="strtDt_S" class="input_calendar" onkeyup="dateMask(this);" autocomplete="off" required data-search="strtDt">
								<span>~</span>
								<input type="text" id="endDt_S" name="endDt_S" class="input_calendar" onkeyup="dateMask(this);" autocomplete="off" required data-search="endDt">
							</div>
						</td>
<!-- 						<th>기계종류</th> -->
<!-- 						<td> -->
<!-- 							<select id="multiple-checkboxes-prdtGrp" multiple="multiple"></select> -->
<!-- 						</td> -->
						<th>담당자</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="wbsPlanMngId_S"   name="wbsPlanMngId_S"   data-search="wbsPlanMngId">
								<input type="text"   id="wbsPlanMngIdNm_S" name="wbsPlanMngIdNm_S" data-search="wbsPlanMngIdNm"
								onkeyup="(event.keyCode == 8 || event.keyCode == 46) ? wbsPlanMngId_S.value = '' : event.keyCode == 13 ? DataSearch() : '';">
								<a onclick="openUserSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th></th><td></td>
					</tr>
					<tr>
						<th>SalesCode</th>
						<td>
							<div class="search_form">
								<input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" value="25079" onkeyup="event.keyCode==13 ? DataSearch() :''">
								<a onclick="wbsSalesCodeSearch($('#salesCd_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>고객사PJT</th>
						<td>
							<select id="clntPjt_S" name="clntPjt_S" data-kind="PRJCTCD" data-search="clntPjt">
								<option value="">전체</option>
							</select>
						</td>
						<th>고객사</th>
						<td>
							<input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S" data-search="ordrsClntCd">
							<div class="search_form">
								<input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S" data-search="ordrsClntNm"
									onkeyup="(event.keyCode==8||event.keyCode==46)?ordrsClntCd_S.value='':event.keyCode==13 ? DataSearch() :''">
								<a onclick="opendClntSearch($('#ordrsClntNm_S').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>PM계획상태</th>
						<td>
							<select id="scdStatus_S" name="scdStatus_S" data-search="scdStatus">
								<option value="">전체</option>
								<option value="진행중" selected>진행중인상태</option>
								<option value="완료된">완료된 상태</option>
								<option value="미도래">미도래 상태</option>
							</select>
						</td>
					</tr>
				</table>
			</div>
		</div>

		<!-- 타임라인 -->
		<div class="timeline" id="timeline">
			<div class="header">
				<div class="header-gutter">SalesCd / 구분</div>
				<div class="plan-badge-col"><div class="cat-badge" id="planBadge">구분</div></div>
				<div class="header-right">
					<div class="header-rulers" id="headerRulers">
						<div class="ruler-month ruler-row" id="rulerMonth"></div>
						<div class="ruler-week ruler-row" id="rulerWeek"></div>
						<div class="ruler-day ruler-row" id="rulerDay"></div>
					</div>
				</div>
			</div>
			<div class="rows" id="rowsContainer"></div>
		</div>
	</div>

	<!-- Tooltip -->
	<div id="ganttTooltip"></div>

	<!-- Bar Context Menu -->
	<div id="barContextMenu" style="display:none; position:fixed; z-index:10050;">
		<ul class="ctx-list">
			<li data-action="openDetail">상세 보기</li>
			<li data-action="insert">일정 추가</li>
			<li data-action="edit">일정 편집</li>
			<li data-action="complete">일정 결과 확정</li>
			<li data-action="cancle">일정 결과 확정 취소</li>
<!-- 			<li data-action="duplicate">일정 복사</li> -->
			<li data-action="delete" class="danger">일정 삭제</li>
			<li data-action="">-----------------</li>
			<li data-action="problem" class="danger">문제 등록</li>
			<li data-action="workreport" class="info">작업일보등록</li>
		</ul>
	</div>

	<!-- 기존 JS 라이브러리 -->
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/ax5/ax5calendar.min.js"></script>
	<script src="/static/js/ax5/ax5picker.min.js"></script>
	<script src="/static/js/ax5/ax5menu.min.js"></script>
	<script src="/static/js/ax5/ax5formatter.min.js"></script>
	<script src="/static/js/ax5/ax5combobox.min.js"></script>
	<script src="/static/js/ax5/ax5select.min.js"></script>
	<script src="/static/js/exceljs.min.js"></script>
	<script src="/static/js/global.js"></script>
	<script src="/static/js/fileTree.js"></script>
	<script src="/static/js/workingDayCalc.js"></script>
	<script src="/static/js/korean-lunar-calendar.min.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<script src="/static/bootstrap/js/bootstrap-multiselect.min.js"></script>
	<script src="/static/js/manualPopup.js"></script>

<script>
	//화면로드시
	$(document).ready(function() {
		mainDefaultLoad("실행계획", "기계별 WBS현황"); // 페이지 타이틀 설정
		setCommonSelect($("#main_area select[data-kind]")); // 공통코드 set

		//메뉴 숨기기
		$('#head_area').toggleClass('off');
		$('#top_area').toggleClass('on');
		$('#main_area').toggleClass('on');
		//회사 기본값지정
		$("#coCd_S").val('GUN');
		$('#wbsPlanMngId_S').val(jwt.userId);
		$('#wbsPlanMngIdNm_S').val(jwt.userNm);
	
		// 시작일 (현재날짜의 월 첫일)
		$('#strtDt_S').datepicker({
				format : "yyyy-mm-dd",
				language : "ko",
				autoclose : true
		})
		.datepicker("setDate", moment().subtract(6, "months").startOf("month").toDate())
		.on("changeDate", function(){
			if($('#strtDt_S').val() > $('#endDt_S').val()){
				alert("날짜를 확인해주세요");
				$('#strtDt_S').datepicker("setDate", new Date($('#endDt_S').val()));
			}
		});
	
		// 종료일 (현재날짜의 월 말일)
		$('#endDt_S').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", moment(new Date()).endOf("month").toDate())
		.on("changeDate", function(){
			if($('#strtDt_S').val() > $('#endDt_S').val()){
				alert("날짜를 확인해주세요");
				$('#endDt_S').datepicker("setDate", new Date($('#strtDt_S').val()));
			}
		});
	
		$('#zoom').on('input', function () { const val = $(this).val(); $('#zoomVal').text(val);});

		//권한체크
		authChk();
		
		
		// 검색조건 이벤트 bind
		$('[data-search]').on("change", function(){ DataSearch(); });
		

	});
	

	// 초기화 버튼
	function initSearch() {
		$('[data-search]').off("change");	//바인딩기능 오프
		$('.contents.search select, .contents.search input').val("");
		// 회사 선택 상자 값 설정
		$("#coCd_S").val('GUN');
		$("#scdStatus_S").val('진행중');
		// 날짜 필드 값 설정
		$("#strtDt_S").val(dateToStr(moment().subtract(6, "months").startOf("month").toDate()));
		$("#endDt_S").val(dateToStr(moment(new Date()).endOf("month").toDate()));
	
		// 검색조건 이벤트 bind
		$('[data-search]').on("change", function(){ DataSearch(); });
	
	}
	

	// 거래처 검색 함수
	function opendClntSearch(inputValue) {
		var paramObj = {
	            "searchValue" : inputValue,
	            "clntDivCd"   : "CLNTDIV12"
	        };
		openModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "거래처 검색", paramObj, function(grid) {
			var row = grid.target.getList("selected")[0];
			$('#ordrsClntCd_S').val(row.clntCd);
			$('#ordrsClntNm_S').val(row.clntNm);
			//gridView.setData(0);
			DataSearch();
		});
	}

	//Sales Code (수주마스터, 수주상세테이블 조인) 검색
	function wbsSalesCodeSearch() {
	    var paramObj = {
	       "coCd" : $('#coCd_S').val(),
	       "searchValue": $('#salesCd_S').val()
	    };
	    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
	        var row = grid.target.getList("selected")[0];
	        $('#salesCd_S').val(row.salesCd);
	        DataSearch();
	    });
	}

	// 작성자 검색 //
	function openUserSearch() {
		var paramObj = {
			  "coCd" : $('#coCd').val(),
			  "userId" : $('#wbsPlanMngId_S').val(),
			  "userNm" : $('#wbsPlanMngIdNm_S').val(),
		};

		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					$('#wbsPlanMngId_S').val(checkedNode.id);
					$('#wbsPlanMngIdNm_S').val(checkedNode.text);
					DataSearch();
				});
	}

	
	function DataSearch() {
		GanttApp.loadAndRender();
	}
</script>
	<!-- 공통/코어/앱 -->
	<script src="common.js"></script>
	<script src="gantt-core.js"></script>
	<script src="app.js"></script>
</body>
</html>

