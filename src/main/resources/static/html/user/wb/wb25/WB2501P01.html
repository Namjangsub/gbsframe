<div id="wbsPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">WBS 과제 평가</h4>   
    </div>
    <div class="popup_table">
        <div class="form-group">            
            <form id="popForm_S">
                 <input type="hidden" id="actionType"   name="actionType">
                 <input type="hidden" id="coCd"   name="coCd">
                 <input type="hidden" id="userId" name="userId">
                 <input type="hidden" id="pgmId"  name="pgmId" value="WB2501P01">
                 <input type="hidden" id="fileTrgtKey" name="fileTrgtKey">
                 <input type="hidden" id="sjFileTrgtKey" name="sjFileTrgtKey">
                 <input type="hidden" id="salesCd" name="salesCd">
                 <input type="hidden" id="telNo"   name="telNo">
                 
                 <table class="popup_table">
                     <colgroup>
                          <col width="9%">
                          <col width="7%">
                          <col width="20%">
                          <col width="6%">
                          <col width="10%">
                          <col width="14%">
                          <col width="10%">
                          <col width="10%">
                          <col width="10%">
                          <col width="10%">
                          <col width="10%">                          
                     </colgroup>
                          <tr>
                           <th>▣ 수주정보</th>
                           <th style="text-align:center;">고객명</th>
                           <td colspan="3"><input type="text" id="clntNm" name="clntNm" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                           <th style="text-align:center;">프로젝트명</th>
                           <td ><input type="text" id="clntPjtNm" name="clntPjtNm" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                           <th style="text-align:center;">수주번호</th>
                           <td><input type="text" id="ordrsNo" name="ordrsNo" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>   
                           <th style="text-align:center;">SALES CODE</th>
                           <td><input type="text" id="salesCd" name="salesCd" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                                                               
                         </tr>
                         
                         <tr>
                           <th>▣ 과제정보</th>
                           <th style="text-align:center;">과제명</th>
                           <td><input type="text" id="sjNm" name="sjNm" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                           <th style="text-align:center;">Ver.</th>
                           <td><input type="text" id="verNo" name="verNo" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                           <th style="text-align:center;">과제시작일</th>
                           <td><input type="text" id="subjSdt" name="subjSdt" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                           <th style="text-align:center;">과제종료일</th>
                           <td><input type="text" id="subjEdt" name="subjEdt" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>
                           <th style="text-align:center;">소요일수</th>
                           <td><input type="text" id="reqreDaycnt" name="reqreDaycnt" readonly style="text-align:center;font-weight:bold;color:#000000;"></td>                                       
                         </tr>
                         <tr>
                        <td colspan="11" style="text-align: left;height:10px;">
                        </tr>
                      <tr>
                        <td colspan="11" style="text-align: left;">
                        <table height="100%">
                        <colgroup>
                          <col width="13%">
                          <col width="20%">
                          <col width="13%">
                          <col width="20%">
                          <col width="17%">
                          <col width="20%">
                          <col width="13%">
                          <col width="15%">                   
                     </colgroup>
                        <tbody>
						  <tr height="30">
						    <th colspan="2" style="text-align:center;">▣ 계획 & 실적 정보</th>
						    <th colspan="2" style="text-align:center;">▣ 원가정보</th>
						    <th colspan="2" style="text-align:center;">▣ 공수정보</th>
						    <th colspan="2" style="text-align:center;">▣ 품질정보 (장애&이슈)</th>
						  </tr>
						  </tbody>
						  <tr height="35">
						    <th style="text-align:center;">계획일자</th>
						    <td><input type="text" id="wbsPlansDt" name="wbsPlansDt" readonly style="text-align:center;font-weight:bold;width:92px;outline: 0px solid #d50000;">~<input type="text" id="wbsPlaneDt" name="wbsPlaneDt" readonly style="text-align:center;font-weight:bold;width:90px;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">견적원가</th>
						    <td><input type="text" id="estPrc" name="estPrc" readonly comma style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">설계공수(계획 / 실적)</th>
						    <td>
						    <input type="text" id="dsgnExpMh" name="dsgnExpMh" readonly style="text-align:center;font-weight:bold;width:92px;outline: 0px solid #d50000;">/<input type="text" id="dsgnRsltMh" name="dsgnRsltMh" readonly style="text-align:center;font-weight:bold;width:90px;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">장애건수 / 금액</th>
						    <td><input type="text" id="reqCnt" name="reqCnt" readonly style="text-align:center;font-weight:bold;width:30px;outline: 0px solid #d50000;">&nbsp;/&nbsp;<input type="text" id="pchsAmt" name="pchsAmt" comma readonly style="text-align:center;font-weight:bold;width:100px;outline: 0px solid #d50000;"></td>
						  </tr>
						  <tr height="35">
						    <th style="text-align:center;">계획소요일</th>
						    <td><input type="text" id="daycnt" name="daycnt" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">목표원가</th>
						    <td><input type="text" id="trgtPrc" name="trgtPrc" comma readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">설계공수 실적율 (%)</th>
						    <td><input type="text" id="dsgnDayRate" name="dsgnDayRate" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;">
						   </td>
						    <td colspan="2" rowspan="6" valign="top">
						    <div class="ax5_grid" data-ax5grid="grid-modal" data-ax5grid-config="{}" style="width: 300px;height:120px" ></div></td>
						  </tr>
						  <tr height="35">
						    <th style="text-align:center;">실적일자</th>
						    <td><input type="text" id="rsltssDt" name="rsltssDt" readonly style="text-align:center;font-weight:bold;width:90px;outline: 0px solid #d50000;">~<input type="text" id="rsltseDt" name="rsltseDt" readonly style="text-align:center;font-weight:bold;width:90px;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">실행원가</th>
						    <td><input type="text" id="actPrc" name="actPrc" comma readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">생산공수(계획 / 실적)</th>
						    <td><input type="text" id="prdExpMh" name="prdExpMh" readonly style="text-align:center;font-weight:bold;width:90px;outline: 0px solid #d50000;">/<input type="text" id="prdctnRsltMh" name="prdctnRsltMh" readonly style="text-align:center;font-weight:bold;width:90px;outline: 0px solid #d50000;"></td>
						  </tr>
						  <tr height="35">
						    <th style="text-align:center;">실적소요일</th>
						    <td><input type="text" id="rsltDaycnt" name="rsltDaycnt" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">견적대비 실적율 (%)</th>
						    <td><input type="text" id="trgtRate" name="trgtRate" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">생산공수 실적율 (%)</th>
						    <td><input type="text" id="prdctnDayRate" name="prdctnDayRate" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						  </tr>
						  <tr height="35">
						    <th style="text-align:center;">계획대비 실적율 (%)</th>
						    <td><input type="text" id="dayRate" name="dayRate" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;">목표대비 실적율 (%)</th>
						    <td><input type="text" id="actRate" name="actRate" readonly style="text-align:center;font-weight:bold;width:100%;outline: 0px solid #d50000;"></td>
						    <th style="text-align:center;font-weight:bold;color:blue;">평가자</th>
						    <td><div class="search_form">
                               <input type="hidden" id="evlId" name="evlId" required="required" msg="평가자">
                               <input type="text" id="evlNm" name="evlNm"onkeyUp="if(window.event.keyCode == 8){evlId.value = ''};" readonly style="text-align:center;font-weight:bold;color:blue;">
                               <a id="openUserSearch" onclick="openUserSearch(1);">
                                   <i class="i_search_w"></i>
                               </a>
                               </div></td>
						  </tr>
						  
						</table>
                        
                        </td>                                                
                      </tr>
                      <tr style="text-align: left;">
                      <th>평가의견 <br> (2000자)</th>                         
                      <td colspan="10"> 
                         <textarea id="evlCnts" name="evlCnts" cols="200" rows="5"   style="border-width:0px;border-color:red;" > </textarea>                        
                      </td>
                      </tr>   
                 </table>  

                 
                 <table style="border:0px;">
                     <tr style="height:30px;">
                       <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
                       <td>
                       <div class="add_btn_small pdl10">       
                               <a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;" >+</a>
                               <a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;" >-</a>    
                           </div>
                       </td>
                     </tr>
                     <tr>
                       <td colspan="2">
                        <div>
                          <div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
                        </div>
                       </td> 
                     </tr>  
                 </table>      
                 
                 
                                 
               </form>                 
        </div>
    </div>
    

    <div class="contents"> 
    <!-- 공통 파일 영역 -->
         <div id="fileList_area"></div>       
    </div>
    
     <br>
    <div class="col-xs-2" style="height: 70px;">
    </div>

<div class ="popup_bottom_btn">
        <button type="button" id="actionBtn" >등록</button>
        <button type="button" class="close_btn"
            onclick="modalStack.close();">닫기</button>
    </div>
 </div>
    
<script type="text/javascript">
var actionType = null;
var coCd = null;
var salesCd = null;

setCommonSelect($(".popup_area select[data-kind]"));


//카톡 정상알림 카운터 변수
var kakaoCnt = 0;


var rGridView = {
        initView: function(){
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: false,
                multipleSelect: false,
                sortable: true,
                target: $('[data-ax5grid="grid-modal"]'),
                header: {
                  align: "center",
                  selector: false
                },
                body: {
                    onClick: function () {
                        //this.self.select(this.dindex); 
                    },
                    onDBLClick: function () {
                        //this.self.clearSelect();
                        //this.self.select(this.dindex);
                    },
               },
               page : {
                   display : false,
               },
               columns: [
                     {key: "coCd",             label: "회사",     hidden:true},
                     {key: "salesCd",             label: "SALES CODE",     hidden:true},
                     {key: "issDivNm",             label: "이슈유형",     align: "center",   width: 100, styleClass: "grid-font-blue-bold"},
                     {key: "planCnt",             label: "계획이슈",     align: "center",   width: 90, styleClass: "grid-font-blue-bold"},
                     {key: "rsltCnt",             label: "실적이슈",     align: "center",   width: 90, styleClass: "grid-font-blue-bold"},
                     
                     ],
            });
            return this;
          },
          setData: function() {
              var targetObj = this.target;
              var formData = {
                  "coCd" : coCd,
                  "salesCd" : salesCd
              }
              postAjax("/user/wb/wb25/selectWbsTaskEvlIssList", formData, null, function(data){
                  var list = data.resultList;                  
                  targetObj.setData({
                       list : list,
                       page : {
                           totalElements : list.length
                       }
                   });
                  
              });
         } 
     }


var gridViewPop = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $('[data-ax5grid="first-grid-modal"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                     onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : false,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        gridView.setData(this.page.selectPage);
                    }
                },
                columns : [
                        {key: "gb",                 label: "구분",        align: "center",   width: 40},
                        {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                        //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                        {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                        {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                        {key: "name",               label: "성명",        align: "center",   width: 80},
                        {key: "jik",                label: "직위",        align: "center",   width: 60},
                        {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
                        {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
                        {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
                        {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                        {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                      ]
                    });
                    return this;
                },

                setData : function(_pageNo) {
                    var targetObj = this.target;
                    var formData = {
                            "fileTrgtKey" : $("#popForm_S #fileTrgtKey").val(),
                            "reqNo" :  $("#popForm_S #sjFileTrgtKey").val(), 
                            "flag" : "N",
                            "pageNo" : _pageNo + 1
                    }
                    postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data){    
                    var list = data.result;
                        targetObj.setData({
                            list : list,
                            page : {
// //                                   currentPage : _pageNo,
// //                                   pageSize : data.paginationInfo.pageSize,
                                        totalElements :  data.paginationInfo.totalRecordCount,
// //                                   totalPages : data.paginationInfo.totalPageCount
                            } 
                        });
                    });
                },

                setData2 : function(_list) {
                    this.target.setData({
                            list : _list,
                            page : {
                                        totalElements :  _list.length,
                            } 
                        });
                }
    }

$(document).ready(function() {
    actionType = modalStack.last().paramObj.actionType;
    coCd = modalStack.last().paramObj.coCd;
    salesCd = modalStack.last().paramObj.salesCd;
    
     $('#popForm_S #actionType').val(actionType);
     $("#popForm_S #coCd").val(coCd);
     $("#popForm_S #salesCd").val(salesCd);
     $("#popForm_S #userId").val(jwt.userId);
    
     if (actionType == "C") {
    	 $('.tit').text('WBS 과제 평가 등록')
         $('#actionBtn').text("등록");
          $('#actionBtn').on("click", function() {
             insertWbsTaskEvl();
         }); 
     }
     else if (actionType == "U") {
    	 
    	 $('.tit').text('WBS 과제 평가 수정')
         $('#actionBtn').text("수정");         
    	 $('#actionBtn').on("click", function() {
             updateWbsTaskEvl();
         });        
         
    	 //평가자 변경 불가
    	 $('#openUserSearch').hide();
    	 
         var row = gridView.target.getList("selected")[0];
         if (row != undefined) {
        	 $.each(row, function (key, val) { 
        		 if (key == "planCloseYn" && val == "Y") {
                     //$('#actionBtn').hide();
                     //$('.tit').text('WBS 과제 평가 보기')
                 }
        		 if ($('#popForm_S #' + key)[0]) {
                     $('#popForm_S #' + key).val(val);
                     if ($('#popForm_S #' + key).is('[comma]')) {
                         onlyNumber($('#popForm_S #' + key)[0]);
                     }
                 }
             });
         }
     }

     // 회사코드 변경시 등록 버튼 숨김
     if ($("#coCd").val() != jwt.coCd) {
    	 $('#actionBtn').hide();
     }
     
     
  // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅 
     var paramObj1 = {
             "coCd" : $("#popForm_S #coCd").val(),
             "userId" : jwt.userId
         }; 
      postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){  
          if (data.result[0] == undefined
                || data.result[0].telNo == "") {
              $("#popForm_S #telNo").val("051-312-2400");  
          }
          else {
              $("#popForm_S #telNo").val(data.result[0].telNo);           
          }
          //alert($("#popForm_S #telNo").val());
      }); 
     //---------------------------------------
     
     var paramObj = modalStack.last().paramObj;
     postAjaxSync("/user/wb/wb25/selectWbsTaskEvlResultList", paramObj, null, function(data){
         var list = data.resultList[0];
         if (list != undefined) {
             $.each(list, function (key, val) {
            	 if ($('#popForm_S #' + key)[0]) {
                     $('#popForm_S #' + key).val(val);
                     if ($('#popForm_S #' + key).is('[comma]')) {
                         onlyNumber($('#popForm_S #' + key)[0]);
                     }
                 }
             });           
         }
     });  
     
    rGridView.initView().setData(0);
     
    gridViewPop.initView().setData(0);
    
    //---------------------------------------------------------------  
      //첨부 화일 처리 시작 
      //---------------------------------------------------------------
      fileParam = {
              fileTrgtTyp : $("#popForm_S #pgmId").val(),
              fileTrgtKey     :$("#popForm_S #fileTrgtKey").val()
      }
      treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
      //---------------------------------------------------------------  
      //첨부 화일 처리 끝
      //---------------------------------------------------------------  
      
      authChk();          
});

function insertWbsTaskEvl() { 
	
    if (inputValidation($('.popup_area [required]'))) { 
        var formData = makeFormData();                                      
        filePostAjax("/user/wb/wb25/wbsTaskEvlInsert", formData,             
                function(data) {
                    alert(data.resultMessage);   
                    kakaoTodo();
                    if (data.resultCode == 200) { 
                    	gridView.setData(0);
                        modalStack.close();                              
                    }
                });                                
    }
}

function updateWbsTaskEvl() { 

	if (inputValidation($('.popup_area [required]'))) { 
        var formData = makeFormData();  
        filePostAjax("/user/wb/wb25/wbsTaskEvlUpdate", formData,             
                function(data) {
                    alert(data.resultMessage);    
                    kakaoTodo();
                    if (data.resultCode == 200) {                          
                    	gridView.setData(0);
                        modalStack.close();                              
                    }
                });                                
    }
}

function makeFormData() {  
    $.each($('.popup_area input[comma]'), function(idx, elem) {
        deleteComma(elem);
    });
    
    // 폼데이터 생성
    var formData = new FormData($("#popForm_S")[0]);
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
    formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용
    
    formData.append("approvalYnCnt", approvalYn());
    
    var fileUploadArr = [];
    var tempArr = [];
    
    tempArr = treeModule.getFileArr();
    $.each(tempArr, function(idx, obj) {
        if (obj.fileKey == 0) {
            formData.append("files", obj.file);
            obj.file = '';
            fileUploadArr.push(obj);
        }
    });

    formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
    formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
    //---------------------------------------------------------------  
    //--첨부화일 처리를 위한 부분 끝
    //--------------------------------------------------------------- 

   var rowSharngList = gridViewPop.target.list;
   var ParamObj = modalStack.last().paramObj.ParamObj;

   if(rowSharngList.length > 0) {
       var rowSharngListArr = []; //공유정보
       var rowApprovalListArr = []; //결재정보
       $.each(rowSharngList, function(idx, elem){
           var rowSharngListObj = elem;
           var rowApprovalListObj = elem;

           if (elem.gb == '공유'){
               rowSharngListObj["gb"] = elem.gb;
               rowSharngListObj["coCd"] = $('#coCd').val();
               rowSharngListObj["salesCd"] = $('#salesCd').val();
               rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
               rowSharngListObj["todoDiv2CodeId"] = "TODODIV1070";
               rowSharngListObj["todoId"] = elem.usrNm;
               rowSharngListObj["todoCoCd"] = elem.coCd;
               rowSharngListObj["empNo"] = elem.empNo;
               rowSharngListObj["name"] = elem.name;
               rowSharngListObj["telNo"] = elem.telNo;
               rowSharngListObj["email"] = elem.eMail;    
               rowSharngListObj["pgPath"] = "/user/wb/wb25/WB2501P02.html";
               rowSharngListArr.push(rowSharngListObj);

           }
           else if (elem.gb == '결재'){
               rowApprovalListObj["gb"] = elem.gb;
               rowApprovalListObj["coCd"] = $('#coCd').val();
               rowApprovalListObj["salesCd"] = $('#salesCd').val();
               rowApprovalListObj["todoDiv1CodeId"] = "TODODIV20";
               rowApprovalListObj["todoDiv2CodeId"] = "TODODIV2080";
               rowApprovalListObj["todoId"] = elem.usrNm;
               rowApprovalListObj["todoCoCd"] = elem.coCd;
               rowApprovalListObj["empNo"] = elem.empNo;
               rowApprovalListObj["name"] = elem.name;
               rowApprovalListObj["telNo"] = elem.telNo;
               rowApprovalListObj["email"] = elem.eMail;    
               rowApprovalListObj["pgPath"] = "/user/wb/wb25/WB2501P02.html";
               rowApprovalListArr.push(rowApprovalListObj);
           }
       });
       formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));
       formData.append("rowApprovalListArr", JSON.stringify(rowApprovalListArr));
       
   }
   return formData;
}


//공유대상자 추가//  
function insertShareUserModal() { 
	if( approvalYn() ) {
        alert("결재가 이미 진행중입니다.");
        return;
    }
	
    var paramObj = {};
    var appshaList = gridViewPop.target.list;
    paramObj["coCd"] = $('#coCd').val();
    paramObj["useYn"] =  "Y";
    paramObj["userId"] =  $('#ordrgId').val();
    paramObj["userNm"] =  $('#ordrgNm').val();
    paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";   
            }).map(function(item) {
                    return {
                        gb: "결재",
                        id: item.usrNm,
                        text: item.name,
                        parent: item.jik,
                        deptNm: item.dtNm,
                        telNo: item.telNo,
                        offTelNo: item.offTelNo,
                        email: item.email
                    };
            });
    paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
            }).map(function(item) {
                    return {
                        gb: "공유",
                        id: item.usrNm,
                        text: item.name,
                        parent: item.jik,
                        deptNm: item.dtNm,
                        telNo: item.telNo,
                        offTelNo: item.offTelNo,
                        email: item.email
                    };
            });
    openModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
        console.log('결재라인 : ', approvalGrid.target.list);
        console.log('공유라인 : ', shareGrid.target.list);
        
        var appArray = approvalGrid.target.list.map(function(item) {
              return {
                    gb: "결재",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
        });
        var shaArray = shareGrid.target.list.map(function(item) {
          return {
                    gb: "공유",
                    usrNm: item.id,
                    name: item.text,
                    jik: item.parent,
                    dtNm: item.deptNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email,
                };
        });
        gridViewPop.setData2(appArray.concat(shaArray));
        
    });
    
}   

function deleteShareUser(){    
	if( approvalYn() ) {
        alert("결재가 이미 진행중입니다.");
        return;
    }
	
    var selRow = parseInt(gridViewPop.target.selectedDataIndexs);    
    if( isNaN(selRow) ) {
        alert("선택된 행이 없습니다.");
        return;
    } else {            
            if( selRow > -1 ) {
                gridViewPop.target.removeRow(selRow);                   
            }
    }
}


//평가자  검색
function openUserSearch(type) {
    var paramObj = {};
    paramObj["coCd"] = jwt.coCd;
    paramObj["userId"] = $('#popForm_S #evlId').val();
    paramObj["useYn"] =  "Y";
    openModal("/static/html/cmn/modal/userSearch.html", 300, 500, "작성자 검색", paramObj, function (tree){
        var checkedId = tree.get_checked()[0];
        var checkedNode = tree.get_node(checkedId);
        
        $('#popForm_S #evlId').val(checkedNode.id);
        $('#popForm_S #evlNm').val(checkedNode.text);           
    });
}


function approvalYn() {
    var gridList = gridViewPop.target.getList();
    var inCnt = 0;
    if( gridList.length > 0 ) {
        var msgArr = [];            
        $.each(gridList, function (idx, elem) { 
            //결재자가 본인이 아니면서 상태가 Y인 경우
            if( elem.usrNm != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
        })
    }
    return inCnt;
}




//KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
    let param = {
            "tmplatDiv": "TMPLATDIV02"
            , "coCd": $("#popForm_S #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": todoDiv1CodeId //"TODODIV10"                 //공통코드 해당업무 - 결재
            , "todoDiv2CodeId": todoDiv2CodeId // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv1CodeNm": todoDiv1CodeNm // "WBS이슈"                        //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv2CodeNm": todoDiv2CodeNm // "WBS계획이슈"                       //공통코드 해당업무 - 결재 - 발주서
            , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $("#popForm_S #sjFileTrgtKey").val()
            , "clntCd": "1"                 //발신회사는 로그인사용자 회사
            , "clntNm": $("#popForm_S #clntNm").val()              //로그의 수신거래처명
            , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
            , "ordrgMngTelNo": $("#popForm_S #telNo").val()       //담당자전화번호    
            , "creatPgm": "WB2501P01"
    }
    commKaKaoSendTodo(param);
}

function kakaoTodo() {
   let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
       
   // 1. 이슈 공유, 결재 프로세스
   var rowList = gridViewPop.target.getList();
   var sharChk = 0;
   var appChk = 0;
   $.each(rowList, function(idx, elem){
       if (elem.gb == "공유") {
           sharChk++;
       }
       else if (elem.gb == "결재") {
           appChk++;
       }
   });  
   // 1-1. 과제 평가 공유 알림톡 처리
   if (sharChk > 0) {
       kakaoSendBody('TODODIV10','TODODIV1070', '과제평가','과제평가 공유','공유');
   }
       
   // 1-2. 과제 평가 결재 알림톡 처리
   if (appChk > 0) {
       kakaoSendBody('TODODIV20','TODODIV2080', '과제평가','과제평가 결재','결재');              
   }

   if (kakaoCnt > 0) {
       kakaoCnt = 0;
       alert("알림톡이 정상 발송되었습니다.");
   }
} 

//to-do결재요청 알림톡
function commKaKaoSendTodo(param) {
   //console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

   //알림톡수신번호 채번
   var maxMessageId = null;            //message id(unique key)
   var talkMessage = null              //발송될 내용 template
   var mobile = null                   //수신인 휴대전화번호
   var title = null                    //todo title
   var sendList = [];
   let talkParam = {};
   let talkBody = {};      
   let sendCnt = 0;
   postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null            
               , function(data) {   
                   if(data.resultList.length > 0 ) {
                       if( data.resultList[0].maxMessageId != "" ) {
                           sendList = data.resultList; 
                       } else {
                           alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                           return;
                       } 

                   }
   });         
   //user search ajax end
   
   //대상 loop
   $.each(sendList, function (key, sendObj) {
       maxMessageId = sendObj.maxMessageId;                            
       talkMessage = sendObj.messageDesc;
       mobile =  sendObj.telNo;
       //로그용
       param.rcvId = sendObj.todoId;           //todo 수신id
       param.rcvNm = sendObj.name;             //todo 수신자명
       param.nameTo = sendObj.name;                //todo 수신자명
       
       // 알림톡 Title 자리수 제한 문자열 자르기
       if (sendObj.todoTitl.length > 30) {
    	   title = sendObj.todoTitl.substring(0,25);
       }
       else {
    	   title = sendObj.todoTitl;   
       }
       
       param.title = title;                                //요청내용제목
       param.sendDt = sendObj.sendDt;
       
       if(mobile == "" || mobile == null) {
           alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
           return;
       }
       if(talkMessage == "" || talkMessage == null) {
           alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
           return;
       }   
       //message 치환
       let message = talkMessage;
       let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`); 
       //loop
       $.each(splitStr, function (key, val) {      
           let compKey = val.substring(1, val.length-1);
           if( compKey != "" && compKey != "undefined" ) {
               if( typeof(param[compKey]) != "undefined" ) {
                   let val2 = '#'+val;
                   message = message.replaceAll(val2, param[compKey]);
               }
           }
       });
       talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
       talkParam.serverName = "gyitt2400";     
       talkParam.paymentType = "P";
       talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
       talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값); 
       talkBody.title = title;                 //알림톡 타이틀 -
       talkBody.message = message;             //알림톡 메시지 (1000 byte) 
       talkBody.mobile = mobile;               //휴대전화번호
       talkBody.template = "10003";            //템플릿관리화면 템플릿ID - 발주서 V2
       let talkJson = JSON.stringify(talkBody);
       sendCnt = kakaoSendReal(talkJson, talkParam, param);        
   });
   //대상 loop end
   if( sendCnt > 0 ) {
       //alert("알림톡 정상 발송되었습니다.");  
       kakaoCnt++;
   }
   
   //한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
  /*  talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
   talkBody.mobile = "01063893764"
   talkJson = JSON.stringify(talkBody); */
   //kakaoSendReal(talkJson, talkParam, param);
}



var kakaoErr = [];
//message load
var paramObj = {
               "userId" : jwt.userId
               , "codeKind" : "KAKAOMSG"
               };
postAjax("/user/sm/sm02/selectCurrToday", paramObj, null
           , function(data) {   
               if(data.resultList.length > 0 ) {
                   kakaoErr = data.resultList;
               }
});     //user search ajax end  


 </script>
 
