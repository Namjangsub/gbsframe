<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
<link rel="stylesheet" href="/static/fontawesome/css/all.css">
<link rel="stylesheet" href="/static/css/ax5/ax5grid.css">
<link rel="stylesheet" href="/static/css/ax5/ax5mask.css">
<link rel="stylesheet" href="/static/css/ax5/ax5modal.css">
<link rel="stylesheet" href="/static/css/ax5/ax5toast.css">
<link rel="stylesheet" href="/static/css/ax5/ax5menu.css">
<link rel="stylesheet" href="/static/css/ax5/ax5calendar.css">
<link rel="stylesheet" href="/static/css/jstree/style.min.css">
<link rel="stylesheet" href="/static/css/ax5/ax5combobox.css">
<link rel="stylesheet" href="/static/css/gnb.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/sub.css">
<link rel="stylesheet" href="/static/css/common.css">

<script src="/static/js/jquery-latest.min.js"></script>
<script src="/static/js/jquery.serializeObject.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
<script src="/static/js/moment/moment-with-locales.js"></script>
<script src="/static/js/jstree/jstree.min.js"></script>
<script src="/static/js/ax5/ax5core.min.js"></script>
<script src="/static/js/ax5/ax5grid.min.js"></script>
<script src="/static/js/ax5/ax5mask.min.js"></script>
<script src="/static/js/ax5/ax5modal.min.js"></script>
<script src="/static/js/ax5/ax5toast.min.js"></script>
<script src="/static/js/ax5/ax5calendar.min.js"></script>
<script src="/static/js/ax5/ax5picker.min.js"></script>
<script src="/static/js/ax5/ax5menu.min.js"></script>
<script src="/static/js/ax5/ax5formatter.min.js"></script>
<script src="/static/js/ax5/ax5combobox.min.js"></script>

<script src="/static/js/global.js"></script>
<script src="/static/js/fileTree.js"></script>

</head>

<body>
    <div id="head_area"></div>
    <div id="top_area"></div>
    
    <div id="main_area">
        <!-- 페이지 상단 -->
        <div class="contents no_bg">
            <ul class="btn_ul">
                <li class="btn_r">
                     <a onclick="initSearch();"><button class="bg_gray">초기화</button></a>
                     <a onclick="salesGridView.setData(0);"><button class="bg_gray">검 색</button></a>
                </li>
            </ul>
        </div>
         <!-- 검색 콘텐츠 -->
        <div class="contents search">
            <div class="">
                <!-- 테이블 인풋 3분할 -->
                <table class="table_input type04">
                
                    <!-- 검색조건 1행 -->
                    <tr>
                        <th class= "hit">회사</th>
                        <td>
                            <select id="coCd_S" name="coCd_S" data-kind="CO" data-search="coCd" required msg="회사">
                              <option value="">전체</option>
                            </select>
                        </td>
                        
                        <th class= "hit">Sales Code</th>
                        <td>
                             <div class="search_form">
                                <input type="text" id="salesCd_S" name="salesCd_S" data-search="salesCd" onkeyup="event.keyCode == 13 ? salesGridView.setData(0) : ''" onchange="gridView.setData(0);">
                                <a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
                            </div>
                            <input type="hidden" id="salesNm_S" name="salesNm_S" >
                        </td>
                        
                        <th>&nbsp;</th>
                        <td>&nbsp;</td>
                        
                        <th></th>
                        <td>
                           
                        </td>
                    </tr>
                    <!-- 검색조건 END -->
                </table>
                <input type="hidden" id="userId"    name="userId">
                <input type="hidden" id="pgmId"     name="pgmId" value="WB0111M01">
            </div>
        </div>

        <!-- 콘텐츠 -->
<div class="contents no_bg">
              <div class="contents_tit">
                <div class="add_btn_small pdl10">
                  <a onclick="deleteWbsPlanIssue();" style="height: 30px; line-height: 28px; width: 60px;">삭제</a>
                  <a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
                </div>
                <select id="recordCnt" class="prae_select" onchange="salesGridView.setData(0);">
                  <option value="10">10</option>
                  <option value="20" selected>20</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="9999999">전체</option>
                </select> 
             </div>
              
       
      <div class="row" style="margin-top: 15px;">
      <div class="col-xs-4" style="padding-right: 5px;">
        <div class="contents" style="margin: 0px; padding: 0px; height: 700px; width: 100%; min-width: 200px">
              <div class="ax5_grid" data-ax5grid="sales-grid" data-ax5grid-config="{}" style="height: 700px; width: 100%" ></div>            
        </div>
      </div>
      <div class="col-xs-8" style="padding-left: 0;">
        <div class="contents">
            <!-- 리스트 -->
              <div class="ax5_grid" data-ax5grid="issue-grid" data-ax5grid-config="{}" style="height: 700px; width: 100%" ></div>
              <div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
        </div>
      </div>
    </div>  
       
    </div>
                    
</body>
</html>

<script type="text/javascript">
    var salesCd = null;
    var isFirst = true;
    var beforeIndex ='';
    ax5.ui.grid.formatter["chkYn"] = function () {
        var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
        if (this.value == "E"){
            return ' ';
        } else {
            return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
        }
    };
    var salesGridView = {
            initView : function() {
                this.target = new ax5.ui.grid();
                this.target.setConfig({
                    showLineNumber: false,
                    showRowSelector : true,
                    multipleSelect : true,
                    sortable : false,
                    target: $('[data-ax5grid="sales-grid"]'),
                    header : {
                        align : "center",
                        selector : true
                    },
                    body: {
                        mergeCells : ["ordrsClntNm","ordrsNo","salesCd"],
                        columnHeight: 26,
                        onClick: function () {
                            var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                                salesGridView.target.select(obj.__origin_index__, {selected: false});
                            });                         
                            this.self.select(this.dindex);
                            if (this.item.dataGbn == 'D') {
                                salesCd = this.item.salesCd;
                               
                                issueGridView.setData(0, this.item.salesCd);
                            }
                            
                        },
                        onDBLClick: function () {
                            var list = salesGridView.target.getList("selected");
                            $.each(list, function(idx, obj){
                                salesGridView.target.select(obj.__origin_index__, {selected: false});
                            })                          
                            this.self.select(this.dindex);
                            //debugger;
                            if (this.item.dataGbn == 'D') {
                                salesCd = this.item.salesCd;
                                issueGridView.setData(0, this.item.salesCd);
                            }
                            
                        },
                   },
                   columns: [
                       {key: "pid",             label: "pid",       hidden: true},
                       {key: "id",              label: "id",        width: 160, hidden: true},
                       {key: "ordrsClntNm",     label: "고객사",       width: 100, align: "left"},
                       {key: "ordrsNo",         label: "오더번호",  width: 100, hidden: true, align: "left"},
                       {key: "salesCd",         label: "SALES CD",  width: 200, hidden: false, align: "left",  treeControl: true},
                       {key: "planCnt",         label: "계획/실적",     width: 60, hidden: false, align: "center", formatter: function () {
                           return this.item.dataGbn=='D' ? this.value + '/'+this.item.rsultCnt : ''}},
//                     {key: "rsultCnt",        label: "실적",    width: 100, hidden: false, align: "center"},
                       {label: "계획", columns: [  
                               {key: "planLockYn",          label: "잠금",    width: 35, align: "center", formatter: "chkYn"},  
                               {key: "planCloseYn",         label: "마감",    width: 35, align: "center", formatter: "chkYn"},
                       ]},
                       {label: "실적", columns: [  
                               {key: "rsultLockYn",         label: "잠금",    width: 35, align: "center", formatter: "chkYn"},  
                               {key: "rsultCloseYn",        label: "마감",    width: 35, align: "center", formatter: "chkYn"},  
                       ]},
                       {key: "dataGbn",         label: "원시구분",  width: 80, hidden: true},
                   ],
                   page : {
                        navigationItemCount : 10,
                        height : 30,
                        display : true,
                        firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                        prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                        nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                        onChange : function() {
                            salesGridView.setData(this.page.selectPage);
                        }
                    },
                    tree: {
                        use: true,
                        indentWidth: 15,
                        arrowWidth: 15,
                        iconWidth: 18,
                        icons: {
                            openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                            collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                            groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                            collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
                            itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
                        },
                       columnKeys: {
                           parentKey: "pid",
                           selfKey: "id",
                       }
                   }
                });
                return this;
            },
            setData : function(_pageNo) {
                var targetObj = this.target;
                var paramObj = {
                        "coCd": $('#coCd_S').val(),
                        "salesCd": $('#salesCd_S').val(),
                        "pageNo" : _pageNo + 1,
                        "recordCnt" : $('#recordCnt').val()};
                postAjax("/user/wb/wb01/selectWbsLeftSalesCodeList", paramObj, null, function(data){
                     var list = data.fileList;
                        targetObj.setData({
                            list : list,
                            page : {
                                currentPage : _pageNo,
                                pageSize : data.paginationInfo.pageSize,
                                totalElements : data.paginationInfo.totalRecordCount,
                                totalPages : data.paginationInfo.totalPageCount
                            }
                        });
                });
            } 
            
        }

    var issueGridView = {
            initView : function() {
                this.target = new ax5.ui.grid();
                this.target.setConfig({
                    showRowSelector: true,
                    multipleSelect: true,
                    sortable: false,
                    target: $('[data-ax5grid="issue-grid"]'),
                    header : {
                        align : "center",
                        selector : false
                    },
                   columns: [
                        {key: "rnum",  label: "NO.", hidden:true},
                        {key: "lvl",  label: "lvl", hidden:true},
                        {key: "codeId",  label: "codeId", align: "left", width: 200, hidden:true, treeControl: true},
                        {key: "codeKind",  label: "codeKind", hidden:true},
                        {key: "coCd",  label: "회사코드", hidden:true},
                        {key: "coCdNm",  label: "회사명", width: 80, hidden:true, align: "center"},
                        {key: "salesCd",  label: "SALES CD", width: 100, hidden:true, align: "center"},
                        {key: "codeNm",  label: "WBS 계획구분", align: "left", width: 200,  treeControl: true},
                        {key: "wbsPlanFileTrgtKey", label: "wbsPlanFileTrgtKey", hidden:true},
                        {key: "wbsPlanNo",          label: "wbsPlanNo", hidden:true},
                        {key: "wbsPlanStsCodeId",   label: "계획상태코드",   hidden: true},
                        {key: "wbsPlanId",          label: "담당자",      hidden:true},
                        {key: "wbsPlanNm",            label: "담당자",      hidden:true},
                        {key: "wbsPlanDt",            label: "담당자",      hidden:true},
                        {key: "wbsPlanStsNm",       label: "계획상태",      hidden:true}, 
                        {key: "wbsPlanMngId",     label: "담당자",      hidden:true}, 
                        {key: "wbsPlanMngNm",     label: "담당자",      align: "center",   width: 80}, 
                        {key: "wbsPlanCnts",      label: "주요내용",      align: "left",   width: 100},
                        {key: "wbsPlanRmk",      label: "비고",      hidden:true},    
                        {key: "wbsPlansDt",         label: "시작일자",      align: "center",   width: 80},
                        {key: "wbsPlaneDt",         label: "종료일자",      align: "center",   width: 80},
                        
                        {key: "issNo",         label: "이슈번호",      align: "center",   width: 80},                        
                        {key: "issDiv",         label: "이슈유형",      hidden:true},
                        {key: "issDivNm",         label: "이슈유형",      align: "center",   width: 80},
                        {key: "issDtlDiv",         label: "이슈세부유형",      hidden:true},
                        {key: "issDtlDivNm",         label: "이슈세부유형",      align: "center",   width: 80},
                        {key: "issGrd",         label: "이슈등급",      hidden:true},
                        {key: "issGrdNm",         label: "이슈등급",      align: "center",   width: 80},
                        {key: "issSts",         label: "이슈상태",      hidden:true},
                        {key: "issStsNm",         label: "이슈상태",      align: "center",   width: 80},
                        
                        {key: "issCnts",         label: "이슈내용",      align: "center",   width: 80},
                        {key: "causeCnts",         label: "원인",      align: "center",   width: 80},
                        
                        {key: "actYn",         label: "조치필요여부",      align: "center",   width: 80},                        
                        {key: "actId",         label: "조치자",      hidden:true},
                        {key: "actNm",         label: "조치자",      align: "center",   width: 80},
                        {key: "actsDt",         label: "조치시작일",      align: "center",   width: 80},
                        {key: "acteDt",         label: "조치종료일",      align: "center",   width: 80},
                        {key: "actMh",         label: "투입공수",      align: "center",   width: 80},
                        {key: "actAmt",         label: "투입비용",      align: "center",   width: 80},
                        {key: "actCnts",         label: "조치내용",      align: "center",   width: 80},
                        {key: "cfYn",         label: "확인필요여부",      align: "center",   width: 80},
                        {key: "cfId",         label: "확인자",      hidden:true},
                        {key: "cfNm",         label: "확인자",      align: "center",   width: 80},
                        
                        {key: "cfDiv",         label: "확인유형",      hidden:true},
                        {key: "cfDivNm",         label: "확인유형",      align: "center",   width: 80},
                        {key: "cfDtlDiv",         label: "확인세부유형",      hidden:true},
                        {key: "cfDtlDivNm",         label: "확인세부유형",      align: "center",   width: 80},
                        {key: "cfGrd",         label: "확인등급",      hidden:true},
                        {key: "cfGrdNm",         label: "확인등급",      align: "center",   width: 80},
                        
                        {key: "cfCnts",         label: "확인내용",      align: "center",   width: 80},                                               
                        {key: "creatDttm",         label: "생성일시",      align: "center",   width: 120},
                        {key: "creatId",         label: "생성자",      hidden:true},
                        {key: "creatNm",         label: "생성자",      align: "center",   width: 80},
                        {key: "udtDttm",         label: "최종변경일자",      align: "center",   width: 120},
                        {key: "udtId",         label: "최종변경자",      hidden:true},
                        {key: "udtNm",         label: "최종변경자",      align: "center",   width: 80},
                        {key: "fileTrgtKey",         label: "이슈 FileTrgtKey",      hidden:true}
                   ],
                    body: {
                        mergeCells : ["coCdNm","codeNm"],
                        columnHeight: 26,
                        onClick: function () {
                             var list = issueGridView.target.getList();
                             $.each(list, function(idx, obj){
                            	 issueGridView.target.select(obj.__index, {selected: false});
                             }); 
                             this.self.select(this.dindex);
                        },
                        
                        onDBLClick: function () {
                            if (beforeIndex) {
                                this.self.select(beforeIndex);
                            }
                            this.self.select(this.dindex);
                            insertWbsPlanModal(this.dindex);
                            beforeIndex = this.dindex;
                        },
                        onDataChanged: function () {
                            if (this.key == 'isChecked') {
                                this.self.updateChildRows(this.dindex, {isChecked: this.item.isChecked});
                            }
                            else if(this.key == '__selected__'){
                                this.self.updateChildRows(this.dindex, {__selected__: this.item.__selected__});
                            }
                        }
                   },
                   page : {
                        navigationItemCount : 10,
                        height : 30,
                        use : true,
                        firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                        prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                        nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                        onChange : function() {
                            gridView.setData(this.page.selectPage);
                        }
                    },
                    tree: {
                        use: true,
                        indentWidth: 15,
                        arrowWidth: 15,
                        iconWidth: 18,
                        icons: {
                            openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                            collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                            groupIcon: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                            collapsedGroupIcon: '<i class="fa fa-folder" aria-hidden="true"></i>',
                            itemIcon: '<i class="fa fa-file" aria-hidden="true"></i>'
                        },
                       columnKeys: {
                           parentKey: "codeKind",
                           selfKey: "codeId",
                       }
                   }
                });
                return this;
            },
            setData : function(_pageNo, salesCd) {
                if (isFirst) return;
                var targetObj = this.target;
                //alert(salesCd);
                var paramObj = {"coCd": $('#coCd_S').val(),
                      "salesCd" : salesCd,
                      "pageNo" : _pageNo + 1,
                      "recordCnt" : $('#recordCnt').val()};
               // debugger;
                postAjax("/user/wb/wb03/selectWbsPlanTreeIssueList", paramObj, null, function(data){
                    var list = data.fileList;
                        targetObj.setData({
                            list : list,
                            page : {
                                totalElements : list.length,
                            }
                        });
                });
            } 

        }

    var excelView = {
            initView: function(){
            this.target = new ax5.ui.grid();
            this.target.setConfig({
            target: $('[data-ax5grid="excel-grid"]'),
            columns: [
                {key: "rnum",  label: "NO.", hidden:true},
                {key: "lvl",  label: "lvl", hidden:true},
                {key: "codeId",  label: "codeId", align: "left", width: 200, hidden:true, treeControl: true},
                {key: "codeKind",  label: "codeKind", hidden:true},
                {key: "coCd",  label: "회사코드", hidden:true},
                {key: "coCdNm",  label: "회사명", width: 80, hidden:true, align: "center"},
                {key: "salesCd",  label: "SALES CD", width: 100, hidden:true, align: "center"},
                {key: "codeNm",  label: "WBS 계획구분", align: "left", width: 200,  treeControl: true},
                {key: "wbsPlanFileTrgtKey", label: "wbsPlanFileTrgtKey", hidden:true},
                {key: "wbsPlanNo",          label: "wbsPlanNo", hidden:true},
                {key: "wbsPlanStsCodeId",   label: "계획상태코드",   hidden: true},
                {key: "wbsPlanId",          label: "담당자",      hidden:true},
                {key: "wbsPlanNm",            label: "담당자",      hidden:true},
                {key: "wbsPlanDt",            label: "담당자",      hidden:true},
                {key: "wbsPlanStsNm",       label: "계획상태",      hidden:true}, 
                {key: "wbsPlanMngId",     label: "담당자",      hidden:true}, 
                {key: "wbsPlanMngNm",     label: "담당자",      align: "center",   width: 80}, 
                {key: "wbsPlanCnts",      label: "주요내용",      align: "left",   width: 100},
                {key: "wbsPlanRmk",      label: "비고",      hidden:true},    
                {key: "wbsPlansDt",         label: "시작일자",      align: "center",   width: 80},
                {key: "wbsPlaneDt",         label: "종료일자",      align: "center",   width: 80},
                
                {key: "issNo",         label: "이슈번호",      align: "center",   width: 80},                        
                {key: "issDiv",         label: "이슈유형",      hidden:true},
                {key: "issDivNm",         label: "이슈유형",      align: "center",   width: 80},
                {key: "issDtlDiv",         label: "이슈세부유형",      hidden:true},
                {key: "issDtlDivNm",         label: "이슈세부유형",      align: "center",   width: 80},
                {key: "issGrd",         label: "이슈등급",      hidden:true},
                {key: "issGrdNm",         label: "이슈등급",      align: "center",   width: 80},
                {key: "issSts",         label: "이슈상태",      hidden:true},
                {key: "issStsNm",         label: "이슈상태",      align: "center",   width: 80},
                
                {key: "issCnts",         label: "이슈내용",      align: "center",   width: 80},
                {key: "causeCnts",         label: "원인",      align: "center",   width: 80},
                
                {key: "actYn",         label: "조치필요여부",      align: "center",   width: 80},                        
                {key: "actId",         label: "조치자",      hidden:true},
                {key: "actNm",         label: "조치자",      align: "center",   width: 80},
                {key: "actsDt",         label: "조치시작일",      align: "center",   width: 80},
                {key: "acteDt",         label: "조치종료일",      align: "center",   width: 80},
                {key: "actMh",         label: "투입공수",      align: "center",   width: 80},
                {key: "actAmt",         label: "투입비용",      align: "center",   width: 80},
                {key: "actCnts",         label: "조치내용",      align: "center",   width: 80},
                {key: "cfYn",         label: "확인필요여부",      align: "center",   width: 80},
                {key: "cfId",         label: "확인자",      hidden:true},
                {key: "cfNm",         label: "확인자",      align: "center",   width: 80},
                
                {key: "cfDiv",         label: "확인유형",      hidden:true},
                {key: "cfDivNm",         label: "확인유형",      align: "center",   width: 80},
                {key: "cfDtlDiv",         label: "확인세부유형",      hidden:true},
                {key: "cfDtlDivNm",         label: "확인세부유형",      align: "center",   width: 80},
                {key: "cfGrd",         label: "확인등급",      hidden:true},
                {key: "cfGrdNm",         label: "확인등급",      align: "center",   width: 80},
                
                {key: "cfCnts",         label: "확인내용",      align: "center",   width: 80},                                               
                {key: "creatDttm",         label: "생성일시",      align: "center",   width: 120},
                {key: "creatId",         label: "생성자",      hidden:true},
                {key: "creatNm",         label: "생성자",      align: "center",   width: 80},
                {key: "udtDttm",         label: "최종변경일자",      align: "center",   width: 120},
                {key: "udtId",         label: "최종변경자",      hidden:true},
                {key: "udtNm",         label: "최종변경자",      align: "center",   width: 80},
                {key: "fileTrgtKey",         label: "이슈 FileTrgtKey",      hidden:true}
               ]
            });
            return this;
        }
    }            
    
        $(document).ready(function() {

            mainDefaultLoad("WBS", "이슈 관리");          // 페이지 타이틀 설정
            setCommonSelect($("#main_area select[data-kind]"));     // 공통코드 set

            $("#coCd_S").val(jwt.coCd);
            

            isFirst = false;    
            salesGridView.initView().setData(0);
            issueGridView.initView();
            excelView.initView();
            //권한체크
            authChk();

        });
        
        // 초기화 버튼용
        function initSearch() {
             $("#coCd_S").val(jwt.coCd);

            
        }
     
        // 고객사 검색
        function openClntSearch(openType) {
            var paramObj = {
                    "searchValue" :  $("#clntNm_S").val()
            }       
            openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", paramObj, function (grid) {
                var row = grid.target.getList("selected")[0];
                if(openType == "P"){
                    $('#clntCd_S').val(row.clntCd);
                    $('#clntNm_S').val(row.clntNm);
                    gridView.setData(0);
                }else if(openType == "V"){
                    $('#vendCd_S').val(row.clntCd);
                    $('#vendNm_S').val(row.clntNm);
                }
            });
        }
     
        //제품코드 검색
        function openPrdtSearch(){
            var paramObj = {
                    "coCd": $('#coCd').val(),
                    "prdtCd": $('#prdtCd_S').val(),
                    "prdtNm": $('#prdtNm_S').val(),
                    "useYn" : "Y"
            }
            openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
                var row = grid.target.getList("selected")[0];
                $("#prdtCd_S").val(row.prdtCd);
                $("#prdtNm_S").val(row.prdtNm);
            });
        }
        
        //Sales Code (수주마스터, 수주상세테이블 조인) 검색
        function wbsSalesCodeSearch() {
            var paramObj = {
               "coCd" : $('#coCd_S').val(),
               "salesCd": $('#salesCd_S').val()
            };
            openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1000, 430, "SALES CODE 검색", paramObj, function (grid){
                var row = grid.target.getList("selected")[0];
                $('#salesCd_S').val(row.salesCd);
                salesGridView.setData(0);
            });
        }
        
        //관리번호 (WbsPlanNo) 검색
        function wbsPlanNoSearch() {
            var paramObj = {
               "coCd" : $('#coCd_S').val(),
               "wbsPlanNo": $('#wbsPlanNo_S').val()
            };
            openSecondModal("/static/html/cmn/modal/wbsPlanNoSearch.html", 450, 300, "관리번호 검색", paramObj, function (grid){
                var row = grid.target.getList("selected")[0];
                $('#wbsPlanNo_S').val(row.wbsPlanNo);
            });
        }
        
        //공유대상자 검색
        function openUserTree() {
            var paramObj = {
                "coCd" : $('#coCd_S').val(),
                "userId": $('#salesMngNm_S').val(),
                "useYn": "Y"
            };
            openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
                var checkedId = tree.get_checked()[0];
                var checkedNode = tree.get_node(checkedId);
                $('#salesMngId_S').val(checkedNode.id);
                $('#salesMngNm_S').val(checkedNode.text);
            });
        }
      
        
        function excelDown() {
        	var paramObj = {"coCd": $('#coCd_S').val(),
                    "salesCd" : salesCd};
              postAjax("/user/wb/wb03/selectWbsPlanTreeIssueExcelList", paramObj, null, function(data){
            	  var list = data.fileList;
                  excelView.target.setData({
                     list : list,
                     page : {
                               totalElements : list.length,
                     }
                  });
                  var todayDate = new Date().format('yyyyMMddHHmmss');
                  excelView.target.exportExcel("WBS_이슈 리스트"+todayDate+".xls");
              });
              
            
        }       
        
      /*계획 수정 or 등록 버튼 클릭 시*/
      function insertWbsPlanModal(idx) {
    	  var wbsPlanFileTrgtKey = null;
          var fileTrgtKey = 0;
          var actionType = "C";
          var coCd = null;
          var lvl = null;
          var salesCd = null;
          var idx1 = null;
          var idx2 = null;
          var idx3 = null;
          var issueIdx = idx;
          var row = issueGridView.target.getList()[idx];
          if (row == undefined){
        	  alert("WBS 계획을 선택하세요");
        	  return;
          }
          else {
        	  //debugger;
        	  if (row.wbsPlanFileTrgtKey == undefined) {
        		  alert("WBS 계획정보가 존재하지 않습니다. 계획 입력 후 이슈 등록이 가능합니다.")
        		  return;
        	  }
        	  else {
        		  wbsPlanFileTrgtKey = row.wbsPlanFileTrgtKey;
        		  fileTrgtKey = 0;
        		  actionType = "C";
        		  if (row.fileTrgtKey != undefined) {
        			  fileTrgtKey = row.fileTrgtKey;
        			  actionType = "U";
        		  }
        		  coCd = row.coCd;
                  lvl = row.lvl-1;
                  salesCd = row.salesCd;
                  idx1 = null;
                  idx2 = null;
                  idx3 = null;     
                  if (lvl == 1) {
                      idx1 = idx;
                  }
                  else if (lvl == 2) {
                      idx2 = idx;
                      
                      //1레벨 조회
                      var list1 = issueGridView.target.getList();
                      $.each(list1, function(idx, obj){
                          var row1 = issueGridView.target.getList()[obj.__index];
                          if (row1.coCd == row.coCd && row1.salesCd == row.salesCd && row1.codeId == row.codeKind) {
                              idx1 = obj.__index;                         
                          }
                      });
                  }
                  else if (lvl == 3) {
                      idx3 = idx;
                      //2레벨 조회
                      var list1 = issueGridView.target.getList();
                      $.each(list1, function(idx, obj){
                          var row1 = issueGridView.target.getList()[obj.__index];
                          if (row1.coCd == row.coCd && row1.salesCd == row.salesCd && row1.codeId == row.codeKind) {
                              idx2 = obj.__index;                         
                          }
                      });

                      //1레벨 조회
                      var row2 = issueGridView.target.getList()[idx2];                    
                      var list2 = issueGridView.target.getList();
                      $.each(list2, function(idx, obj){
                          var row3 = issueGridView.target.getList()[obj.__index];
                          if (row3.coCd == row2.coCd && row3.salesCd == row2.salesCd && row3.codeId == row2.codeKind) {
                              idx1 = obj.__index;                         
                          }
                      });
                  }
                  var paramObj = {
                          "actionType" : actionType,
                          "wbsPlanFileTrgtKey" : wbsPlanFileTrgtKey,
                          "fileTrgtKey" : fileTrgtKey,
                          "coCd" : coCd,
                          "lvl"      : lvl,
                          "idx1"      : idx1,
                          "idx2"   : idx2,
                          "idx3"  : idx3,
                          "salesCd" : salesCd,
                          "issueIdx" : issueIdx
                  }
                  openModal("/static/html/user/wb/wb03/WB0301P01.html", 1600, 850, "", paramObj, function(data) {}); 
        	  }
          }          
     }
      function deleteWbsPlanIssue() {   
          var list = issueGridView.target.getList("selected");
          var rowListArr = [];
          if(list.length > 0) {
              if(confirm("이슈리스트를 삭제하시겠습니까?")){
                  var formData = new FormData();
                  $.each(list, function(idx, elem){
                      var row = issueGridView.target.getList()[elem.__index];
                      if (row != undefined && row.fileTrgtKey != undefined) {
                          const obj = {fileTrgtKey:row.fileTrgtKey, 
                        		       coCd:row.coCd,
                        		       salesCd:row.salesCd,
                        		       issueNo:row.issNo,
                        		       wbsPlanCodeKind:row.codeKind,
                        		       wbsPlanCodeId:row.codeId,
                        		       S_todoDiv1CodeId:"TODODIV10",
                        		       S_todoDiv2CodeId:"TODODIV1030"
                        		       };
                          rowListArr.push(obj);
                      }               
                  });
                  formData.append("rowListArr", JSON.stringify(rowListArr));
                  filePutAjax("/user/wb/wb03/deleteWbsPlanIssue", formData, function(data){
                      if(data.resultCode == 200){
                          alert("삭제 완료되었습니다.");       
                          issueGridView.setData(0, salesCd);
                      }
                   }); 
              } 
          }
      }


</script>
