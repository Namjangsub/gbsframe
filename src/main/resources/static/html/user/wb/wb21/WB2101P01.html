<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit" id="popTit">과제관리 등록</h4>
	</div>

	<div class="popup_table">
		<div class="contents_tit">
			<div class="add_btn_small pdl10">
				<a id="copyBtn" onclick="wbsSjNocopySearch();" style="height: 30px; line-height: 28px; width: 60px;">복사</a>
				<a id="confirm" onclick="confirmY();" style="height: 30px; line-height: 28px; width: 60px;">확정</a>
				<!-- <a id="unconfirm" onclick="confirmN();" style="height: 30px; line-height: 28px; width: 60px;">미확정</a> -->
				<a id="verUp" onclick="createVerUp();" style="height: 30px; line-height: 28px; width: 60px;">Ver.Up</a>
			</div>
		</div>

		<form id="popForm">
			<input type="hidden" id="coCd"   name="coCd">
			<input type="hidden" id="userId" name="userId">
			<input type="hidden" id="userId" name="maxVerNo">
			<input type="hidden" id="pgmId" name="pgmId" value="WB2101M02">
			<table class="popup_table">
				<colgroup>
					<col width="15%">
					<col width="16%">
					<col width="24%">
					<col width="13%">
					<col width="24%">
					<col width="14%">
					<col width="23%">
					<col width="15%">
					<col width="26%">
				</colgroup>

				<thead>
					<tr>
						<td colspan="9" style="height:30px;text-align: left;">과제정보</td>
					</tr>
				</thead>

				<tr style="height:40px;text-align: left;" rowspan="2">
					<th>과제기본정보</th>
					<!-- <th>과제번호</th> -->
					<!-- <td></td> -->
					<th>과제명</th>
					<td colspan="3">
						<input type="hidden" id="sjNo" name="sjNo" readonly required msg="과제번호">
						<input type="text" id="sjNm" name="sjNm" msg="과제명">
					</td>

					<th>Ver.</th>
					<td>
						<input type="text" id="verNo" name="verNo" onkeyup="onlyNumber(this)" maxlength="1" readonly>
					</td>

					<th>확정여부</th>
					<td>
						<input type="text" id="closeYn" name="closeYn" readonly="readonly">
					</td>
				</tr>

				<tr>
					<td colspan="9" style="height:8px;text-align: left;"></td>
				</tr>

				<tr style="height:40px;text-align: left;" rowspan="2">
					<th>고객기본정보</th>
					<th  class="hit">SALES CODE</th>
					<td>
						<div class="search_form">
							<input type="text" id="salesCd" name="salesCd" required msg="salesCd">
							<a onclick="wbsSalesCodeSearch('P');"><i class="i_search_w" readonly></i></a>
						</div>
					</td>

					<th>고객사</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd" >
						<input type="text" id="clntNm" name="clntNm" readonly >
					</td>

					<th>제품</th>
					<td>
						<input type="hidden" id="prdtCd" name="prdtCd" >
						<input type="text" id="prdtNm" name="prdtNm" readonly >
					</td>

					<th>차종</th>
					<td>
						<input type="hidden" id="clntPjt" name="clntPjt">
						<input type="text" id="clntPjtNm" name="clntPjtNm" readonly >
					</td>
				</tr>

				<tr>
					<td colspan="9" style="height:8px;text-align: left;"></td>
				</tr>

				<tr  style="height:40px;text-align: left;">
					<th>실행정보</th>
					<th>제작처 구분</th>
					<td>
						<select id="mkerDiv" name="mkerDiv" data-kind="MAKERDIV" class="form-control" onchange="mkerCd.value='';mkerNm.value='';">
						</select>
					</td>

					<th>제작업체</th>
					<td colspan="2">
						<input type="hidden" id="mkerCd" name="mkerCd">
						<div class="search_form" style="width: 100%;">
							<input type="text" id="mkerNm" name="mkerNm" readonly>
							<a onclick="openClntSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<td colspan="1"></td>
					<th>일정예외상황</th>
					<td>
						<select id="planExcept" name="planExcept" data-kind="PLANEXCEPT" class="form-control">
						</select>
					</td>
				</tr>

				<tr>
					<td colspan="9" style="height:8px;text-align: left;"></td>
				</tr>

				<tr style="height:40px;text-align: left;">
					<th>납기정보</th>
					<th class="hit">시작일</th>
					<td>
						<input id="beginDt" name="beginDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="시작일" onchange="dateChk();" date>
					</td>

					<th class="hit">출고일</th>
					<td>
						<input id="deDt" name="deDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="출고일" onchange="dateChk();" date>
					</td>
					<th>설계난이도</th>
					<td>
						<select id="dsgnDifCodeId" name="dsgnDifCodeId" data-kind="DSGNDIF" class="form-control">

						</select>
					</td>

					<th>설계계획공수</th>
					<td>
						<input type="text" class="form-control" id="dsgnPlanHour" name="dsgnPlanHour" onkeyup="onlyNumber(this)" required msg="설계계획공수" value="0">
					</td>

				</tr>

				<tr>
					<td colspan="9" style="height:8px;text-align: left;"></td>
				</tr>

				<tr  style="height:40px;text-align: left;">
					<th>참조정보</th>
					<th class="hit">완료검수일</th>
					<td>
						<input id="acptncDt" name="acptncDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="완료검수일" onchange="dateChk();" date>
					</td>

					<th>소요일수</th>
					<td>
						<input id="reqreDaycnt" name="reqreDaycnt"  required msg="소요일수" readonly >
					</td>

					<th>생산난이도</th>
					<td>
						<select id="prdctnDifCodeId" name="prdctnDifCodeId" data-kind="PRDCTNDIF" class="form-control">

						</select>
					</td>

					<th>생산계획공수</th>
					<td>
						<input type="text" class="form-control" id="prdctnPlanHour" name="prdctnPlanHour" onkeyup="onlyNumber(this)" required msg="생산계획공수" value="0">
					</td>
				</tr>

				<tr>
					<td colspan="9" style="height:8px;text-align: left;"></td>
				</tr>

				<tr>
					<th class="hit">총괄PM</th>
					<td colspan="3">
						<div class="search_form">
							<input type="hidden" id="smrizeId" name="smrizeId" msg="총괄PM"  class="form-control">
							<input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly required msg="총괄PM">
							<a onclick="openUserSearch();"><i class="i_search_w"></i></a>
						</div>
						<td colspan="5"></td>
					</td>
				</tr>

				<tr>
					<tr style="text-align: left;">
						<th>비고<br>(1000자)</th>
						<td colspan="8">
							<textarea id="sjRmk" name="sjRmk"  rows="22" style="width:100%; border:none;outline: none;"></textarea>
						</td>
					</tr>
				</tr>
			</table>
		</form>
    </div>

	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>


	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionBtn" authchk>등록</button>
		<button type="button" class="close_btn" onclick="modalClose();">닫기</button>
	</div>
	<div>
		<br>
		<br>
	</div>
</div>

<script type="text/javascript">
	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];

	var fileTrgtKey = '';
	$(document).ready(function() {
// 		console.log("팝업레뒤");
		setCommonSelect($(".popup_area select[data-kind]"));

// 		$('#sjNm').prop('readonly', true);
		$('#userId').val(jwt.userId);
		//회사 기본값지정
		if(modalStack.last().paramObj.coCd == '' || modalStack.last().paramObj.coCd == undefined) {
			$("#popForm #coCd").val(jwt.coCd);
		} else {
			$("#popForm #coCd").val(modalStack.last().paramObj.coCd);
		}
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;

		$('#beginDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", "today")
		.on("changeDate", function(){
			dateChk();
		});

		$('#deDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker()
		.on("changeDate", function(){
// 			console.log("출고일수정 actionType : " + actionType);
			//완료검수일 같이 바꾸는 건 등록시만
			if (actionType != "U") {
				$('#acptncDt').datepicker("setDate", $('#deDt').val());
			}
			dateChk();
		});

		$('#acptncDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker()
		.on("changeDate", function(){
			dateChk();
		});

		$('#reqreDaycnt').val(calcDate());

		//과제 정보 DB 검색 화면에 표시
		sjDBSearchinfo();

		// ----------------------------------

// 		var param_fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		var param_fileTrgtKey = modalStack.last().paramObj.SJ240613;
		//---------------------------------------------------------------
		//첨부 화일 처리 시작 , 결재승인 버튼처리 기능 포함됨
		//---------------------------------------------------------------
		fileParam = {
				fileTrgtTyp	: "WB2101M02",
				fileTrgtKey : $('#sjNo').val(),
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
		authChk();
	});

	function sjDBSearchinfo () {
		var paramData = {
			"fileTrgtKey" : fileTrgtKey
		};
		postAjaxSync("/user/wb/wb21/selectSjInfo", paramData, null, function(data) {
			// console.log(data.resultList);
			if (data.resultList) {
				$.each(data.resultList, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
// 				console.log(data.resultList);
				//최종버전만 수정이든 뭐든 가능
				if(data.resultList.maxVerNo == data.resultList.verNo) {
					$('.tit').text('과제관리 수정');

					if($('#popForm #closeYn').val() == 'Y') {
						$('#actionBtn').hide();
						$('#confirm').hide();
					} else {
						$('#actionBtn').show();
						$('#actionBtn').text("수정");
						$('#actionBtn').on("click", function() {
							saveSj();
						});
					}
				} else {
					$('.tit').text('과제관리 이력조회');
					$('#actionBtn').hide();
					$('#copyBtn').hide();
					$('#confirm').hide();
					$('#verUp').hide();
				}
			} else {
				var strYear = new Date().toISOString().substring(2, 4);
				var planData = {
					"coCd" : jwt.coCd,
					"year" : "SJ" + strYear
				};
				postAjaxSync("/user/wb/wb21/selectMaxSjNo", planData, null, function(data) {
					$("#sjNo").val(data.result[0].sjNo);
					$("#verNo").val("1");
				});

				$("#actionBtn").text("등록");
				$('#actionBtn').on("click", function() {
					saveSj();
				});
				$('#copyBtn').hide();
				$('#confirm').hide();
				$('#verUp').hide();
			}
		});
		// 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
		var paramObj = {
			"coCd" : $("#popForm #coCd").val(),
			"salesCd" : $("#popForm #salesCd").val(),
		};
		postAjaxSync("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data) {
			if (data.result[0].closeChk == "Y") {
				$('.tit').text('과제관리 이력조회');
				$('#actionBtn').hide();
				$('#copyBtn').hide();
				$('#confirm').hide();
				$('#verUp').hide();
			}
		});
	}

	function modalClose() {
		modalStack.close();
	}

	function makeFormData() {
		var formData = new FormData($("#popForm")[0]);
		if (actionType == "U") {
			formData.append("fileTrgtKey", fileTrgtKey);
		}

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
        formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용

        var fileUploadArr = [];
        var tempArr = [];
        tempArr = treeModule.getFileArr();
        $.each(tempArr, function(idx, obj) {
            if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
            }
        });

        formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
        //---------------------------------------------------------------
        //--첨부화일 처리를 위한 부분 끝
        //---------------------------------------------------------------
		return formData;
	}

	function wbsSjNocopySearch() {
		var paramObj = {};
		paramObj["fileTrgtKey"] = fileTrgtKey;
		paramObj["coCd"] = $("#popForm #coCd").val();
		// paramObj["searchValue"] = $('#smrizeNm').val();
        var tempCode = $("#popForm #salesCd").val();
        paramObj["searchValue"] = tempCode.substring(0,5);
		// paramObj["searchValue"] = $("#popForm #salesCd").val();
        paramObj["pgmId"] = "WB2101M02";
		openSecondModal("/static/html/cmn/modal/wbsSjNocopySearch.html", 1200, 650, "과제 복사대상 검색", paramObj);
	}

	function saveSj() {
		if ($("#closeYn").val() == "Y") {
			alert("확정 상태입니다. 수정 불가합니다.");
			return;
		}

		if (inputValidation($('.popup_area [required]'))) {
			var codeId = null;
			var formData = makeFormData();

			if (actionType == "C") {
				filePostAjax("/user/wb/wb21/sjInsert", formData, function(data) {
					// alert(data.resultMessage);
					if (data.resultCode == 200) {
						var salesCd = $("#popForm #salesCd").val();
						var verNo = $("#popForm #verNo").val();
						gridView.setData(0);
						modalClose();
					}
				});
			} else {
				filePostAjax("/user/wb/wb21/sjUpdate", formData, function(data) {
					// alert(data.resultMessage);
					if (data.resultCode == 200) {
						gridView.setData(0);
						modalClose();
					}
				});
			}
		}
	}

	function confirmY() {
		if (fileTrgtKey == undefined) {
			alert("대상을 선택하세요");
			return false;
		}

		if (parseInt($("#popForm #verNo").val())< parseInt($("#popForm #maxVerNo").val())) {
			alert("상위버전이 존재합니다.");
			return;
		}

		if ($("#popForm #closeYn").val() == "Y") {
			alert("확정된 상태입니다.");
			return;
		}
		if (inputValidation($('.popup_area [required]'))) {
			if(confirm("확정하시겠습니까?")) {
				var formData = new makeFormData();
				let sharManager = (jwt.userId == 'js.nam') ? 'js.nam' : 'ycy'; //공유 또는 결재대상 ycy: 윤치영부장
				formData.append("fileTrgtKey", fileTrgtKey);
				var rowSharngListArr = []; //공유정보
				var rowSharngListObj = {};
				// if (elem.gb == '공유'){
					rowSharngListObj["gb"] = '공유';
					rowSharngListObj["sanCtnSn"] = '1';
					rowSharngListObj["coCd"] = $("#popForm #coCd").val() ;
					rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
					rowSharngListObj["todoDiv2CodeId"] = "TODODIV1110";
					rowSharngListObj["salesCd"] = $("#popForm #salesCd").val();
					rowSharngListObj["pgPath"] = "/user/wb/wb21/WB2101P01.html";
					rowSharngListObj["fileTrgtKey"] = fileTrgtKey;
					rowSharngListObj["reqNo"] = $("#popForm #sjNo").val();
					rowSharngListObj["usrNm"] = sharManager;	//공유 또는 결재대상 ycy: 윤치영부장
					rowSharngListObj["userId"] = jwt.userId;
					rowSharngListObj["pgmId"] = "WB2101P01";
					rowSharngListObj["todoCoCd"] = $("#popForm #coCd").val() ;
					// rowSharngListObj["pgParam"] = modalStack.last().paramObj;
				//TITLE 추가
					rowSharngListObj['todoTitle'] = $("#popForm #salesCd").val() + "과제관리 등록 확인용"
					rowSharngListArr.push(rowSharngListObj);
				// }
				formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));

				filePutAjax("/user/wb/wb21/sjConfirmY", formData, function(data) {
					if(data.resultCode == 200) {
						// alert("확정 되었습니다.");
                        kakaoTodo();
						gridView.setData(0);
						modalClose();
					} else {
						alert("확정 작업 실패했습니다." + data );
					}
				});
			}
		}
	}

	function confirmN() {
		if (fileTrgtKey != undefined) {
			if (parseInt($("#popForm #verNo").val())< parseInt($("#popForm #maxVerNo").val())) {
				alert("상위버전이 존재합니다.");
				return;
			}

			if ($('#closeYn').val() == "N") {
				alert("확정 취소 상태입니다.");
				return;
			}

			if(confirm("확정 취소 하시겠습니까?")) {
				var formData = new FormData();
				formData.append("fileTrgtKey", fileTrgtKey);
				formData.append("userId", $('#userId').val());
				formData.append("pgmId", $('#pgmId').val());
				filePutAjax("/user/wb/wb21/sjConfirmN", formData, function(data) {
					if(data.resultCode == 200) {
						alert("확정 취소 되었습니다.");
						gridView.setData(0);
						modalClose();
					} else {
						alert("확정 취소 작업 실패했습니다." + data );
					}
				});
			}
		} else {
			alert("대상을 선택하세요");
		}
	}

	function createVerUp() {
		if (actionType == "U" && fileTrgtKey == undefined) {
			alert("대상을 선택하세요");
			return;
		}

		if ($("#closeYn").val() == "N") {
			alert("미확정 상태입니다. 신규 버전을 생성할 수 없습니다.");
			return;
		}

		var strYear = new Date().toISOString().substring(2, 4);
		var planData = {
			"coCd" : $("#popForm #coCd").val(),
			"sjNo" : $("#popForm #sjNo").val(),
			"salesCd" : $("#popForm #salesCd").val(),
		};
		var newVerNo;
		var aftCnt;
		var aftText = "";
		postAjaxSync("/user/wb/wb21/selectSjVerNoNext", planData, null, function(data) {
			newVerNo = data.result[0].verNo
			aftCnt = data.result[0].aftCnt
		});

		if(aftCnt > 0) {
			aftText = "\n진행중인 WBS계획이 있습니다!\n버전 변경 시 확정 전까지 일정수정이 불가합니다!";
		}

		if(confirm("버젼 변경을 하시겠습니까?"+aftText)) {
			$("#verNo").val(newVerNo);
// 			if (inputValidation($('.popup_area [required]'))) {
				var codeId = null;
				var formData = makeFormData();
				filePostAjax("/user/wb/wb21/sjVerUpInsert", formData, function(data) {
					alert(data.resultMessage);
					if (data.resultCode == 200) {
						var salesCd = $("#popForm #salesCd").val();
						var verNo = $("#popForm #verNo").val();
						fileTrgtKey = data.fileTrgtKey;
						gridView.setData(0);
						//과제 정보 DB 검색 화면에 표시
						sjDBSearchinfo();
// 						modalClose();
					} else {
						alert("버젼 변경 작업 실패했습니다." + data );
					}
				});
// 			}
		}
	}

	// SALES CODE 검색 팝업. flag 가 S면 기본화면 조회. P면 과제관리 팝업
	function wbsSalesCodeSearch(flag) {
		if(flag != "S" && actionType == "U") {
			alert("SALES CODE는 수정 불가합니다.");
			return;
		}

		var paramObj = {};
		if (flag == "S") {
			paramObj["coCd"] = $('#coCd_S').val();
			paramObj["salesCd"] = $('#salesCd_S').val();
		} else {
			paramObj["coCd"] = $('#coCd_S').val();
			paramObj["salesCd"] = $('#salesCd').val();
		}
		openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			if (flag == "S") {
				$('#salesCd_S').val(row.salesCd);
				gridView.setData(0);
			} else {
// 				console.log(row);
				$('#salesCd').val(row.salesCd);
				$('#clntCd').val(row.ordrsClntCd);
				$('#clntNm').val(row.ordrsClntNm);
				$('#prdtCd').val(row.prdtCd);
				$('#prdtNm').val(row.prdtCdNm);
				$('#clntPjt').val(row.clntPjt);
				$('#clntPjtNm').val(row.clntPjtNm);
				//과제명 = 설비명 적용 후 수정 불가
				$('#sjNm').val(row.eqpNm);
				$('#sjNm').prop('readonly', true);
				// SALES CODE 가 사용되고 있는지 체크
				var paramData = {
					"salesCd" : row.salesCd
				};
				postAjaxSync("/user/wb/wb21/selectSalesCodeCheck", paramData, null, function(data) {
					// console.log(data.result[0].rtnCnt > 0);
					if(data.result[0].rtnCnt > 0) {
						alert("이미 작성된 과제가 있습니다!");
						$('#salesCd_S').val(row.salesCd);
						gridView.setData(0);
						modalClose();
					}
				});
			}
		});
	}

    /*
    #   TODO 알림톡발송 시작
    #
    */
//     $("#approvalReqTodoBtn").on("click", function () {
//        kakaoTodo();
//     });
function kakaoTodo() {

    //message load
    if (kakaoErr.length == 0) {
        var paramObj = {
            "userId" : jwt.userId
            , "codeKind" : "KAKAOMSG"
        };
        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
            if(data.resultList.length > 0 ) {
                kakaoErr = data.resultList;
            }
        });
    }

         //---------------------------------------
       let param = {
             "tmplatDiv"	: "TMPLATDIV02"
             , "title"		: "과제관리 확정"
             , "coCd"		: $("#popForm #coCd").val()            	//해당업무의 coCd(트르넷발주 TRN )
             , "todoNo"		: $("#popForm #sjNo").val()
             , "histNo"		: ''   									//수주등록시 사용
             , "clntCd"		: "1"               					//발신회사는 로그인사용자 회사
             , "clntNm"		: (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷"       //로그의 수신거래처명
             , "creatPgm"  	: "WB2101P01"
			 , "userId" 	: jwt.userId

             , "todoDiv1CodeId"	: "TODODIV10"               //공통코드 해당업무 - 결재
             , "todoDiv2CodeId"	: "TODODIV1110"             //공통코드 해당업무 - 결재 - 발주서
             , "todoDiv1CodeNm"	: "공유"                  	//공통코드 해당업무 - 결재 - 발주서
             , "sanctnDiv2"		: "공유"                     	//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.

       }
       commKaKaoSendTodo(param);  //결재자 전송처리

       if (kakaoCnt > 0) {
           kakaoCnt = 0;
//            alert("알림톡이 정상 발송되었습니다.");
        }
    }

    //to-do결재요청 알림톡
    function commKaKaoSendTodo(param) {
//        console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);

       //알림톡수신번호 채번
       var talkMessage = null             //발송될 내용 template
       var mobile = null               //수신인 휴대전화번호
       var sendList = [];
       let talkParam = {};
       let talkBody = {};
       let sendCnt = 0;
       postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodoNew", param, null
                , function(data) {
                   if(data.resultList.length > 0 ) {
                      if( data.resultList[0].maxMessageId != "" ) {
                         sendList = data.resultList;
                      } else {
                         alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                         return;
                      }

                   }
       });
       //user search ajax end

       //대상 loop
       $.each(sendList, function (key, sendObj) {
          talkMessage = sendObj.messageDesc;
          mobile =  sendObj.telNo;
          if(mobile == "" || mobile == null) {
             alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
             return false;
          }
          if(talkMessage == "" || talkMessage == null) {
             alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
             return false;
          }
          //로그용
          param.rcvId = sendObj.todoId;         	//todo 수신id
          param.rcvNm = sendObj.name;            	//todo 수신자명
          param.nameTo = sendObj.name;            	//todo 수신자명
          param.todoDiv2CodeNm = sendObj.todoTitl;
          param.sendDt = sendObj.sendDt;
          param.ordrgMngNm = sendObj.ordrgMngNm;	 //작성자(담당자)
          param.ordrgMngTelNo = sendObj.ordrgMngTelNo;//담당자전화번호

          //message 치환
          let message = talkMessage;
          let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
          //loop
          $.each(splitStr, function (key, val) {
             let compKey = val.substring(1, val.length-1);
             if( compKey != "" && compKey != "undefined" ) {
                if( typeof(param[compKey]) != "undefined" ) {
                   let val2 = '#'+val;
                   message = message.replaceAll(val2, param[compKey]);
                }
             }
          });

          talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
          talkParam.serverName = "gyitt2400";
          talkParam.paymentType = "P";

          talkBody.service = "2310086157";            	//서비스번호(1000000000 - 예시  real : 2310086157
          talkBody.messageId = sendObj.maxMessageId;    //고객사에서 관리하는 메시지No - 40byte (unique 값으로 건별 번호);
          talkBody.title = param.title;               	//알림톡 타이틀 -
          talkBody.message = message;            		//알림톡 메시지 (1000 byte)
          talkBody.mobile = mobile;            			//휴대전화번호
          talkBody.template = "10003";         			//템플릿관리화면 템플릿ID   - 발주서 V2
          let talkJson = JSON.stringify(talkBody);

          sendCnt = kakaoSendReal(talkJson, talkParam, param);
       });
       //대상 loop end
       if( sendCnt > 0 ) {
          //alert("알림톡 정상 발송되었습니다.");
          kakaoCnt++;
       }
    }


    function dateChk() {
        $('#reqreDaycnt').val(calcDate());
    }

    function calcDate() {
    	let calDay = calculateHolidayCnt($('#beginDt').val(), $('#deDt').val());
    	return calDay.workingDays;
    }

</script>