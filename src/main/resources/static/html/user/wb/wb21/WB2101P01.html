<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit" id="popTit">과제관리 등록</h4>
	</div>
	<input type="file" id="manualFile" style="display:none" onchange="setManualFile(this);"/>

	<div class="popup_table">
		<div class="contents_tit">
			<div class="add_btn_small pdl10">
				<a id="copyBtn" onclick="wbsSjNocopySearch();" style="height: 30px; line-height: 28px; width: 60px;" authchk>복사</a>
				<a id="confirm" onclick="confirmY();" style="height: 30px; line-height: 28px; width: 60px;" authchk>확정</a>
				<!-- <a id="unconfirm" onclick="confirmN();" style="height: 30px; line-height: 28px; width: 60px;">미확정</a> -->
				<a id="verUp" onclick="createVerUp();" style="height: 30px; line-height: 28px; width: 60px;" authchk>Ver.Up</a>
			</div>
		</div>

		<form id="wb21_popForm">
			<input type="hidden" id="coCd"   	name="coCd">
			<input type="hidden" id="userId" 	name="userId">
			<input type="hidden" id="maxVerNo" 	name="maxVerNo">
			<input type="hidden" id="pgmId" 	name="pgmId" value="WB2101P02">
			<input type="hidden" id="fileTrgtKey" 	name="fileTrgtKey">
			<select id="prdMngChk" data-kind="SPECRTS" hidden></select>
			<table class="popup_table">
				<colgroup>
					<col width="15%">
					<col width="16%">
					<col width="22%">
					<col width="15%">
					<col width="24%">
					<col width="14%">
					<col width="23%">
					<col width="15%">
					<col width="26%">
				</colgroup>

				<thead>
					<tr>
						<td colspan="9" style="height:30px;text-align: left;">과제정보</td>
					</tr>
				</thead>

				<tr style="height:40px;text-align: left;" rowspan="2">
					<th>과제기본정보</th>
					<!-- <th>과제번호</th> -->
					<!-- <td></td> -->
					<th>과제명</th>
					<td colspan="3">
						<input type="hidden" id="sjNo" name="sjNo" readonly required msg="과제번호">
						<input type="text" id="sjNm" name="sjNm" msg="과제명" readonly>
					</td>

					<th>Ver.</th>
					<td>
						<input type="text" id="verNo" name="verNo" onkeyup="onlyNumber(this)" maxlength="1" readonly>
					</td>

					<th>확정여부</th>
					<td>
						<input type="text" id="closeYn" name="closeYn" readonly="readonly">
					</td>
				</tr>

				<tr style="height:40px;text-align: left;" rowspan="2">
					<th>고객기본정보</th>
					<th  class="hit">SALES CODE</th>
					<td>
						<div class="search_form">
							<input type="text" id="salesCd" name="salesCd" required msg="salesCd">
							<a onclick="wbsSalesCodeSearch_wb21p();"><i class="i_search_w" readonly></i></a>
						</div>
					</td>

					<th>고객사</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd" >
						<input type="text" id="clntNm" name="clntNm" readonly >
					</td>

					<th>제품</th>
					<td>
						<input type="hidden" id="prdtCd" name="prdtCd" >
						<input type="text" id="prdtNm" name="prdtNm" readonly >
					</td>

					<th>차종</th>
					<td>
						<input type="hidden" id="clntPjt" name="clntPjt">
						<input type="text" id="clntPjtNm" name="clntPjtNm" readonly >
					</td>
				</tr>

				<tr  style="height:40px;text-align: left;">
					<th>실행정보</th>
					<th>제작처 구분</th>
					<td>
						<select id="mkerDiv" name="mkerDiv" data-kind="MAKERDIV" class="form-control" onchange="mkerCd.value='';mkerNm.value='';">
						</select>
					</td>

					<th>제작업체</th>
					<td colspan="2">
						<input type="hidden" id="mkerCd" name="mkerCd">
						<div class="search_form" style="width: 100%;">
							<input type="text" id="mkerNm" name="mkerNm" readonly>
							<a onclick="openClntSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<td colspan="1"></td>
					<th>일정예외상황</th>
					<td>
						<select id="planExcept" name="planExcept" data-kind="PLANEXCEPT" class="form-control" onchange="onPlanExceptChange(this.value)">
						</select>
					</td>
				</tr>

				<tr style="height:40px;text-align: left;">
					<th>납기정보</th>
					<th class="hit">시작일</th>
					<td>
						<input id="beginDt" name="beginDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="시작일" onchange="dateChk();" date>
					</td>

					<th class="hit">출고일</th>
					<td>
						<input id="deDt" name="deDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="출고일" onchange="dateChk();" date>
					</td>
					<th>설계난이도</th>
					<td>
						<select id="dsgnDifCodeId" name="dsgnDifCodeId" data-kind="DSGNDIF" class="form-control">
						</select>
					</td>

					<th>설계계획공수</th>
					<td>
						<input type="text" class="form-control" id="dsgnPlanHour" name="dsgnPlanHour" onkeyup="onlyNumber(this)" required msg="설계계획공수" value="0">
					</td>

				</tr>

				<tr  style="height:40px;text-align: left;">
					<th>참조정보</th>
					<th class="hit">완료검수일</th>
					<td>
						<input id="acptncDt" name="acptncDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="완료검수일" onchange="dateChk();" date>
					</td>

					<th>소요일수</th>
					<td>
						<input id="reqreDaycnt" name="reqreDaycnt"  required msg="소요일수" readonly >
					</td>

					<th>생산난이도</th>
					<td>
						<select id="prdctnDifCodeId" name="prdctnDifCodeId" data-kind="PRDCTNDIF" class="form-control">

						</select>
					</td>

					<th>생산계획공수</th>
					<td>
						<input type="text" class="form-control" id="prdctnPlanHour" name="prdctnPlanHour" onkeyup="onlyNumber(this)" required msg="생산계획공수" value="0">
					</td>
				</tr>

				<tr>
					<th colspan="2" class="hit">매뉴얼대상</th>
					<td>
						<select id="manualYn" name="manualYn" data-kind="YN" class="form-control" required msg="매뉴얼작성대상">
							<option value="" selected>선택</option>
						</select>
					</td>
					<th>기계매뉴얼</th>
					<td colspan="1">
						<div class="manualButton">
							<button type="button" id="manualMcAddButton" class="btn btn-primary btn-sm" style="padding: 0px; height: 24px;">등록</button> 
							<button type="button" id="manualMcRemoveButton" class="btn btn-primary btn-sm" style="padding: 0px; height: 24px; display: none;">삭제</button>
						</div>
					</td>
					<td colspan="4">
						<input type="hidden" id="manualMc" name="manualMc" readonly> 
						<input type="text" id="manualMcFileNm" name="manualMcFileNm" readonly>
					</td>
				</tr>

				<tr>
					<th  colspan="2" class="hit">총괄PM</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="smrizeId" name="smrizeId" msg="총괄PM"  class="form-control">
							<input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly required msg="총괄PM">
							<a onclick="openUserSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>전기매뉴얼</th>
					<td colspan="1">
						<div class="manualButton">
							<button type="button" id="manualElecAddButton" class="btn btn-primary btn-sm" style="padding: 0px; height: 24px;">등록</button> 
							<button type="button" id="manualElecRemoveButton" class="btn btn-primary btn-sm" style="padding: 0px; height: 24px; display: none;">삭제</button></th>
						</div>
					</td>
					<td colspan="4">
						<input type="hidden" id="manualElec" name="manualElec" readonly>
						<input type="text" id="manualElecFileNm" name="manualElecFileNm" readonly>
					</td>
				</tr>
				<thead>
					<tr>
						<td colspan="9" style="height:30px;">
							<div style="display:flex; justify-content:space-between; align-items:center;">
								<div style="display:flex; align-items:center; text-align:left;">
									<span style="margin-right:10px;">▣ 일정계획정보</span>

									<!-- <div id="copyCheckBox">
										<label style="margin-right:10px;">
											<input type="checkbox" id="allPjtYn" class="copyChk" style="vertical-align: middle; margin-right:3px; margin-bottom:4px;"/>프로젝트 전체
										</label>

										<label style="margin-right:10px;">
											<input type="checkbox" id="taskPlanYn" class="copyChk" style="vertical-align: middle; margin-right:3px; margin-bottom:4px;"/>TASK 계획 포함
										</label>
									</div> -->
								</div>
								<div id="addrow1" class="add_btn_small pdl10" style="white-space:nowrap;">
									<a id="btn15" onclick="copyAllPlanPopUp();" style="width:60px;height:30px;line-height:28px;">복사</a>
									<a id="btn1" onclick="wbsLevel1Insert();" style="width:60px;height:30px;line-height:28px;">저장</a>
									<a id="btn2" onclick="updateWbsChanges();" style="width:100px;height:30px;line-height:28px;">변경요청 저장</a>
									<!-- <a id="btn2" onclick="wbsLevel1confirm('N');" data-grid-control="row-add2" style="width:60px;height: 30px; line-height: 28px;">미확정</a> -->
									<a id="btn3" onclick="wbsLevel1confirm('Y');" style="width:60px;height:30px;line-height:28px;">확정</a>
									<a id="btn4" onclick="createWbsPlanVerUp();" style="width:60px;height:30px;line-height:28px;">Ver. Up</a>
								</div>

							</div>
						</td>
					</tr>
				</thead>
				<tr style="text-align: left;">
					<th>계획기본정보</th>
					<th>Ver.</th>
					<td>
						<input type="text" id="wbsPlanVerNo" name="wbsPlanVerNo" readonly>
					</td>
					<td colspan="2">
						<input type="text" id="wbsPlanVerUpReason" name="wbsPlanVerUpReason" readonly>
					</td>
					</td>
					<th style="color: blue;">확정</th>
					<td>
						<input type="hidden" id="wbsPlanCloseYn" name="wbsPlanCloseYn" style="color: blue;" readonly><div id="wbsPlanClose"></div>
					</td>
				</tr>
				<tr>
					<td colspan="9">
						<div class="ax5_grid" data-ax5grid="popup-grid1" data-ax5grid-config="{}" style="height: 445px; width: 100%" ></div>
					</td>
				</tr>
				<tr>
					<tr style="text-align: left;">
						<th>비고<br>(1000자)</th>
						<td colspan="8">
							<textarea id="sjRmk" name="sjRmk" rows="5" style="width:100%; border:none; outline:none; resize:none; overflow:hidden;" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
						</td>
					</tr>
				</tr>
			</table>
		</form>
    </div>

	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>


	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button type="button" id="fileUpBtn" form="wb21_popForm" onclick="fileUpload($(this.form));" authChk>첨부파일저장</button>
		<button id="actionBtn" authchk>등록</button>
		<button type="button" class="close_btn" onclick="modalClose();">닫기</button>
	</div>
	<div>
		<br>
		<br>
	</div>
</div>

<script type="text/javascript">
	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];
	
	var manualFileArr = []; //매뉴얼 첨부파일 정보 임시저장
	var manualFileDeleteArr = []; //매뉴얼 첨부파일 삭제 임시저장
	var manualCall = '';
    var actionType = '';
	var fileTrgtKey = '';
	var originDeDt = '';
	var planVerNo = '';
	var histYn = "N";
	var wbsPlanCodeKind = null;
	var deleteRowArr = [];
	var addRowArr = [];
	var level__index = 0;
	var firstCol = '';
	var firstRow = '';
	var thisGridRow = 0;
	var thisGridCol = 0;
	var teamManagerYnFlag = false;

	ax5.ui.grid.formatter["chkYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
	};

	//---------------------------------------------------
	/*  WBSPLANSTS10	미진행
		WBSPLANSTS20	진행중
		WBSPLANSTS30	지연
		WBSPLANSTS40	지연완료
		WBSPLANSTS50	정상완료 */
	var wbsPlanStsCodeId = [];
	var paramObj = {codeKind : "WBSPLANSTS"};

	postAjaxSync("/user/wb/wb21/selectCodeList", paramObj, null, function(data) {
		wbsPlanStsCodeId = data.resultList;
	});
	//---------------------------------------------------

	const deptByPlanCode = {
		"WBSCODE01" : "GUN30",
		"WBSCODE02" : "GUN30",
		"WBSCODE03" : "GUN40",
		"WBSCODE04" : "TRN50",
		"WBSCODE05" : "GUN60",
		"WBSCODE06" : "TRN50",
		"WBSCODE07" : "GUN60",
		"WBSCODE08" : "GUN60",
		"WBSCODE09" : "GUN30",
		"WBSCODE10" : "GUN30",
		"WBSCODE11" : "GUN30",
		"WBSCODE12" : "GUN30",
		"WBSCODE13" : "GUN30",
		"WBSCODE14" : "GUN30",
		"WBSCODE15" : "GUN30",
		"WBSCODE16" : "GUN30",
		"WBSCODE17" : "TRN50",
		"WBSCODE18" : "GUN30"
	}

	function gridColor(item) {
		let rtnColor = "";
		if (item.wbsPlanMngId == jwt.userId) {
			rtnColor = "grid-row-yellow";
		}
		return rtnColor;
	}

	// 일정관리 권한에 따른 편집가능 여부 체크 함수
	function canEditPlanRow(row) {
		if (!row) return false;

		// 전기 인원은 WBSCODE06(전기완료)만 수정 가능
		const isElectUser = jwt.userId === 'canmtb' || jwt.userId === 'tjswlssky' || jwt.userId === 'famyg80';
		if (isElectUser) {
			return row.wbsPlanCodeId === 'WBSCODE06';
		}

		const sameDeptTeamManager = teamManagerYnFlag && row.deptId && jwt.deptId && row.deptId.slice(0, 5) == jwt.deptId.slice(0, 5);

		// 생산관리 권한
		const prdMngIds = ($('#prdMngChk option').attr('data-etc') || '').replace(/\s/g, '').split(',').filter(Boolean);

		// 시스템관리자, js.nam, ssj: 확정 여부 상관없이 수정 가능
		const privilegedUserAlways =
			jwt.authInfo.includes('AUTH999') ||
			jwt.userId == 'js.nam' ||
			jwt.userId == 'ssj' ||
			prdMngIds.includes(jwt.userId);

		// 총괄PM, 생산관리: 미확정일 때만 수정 가능
		const privilegedUserUnconfirmed =
			$('#smrizeId').val() == jwt.userId;

		const unconfirmed = $("#wbsPlanCloseYn").val() !== "Y";

		// 빈로우에 대한 추가 설정
		const coCd = $("#coCd").val();
		const mappedDeptId = deptByPlanCode[row.wbsPlanCodeId];
		const isTeam01 = jwt.teamManager === "TEAM01";

		const extraAllowedByPlanCode = coCd === "GUN" && mappedDeptId && jwt.deptId && mappedDeptId === jwt.deptId.slice(0, 5) && isTeam01;
		const extraAllowedTRN = coCd === "TRN" && mappedDeptId === "TRN50" && isTeam01;

		return sameDeptTeamManager || privilegedUserAlways || (unconfirmed && privilegedUserUnconfirmed) || extraAllowedByPlanCode || extraAllowedTRN;
	}


	var gridView1 = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
				multipleSelect: false,
				sortable: false,
				target: $('[data-ax5grid="popup-grid1"]'),
				header: {
					align: "center",
					selector: false,
				},
				page : {
					navigationItemCount : 10,
					height : 0,
					use : false,
				},
				body: {
					onClick: function (event, e) {
						this.self.select(this.dindex);
						var idx = this.dindex;
						firstCol = this.colIndex;
						firstRow = this.dindex;

						// 일정관리 미확정일때도 Task 계획 및 실적 조회가능하게 수정 2025-09-22 최지상
						if(histYn == "N") {
							// if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
							// 	if (confirm("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요?")) {
							// 		gridView1.target.select(lastGridView1Rownum);
							// 		return;
							// 	}
							// }
							deleteRowArr = [];
							addRowArr = [];
							
							wbsPlanCodeKind = this.item.wbsPlanCodeId;
							
							// Validation 체크 총괄PM이 아니면 자기담당인TASK만 조회가능
							var smrizeId = $('#smrizeId').val();
							var row = gridView1.target.getList("selected")[0];
							level__index = row.__index;
							// 1. 총괄 PM인 경우 조회만 됨
							//  총괄PM 또는 일정관리 담당자 한동주 가능-->
							// 등록내용은 전체 조회가 되고,  수정권한만 제거 함. 남장섭 231215 확인
							// Validation 체크 - 2레벨 담당자 체크 버튼 보임 처리
							if (row != undefined && row.wbsPlanMngId != jwt.userId && this.item.closeYn != "Y") {
								$("#wb21_popForm #addrow2").hide();
							}else {
								$("#wb21_popForm #addrow2").show();
							}
// 							if(jwt.userId == smrizeId || jwt.userId == 'ycy'){
// 								gridView2.setData(0);
// 							}else if(row != undefined && row.wbsPlanMngId == jwt.userId){
// 								// 2. 자신이 담당자인 TASK 조회
// 								gridView2.setData(0);
// 							}else{
// 								gridView2.setData(0);
// 							}

							// gridView2.setData(0);
						}

					},
					onDBLClick: function () {
						var idx = this.dindex;
						// Validation 체크: 수정 권한 없으면 return
						if (!canEditPlanRow(this.item)) {
							return;
						}

						if (this.column.key=='wbsPlanMngNm') {
							var closeYn = this.item.closeYn;
							var deptId = this.item.deptId;
							var oldMngNm = this.item.wbsPlanMngNm || '';  // 변경 전 담당자명 저장
							var paramObj = {
								"coCd" : coCd,
								"userId": '',
								"useYn": "Y"
							};
							openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "담당자 검색", paramObj, function (tree){
								var row = gridView1.target.getList("selected")[0];
								var isElectPlanAllower = row.wbsPlanCodeId === 'WBSCODE06' && (jwt.userId === 'canmtb' || jwt.userId === 'tjswlssky' || jwt.userId === 'famyg80');
								var checkedId = tree.get_checked()[0];
								var checkedNode = tree.get_node(checkedId);

								// 확정일 때만 부서 체크, 총괄PM/생산관리/시스템관리자는 부서 제한 없음
								var prdMngIds = ($('#prdMngChk option').attr('data-etc') || '').replace(/\s/g, '').split(',').filter(Boolean);
								var isPrivilegedUser = $('#smrizeId').val() == jwt.userId || prdMngIds.includes(jwt.userId) || jwt.authInfo.includes('AUTH999') || jwt.userId == 'js.nam' || jwt.userId == 'ssj';

								if (closeYn == "Y" && !isPrivilegedUser && jwt.deptId.slice(0, 5) !== checkedNode.original.parent.slice(0, 5)) {
									customAlert("같은 부서원만 선택 가능합니다.");
									return false;
								}
																
								var newMngNm = checkedNode.text;  // 변경 후 담당자명

								gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngId : checkedNode.id}), idx);
								gridView1.target.updateRow($.extend({}, gridView1.target.list[idx], {wbsPlanMngNm : newMngNm}), idx);

								// 미확정일 때 저장버튼 표시
								if (closeYn !== "Y") {
									$("#wb21_popForm #btn1").show();
								}

								// 권한 있는 사용자가 담당자를 변경한 경우 저장 처리 (확정일 때)
								if (closeYn == "Y" && canEditPlanRow(row)) {
									if (oldMngNm !== newMngNm) {
										updateWbsPlan(idx, 'mngId', { oldValue: oldMngNm, newValue: newMngNm });
									} else {
										wbsLevel1Insert();
									}
								}
							});
						} else if (this.column.key=='wbsPlansDt' || this.column.key=='wbsPlaneDt') {
							
						}

					},
					onDataChanged: function (param) {
						var that = this;
						var oldValue = this.before;  // 변경 전 값
						var newValue = this.value;   // 변경 후 값

						//하나라도 수정되면 저장버튼 활성화,
						//   setValue는 onDataChanged 이벤트 없음.--> 해당함수에서 처리해야함

						// 버튼 표시 로직 (과제 확정 시에만 동작)
						if ($('#wb21_popForm #closeYn').val() == "Y") {
							if (this.key == "chgReason") {
								$("#wb21_popForm #btn2").show();
							} else if (this.item.closeYn != "Y") {
								$("#wb21_popForm #btn1").show();
							}
						}

						const fDate = new Date(this.item.wbsPlansDt);
						const tDate = new Date(this.item.wbsPlaneDt);

						//시작일
						const beginDt = new Date($('#beginDt').val());
						//완료검수일
						const acptncDt = new Date($('#acptncDt').val());

						//1. 시작일자가 시작일 이전이면 안됨
// 						if(this.item.wbsPlansDt != undefined && fDate < beginDt){
// 							alert("시작일자는 시작일 이전 일 수 없습니다.");
// 							this.self.setValue(this.dindex, "wbsPlaneDt", null);
// 							return false;
// 						}

						//2. 종료일자가 완료검수일 이후면 안됨
// 						if(this.item.wbsPlaneDt != undefined && tDate > acptncDt){
// 							alert("종료일자는 완료검수일 이후 일 수 없습니다.");
// 							this.self.setValue(this.dindex, "wbsPlaneDt", null);
// 							return false;
// 						}

						//3. 시작일자는 종료일자 이후일 수 없다.
// 						if(this.item.wbsPlansDt != undefined && this.item.wbsPlaneDt != undefined && fDate > tDate) {
// 							// alert("시작일자는 종료일자 이후 일 수 없습니다.");
// 							let dtSelect = confirm("시작일자는 종료일자 이후 일 수 없습니다.");
// 							if (dtSelect) {
// 								//확인이면 종료일자를 시작일자로 설정
// 								this.self.setValue(this.dindex, "wbsPlaneDt", this.item.wbsPlansDt);
// 							} else {
// 								this.self.setValue(this.dindex, "wbsPlansDt", null);
// 							}
// 							return false;
// 						}

						if((this.key === 'wbsPlansDt' || this.key === 'wbsPlaneDt') && this.item.wbsPlansDt != undefined && this.item.wbsPlaneDt != undefined){
							this.self.setValue(this.dindex, "daycnt", calculateCalendarCnt(this.item.wbsPlansDt, this.item.wbsPlaneDt));
						}

						// 확정일 때 권한 있는 사용자가 시작일자/종료일자를 변경한 경우 자동 저장 처리
						if (this.item.closeYn == "Y" && canEditPlanRow(this.item)) {
							if ((this.key === 'wbsPlansDt' || this.key === 'wbsPlaneDt') && oldValue !== newValue) {
								updateWbsPlan(this.dindex, 'date', null);
							}
						}

						// if ($("#allPjtYn").is(":checked") && (this.key === "wbsPlanMngId" || this.key === "wbsPlansDt" || this.key === "wbsPlaneDt")) {
						// 	this.self.setValue(this.dindex, "allPjtYn", "Y");
						// }
						// if ($("#taskPlanYn").is(":checked") && (this.key === "wbsPlanMngId" || this.key === "wbsPlansDt" || this.key === "wbsPlaneDt")) {
						// 	this.self.setValue(this.dindex, "taskPlanYn", "Y");
						// }

						// //  // 담당자 ID, 시작일자, 종료일자 변경시
						// if (this.item.taskPlanYn == "Y" && (this.key == "wbsPlanMngId" || this.key == "wbsPlansDt" || this.key == "wbsPlaneDt")) {
						// 	chkRsltsExist(this.item);
						// }
					},
				},
				contextMenu: {
					iconWidth: 20,
					acceleratorWidth: 100,
					itemClickAndClose: false,
					icons: {
						'arrow': '<i class="fa fa-caret-right"></i>'
					},
					items: [
						{type: 1, label: "붙여넣기"},
						{divide: true},
						{type: 1, label: "내용삭제"},
					],
					popupFilter: function (item, param) {

						// 우클릭 컨텐츠박스 권한에 따른 제어
						// 1. 팀장이면서 해당 계획에 담당자 또는 같은 부서의 직원의 계획이면 변경 붙여넣기 및 내용삭제 가능
						// 2. 전기완료 계획인 경우 한동주, 오선진 제어 가능하게 (deptId로 제어함)
						// 3. 총괄PM, 생산관리담당자, 시스템관리자(AUTH999) 이면 붙여넣기 및 내용삭제 가능
						// 4. 위 조건에 해당하지 않으면 붙여넣기 및 내용삭제 방지
						const selectedRow = gridView1.target.list[param.dindex];
						if (teamManagerYnFlag && (selectedRow.wbsPlanMngId == jwt.userId || selectedRow.deptId.slice(0,5) == jwt.deptId.slice(0,5))) {
							return true;
						} else if (selectedRow.wbsPlanCodeId == 'WBSCODE06' && (jwt.deptId =='TRN5020' || jwt.deptId =='TRN5040')) {
							return true;
						} else if ($('#smrizeId').val() == jwt.userId || $('#prdMngChk option').attr('data-etc').replace(/\s/g,'').split(',').includes(jwt.userId) || jwt.authInfo.includes('AUTH999') ) {
							return true;
						} else {
							return false;
						}
						//console.log(item, param);
						if (param.element) {
							return true;
						} else {
							return item.type == 1;
						}
					},
					onClick: function (item, param, e) {
// 						console.log("contextMenu onPaste");
						//하나라도 수정되면 저장버튼 활성화 (미확정일 때만)
						var row = gridView1.target.list[param.dindex];
						if (row && row.closeYn !== "Y") {
							$("#wb21_popForm #btn1").show();  //저장버튼
						}
						thisGridRow = param.dindex;
						thisGridCol = param.colIndex;

						if (item.label == "붙여넣기") {
							gridPaste(gridView1.target, thisGridRow, thisGridCol);
						} else if (item.label == "내용삭제") {
							var row = gridView1.target.list[thisGridRow];
							// DB에 저장된 적 없는 경우 (최초 등록 상태) 그리드 값만 초기화
							if (!row.fileTrgtKey || !row.verNo) {
								gridView1.target.setValue(thisGridRow, 'wbsPlanMngId', '');
								gridView1.target.setValue(thisGridRow, 'wbsPlanMngNm', '');
								gridView1.target.setValue(thisGridRow, 'wbsPlansDt', '');
								gridView1.target.setValue(thisGridRow, 'wbsPlaneDt', '');
								gridView1.target.setValue(thisGridRow, 'daycnt', '');
								$("#wb21_popForm #btn1").show(); // 저장버튼 표시
							} else {
								// DB에 저장된 경우 버전업 처리
								updateWbsPlan(thisGridRow, 'delete', null);
							}
						}
						gridView1.target.contextMenu.close();
					}
				},
				columns: [
					{key: "rn",            label: "No."				,    align: "center",   width: 40},
					{key: "fileTrgtKey",   label: "FILE TRGT KEY"	,    hidden:true},
					{key: "coCd",          label: "회사"				,    hidden:true},
					{key: "salesCd",       label: "SALES CODE"		,    hidden:true},
					{key: "wbsPlanNo",     label: "계획번호"			,    hidden:true},
					{key: "wbsPlanCodeId", label: "계획코드"			,    hidden:true},
					{key: "wbsCodeDesc",   label: "코드설명"			,    hidden:true},
					{key: "verNo",         label: "Ver."			,    align: "center",   width: 100,      hidden: true},
					{key: "wbsPlanCodeNm", label: "계획명"			,    align: "left",   width: 170, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlanMngId",  label: "담당자 ID"			,    align: "center",   width: 80, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlanMngNm",  label: "<span style='color: red;'>*</span>담당자명",    align: "center",   width: 80, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlansDt",    label: "<span style='color: red;'>*</span>시작일자",      align: "center",   width: 120,
						editor: {type: "date", config: { content: { config: { mode: "day", selectMode: "day" } } },
						disabled: function () { return !canEditPlanRow(this.item); }, }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "wbsPlaneDt",    label: "<span style='color: red;'>*</span>종료일자",      align: "center",   width: 120,
						editor: { type: "date", config: { content: { config: { mode: "day", selectMode: "day" }, } },
						disabled: function () { return !canEditPlanRow(this.item); }, }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "daycnt",  label: "소요일수",    align: "center",   width: 80,  
						formatter: function () {
							const n = Number(this.value);
							return Number.isFinite(n) ? String(n) : "0";
						},
						styleClass: function () {return gridColor(this.item);}},
					{key: "rsltssDt", label: "<span style='color: #0000FF;'>실적시작일</span>", align: "center", width: 120,
						formatter: function () { return '<div style="color: #0000FF">' + (this.value||'') + '</div>'; }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "rsltseDt", label: "<span style='color: #0000FF;'>실적종료일</span>", align: "center", width: 120,
						formatter: function () { return '<div style="color: #0000FF">' + (this.value||'') + '</div>'; }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "rsltDaycnt",  label: "<span style='color: #0000FF;'>실적소요일수</span>",    align: "center",   width: 80 ,
						formatter: function () { return '<div style="color: #0000FF">' + (calculateCalendarCnt(this.item.rsltssDt, this.item.rsltseDt)||'') + '</div>'; }
						, styleClass: function () {return gridColor(this.item);}},
					{key: "chgReason",    label: "변경사유",   	   width: "*", align: "center", editor: {type: "text"}},
					{key: "closeYn",      label: "확정"			,  width: 80, align: "center" , formatter: "chkYn",      hidden: true},
					{key: "wbsPlanStsCodeIdNm"					,  hidden: true},
					{key: "creatId",      label: "생성자"			,  hidden: true},
					{key: "creatNm",      label: "생성자명"		,  hidden: true},
					{key: "creatDttm",    label: "생성일시"		,  hidden: true},
					{key: "udtId",        label: "최종변경자"		,  hidden: true},
					{key: "udtNm",        label: "최종변경자명"		,  hidden: true},
					{key: "udtDttm",      label: "최종변경일자"		,  hidden: true},
					{key: "levelNm",      label: "직급"		,  hidden: true},
					{key: "allPjtYn",     label: "프로젝트 전체"      ,  hidden: true},
					{key: "taskPlanYn",   label: "Task계획 포함"      ,  hidden: true},
					{key: "rsltDete",     label: "실적삭제여부"      ,  hidden: true}
				]
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			var formData = {
				"coCd" : $("#wb21_popForm #coCd").val(),
				"salesCd" : $("#wb21_popForm #salesCd").val(),
				"beginDt" : $("#wb21_popForm #beginDt").val(),
				"acptncDt" : $("#wb21_popForm #acptncDt").val(),
				"reqreDaycnt" : $("#wb21_popForm #reqreDaycnt").val(),
				"planVerNo" : $("#wb21_popForm #wbsPlanVerNo").val(),
				"userId" :  $("#wb21_popForm #smrizeId").val(),
				"histYn" : 'N'
			}
			var ajaxUrl;
			if(histYn == "N"){
				ajaxUrl = "/user/wb/wb22/selectWBS1Level";
			}else{
				ajaxUrl = "/user/wb/wb22/selectHistWBS1Level";

				$('.tit').text('과제관리 이력조회');
				$('#actionBtn').hide();
				$("#wb21_popForm #addrow1").hide();
				$("#wb21_popForm #addrow2").hide();
			}
			postAjax(ajaxUrl, formData, null, function(data){
				try {
					var list = data.fileList;
					var i = 0;
					if (list != undefined) {
						$.each(list, function(idx, obj){
							obj.allPjtYn = "N";
							obj.taskPlanYn = "N";
							list[i].daycnt = calculateCalendarCnt (obj.wbsPlansDt, obj.wbsPlaneDt);
							if(i == 0){
	// 							console.log(list[i]);
								var ver = list[i].verNo;
								var reason = list[i].verUpReason;
								$("#wb21_popForm #wbsPlanVerNo").val(ver);
								$("#wb21_popForm #wbsPlanVerUpReason").val(reason);
								
								var val2 = list[i].closeYn;
								// 확정/Ver.Up 버튼 권한 체크
								var prdMngIds = ($('#wb21_popForm #prdMngChk option').attr('data-etc') || '').replace(/\s/g,'').split(',').filter(Boolean);
								var isElectUser = jwt.userId === 'canmtb' || jwt.userId === 'tjswlssky' || jwt.userId === 'famyg80';
								var hasConfirmPermission = !isElectUser && ($('#smrizeId').val() == jwt.userId || prdMngIds.includes(jwt.userId) || jwt.authInfo.includes('AUTH999') || jwt.userId == 'js.nam' || jwt.userId == 'ssj');

								if (val2 == "Y") {
									if (hasConfirmPermission) {
										$("#wb21_popForm #btn4").show();  //Ver.Up버튼
									}
									$("#wb21_popForm #btn3").hide();  //확정버튼
									$("#wb21_popForm #btn1").hide();  //저장버튼
									$("#wb21_popForm #btn2").hide();  //변경요청 저장버튼
								} else {
									$("#wb21_popForm #btn4").hide();
									// 과제 확정 시에만 일정 버튼 표시
									if ($('#wb21_popForm #closeYn').val() == "Y") {
										if (hasConfirmPermission) {
											$("#wb21_popForm #btn3").show();  //확정버튼
										}
										$("#wb21_popForm #btn1").hide();  //저장버튼 기본 숨김 (수정 시 표시)
										$("#wb21_popForm #btn2").hide();  //변경요청 저장 기본 숨김
									}
									$("#wb21_popForm #addrow2").hide();	// 일정미확정일경우 Task 버튼영역 숨김
								}
								$("#wb21_popForm #wbsPlanCloseYn").val(val2);
								var color2 = val2 == "Y" ? "color-circle_02.png" : "color-circle_01.png";
								var html2 = '<img src="/static/img/'+color2+'" align="center" style="width: 10px;height: 10px;"></img>';
								$("#wb21_popForm #wbsPlanClose").html(html2);
								
							    // if (val2 === 'Y') {
							    //     $('#planExcept').hide();        // select 숨김
							    //     $('#planExceptNm').show();      // input 표시
							    // } else if (val2 === 'N') {
							    //     $('#planExcept').show();        // select 표시
							    //     $('#planExceptNm').hide();      // input 숨김
							    // }
								
							}
							i++;
						});
						targetObj.setData({
							list : list,
							page : {
								// totalElements : list.length
							}
						});

						gridView1.target.select(level__index, {selected: true});
					}
				} catch (error) {
					alert("오류 발생!! 전산실 연락 바랍니다", error.message);
					return null; // 오류 발생 시 null 반환
				} finally {
					// console.log("함수 실행 완료.");
				}
			});
			// Validation 체크 - 확정버튼 권한
			var smrizeId = $('#wb21_popForm #smrizeId').val();
			var prdMngIds = ($('#prdMngChk option').attr('data-etc') || '').replace(/\s/g,'').split(',').filter(Boolean);
			var isElectUser = jwt.userId === 'canmtb' || jwt.userId === 'tjswlssky' || jwt.userId === 'famyg80';
			var hasConfirmPermission = !isElectUser && (smrizeId == jwt.userId || prdMngIds.includes(jwt.userId) || jwt.authInfo.includes('AUTH999') || jwt.userId == 'js.nam' || jwt.userId == 'ssj');
			
			// 일정 계획 버튼 표시 로직
			if ($('#wb21_popForm #closeYn').val() == "Y") {
				if(hasConfirmPermission){
					$("#wb21_popForm #btn15").show(); // 복사
					$("#wb21_popForm #btn3").show();  // 확정
					$("#wb21_popForm #btn4").show();  // Ver.Up
				} else {
					$("#wb21_popForm #btn15").hide();
					$("#wb21_popForm #btn3").hide();
					$("#wb21_popForm #btn4").hide();
				}
			} else {
				// 과제가 확정되지 않은 경우 모든 일정 계획 버튼 숨김 (저장버튼은 예외)
				$("#wb21_popForm #btn15").hide();
				$("#wb21_popForm #btn1").show(); // 미확정 시에도 저장 가능하도록 수정
				$("#wb21_popForm #btn2").hide();
				$("#wb21_popForm #btn3").hide();
				$("#wb21_popForm #btn4").hide();
			}
		}
	}


	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));

		$("#wb21_popForm #fileUpBtn").hide(); //첨부파일 저장버튼 숨김
// 		$('#sjNm').prop('readonly', true);
		$('#wb21_popForm #userId').val(jwt.userId);
		//회사 기본값지정
		if(modalStack.last().paramObj.coCd == '' || modalStack.last().paramObj.coCd == undefined) {
			$("#wb21_popForm #coCd").val(jwt.coCd);
		} else {
			$("#wb21_popForm #coCd").val(modalStack.last().paramObj.coCd);
		}
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		if(modalStack.last().paramObj.actionType == '' || modalStack.last().paramObj.actionType == undefined) {
			actionType = 'U';
		} else {
			actionType = modalStack.last().paramObj.actionType;
		}
		$('#wb21_popForm #beginDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", "today")
		.on("changeDate", function(){
			dateChk();
		});

		$('#wb21_popForm #deDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker()
		.on("changeDate", function(){
			//완료검수일 같이 바꾸는 건 등록시만
			if (actionType != "U") {
				$('#wb21_popForm #acptncDt').datepicker("setDate", $('#wb21_popForm #deDt').val());
			}
			dateChk();
		});

		$('#wb21_popForm #acptncDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker()
		.on("changeDate", function(){
			dateChk();
		});

		$('#wb21_popForm #reqreDaycnt').val(calcDate());

		//과제 정보 DB 검색 화면에 표시
		sjDBSearchinfo();

		// ----------------------------------

		$('#wb21_popForm #manualYn').on("change", function(){
			if ($('#wb21_popForm #manualYn').val() == 'Y' && actionType != 'C') {
				$('.popup_area .manualButton').show();
			} else {
				$('.popup_area .manualButton').hide();
			}
		});

		// 출고일 변경에 따른 일정관리에 등록된 과제정보 체크
		$('#wb21_popForm #deDt').on("change", function(){
			deDtChangChk();
		});

		if (actionType == 'C') {
			$('.manualButton').hide();
		}
		
		$('#wb21_popForm #manualMcAddButton, #manualMcRemoveButton, #manualElecAddButton, #manualElecRemoveButton').on("click", function(){
			if (this.id == "manualMcAddButton") {	//기계 매뉴얼 등록 수정
				manualCall = 'manualMc';
				if ($('#wb21_popForm #manualMcAddButton').text() =="변경") {
					//이전에 등록된 파일은 삭제하고변경된 파일은 다시 등록해야함.
				}
				//파일 등록처리하면됨
				manualFile.click();
			} else if (this.id == "manualMcRemoveButton") {	//기계 매뉴얼 삭제
				manualCall = 'manualMc';
				//이전에 등록된 매뉴얼 파일을 삭제처리함
				deleteManualFile('manualMc');
				$('.popup_area #manualMcRemoveButton').hide();
			} else if (this.id == "manualElecAddButton") {		//전기 매뉴얼 등록 수정
				manualCall = 'manualElec';
				if ($('.popup_area #manualElecAddButton').text() =="변경") {
					//이전에 등록된 파일은 삭제하고변경된 파일은 다시 등록해야함
				}
				//파일 등록처리하면됨
				manualFile.click();
			} else if (this.id == "manualElecRemoveButton") {	//전기 매뉴얼 삭제
				//이전에 등록된 매뉴얼 파일을 삭제처리함
				manualCall = 'manualElec';
				deleteManualFile('manualElec');
				$('.popup_area #manualElecRemoveButton').hide();
			}
		});
		//---------------------------------------------------------------
		//첨부 화일 처리 시작 , 결재승인 버튼처리 기능 포함됨
		//---------------------------------------------------------------
		fileParam = {
				fileTrgtTyp	: "WB2101P02",
				fileTrgtKey : $('#wb21_popForm #fileTrgtKey').val(),
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		gridView1.initView().setData(0);

		authChk();
	});

	
	
	function setManualFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
	        var file = obj;
				var testArr = file.name.split(".");
// 				manualFileArr.push({
// 					'manualNo' 		: $('#salesCd').val(),
// 					'manualTypes' 	: manualCall,
// 					'updCheck' 		: 'C',
// 					'fileKey' 		: '0',
// 			      	'fileName' 		: file.name,
// 			      	'fileType' 		: testArr[testArr.length-1],
// 			      	'fileSize' 		: file.size,
// 			      	'file' 			: file,
// 			      	'fileDelete'	: 'Y'
// 				});
				let tempFileName = $('#wb21_popForm #' + manualCall + 'FileNm').val();
				let tempFileKey = $('#wb21_popForm #' + manualCall).val();
				if (tempFileName != "" && tempFileKey != '' && tempFileKey != '0') {	//수정이면서 기존 파일명이 있고 파일 등록된 번호가 있을경우만 파일 삭제대상임 
					manualFileDeleteArr.push({
						fileKey 	: tempFileKey,
						fileName 	: tempFileName
					});
				}
				$('#wb21_popForm #' + manualCall).val('0');
				$('#wb21_popForm #' + manualCall + 'FileNm').val(file.name);
				$('#wb21_popForm #' + manualCall + 'FileNm').removeAttr('onclick');
				
				$('.popup_area #' + manualCall + 'RemoveButton').show();
				$('.popup_area #' + manualCall + 'AddButton').text("변경");
		});
		//백엔스 Ajax Call 파일 업로드 처리할것
		var formData = manualMakeFormData();
		formData.append("files", tempFiles[0]);
		formData.append("manualCall", manualCall);
		formData.append("attchFileName", $('#wb21_popForm #' + manualCall + 'FileNm').val());
		filePostAjax("/user/wb/wb21/updateSalesCdManual", formData,function(data) {
			if (data.resultCode == 200) {
				//정상처리 완료
				$('#wb21_popForm #'+ data.manualCall).val(data.fileKey);
				if (typeof workGridView !== 'undefined') workGridView.setData();  //데시보드 완료예정업무 list 갱신
				if (typeof gridView !== 'undefined') gridView.setData();  //메인화면 그리드 list 갱신
			} else {
				alert("매뉴얼 등록에 문제가 발행했습니다. 전산실 확인 바랍니다.");
			}
		});
		
		$(elem).val("");
	}

	
	function deleteManualFile(manualTypes){
// 		const nameArea = ['manualMc','manualElec'];
		let tempFileName = $('#wb21_popForm #'+ manualTypes + 'FileNm').val();
		let tempFileKey = $('#wb21_popForm #'+ manualTypes).val();
		if (tempFileName != "" && tempFileKey != 0) {	//수정이면서 기존 파일명이 있고 파일 등록된 번호가 있을경우만 파일 삭제대상임 
			manualFileDeleteArr.push({
				manualTypes : manualTypes,
				updCheck 	: 'D',
				fileKey 	: tempFileKey,
				fileName 	: tempFileName
			});
			//백엔스 Ajax Call 파일 삭제 처리할것
			var formData = manualMakeFormData();
			formData.append("manualCall", manualCall);
			filePostAjax("/user/wb/wb21/deleteSalesCdManual", formData,function(data) {
				if (data.resultCode == 200) {
					//정상처리 완료
					$('#wb21_popForm #'+ manualTypes).val('');
					$('#wb21_popForm #'+ manualTypes + 'FileNm').val('');
					$('#wb21_popForm #'+ manualTypes + 'FileNm').removeAttr('onclick');
					
					$('.popup_area #'+ manualTypes + 'RemoveButton').hide();
					$('.popup_area #'+ manualTypes + 'AddButton').text("등록");
					if (typeof workGridView !== 'undefined') workGridView.setData();  //데시보드 완료예정업무 list 갱신
					if (typeof gridView !== 'undefined') gridView.setData();  //메인화면 그리드 list 갱신
				} else {
					alert("매뉴얼 삭제 처리에 문제가 발행했습니다. 전산실 확인 바랍니다.");
				}
			});
			
		}
	}
	


	function manualMakeFormData() {
		var formData = new FormData($("#wb21_popForm")[0]);
		
		formData.append("fileTrgtKey", fileTrgtKey);

		//---------------------------------------------------------------
		//-------매뉴얼  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("prdtCd", $('#wb21_popForm #prdtCd').val());
		formData.append("prjctCd", $('#wb21_popForm #clntPjt').val());
        formData.append("comonCd", "FITR0203"); //영엄->매뉴얼 폴더에 첨부화일 추가
        formData.append("uploadFileArr", JSON.stringify(manualFileArr));
        formData.append("deleteFileArr", JSON.stringify(manualFileDeleteArr));

        manualFileArr = [];
        manualFileDeleteArr =[];
        //---------------------------------------------------------------
        //--매뉴얼 첨부화일 처리를 위한 부분 끝
        //---------------------------------------------------------------
		return formData;
	}
	
	
	//다운로드 하기
	// function downloadManualFile(manualTypes) {
	//   	let fileKey = $('#wb21_popForm #' + manualTypes).val();
	//     var host = window.location.origin;
	//     location.href = "/admin/cm/cm08/fileDownloadAuth2?fileKey="+fileKey+"&userId="+jwt.userId;
	// }

	function downloadManualFile(_fileKey, _filename) {
		return new Promise(function(resolve, reject) {
			var xhr = new XMLHttpRequest();
			xhr.open("GET", "/admin/cm/cm08/fileDownloadAuth2?fileKey=" + _fileKey + "&userId=" + jwt.userId + "&coCd=" + $('#coCd').val(), true);
			xhr.responseType = "blob";
			xhr.setRequestHeader("Authorization", authorizationToken);
			xhr.setRequestHeader("X-GBS-Source", "pdfjs-viewer");
			
			xhr.onload = function() {
				if (xhr.status === 200) {
					var contentType = xhr.getResponseHeader("Content-Type");
					// 오류 상황: Content-Type이 text/plain이면 서버가 오류 메시지를 반환한 것으로 간주
					if (contentType && contentType.indexOf("text/plain") !== -1) {
						var reader = new FileReader();
						reader.onload = function(e) {
							// reject 시, 파일명과 함께 오류 메시지 전달
							reject("[" + _filename + "] " + e.target.result);
						};
						reader.readAsText(xhr.response);
					} else {
						// 정상적인 파일이면 다운로드 진행
						var blob = xhr.response;
						var url = window.URL.createObjectURL(blob);
						var a = document.createElement('a');
						a.href = url;
						a.download = _filename;
						document.body.appendChild(a);
						a.click();
						document.body.removeChild(a);
						window.URL.revokeObjectURL(url);
						resolve(); // 성공 시 resolve 호출
					}
				} else {
					console.error("백엔드 오류 발생: " + xhr.status + " - " + xhr.statusText);
					reject("[" + _filename + "] 백엔드 오류 발생: " + xhr.status + " - " + xhr.statusText);
				}
			};

			xhr.onerror = function() {
				console.error("네트워크 오류가 발생했습니다.");
				reject("[" + _filename + "] 네트워크 오류가 발생했습니다.");
			};

			xhr.send();
		});
	}

	
	
	function sjDBSearchinfo () {
		var paramData = {
			"fileTrgtKey" : fileTrgtKey
		};
		postAjaxSync("/user/wb/wb21/selectSjInfo", paramData, null, function(data) {
	        const checkDateKeys = ['beginDt', 'deDt', 'acptncDt'];
			if (data.resultList) {
				$.each(data.resultList, function(key, value) {
	                if (checkDateKeys.includes(key)) {
	                    $('#wb21_popForm #' + key).datepicker('setDate', value);
	                } else 
					if ($('#wb21_popForm #' + key)[0]) {
						$('#wb21_popForm #' + key).val(value);
						if ($('#wb21_popForm #' + key).is('[comma]')) {
							onlyNumber($('#wb21_popForm #' + key)[0]);
						}
						// 비고란 자동 높이 조절 트리거
						if (key === 'sjRmk') {
							$('#wb21_popForm #sjRmk').trigger('input');
						}
					}
				});
				originDeDt = data.resultList.deDt; // 원래 날짜 정보 저장
				//최종버전만 수정이든 뭐든 가능
				if(data.resultList.maxVerNo == data.resultList.verNo) {
					$('.tit').text('과제관리 수정');
					if($('#wb21_popForm #closeYn').val() == 'Y') {
						$('.popup_area #actionBtn').hide();
						$('#confirm').hide();
						$('.popup_area #fileUpBtn').show();
					} else {
						$('.popup_area #actionBtn').show();
						$('.popup_area #fileUpBtn').hide();
						$('.popup_area #actionBtn').text("수정");
						$('.popup_area #actionBtn').on("click", function() {
							saveSj();
						});
					}
				} else {
					$('.popup_area .tit').text('과제관리 이력조회');
					$('.popup_area #actionBtn').hide();
					$('.popup_area #copyBtn').hide();
					$('.popup_area #confirm').hide();
					$('.popup_area #verUp').hide();
				}
				
				// if (data.resultList.manualYn !== 'Y') {
				//     $('.manualButton').hide();
				// } else {
				//     const manualTypes = [
				//         { key: 'manualMc', addButton: '#manualMcAddButton', removeButton: '#manualMcRemoveButton', fileName: '#manualMcFileNm' },
				//         { key: 'manualElec', addButton: '#manualElecAddButton', removeButton: '#manualElecRemoveButton', fileName: '#manualElecFileNm' }
				//     ];

				//     manualTypes.forEach(({ key, addButton, removeButton, fileName }) => {
				//         if (data.resultList[key]) {
				//             $('#wb21_popForm ' + addButton).text("변경");
				//             $('#wb21_popForm ' + removeButton).show();
				//             $('#wb21_popForm ' + fileName).on('click', () => downloadManualFile(key));
				//         }
				//     });
				// }
				if (data.resultList.manualYn !== 'Y'|| actionType == 'C') {
					$('.manualButton').hide();
				} else {
					['manualMc','manualElec'].forEach(key => {
						const keyField = data.resultList[key];
						const nameField = data.resultList[key + 'FileNm'];
						if (keyField) {
							$('#wb21_popForm #' + key + 'FileNm')
								.val(nameField)
								.attr('onclick', "downloadManualFile(" + keyField + ", '" + nameField + "')")
								.css('cursor','pointer');
							$('#wb21_popForm #' + key + 'AddButton').text("변경");
							$('#wb21_popForm #' + key + 'RemoveButton').show();
						}
					});
				}
			} else {
				var strYear = new Date().toISOString().substring(2, 4);
				var planData = {
					"coCd" : jwt.coCd,
					"year" : "SJ" + strYear
				};
				postAjaxSync("/user/wb/wb21/selectMaxSjNo", planData, null, function(data) {
					$("#wb21_popForm #sjNo").val(data.result[0].sjNo);
					$("#wb21_popForm #verNo").val("1");
				});

				$(".popup_area #actionBtn").text("등록");
				$('.popup_area #actionBtn').on("click", function() {
					saveSj();
				});
				$('.popup_area #copyBtn').hide();
				$('.popup_area #confirm').hide();
				$('.popup_area #verUp').hide();
			}
		});
		// 과제 평가 완료 시 등록, 수정, 삭제 버튼 비활성화 처리
		var paramObj = {
			"coCd" : $("#wb21_popForm #coCd").val(),
			"salesCd" : $("#wb21_popForm #salesCd").val(),
		};
		postAjaxSync("/user/wb/wb25/selectEvlCloseChk", paramObj, null, function(data) {
			if (data.result[0].closeChk == "Y") {
				$('.popup_area .tit').text('과제관리 이력조회');
				$('.popup_area #actionBtn').hide();
				$('.popup_area #copyBtn').hide();
				$('.popup_area #confirm').hide();
				$('.popup_area #verUp').hide();
			}
		});
	}

	function modalClose() {
		modalStack.close();
	}

	function wb21MakeFormData() {
		var formData = new FormData($("#wb21_popForm")[0]);
		if (actionType == "U") {
			formData.append("fileTrgtKey", fileTrgtKey);
		}

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
        formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용

        var fileUploadArr = [];
        var tempArr = [];
        tempArr = treeModule.getFileArr();
        $.each(tempArr, function(idx, obj) {
            if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
            }
        });

        formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
        //---------------------------------------------------------------
        //--첨부화일 처리를 위한 부분 끝
        //---------------------------------------------------------------
		return formData;
	}

	// 작성자 검색 //
	function openUserSearch() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId" : $('#smrizeId').val(),
			"userNm" : $('#smrizeNm').val(),
		};

		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					$('#smrizeId').val(checkedNode.id);
					$('#smrizeNm').val(checkedNode.text);
				});
	}

	function wbsSjNocopySearch() {
		var paramObj = {};
		paramObj["fileTrgtKey"] = fileTrgtKey;
		paramObj["coCd"] = $("#wb21_popForm #coCd").val();
		// paramObj["searchValue"] = $('#smrizeNm').val();
        var tempCode = $("#wb21_popForm #salesCd").val();
        paramObj["searchValue"] = tempCode.substring(0,5);
		paramObj["fromSalesCd"] = $("#wb21_popForm #salesCd").val();
        paramObj["pgmId"] = "WB2101M02";
		openSecondModal("/static/html/cmn/modal/wbsSjNocopySearch.html", 1200, 650, "과제 복사대상 검색", paramObj);
	}

	function saveSj() {
		if ($("#wb21_popForm #closeYn").val() == "Y") {
			alert("확정 상태입니다. 수정 불가합니다.");
			return;
		}

		if (inputValidation($('.popup_area [required]'))) {
			var codeId = null;
			var formData = wb21MakeFormData();

			if (actionType == "C") {
				filePostAjax("/user/wb/wb21/sjInsert", formData, function(data) {
					// alert(data.resultMessage);
					if (data.resultCode == 200) {
						var salesCd = $("#wb21_popForm #salesCd").val();
						var verNo = $("#wb21_popForm #verNo").val();
						gridView.setData(0);
						modalClose();
					}
				});
			} else {
				filePostAjax("/user/wb/wb21/sjUpdate", formData, function(data) {
					// alert(data.resultMessage);
					if (data.resultCode == 200) {
						gridView.setData(0);
						modalClose();
					}
				});
			}
		}
	}

	function confirmY() {
		if (fileTrgtKey == undefined) {
			alert("대상을 선택하세요");
			return false;
		}

		if (parseInt($("#wb21_popForm #verNo").val())< parseInt($("#wb21_popForm #maxVerNo").val())) {
			alert("상위버전이 존재합니다.");
			return;
		}

		if ($("#wb21_popForm #closeYn").val() == "Y") {
			alert("확정된 상태입니다.");
			return;
		}
		if (inputValidation($('.popup_area [required]'))) {
			if(confirm("확정하시겠습니까?")) {
				var formData = new wb21MakeFormData();
				let sharManager = (jwt.userId == 'js.nam') ? 'js.nam' : 'jwc'; //공유 또는 결재대상 (ycy: 윤치영부장) => cyh: 조영희부장  => pwj: 박원제부장 => kcg3190 : 강춘기실장 => 'jwc : 조완철차장
				formData.append("fileTrgtKey", fileTrgtKey);
				var rowSharngListArr = []; //공유정보
				var rowSharngListObj = {};
				// if (elem.gb == '공유'){
					rowSharngListObj["gb"] = '공유';
					rowSharngListObj["sanCtnSn"] = '1';
					rowSharngListObj["coCd"] = $("#wb21_popForm #coCd").val() ;
					rowSharngListObj["todoDiv1CodeId"] = "TODODIV10";
					rowSharngListObj["todoDiv2CodeId"] = "TODODIV1110";
					rowSharngListObj["salesCd"] = $("#wb21_popForm #salesCd").val();
					rowSharngListObj["pgPath"] = "/user/wb/wb21/WB2101P01.html";
					rowSharngListObj["fileTrgtKey"] = fileTrgtKey;
					rowSharngListObj["reqNo"] = $("#wb21_popForm #sjNo").val();
					rowSharngListObj["usrNm"] = sharManager;	//공유 또는 결재대상 ycy: 윤치영부장
					rowSharngListObj["userId"] = jwt.userId;
					rowSharngListObj["pgmId"] = "WB2101P01";
					rowSharngListObj["todoCoCd"] = $("#wb21_popForm #coCd").val() ;
					// rowSharngListObj["pgParam"] = modalStack.last().paramObj;
				//TITLE 추가
					rowSharngListObj['todoTitle'] = $("#wb21_popForm #salesCd").val() + "과제관리 등록 확인용"
					rowSharngListArr.push(rowSharngListObj);
				// }
				formData.append("rowSharngListArr", JSON.stringify(rowSharngListArr));

				filePutAjax("/user/wb/wb21/sjConfirmY", formData, function(data) {
					if(data.resultCode == 200) {
						// alert("확정 되었습니다.");
                        wb21_kakaoTodo();
						
						// 일정 계획 확정 연동
						wbsLevel1confirm('Y');

						gridView.setData(0);
						modalClose();
					} else {
						alert("확정 작업 실패했습니다." + data );
					}
				});
			}
		}
	}

	function confirmN() {
		if (fileTrgtKey != undefined) {
			if (parseInt($("#wb21_popForm #verNo").val())< parseInt($("#wb21_popForm #maxVerNo").val())) {
				alert("상위버전이 존재합니다.");
				return;
			}

			if ($('#closeYn').val() == "N") {
				alert("확정 취소 상태입니다.");
				return;
			}

			if(confirm("확정 취소 하시겠습니까?")) {
				var formData = new FormData();
				formData.append("fileTrgtKey", fileTrgtKey);
				formData.append("userId", $('#wb21_popForm #userId').val());
				formData.append("pgmId", $('#wb21_popForm #pgmId').val());
				filePutAjax("/user/wb/wb21/sjConfirmN", formData, function(data) {
					if(data.resultCode == 200) {
						alert("확정 취소 되었습니다.");
						gridView.setData(0);
						modalClose();
					} else {
						alert("확정 취소 작업 실패했습니다." + data );
					}
				});
			}
		} else {
			alert("대상을 선택하세요");
		}
	}

	function createVerUp() {
		if (actionType == "U" && fileTrgtKey == undefined) {
			alert("대상을 선택하세요");
			return;
		}

		if ($("#wbsPlanCloseYn").val() == "N") {
			alert("미확정 상태입니다. 신규 버전을 생성할 수 없습니다.");
			return;
		}

		var strYear = new Date().toISOString().substring(2, 4);
		var planData = {
			"coCd" : $("#wb21_popForm #coCd").val(),
			"sjNo" : $("#wb21_popForm #sjNo").val(),
			"salesCd" : $("#wb21_popForm #salesCd").val(),
		};
		var newVerNo;
		var aftCnt;
		var aftText = "";
		postAjaxSync("/user/wb/wb21/selectSjVerNoNext", planData, null, function(data) {
			newVerNo = data.result[0].verNo
			aftCnt = data.result[0].aftCnt
		});

		if(aftCnt > 0) {
			aftText = "\n진행중인 WBS계획이 있습니다!\n버전 변경 시 확정 전까지 일정수정이 불가합니다!";
		}

		if(confirm("버젼 변경을 하시겠습니까?"+aftText)) {
			$("#verNo").val(newVerNo);
// 			if (inputValidation($('.popup_area [required]'))) {
				var codeId = null;
				var formData = wb21MakeFormData();
				filePostAjax("/user/wb/wb21/sjVerUpInsert", formData, function(data) {
					alert(data.resultMessage);
					if (data.resultCode == 200) {
						var salesCd = $("#wb21_popForm #salesCd").val();
						var verNo = $("#wb21_popForm #verNo").val();
						fileTrgtKey = data.fileTrgtKey;
						gridView.setData(0);
						//과제 정보 DB 검색 화면에 표시
						sjDBSearchinfo();
// 						modalClose();

						$('.popup_area #confirm').show();
					} else {
						alert("버젼 변경 작업 실패했습니다." + data );
					}
				});
// 			}
		}
	}

	// SALES CODE 검색 팝업. flag 가 S면 기본화면 조회. P면 과제관리 팝업
	function wbsSalesCodeSearch_wb21p() {
		if(actionType == "U") {
			alert("SALES CODE는 수정 불가합니다.");
			return;
		}

		var paramObj = {};
		paramObj["coCd"] = $('#wb21_popForm #coCd').val();
		paramObj["salesCd"] = $('#wb21_popForm #salesCd').val();
		openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1200, 700, "SALES CODE 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#wb21_popForm #salesCd').val(row.salesCd);
			$('#wb21_popForm #clntCd').val(row.ordrsClntCd);
			$('#wb21_popForm #clntNm').val(row.ordrsClntNm);
			$('#wb21_popForm #prdtCd').val(row.prdtCd);
			$('#wb21_popForm #prdtNm').val(row.prdtCdNm);
			$('#wb21_popForm #clntPjt').val(row.clntPjt);
			$('#wb21_popForm #clntPjtNm').val(row.clntPjtNm);
			//과제명 = 설비명 적용 후 수정 불가
			$('#wb21_popForm #sjNm').val(row.eqpNm);
			$('#wb21_popForm #sjNm').prop('readonly', true);
			// SALES CODE 가 사용되고 있는지 체크
			var paramData = {
				"salesCd" : row.salesCd
			};
			postAjaxSync("/user/wb/wb21/selectSalesCodeCheck", paramData, null, function(data) {
				// console.log(data.result[0].rtnCnt > 0);
				if(data.result[0].rtnCnt > 0) {
					alert("이미 작성된 과제가 있습니다!");
					$('#wb21_popForm #salesCd').val(row.salesCd);
					gridView.setData(0);
					modalClose();
				}
			});
		});
	}

	// 복사
	function copyAllPlanPopUp() {
		var paramObj = {};
		paramObj["coCd"] = $('#wb21_popForm #coCd').val(); 
		paramObj["pgmId"] = "WB2201M02";
		var tempCode = $("#wb21_popForm #salesCd").val(); 
		paramObj["searchValue"] = tempCode.substring(0,5);
		openSecondModal("/static/html/cmn/modal/wbsPlanConfirmSearch.html", 1200, 870, "일정계획 일괄 대상 검색", paramObj);
	}

	// 저장
	function wbsLevel1Insert(fromConfirm) {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다.\n 저장 후 처리하세요");
			return;
		}
		
		//유효성 체크
		var row = gridView1.target.getList()[0];
		if (row != undefined) {
			if (row.closeYn == "Y" && !canEditPlanRow(row)) {
				alert("확정된 상태입니다.");
				return;
			}
		}
		////////////////

		var rowList = gridView1.target.getList();
		var formData = new FormData();
		var actionType = null;

		formData.append("coCd", $("#wb21_popForm #coCd").val());
		formData.append("year", $('#wb21_popForm #beginDt').val().substring(0,4));
		formData.append("salesCd", $('#wb21_popForm #salesCd').val());
		formData.append("userId", jwt.userId);
		
		if(rowList.length > 0) {
			var rowListArr = [];
			$.each(rowList, function(idx, elem){
				if (elem.fileTrgtKey != undefined) {
					actionType = "U";
				}
				else {
					actionType = "C";
				}
				var row = gridView1.target.getList()[idx];
				var rowListObj = elem;

				rowListObj["actionType"] = actionType;

				rowListObj["coCd"] = elem.coCd;
				rowListObj["salesCd"] = $('#wb21_popForm #salesCd').val();
				rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
				rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
				if (actionType == "U") {
					rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
					rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
				}
				rowListObj["salesCd"] = elem.salesCd;
				if (elem.verNo != undefined) {
					rowListObj["verNo"] = elem.verNo;
				}
				else {
					//신규 등록시 동일버젼 내에서 버전번호 최대값 추출
					const largestValue = rowList.reduce((maxObject, currentObject) => {
						return currentObject["verNo"] > maxObject["verNo"] ? currentObject : maxObject;
						}, rowList[0]);

					rowListObj["verNo"] = (largestValue["verNo"] == undefined) ? 1 : largestValue["verNo"] ;
				}

				if (elem.wbsPlanMngId != undefined) {
					rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
				}
				else {
					rowListObj["wbsPlanMngId"] = "";
				}

				rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
				rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
				rowListObj["daycnt"] = elem.daycnt;
				var wbsPlanStsCodeId = "";

				if (elem.wbsPlanStsCodeId != undefined) {
					wbsPlanStsCodeId = elem.wbsPlanStsCodeId;
				}

				rowListObj["wbsPlanStsCodeId"] = wbsPlanStsCodeId;
				rowListObj["creatId"] = jwt.userId;
				rowListObj["creatPgm"] = "WB2101P01"; 
				rowListObj["chgReason"] = elem.chgReason;		
				rowListObj["allPjtYn"] = elem.allPjtYn;			
				rowListObj["taskPlanYn"] = elem.taskPlanYn;		
				rowListObj["taskPlanYn"] = elem.taskPlanYn;		

				rowListArr.push(rowListObj);
			});
			formData.append("rowListArr", JSON.stringify(rowListArr));
		}

		filePostAjax("/user/wb/wb22/wbsLevel1Insert", formData, function(data) {
			if(!fromConfirm){
				// alert(data.resultMessage);
			}
			if (data.resultCode == 200) {
				$("#wb21_popForm #btn1").hide();  
				gridView1.setData(0);
				if(fromConfirm){
					getGrid1RowList();
				}
			}
		});
	}
	
	// 변경사항 저장
	function updateWbsChanges() {
		var changedData = gridView1.target.getList().filter(function(row) {
			return row.__modified__;  
		});

		if (changedData.length === 0) {
			alert('변경된 내용이 없습니다.');
			return;  
		}

		var formData = new FormData();

		formData.append("coCd", $('#wb21_popForm #coCd').val());
		formData.append("salesCd", $('#wb21_popForm #salesCd').val());

		var filteredData = changedData.map(function(row) {
			return {
				coCd: row.coCd,
				salesCd: $('#wb21_popForm #salesCd').val(),
				fileTrgtKey: row.fileTrgtKey,
				chgReason: row.chgReason
			};
		});

		formData.append("changedData", JSON.stringify(filteredData));

		filePostAjax("/user/wb/wb22/updateWbsChanges", formData, function(data) {
			if (data.resultCode == 200) {
				gridView1.setData(0);
			} else {
				alert(data.resultMessage);
			}
		});
	}

	// 확정
	function wbsLevel1confirm(flag) {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}

		var rowList = gridView1.target.getList();
		var chk = 0;
		var chkError = "";
		var chk2 = 0;
		var chk2Error = "";
		var chk3 = 0;
		var chk3Error = "";
		var chk4 = 0;
		if (rowList.length > 0) {
			let planExceptCd = $('#wb21_popForm #planExcept').val();  
			let wbsCodeArr = [];
			if (planExceptCd == 'PLANEXCEPT01') {
				wbsCodeArr = ["WBSCODE01","WBSCODE02","WBSCODE11","WBSCODE12","WBSCODE13","WBSCODE14"];
			} else {
				wbsCodeArr = ["WBSCODE01","WBSCODE02"];
			}
			$.each(rowList, function(idx, elem){
				if (wbsCodeArr.indexOf(elem.wbsPlanCodeId) !== -1) {
					if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
						chk++;
						chkError += chk==1 ? "" : ", "
						chkError += idx+1
					}
					if (elem.wbsPlansDt == undefined || elem.wbsPlansDt == "") {
						chk2++;
						chk2Error += chk2==1 ? "" : ", "
						chk2Error += idx+1
					}
					if (elem.wbsPlaneDt == undefined || elem.wbsPlaneDt == "") {
						 chk3++;
						chk3Error += chk3==1 ? "" : ", "
						chk3Error += idx+1
					 }
				}

				chkwbsPlanMngId = elem.wbsPlanMngId == undefined ? "" : elem.wbsPlanMngId;
				chkwbsPlansDt = elem.wbsPlansDt == undefined ? "" : elem.wbsPlansDt;
				chkwbsPlaneDt = elem.wbsPlaneDt == undefined ? "" : elem.wbsPlaneDt;
				if (chkwbsPlanMngId != "" ||
					chkwbsPlansDt != "" ||
					chkwbsPlaneDt != "") {
					if (chkwbsPlanMngId == undefined || chkwbsPlanMngId == "") {
						chk4++;
						alert(elem.wbsPlanCodeNm + " 업무 담당자를 입력하세요.");
						return false;
					}
					if (chkwbsPlansDt == undefined || chkwbsPlansDt == "") {
						chk4++;
						alert(elem.wbsPlanCodeNm + " 시작일자를 입력하세요.");
						return false;
					}
					if (chkwbsPlaneDt == undefined || chkwbsPlaneDt == "") {
						chk4++;
						alert(elem.wbsPlanCodeNm + " 종료일자를 입력하세요");
						return false;
					 }
				}
			});

			if (chk4 > 0 ) { 
				return;
			}
			if (chk > 0) {
				alert(chkError + " 담당자명은 지정되어야 확정 가능합니다.");
				return;
			}
			if (chk2 > 0 || chk3 > 0) {
				alert(chk2Error +" 계획시작일자를 입력해야 확정 가능합니다.");
				return;
			}
			if (chk2 > 0 || chk3 > 0) {
				alert(chk2Error+ " 계획시작일자" +chk3Error+ " 계획종료일자를 입력해야 확정 가능합니다.");
				return;
			}

		}
		
		var wbsPlanVerNo = $("#wb21_popForm #wbsPlanVerNo").val();
		if(wbsPlanVerNo == "" || wbsPlanVerNo == null || wbsPlanVerNo == undefined){
			wbsLevel1Insert(true);
		}else{
			wbsLevel1Submit(flag);
		}
	}
	
	// 일정계획 확정
	function wbsLevel1Submit(flag,list){
		
		var row = gridView1.target.getList()[0];
		var rowList = gridView1.target.getList();
		if (list){
			
			row = list[0];
			rowList = list;
		}
		if (row != undefined && row.fileTrgtKey != undefined) {
			if (flag == "N") {
				// Validation 체크
				if (row.closeYn == "N") {
					alert("미확정된 상태입니다.");
					return;
				}
				/////////////////

				if(confirm("미확정하시겠습니까?")){
					var formData = new FormData();
					if(rowList.length > 0) {
						var rowListArr = [];
						$.each(rowList, function(idx, elem){
							if (elem.fileTrgtKey != undefined) {
								var rowListObj = elem;
								rowListObj["coCd"] = elem.coCd;
								rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
								rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
								rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
								rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
								rowListObj["salesCd"] = elem.salesCd;
								rowListObj["verNo"] = elem.verNo;
								rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
								rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
								rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
								rowListObj["daycnt"] = elem.daycnt;
								rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
								rowListObj["flag"] = flag;
								rowListObj["creatId"] = jwt.userId;
								rowListObj["creatPgm"] = "WB2101P01"; 
								rowListArr.push(rowListObj);
							}
						});
						formData.append("rowListArr", JSON.stringify(rowListArr));
					}

					filePostAjax("/user/wb/wb22/wbsLevel1confirm", formData, function(data){
						if(data.resultCode == 200){
// 							alert("미확정 되었습니다.");
							gridView1.setData(0);
						} else {
							alert("오류가 있습니다.\n" + data.resultMessage);
						}
					});
				}
			} else {
				// Validation 체크
				if (flag == "Y" && row.closeYn == "Y") {
					alert("확정된 상태입니다.");
					return;
				}

				if(confirm("일정계획을 확정하시겠습니까?")){
					var formData = new FormData();
					if(rowList.length > 0) {
						var rowListArr = [];
						$.each(rowList, function(idx, elem){
							if (elem.fileTrgtKey != undefined) {
								var rowListObj = elem;
								rowListObj["coCd"] = elem.coCd;
								rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
								rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
								rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
								rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
								rowListObj["salesCd"] = elem.salesCd;
								rowListObj["verNo"] = elem.verNo;
								rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
								rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
								rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
								rowListObj["daycnt"] = elem.daycnt;
								rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
								rowListObj["flag"] = flag;
								rowListObj["creatId"] = jwt.userId;
								rowListObj["creatPgm"] = "WB2101P01";
								rowListArr.push(rowListObj);
							}
						});
						formData.append("rowListArr", JSON.stringify(rowListArr));
					}
								
					 filePostAjax("/user/wb/wb22/wbsLevel1confirm", formData, function(data){ 
						if(data.resultCode == 200){
							gridView1.setData(0);
						} else {
							alert("오류가 있습니다.\n" + data.resultMessage);
						}
					}); 
				}
			}
		}
	}
	
	// 저장 후 재조회
	function getGrid1RowList(){
		var formData = {
				"coCd" : $("#wb21_popForm #coCd").val(),
				"salesCd" : $("#wb21_popForm #salesCd").val(),
				"beginDt" : $('#wb21_popForm #beginDt').val(),
				"acptncDt" : $('#wb21_popForm #acptncDt').val(),
				"reqreDaycnt" : $('#wb21_popForm #reqreDaycnt').val(),
				"planVerNo" : $("#wb21_popForm #wbsPlanVerNo").val(),
				"userId" : $('#wb21_popForm #smrizeId').val(),
				"histYn" : histYn
			}
			var ajaxUrl;	
				ajaxUrl = "/user/wb/wb22/selectWBS1Level";
		
		
		postAjax(ajaxUrl, formData, null, function(data){
			try {
				var list = data.fileList;
				var i = 0;
				$.each(list, function(idx, obj){
					list[i].daycnt = calculateCalendarCnt(obj.wbsPlansDt, obj.wbsPlaneDt);
					i++;
				});
				
				wbsLevel1Submit('Y',list);
			} catch (error) {
				alert("오류 발생!! 전산실 연락 바랍니다", error.message);
				return null; 
			}
		});
	}

	// 일정계획 Ver.Up
	function createWbsPlanVerUp() {
		if (addRowArr.length  > 0 || deleteRowArr.length  > 0) {
			alert("TASK별 정보내 추가 또는 삭제 내역이 존재합니다. 저장 후 처리하세요");
			return;
		}
		// 유효성 체크
		var row = gridView1.target.getList()[0];
		if (row.closeYn == "N") {
			alert("미확정 상태입니다. 신규 버전을 생성할 수 없습니다.");
			return;
		}

		var rowList = gridView1.target.getList();
		var chk = 0;
		if (rowList.length > 0) {
			$.each(rowList, function(idx, elem){
				if (elem.wbsPlanMngId == undefined || elem.wbsPlanMngId == "") {
					chk++;
				}
			});
		}

		// 버전업 사유 입력
		var reason = prompt("Ver.Up 사유를 입력하세요.");
		if (reason === null) return; // 취소됨
		const verUpReasonValue = String(reason || '').trim();
		
		if (!verUpReasonValue) {
			alert('Ver.Up 사유를 입력하세요.');
			return false;
		}

		var formData = new FormData();
		formData.append("coCd", $('#wb21_popForm #coCd').val());
		formData.append("salesCd", $('#wb21_popForm #salesCd').val());
		formData.append("verNo", row.verNo);
		formData.append("verUpReason", verUpReasonValue);

		// 다음 버전 번호 조회
		var planData = {
			"coCd" : $('#wb21_popForm #coCd').val(),
			"salesCd" : $('#wb21_popForm #salesCd').val()
		};
		var nextVerNo = 0;
		postAjaxSync("/user/wb/wb22/selectVerNoNext", planData, null, function(data){
			nextVerNo = data.result[0].verNo;
		});
		
		if (nextVerNo == 0) {
			alert("버전 정보를 가져오는데 실패했습니다.");
			return;
		}
		
		formData.append("newVerNo", nextVerNo);


		var rowList = gridView1.target.getList();
		var rowListArr = [];
		$.each(rowList, function(idx, elem){
			// ... mapping similar to wbsLevel1Insert but with specific fields for VerUp ...
			var rowListObj = elem;
			// For VerUp we basically copy current rows to history and create new version rows.
			// The backend wbsVerUpInsert handles the logic. We need to pass current rows.
			if (elem.fileTrgtKey != undefined) {
				rowListObj["coCd"] = elem.coCd;
					rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
					rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
					rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
					rowListObj["salesCd"] = elem.salesCd;
					rowListObj["verNo"] = elem.verNo;
					if (elem.wbsPlanCodeNm != undefined) {
						rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
					}
					else {
						rowListObj["wbsPlanCodeNm"] = "";
					}

					if (elem.wbsPlanMngId != undefined) {
						rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
					}
					else {
						rowListObj["wbsPlanMngId"] = "";
					}

					rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
					rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
					rowListObj["daycnt"] = elem.daycnt;
					rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
					rowListObj["closeYn"] = elem.closeYn;
					rowListObj["creatId"] = jwt.userId;
					rowListObj["creatPgm"] = "WB2101P01";
					rowListObj["verUpReason"] = verUpReasonValue;
					rowListArr.push(rowListObj);
			}
		});
		formData.append("rowListArr", JSON.stringify(rowListArr));

		filePostAjax("/user/wb/wb22/wbsVerUpInsert", formData, function(data) {
			if (data.resultCode == 200) {
				gridView1.setData(0);
			} else {
				alert("미확정 상태입니다.")
				gridView1.setData(0);
			}
		});
	}
	
	function calculateCalendarCnt(startDate, endDate) {
		if (!startDate || !endDate) return 0;
		const toUTC = (d) => {
			if (d instanceof Date) return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
			if (typeof d === 'string') {
				const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(d);
				if (!m) return NaN;
				return Date.UTC(+m[1], +m[2] - 1, +m[3]);
			}
			return NaN;
		};
		const startDay = toUTC(startDate);
		const endDay   = toUTC(endDate);
		if (!Number.isFinite(startDay) || !Number.isFinite(endDay)) return NaN;
		if (endDay < startDay) return 0; 
		return Math.floor((endDay - startDay) / 86400000) + 1; 
	}

    /*
    #   TODO 알림톡발송 시작
    #
    */
//     $("#approvalReqTodoBtn").on("click", function () {
//        kakaoTodo();
//     });
function wb21_kakaoTodo() {

    //message load
    if (kakaoErr.length == 0) {
        var paramObj = {
            "userId" : jwt.userId
            , "codeKind" : "KAKAOMSG"
        };
        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
            if(data.resultList.length > 0 ) {
                kakaoErr = data.resultList;
            }
        });
    }

         //---------------------------------------
       let param = {
             "tmplatDiv"	: "TMPLATDIV02"
             , "title"		: "과제관리 확정"
             , "coCd"		: $("#wb21_popForm #coCd").val()            	//해당업무의 coCd(트르넷발주 TRN )
             , "todoNo"		: $("#wb21_popForm #sjNo").val()
             , "histNo"		: ''   									//수주등록시 사용
             , "clntCd"		: "1"               					//발신회사는 로그인사용자 회사
             , "clntNm"		: (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷"       //로그의 수신거래처명
             , "creatPgm"  	: "WB2101P01"
			 , "userId" 	: jwt.userId

             , "todoDiv1CodeId"	: "TODODIV10"               //공통코드 해당업무 - 결재
             , "todoDiv2CodeId"	: "TODODIV1110"             //공통코드 해당업무 - 결재 - 발주서
             , "todoDiv1CodeNm"	: "공유"                  	//공통코드 해당업무 - 결재 - 발주서
             , "sanctnDiv2"		: "공유"                     	//템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.

       }
       wb21_commKaKaoSendTodo(param);  //결재자 전송처리

       if (kakaoCnt > 0) {
           kakaoCnt = 0;
//            alert("알림톡이 정상 발송되었습니다.");
        }
    }

    //to-do결재요청 알림톡
    function wb21_commKaKaoSendTodo(param) {
//        console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);

       //알림톡수신번호 채번
       var talkMessage = null             //발송될 내용 template
       var mobile = null               //수신인 휴대전화번호
       var sendList = [];
       let talkParam = {};
       let talkBody = {};
       let sendCnt = 0;
       postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodoNew", param, null
                , function(data) {
                   if(data.resultList.length > 0 ) {
                      if( data.resultList[0].maxMessageId != "" ) {
                         sendList = data.resultList;
                      } else {
                         alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                         return;
                      }

                   }
       });
       //user search ajax end

       //대상 loop
       $.each(sendList, function (key, sendObj) {
          talkMessage = sendObj.messageDesc;
          mobile =  sendObj.telNo;
          if(mobile == "" || mobile == null) {
             alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
             return false;
          }
          if(talkMessage == "" || talkMessage == null) {
             alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
             return false;
          }
          //로그용
          param.rcvId = sendObj.todoId;         	//todo 수신id
          param.rcvNm = sendObj.name;            	//todo 수신자명
          param.nameTo = sendObj.name;            	//todo 수신자명
          param.todoDiv2CodeNm = sendObj.todoTitl;
          param.sendDt = sendObj.sendDt;
          param.ordrgMngNm = sendObj.ordrgMngNm;	 //작성자(담당자)
          param.ordrgMngTelNo = sendObj.ordrgMngTelNo;//담당자전화번호

          //message 치환
          let message = talkMessage;
          let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
          //loop
          $.each(splitStr, function (key, val) {
             let compKey = val.substring(1, val.length-1);
             if( compKey != "" && compKey != "undefined" ) {
                if( typeof(param[compKey]) != "undefined" ) {
                   let val2 = '#'+val;
                   message = message.replaceAll(val2, param[compKey]);
                }
             }
          });

          talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
          talkParam.serverName = "gyitt2400";
          talkParam.paymentType = "P";

          talkBody.service = "2310086157";            	//서비스번호(1000000000 - 예시  real : 2310086157
          talkBody.messageId = sendObj.maxMessageId;    //고객사에서 관리하는 메시지No - 40byte (unique 값으로 건별 번호);
          talkBody.title = param.title;               	//알림톡 타이틀 -
          talkBody.message = message;            		//알림톡 메시지 (1000 byte)
          talkBody.mobile = mobile;            			//휴대전화번호
          talkBody.template = "10003";         			//템플릿관리화면 템플릿ID   - 발주서 V2
          let talkJson = JSON.stringify(talkBody);

          sendCnt = kakaoSendReal(talkJson, talkParam, param);
       });
       //대상 loop end
       if( sendCnt > 0 ) {
          //alert("알림톡 정상 발송되었습니다.");
          kakaoCnt++;
       }
    }


    function dateChk() {
        $('#wb21_popForm #reqreDaycnt').val(calcDate());
    }

    function calcDate() {
    	let calDay = calculateCalendarCnt($('#wb21_popForm #beginDt').val(), $('#wb21_popForm #deDt').val());
		if (calDay == false) {
			calDay = "";
		}
    	return calDay;
    }

	// 출고일 변경에 따른 체크
	function deDtChangChk() {
		var paramObj = {
			"deDt": $("#deDt").val(),
			"salesCd": $("#salesCd").val()
		};
		postAjaxSync("/user/wb/wb21/deDtChangChk", paramObj, null, function(data) {
			var resultList = data.resultList;
			if (resultList && resultList.length > 0) {
				var parents = {};
				var groups = {}; 

				resultList.forEach(function(item) {
					if (item.wbsPlanCodeKind === "WBSCODE") {
						parents[item.wbsPlanCodeId] = item.codeNm;
					} else {
						var parentId = item.wbsPlanCodeKind;
						if (!groups[parentId]) {
							groups[parentId] = [];
						}
						groups[parentId].push(item.codeNm);
					}
				});

				// 각 부모 그룹에 대해 두 줄 메시지 구성
				// 첫 번째 줄: "일정 계획 : 부모이름"
				// 두 번째 줄: "부모이름Task : 자식1, 자식2, ..."
				var messageParts = [];
				for (var parentId in groups) {
					var parentName = parents[parentId] || parentId;
					messageParts.push("일정 계획 : " + parentName + "\n" + parentName + "Task : " + groups[parentId].join(", "));
				}
				
				var message = "출고일보다 늦은 계획 항목\n\n" + messageParts.join("\n\n") + "\n\n그래도 변경하시겠습니까?";
				if (confirm(message)) {
				} else {
					$("#deDt").datepicker('setDate', originDeDt);
				}
			}
		});
	}

	// 캘린더 데이 계산 함수 (종료일 - 시작일)
	function calculateCalendarCnt(startDate, endDate) {
		if (!startDate || !endDate) return false;

		const toUTC = (d) => {
			if (d instanceof Date) {
				return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
			}
			if (typeof d === 'string') {
				const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(d);
				if (!m) return NaN;
				return Date.UTC(+m[1], +m[2] - 1, +m[3]);
			}
			return NaN;
		};

		const startDay = toUTC(startDate);
		const endDay   = toUTC(endDate);
		if (!Number.isFinite(startDay) || !Number.isFinite(endDay)) return NaN;

		if (endDay < startDay) return 0; // 역순 보호

		return Math.floor((endDay - startDay) / 86400000) + 1; // 양끝 포함
	}

	// changeType: 'delete' | 'mngId' | 'date'
	// changeInfo: { oldValue, newValue } (담당자 변경 시: oldValue=이전담당자명, newValue=신규담당자명)
	function updateWbsPlan(dindex, changeType, changeInfo) {
		var row = gridView1.target.list[dindex];
		var verUpReasonValue = "";

		// 변경 유형에 따라 버전업 사유 생성
		if (changeType === 'delete') {
			// 내용삭제: 기존 로직 유지
			verUpReasonValue = jwt.userNm + ("수정" || '') + " (" + row.wbsPlanCodeNm + " 일정 삭제)";
		} else if (changeType === 'mngId') {
			// 담당자 변경
			verUpReasonValue = jwt.userNm + ("수정" || '') + " (담당자 " + (changeInfo.oldValue || '') + "에서 " + (changeInfo.newValue || '') + "으로 변경)";
		} else if (changeType === 'date') {
			// 일자 변경 (시작일자 또는 종료일자)
			verUpReasonValue = jwt.userNm + ("수정" || '') + " (" + row.wbsPlanCodeNm + " 일정수정)";
		} else {
			// 기본값 (기존 로직)
			verUpReasonValue = jwt.userNm + ("수정" || '') + " (" + row.wbsPlanCodeNm + " 일정 삭제)";
		}

		var formData = new FormData();
		formData.append("coCd", $('#wb21_popForm #coCd').val());
		formData.append("year", $('#wb21_popForm #beginDt').val().substring(0,4));
		formData.append("salesCd", $('#wb21_popForm #salesCd').val());
		formData.append("verNo", row.verNo);
		formData.append("creatId", jwt.userId);
		formData.append("userId", jwt.userId);
		formData.append("creatPgm", $('#wb21_popForm #pgmId').val());
		formData.append("verUpReason", verUpReasonValue);
		formData.append("wbsPlanCodeId", row.wbsPlanCodeId);
		formData.append("changeType", changeType || 'delete');	// 변경 유형 전달
		formData.append("flag", $("#wbsPlanCloseYn").val());	// 일정 확정 유무

		var strYear = new Date().toISOString().substring(2, 4);
		var planData = {
			"coCd" : $('#wb21_popForm #coCd').val(),
			"salesCd" : $('#wb21_popForm #salesCd').val()
		};
		postAjaxSync("/user/wb/wb22/selectVerNoNext", planData, null, function(data){
			formData.append("newVerNo", data.result[0].verNo);
		});

		var rowList = gridView1.target.getList();
		var rowListArr = [];
		$.each(rowList, function(idx, elem){
			var row = gridView1.target.getList()[idx];
			var rowListObj = elem;
			rowListObj["coCd"] = elem.coCd;
			rowListObj["fileTrgtKey"] = elem.fileTrgtKey;
			rowListObj["wbsPlanNo"] = elem.wbsPlanNo;
			rowListObj["wbsPlanCodeId"] = elem.wbsPlanCodeId;
			rowListObj["salesCd"] = elem.salesCd;
			rowListObj["verNo"] = elem.verNo;
			if (elem.wbsPlanCodeNm != undefined) {
				rowListObj["wbsPlanCodeNm"] = elem.wbsPlanCodeNm;
			}
			else {
				rowListObj["wbsPlanCodeNm"] = "";
			}

			if (elem.wbsPlanMngId != undefined) {
				rowListObj["wbsPlanMngId"] = elem.wbsPlanMngId;
			}
			else {
				rowListObj["wbsPlanMngId"] = "";
			}

			rowListObj["wbsPlansDt"] = elem.wbsPlansDt;
			rowListObj["wbsPlaneDt"] = elem.wbsPlaneDt;
			rowListObj["daycnt"] = elem.daycnt;
			rowListObj["wbsPlanStsCodeId"] = elem.wbsPlanStsCodeId;
			rowListObj["closeYn"] = elem.closeYn;
			rowListObj["creatId"] = jwt.userId;
			rowListObj["creatPgm"] = "WB2201M01";
			rowListObj["verUpReason"] = verUpReasonValue;
			rowListArr.push(rowListObj);
		});
		formData.append("rowListArr", JSON.stringify(rowListArr));

		filePostAjax("/user/wb/wb22/updateWbsPlan", formData, function(data){
			if (data.resultCode == 200) {
			} else {
				customAlert(data.resultMessage);
			}
			gridView1.setData(0);
		});
	}

	// 일정예외사항 변경 시 처리
	function onPlanExceptChange(value){
		// 미확정일 때만 저장버튼 표시
		if ($("#wb21_popForm #wbsPlanCloseYn").val() !== "Y") {
			$("#wb21_popForm #btn1").show();
		}
		var rowList = gridView1.target.getList();
		if (value != 'PLANEXCEPT01') {
			$.each(rowList, function(idx, elem) {
				if (["WBSCODE11", "WBSCODE12", "WBSCODE13", "WBSCODE14"].includes(elem.wbsPlanCodeId)) {
					elem.wbsPlanMngId = "";
					elem.wbsPlanMngNm = "";
					elem.daycnt = "";
					elem.wbsPlansDt = "";
					elem.wbsPlaneDt = "";
				}
			});
			gridView1.target.setData(rowList);
		}
	}
</script>