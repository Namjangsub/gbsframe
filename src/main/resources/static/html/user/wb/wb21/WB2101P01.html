<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
      <h4 class="tit" id="popTit">과제관리 등록</h4>
    </div>
    <div class="popup_table">
    	<div class="contents_tit">
           <div class="add_btn_small pdl10">
             <a onclick="confirmY();" style="height: 30px; line-height: 28px; width: 60px;">확정</a>
             <a onclick="confirmN();" style="height: 30px; line-height: 28px; width: 60px;">미확정</a>
             <a onclick="createVerUp();" style="height: 30px; line-height: 28px; width: 60px;">Ver.Up</a>
           </div>
        </div>
    	<form id="popForm">
	        <input type="hidden" id="coCd"   name="coCd">
	        <input type="hidden" id="userId" name="userId">
	        <input type="hidden" id="pgmId"  name="pgmId" value="WB2101M01">
	        <table class="popup_table">
	            <colgroup>
	                 <col width="19%">
	                 <col width="20%">
	                 <col width="20%">
	                 <col width="20%">
	                 <col width="18%">
	                 <col width="17%">
	                 <col width="18%">
	                 <col width="20%">
	                 <col width="18%">
	            </colgroup>
	            
	            <thead>
	                <tr>
	                   <td colspan="9" style="height:30px;text-align: left;">과제정보</td>                                                
	                </tr>
	            </thead>
	               <tr style="height:40px;text-align: left;" rowspan="2">
	                    <th>과제기본정보</th>                            
<!-- 	                    <th>과제번호</th> -->
<!-- 	                    <td>  -->
<!-- 	                    </td> -->
	                    <th>과제명</th>
	                    <td colspan="3"> 
	                       <input type="hidden" id="sjNo" name="sjNo" readonly required msg="과제번호">
	                       <input type="text" id="sjNm" name="sjNm" msg="과제명">
	                    </td>                               
	                    <th>Ver.</th>
	                    <td>   
	                       <input type="text" id="verNo" name="verNo" onkeyup="onlyNumber(this)" maxlength="1" readonly>
	                    </td>
						<th>확정여부</th>
		                <td>
		                	<input type="text" id="closeYn" name="closeYn" readonly="readonly">
		                </td>
	                </tr>
	                
	                <tr>
	                   <td colspan="9" style="height:8px;text-align: left;"></td>                                                
	                </tr>
	                
	                 <tr style="height:40px;text-align: left;" rowspan="2">
	                    <th>고객기본정보</th>                            
	                    <th  class="hit">SALES CODE</th>
	                    <td> 
	                       <div class="search_form">
	                        <input type="text" id="salesCd" name="salesCd" required readonly msg="salesCd">
	                        <a onclick="wbsSalesCodeSearch('P');"><i class="i_search_w" readonly></i></a>
	                    </div>
	                    </td>
	                    <th>고객사</th>
	                    <td> 
	                       <input type="hidden" id="clntCd" name="clntCd" >
	                       <input type="text" id="clntNm" name="clntNm" readonly >
	                    </td>
	                    <th>제품</th>
	                    <td>
	                        <input type="hidden" id="prdtCd" name="prdtCd" >
	                        <input type="text" id="prdtNm" name="prdtNm" readonly >
	                    </td>
	                    <th>차종</th>
	                    <td>   
	                       <input type="hidden" id="clntPjt" name="clntPjt">
	                       <input type="text" id="clntPjtNm" name="clntPjtNm" readonly >
	                    </td>
	                </tr>
	                
	                 <tr>
	                   <td colspan="9" style="height:8px;text-align: left;"></td>                                                
	                </tr>
	                <tr  style="height:40px;text-align: left;">
	                    <th>실행정보</th>                            
	                    <th>제작처 구분</th>
	                    <td>
	                        <select id="mkerDiv" name="mkerDiv" data-kind="MAKERDIV" onchange="mkerCd.value='';mkerNm.value='';">
	                        </select>
	                    </td>
	                    <th>제작업체</th>
	                    <td colspan="2"> 
	                       <input type="hidden" id="mkerCd" name="mkerCd">
	                        <div class="search_form" style="width: 100%;">
	                            <input type="text" id="mkerNm" name="mkerNm" readonly> 
	                            <a onclick="openClntSearch();"><i class="i_search_w"></i></a>
	                        </div>
	                    </td>
	                    <td colspan="3"></td>
	                </tr>
	                <tr>
	                   <td colspan="9" style="height:8px;text-align: left;"></td>                                                
	                </tr>
	                 <tr style="height:40px;text-align: left;">
	                    <th>납기정보</th>                            
	                    <th class="hit">시작일</th>
	                    <td>        
	                    <input id="beginDt" name="beginDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="시작일" date>                            
	                    </td>
	                    <th class="hit">출고일</th>
	                    <td>                   
	                    <input id="deDt" name="deDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="출고일" date>                 
	                    </td>
	                    <th class="hit">완료검수일</th>
	                    <td>                   
	                    <input id="acptncDt" name="acptncDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required msg="완료검수일" date>                    
	                    </td>
	                    <th>소요일수</th>
	                    <td>                   
	                    <input id="reqreDaycnt" name="reqreDaycnt"  required msg="소요일수" readonly >                    
	                    </td>
	                </tr>
	                <tr>
	                   <td colspan="9" style="height:8px;text-align: left;"></td>                                                
	                </tr>
	                <tr  style="height:40px;text-align: left;">
	                    <th>참조정보</th>                            
	                    <th>설계난이도</th>
	                    <td>        
	                    <select id="dsgnDifCodeId" name="dsgnDifCodeId" data-kind="DSGNDIF"> 
	                    </select>                    
	                    </td>
	                    <th>설계계획공수</th>
	                    <td>                   
	                    <input type="text" class="form-control" id="dsgnPlanHour" name="dsgnPlanHour" onkeyup="onlyNumber(this)">            
	                    </td>
	                    <th>생산난이도</th>
	                    <td>                   
	                    <select id="prdctnDifCodeId" name="prdctnDifCodeId" data-kind="PRDCTNDIF">
	                    </select>                
	                    </td>
	                    <th>생산계획공수</th>
	                    <td>                   
	                    <input type="text" class="form-control" id="prdctnPlanHour" name="prdctnPlanHour" onkeyup="onlyNumber(this)">                  
	                    </td>
	                </tr>
	                <tr>
	                   <td colspan="9" style="height:8px;text-align: left;"></td>                                                
	                </tr>
	                
	                <tr>
	                <th class="hit">총괄PM</th>
	                <td colspan="3"> 
	                  <div class="search_form">
	                    <input type="hidden" id="smrizeId" name="smrizeId" msg="총괄PM" >
	                    <input type="text" id="smrizeNm" name="smrizeNm" onkeyUp="if(window.event.keyCode == 8){smrizeId.value = ''};" readonly required msg="총괄PM">
	                    <a onclick="openUserSearch();">
	                        <i class="i_search_w"></i>
	                    </a>
	                </div>
	                <td colspan="5">
	                </td>
	                </tr>
	                <tr style="height:150px;text-align: left;">                         
	                    <th>비고<br>(1000자)</th>                            
	                    <td colspan="8">   
	                    <textarea id="sjRmk" name="sjRmk" cols="160" rows="24" style="border:none;outline: none;"></textarea>                                                                                   
	                    </td>
	                </tr>
	        </table>                    
	        <input type="hidden" id="userId" name="userId">
	        <input type="hidden" id="pgmId" name="pgmId" value="WB2101P01">
 	   </form>         
    </div>

    <br>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionBtn" authchk>등록</button>
      <button type="button" class="close_btn" onclick="modalClose();">닫기</button>
    </div>
</div>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">	
	$(document).ready(function() {
		console.log("팝업레뒤");
		setCommonSelect($(".popup_area select[data-kind]"));

		$('#sjNm').prop('readonly', true);
		
		$("#popForm #coCd").val(jwt.coCd);
		
		$('#beginDt').datepicker({
		    format : "yyyy-mm-dd",
		    language : "ko",
		    autoclose : true
		  })
		 .datepicker("setDate", "today")
		 .on("changeDate", function(){
		     dateChk();
		 });
		
		$('#deDt').datepicker({
		    format : "yyyy-mm-dd",
		    language : "ko",
		    autoclose : true
		  })
		 .datepicker()
		 .on("changeDate", function(){
		  $('#acptncDt').datepicker("setDate", $('#deDt').val());
		     dateChk();
		 });
		 
		$('#acptncDt').datepicker({
		    format : "yyyy-mm-dd",
		    language : "ko",
		    autoclose : true
		 })
		.datepicker()
		.on("changeDate", function(){
		    dateChk();
		});
		
		$('#reqreDaycnt').val(calcDate());

		var paramData = {
            "fileTrgtKey" : fileTrgtKey
        }; 
	    postAjaxSync("/user/wb/wb21/selectSjInfo", paramData, null, function(data){
	    	console.log(data.resultList);
	    	if (data.resultList) {
				$.each(data.resultList, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				$('.tit').text('과제관리 수정');
				
				if($('#popForm #closeYn').val() == 'Y'){
					$('#actionBtn').hide();
				}else{
					$('#actionBtn').text("수정");
					$('#actionBtn').on("click", function() {
						saveSj();
					});
				}
				
			} else {
				
				var strYear = new Date().toISOString().substring(2, 4);
			    var planData = {
			             "coCd" : jwt.coCd,
			             "year" : "SJ" + strYear
			         }; 
			    postAjaxSync("/user/wb/wb21/selectMaxSjNo", planData, null, function(data){
			          $("#sjNo").val(data.result[0].sjNo);
			          $("#verNo").val("1");
			      }); 
			    
				$("#actionBtn").text("등록");
				$('#actionBtn').on("click", function() {
					saveSj();
				});
			} 
			
	    });
	    
	});
	
	function modalClose(){
		modalStack.close();
	}
	
	function makeFormData() {
		   var formData = new FormData($("#popForm")[0]);
		   if (actionType == "U") {
			   formData.append("fileTrgtKey", fileTrgtKey);
		   }
		   return formData;
	}
	
	function saveSj() { 
		if ($("#closeYn").val() == "Y") {
			alert("확정 상태입니다. 수정 불가합니다.");
			return;
		}
		
	    if (inputValidation($('.popup_area [required]'))) { 
	        var codeId = null;
	        var formData = makeFormData();
	        
	        if (actionType == "C") {
	            filePostAjax("/user/wb/wb21/sjInsert", formData,             
	                    function(data) {
	                        alert(data.resultMessage);                              
	                        if (data.resultCode == 200) {
	                            var salesCd = $("#popForm #salesCd").val();
	                            var verNo = $("#popForm #verNo").val();
	                            gridView.setData(0);
	                            modalClose();
	                        }
	                    }); 
	        }
	        else {
	        	filePostAjax("/user/wb/wb21/sjUpdate", formData,             
	                    function(data) {
	                        alert(data.resultMessage);                              
	                        if (data.resultCode == 200) {
	                        	gridView.setData(0);
	                        	modalClose();
	                        }
	                    }); 
	        }
	    }
	}
	
	function confirmY() {
		var row = gridView.target.getList("selected")[0];
		if (row != undefined && row.fileTrgtKey != undefined) {
			if (row.verNo < row.maxVerNo) {
				alert("상위버전이 존재합니다.");
	            return;
			}			
			if (row.closeYn == "Y") {
				alert("확정된 상태입니다.");
				return;
			}
			if(confirm("확정하시겠습니까?")){
		        var formData = new makeFormData(); 
		        formData.append("fileTrgtKey", row.fileTrgtKey);
		        filePutAjax("/user/wb/wb21/sjConfirmY", formData, function(data){
		            if(data.resultCode == 200){
		                alert("확정 되었습니다.");       
		                gridView.setData(0);
		                modalClose();
		            }
		         }); 
		    }
		}
		else {
			alert("대상을 선택하세요");    
		}
	}

	function confirmN() {
	    var row = gridView.target.getList("selected")[0];
	    if (row != undefined && row.fileTrgtKey != undefined) {
	    	if (row.verNo < row.maxVerNo) {
	            alert("상위버전이 존재합니다.");
	            return;
	        } 
	    	
	    	if (row.closeYn == "N") {
	            alert("확정 취소 상태입니다.");
	            return;
	        }
	        if(confirm("확정 취소 하시겠습니까?")){
	            var formData = new FormData();
	            formData.append("fileTrgtKey", row.fileTrgtKey);
	            formData.append("userId", $('#userId').val());
	            formData.append("pgmId", $('#pgmId').val());
	            filePutAjax("/user/wb/wb21/sjConfirmN", formData, function(data){
	                if(data.resultCode == 200){
	                    alert("확정 취소 되었습니다.");       
	                    gridView.setData(0);
	                    modalClose();
	                }
	             }); 
	        }
	    }
	    else {
	        alert("대상을 선택하세요");    
	    }
	}

	function createVerUp() { 
	    var row = gridView.target.getList("selected")[0];
	    if (actionType == "U" && row == undefined) {
	        alert("대상을 선택하세요");
	        return;
	    }
	    if ($("#closeYn").val() == "Y") {
	        alert("확정 상태입니다. 신규 버전을 생성할 수 없습니다.");
	        return;
	    }
	    var strYear = new Date().toISOString().substring(2, 4);
	    var planData = {
	             "coCd" : row.coCd,
	             "sjNo" : row.sjNo
	         }; 
	    postAjaxSync("/user/wb/wb21/selectSjVerNoNext", planData, null, function(data){
	    	  $("#verNo").val(data.result[0].verNo);
	      });
	    
	    if(confirm("버젼 변경을 하시겠습니까?")){
	    	if (inputValidation($('.popup_area [required]'))) { 
	            var codeId = null;
	            var formData = makeFormData();  
	            filePostAjax("/user/wb/wb21/sjVerUpInsert", formData,             
	                    function(data) {
	                        alert(data.resultMessage);                              
	                        if (data.resultCode == 200) {
	                            var salesCd = $("#popForm #salesCd").val();
	                            var verNo = $("#popForm #verNo").val();
	                            fileTrgtKey = data.fileTrgtKey;
	                            gridView.setData(0);
	                        }
	                    }); 
	        }
	    }
	}
	
	// SALES CODE 검색 팝업. flag 가 S면 기본화면 조회. P면 과제관리 팝업
	function wbsSalesCodeSearch(flag) {
		if(flag != "S" && actionType == "U"){
			alert("SALES CODE는 수정 불가합니다.");
			return;
		}
	    var paramObj = {};
	    if (flag == "S") {
	    	paramObj["coCd"] = $('#coCd_S').val();
	        paramObj["salesCd"] = $('#salesCd_S').val();
	    }
	    else {
	    	paramObj["coCd"] = $('#coCd_S').val();
	        paramObj["salesCd"] = $('#salesCd').val();
	    }       
	    openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 980, 550, "SALES CODE 검색", paramObj, function (grid){
	        var row = grid.target.getList("selected")[0];
	        if (flag == "S") {
	        	$('#salesCd_S').val(row.salesCd);
	        	gridView.setData(0);
	        }
	        else {
	        	console.log(row);
	        	$('#salesCd').val(row.salesCd);
	        	$('#clntCd').val(row.ordrsClntCd);
	        	$('#clntNm').val(row.ordrsClntNm);
	        	$('#prdtCd').val(row.prdtCd);
	            $('#prdtNm').val(row.prdtCdNm);     	
	            $('#clntPjt').val(row.clntPjt);
	            $('#clntPjtNm').val(row.clntPjtNm);
	            //과제명 = 설비명 적용 후 수정 불가
	            $('#sjNm').val(row.eqpNm);
	            $('#sjNm').prop('readonly', true);
	            
	            // SALES CODE 가 사용되고 있는지 체크
	            var paramData = {
	            			     "salesCd" : row.salesCd
							    }; 
			    postAjaxSync("/user/wb/wb21/selectSalesCodeCheck", paramData, null, function(data){
// 	  	    		console.log(data.result[0].rtnCnt > 0);
	  	    		if(data.result[0].rtnCnt > 0){
		  	    		alert("이미 작성된 과제가 있습니다!");
	  	    			
		  	    		$('#salesCd_S').val(row.salesCd);
			        	gridView.setData(0);
			        	
			        	modalClose();
	  	    		}
	  	        });
	        }
	    });
	}
</script>