<style>
    /* 스타일을 추가하여 모달 창을 화면 전체를 덮도록 설정 */
    .modal-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
    }
    
	/* 로딩 스피너 스타일 */
	.loading-spinner {
	  border: 8px solid rgba(255, 255, 255, 0.3); /* 테두리 색상 */
	  border-top: 8px solid #3498db; /* 스피너의 상단 색상 */
	  border-radius: 50%; /* 원형 모양 */
	  width: 40px; /* 스피너의 가로 크기 */
	  height: 40px; /* 스피너의 세로 크기 */
	  animation: spin 2s linear infinite; /* 애니메이션 적용 */
	  margin: 0 auto; /* 가운데 정렬 */
	}

	/* 로딩 스피너 회전 애니메이션 */
	@keyframes spin {
	  0% {
	    transform: rotate(0deg);
	  }
	  100% {
	    transform: rotate(360deg);
	  }
	}        
</style>
<div class="container-fluid">
	<div class="row">
        <div class="popup_area">
	 		<input type="file" id="mailFile" style="display:none" multiple="multiple" onchange="setMailFile(this);"/>
	 		<form id="mailForm">
			<table class="popup_table">
				<colgroup>
					<col style="width: 20%;">
					<col style="width: 80%;">
				</colgroup>
				<tbody>
					<tr>
						<th>보내는 사람</th>
						<td>
							<input type="text" class="form-control input-sm" id="mailFrom" name="mailFrom" msg="보내는 사람" readonly>
						</td>
					</tr>
					<tr>
						<th class="hit">받는 사람</th>
						<td>
							<input type="text" class="form-control input-sm" id="mailTo" name="mailTo" msg="받는사람" required>
						</td>
					</tr>
					<tr>
						<th>참조 메일 주소</th>
						<td>
							<input type="text" class="form-control input-sm" id="mailCc" name="mailCc">
						</td>
					</tr>
					<tr>
						<th class="hit">제목</th>
						<td>
							<input type="text" class="form-control input-sm" id="mailTitle" name="mailTitle" msg="제목" required>
						</td>
					</tr>
					<tr>
						<th class="hit">내용</th>
						<td>
							<textarea rows="6" class="form-control input-sm" id="mailCnts" name="mailCnts" msg="내용" required></textarea>
						</td>
					</tr>
					<tr>
						<th>
							<button type="button" id="buttonFile" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="mailFile.click();">첨부파일</button>
						</th>
						<td>
							<div data-ax5grid="mailFile-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
						</td>
					</tr>
				</tbody>
			</table>
			<input type="hidden" id="userId" name="userId">
			<input type="hidden" id="pgmId" name="pgmId" value="maiSend">
			<input type="hidden" id="coCd" name="coCd">
			</form>
		</div>
		<div class="bottom_btn">
			<button type="button" class="btn btn-default btn-sm" id="mailActionBtn"></button>
			<button type="button" class="btn btn-default btn-sm" id="mailActionBtn2"></button>
			<button type="button" class="btn btn-default btn-sm" onclick="modalStack.close();">닫기</button>
		</div>
	</div>
</div>
<!-- JSON 호출 시에 흐리게 덮을 모달 창 -->
<div class="modal-container" id="modalContainer">
	<div class="modal-content">
		<div class="loading-spinner" ></div>
		메일 전송중...
	</div>
</div>
<script type="text/javascript">
	//등록시 직급코드 중복체크 여부
	var mailFileArr = [];
	var deleteMailFileArr = [];
	var mailFileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="mailFile-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
// 		            	downloadFile(this.dindex);
		            },
		        	},
				columns: [
						{key: "fileName", label: "파일명", width: 240, align: "left"},
						{key: "fileType", label: "파일타입", width: 80, align: "center"},
						{key: "fileSize", label: "파일크기", width: 80,  align: "right", formatter: "money"},
						{key: "fileDelBtn", label: "삭제", width: 35,
							formatter:function() {return '<a type="button" onclick="deleteFile('+this.dindex+')">삭제</a>'}
						},
				]
			});
		},
		setData: function(){
			var targetObj = this.target;
			targetObj.setData({
				list: mailFileArr,
				page : {
					totalElements : mailFileArr.length
				}
			});
		}
	}
	debugger;
	$(document).ready(function() {
		mailFileGridView.initView();
		
		$('#mailActionBtn').text("메일발송");
		$('#mailActionBtn').on("click", function(){executeMail();});
		$('#mailActionBtn2').text("심플메일발송");
		$('#mailActionBtn2').on("click", function(){executeSmpleMail();});
		$('#mailForm #mailFrom').val(jwt.email);
		$('#mailForm #userId').val(jwt.userId);
		$('#mailForm #mailTitle').val(modalStack.last().paramObj.mailTitle);
		$('#mailForm #mailCnts').val(modalStack.last().paramObj.mailCnts);
		
		if (modalStack.last() && modalStack.last().paramObj && modalStack.last().paramObj.fileName) {
			var file = modalStack.last().paramObj.file
			const fileName = modalStack.last().paramObj.fileName
			file.name=fileName;
			var typeArr = fileName.split(".");
			mailFileArr.push({
				'fileKey' : 0,
		      	'fileName' : file.name,
		      	'fileType' : typeArr[typeArr.length-1],
		      	'fileSize' : file.size,
		      	'file' : file
			});
			mailFileGridView.setData()
		}
		
	});
	

	function executeMail () {
		if(!inputValidation($('input[required]'))) {
			return false;
		}
		
		$("#modalContainer").show();
		
		var formData = new FormData($("#mailForm")[0]);
		
		// 첨부파일 추가
		$.each(mailFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file, obj.file.name);
			}
		});
		//추가 내용 파라메터에 추가
// 		formData.append("coCd" 			, jwt.coCd);
// 		formData.append("userId"		, jwt.userId);
		formData.append("mailFrom"		, jwt.email);
// 		const toArr = $("#mailTo").val().split(',');
		const toArr = $("#mailTo").val();
		formData.append("mailTo"		,  toArr);
		formData.append("mailCc"		,  $("#mailCc").val().split(','));
		formData.append("userNm"		, jwt.userNm);
		formData.append("pgmId" 		, "textMail");
		formData.append("sendType" 		, "textMail"); //고유한 프로그램명
		formData.append("sendKey" 		, 0); //해당 프로그램에서 교유한 key 값
		formData.append("cntsType" 		, "free"); //메일내용 포멧 적용 시 사용예정 (free:자유형식)
		formData.append("mailAttach" 	, mailFileArr.map(fileObj => fileObj.fileName).join('\n'));
		formData.append("shortUrl" 		, modalStack.last().paramObj.urlInfo.shortUrl); 
		formData.append("chkCode" 		, modalStack.last().paramObj.urlInfo.chkCode); 

// 		$("#mailForm input").each(function() {
// 			  var name = $(this).attr("name");
// 			  var value = $(this).val();
// 			  console.log(name + ": " + value);
// 			});		
		
		filePostAjax("/mail/sendJoinMail", formData ,function(data) {
			$("#modalContainer").hide();
			alert(data.resultMessage);
		});
	}	
	

	function executeSmpleMail () {
		if(!inputValidation($('input[required]'))) {
			return false;
		}
		
		$("#modalContainer").show();
		
		var formData = new FormData($("#mailForm")[0]);
		
		// 첨부파일 추가
		$.each(mailFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file, obj.file.name);
			}
		});
		//추가 내용 파라메터에 추가
// 		formData.append("coCd" 			, jwt.coCd);
// 		formData.append("userId"		, jwt.userId);
		formData.append("mailFrom"		, jwt.email);
// 		const toArr = $("#mailTo").val().split(',');
		const toArr = $("#mailTo").val();
		formData.append("mailTo"		,  toArr);
		formData.append("mailCc"		,  $("#mailCc").val().split(','));
		formData.append("userNm"		, jwt.userNm);
		formData.append("pgmId" 		, "textMail");
		formData.append("sendType" 		, "textMail"); //고유한 프로그램명
		formData.append("sendKey" 		, 0); //해당 프로그램에서 교유한 key 값
		formData.append("mailAttach" 	, mailFileArr.map(fileObj => fileObj.fileName).join('\n'));

		$("#mailForm input").each(function() {
			  var name = $(this).attr("name");
			  var value = $(this).val();
			  console.log(name + ": " + value);
			});		
		
		filePostAjax("/mail/sendMailSimple", formData ,function(data) {
			$("#modalContainer").hide();
			alert(data.resultMessage);
		});
	}	
	
	// 파일 추가
	function setMailFile(elem) {
		var tempFiles = elem.files;
		// 전역변수 배열에 선택된 파일 추가 
		$.each(tempFiles, function(idx, obj){
			var typeArr = obj.name.split(".");
			mailFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : typeArr[typeArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		
// 		$("#fileList").val(mailFileArr.map(fileObj => fileObj.fileName).join('\n'));
		mailFileGridView.setData();
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
		mailFileGridView.target.removeRow(rowIndex);
		
		if(mailFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteMailFileArr.push(mailFileArr[rowIndex].fileKey);
		}
		
		notiFileArr.splice(rowIndex, 1);
	}	
</script>