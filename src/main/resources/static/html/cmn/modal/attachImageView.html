<script src="/static/js/pdf.min.js"></script>
    <style>
        .image-container {
            position: relative;
            width: 100%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 180px;
        }
        .resized-image {
            width: 1300px;
            height: 860px;
            object-fit: contain;
        }
        #viewArea {
            width: 1300px;
            height: 860px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #pdfControls {
            display: none;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<div class="image-container">
    <button id="prevButton">이전</button>

    <div id="viewArea">
        </div>

    <button id="nextButton">다음</button>
</div>

<div id="pdfControls" class="popup_bottom_btn"  style="text-align: center; margin: 10px 0;">
    <button id="pdfPrevButton">◀ 이전 페이지</button>
    <input type="number" id="currentPageInput" min="1" style="width: 50px; text-align: center;" value="1">
    <span id="pageInfo">/ 1</span>
    <button id="pdfNextButton">다음 페이지 ▶</button>
    <button class="close_btn" onclick="modalStack.close();">닫기</button>
</div>

<div id="imageControls" class="popup_bottom_btn" style="text-align: center; margin-top: 10px;">
    <button id="rotateButton">그림회전</button>
    <button id="zoomInButton">Zoom In</button>
    <button id="zoomOutButton">Zoom Out</button>
    <button id="resetButton">Reset</button>
    <button class="close_btn" onclick="modalStack.close();">닫기</button>
</div>
<script type="text/javascript">
let rotationAngle = 0;
let scaleFactor = 1;
let originalWidth = 1300;
let originalHeight = 860;
let currentPage = 1;
let totalPages = 1;
let pdfDoc = null;
let currentFile = null;
let currentIsImage = true;
let imageList = [];
let currentIndex = 0;

// pdf.js 설정
let pdfjsLib;

$(document).ready(function () {
    pdfjsLib = window['pdfjs-dist/build/pdf'];
    if (pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = '/static/js/pdf.worker.min.js'; // 올바른 워커 파일 경로 설정
        initializeViewer();
    } else {
        console.error("PDF.js 초기화 실패");
        alert("PDF를 표시할 수 없습니다.");
    }
});

function initializeViewer() {
    const paramObj = modalStack.last().paramObj;
    if (Array.isArray(paramObj.fileList) && paramObj.fileList.length > 0) {
        imageList = paramObj.fileList;
        currentIndex = imageList.findIndex(file => file.fileKey === paramObj.fileKey);

        if (currentIndex !== -1) {
            loadFile(imageList[currentIndex]);
        } else {
            alert("파일을 찾을 수 없습니다.");
        }
        updateButtonState();
    } else {
        loadFile(paramObj);
        $('#prevButton, #nextButton').css('visibility', 'hidden');
    }

    $('#prevButton').on('click', function () {
        if (currentIndex > 0) {
            currentIndex--;
            loadFile(imageList[currentIndex]);
            updateButtonState();
        }
    });

    $('#nextButton').on('click', function () {
        if (currentIndex < imageList.length - 1) {
            currentIndex++;
            loadFile(imageList[currentIndex]);
            updateButtonState();
        }
    });

    $('#rotateButton').on('click', function () {
        rotationAngle = (rotationAngle + 90) % 360;
        applyTransform();
    });

    $('#zoomInButton').on('click', function () {
        scaleFactor += 0.1;
        applyTransform();
    });

    $('#zoomOutButton').on('click', function () {
        scaleFactor = Math.max(0.1, scaleFactor - 0.1);
        applyTransform();
    });

    $('#resetButton').on('click', function () {
        rotationAngle = 0;
        scaleFactor = 1;
        applyTransform();
    });

    $('#pdfPrevButton').on('click', function () {
        if (currentPage > 1) {
            currentPage--;
            renderPage();
            updatePageInfo();
        }
    });

    $('#pdfNextButton').on('click', function () {
        if (currentPage < totalPages) {
            currentPage++;
            renderPage();
            updatePageInfo();
        }
    });
    
    $('#currentPageInput').on('change', function () {
        let inputPage = parseInt($(this).val(), 10);
        if (!isNaN(inputPage) && inputPage >= 1 && inputPage <= totalPages) {
            currentPage = inputPage;
            renderPage();
            updatePageInfo();
        } else {
            alert(`1부터 ${totalPages} 사이의 숫자를 입력해주세요.`);
            $(this).val(currentPage); // 잘못 입력시 복구
        }
    });
    
    $('#viewArea').on('wheel', function (event) {
        if (!currentIsImage && !pdfDoc) return;
        event.preventDefault();
        if (event.originalEvent.deltaY < 0) {
            scaleFactor += 0.2;
        } else {
            scaleFactor = Math.max(0.2, scaleFactor - 0.2);
        }
        applyTransform();
    });
}

function updateButtonState() {
    $('#prevButton').css('visibility', currentIndex === 0 ? 'hidden' : 'visible');
    $('#nextButton').css('visibility', currentIndex === imageList.length - 1 ? 'hidden' : 'visible');
}

function loadFile(file) {
    currentFile = file;
    rotationAngle = 0;
    scaleFactor = 1;
    $('#viewArea').empty();

    const fileName = file.fileName || '';
    const extension = fileName.split('.').pop().toLowerCase();
    $(".ax-modal-header").last().contents().first().replaceWith(fileName);

    if (extension === 'pdf') {
        currentIsImage = false;
        loadPdf(file);
        $('#imageControls').hide();
        $('#pdfControls').show(); // PDF 컨트롤러는 항상 보이도록 수
    } else {
        currentIsImage = true;
        loadImage(file);
        $('#pdfControls').hide(); // 이미지일 경우 PDF 컨트롤러 숨김
        $('#imageControls').show();
    }
}

function loadImage(file) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/admin/cm/cm08/fileDownloadAuth2?fileKey=" + file.fileKey + "&userId=" + jwt.userId, true);
    xhr.responseType = "blob";
    xhr.onload = function () {
        if (xhr.status === 200) {
            var blob = xhr.response;
            var reader = new FileReader();
            reader.onloadend = function () {
                var img = $('<img>', {
                    id: 'viewImgData',
                    class: 'resized-image',
                    src: reader.result,
                    style: 'transform: rotate(0deg) scale(1)',
                    click: function () { modalStack.close(); }
                });
                $('#viewArea').append(img);
            };
            reader.readAsDataURL(blob);
        }
    };
    xhr.send();
}

async function loadPdf(file) {
    const pdfUrl = "/admin/cm/cm08/fileDownloadAuth2?fileKey=" + file.fileKey + "&userId=" + jwt.userId;
    pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
    currentPage = 1;
    totalPages = pdfDoc.numPages;

    $('#currentPageInput').val(currentPage); // 초기 값 설정
    if (totalPages > 1) {
        $('#pdfControls').show();
    } else {
        $('#pdfControls').hide();
    }

    updatePageInfo();
    renderPage();
}
async function renderPage() {
    const page = await pdfDoc.getPage(currentPage);
    const scale = scaleFactor;
    const viewport = page.getViewport({ scale: scale });

    const canvas = document.createElement('canvas');
    canvas.id = 'pdfCanvas';
    const context = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    $('#viewArea').empty().append(canvas);

    const renderContext = {
        canvasContext: context,
        viewport: viewport
    };
    await page.render(renderContext).promise;

    canvas.style.transform = `rotate(${rotationAngle}deg)`;
}

function applyTransform() {
    if (currentIsImage) {
        $('#viewImgData').css('transform', `rotate(${rotationAngle}deg) scale(${scaleFactor})`);
    } else {
        renderPage(); // PDF는 다시 그려야 함
    }
}

function updatePageInfo() {
    $('#pageInfo').text(`/ ${totalPages}`);
    $('#currentPageInput').val(currentPage);
}
</script>