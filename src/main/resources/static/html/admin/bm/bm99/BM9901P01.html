<style>
	input[comma] {text-align: right;}
</style>
<script src="/static/js/fileTree.js"></script>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
        <h4 class="tit">도움말</h4>
    </div>

	<div class="popup_table">
		<div class="form-group">
			<input type="hidden" id="fileTrgtKey"/>
			<input type="file" id="clntFile" style="display:none" multiple="multiple" onchange="setFile(this);"/>
			<form id="manualForm">
				<!-- 내용 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="12%">
						<col width="">
					</colgroup>
					<thead>
						<tr>
							<th>내용</th>
							<td>
								<textarea class="form-control" id="pgExpl" name="pgExpl" style="height: 200px;" maxlength="9000"></textarea>
							</td>
						</tr>
					</thead>
				</table>
			</form>
		</div>
	</div>
	
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" onclick="updateClnt();">수정</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	
	$(document).ready(function() {
		
		//슈퍼사용자만 수정할 수 있도록
		if(jwt.userGrade == "USERS"){
			$('#actionBtn').show();
		}else{
			$('#actionBtn').hide();
		}
		
		// 도움말 정보 불러오기 
		selectManualInfo();
		
		//권한체크
		authChk();
	});
	
	function selectManualInfo() {
		
		var paramObj = {
				 "userId": modalStack.last().paramObj.userId
				,"pgmId": modalStack.last().paramObj.pgmId
				};
		postAjax("/admin/bm/bm99/selectManualInfo", paramObj, null, function(data){
			setInfo(data.info);
		});
	}
	
	function setInfo(info) {
// 		console.log(info);
		// 기본정보 set
		$('#pgExpl').val(info.pgExpl);
		
      	//---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp	: "BM9901P01",
			fileTrgtKey : info.fileTrgtKey
		}

		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------
		
	}
	
	// 수정
	function updateClnt() {
		var formData = makeFormData();
		
		filePutAjax("/admin/bm/bm99/updateManualInfo", formData, function(data){
			alert(data.resultMessage);
			if(data.resultCode == 200){
// 				modalStack.close();
				selectManualInfo();
			}
		});
	}
	
	// 폼데이터 생성
	function makeFormData() {
		// 콤마 제거
		$.each($('input[comma]'), function(idx, elem){deleteComma(elem);});
		// 폼데이터 생성
		var formData = new FormData($('#manualForm')[0]);
		// 유저아이디 추가
		formData.append("userId", modalStack.last().paramObj.userId);
		// 대상 프로그램 ID 추가
		formData.append("pgmId", modalStack.last().paramObj.pgmId);
		// 파일키 추가
		formData.append("fileTrgtKey", $('#fileTrgtKey').val());
		

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId" , jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용

		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
				obj.file = '';
				fileUploadArr.push(obj);
			}
		});
		
		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝\
		//---------------------------------------------------------------
		
		return formData;
	}
	
</script>