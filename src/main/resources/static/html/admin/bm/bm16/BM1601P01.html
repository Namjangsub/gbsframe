<style>
* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit" id="prjctPopTit">프로젝트 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
      <input type="hidden" id="prjctInfo" style="display: none" multiple="multiple" onchange="setPrjct(this);">
      <input type="hidden" id="prjctSeq"  name="prjctSeq">
      <input type="hidden" id="pgmId"     name="pgmId" value="BM1601P01">
      <table>

        <colgroup>
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="19%">
        </colgroup>

        <tr>

          <th class="hit">회사</th>
          <td>
            <select id="coCd" name="coCd" data-kind="CO" class="form-control input-sm" required="required" msg="회사">
            </select>
          </td>
          <th class="hit">업체명</th>
          <td>
            <input type="hidden" id="clntCd" name="clntCd" required msg="업체명">
            <div class="search_form">
              <input type="text" id="clntNm" name="clntNm" class="form-control" maxlength="25">
              <a onclick="clntSearch();"><i class="i_search_w"></i>
              </a>
            </div>
          </td>

          <th class="hit">계약년월</th>
          <td>
            <input id="yyyymm" name="yyyymm" class="form-control input_calendar" required msg="계약년월" data-search="yyyymm" date>
        </tr>

        <tr>
          <th>국내/해외</th>
          <td>
            <select data-kind="INPEXP" id="inpexpCd" name="inpexpCd" class="form-control" style="text-align: center;">
            	<!-- <option value="">선택</option> -->
            </select>
          </td>

          <th class="hit">업체담당자</th>
          <td>
            <div class="search_form">
              <input type="text" id="clntMngNm" name="clntMngNm" class="form-control" required msg="업체담당자">
          </td>
          <th>구매방법</th>
          <td>
            <select id="odrCd" name="odrCd" data-search="odrCd" class="form-control" data-kind="PCHORD" style="text-align: center;">
            	<!-- <option value="">선택</option> -->
             </select>
          </td>
        </tr>

        <tr>
          <th class="hit">고객사PJT</th>
          <td>
            <select id="prjctCd" name="prjctCd" data-kind="PRJCTCD" class="form-control" required msg="프로젝트코드">
            	<!-- <option value="">선택</option> -->
            </select>
          </td>

          <th class="hit">계약명</th>
          <td>
            <input type="text" id="prjctNm" name="prjctNm" data-search="prjctNm" class="form-control" required msg="프로젝트명">

          </td>
           <th>신규여부</th>
               <td>
                  <select id="newPrdtCd" name="newPrdtCd" data-kind="ORDRSDTLDIV20" class="form-control" style="text-align: center;">
            			<!-- <option value="">선택</option> -->
                   </select>
               </td>
        </tr>

        <tr>
          <th  class="hit">주요설비명</th>
          <td>
            <input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm" class="form-control" required msg="설비명">
          </td>

          <th  class="hit">수량</th>
          <td>
<!--         <input type="text" id="eqpQty" name="eqpQty" class="form-control" style="text-align: right;" onkeyup="pasIntComma(this)" comma> -->
			<input type="text"  id="eqpQty" name="eqpQty" style="text-align:right;" onkeyup="onlyNumber(this)" maxlength="3" comma>
          </td>

          <th  class="hit">예상물량</th>
          <td>
<!--        <input type="text" id="epctAmt" name="epctAmt" class="form-control" comma required msg="예상물량" onkeyup="onlyNumber(this)" comma> -->
            <input type="text"  id="epctAmt" name="epctAmt" required msg="예상물량" style="text-align:right;" onkeyup="onlyNumber(this)" comma>
          </td>
          </td>
        </tr>

        <tr>
          <th>영업상황</th>
          <td colspan="3">
            <input type="text" id="winbdRmk" name="winbdRmk" class="form-control">
          </td>
          <th>수주목표</th>
          <td>
<!--         <input type="text"  id="ordrsPlanAmt" name="ordrsPlanAmt" class="form-control" required msg="수주목표" onkeyup="onlyNumber(this)" comma> -->
			 <input type="text"  id="ordrsPlanAmt" name="ordrsPlanAmt" msg="수주목표" style="text-align:right;"  onkeyup="onlyNumber(this)" comma>
          </td>
        </tr>

        <tr>
          <th>수주예정일</th>
          <td>
            <input id="ordrsPlanDt" name="ordrsPlanDt" class="input_calendar form-control" data-search="ordrsPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>설계일자</th>
          <td>
          <input id="dsgnDt" name="dsgnDt" class="input_calendar form-control" data-search="dsgnDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>수주금액</th>
          <td>
<!--        <input type="text" id="ordrsAmt" name="ordrsAmt" class="form-control" onkeyup="onlyNumber(this)" comma> -->
			<input type="text"  id="ordrsAmt" name="ordrsAmt" style="text-align:right;" onkeyup="onlyNumber(this)" comma>
            </td>
        </tr>
        <tr>
          <th>구매일자</th>
          <td>
          <input id="purchsDt" name="purchsDt" class="input_calendar form-control" data-search="purchsDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>제작완료일자</th>
          <td>
           <input id="prdctnDt" name="prdctnDt" class="input_calendar form-control" data-search="prdctnDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>미수주금액</th>
          <td>
<!--      <input type="text" id="unordrsAmt" name="unordrsAmt" class="form-control" style="text-align: right;" onkeyup="onlyNumber(this)" comma> -->
           <input type="text"  id="unordrsAmt" name="unordrsAmt" style="text-align:right;" onkeyup="onlyNumber(this)" comma>
           </td>
        </tr>
        <tr>
          <th>검수일자</th>
          <td>
           <input id="acptncDt" name="acptncDt" class="input_calendar form-control" data-search="acptncDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>출고일자</th>
          <td>
            <input id="dlivyDt" name="dlivyDt" class="input_calendar form-control" data-search="dlivyDt" autocomplete="off" onkeyup="dateMask(this);" date>   
          </td>

          <th>설치시운전완료일자</th>
          <td>
         
          <input id="dudtPlanDt" name="dudtPlanDt" class="input_calendar form-control" data-search="dudtPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>  
           </td>
        </tr>


        <tr>
          <th class="hit">영업담당자</th>
          <td>
             <div class="search_form">
                  <input type="hidden" id="mngId" name="mngId"  msg="영업당당자">
                   <input type="text" id="mngNm" name="mngNm" class="form-control" readonly onclick="openUserTree();">
                 <a onclick="openUserTree();">
                <i class="i_search_w"></i>
              </a></div>
          </td>
          <th>수주확정</th>
          <td>
            <select id="winbdCd" name="winbdCd" data-kind="YN" class="form-control" data-search="winbdCd">
            </select>
          </td>
          <th>수주확률</th>
          <td>
              <select type="text" id="ordrsPct" name="ordrsPct" class="form-control">
                    <!-- <option value="" selected>선택</option> -->
                    <option value="0">0%</option>
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="30">30%</option>
                    <option value="40">40%</option>
                    <option value="50">50%</option>
                    <option value="60">60%</option>
                    <option value="70">70%</option>
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
              </select>
          </td>
        </tr>
        <tr>
          <th>수주가치</th>
          <td>
            <input type="text" id="odrRmk" name="odrRmk" class="form-control" >
          </td>
          <th>수주일</th>
          <td>
            <input type="text" id="ordrsDt" name="ordrsDt" class="input_calendar form-control"  data-search="ordrsDt" autocomplete="off" onkeyup="dateMask(this);" readonly date>
          </td>
          <th>등록번호</th>
          <td>
            <input type="text" id="prjctSeq" name="prjctSeq" readonly >
          </td>
               
          </td>
        </tr>
        <tr>
          <th>비고</th>
          <td colspan="5">
            <textarea class="form-control" id="prjctRmk" name="prjctRmk" style="height: 60px;" maxlength="500"></textarea>
          </td>
        </tr>

      </table>

    </form>

		<!-- 콘텐츠 -->
	  <div class="contents">
	      <!-- 리스트 -->
	      <div class="ax5_grid">
	        <ul class="ul_list type02">
	            <li style="width: 70%">
	                <div class="table_list_tit">
	                    <h5 class="tit">대상설비</h5>
						<h7>※ 실적 더블클릭은 수주내역 수정 또는 조회 화면 실행.</h7>
	                    <div class="add_btn_small">
	                        <a onclick= "updatePrdtList('C')" style="width: 50px;" authchk><i class="fas fa-folder-plus"></i> 등록</a>
	                        <a onclick= "updatePrdtList('U')" style="width: 50px;" authchk><i class="fas fa-money-check"></i> 수정 </a>
	                        <a onclick= "deletePrdtList(prdtIdx)" style="width: 50px;" authchk><i class="fas fa-trash"></i> 삭제 </a>
	                    </div>
	                </div>
	                <div>
	                <div data-ax5grid="PD01-grid" data-ax5grid-config="{}" style="height:300px; width: 100%" ></div>
	                </div>
	                
	            </li>
	            <li style="width: 29%">
	                <div class="table_list_tit">
	                    <h5 class="tit">아이템 상세 내역</h5>
	                     <div class="add_btn_small">
	                    </div>
	                </div>
	                  <div>
	                <div data-ax5grid="PJ01-grid" data-ax5grid-config="{}" style="height: 300px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>


	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	
</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="prjctActionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
  
var actionType = null;
var paramPrjctSeq = null;

var firstGrid = null;
var secondGrid = null;

var prdtArr = [];
var prdtDeleteArr = [];//제품코드 삭제 내용 저장
var prdtItemArr = [];  //제품코드:상세아이템 그리드내용,...로 임시저장, 변경된건만 저장
var detailArr = [];

var prdtIdx = null;		//제품선택병경 체크용 인덱스	
var saveWork = false;	//제품 아이템 수정 내역 체크
var savePrdtCd = null;	//제품선택변경 체크용
var savePrdtNewCd = null;	//제품선택변경 체크용

var PD01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="PD01-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: false
		         },
		         body: {
			        	 onClick: function () {
			                this.self.select(this.dindex);
							if (this.item.dataType == '계획') {
								if (saveWork) {
									prdtItemArr[prdtIdx] = PJ01GridView.target.list;
									saveWork = false;
								}
								prdtIdx = this.dindex;
								savePrdtCd = this.item.prjctPrdtCd;
								savePrdtNewCd = this.item.prjctPrdtNewCd;
								PJ01GridView.setData(savePrdtCd, savePrdtNewCd);
							} else {
								var itemData = [{
									"isChk": "Y",
									"prjctSeq" : 0,
									"prjctPrdtCd": this.item.prjctPrdtCd,
									"prjctPrdtNewCd": this.item.prjctPrdtNewCd,
									"codeId": this.item.itemDiv,
									"codeNm": this.item.itemDivNm,
									"prjctItemRmk": "수주완료건"
								}];

								PJ01GridView.setData2(itemData); //임시 생성한 itemData데이터 대입용임
							}
			        	 },
						 onDBLClick: function () {
// 							console.log(this.value);
							if (this.item.dataType == '계획') {
								updatePrdtList('U');
							} else if  (this.item.dataType == '실적') {
								insertProjectModal(this.item)
							}
						 },

			             onDataChanged: function () {
			            	 if (this.item.__selected__ == true) {
			                		prdtIdx = this.dindex;
			                		savePrdtCd = this.item.prjctPrdtCd;
			                		savePrdtNewCd = this.item.prjctPrdtNewCd;
			                }
			            	 //제품내역 수정이 있으면 저장 필요
// 			            	saveWork = true;
			            	this.item.prdtUpd = 'U';
			             },
		    			mergeCells : ["dataType", "prjctPrdtNewNm", "salesCd"], 
	             },
		        footSum: [
	                [
	                    {label: "합계", align: "center", colspan: 5},
	                    {key: "prjctPrdtQty", collector: "sum", formatter: "money", align: "center"},
	                    {colspan: 4},
	                    {key: "prjctPrdtPrc", collector: "sum", formatter: "money", align: "right"},
	                ]
      			],
		        columns : [
		            {key : "dataType",  		label : "구분",   		width : 40,		align: "center"}
		           ,{key : "prjctSeq",  		label : "프로젝트시퀀스",   width : 30,		hidden: true}
		           ,{key : "prjctInpexpCd",  	label : "국내외",     	width : 60,		hidden: true}
		           ,{key : "prjctInpexpNm",  	label : "국내외",     	width : 40,		hidden: true}
		           ,{key : "prjctPrdtNewCd",  	label : "신규",    		width : 40,		hidden: true}
		           ,{key : "prjctPrdtNewNm",  	label : "제작",    		width : 40,		hidden: false}
		           ,{key : "prjctPrdtCd",  		label : "제품코드",   		width : 60,		hidden: true}
		           ,{key : "salesCd",  			label : "Sales Code",   width : 130}
		           ,{key : "prdtNm",  			label : "제품유형",   		width : 200, align: "left"}
		           ,{key : "prjctPrdtMctype",  	label : "MC/MOLD",     	width : 70,		hidden: true}
		           ,{key : "prjctPrdtMctypeNm", label : "MC/MOLD",     	width : 70,		hidden: false}
		           ,{key : "prjctPrdtQty",  	label : "대수",      		width : 50,		hidden: false}
		           ,{key : "prjctPrdtOrdrsDt",  label : "수주일자",    	width : 80,		hidden: false}
		           ,{key : "prjctPrdtPlanDt",  	label : "납기일자",    	width : 80,		hidden: false}
		           ,{key : "inPrdConNm", 		label : "자체구분",   		width : 70}
		           ,{key : "prjctPrdtRmk", 		label : "특이사항",   		width : 220, align: "left"}
		           ,{key : "prjctPrdtSeq", 		label : "순번",   		width : 60,		hidden: true}
		           ,{key : "prjctPrdtPrc", 		label : "금액",   		width : 100, align: "right", formatter: "money"}
		           ,{key : "prjctCrudChk", 		label : "CRUD",   		width : 100,	hidden: true}
		           ,{key : "ordrsNo", 			label : "수주번호",   		width : 100,	hidden: true}
		           ,{key : "histNo", 			label : "차수",   		width : 100,	hidden: true}
			     ]
			    });
			return this;
		},


        setData: function(chk){
// 			console.log(chk);
			if (chk) {
				var target = this.target;
				var list = PD01GridView.target.list
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length
            		}
       			 });
        	} else {
				var target = this.target;
				var formData = {
					"prjctSeq" 		: paramPrjctSeq,
				}
	
	    		postAjax("/admin/bm/bm16/selectPrdtList", formData, null, function(data) {
					try {
						var list = data.prdtList;
						target.setData({
							list : list,
							page : {
								totalElements : list.length
							}
						});
						gridResize(list.length); //그리드 높이 조정
					} catch {
						alert("오류 발생!! 전산실 연락 바랍니다", error.message);
						return null; // 오류 발생 시 null 반환
					} finally {
						// console.log("함수 실행 완료.");
					}
	    	 	});
        	}
     	}, //setData
     }


var PJ01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: false,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="PJ01-grid"]'),
		         header: {
			        		 align: "center",
			        		 selector: false
		        },
		        body: {
  			        	 onClick: function () {
							var row = PD01GridView.target.getList("selected")[0];
							if (row == undefined) {
								alert('대상설비를 먼저 선택하세요!, 계획설비만 선택 가능합니다.');
								return false;
							} else if (row.dataType == '계획') {
								this.self.select(this.dindex);
							}

			            },
			            	onDBLClick: function () {
		
			            },
			            onDataChanged: function () {
							var row = PD01GridView.target.getList("selected")[0];
							if (row == undefined) {
								return false;
							} else if (row.dataType == '계획') {
				            	//아이템 상세내역이 수정이 있으면 저장 필요
				            	saveWork = true;
				            	this.item.itemUpd = 'U';
							}
			            },
		        },
		        columns : [
		               {key : "isChk",    			label : "선택",   		width : 60,
	          	  			editor: {type: "checkbox",	config: {trueValue : "Y",	falseValue : "N"}}}
	                  ,{key : "prjctSeq",  			label : "프로젝트시퀀스", 	width : 40,		hidden: true}
	                  ,{key : "prjctPrdtCd",  		label : "제품코드", 		hidden: true}
		              ,{key : "codeId",				label : "코드아이디",  	hidden: true}
		              ,{key : "prjctItemCd", 		label : "등록아이템코드", 	width : 100,	hidden: true}
		              ,{key : "codeNm",  	  		label : "아이템내역",     	width : 150,}
			          ,{key : "prjctPrdtNewCd",  	label : "신규",    		width : 50,		hidden: true}
		              ,{key : "prjctItemRmk", 		label : "비고",   		width : 230,  	editor: {type: "textarea"}}
		         	]
		    });
			return this;
		},

		setData: function(prdtCd,  prdtNewCd){
			secondGrid = this.target;
			
			if (prdtItemArr[prdtIdx]) {
				var list = prdtItemArr[prdtIdx];
				secondGrid.setData({
					list : list,
					page : {
						totalElements : list.length
					}
		     	});
			} else {
				if (prdtCd) {
		   		 	var formData = {
						"prjctSeq" 		: paramPrjctSeq,
		        		"prjctPrdtCd" 	: prdtCd,  
		        		"prjctPrdtNewCd": prdtNewCd  
		   		 	}
		
					postAjax("/admin/bm/bm16/selectItemList", formData, null, function(data) {
						try {
							var list = data.itemList;
							secondGrid.setData({
								list : list,
								page : {
									totalElements : list.length
								}
					     	});
						} catch {
							alert("오류 발생!! 전산실 연락 바랍니다", error.message);
							return null; // 오류 발생 시 null 반환
						} finally {
							// console.log("함수 실행 완료.");
						}
					}, false);
				} //if (prdtCd) {
			}  //if (prdtItemArr[prdtIdx]
		},
		setData2: function(_dataArr){  //임시 생성한 itemData데이터 대입용임
			var target = this.target;
			target.setData({
				list : _dataArr,
				page : {
					totalElements : _dataArr.length
				}
			}, false);
		} //setData2 end
}
// 	$document.ready(function(){
	$().ready(function(){
// 	$(function(){
// 	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		setByCoCd(modalStack.last().paramObj.coCd);
		$("#userId").val(jwt.userId);
		//계약년월//
		$('#yyyymm').datepicker({
			format : "yyyy-mm",
			language : "ko",
			autoclose : true,
			minViewMode: "months"
		}).datepicker("setDate", new Date());
		
		//수주예정//
		$('#ordrsPlanDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date())
  		.on("changeDate", function(){
  			if($('#ordrsPlanDt').val() > $('#dudtPlanDt').val()){
  				// alert("수주예정일이 설치시운전완료일자보다 클 수 없습니다.");
//   				$('#dudtPlanDt').datepicker("setDate", new Date($('#ordrsPlanDt').val()));
  			}
  		});
		//수주일//
// 		$('#ordrsDt').datepicker({
// 			format : "yyyy-mm-dd",
// 			language : "ko",
// 			autoclose : true
// 		}).datepicker("setDate", new Date());

		$("#popForm #winbdCd").change(function() {
		   if ($(this).val() == "Y") {
		     $("#ordrsDt").prop("readonly", false);
		     $("#ordrsDt").prop("required", true);
		     $('#ordrsDt').closest('td').prev('th').addClass('hit');
		     $('#ordrsDt').datepicker({
					format : "yyyy-mm-dd",
					language : "ko",
					autoclose : true
// 				}).datepicker("setDate", new Date())
				})
		  		.on("changeDate", function(){
		  			if($('#ordrsDt').val() > $('#dudtPlanDt').val()){
		  				// alert("수주일이 설치시운전완료일자보다 작을 수 없습니다.");
// 		  				$('#ordrsDt').datepicker("setDate", new Date($('#dudtPlanDt').val()));
		  			}
		  		});
		   } else {
		     $("#ordrsDt").prop("readonly", true);
		     $("#ordrsDt").prop("required", false);
		     $('#ordrsDt').closest('td').prev('th').removeClass('hit');
		     $("#ordrsDt").datepicker("destroy");
		     $("#ordrsDt").val('');
		   }
		});
		
		
		//설계일자//
        $('#dsgnDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true,
        }).datepicker("setDate", new Date())
        .on("changeDate", function(){
            if($('#ordrsPlanDt').val() > $('#dsgnDt').val()){
                // alert("설계일자는 수주예정일보다 작을 수 없습니다.");
//                 $('#dsgnDt').datepicker("setDate", new Date($('#ordrsPlanDt').val()));
            }
        });
		
        //구매일자//
        $('#purchsDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true,
        }).datepicker("setDate", new Date())
        .on("changeDate", function(){
            if($('#dsgnDt').val() > $('#purchsDt').val()){
                // alert("구매일자는 설계일자보다 작을 수 없습니다.");
//                 $('#purchsDt').datepicker("setDate", new Date($('#dsgnDt').val()));
            }
        });
      

        //제작완료일자//
        $('#prdctnDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true,
        }).datepicker("setDate", new Date())
        .on("changeDate", function(){
            if($('#purchsDt').val() > $('#prdctnDt').val()){
                // alert("제작완료일자는 구매일자보다 작을 수 없습니다.");
//                 $('#prdctnDt').datepicker("setDate", new Date($('#purchsDt').val()));
            }
        });
        
        
        //검수일자//
        $('#acptncDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true,
        }).datepicker("setDate", new Date())
        .on("changeDate", function(){
            if($('#prdctnDt').val() > $('#acptncDt').val()){  //2024.02.02 김일희이사 요청으로 검수일자는 체크안함
                // alert("검수일자는 생산일자보다 작을 수 없습니다.");
//                 $('#acptncDt').datepicker("setDate", new Date($('#prdctnDt').val()));
            }
        });
        
        //출고일자//
        $('#dlivyDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true,
        }).datepicker("setDate", new Date())
        .on("changeDate", function(){
            if($('#acptncDt').val() > $('#dlivyDt').val()){
                // alert("출고일자는 검수일자보다 작을 수 없습니다.");
//                 $('#dlivyDt').datepicker("setDate", new Date($('#acptncDt').val()));
            }
        });
      
      //설치시운전완료일자//
        $('#dudtPlanDt').datepicker({
            format : "yyyy-mm-dd",
            language : "ko",
            autoclose : true,
        }).datepicker("setDate", new Date())
        .on("changeDate", function(){
            if($('#dlivyDt').val() > $('#dudtPlanDt').val()){
                // alert("설치시운전완료일자 출고일자보다 작을 수 없습니다.");
//                 $('#dudtPlanDt').datepicker("setDate", new Date($('#dlivyDt').val()));
            }
        });
      
      
      

		 $('#ordrsPlanAmt, #ordrsAmt').on('keyup', ordRemCal);
		  // 계산 함수 정의

		actionType = modalStack.last().paramObj.actionType;
		paramPrjctSeq = modalStack.last().paramObj.prjctSeq;
		savePrdtCd = '';
		savePrdtNewCd = '';

		PD01GridView.initView();
		PJ01GridView.initView();
		
		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#prjctActionBtn").text("등록");
			$('#prjctActionBtn').on("click", function() {
				insertPrjct();
			});

		} else if (actionType == "U") {
			$('#prjctPopTit').text('프로젝트 수정');
			selectPrjctInfo();				//프로젝트 정보 호출

			$('#prjctActionBtn').text("수정");
			$('#prjctActionBtn').on("click", function() {
				updatePrjct();
			});
		}
		
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
				fileTrgtTyp	: $("#popForm #pgmId").val(),
				fileTrgtKey		: paramPrjctSeq
		}
  		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  

		authChk();						// 권한체크

	});
	
	//미수주 금액 계산 함수
	function ordRemCal() {
	    var ordrsPlanAmt = $('#ordrsPlanAmt').val();
	    var ordrsAmt = $('#ordrsAmt').val();
	    var result = parseFloat(ordrsPlanAmt.replace(/,/g, '')) - parseFloat(ordrsAmt.replace(/,/g, ''));
// 	    var result = parseFloat(ordrsPlanAmt) - parseFloat(ordrsAmt);
	    $('#unordrsAmt').val(isNaN(result) ? '' : result.toLocaleString());
// 	    $('#unordrsAmt').val(isNaN(result) ? '' : result);
	}		
	
	function selectPrjctInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"prjctSeq" : paramPrjctSeq,
		}
		postAjax("/admin/bm/bm16/selectPrjctInfo", formData, null, function(data) {
				$('#popForm #dudtPlanDt').val('');  //기본 오늘날자이므로 clear
				$('#popForm #ordrsPlanDt').val(''); //기본 오늘날자이므로 clear
				$.each(data.result, function(key, value) {
					if ($('#popForm #' + key)[0]) {
						$('#popForm #' + key).val(value);
						if ($('#popForm #' + key).is('[comma]')) {
							onlyNumber($('#popForm #' + key)[0]);
						}
					}
				});
				
				ordRemCal(); //미수주금액 계싼
				
				var prdtList = data.result.prdtList;
				
				if (prdtList.length) {
					PD01GridView.setData(0); 		//첫 번째 그리드의 데이터를 불러오기
					savePrdtCd = prdtList[0].prjctPrdtCd;
					savePrdtNewCd = prdtList[0].prjctPrdtNewCd;
					PJ01GridView.setData(savePrdtCd, savePrdtNewCd); 
// 					PD01GridView.target.focus("HOME");
				}
				prdtIdx = 0;
				$("#popForm #winbdCd").trigger("change");  //수주확정 구분에 따라 수주일 필드 컨디션 조정
		});
	}


	//-----아래로 인서트,업데이트 PrdtList , ItemList 개별 저장 ----------------------//
    //--  SD0601M01 복사 수정 본 참고자료-----  //

	function updatePrdtList(type){
		
        if (saveWork) {
       		prdtItemArr[prdtIdx] = PJ01GridView.target.list;
       		saveWork = false;
		}		
		
		if ( type == 'U') {  //수정버튼클릭
			if (selectGridValidation(PD01GridView.target))
				return;
			var paramObj = PD01GridView.target.getList("selected")[0];
			
			if (paramObj.dataType == "실적") return false; //실적은 수정 삭제 못함.
				paramObj["prdtActionType"] = type;
		} else {	//등록버튼클릭
			var paramObj = {prdtActionType : type};
		}
		
		openSecondModal("/static/html/admin/bm/bm16/BM1602D01.html", 690, 280, "대상설비", paramObj, function (rtnData) {
			var idx; //수정이면 이전 인덱스에 해당하는 값을 대체, 아니면 추가
			var crudChk;
			
			if ( type == 'U') {
				idx = PD01GridView.target.getList("selected")[0].__index;
				if (PD01GridView.target.getList("selected")[0].prjctCrudChk =='I') {
					crudChk = 'I';
				} else {
					crudChk = 'U';
				}
			} else {
				idx = PD01GridView.target.getList().length;
				crudChk = 'I';
			}
			prdtIdx = idx;
			
			PD01GridView.target.list[idx] = {
				  prjctSeq			: (type =="U") ? rtnData.prjctSeq : 0,  //처음 파라메터 프로젝트 키값
				  dataType     		: rtnData.dataType,  
				  prjctInpexpCd		: $("#inpexpCd").val(),
				  prjctInpexpNm		: rtnData.prjctInpexpNm,
				  prjctPrdtNewCd	: rtnData.prjctPrdtNewCd,
				  prjctPrdtNewNm	: rtnData.prjctPrdtNewNm,
				  prjctPrdtCd		: rtnData.prjctPrdtCd,
				  prdtNm			: rtnData.prdtNm,
				  prjctPrdtQty		: rtnData.prjctPrdtQty,
				  prjctPrdtOrdrsDt	: rtnData.prjctPrdtOrdrsDt,
				  prjctPrdtPlanDt	: rtnData.prjctPrdtPlanDt,
				  prjctPrdtRmk		: rtnData.prjctPrdtRmk,
				  prjctPrdtMctypeNm	: rtnData.prjctPrdtMctypeNm,
				  prjctPrdtMctype	: rtnData.prjctPrdtMctype,
				  prjctPrdtSeq		: rtnData.prjctPrdtSeq,
				  __index			: idx,
				  prjctCrudChk		: crudChk,
        		  prdtUpd			:'U'
			};
// 			PD01GridView.target.repaint();
			PD01GridView.setData('chk');
			PD01GridView.target.focus("END");
			savePrdtCd = rtnData.prjctPrdtCd;
			savePrdtNewCd = rtnData.prjctPrdtNewCd;
			PJ01GridView.setData(savePrdtCd, savePrdtNewCd); 
			prdtQtycount();			
				
		});
	}

	//프로젝트 제품의 기계수의 합계
	function prdtGridDuplicates(array) {
		  let uniqueSet = new Set(array);
		  return uniqueSet.size !== array.length;

	}
	
	
	function deletePrdtList(idx){
		if (selectGridValidation(PD01GridView.target))
			return;
		var obj = PD01GridView.target.getList("selected")[0];
		if (obj.dataType == "실적") return false; //실적은 수정 삭제 못함.
		if (obj.prjctSeq) {
			obj.prjctCrudChk = 'D';   //DB에 등록된 자료인 경우 삭제 로 저장
			prdtDeleteArr.push(obj);
		}
		PD01GridView.target.list.splice(idx,1);
		PD01GridView.target.repaint();
		prdtQtycount();
	}

	//프로젝트 제품의 기계수의 합계
	function prdtQtycount() {
		const targetPrdt =  PD01GridView.target.list;
		let totalQty = 0;

		targetPrdt.forEach(item => {
			totalQty += pasFloatChk(item.prjctPrdtQty);
		});
		$('#eqpQty').val(totalQty);
	}
	
	 // 등록
	function insertPrjct() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			filePostAjax("/admin/bm/bm16/insertPrjct", formData,function(data) {
				if (data.resultDBError == 23000) {
					alert("동일한 자료가 있습니다. 확인바랍니다."
						+ "\n - 업 체 명  : "    + $('#clntNm').val()
						+ "\n - 계약 년월 : "  + $('#yyyymm').val()
						+ "\n - 프로젝트  : "  + $("#prjctCd option:selected").text()
						+ "\n - 국내/국외 : " +$("#inpexpCd option:selected").text()
						+ "\n - 구매 방법 : "  + $("#odrCd option:selected").text()
						+ "\n - 신규 여부 : "  + $("#newPrdtCd option:selected").text());
				} else {
					alert(data.resultMessage);
				}
				if (data.resultCode == 200) {
					gridView.setData(0);
					modalStack.close();					// 모달을 닫음
				}
			});
		}
	}

	// 수정
	function updatePrjct() {
		if (inputValidation($('.popup_area [required]'))) {
			if ($('#prjctSeq').val() == "0") {
// 				alert("프로젝트 번호가 없습니다. 전산실 확인 바람!");
// 				return false;
				$('#prjctSeq').val(paramPrjctSeq);
			}
			var formData = makeFormData();
	      	filePostAjax("/admin/bm/bm16/updatePrjct", formData,function(data) {
				if (data.resultDBError == 23000) {
					alert("동일한 자료가 있습니다. 확인바랍니다."
						+ "\n - 업 체 명  : "    + $('#clntNm').val()
						+ "\n - 계약 년월 : "  + $('#yyyymm').val()
						+ "\n - 프로젝트  : "  + $("#prjctCd option:selected").text()
						+ "\n - 국내/국외 : " +$("#inpexpCd option:selected").text()
						+ "\n - 구매 방법 : "  + $("#odrCd option:selected").text()
						+ "\n - 신규 여부 : "  + $("#newPrdtCd option:selected").text());
				} else {
					alert(data.resultMessage);
					if (data.resultCode == 200) {
						gridView.setData(0, modalStack.last().paramObj.rowIndex);
						saveWork = false;
						modalStack.close();
					}
				}	      		
			});
		}
	}

	//----------------------------------------------//
	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		//---------------------------------------------------------------  
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------  
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("comonCd", treeModule.getFileNodeId());
		var fileUploadArr = [];
		var tempArr = [];
		
		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
		//---------------------------------------------------------------  
		//--첨부화일 처리를 위한 부분 끝
		//--------------------------------------------------------------- 

		//제품-설비자료 준비
		prdtArr = prdtDeleteArr.slice(0); //자바스크립트 배열 복사 prdtDeleteArr를 prdtArr에 복사
		var list = PD01GridView.target.list;
// 		let countMap = {}; //동일제품 카운트를 하기위한 임시배열

// 		for (let prdtAry of list) {
// 			//동일 제품등록 갯수를 산정하기 위한 검색 필드 조합 : 제품코드 + MC/MOLD
// 			let chkPrdt = prdtAry.prjctPrdtCd + prdtAry.prjctPrdtMctype;
// 		    if (countMap[chkPrdt] === undefined) {
// 		        countMap[chkPrdt] = 1;
// 		    } else {
// 		        countMap[chkPrdt]++;
// 		    }
// 		    prdtAry.prjctPrdtSeq = countMap[chkPrdt];
// 		}
		//백단에서 SELECT NVL(COUNT(*), 0) + 1 FROM TB_BM06D01 WHERE PRJCT_SEQ = #{prjctSeq} 으로  전체 건수를 산정하는것으로 변경함
		
		$.each(list,function(idx, obj) {
			if (obj.prdtUpd == 'U') {
				if (obj.prjctCrudChk != 'I') {
					obj.prjctCrudChk = 'U';
				}
				prdtArr.push(obj);
			}
		});

		formData.append("prdtArr", JSON.stringify(prdtArr));
		//제품-설비자료  끝		

		//세부 아이템 자료 준비
        if (saveWork) {
			prdtItemArr[prdtIdx] = PJ01GridView.target.list;
       		saveWork = false;
        }
		
		detailArr = [];
		$.each(prdtItemArr,function(prdtIdx, list) {
			if (list) {
// 			var list = PJ01GridView.target.list;
				$.each(list,function(idx, obj) {
					if (obj.itemUpd == 'U') {
						if (!obj.prjctItemCd && obj.isChk == 'Y') {
							obj.dtaChk = 'I';
							obj.prjctSeq = $("#prjctSeq").val();
							obj.prjctItemCd = obj.codeId;
							detailArr.push(obj);
						} else if (obj.prjctItemCd && obj.isChk == 'Y') {
							obj.dtaChk = 'U';
							detailArr.push(obj);
						} else if (obj.prjctItemCd && obj.isChk == 'N') {
							obj.dtaChk = 'D';
							detailArr.push(obj);
						}
					}
				});
			}
		});		

		formData.append("prdtItemArr", JSON.stringify(detailArr));//선택된 ROW 만 formData에 저장
		//세부 아이템 자료 끝
		
		return formData;
	}

	//  업체명 검색 //
	function clntSearch() {
		var paramObj = {
				"clntDivCd": "CLNTDIV12",
				"searchType": "CLNT_NM",
				"searchValue": $('#clntNm').val(),
			};
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", paramObj, function(grid) {
					var row = grid.target.getList("selected")[0];
// 					$('#prjctSeq').val(row.prjctSeq);
					$('#clntCd').val(row.clntCd);
					$('#clntNm').val(row.clntNm);
					$('#mngId').val(row.salesEmpId);
					$('#mngNm').val(row.salesEmpNm);

					var paramObj = {
						"coCd" : $('#coCd').val(),
						"clntCd" : row.clntCd
					}
// 					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
	function setMngInfo(paramObj) {
		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
				function(data) {
					if (data.mngInfo) {
						$('#mngId').val(data.mngInfo.salesEmpId);
						$('#mngNm').val(data.mngInfo.salesEmpNm);
					} else {
						$('#mngId').val("");
						$('#mngNm').val("");
					}
				});
	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"userNm": $('#mngNm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	
	function setByCoCd(value) {
		$('#coCd option:not([value="'+value+'"])').remove();
	}

	function pasFloatChk (value) {
		const cvtValue = parseFloat(deleteCommaStr(value));
		return isNaN(cvtValue) ? 0 : cvtValue;
	}	

	function pasIntComma (value) {
		const cvtValue = parseFloat(deleteCommaStr(value));
		return isNaN(cvtValue) ? 0 : addCommaStr(cvtValue);
	}	
	

    function insertProjectModal(row) {
		var paramObj = {
			"actionType"  : 'U',
			"fileTrgtKey" : row.fileTrgtKey,
			"coCd"        : row.coCd,
			"ordrsNo"	  : row.ordrsNo,
			"histNo"	  : row.histNo,
			"userId"      : jwt.userId,
			"pgmId"       : "CR0201M01"
		};
        openThirdModal("/static/html/user/cr/cr02/CR0202P01.html", 1800, 835, "", paramObj,  function(data) {
        	// DataSearch();
        });
    }	
    
    function gridResize(size) {
            let tagHeight = (size) * 27 + 80 ;
            tagHeight = tagHeight > 750 ? 750 : tagHeight;
            tagHeight = tagHeight < 300 ? 300 : tagHeight;
            PD01GridView.target.setHeight(tagHeight);
            PJ01GridView.target.setHeight(tagHeight);
    }
</script>