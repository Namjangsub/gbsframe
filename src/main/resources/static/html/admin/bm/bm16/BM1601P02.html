<style>
* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">프로젝트 이슈관리</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
      <input type="hidden" id="prjctSeq"  	name="prjctSeq">
      <input type="hidden" id="issNo"  		name="issNo">
      <input type="hidden" id="pgmId"     	name="pgmId" value="BM1601M01">
      <table>

        <colgroup>
          <col width="10%">
          <col width="20%">
          <col width="10%">
          <col width="20%">
        </colgroup>

        <tr>
         
          <th>업체명</th>
          <td>
            <input type="hidden" id="clntCd" name="clntCd" required msg="업체명" >
            <div class="search_form">
              <input type="text" id="clntNm" name="clntNm" maxlength="25" >
            </div>
          </td>
          <th>계약년월</th>
          <td>
            <input id="yyyymm" name="yyyymm" required msg="계약년월" data-search="yyyymm" date >
          </td>
        </tr>

        <tr>
          <th>프로젝트코드</th>
          <td>
            <input type="text" id="prjctCdNm" name="prjctCdNm" data-search="prjctCdNm" >
          </td>
          <th>프로젝트명</th>
          <td>
            <input type="text" id="prjctNm" name="prjctNm" data-search="prjctNm" >

          </td>
        </tr>

        <tr>
          <th>설비명</th>
          <td>
            <input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm" >
          </td>
          <th>수주예정일</th>
          <td>
            <input id="ordrsPlanDt" name="ordrsPlanDt" class="form-control" data-search="ordrsPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>
        </tr>

        <tr>
          <th>수량</th>
          <td>
            <input type="text" id="eqpQty" name="eqpQty" style="text-align: left;" >
          </td>
          <th>예상납기일</th>
          <td>
            <input id="dudtPlanDt" name="dudtPlanDt" class=" form-control" data-search="dudtPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>
		</tr>
        </tr>

        <tr>
          <th class="hit">이슈일자</th>
          <td>
            <input id="issDt" name="issDt" class="input_calendar form-control" data-search="issDt" autocomplete="off" onkeyup="dateMask(this);" date required msg="이슈일자">
          </td>        
          <th class="hit">진행상태</th>
          <td>
            <select id="issSts" name="issSts" data-kind="ISSSTS" data-search="issSts"  required msg="진행상태">
            </select>
          </td>

        </tr>

        <tr>
          <th></th>
          <td>
          </td>
          <th>완료일자</th>
          <td>
            <input id="actDt" name="actDt" class="input_calendar form-control" data-search="actDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>        


        </tr>

        <tr>
          <th class="hit">이슈내용</th>
          <td colspan="3">
            <textarea class="form-control" id="issCnts" name="issCnts" data-search="issCnts" style="height: 90px;" maxlength="3000" required msg="이슈내용"></textarea>
          </td>
        </tr>

        <tr>
          <th>원인</th>
          <td colspan="3">
            <textarea class="form-control" id="causeCnts" name="causeCnts" data-search="causeCnts" style="height: 90px;" maxlength="3000"></textarea>
          </td>
        </tr>

        <tr>
          <th>조치내용</th>
          <td colspan="3">
            <textarea class="form-control" id="actCnts" name="actCnts" data-search="actCnts" style="height: 90px;" maxlength="3000"></textarea>
          </td>
        </tr>

      </table>

    </form>

</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="prjctActionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">

var actionType = null;
var paramPrjctSeq = null;

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		$("#userId").val(jwt.userId);
		$('#issDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", moment(new Date()).toDate());
		$('#actDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", moment(new Date()).toDate());

		authChk();						// 권한체크

		actionType = modalStack.last().paramObj.actionType;
		paramPrjctSeq = modalStack.last().paramObj.prjctSeq;

		selectPrjctIssueInfo();	

	});

	function selectPrjctIssueInfo() {						//화면에 뿌리는 데이터
		
		$.each(modalStack.last().paramObj.row, function(key, value) {
			if ($('#popForm #' + key)[0]) {
				$('#popForm #' + key).val(value);
				if ($('#popForm #' + key).is('[comma]')) {
					onlyNumber($('#popForm #' + key)[0]);
				}
			}
		});
		$('#popForm #actDt').val(''); //기본 오늘날자이므로 clear

		var formData = {
			"prjctSeq" : paramPrjctSeq,
		}
		postAjax("/admin/bm/bm16/selectPrjctIssueInfo", formData, null, function(data) {
				if (data.result) {
					$.each(data.result, function(key, value) {
						if ($('#popForm #' + key)[0]) {
							$('#popForm #' + key).val(value);
							if ($('#popForm #' + key).is('[comma]')) {
								onlyNumber($('#popForm #' + key)[0]);
							}
						}
					});
					
					$('.tit').text('프로젝트 이슈 수정');

					$('#prjctActionBtn').text("수정");
					$('#prjctActionBtn').on("click", function() {
						updatePrjctIssueInfo();
					});
					
				} else {
					$("#prjctActionBtn").text("등록");
					$('#prjctActionBtn').on("click", function() {
						insertPrjctIssueInfo();
					});
				} 
					
		});
	}


	 // 등록
	function insertPrjctIssueInfo() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/admin/bm/bm16/insertPrjctIssue", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);								// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {							//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);								// 결과갑시 200인 경우 리드 뷰를 업데이트
							modalStack.close();									// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updatePrjctIssueInfo() {
		var dataRprc = $('#issSts option:selected').data('rprc');
		if (dataRprc == 'Y') {
			if ($('#actDt').val() == '' ) {
				alert("완료일자를 선택하세요!");
				return false;
			}
		}
		
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
	      	filePostAjax("/admin/bm/bm16/updatePrjctIssue", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}
	 /* 기존 저장과 중복 될 수 있음. 개별 저장 완료 후 수정 필요 */
/* 프로젝트 인서트, 업데이트 조건에 따른 간섭이 없는지 재확인 할 것 */

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		formData.append("userId", jwt.userId);
		
		return formData;
	}

	
</script>