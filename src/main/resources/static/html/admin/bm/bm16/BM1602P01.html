<style>
* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">프로젝트 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
      <input type="hidden" id="prjctInfo" style="display: none" multiple="multiple" onchange="setPrjct(this);">
      <input type="text" id="prjctSeq"  name="prjctSeq">
      <input type="hidden" id="pgmId"     name="pgmId" value="BM1601M01">
      <table>

        <colgroup>
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="19%">
        </colgroup>

        <tr>

          <th class="hit">회사</th>
          <td>
            <select id="coCd" name="coCd" data-kind="CO" required="required" >
            </select>
          </td>
          <th class="hit">업체명</th>
          <td>
            <input type="hidden" id="clntCd" name="clntCd" required>
            <div class="search_form">
              <input type="text" id="clntNm" name="clntNm" maxlength="25">
              <a onclick="clntSearch();">
                <i class="i_search_w"></i>
              </a>
            </div>
          </td>

          <th class="hit">계약년월</th>
          <td>
            <input id="yyyymm" name="yyyymm" class="input_calendar" msg="계약년월" data-search="yyyymm" date>
        </tr>

        <tr>
          <th>국내/국외</th>
          <td>
            <select data-kind="INPEXP" id="inpexpCd" name="inpexpCd" style="text-align: center;">
            </select>
          </td>

          <th class="hit">업체담당자</th>
          <td>
            <div class="search_form">
              <input type="text" id="clntMngNm" name="clntMngNm" class="form-control" required>
          </td>
          <th>구매방법</th>
          <td>
            <select id="odrCd" name="odrCd" data-search="odrCd" data-kind="PCHORD" style="text-align: center;">
             </select>
          </td>
        </tr>

        <tr>
          <th class="hit">프로젝트코드</th>
          <td>
            <input type="text" id="prjctCd" name="prjctCd" data-search="prjctCd" class="form-control" required>
          </td>

          <th class="hit">프로젝트명</th>
          <td>
            <input type="text" id="prjctNm" name="prjctNm" data-search="prjctNm" required>

          </td>
           <th>신규여부</th>
               <td>
                  <select id="newPrdtCd" name="newPrdtCd" data-kind="BIZDIV" style="text-align: center;">
                   </select>
               </td>
        </tr>

        <tr>
          <th  class="hit">설비명</th>
          <td>
            <input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm" required>
          </td>

          <th  class="hit">수량</th>
          <td>
            <input type="text" id="eqpQty" name="eqpQty" class="form-control" style="text-align: right;">
          </td>

          <th  class="hit">예상물량</th>
          <td>
            <input type="text" id="epctAmt" name="epctAmt" class="form-control" comma required>
          </td>
          </td>
        </tr>

        <tr>
          <th>영업상황</th>
          <td colspan="3">
            <input type="text" id="winbdRmk" name="winbdRmk">
          </td>
          <th class="hit">수주목표</th>
          <td>
            <input type="text"  id="ordrsPlanAmt" name="ordrsPlanAmt" comma required>
          </td>
        </tr>

        <tr>
          <th>예상납기일</th>
          <td>
            <input id="dudtPlanDt" name="dudtPlanDt" class="input_calendar form-control" data-search="dudtPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>수주예정일</th>
          <td>
            <input id="ordrsPlanDt" name="ordrsPlanDt" class="input_calendar form-control" data-search="ordrsPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>수주금액</th>
          <td>
            <input type="text" id="ordrsAmt" name="ordrsAmt" comma>
           </td>
        </tr>

        <tr>
          <th class="hit">영업담당자</th>
          <td>
             <div class="search_form">
                  <input type="hidden" id="mngId" name="mngId" class="form-control" required>
                  <input type="text" id="mngNm" name="mngNm" class="form-control" required>
                 <a onclick="openUserTree();">
                <i class="i_search_w"></i>
              </a></div>
          </td>
          <th>수주확정</th>
          <td>
            <select id="winbdCd" name="winbdCd" data-kind="YN" data-search="winbdCd" >
            </select>
          </td>
          <th>미수주금액</th>
          <td>
              <input type="text" id="unordrsAmt2" name="unordrsAmt"  money style="text-align: right;" >
          </td>
        </tr>
        <tr>
          <th>수주가치</th>
          <td>
            <input type="text" id="odrRmk" name="odrRmk" class="form-control" money>
          </td>
          <th>수주일</th>
          <td>
            <input type="text" id="ordrsDt" name="ordrsDt" class="input_calendar form-control"  data-search="ordrsDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>
          <th>수주확률</th>
          <td>
               <select type="text" id="ordrsPct" name="ordrsPct" >
                    <option value="10" selected>선택</option>
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="50">50%</option>
                    <option value="100">100%</option>
              </select>
          </td>
        </tr>
        <tr>
          <th>비고</th>
          <td colspan="5">
            <textarea class="form-control" id="prjctRmk" name="prjctRmk" style="height: 60px;" maxlength="500"></textarea>
          </td>
        </tr>

      </table>

      </form>
</div>
	  <!-- 콘텐츠 -->
	    <div class="contents">
	      <!-- 리스트 -->
	      <div class="ax5_grid">
	        <ul class="ul_list type02">
	            <li>
	                <div class="table_list_tit">
	                    <h5 class="tit">대상설비</h5>
	                    <div class="add_btn_small">
	                        <a onclick= "updatePrdtList('C')" style="width: 50px;" authchk><i class="fas fa-folder-plus"></i> 등록</a>
	                        <a onclick= "updatePrdtList('U')" style="width: 50px;" authchk><i class="fas fa-money-check"></i> 수정 </a>
	                        <a onclick= "deletePrdtList(prdtIdx)" style="width: 50px;" authchk><i class="fas fa-trash"></i> 삭제 </a>
	                    </div>
	                </div>
	                <div>
	                <div data-ax5grid="PD01-grid" data-ax5grid-config="{}" style="height:300px; width: 100%" ></div>
	                </div>
	                
	            </li>
	            <li>
	                <div class="table_list_tit">
	                    <h5 class="tit">아이템 상세 내역</h5>
	                     <div class="add_btn_small">
	                    </div>
	                </div>
	                  <div>
	                <div data-ax5grid="PJ01-grid" data-ax5grid-config="{}" style="height: 300px; width: 100%" ></div>
	                </div>
	            </li>
	        </ul>	
	    </div>
	  </div>
	</div>
	
      <br>
	<div class ="popup_bottom_btn">
		<button type="button" id="prjctActionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>



<script type="text/javascript">

var actionType = null;
var paramPrjctSeq = null;
var prdtArr = [];
var prdtDeleteArr = [];
var detailArr = []; 
var firstGrid = null;
var secondGrid = null;
var prdtIdx = null;		//제품선택병경 체크용 인덱스	
var saveWork = false;	//제품 아이템 수정 내역 체크
var savePrdtCd = null;	//제품선택변경 체크용
var itemArr = [];
var deleteItemArr = [];

var PD01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="PD01-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: false
		         },
		         body: {
			        	 onClick: function () {
			                this.self.select(this.dindex);
			                prdtIdx = this.dindex;
			                if ((savePrdtCd != this.item.prjctPrdtCd) && saveWork) {
		                		if(confirm('아이템 수정내역이 있습니다. 저장하시겠습니다까?')){	
				                	if (actionType == "C") {
			                			insertPrjct();
				                	} else {
			                			updatePrjct();
			                		}
			                	}
		                		saveWork = false;
			                }
			                PJ01GridView.setData(this.item.prjctPrdtCd);
			                savePrdtCd = this.item.prjctPrdtCd;
			        	 },
						 onDBLClick: function () {
						 	updatePrdtList('U');
						 },

			             onDataChanged: function () {
			            	 if (this.item.__selected__ == true) {
// 			                		var index = this.dindex;
			                		savePrdtCd = this.item.prjctPrdtCd;
			                }
			            	 //제품내역 수정이 있으면 저장 필요
			            	saveWork = true;
			            	this.item.prdtUpd = 'U';
			             },
	             },
		        columns : [
		            {key : "prjctSeq",  		label : "프로젝트시퀀스",   width : 30,	hidden: true}
		           ,{key : "prjctInpexpCd",  	label : "국내외",     width : 60,	hidden: true}
		           ,{key : "prjctInpexpNm",  	label : "국내외",     width : 60,	hidden: false}
		           ,{key : "prjctPrdtNewCd",  	label : "신규여부",    width : 60,	hidden: true}
		           ,{key : "prjctPrdtNewNm",  	label : "신규여부",    width : 60,	hidden: false}
		           ,{key : "prjctPrdtCd",  		label : "제품코드",   width : 60,	hidden: true}
		           ,{key : "prdtNm",  			label : "제품유형",   width : 120,	hidden: false}
		           ,{key : "prjctPrdtQty",  	label : "대수",      	width : 60,	hidden: false}
		           ,{key : "prjctPrdtOrdrsDt",  label : "수주일자",    width : 80,	hidden: false}
		           ,{key : "prjctPrdtPlanDt",  	label : "납기일자",    width : 80,	hidden: false}
		           ,{key : "prjctPrdtRmk", 		label : "특이사항",   	width : 190}
		           ,{key : "prjctCrudChk", 		label : "CRUD",   width : 100,	hidden: true}
			     ]
		    });
			return this;
		},


        setData: function(){
			 var target = this.target;
       		 var formData = {
					"prjctSeq" 		: paramPrjctSeq,
//       				"pageNo" 		: _pageNo + 1,
//       				"recordCnt" 	: $("#recordCnt").val()
       		 }

    		postAjax("/admin/bm/bm16/selectPrdtList", formData, null, function(data) {
				var list = data.prdtList;
				target.setData({
            		list : list,
            		page : {
            			totalElements : list.length				 	//그리드 하단 파일 수 표시용
            		}
       			 });
    	 	});
     	   }
        }


var PJ01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: true,
		    	 sortable: false,
		         target: $('[data-ax5grid="PJ01-grid"]'),
		         header: {
			        		 align: "center",
			        		 selector: false
		        },
		        body: {
  			        	 onClick: function () {
  			                this.self.select(this.dindex);

			            },
			            	onDBLClick: function () {
		
			            },
			            onDataChanged: function () {
			            	//아이템 상세내역이 수정이 있으면 저장 필요
			            	saveWork = true;
			            	this.item.itemUpd = 'U';
			            },
		        },
		        columns : [
		               {key : "isChk",    		label : "선택",   		width : 80,
	          	  			editor: {type: "checkbox",	config: {trueValue : "Y",	falseValue : "N"}}}
	                  ,{key : "prjctSeq",  		label : "프로젝트시퀀스", 	width : 40}
	                  ,{key : "prjctPrdtCd",  	label : "제품코드", 	hidden: true}
		              ,{key : "codeId",			label : "코드아이디",  hidden: true}
		              ,{key : "prjctItemCd", 	label : "등록아이템코드", 	width : 100,   hidden: true}
		              ,{key : "codeNm",  	  	label : "아이템내역",     	width : 200,}
		              ,{key : "prjctItemRmk", 	label : "비고",   		width : 208,  editor: {type: "textarea"}}
		         	]
		    });
			return this;
		},

		setData: function(prdtCd){
			secondGrid = this.target;
// 			var row = PD01GridView.target.getList("selected")[0];
			
			if (prdtCd) {
	   		 	var formData = {
					"prjctSeq" 		: paramPrjctSeq,
	        		"prjctPrdtCd" 	: prdtCd  
	   		 	}
	
				postAjax("/admin/bm/bm16/selectItemList", formData, null, function(data) {
						var list = data.itemList;
						secondGrid.setData({
							list : list,
							page : {
								totalElements : list.length
							}
				     	});
				});
			}
		}
}

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		$("#userId").val(jwt.userId);
		$("#pgmId").val(jwt.pgmId);
// 		$("#clntNm").val(jwt.clntNm);
// 		$("#coCd").val(jwt.coCd)
		//계약년월//
		$('#yyyymm').datepicker({
			format : "yyyy-mm",
			language : "ko",
			autoclose : true,
			minViewMode: "months"
		}).datepicker("setDate", "today");
		//예상납기//
		$('#dudtPlanDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		//수주예정//
		$('#ordrsPlanDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		//수주일//
		$('#ordrsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");


		// 저장/수정 기능(원복)
		actionType = modalStack.last().paramObj.actionType;
		paramPrjctSeq = modalStack.last().paramObj.prjctSeq;

		authChk();						// 권한체크

		PD01GridView.initView().setData(0);
		PJ01GridView.initView().setData(0);
		
		//변수 actionType을 선언하고, modalStack.last().paramObj.actionType의 값을 할당
		if (actionType == "C") {
			$("#prjctActionBtn").text("등록");
			$('#prjctActionBtn').on("click", function() {
				insertPrjct();
			});

		} else if (actionType == "U") {
	
			selectPrjctInfo();				//프로젝트 정보 호출

			$('#prjctActionBtn').text("수정");
			$('#prjctActionBtn').on("click", function() {
				updatePrjct();
			});
		}

	});

	function selectPrjctInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"prjctSeq" : paramPrjctSeq,
		}
		postAjax("/admin/bm/bm16/selectPrjctInfo", formData, null, function(data) {
			
				$.each(data.result, function(key, value) {
					if ($('#' + key)[0]) {
						$('#' + key).val(value);
						if ($('#' + key).is('[comma]')) {
							onlyNumber($('#' + key)[0]);
						}
					}
				});
				var prdtList = data.result.prdtList;
// 				var itemList = data.result.itemList;
				
				PD01GridView.setData(0); 		//첫 번째 그리드의 데이터를 불러오기
				PJ01GridView.setData(prdtList[0].prjctPrdtCd); 
				savePrdtCd = prdtList[0].prjctPrdtCd;
				prdtIdx = 0;
		});
	}


	//-----아래로 인서트,업데이트 PrdtList , ItemList 개별 저장 ----------------------//
    //--  SD0601M01 복사 수정 본 참고자료-----  //

	function updatePrdtList(type){
		
		if ( type == 'U') {
			if (selectGridValidation(PD01GridView.target))
				return;
			var paramObj = PD01GridView.target.getList("selected")[0];
				paramObj["prdtActionType"] = type;
		} else {
			var paramObj = {prdtActionType : type};
		}
		
		openSecondModal("/static/html/admin/bm/bm16/bm1602d01.html", 690, 280, "대상설비", paramObj, function (rtnData) {
			var idx; //수정이면 이전 인덱스에 해당하는 값을 대체, 아니면 추가
			var crudChk;
			
			if ( type == 'U') {
				idx = PD01GridView.target.getList("selected")[0].__index;
				crudChk = 'U';
			} else {
				idx = PD01GridView.target.getList().length;
				crudChk = 'I';
			}
			
			PD01GridView.target.list[idx] = {
				  prjctSeq			: 0,  //처음 파라메터 프로젝트 키값
				  prjctInpexpCd		: rtnData.prjctInpexpCd,
				  prjctInpexpNm		: rtnData.prjctInpexpNm,
				  prjctPrdtNewCd	: rtnData.prjctPrdtNewCd,
				  prjctPrdtNewNm	: rtnData.prjctPrdtNewNm,
				  prjctPrdtCd		: rtnData.prjctPrdtCd,
				  prdtNm			: rtnData.prdtNm,
				  prjctPrdtQty		: rtnData.prjctPrdtQty,
				  prjctPrdtOrdrsDt	: rtnData.prjctPrdtOrdrsDt,
				  prjctPrdtPlanDt	: rtnData.prjctPrdtPlanDt,
				  prjctPrdtRmk		: rtnData.prjctPrdtRmk,
				  __index			: idx,
				  prjctCrudChk		: crudChk,
        		  prdtUpd			:'U'
			};
           	saveWork = true;
			PD01GridView.target.repaint();
				
		});
	}

	
	function deletePrdtList(idx){
		if (selectGridValidation(PD01GridView.target))
			return;
		var obj = PD01GridView.target.getList("selected")[0];
		if (obj.prjctSeq) {
			obj.prjctCrudChk = 'D';   //DB에 등록된 자료인 경우 삭제 로 저장
			prdtDeleteArr.push(obj);
		}
		PD01GridView.target.list.splice(idx,1);
		PD01GridView.target.repaint();
	}


	 // 등록
	function insertPrjct() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();															// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/admin/bm/bm16/insertPrjct", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
						alert(data.resultMessage);														// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {													//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							gridView.setData(0);																// 결과갑시 200인 경우 리드 뷰를 업데이트
							modalStack.close();																  // 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updatePrjct() {
		if (inputValidation($('.popup_area [required]'))) {									// 필수 필드의 유효성 검사
			var formData = makeFormData();																		// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
	      	filePostAjax("/admin/bm/bm16/updatePrjct", formData,function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {
							gridView.setData(0);
// 							modalStack.close();
							selectPrjctInfo();
						}
					});
		}
	}
	 /* 기존 저장과 중복 될 수 있음. 개별 저장 완료 후 수정 필요 */
/* 프로젝트 인서트, 업데이트 조건에 따른 간섭이 없는지 재확인 할 것 */

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		// 유저아이디 추가
		formData.append("userId", jwt.userId);

		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		$.each(itemArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
			}
				//  itemArr 배열의 각 항목에 대해 반복하면서 obj.fileKey가 0인 경우에만 formData 객체에 "files"라는 키와 obj.file을 추가합니다.
		});

		formData.append("deleteItemArr", JSON.stringify(deleteItemArr));
		if (actionType == "D") {
			formData.append("deleteItemArr", JSON.stringify(deleteItemArr));
		}
		//--첨부화일 처리를 위한 부분 끝

		//제품-설비자료 준비
		prdtArr = prdtDeleteArr.slice(0);
		var list = PD01GridView.target.list;
		$.each(list,function(idx, obj) {
			if (obj.prdtUpd == 'U') {
				if (obj.prjctCrudChk != 'I') {
					obj.prjctCrudChk = 'U';
				}
				prdtArr.push(obj);
			}
		});
		
		formData.append("prdtArr", JSON.stringify(prdtArr));
		//제품-설비자료  끝		
debugger;
		//세부 아이템 자료 준비
		var list = PJ01GridView.target.list;
		detailArr = [];
		$.each(list,function(idx, obj) {
			if (obj.itemUpd == 'U') {
				if (!obj.prjctItemCd && obj.isChk == 'Y') {
					obj.dtaChk = 'I';
					obj.prjctSeq = $("#prjctSeq").val();
					obj.prjctPrdtCd = savePrdtCd;
					obj.prjctItemCd = obj.codeId;
					
					detailArr.push(obj);
				} else if (obj.prjctItemCd && obj.isChk == 'Y') {
					obj.dtaChk = 'U';
					detailArr.push(obj);
				} else if (obj.prjctItemCd && obj.isChk == 'N') {
					obj.dtaChk = 'D';
					detailArr.push(obj);
				}
			}
		});

		formData.append("detailArr", JSON.stringify(detailArr));//선택된 ROW 만 formData에 저장
		//세부 아이템 자료 끝
		
		return formData;
	}
debugger;
	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
// 					$('#prjctSeq').val(row.prjctSeq);
					$('#clntCd').val(row.clntCd);
					$('#clntNm').val(row.clntNm);
					$('#mngId').val(row.salesEmpId);
					$('#mngNm').val(row.salesEmpNm);

					var paramObj = {
						"coCd" : $('#coCd').val(),
						"clntCd" : row.clntCd
					}
// 					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
	function setMngInfo(paramObj) {
		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
				function(data) {
					if (data.mngInfo) {
						$('#mngId').val(data.mngInfo.salesEmpId);
						$('#mngNm').val(data.mngInfo.salesEmpNm);
					} else {
						$('#mngId').val("");
						$('#mngNm').val("");
					}
				});
	}

	//  업체담당자 검색 //
	function openUserTree(gbn) {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
// 			$("#deptNm_S").val(checkedNode.original.deptNm);
// 			$("#deptId_S").val(checkedNode.parent);
		});
	}
	
	
	
	function setByCoCd(value) {
		$('#coCd').data("desc", value);
		$('#coCd option:not([value=""])').remove();
		setCommonSelect($('#coCd'));
	}

</script>