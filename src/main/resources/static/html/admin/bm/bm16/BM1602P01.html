<style>
* input[comma] {
  text-align: right;
 }
</style>

<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">프로젝트 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
      <input type="hidden" id="prjctInfo" style="display: none" multiple="multiple" onchange="setPrjct(this);">
      <table>
        <colgroup>
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="18%">
          <col width="15%">
          <col width="19%">
        </colgroup>

        <tr>
          <th class="hit">회사</th>
          <td>
            <select id="coCd" name="coCd" data-kind="CO" required="required" >
            </select>
          </td>
          <th class="hit">업체명</th>
          <td>
            <input type="hidden" id="clntCd" name="clntCd">
            <div class="search_form">
              <input type="text" id="clntNm" name="clntNm" maxlength="25">
              <a onclick="clntSearch();">
                <i class="i_search_w"></i>
              </a>
            </div>
          </td>

          <th class="hit">계약년월</th>
          <td>
            <input id="yyyymm" name="yyyymm" class="input_calendar" msg="계약년월" data-search="yyyymm">
        </tr>

        <tr>
          <th>국내/국외</th>
          <td>
            <select data-kind="INPEXP" id="inpexpCd" name="inpexpCd" style="text-align: center;">
            </select>
          </td>

          <th>업체담당자</th>
          <td>
            <input type="hidden" id="clntMng" name="clntMng" >
            <div class="search_form">
              <input type="text" id="clntMngNm" name="clntMngNm" class="form-control">
                <a onclick="clntSearch2();">
                <i class="i_search_w"></i>
              </a>
          </td>
          <th>구매방법</th>
          <td>
            <select id="odrCd" name="odrCd" data-search="odrCd" data-kind="PCHORD" style="text-align: center;">
             </select>
          </td>
        </tr>

        <tr>
          <th class="hit">프로젝트코드</th>
          <td>
            <input type="text" id="prjctCd" name="prjctCd" data-search="prjctCd" class="form-control">
          </td>

          <th>프로젝트명</th>
          <td>
            <input type="text" id="prjctNm" name="prjctNm" data-search="prjctNm">

          </td>
           <th>신규여부</th>
               <td>
                  <select id="newPrdtCd" name="newPrdtCd" data-kind="BIZDIV" style="text-align: center;">
                   </select>
               </td>
        </tr>

        <tr>
          <th>설비명</th>
          <td>
            <input type="text" id="eqpNm" name="eqpNm" data-search="eqpNm">
          </td>

          <th>수량</th>
          <td>
            <input type="text" id="eqpQty" name="eqpQty" class="form-control" style="text-align: right;">
          </td>

          <th>예상물량</th>
          <td>
            <input type="text" id="epctAmt" name="epctAmt" class="form-control" comma>
          </td>
          </td>
        </tr>

        <tr>
          <th>영업상황</th>
          <td colspan="3">
            <input type="text" id="winbdRmk" name="winbdRmk">
          </td>
          <th>수주목표</th>
          <td>
            <input type="text"  id="ordrsPlanAmt" name="ordrsPlanAmt" comma>
          </td>
        </tr>

        <tr>
          <th>예상납기일</th>
          <td>
            <input id="dudtPlanDt2" name="dudtPlanDt" class="input_calendar" class="form-control" data-search="dudtPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>수주예정일</th>
          <td>
            <input id="ordrsPlanDt2" name="ordrsPlanDt" class="input_calendar" class="form-control" data-search="ordrsPlanDt" autocomplete="off" onkeyup="dateMask(this);" date>
          </td>

          <th>수주금액</th>
          <td>
            <input type="text" id="ordrsAmt" name="ordrsAmt" comma>
           </td>
        </tr>

        <tr>
          <th>영업담당자</th>
          <td>
             <div class="search_form">
                  <input type="text" id="mngId" name="mngId" class="form-control">
                 <a onclick="setMngInfo(paramObj);">
                <i class="i_search_w"></i>
              </a></div>
          </td>
          <th>수주확정</th>
          <td>
            <select id="winbdCd" name="winbdCd" data-kind="YN" data-search="winbdCd" >
            </select>
          </td>
          <th>미수주금액</th>
          <td>
              <input type="text" id="unordrsAmt" name="unordrsAmt"  money style="text-align: right;" >
          </td>
        </tr>
        <tr>
          <th>수주가치</th>
          <td>
            <input type="text" id="odrRmk" name="odrRmk" class="form-control" money>
          </td>
          <th>수주일</th>
          <td>
            <input type="text" id="ordrsDt2" name="ordrsDt" class="input_calendar" autocomplete="off">
          </td>
          <th>수주확률</th>
          <td>
               <input type="text" id="ordrsPct" name="ordrsPct" style="text-align: right;">

          </td>
        </tr>
        <tr>
          <th>비고</th>
          <td colspan="5">
            <textarea class="form-control" id="prjctRmk" name="prjctRmk" style="height: 60px;" maxlength="500"></textarea>
          </td>
        </tr>

      </table>
                          <input type="text"   id="prjctSeq"     name="prjctSeq">
                    <input type="hidden"   id="prjctPrdtCd"  name="prjctPrdtCd">
                    <input type="hidden"   id="prjctItemRmk" name="prjctItemRmk">
                    <input type="hidden"   id="prjctRmk"     name="prjctRmk">

      </form>
</div>

    <div class="contents">
	      <!-- 리스트 -->
	    <div class="ax5_grid">
	        <ul class="ul_list type02">
	            <li>
	                <div class="table_list_tit">
	                    <h5 class="tit">대상설비</h5>
	                      <div class="add_btn_small">
                            <a onclick="updatePrdtList('C');" style="height: 25px; line-height: 25px;" authchk><i class="fas fa-plus"></i>등록</a>
                            <a onclick="updatePrdtList('U');" style="height: 25px; line-height: 25px;" authchk><i class="fas fa-minus"></i>수정</a>
                          </div>
                      </div>
                      <div>
    	                   <div data-ax5grid="PD01-grid" data-ax5grid-config="{}" style="height:400px; width: 100%" >
                           </div>
    	              </div>
        	      </li>
        	      <li>
  	                <div class="table_list_tit">
  	                    <h5 class="tit">아이템 상세 내역</h5>
                          <div class="add_btn_small">
                           <a onclick="updateItemList('C');" style="height: 25px; line-height: 25px;" authchk><i class="fas fa-plus"></i>등록</a>
                            <a onclick="updateItemList('U');" style="height: 25px; line-height: 25px;" authchk><i class="fas fa-minus"></i>수정</a>
                          </div>

            	             <div data-ax5grid="PJ01-grid" data-ax5grid-config="{}" style="height: 400px; width: 100%" >
                             </div>
                         </div>
                         </div>
                    </li>
                </ul>
         </div>
      <br>
				<div>
					<button type="button" id="prjctActionBtn" authChk>등록</button>
					<button type="button" class="close_btn"
						onclick="modalStack.close();">닫기</button>
				</div>



<script type="text/javascript">
debugger;
var actionType = null;
var prdtArr = [];
var firstGrid = null;
var secondGrid = null;

var PD01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: false,
		    	 sortable: false,
		         target: $('[data-ax5grid="PD01-grid"]'),
		         header: {
		        		 align: "center",
		        		 selector: false
		         },
		         body: {
			        	 onClick: function () {
			                this.self.select(this.dindex);
			                 $("#prjctSeq").val( this.item.prjctSeq );
			                 $("#prjctPrdtCd").val( this.item.prjctPrdtCd );

			                PJ01GridView.initView().setData(0);
			                /*현재 그리드는 PD01Grid(첫번째) 이거 누르면 PK인prjctSeq를 기준으로
			                  프로젝트그리드(두번째)를 다시 그려라 */
	            },
	            onDBLClick: function () {
	            },
	        },
		        page: {
		            navigationItemCount: 9,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	gridView.setData(this.page.selectPage);
		            }
		        },
		        columns : [
		            {key : "prjctSeq",  	label : "프로젝트시퀀스",   width : 80, hidden: true}
		           ,{key : "prjctPrdtCd",  	label : "설비코드",      	width : 105}
		           ,{key : "prdtNm",  		label : "대상설비",      	width : 250}
		           ,{key : "prjctItemRmk", 	label : "특이사항",   		width : 250,  editor: {type: "textarea"}}
			     ]
		    });
			return this;
		},

        setData: function(){
			 $("#prjctSeq").val("");
        		PJ01GridView.initView().setData(0);

        		firstGrid = this.target;

//     		postAjax("/admin/bm/bm16/selectPrdtList", formData, null, function(data) {
// 				var list = prjctInfo.prdtList;

				firstGrid.setData({
            		list : prdtArr,
            		page : {
            			totalElements : prdtArr.length
            		}
       			 });
//     	 	});
     	   }
        }


var itemArr = [];
var deleteItemArr = [];
var PJ01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	 showRowSelector: true,
		    	 multipleSelect: true,
		    	 sortable: false,
		         target: $('[data-ax5grid="PJ01-grid"]'),
		         header: {
			        		 align: "center",
			        		 selector: false
		        },
		        body: {
  			        	 onClick: function () {
  			                this.self.select(this.dindex);
			                $("#prjctSeq").val(this.item.prjctSeq);

	            },
	            onDBLClick: function () {

	            },
	        },
		        page: {
		            navigationItemCount: 9,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	gridView.setData(this.page.selectPage);
		            }
		        },
		        columns : [
// 		        	  {key : "isChk",    		label : "선택",   		width : 80,
// 		          	  		editor: {type: "checkbox",	config: {height : 20,	trueValue : "Y",	falseValue : "N"}}}
	                  {key : "prjctSeq",  		hidden: true}
		              ,{key : "codeId",			label : "코드아이디",  		hidden: true}
		              ,{key : "prjctItemCd", 	label : "등록아이템코드", 	width : 100}
		              ,{key : "codeNm",  		label : "아이템내역",      	width : 205}
		              ,{key : "prjctRmk", 		label : "비고",   			width : 300,  editor: {type: "textarea"}}

		         	]
		    });
			return this;
		},
		setData: function(){
			secondGrid = this.target;

			// 페이징 전체 유무
			var recordCnt = $("#recordCnt").val();
			if(recordCnt == '9999'){formData.pageNo = 1;}

// 		postAjax("/admin/bm/bm16/selectItemList", formData, null, function(data) {
// 				var list = prjctInfo.itemList;

       // isChk 값이 true인 데이터만 itemArr에 추가
//         for(var i=0; i<list.length; i++) {
//             if(list[i].isChk == true) {
//                 itemArr.push(list[i]);
//             }
//         }

			secondGrid.setData({
				list : itemArr,
				page : {
					totalElements : itemArr.length
				}
	     });
// 	});
	}
}

	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
// 		$("#userId").val(jwt.userId);
// 		$("#pgmId").val(jwt.pgmId);
// 		$("#clntNm").val(jwt.clntNm);
// 		$("#coCd").val(jwt.coCd)
// 		$("#popForm #ordrsAmt").attr("disabled", true); //수주금액은 호출만


		  // 저장/수정 기능(원복)
		var actionType = modalStack.last().paramObj.actionType;
		if (actionType == "C") {

			$("#prjctActionBtn").text("등록");
			$('#prjctActionBtn').on("click", function() {
				insertPrjct();
			});
		} else if (actionType == "U") {
			PD01GridView.initView();
			PJ01GridView.initView();

			$('#prjctActionBtn').text("수정");
			$('#prjctActionBtn').on("click", function() {
				updatePrjct();
			});
		}

		//계약년월//
		$('#yyyymm2').datepicker({
			format : "yyyy-mm",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		//예상납기//
		$('#dudtPlanDt2').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		//수주예정//
		$('#ordrsPlanDt2').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");
		//수주일//
		$('#ordrsDt2').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", "today");

	// 그리드 초기화
		PJ01GridView.initView(0);
		PD01GridView.initView();

	//아이템 상세내역 관련
		selectPrjctInfo();

	//미수주금액, 수주확률 계산
		calculateunodrs();

// 권한체크
		authChk();
	});


    var prjctDtl;
	function setPrjctInfo(obj) {
		var itemInfo = obj.itemList;
// 		var prdtInfo = obj.prdtList;
		var prjctInfo = obj;
		prjctDtl = obj.prjctDtl;

		//메인정보 세팅
		$.each(prjctInfo, function(key, value) {
			$('#' + key).val(value);

			// 수주확정 set
			if (key == "winbdCd" && value == "Y") {
				$('#' + key).prop("checked", true);
			}
		});
	}

	function selectPrjctInfo() {
		var row = gridView.target.getList("selected")[0];
		var formData = {
			"prjctSeq" : row.prjctSeq,
			"mngId" : row.mngId,
			"newPrdtCd" : row.newPrdtCd,
// 			"newPrdtNm" : row.newPrdtNm
		}
		postAjax("/admin/bm/bm16/selectPrjctInfo", formData, null, function(
				data) {
			setPrjctInfo(data.result);
		});
	}

	function setPrjctInfo(prjctInfo) {
		//기본정보 set
		$.each(prjctInfo, function(key, value) {
			if ($('#' + key)[0]) {

				console.log(key + " :: " + value);
				$('#' + key).val(value);
				if ($('#' + key).is('[comma]')) {
					onlyNumber($('#' + key)[0]);
				}
			}
		});

		prdtArr = prjctInfo.prdtList;
		itemArr = prjctInfo.itemList;

// 		//첫 번째 그리드의 데이터를 불러오기
		PD01GridView.setData(prjctInfo.prdtList);
// 		//두 번째 그리드의 데이터를 불러오기
		PJ01GridView.setData(prjctInfo.itemList);

	}

	//-----아래로 인서트,업데이트 PrdtList , ItemList 개별 저장 ----------------------//
    //--  SD0601M01 복사 수정 본 참고자료-----  //

	function updatePrdtList(type){
		actionType = type;

		if ( actionType == 'U' && selectGridValidation(firstGrid))
			return;

		openSecondModal("/static/html/admin/bm/bm16/bm1602d01.html", 500, 200, "대상설비");
         // 중복 모달 창 띄우기
      			$('#prjctSeq').val(row.prjctSeq);
      			$('#prjctPrdtCd').val(row.prjctPrdtCd);
      			$('#prjctItemRmk').val(row.prjctItemRmk);
	}

	function updateItemList(type){
		//updatePrdDtltList로 계획했으나 ItemList를 재활용하는 것이 맞을듯.
		actionType = type;

		if ( actionType == 'U' && selectGridValidation(secondGrid))
			return;

		if ( actionType == 'C' && selectGridValidation(firstGrid))
			return;

		openSecondModal("/static/html/admin/bm/bm16/bm1602d02.html", 500, 200, "아이템상세내역");

	}

	//-----인서트,업데이트,삭제 구문 ----------------------//
 /* 기존 저장과 중복 될 수 있음. 개별 저장 완료 후 수정 필요 */

	 // 등록
	function insertPrjct() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			filePostAjax("/admin/bm/bm16/insertPrjct", formData,
					function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {

							gridView.setData(0);
// 							PD01GridView.gridView.setData(0);
// 							PJ01GridView.gridView.setData(0);

							modalStack.close();
						}
					});
		}
	}

	// 수정
	function updatePrjct() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			filePostAjax("/admin/bm/bm16/updatePrjct", formData,
					function(data) {
						alert(data.resultMessage);
						if (data.resultCode == 200) {

							gridView.setData(0);
// 							PD01GridView.gridView.setData(0);
// 							PJ01GridView.gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}
	 /* 기존 저장과 중복 될 수 있음. 개별 저장 완료 후 수정 필요 */
/* 프로젝트 인서트, 업데이트 조건에 따른 간섭이 없는지 재확인 할 것 */

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		// 유저아이디 추가
		formData.append("userId", jwt.userId);

		//-------itemarr
		$.each(itemArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
			}
		});
		//-------prdtArr
		$.each(prdtArr, function(idx, obj) {
			if (obj.fileKey == 0) {
				formData.append("files", obj.file);
			}
		});

		formData.append("deleteItemArr", JSON.stringify(deleteItemArr));
		if (actionType == "D") {
			formData.append("deleteItemArr", JSON.stringify(deleteItemArr));
		}

		//-----인서트,업데이트,삭제 때 사용하는 구문. ----------------------//
		var list = PJ01GridView.target.list; //상세내역 그리드 항목에 있는 내용이 담겨있는 자료들의 집합
                                             //PD01쪽 데이터를 추후 고려할 것
// 		var list = PD01GridView.target.list;


		var detailArr = []; // 처리할 대상 자료만 모아놓을 자료배열변수
		$.each(list,
				function(idx, obj) {
					if ((!obj.prjctItemCd || obj.prjctItemCd == "")
							&& obj.isChk == 'Y') {
						obj.dtaChk = 'I';
						obj.prjctPrdtCd = 1;
						obj.prjctSeq = $("#prjctSeq").val();
						detailArr.push(obj);
					} else if (obj.prjctItemCd && obj.isChk == 'Y') {
						obj.dtaChk = 'U';
						//     				obj.prjctPrdtCd = 1 ;
						detailArr.push(obj);
					} else if (obj.prjctItemCd && obj.isChk == 'N') {
						obj.dtaChk = 'D';
						detailArr.push(obj);
					}
				});

		formData.append("detailArr", JSON.stringify(detailArr));//선택된 ROW 만 formData에 저장
		return formData;
	}

	//-----위로 인서트,업데이트,삭제 구문 ----------------------//



	//-----아래로 검색용 함수, ETC ----------------------//

	//  업체명 검색 //
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체명 검색", {}, function(grid) {
					var row = grid.target.getList("selected")[0];
					$('#prjctSeq').val(row.prjctSeq);
					$('#clntCd').val(row.clntCd);
// 					$('#clntNm').val(row.clntNm);

					var paramObj = {
						"coCd" : $('#coCd').val(),
						"clntCd" : row.clntCd

					}
					setMngInfo(paramObj);
				});
	}

	// 영업담당자 set
	function setMngInfo(paramObj) {
		postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
				function(data) {
					if (data.mngInfo) {
						$('#mngId').val(data.mngInfo.salesEmpId);
						$('#mngIdNm').val(data.mngInfo.salesEmpNm);
					} else {
						$('#mngId').val("");
						$('#mngIdNm').val("");
					}
				});
	}

	//  업체담당자 검색 //
	function clntSearch2() {
		var paramObj = {
			"coCd" : "GUN", //$('#coCd').val(),
			"userId" : $('#clntMngNm').val(),
			"useYn" : "Y"
		};

		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
				"업체담당자 검색", paramObj, function(grid) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					$('#clntCd').val(checkedNode.id);
					$('#clntMngNm').val(checkedNode.text);
				});
	}

	function setByCoCd(value) {
		$('#coCd').data("desc", value);
		$('#coCd option:not([value=""])').remove();
		setCommonSelect($('#coCd'));
	}

	//미수주금액, 수주확률계산 //
	function calculateunodrs(){
    	var ordrsPlanAmt = parseFloat(document.getElementById("ordrsPlanAmt").value.replace(/,/g, ''));
    	var ordrsAmt = parseFloat(document.getElementById("ordrsAmt").value.replace(/,/g, ''));
    	var unordrsAmt = ordrsPlanAmt - ordrsAmt;
    	var ordrsPct = (ordrsAmt / ordrsPlanAmt) * 100;

    	document.getElementById("unordrsAmt").value = unordrsAmt.toLocaleString();
    	document.getElementById("ordrsPct").value = ordrsPct.toFixed(2) + "%";
    	}

//        /* value값을 숫자로 설정해서 주면 되는데
// 		식은 제대로 들어간 거 같은데 값이 안나옴.
//       이 예에서 주문 목표 및 주문 금액에 대한 입력 필드에는 사용자가 값을 입력할 때마다
//       "calculateunodrs()" 함수를 트리거하는 onchange 이벤트 핸들러가 있습니다.
//       이 함수는 입력 필드의 값을 검색하고 parseFloat() 메서드를 사용하여 숫자로 변환하고
//       정규식과 함께 replace() 메서드를 사용하여 쉼표를 제거하고 필요한 계산을 수행한 다음 해당 필드에 결과를 표시합니다.
//       "unordrsAmt" 필드는 읽기 전용으로 설정되며 toLocaleString() 메서드를 사용하여 계산된
//       미지급 금액 값을 쉼표와 함께 표시합니다. "ordrsPct" 필드도 읽기 전용으로 설정되며
//       toFixed() 메서드를 사용하여 계산된 주문 확률 값을 소수점 이하 두 자리의 백분율로 표시합니다.
//       계산을 수정하거나 결과가 표시되는 방식을 변경하는 등 특정 요구 사항에 맞게 이 코드를 사용자 지정할 수 있습니다.
//       */
// 	}

</script>