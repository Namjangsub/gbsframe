<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">업무 요청 등록</h4>
	</div>

	<style>
		input[type="datetime-local"].form-control {
			height: 25px;
		}
		textarea.form-control {
			overflow: hidden; /* 스크롤바 비활성화 */
			resize: none; /* 사용자가 크기를 조절하지 못하도록 설정 */
			height: 55px; /* 기본 높이 */
		}
	</style>
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="pgmId"     	name="pgmId"	value="CM1601M01">
			<input type="hidden" id="reqDept" name="reqDept" value="">
			<table>
				<colgroup>
					<col width="15%">
					<col width="35%">
					<col width="15%">
					<col width="35%">
				</colgroup>

				<tr>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" required msg="회사"></select>
					</td>
					<th>요청번호</th>
					<td>
						<input type="text" id="fileTrgtKey" name="fileTrgtKey" class="form-control" readonly>
					</td>
				</tr>
				<tr>
					<th class="hit">업무 요청일시</th>
					<td>
						<input type="datetime-local" id="reqDttm" name="reqDttm" class="form-control" required msg="업무 요청일시" max="9999-12-31T00:00" onfocus="setCurrentDateTime(this)">
					</td>
					<th class="hit">업무 요청자</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="reqId" name="reqId" required msg="요청자"> <a onclick="openUserSearch();"><i class="i_search_w"></i></a>
							<input type="text" id="reqIdNm" name="reqIdNm"  onkeyup="event.keyCode === 8 ? reqId.value = '' : (event.keyCode === 13 ? openUserSearch() : true);" required msg="업무 요청자">
						</div>
					</td>
				</tr>
				<tr>
					<th class="hit">요청 분류</th>
					<td>
						<select class="form-control" id="reqType" name="reqType" data-kind="ITSMREQ" onchange="selectCodeList(this.value);" data-search="reqType" required msg="요청 분류">
							<option value="">선택 하세요</option>
						</select>
					</td>
					<th class="issAct">처리완료일시</th>
					<td class="issAct">
						<input type="datetime-local" id="actDttm" name="actDttm" class="form-control" msg="처리완료일시"  max="9999-12-31T00:00" onfocus="setCurrentDateTime(this)" >
					</td>
				</tr>
				<tr>
					<th class="hit">요청상세구분</th>
					<td>
						<select class="form-control" id="reqType2" name="reqType2" data-kind="ITSMREQ2" data-search="reqType2" required msg="요청상세구분">
							<option value="">선택 하세요</option>
						</select>
					</td>
					<th class="hit">조치상태</th>
					<td>
						<select class="form-control" id="actCd" name="actCd" data-kind="ISSSTS" required msg="조치상태">
							<option value="">선택</option>
						</select>
					</td>
				</tr>
				<tr>
					<th class="hit">업무 처리자</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="actId" name="actId" msg="처리자ID">
								<!-- <a onclick="openActUserSearch();"><i class="i_search_w"></i></a> -->
							<input type="text" id="actIdNm" name="actIdNm" readonly required msg="업무 처리자">
						</div>
					</td>
					<th class="issAct">담당자투입시간</th>
					<td class="issAct">
						<input type="text" class="form-control" id="actProcTm" name="actProcTm" msg="담당자투입시간"
						oninput="this.value=setWorkRptHour(this.value)" onblur="this.value=setWorkRptHour2(this.value)">
					</td>
				</tr>
				<tr>
					<th class="hit">요청 내용</th>
					<td colspan="3">
						<textarea rows="4" class="form-control" id="issue" name="issue" data-search="issue" required msg="요청 내용"></textarea>
					</td>
				</tr>
				<tr>
					<th>비고</th>
					<td colspan="3">
						<textarea rows="4" class="form-control" id="rmk" name="rmk" data-search="rmk" msg="비고"></textarea>
					</td>
				</tr>
				<tr>
					<th class="issAct">요청처리 결과</th>
					<td  class="issAct" colspan="3">
						<textarea rows="4" class="form-control" id="actDesc" name="actDesc" data-search="actDesc" msg="요청처리 결과"></textarea>
					</td>
				</tr>
				<td colspan= 5>
					<!-- 공유대상자-->
					<div class="popup_table" id="approval_trgt">
						<table style="border:0px;">
							<tr style="height:20px;">
							<td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
							<td colspan="3">
								<div class="add_btn_small pdl10" id="plus-minus">
								<a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;" authchk>+</a>
								<a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;" authchk>-</a>
							</div>
							</td>
							</tr>
							<tr>
							<td colspan="4">
							<div>
									<div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 200px; width: 100%;" ></div>
								</div>
							</td>
							</tr>
						</table>
					</div>
				</td>
			</table>
			<div  id="dayilyRpt" style="margin-bottom: 40px;"></div>
		</div>
	</form>
	<!-- 공통 파일 영역 -->
	<div id="fileList_area"></div>
	<!-- 공통 파일 영역 -->
	<div>
	<br>
	<br></div>
	<!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
    var teleNo = ""; //카카오 접수자 전화번호변수

    // 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
	var kakaoErr = [];

	var gridViewPop = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: true,
				multipleSelect: false,
				sortable: false,
					target: $('[data-ax5grid="first-grid-modal"]'),
					header: {
						align: "center",
						selector: true
					},
					body: {
						onClick: function () {
							this.self.select(this.dindex);
						},
						onDBLClick: function () {
						},
						mergeCells : ["gb"],
					},
				page : {
					navigationItemCount : 10,
					height : 30,
					display : true,
					firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
					prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
					nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
					lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
					onChange : function() {
						gridView.setData(this.page.selectPage);
					}
				},
				columns : [
						{key: "gb",               label: "구분",         align: "center",   width: 40},
						{key: "sanctnSn",          label: "순번",       align: "center",   width: 50},
						{key: "coCd",               label: "coCd",      align: "center",   width: 50, hidden: true},
						{key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
						{key: "usrNm",            label: "ID",         align: "center",   width: 130, hidden: true},
						{key: "empNo",            label: "사원번호",    align: "center",   width: 130, hidden: true},
						{key: "name",             label: "성명",         align: "center",   width: 80},
						{key: "jik",                label: "직위",         align: "center",   width: 60},
						{key: "creatDttm",         label: "요청일자",    align: "center",   width: 90},
						{key: "todoCfDt",            label: "확인일자",      align: "center",   width: 130},
						{key: "todoCfOpn",         label: "확인의견",    align: "left",     width: 200},
						{key: "todoKey",            label: "todoKey",      align: "center",   width: 130, hidden: true},
						{key: "sanctnSttus",         label: "sanctnSttus",      align: "center",   width: 130, hidden: true},
						{key: "todoId",            label: "todoId",      align: "center",   width: 130, hidden: true},
						{key: "flag",               label: "flag",      align: "center",   width: 130, hidden: true}
						]
				});
					return this;
				},

				setData : function(_pageNo) {
					var targetObj = this.target;
					var formData = {
							"fileTrgtKey" : fileTrgtKey,
							"reqNo" 	  : fileTrgtKey,
							"pageNo"      : _pageNo + 1
					}

					postAjax("/user/wb/wb20/selectSignResUserlst", formData, null, function(data){
						var list = data.result;
						targetObj.setData({
							list : list,
							page : {
									totalElements : list.length
							}
						});
					});
				},

				setData2 : function(_list) {
					this.target.setData({
							list : _list,
							page : {
									totalElements :  _list.length,
							}
						});
					}
	}

	//**********************************************************************
	//  1. 입력
	//      1-1 : 단순 입력
	//      1-2 : 참조 입력
	//  2. 수정   : 기존자료 화면 표시
	//            수정자료 입력 후 Update
	//  3. 단순 조회  : 화면 조회 처리
	//              - 필요시 공통업무에서 결재 처리 활성화 됨
	//
	//**********************************************************************
	$(document).ready(function() {
		// select 요소에 데이터를 채우는 함수 호출
		setCommonSelect($(".popup_area select[data-kind]"));

		// 변수 설정
		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;

		//진행상태가 완료일 경우 투입공수, 투입비용, 조치내용은 필수 입력임  actAmtSts actDng
		$('#actCd').change(function () {
			if ($("#actCd").val() == 'ISSSTS03') {
				$("#actDttm").closest('td').prev('th').addClass("hit");
        		$('#actDttm').attr('required', 'true');
        		$('#actProcTm').parent('td').prev('th').addClass('hit');
        		$('#actProcTm').attr('required', 'true');
        		$('#actDesc').parent('td').prev('th').addClass('hit');
        		$('#actDesc').attr('required', 'true');
//         		$('#btn_plus2').show();
//         		$('#btn_minus2').show();

        		if (actionType == 'T') {
        			$('#popForm #actionBtn').hide();
        		} else {
        			$('#popForm #actionBtn').show();
        		}
            	$('.issAct').removeClass('no-click');

        	} else {
        		$('#actsDt').closest('td').prev('th').removeClass('hit');
        		$('#actsDt').removeAttr('required', 'true');
        		$('#actProcTm').parent('td').prev('th').removeClass('hit');
        		$('#actProcTm').removeAttr('required', 'true');
        		$('#actDesc').parent('td').prev('th').removeClass('hit');
        		$('#actDesc').removeAttr('required', 'true');
//         		$('#btn_plus2').hide();
//         		$('#btn_minus2').hide();
        		if (actionType == 'T') {
        			$('#popForm #actionBtn').hide();
        		} else {
        			$('#popForm #actionBtn').show();
        		}
            	$('.issAct').addClass('no-click');
        	}
		})

		// 상세구분 선택 시 자동으로 필드 채우기
		$('#reqType2').on('change', function() {
			var selectedOption = $(this).find('option:selected');
			var codeRprc = selectedOption.attr('data-rprc');
			var codeDesc = selectedOption.attr('data-desc'); // 기본 메시지가 이미 설정됨

			$('#actId').val(codeRprc);            // 업무 처리자 자동 설정
			$('#issue').attr('placeholder', codeDesc);  // 업무 처리 내용 placeholder 설정

			if (codeRprc) {		// codeRprc에 요청상세구분별 처리담당자 ID 가 들어 있음

				$('#actId').val(codeRprc); // 숨겨진 필드에 ID 저장

				// ID로 이름을 조회하여 actIdNm 필드에 표시
				var paramObj = { "coCd": "", "useYn": "Y" };
				postAjaxSync("/admin/cm/cm06/selectUserTree", paramObj, null, function(data) {
					if (data && data.userTree) {
						var matchedUser = data.userTree.find(user => user.id === codeRprc);
						if (matchedUser) {
							$('#actIdNm').val(matchedUser.text); // 이름 표시용 필드에 이름 설정
						} else {
							$('#actIdNm').val(''); // 이름 조회 실패 시 초기화
						}
					}
				});
			} else {
				// ID가 없을 경우 필드 초기화
				$('#actId').val('');
				$('#actIdNm').val('');
			}
		});
		// 등록 모드일 때
		if (actionType == "C") {
			// modal에 전달된 값 설정
			//   case 1. 신규등록은 아무런 값이 없음
			//   case 2. 기존 자료 참조 등록인경우 일부 자료 paramObj에 값전달됨
			$.each(modalStack.last().paramObj, function (key, val) {
				if( $("#popForm").find("#" + key).length > 0 ) {
					$("#popForm").find("#" + key).val(val);
				}

				if (key == 'reqType') {
					selectCodeList();
				}
			});

			$('#reqType2').change();

			// 요청자, 회사코드 들어오기
			$("#popForm #reqId").val(jwt.userId);
			$("#popForm #reqIdNm").val(jwt.userNm);
			$("#popForm #coCd").val(jwt.coCd);


			// 조치상태 '접수'로 고정
			$('#actCd').val('ISSSTS01');
			$('#actCd').change();
			$('#actCd').addClass('no-click');

			$('#reqDttm').focus();	// 팝업창이 열릴 때 요청일시 필드에 현재 시간을 설정

			// 등록 버튼 클릭 시 insertItoaIssue 함수 호출
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertItoaIssue();
			});

		} else if (actionType == "U" || actionType == "S" || actionType == "T") {  // || actionType == "S" || actionType == "T" 추가하기
			$('.tit').text('업무 요청 수정');
			selectItoaIssueInfo(); // ITSM 정보 불러오기

			if (actionType == "U" ) { //  || actionType == "S" 추가
				// 현재 로그인된 사용자 ID (예시: jwt.userId)
				const currentUserId = jwt.userId;

				// 처리자 ID를 가져오기
				const actId = $('#actId').val();

				// 처리자 또는 요청자와 로그인한 사용자가 일치하는지 확인
				if (currentUserId !== actId && currentUserId !== $('#reqId').val()) {
					// 처리자나 요청자가 아닌 경우, 모든 필드를 비활성화
					$('#popForm select, #popForm input, #popForm textarea').each(function() {
						$(this).attr('disabled', true);
						$(this).css({'background-color': '#e6e6e6', 'pointer-events': 'none'});
						$('#actionBtn').remove();
					});
				} else {
					// 처리자나 요청자일 경우 수정 가능
					$('#popForm select, #popForm input, #popForm textarea').each(function() {
						$(this).removeAttr('disabled');
						$(this).css({'background-color': '', 'pointer-events': ''});
					});

					// 수정 버튼 활성화
					$('#actionBtn').removeAttr('disabled');
				}
				$('#actionBtn').text("수정");
				$('#actionBtn').on('click', function() {
					updateItoaIssue();
				});
			} else if (actionType == "T" || actionType == "S") {
				$('.tit').text('업무 요청 조회');
				// 조회 모드일 때 버튼 및 검색 아이콘 제거

				$('#actionBtn').remove();
				$('.i_search_w').remove();

				// input, textarea, select 모두 읽기 전용 또는 비활성화
				$.each($('#popForm select, input, textarea'), function(idx, elem) {
					var id = $(elem).attr("id");
					if (id) {
						var eleId = "#popForm #" + id;
						if ($(elem).prop('tagName') == "INPUT") $(eleId).attr("readonly", true);
						if ($(elem).prop('tagName') == "TEXTAREA") $(eleId).attr("readonly", true);
						if ($(elem).prop('tagName') == "SELECT")$(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
						if ($(elem).prop('tagName') == "BUTTON")$(eleId).remove();
					}
				});
			}
		}

		gridViewPop.initView().setData(0);



        //---------------------------------------------------------------
		//첨부 화일 처리 시작
		//---------------------------------------------------------------
		fileParam = {
			fileTrgtTyp   : $("#popForm #pgmId").val(),
			fileTrgtKey      :fileTrgtKey
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------
		//첨부 화일 처리 끝
		//---------------------------------------------------------------

		authChk();

	});


	//Backend 자료 검색 화면 출력 처리
	function selectItoaIssueInfo() {
	// fileTrgtKey가 정의되지 않았을 수 있으니 확인
		var formData = {
			"fileTrgtKey": fileTrgtKey, // fileTrgtKey가 제대로 설정되어 있는지 확인
		}

		postAjaxSync("/admin/cm/cm16/selectItoaIssueInfo", formData, null, function(data) {
			var reqDept = data.result.reqDept || modalStack.last().paramObj.reqDept;
			$('#reqDept').val(reqDept);

			// 응답 데이터를 폼에 채워 넣음
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);

					// 숫자 관련 필드일 경우 comma 처리를 하는 부분
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}

					if (key == 'reqType') {
						selectCodeList();
					}

					if (key == 'actCd' && actCd == 'ISSTS02') {
						//선택, 접수 ISSTS01 삭제 처리 찾아서 코딩 할것
					}
				}
			});

			// 각 텍스트 에어리어 크기 조절
			txtareaHeightResize($('#issue'));
			txtareaHeightResize($('#actDesc'));
			txtareaHeightResize($('#rmk'));

			$('#actCd').change();

		});
	}

	//----------------------------------------------//

	function makeFormData() {
		if (!inputValidation($('.popup_area [required]'))) {
			return false;
		}

		var actCd = $('#actCd').val();
		var reqDttm = $('#reqDttm').val();
		var actDttm = $('#actDttm').val();
		var actProcTm = $('#actProcTm').val();

		// 조치상태가 진행중 또는 완료일 때 요청일시, 처리일시에 대한 조건
		if (actCd === 'ISSSTS02' || actCd === 'ISSSTS03') {
			// 처리일시가 요청일시보다 빠를 수 없음
			if (reqDttm && actDttm) {
				var reqDate = new Date(reqDttm);
				var actDate = new Date(actDttm);
				if (actDate < reqDate) {
					alert('처리일시는 요청일시보다 빠를 수 없습니다.');
					return false;
				}
			}
		}

		// reqType2이 select 타입에 대한 처리
		var reqType2Label = $('#reqType2').find("option:selected").text();

		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});

		//1. 조치담당자 결재 자동등록 처리하기
		//2. 조치담당자 팀장 결재 자동등록 처리하기
		//3. 이슈 등록자 담당팀장 결재 자동 등록 처리하기
		// 주석 해제할 것
		selectTeamManagerApprovalAdd();
		// approvalUserInfoData();

		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		formData.append('reqType', $('#reqType').val());
		formData.append('reqType2', $('#reqType2').val());
		formData.append('actCd', $('#actCd').val());		// 조치상태 추가

		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		formData.append("ordrsNo", '');
		formData.append("userId" , jwt.userId);
		formData.append("clntCd" , '');         //첨부화일용
		formData.append("prdtCd" , '');         //첨부화일용
		formData.append("itemCd" , '');         //첨부화일용
		formData.append("prjctCd", '');      //첨부화일용
		formData.append("comonCd", treeModule.getFileNodeId());   //첨부화일용

		//---------------------------------------------------------------

		//---------------------------------------------------------------
		var fileUploadArr = [];
		var tempArr = [];

		tempArr = treeModule.getFileArr();
		$.each(tempArr, function(idx, obj) {
			if (obj.fileKey == 0) {
					formData.append("files", obj.file);
					obj.file = '';
					fileUploadArr.push(obj);
			}
		});

		formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
		formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));


		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		// 공유대상자 리스트  TODO LIST에 등록하기 위한 모듈 추가
      	// 공유 : TODODIV10, TODODIV1130  결재 :TODODIV20, TODODIV2130

		/*	결재그리드 insert make start */
	    // 요청자의 담당팀장 결재라인에 자동 등록 처리하기 -> ITSM관리는 현재 담당팀장에게 결재라인 자동 등록하지 않음
		// selectTeamManagerInfo($('#reqId').val());

		//결재그리드
		var rowSharngList = gridViewPop.target.list;
		var ParamObj = modalStack.last().paramObj;

       	var approvalArr = []; //결재정보

		$("#reqDept").val(jwt.deptId);
		//TITLE 추가
		var tempTitl = $("#reqIdNm").val() + '님의 '  + reqType2Label + ' 관련 문제 ' + $("#actCd option:selected").text();

      	//각업무에 맞는 param insert - 하드코딩값
		var addParam = {
					  coCd: $('#coCd').val()
					, salesCd: $("#fileTrgtKey").val()
					, issNo: $("#fileTrgtKey").val()
					, pgmId: $("#pgmId").val()
					, pgPath: "/admin/cm/cm16/CM1601P01.html"
					, sanctnSttus: "N"
					, todoCoCd: $('#coCd').val()
					, todoNo: $("#fileTrgtKey").val()
					, todoFileTrgtKey: $("#fileTrgtKey").val()
					, userId: jwt.userId
					, todoTitl:  wordRemove(tempTitl)
					, todoTitle:  wordRemove(tempTitl)
					, todoKey: ""
					, todoCodeKind: ""
					, todoCodeId: ""
			};

        let 결재순번 = 0;
        let 공유순번 = 0;
       if(rowSharngList.length > 0) {
           $.each(rowSharngList, function(idx, elem) {
		           	/* rowSharngList 내용입니다.
		           	{
					    "rnum": "2",
					    "wbsPlancoCd": "GUN",
					    "coCd": "GUN",
					    "wbsPlancoCdNm": "건양ITT",
					    "usrNm": "gyrsult10",
					    "empNo": "gyrsult10",
					    "name": "외부설계",
					    "telNo": "010-1234-1321",
					    "email": "발주요청서 실적 관리용입니다.",
					    "dtNm": "실적관리용",
					    "jik": "담 당",
					    "todoDiv1CodeId": "TODODIV20",
					    "gb": "결재",
					    "sanctnSttus": "N",
					    "sanctnSttusNm": "미승인",
					    "creatDttm": "2024-07-01",
					    "todoKey": "5778",
					    "sanctnSn": "2",
					    "todoId": "gyrsult10",
					    "todoDiv2CodeId": "TODODIV2020",
					    "salesCd": "24000-00DUMMY",
					    "flag": "U",
					    "__original_index": 1,
					    "__index": 1
					}
			   	*/
			   	if (elem.usrNm.includes('gyrsult')) {
			   		//퇴사자 또는 외주업체담담자등록용으로 결재 제외처리함
			   		// gyrsult10 외부설계
			   		// gyrsult20 외부기계
			   		// gyrsult30 외부전기
			   		// gyrsult90 퇴사자
			   	} else {
	               var approvalListObj = elem;

	               addParam["todoId"] = elem.usrNm;
	               addParam["empNo"] = elem.empNo;
	               addParam["name"] = elem.name;
	               addParam["telNo"] = elem.telNo;
	               addParam["email"] = elem.eMail;
	               addParam["gb"] = elem.gb;

	               ParamObj["actionType"] = (elem.gb == '공유')? "T" : "S";
	               addParam["pgParam"] = JSON.stringify(ParamObj);

	               if (elem.gb == '공유') {
		               	공유순번 += 1;
		               	approvalListObj["sanctnSn"] = 공유순번;
		               	approvalListObj["todoDiv1CodeId"] = "TODODIV10";
		               	approvalListObj["todoDiv2CodeId"] = "TODODIV1130";
	               } else if (elem.gb == '결재') {
		               	결재순번 += 1;
		               	approvalListObj["sanctnSn"] = 결재순번;
		               	approvalListObj["todoDiv1CodeId"] = "TODODIV20";
		               	approvalListObj["todoDiv2CodeId"] = "TODODIV2130";
	               }
	               const mergedParam = {...addParam, ...approvalListObj}//속성합치기
	               approvalArr.push(mergedParam);
			   	}
           });
       }

		// 처리자와 요청자가 다를경우 처리자에게 공유카톡 자동 발송 추가
		if ($("#reqId").val().includes('gyrsult')) {
			//외주업체이면 공유제외 처리함
		} else {
			if (!$("#reqId").val().includes('gyrsult') && $("#reqId").val() != $("#reqId").val()) {

	            addParam["todoId"] = $("#reqId").val();
	            addParam["usrNm"] = $("#reqId").val();
	            addParam["empNo"] = $("#reqId").val();
	            addParam["name"] = $('#reqIdNm').val();
	            addParam["telNo"] = '';
	            addParam["email"] = '';
	            addParam["gb"] = '공유';
	            ParamObj["actionType"] = "T";
	            addParam["pgParam"] = JSON.stringify(ParamObj);

	            var approvalListObj = {};

	           	공유순번 += 1;
	           	approvalListObj["sanctnSn"] = 공유순번;
	           	approvalListObj["todoDiv1CodeId"] = "TODODIV10";
	           	approvalListObj["todoDiv2CodeId"] = "TODODIV1130";

	            const mergedParam = {...addParam, ...approvalListObj}//속성합치기
	            approvalArr.push(mergedParam);
			}
		}
		formData.append("approvalArr", JSON.stringify(approvalArr));
	    /*	결재그리드 insert make end */
		formData.append("S_todoDiv1CodeId", "TODODIV10");
		formData.append("S_todoDiv2CodeId", "TODODIV1130");

		return formData;
	}

	// 등록
	function insertItoaIssue() {
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			if (formData) {
				filePostAjax("/admin/cm/cm16/insertItoaIssue", formData, function(data) {
					if (data.resultCode == 200) {
						if (typeof gridView !== 'undefined') gridView.setData(0);

						fileTrgtKey = data.fileTrgtKey;
						$('#fileTrgtKey').val(fileTrgtKey);

						kakaoTodo();				//kakaoTodo() 호출
						modalStack.close();
					}
				});
			}
		}
	}

	// 수정
	function updateItoaIssue() {
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}
		if (inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();

			filePostAjax("/admin/cm/cm16/updateItoaIssue", formData,function(data) {
					if (data.resultCode == 200) {
						if (typeof gridView !== 'undefined') gridView.setData(0);

						kakaoTodo();			//kakaoTodo() 호출
						modalStack.close();
					}
			});
		}
	}

	// 구분과 상세구분을 처리하는 함수
	function selectCodeList() {
		$('#actId').val(''); // 처리 담당자 ID 초기화
    	$('#actIdNm').val(''); // 처리 담당자 이름 초기화

		$('#reqType2').empty(); // 구분이 선택되지 않은 경우 상세구분 초기화
		$('#reqType2').append('<option value="">선택</option>');

		target = $("#reqType2");
		var paramObj = { "codeKind": $("#reqType").val() };
		// AJAX 요청을 통해 구분에 따른 상세구분 데이터를 로드
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data) {
			var optionHtml = '';
			var childCodeList = data.childCodeList;
			$.each(childCodeList, function(index, item) {
				var desc = item.codeDesc || "요청 내용을 입력해주세요.";  // 기본 메시지 설정

				// desc 변수를 data-desc 속성에 직접 설정
				optionHtml += '<option value="' + item.codeId + '" data-rprc="' + item.codeRprc + '" data-desc="' + desc + '">';
				optionHtml += item.codeNm;
				optionHtml += '</option>';
			});
			$(target).append(optionHtml);
		});

	}

	function wordRemove(originalWord) {
		let tempWord = originalWord.replace(/주식회사/g, '');
		tempWord = tempWord.replace(/\(주\)/g, '');
		tempWord = tempWord.replace(/,,/g, ',');
		tempWord = tempWord.replace(/\(주\)/g, '');
		tempWord = tempWord.replace(/ ,/g, ',');

		return tempWord;
	}

	//등록시 그리드값 배열 저장
	$.approvalInsertArr = function(gridObj, addParam) {
		var gridList = gridObj.target.getList();
		var gridColumns = gridObj.target.columns;
		var detailArr = [];
		var msgArr = [];
		var errCnt = 0;
		if( gridList.length > 0 ) {
			var msgArr = [];
			$.each(gridList, function (idx, elem) {
				var detailObj = {};
				//컬럼수 루프
				for(var i=0; i<gridColumns.length; i++) {
				var key = gridColumns[i].key;
				var val = elem[key];
				if( typeof(val) == "undefined") val = "";
				detailObj["idx"] = i + 1;
				//발주순번 은 select key로  ORDRG_SEQ
				detailObj[key] = val;
				}
				//필수값 체크를 여기서 한다.
				if( detailObj['todoId'] != ""  ) {
					detailArr.push(detailObj);
				}
				//공유/결재구분
				if( detailObj['gb'] == "결재" ) {
					detailObj['todoDiv1CodeId'] = "TODODIV20";
					detailObj['todoDiv2CodeId'] = "TODODIV2130";
				} else if( detailObj['gb'] == "공유" ) {
					detailObj['todoDiv1CodeId'] = "TODODIV10";
					detailObj['todoDiv2CodeId'] = "TODODIV1130";
				}
				//추가할 param
				$.each(addParam, function(key, val){
				detailObj[key] = val;
				});
				//TITLE 추가
				var tempTitl = $("#reqIdNm").val() + '님의 '  + reqType2Label + ' 관련 문제 ' + $("#actCd option:selected").text();
				tempTitl = tempTitl.replace(/주식회사/g, '');
				tempTitl = tempTitl.replace(/(주)/g, '');
				tempTitl = tempTitl.replace(/,,/g, ',');
				detailObj['todoTitl'] = tempTitl;
			});
			//error alert 후 종료
			if( msgArr.length > 0 ) {
				alert(msgArr.join("\r\n"));
				return false;
			}
		}
		return detailArr;
	}

	//입력그리드 No. 재정립
	$.gridNoSet = function(gridObj, key) {
		var gridList = gridObj.target.getList();
		if( gridList.length > 0 ) {
			$.each(gridList, function (idx, elem) {
				let detailObj = {};
				gridObj.target.setValue(idx, key, idx+1);
			});
			gridObj.target.repaint();
		}
	}

	// 요청자 검색 //
	function openUserSearch() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId" : $('#reqId').val(),
			"userNm" : $('#reqIdNm').val(),
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "요청자 검색", paramObj, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					var deptName = checkedNode.original.deptNm;			// 요청자 reqDept 설정
					var coCd = checkedNode.original.coCd;				// 요청자 회사코드 설정

					$('#reqId').val(checkedNode.id);
					$('#reqIdNm').val(checkedNode.text);

					// 요청자에 따라 reqDept 설정
					if (deptName) {
						$('#reqDept').val(deptName);
					}
					// 요청자에 따라 회사 코드 설정
					if (coCd) {
						$('#coCd').val(coCd);  // 회사 코드 자동 설정
					}

				});
	}

	// 처리자 검색 기능 추가
	function openActUserSearch() {
		var paramObj = {
			"coCd": $('#coCd').val(),
			"userId": $('#actId').val(),
			"userNm": $('#actIdNm').val()
		};

		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "처리자 검색", paramObj, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);
					var deptName = checkedNode.original.deptNm;

					if (deptName) {
						$('#reqDept').val(deptName);
					}

					$('#actId').val(checkedNode.id);
					$('#actIdNm').val(checkedNode.text);
				});
	}

	// 담당투입시간
	function setWorkRptHour(_value) {
		var value = _value.replace(/[^0-9.]/g, "");
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return 24;
		}
		return value;
	}

	//담당투입시간 포커스를 빠져나갈때 실행됨
	function setWorkRptHour2(_value) {
		var value = parseFloat(_value.replace(/[^0-9.]/g, "")).toFixed(2);
		value = value.toLocaleString();
		value = value == 'NaN' ? 0 : value;
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return 24;
		}
		if(value == 0) {
			return "";
		}
		return value;
	}

	// 첨부파일 삭제
	function deleteFile(rowIndex) {
		if (notiFileArr[rowIndex].fileDelete != 'Y') {
			alert('파일 삭제 권한이 없습니다.')
			return false;
		};

		fileGridView.target.removeRow(rowIndex);

		if(notiFileArr[rowIndex].fileKey){
			deleteFileArr.push(notiFileArr[rowIndex].fileKey);
		}

		notiFileArr.splice(rowIndex, 1);
	}

	// 텍스트 영역 설정
	function txtareaHeightResize(obj) {
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 4)
			obj.css('height', "55px");
		else
			obj.css('height', (rowCount * 23) + "px");
	}

	// 포커스 시 현재 날짜와 시간 설정
	function setCurrentDateTime(input) {
		if (!input.value) { // 값이 없으면 현재 날짜와 시간을 설정
			const now = new Date();
			const year = now.getFullYear();
			const month = String(now.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
			const day = String(now.getDate()).padStart(2, '0');
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');

			// "yyyy-MM-ddThh:mm" 형식으로 설정
			const currentDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
			input.value = currentDateTime;
		}
	}

	//결재 여부
	function approvalYn() {
		var gridList = gridViewPop.target.getList();
		var inCnt = 0;
		if( gridList.length > 0 ) {
			var msgArr = [];
			$.each(gridList, function (idx, elem) {
				//결재자가 본인이 아니면서 상태가 Y인 경우
				if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
			})
		}
		return inCnt;
	}

	// 공유대상자 추가//
    function insertShareUserModal() {
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

		var paramObj = {};
		var appshaList = gridViewPop.target.list;
		paramObj["coCd"] = $('#coCd').val();
		paramObj["useYn"] =  "Y";
		paramObj["userId"] =  $('#actId').val();
		paramObj["userNm"] =  $('#actIdNm').val();
		paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
			}).map(function(item) {
					return {
						gb: "결재",
						id: item.usrNm,
						text: item.name,
						parent: item.jik,
						deptNm: item.dtNm,
						telNo: item.telNo,
						offTelNo: item.offTelNo,
						email: item.email
						, id: item.todoId
						, todoKey: item.todoKey
						, sanctnSn: item.sanctnSn
						, sanctnSttus: item.sanctnSttus
						, todoCfDt: item.todoCfDt
						, todoCfOpn: item.todoCfOpn
						, flag: item.flag
						, coCd: item.coCd
					};
			});
		paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
			}).map(function(item) {
					return {
					gb: "공유",
					id: item.usrNm,
					text: item.name,
					parent: item.jik,
					deptNm: item.dtNm,
					telNo: item.telNo,
					offTelNo: item.offTelNo,
					email: item.email
					, id: item.todoId
						, todoKey: item.todoKey
						, sanctnSn: item.sanctnSn
						, sanctnSttus: item.sanctnSttus
						, todoCfDt: item.todoCfDt
						, todoCfOpn: item.todoCfOpn
						, flag: item.flag
						, coCd: item.coCd
				};
			});

		openSecondModal("/static/html/cmn/modal/userLstSearch.html", 900, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){

		var appArray = approvalGrid.target.list.map(function(item) {
			return {
					gb: "결재",
					usrNm: item.id,
					name: item.text,
				jik: item.parent,
				dtNm: item.deptNm,
				telNo: item.telNo,
				offTelNo: item.offTelNo,
				email: item.email,
				todoId: item.id
					, todoKey: item.todoKey
					, sanctnSn: item.sanctnSn
					, sanctnSttus: item.sanctnSttus
					, todoCfDt: item.todoCfDt
					, todoCfOpn: item.todoCfOpn
					, flag: item.flag
					, coCd: item.coCd
			};
		});
		var shaArray = shareGrid.target.list.map(function(item) {
			return {
					gb: "공유",
				usrNm: item.id,
				name: item.text,
				jik: item.parent,
				dtNm: item.deptNm,
				telNo: item.telNo,
				offTelNo: item.offTelNo,
				email: item.email,
				todoId: item.id
					, todoKey: item.todoKey
					, sanctnSn: item.sanctnSn
					, sanctnSttus: item.sanctnSttus
					, todoCfDt: item.todoCfDt
					, todoCfOpn: item.todoCfOpn
					, flag: item.flag
					, coCd: item.coCd
			};
		});
		gridViewPop.setData2(appArray.concat(shaArray));

		//           approvalGrid.id //userId
        //   approvalGrid.text //성명
        //   approvalGrid.parent //직책
        //   approvalGrid.deptNm //부서
        //   approvalGrid.telNo
        //   approvalGrid.offTelNo
        //   approvalGrid.email

        //   shareGrid.id //userId
        //   shareGrid.text //성명
        //   shareGrid.parent //직책
        //   shareGrid.deptNm //부서
        //   shareGrid.telNo
        //   shareGrid.offTelNo
        //   shareGrid.email
		});

	}

	function deleteShareUser(){
		if( approvalYn() ) {
			alert("결재가 이미 진행중입니다.");
			return;
		}

		var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
		if( isNaN(selRow) ) {
	//           alert("선택된 행이 없습니다.");
			return;
		} else {
			if( selRow > -1 ) {
				//gridViewPop.target.removeRow(selRow);
				var todoKey = gridViewPop.target.getList()[selRow].todoKey;
				var gridList = gridViewPop.target.getList("selected")[0];
				if( typeof(todoKey) == "undefined" ) {
				gridViewPop.target.removeRow(selRow);
				$.gridNoSet(gridViewPop, "sanctnSn");
				} else {
					var paramObj = {
							todoNo: $("#popForm #fileTrgtKey").val(),
							todoKey: gridList.todoKey,
							sanctnSn: gridList.sanctnSn,
							todoDiv1CodeId: gridList.todoDiv1CodeId,
							todoDiv2CodeId: gridList.todoDiv2CodeId
					}
					if( confirm("선택행을 삭제하시겠습니까?")) {
						deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
							if (data.resultCode == 200) {
								alert(data.resultMessage);
								gridViewPop.setData(0);
							} else {
								alert("삭제중 오류가 발생했습니다");
							}
						});
					}
				}
			}
		}
	}

	/*
   #   TODO 알림톡발송 시작
   #
   */
//    $("#approvalReqTodoBtn").on("click", function () {
//       kakaoTodo();
//    });
	function kakaoTodo() {

       //message load
		if (kakaoErr.length == 0) {
			var paramObj = {
				"userId" : jwt.userId
				, "codeKind" : "KAKAOMSG"
			};
			postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
				if(data.resultList.length > 0 ) {
					kakaoErr = data.resultList;
				}
			});
		}

		let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

      	// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
        var paramObj1 = {
                "coCd" : $("#coCd").val(),
                "userId" : $("#reqId").val()
            };
		postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
			if (data.result[0] == undefined
				|| data.result[0].telNo == "") {
				teleNo = "051-312-2400";
			}
			else {
				teleNo = data.result[0].telNo;

			}
		});
		//---------------------------------------
		let param = {
            "tmplatDiv": "TMPLATDIV02"
            , "coCd": $("#popForm #coCd").val()            // 해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": "TODODIV20"               // 공통코드 해당업무 - 결재
            , "todoDiv2CodeId": "TODODIV2130"               //공통코드 해당업무 - ITSM 문제결재
            , "todoDiv1CodeNm": "결재"                  // 공통코드 해당업무 - 결재
            //, "todoDiv2CodeNm": "발주 및 출장 요청"                  //공통코드 해당업무 - 결재 - 발주서
            , "title": "ITSM 관리"
            , "sanctnDiv2": "결재"                     // 템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $("#popForm #fileTrgtKey").val()
            //, "todoNo": tReqNo
            , "clntCd": "1"               // 발신회사는 로그인사용자 회사
            , "clntNm": clntNm            // 로그의 수신거래처명
            , "ordrgMngNm": $("#popForm #reqIdNm").val()         // 요청하는 사람
            , "ordrgMngTelNo": teleNo      // 조치자전화번호
            , "creatPgm"  : "CM1601P01"
			, "salesCd": $("#popForm #fileTrgtKey").val()
			, "issNo" : $("#popForm #fileTrgtKey").val()
		}
		commKaKaoSendTodo(param);

      //공유
		let param2 = {
				"tmplatDiv": "TMPLATDIV02"
				, "coCd": $("#popForm #coCd").val()            //해당업무의 coCd(트르넷발주 TRN )
				, "todoDiv1CodeId": "TODODIV10"               //공통코드 해당업무 - 결재
				, "todoDiv2CodeId": "TODODIV1130"               //공통코드 해당업무 - ITSM 문제결재
				, "todoDiv1CodeNm": "공유"                  //공통코드 해당업무 - 결재
				, "title": "ITSM 관리"
				, "sanctnDiv2": "공유"                     //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
				, "todoNo": $("#popForm #fileTrgtKey").val()
				//, "todoNo": tReqNo
				, "clntCd": "1"               //발신회사는 로그인사용자 회사
				, "clntNm": clntNm            //로그의 수신거래처명
				, "ordrgMngNm": $("#popForm #reqIdNm").val()         // 요청하는 사람
				, "ordrgMngTelNo": teleNo      //담당자전화번호
				, "creatPgm"  : "CM1601P01"
				, "salesCd": $("#popForm #fileTrgtKey").val()
				, "issNo" : $("#popForm #fileTrgtKey").val()
		}
		commKaKaoSendTodo(param2);

		if (kakaoCnt > 0) {
			kakaoCnt = 0;
		//           alert("알림톡이 정상 발송되었습니다.");
		}
	}

   	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
//       console.log('---카카오 발주및출장요청서 알림톡발송시작 --' + param);

		//알림톡수신번호 채번
		var maxMessageId = null;         //message id(unique key)
		var talkMessage = null             //발송될 내용 template
		var mobile = null               //수신인 휴대전화번호
		var title = null               //todo title
		var todoDiv2CodeNm = null               //todo title
		var sendList = [];
		let talkParam = {};
		let talkBody = {};
		let sendCnt = 0;
		postAjaxSync("/user/bm/bm18/selectMaxMessageIdTodo", param, null, function(data) {
					if(data.resultList.length > 0 ) {
						if( data.resultList[0].maxMessageId != "" ) {
							sendList = data.resultList;
						} else {
							alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
							return;
						}

					}
		});
      	//user search ajax end

      	//대상 loop
		$.each(sendList, function (key, sendObj) {
			maxMessageId = sendObj.maxMessageId;
			talkMessage = sendObj.messageDesc;
			mobile =  sendObj.telNo;
			//로그용
			param.rcvId = sendObj.todoId;         //todo 수신id
			param.rcvNm = sendObj.name;            //todo 수신자명
			param.nameTo = sendObj.name;            //todo 수신자명

			//title      = sendObj.todoTitl;
			todoDiv2CodeNm =   sendObj.todoTitl;
			param.todoDiv2CodeNm = todoDiv2CodeNm;
			//param.title = title;                        //요청내용제목
			param.sendDt = sendObj.sendDt;

			if(mobile == "" || mobile == null) {
				alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
				return;
			}
			if(talkMessage == "" || talkMessage == null) {
				alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
				return;
			}
			//message 치환
			let message = talkMessage;
			let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
			//loop
			$.each(splitStr, function (key, val) {
				let compKey = val.substring(1, val.length-1);
				if( compKey != "" && compKey != "undefined" ) {
				if( typeof(param[compKey]) != "undefined" ) {
					let val2 = '#'+val;
					message = message.replaceAll(val2, param[compKey]);
				}
				}
			});

			talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
			talkParam.serverName = "gyitt2400";
			talkParam.paymentType = "P";
			talkBody.service = "2310086157";            //서비스번호(1000000000 - 예시  real : 2310086157
			talkBody.messageId = maxMessageId;         //고객사에서 관리하는 메시지No - 40byte (unique 값);
			if (param.title.length > 50) {
				param.title = param.title.substring(0, 49); // 50자까지만 자르기
			}
			talkBody.title = param.title;               //알림톡 타이틀 -
			talkBody.message = message;            //알림톡 메시지 (1000 byte)
			talkBody.mobile = mobile;            //휴대전화번호
			talkBody.template = "10003";         //템플릿관리화면 템플릿ID   - 발주서 V2
			let talkJson = JSON.stringify(talkBody);
			// sendCnt = kakaoSendReal(talkJson, talkParam, param);

		});

      	//대상 loop end
		if( sendCnt > 0 ) {
			//alert("알림톡 정상 발송되었습니다.");
			kakaoCnt++;
		}
	}

   //조치담당자 팀장 정보 가져오기
	function selectTeamManagerInfo(paramUserId) {
		//결자자 정보 가져오기//결자자 정보 가져오기 gridViewPop2
		var appshaList = gridViewPop.target.list.map(function(item) {
							return {
								gb: item.gb,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email,
							};
						});


		var appArray = $.grep(appshaList, function(item) { return item.gb === "결재"; }).map(function(item) {
							return {
								gb: item.gb,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email
							};
						});
		var shaArray =  $.grep(appshaList, function(item) { return item.gb === "공유"; }).map(function(item) {
							return {
								gb: item.gb,
								usrNm: item.usrNm,
								name: item.name,
								jik: item.jik,
								dtNm: item.dtNm,
								telNo: item.telNo,
								offTelNo: item.offTelNo,
								email: item.email
							};
						});

		var formData = {
			"userId" : paramUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
									gb: "결재",
									usrNm: list.id,
									name: list.name,
									jik: list.levelNm,
									dtNm: list.deptNm,
									telNo: list.telNo,
									offTelNo: list.offTelNo,
									email: list.email,
									todoNo: $('#rsltNo').val(),
									sanctnSn: 0,
								});
				}

				gridViewPop.setData2(appArray.concat(shaArray));
			}
		});
	}


    //조치담당자 팀장 정보 가져오기 -> ITSM관리는 지금은 팀장에게는 결재에 대한 알림을 추가하지 않음 조치자에게만 공유 알림 발송
	// approvalTeamManagerInfoData(), approvalTeamManagerSpecialInfoData() 함수는 일단 사용하지 않음
	function selectTeamManagerApprovalAdd() {
    	//------------------------------------------------
    	//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  start
    	//결재자 정보와 공유자 정보를 분리하고 조치담당자, 조치담당자 팀장이 공유에 있으면 제외 처리함.
    	//------------------------------------------------
		let appshaList = gridViewPop.target.getList();

		var appArray = [];	//결재권자 정보
		var shaArray = [];	//공유자 정보
		var tempActId = $("#actId").val();	// 요청자ID
		if (tempActId.slice(0,7) == 'gyrsult') return false; //실적관리용 ID는 결제 제외처리함.

        $.each(appshaList, function(idx, item){
            if (item.gb === "결재") {
				appArray.push(item);
            } else {
            	//공유일경우 조치담당자가 공유에 있으면 제외처리함.
				if (item.usrNm != tempActId) {
					shaArray.push(item);
				}
            }
        });
		//------------------------------------------------
		//이슈등록, 조치결과 등록시 결재자 정보를 메모리에 가져오기  end
		//------------------------------------------------

		// 조치담당자 정보 자동 추가
		// 주석 해제할 것
		appArray = approvalUserInfoData(tempActId, appArray);				// 조치자 정보 추가

		gridViewPop.setData2(appArray.concat(shaArray));
	}

    //처리담당자 정보 정보 가져오기
	function approvalUserInfoData (appUserId, appArray) {
		var formData = {
			"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectRsltsMemberList", formData, null, function(data) {
			if (data.resultList != '' && data.resultList!=null) {
				//조치결과 결자자 정보 가져오기
				let list = data.resultList[0];
				if (appArray.some(item => item.usrNm === list.usrNm)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",		// 공유에서 결재로 바꾸면 등록 및 수정시 결재로우로 채워짐
								usrNm: list.usrNm,
								name: list.name,
								jik: list.jik,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,
							});
				}
			}
		});
		return appArray;
	}


	// ITSM은 현재 처리담당자 팀장 정보에 대해 사용하지 않음 추후 사용할 수도 있음
    //담당자 팀장 정보 가져오기
	function approvalTeamManagerInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}

	// 처리담당자 팀장 정보와 마찬가지로 사용하지 않음
    //특정담당자 정보 가져오기
	function approvalTeamManagerSpecialInfoData(appUserId, appArray) {
		var formData = {
				"userId" : appUserId,
		}
		postAjaxSync("/user/wb/wb24/selectTeamManagerSpecialInfo", formData, null, function(data) {
			if (data.result != '' && data.result!=null) {
				//결자자 정보 가져오기
				let list = data.result;
				if (appArray.some(item => item.usrNm === list.id)) {
					//Array에 usrNm 의 값중에 list.id와 같은 값이 있으면 true
				} else {
					appArray.push({
								gb: "결재",
								usrNm: list.id,
								name: list.name,
								jik: list.levelNm,
								dtNm: list.deptNm,
								telNo: list.telNo,
								offTelNo: list.offTelNo,
								email: list.email,

							});
				}
			}
		});
		return appArray;
	}
</script>