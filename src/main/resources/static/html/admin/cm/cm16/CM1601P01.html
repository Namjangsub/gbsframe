<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">문제현황 등록</h4>
	</div>
	<input type="file" id="notiFile" style="display:none" multiple="multiple" onchange="setNotiFile(this);"/>
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
			<input type="hidden" id="pgmId"     	name="pgmId"	value="CM1601M01">
			<table>
				<colgroup>
					<col width="15%">
					<col width="35%">
					<col width="15%">
					<col width="35%">
				</colgroup>

				<tr>
					<th class="hit">회사</th>
						<td>
							<select id="coCd" name="coCd" data-kind="CO" data-search="coCd" required>
						</td>
					<th class="hit">구분</th>
					<td>
						<select class="form-control" id="reqType" name="reqType" data-search="reqType" data-kind="ITSMREQ" required msg="구분종류">
							<option value="">선택</option>
						</select>
					</td>
				</tr>
				<tr>
					<th class="hit">요청자</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="reqId" name="reqId" required msg="요청자"> <a onclick="openUserSearch();"><i class="i_search_w"></i></a>
								<input type="text" id="reqIdNm" name="reqIdNm"  onkeyup="event.keyCode === 8 ? reqId.value = '' : (event.keyCode === 13 ? openUserSearch() : true);" required msg="요청자">
							</div>
						</td>
					<th class="hit">요청일시</th>
					<td>
						<input id="reqDttm" name="reqDttm" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date >
					</td>
				</tr>
				<tr>
					<th>처리자</th>
					<td>
						<input type="hidden" id="actId" name="actId" msg="처리자ID">
						<div class="search_form">
							<input type="text" id="actIdNm" name="actIdNm" class="form-control" required msg="처리자">
							<a onclick="openUserSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>처리일시</th>
					<td>
						<input id="actDttm" name="actDttm" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" required date>
					</td>
				</tr>
				<tr>
					<th class="hit">조치상태</th>
					<td>
						<select class="form-control" id="actCd" name="actCd" data-kind="ISSSTS" required msg="조치상태">
							<option value="">선택</option>
						</select>
					</td>
					<th>담당투입시간</th>
					<td>
						<input type="text" class="form-control" id="actProcTm" name="actProcTm" required="required" class="form-control" msg="담당투입시간"
						oninput="this.value=setWorkRptHour(this.value)" onblur="this.value=setWorkRptHour2(this.value)">
					</td>
				</tr>
				<tr>
					<th>문제</th>
					<td colspan="3">
						<textarea rows="4" class="form-control" id="issue" name="issue" data-search="issue" class="form-control"  msg="문제내용"></textarea>
					</td>
				</tr>
				<tr>
					<th>처리내용</th>
					<td colspan="3">
						<textarea rows="4" class="form-control" id="actDesc" name="actDesc" data-search="actDesc" class="form-control"  msg="처리내용"></textarea>
					</td>
				</tr>
				<tr>
					<th>비고</th>
					<td colspan="3">
						<textarea rows="4" class="form-control" id="rmk" name="rmk" data-search="rmk" class="form-control"  msg="비고"></textarea>
					</td>
				</tr>
			</table>
            <div  id="dayilyRpt" style="margin-bottom: 40px;"></div>
		</div>
	</form>
</div>

<!-- 공통 파일 영역 -->
<div id="fileList_area"></div>
<!-- 하단 버튼 -->
<div class ="popup_bottom_btn">
	<!-- 등록에 authChk 넣어야함 -->
	<button type="button" id="actionBtn">등록</button>
	<button type="button" class="close_btn"
	onclick="modalStack.close();">닫기</button>
</div>

<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;

	$(document).ready(function() {
	debugger;
	    // select 요소에 데이터를 채우는 함수 호출
	    setCommonSelect($(".popup_area select[data-kind]"));
	
	    // 요청일자 설정
	    $('#reqDttm').datepicker({
	        format : "yyyy-mm-dd",
	        language : "ko",
	        autoclose : true
	    }).datepicker("setDate", new Date());
	
	    // 처리일자 설정
	    $('#actDttm').datepicker({
	        format : "yyyy-mm-dd",
	        language : "ko",
	        autoclose : true
	    }).datepicker("setDate", new Date());
	
	    // 변수 설정
	    actionType = modalStack.last().paramObj.actionType;
	    fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
	    $("#fileTrgtKey").val(fileTrgtKey);
	
	    // 등록 모드일 때
	    if (actionType == "C") {    
		    // 조치자, 회사코드 들어오기
			$("#popForm #actId").val(jwt.userId);
	        $("#popForm #actIdNm").prop('readonly', true).val(jwt.userNm); // 처리자 읽기
	
	        // modal에 전달된 값 설정
	        $.each(modalStack.last().paramObj, function (key, val) {
	            if( $("#popForm").find("#" + key).length > 0 ) {
	                $("#popForm").find("#" + key).val(val);
	            }
	        });
	
	        // 사용자 ID와 부서 설정
	        $("#popForm #reqId").val(jwt.userId);
	        $("#popForm #reqIdNm").val(jwt.userNm);
	        
	        // 등록 버튼 클릭 시 insertItoaIssue 함수 호출
	        $("#actionBtn").text("등록");
	        $('#actionBtn').on("click", function() {
	            insertItoaIssue();
	        });
	
	    } else if (actionType == "U" || actionType == "I") {  
	        $('.tit').text('문제현황 수정');
	        selectItoaIssueInfo(); // 문제 현황 정보 불러오기
	
	        if (actionType == "U") {
	            $('#actionBtn').text("수정");
	            $('#actionBtn').on('click', function() {
	                $('#actCd');
	                insertItoaIssue();
	            });
	        } else {
	            // 조회 모드일 때 버튼 및 검색 아이콘 제거
	            $('#actionBtn').remove();
	            $('.i_search_w').remove();
	
	            // input, textarea, select 모두 읽기 전용 또는 비활성화
	            $.each($('#popForm select, input, textarea'), function(idx, elem) {
	                var id = $(elem).attr("id");
	                if (id) {
	                    var eleId = "#popForm #" + id;
	                    if ($(elem).prop('tagName') == "INPUT") $(eleId).attr("readonly", true);
	                    if ($(elem).prop('tagName') == "TEXTAREA") $(eleId).attr("readonly", true);
	                    if ($(elem).prop('tagName') == "SELECT")$(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
	                    if ($(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
	                    if ($(elem).prop('tagName') == "BUTTON")$(eleId).remove();
	                }
	            });
	        }
	    }
	
		//---------------------------------------------------------------  
		//첨부 화일 처리 시작 
		//---------------------------------------------------------------  
		fileParam = {
	        fileTrgtTyp   : $("#popForm #pgmId").val(),
	        fileTrgtKey      :fileTrgtKey
		}
		treeModule.initAll('deptTreeOrdars', 'file-grid', 'FILETREE', fileParam);
		//---------------------------------------------------------------  
		//첨부 화일 처리 끝
		//---------------------------------------------------------------  
	});

	
	// 구분, 조치상태 코드
	// function selectCodeList(obj,idx) {
	// 	var codeKind = $(obj).val();
	// 	var target = $(obj).next('select.division');
	// 	if(idx == 0){
	// 		target = $("#workRptM");
	// 		$('#workRptM option[value!=""]').remove();
	// 		$('#workRptS option[value!=""]').remove();
	// 	}else{
	// 		target = $("#workRptS");
	// 		$('#workRptS option[value!=""]').remove();
	// 	}
	// 	var paramObj = {"codeKind": codeKind};

	// 	postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data){
	// 		var optionHtml = '';
	// 		var childCodeList = data.childCodeList;
	// 		$.each(childCodeList, function(index, item) {
	// 			// optionHtml += '<option value='+item.codeId+' >';
	// 			//data-etc = 'Y' 이면 saledCode 필수 'N' 이면 옵션으로 설정
	// 			optionHtml += '<option value="'+item.codeId+'" data-rprc="'+item.codeRprc+'" data-etc="'+item.codeEtc+'"">';
	// 			optionHtml += item.codeNm;
	// 			optionHtml += '</option>';
	// 		});
	// 		$(target).append(optionHtml);
			
	//         selectSalesCodeSet();
	// 	});
	// }


	// function selectItoaIssueInfo() {
	// 	var formData = {
	// 		"itoaIssueNo" : itoaIssueNo,
	// 	}
	// 	postAjaxSync("/admin/cm/cm16/selectItoaIssueInfo", formData, null, function(data) {
	// 		$.each(data.result, function(key, value) {
	// 			if ($('#popForm #' + key)[0]) {
	// 				$('#popForm #' + key).val(value);
	// 				if ($('#popForm #' + key).is('[comma]')) {
	// 					onlyNumber($('#popForm #' + key)[0]);
	// 				}
	// 			}
	// 		});

	// 	  	txtareaHeightResize($('#issue'));  //문제 크기 조절하기
	// 	  	txtareaHeightResize($('#actDesc'));  //처리내용 크기 조절하기
	// 	  	txtareaHeightResize($('#rmk'));  //비고 크기 조절하기
			
	// 	});
	// }

		function selectItoaIssueInfo() {
		// itoaIssueNo가 정의되지 않았을 수 있으니 확인
		var formData = {
			"itoaIssueNo": itoaIssueNo, // itoaIssueNo가 제대로 설정되어 있는지 확인
		};

		// formData에 제대로 값이 들어갔는지 확인하는 로그
		console.log("서버로 보낼 데이터:", formData);

		// 서버로 AJAX 요청을 보냄
		postAjaxSync("/admin/cm/cm16/selectItoaIssueInfo", formData, null, function(data) {
			// 서버 응답 데이터 확인
			console.log("서버 응답 데이터:", data);

			// 응답에 문제가 있는지 체크
			if (!data || !data.result) {
				console.error("서버에서 반환된 데이터가 없습니다.");
				alert("서버에서 데이터를 불러오지 못했습니다. 다시 시도해주세요.");
				return;
			}

			// 응답 데이터를 폼에 채워 넣음
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					
					// 숫자 관련 필드일 경우 comma 처리를 하는 부분
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
			});

			// 각 텍스트 에어리어 크기 조절
			txtareaHeightResize($('#issue'));
			txtareaHeightResize($('#actDesc'));
			txtareaHeightResize($('#rmk'));

		}, function(jqXHR, textStatus, errorThrown) {
			// 요청이 실패했을 때의 오류 로그
			console.error("AJAX 요청 실패:", textStatus, errorThrown);
			alert("서버와의 통신에 실패했습니다. 다시 시도해주세요.");
		});
	}
	
	// 등록
	function insertItoaIssue() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			if (formData) {
				filePostAjax("/admin/cm/cm16/itoaInsertIssue", formData, function(data) {
							if (data.resultCode == 200) {	//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
								modalStack.last().callback(data);
								if (typeof gridView !== 'undefined' && gridView !== null) {
									gridView.setData(0);
								}
								modalStack.close();									// 모달을 닫음
							}
						});
			}
		}
	}

	// 수정
	function updateItoaIssue() {

		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
	    	//문제여부가 이면 제목 입력은 필수처리하기 위함
	        // if ($('#issueYn').val() === 'Y') {
	        //   if ($.trim($('#issueTitle').val()) === '') {
	        //     alert('문제발생시 제목입력은 필수입니다.');
	        //     return false;
	        //   }
	        // }
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성\
			for (let key of formData.keys()) {
			}
	      	filePostAjax("/admin/cm/cm16/itoaUpdateIssue", formData,function(data) {
// 						alert(data.resultMessage);
						if (data.resultCode == 200) {
							// if ($("#issueYn").val() == 'Y') { 
                            //     kakaoTodo();
                            // }
							modalStack.last().callback(data);
							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
		
// 		if (조건) {
// 			alert("오류 확인 바랍니다.");
// 			return false;
// 		}
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);


      //---------------------------------------------------------------
      //-------itemarr  --첨부화일 처리를 위한 부분 시작
      //---------------------------------------------------------------
      formData.append("ordrsNo", $("#ordrsNo").val());
      formData.append("userId" , jwt.userId);
      formData.append("clntCd" , $('#clntCd').val());         //첨부화일용
      formData.append("prdtCd" , $('#prdtCd').val(""));         //첨부화일용
      formData.append("itemCd" , $('#itemDiv').val(""));         //첨부화일용
      formData.append("prjctCd", $('#clntPjt').val());      //첨부화일용
      formData.append("comonCd", treeModule.getFileNodeId());   //첨부화일용
      
      //---------------------------------------------------------------  
        
      //---------------------------------------------------------------  
      var fileUploadArr = [];
      var tempArr = [];
      
      tempArr = treeModule.getFileArr();
      $.each(tempArr, function(idx, obj) {
         if (obj.fileKey == 0) {
                formData.append("files", obj.file);
                obj.file = '';
                fileUploadArr.push(obj);
         }
      });

      formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
      formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));
      
      
      //---------------------------------------------------------------  
      //--첨부화일 처리를 위한 부분 끝
      //--------------------------------------------------------------- 

	
		return formData;
	}


	// 요청자 검색 //
	function openUserSearch() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId" : $('#reqId').val(),
			"userNm" : $('#reqIdNm').val(),
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function(tree) {
					var checkedId = tree.get_checked()[0];
					var checkedNode = tree.get_node(checkedId);

					$('#reqId').val(checkedNode.id);
					$('#reqIdNm').val(checkedNode.text);
					// gridView.setData(0);
				});
	}

	// 담당투입시간
	function setWorkRptHour(_value) {
		var value = _value.replace(/[^0-9.]/g, "");
// 		value = value.toLocaleString();
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return 24;
		}
		return value;
	}

	//담당투입시간 포커스를 빠져나갈때 실행됨
	function setWorkRptHour2(_value) {
		var value = parseFloat(_value.replace(/[^0-9.]/g, "")).toFixed(2);
		value = value.toLocaleString();
		value = value == 'NaN' ? 0 : value;
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return 24;
		}		
		if(value == 0) {
			return "";
		}
		return value;
	}
    
	$("#popForm #workRptM").change(function() {
		var workRptS = $("#workRptS").val();
		var workTime = $("#workRptHour").val();
	    var str = workRptS.substr(-5);
	    if (str == '09901'){
	    	$("#workRptHour").val("8");
	    }
	    else {
// 	    	$("#workRptHour").val("");
	    }
	});
	
	$("#popForm #workRptS").change(function() {
		var workRptS = $("#workRptS").val();
		var workTime = $("#workRptHour").val();
	    var str = workRptS.substr(-5);
	    if (str == '09901'){
	    	$("#workRptHour").val("8");
	    }
	    else {
// 	    	$("#workRptHour").val("");
	    }
	});
	
	$("#popForm #issueYn").change(function() {
		if ($("#issueYn").val() == 'Y'){
			//fileGridView.initView();
		    $("#field01").show();
		    $("#field02").show();
		}
		else {
			$("#field01").hide();
		    $("#field02").hide();
		}
	});
	
	function setNotiFileInfo(fileInfo) {
		// 첨부파일 set
		$.each(fileInfo, function(idx, obj){
			notiFileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'fileList' : obj.fileList,
		      	'fileUp' : obj.fileUp,
		      	'fileDown' : obj.fileDown,
		      	'fileDelete' : obj.fileDelete,
		      	'fileUpdate' : obj.fileUpdate,
		      	'file' : obj
			});
		});
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	function setNotiFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			var testArr = obj.name.split(".");
			notiFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : testArr[testArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj,
		      	'fileDelete':'Y'
			});
		fileGridView.setData();
		$(elem).val("");
		});
	}
	
	
	function deleteFile(rowIndex) {
        if (notiFileArr[rowIndex].fileDelete != 'Y') {
        	alert('파일 삭제 권한이 없습니다.')
        	return false;
        };
		
		fileGridView.target.removeRow(rowIndex);
		
		if(notiFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(notiFileArr[rowIndex].fileKey);
		}
		
		notiFileArr.splice(rowIndex, 1);
	}
	
	function selectNotiInfo(){
		var paramObj = {
				"fileTrgtKey": fileTrgtKey,
				"fileTrgtTyp" : "PM0101M01",
				"userId" : jwt.userId
				};
		
		postAjax("/user/pm/pm01/selectUploadFileList", paramObj, null, function(data){
			var list = data.result;
			setNotiFileInfo(list);
		});
		
		//파일 등록 권한이 없으면 버튼 비활성화
		paramObj.comonCd = 'FITR9902';
		postAjax("/admin/cm/cm15/selectTreeAuthUserList", paramObj, null, function(data){
			if (data.userList[0].fileUp == 'Y') {
				$('#buttonFile').prop('disabled', false); // 활성화
				$('#buttonFile').css('backgroundColor', ''); // 기본 배경색으로 변경 (옵션)
	        } else {
	        	$('#buttonFile').prop('disabled', true); uttonFile.disabled = true; // 비활성화
	        	$('#buttonFile').css('backgroundColor', 'gray');  // 회색 배경색으로 변경 (옵션)
	        }	
		});	
	}

	function downloadFile(idx) {
	    if (notiFileArr[idx].fileDown != 'Y') {
	    	alert('파일 다운로드 권한이 없습니다.')
	    	return false;
	    };
		
		var fileKey = notiFileArr[idx].fileKey;
		var paramObj = {
				"fileKey" : fileKey,
				"userId" : jwt.userId
			}		
		
		postAjax("/admin/cm/cm08/fileDownInfoUser", paramObj, null, function(data){
			if(data.resultCode == 200){
				var fileInfo = data.fileInfo;
				location.href = "/admin/cm/cm08/fileDownloadAuth?fileKey="+fileKey+"&userId="+jwt.userId;
			} else {
				alert("다운로드 권한이 없습니다.");	
			}
		});
	}	

	function txtareaHeightResize(obj) {
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 4)
			obj.css('height', "52px");
		else
			obj.css('height', (rowCount * 23) + "px");
	}
	
</script>