<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">문제현황 등록</h4>
	</div>
	<input type="file" id="notiFile" style="display:none" multiple="multiple" onchange="setNotiFile(this);"/>
	<input type="file" id="tripRptFile" style="display:none" onchange="setTripRptFile(this);"/>
	<form id="popForm" onSubmit="return false;">
		<div class="form-group popup_table">
			<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
			<input type="hidden" id="pgmId"     	name="pgmId"	value="PM0101M01">
			<input type="hidden" id="deptId"     	name="deptId">
			<input type="hidden" id="ordCoCd"     	name="ordCoCd" msg="오더도는 salesCode용 회사코드">
			<input type="hidden" id="coCd" name="coCd" required msg="회사">
			<input type="hidden" id="workRptNo" name="workRptNo" msg="작업일보번호">
			<input class="division" type="hidden" id="workRptL" name="workRptL" data-depth="0" onchange="selectCodeList(this,0);" required msg="작업대분류" >
			<input type="hidden" id="telNo"   name="telNo">
			
			<table>
				<colgroup>
					<col width="15%">
					<col width="35%">
					<col width="15%">
					<col width="35%">
				</colgroup>
				
				<tr>
					<th class="hit">작성자</th>
					<td>
						<input type="hidden" id="workRptId" name="workRptId" msg="작성자ID">
						<div class="search_form">
							<input type="text" id="workRptIdNm" name="workRptIdNm" class="form-control" required msg="작성자">
							<a onclick="openUserTree();"><i class="i_search_w"></i></a>
						</div>
					</td>
					
					<th class="hit">작성일자</th>
					<td>
						<input id="workRptDt" name="workRptDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  required msg="작성일자"
						date onchange="monthCloseChk(this.value);">
					</td>
				</tr>
				<tr>
					<th class="hit">작업분류</th>
					<td>
						<select class="form-control" id="workRptM" name="workRptM" onchange="selectCodeList(this,1);" data-depth="1" required msg="작업중분류">
						</select>
					</td>
					
					<th class="hit">작업구분</th>
					<td>
						<select class="form-control" id="workRptS" name="workRptS" onchange="selectSalesCodeSet();" data-depth="2" required msg="작업소분류">
						</select>
					</td>
				</tr>
				
				<tr>
					<th class="hit">작업시간</th>
					<td>
						<input type="text" class="form-control" id="workRptHour" name="workRptHour" maxlength="10" required="required" class="form-control" required msg="작업시간"
						oninput="this.value=setWorkRptHour(this.value)" onblur="this.value=setWorkRptHour2(this.value)">
					</td>
					
					<th>고객사</th>
					<td>
			            <input type="hidden" id="clntCd" name="clntCd" msg="고객사">
			            <div class="search_form">
			              <input type="text" id="clntNm" name="clntNm" class="form-control"  onchange="clntSearch();" onkeyup="event.keyCode == 8 ? clntCd.value = '' : event.keyCode == 13 ? clntSearch() : ''" >
			              <a onclick="clntSearch();"><i class="i_search_w"></i>
			              </a>
			            </div>
					</td>
				</tr>
				
				<tr>
					<th>수주번호</th>
					<td>
						<div class="search_form">
							<input type="text" class="form-control" id="ordrsNo" name="ordrsNo"  onchange="clearSalesCodeField();"  msg="수주번호">
							<a id="salesTarget" onclick="opendOrdrsSearch($('#ordrsNo').val(), $('#coCd').val());"><i class="i_search_w"></i></a>
						</div>
					</td>
					
					<th class="hit Sales_Code">Sales Code</th>
					<td>
						<div class="search_form">
							<input type="text" class="form-control" id="salesCd" name="salesCd" onchange="clearSalesCodeField();"  msg="Sales Code">
							<a  id="salesTarget" onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>
				
				<tr>
					<th>고객사PJT</th>
					<td>
						<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" data-search="clntPjt" class="form-control" msg="고객사PJT">
							<option value=""></option>
            			</select>
					</td>
					
					<th>설비명</th>
					<td colspan="1">
						<input type="text" class="form-control" id="eqpNm" name="eqpNm" data-search="eqpNm" msg="설비명">
					</td>
				</tr>
				
				<tr>
					<th>제품유형</th>
							<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" class="form-control" style="text-align: center;" readonly>
					<td colspan= "1">
				   		<div class="search_form">
				    	  	<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtNm" class="form-control" onkeyup="event.keyCode == 8 ? prdtCd.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''" >
					    	<a onclick="openPrdtSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>아이템구분</th>
					<td>
						<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv" class="form-control" msg="아이템구분">
							<option value=""></option>
            			</select>
					</td>
				</tr>
				
				<tr>
					<th>비고<br>(문제내용)</th>
					<td colspan="3">
						<textarea rows="2" class="form-control" id="workRptRmk" name="workRptRmk" data-search="workRptRmk" class="form-control"  msg="비고"></textarea>
					</td>
				</tr>
				<tr>
				  <th>문제유무</th>
				  <td>
					  <select id="issueYn" name="issueYn" data-search="issueYn" class="form-control" >
						  <option value="N">NO</option>
						  <option value="Y">YES</option>
					  </select>
				  </td>
				  <td  colspan="2"></td>
				</tr>
				<tr id="field01" style="display:none;">
					<th>문제제목</th>
					<td colspan="3">
					  <input type="text" id="issueTitle" name="issueTitle" class="form-control">
					</td>
				</tr>
				<tr id="field02">
				  <th>
					<button type="button" id="buttonFile" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="notiFile.click();">첨부파일</button>
				  </th>
				  <td colspan="3">
					<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
				  </td>
				</tr>
				<tr class="tripAreaButton">
					<th colspan=1>일일 출장비 내역 등록</th>
					<th><button type="button" id="addDayileRptTrpButton" class="btn btn-primary btn-sm" style="height: 35px; line-height: 15px;">경비추가</button> 
					<button type="button" id="removeDayileRptTrpButton" class="btn btn-primary btn-sm" style="height: 35px; line-height: 15px; display: none;">경비삭제</button></th>
				</tr>
			</table>
            <div  id="dayilyRpt" style="margin-bottom: 40px;"></div>
		</div>
	</form>
</div>

<!-- 공통 파일 영역 -->
<!-- <div id="fileList_area"></div> -->
<!-- 하단 버튼 -->
<div class ="popup_bottom_btn">
	<button type="button" id="actionBtn" authChk>등록</button>
	<button type="button" class="close_btn"
	onclick="modalStack.close();">닫기</button>
</div>

<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	var fileParam = null;

	// 카톡 정상알림 카운터 변수
	var kakaoCnt = 0;
	var kakaoErr = [];
	
	
	//등록시 직급코드 중복체크 여부
	var isChecked = false;
	var notiFileArr = [];
	var deleteFileArr = [];
	
	var rptTripFileArr = []; //경비항목별 첨부파일 정보 임시저장
	var tripRptRowDeleteArr = []; //경비 등록내용 삭제 임시저장
	var tripRptRowFileDeleteArr = []; //경비 등록내용중 첨부파일만 삭제 임시저장
	var lastPosition = "";
	
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        	},
				columns: [
						{key: "fileName", label: "파일명", width: 240},
						{key: "fileType", label: "파일타입", width: 80, align: "center"},
						{key: "fileSize", label: "파일크기", width: 80,  align: "right", formatter: "money"},
						{key: "fileDelBtn", label: "삭제", width:50,
							formatter:function() {return (this.item.fileDelete == "Y") ? '<button style="height: 18px; padding:0px;" type="button" onclick="deleteFile('+this.dindex+')">삭제</button>' : '불가'}
						},
						{key : "fileList",  label : "list",	 width : 60, align: "center", hidden: true},
						{key : "fileUp",  label : "up",	 width : 60, align: "center", hidden: true},
						{key : "fileDown",  label : "down",	 width : 60, align: "center", hidden: true},
						{key : "fileUpdate",  label : "update",	 width : 60, align: "center", hidden: true},
						{key : "fileDelete",  label : "delete",	 width : 60, align: "center", hidden: true},
				]
			});
		},
		setData: function(){
			var targetObj = this.target;
			targetObj.setData({
				list: notiFileArr,
				page : {
					totalElements : notiFileArr.length
				}
			});
		}
	}

	$(document).ready(function() {
		fileGridView.initView();
		$("#popForm #coCd").val(modalStack.last().paramObj.coCd);

		setCommonSelect($(".popup_area select[data-kind]"));
		setWorkPtDept(jwt.deptId);//자동분류 자동선택

		//작성일자//
		$('#workRptDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		}).datepicker("setDate", new Date());

		actionType = modalStack.last().paramObj.actionType;
		fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
		$("#fileTrgtKey").val(fileTrgtKey);
		
// 		$("#clntNm").prop("readonly", true);
// 	    $("#clntPjtNm").prop("readonly", true);
// 	    $("#prdtCdNm").prop("readonly", true);
// 	    $("#itemDivNm").prop("readonly", true);
// 	    $("#eqpNm").prop("readonly", true);

		if (actionType == "C") {	
			$("#popForm #workRptIdNm").prop('readonly', true).val(jwt.userNm); //작성자 읽기전용
			$('a[onclick="openUserTree();"]').remove();						   //사용자검색 돋보기 제거

			//modal 넘어온값만큼 만큼 루프 
			$.each(modalStack.last().paramObj, function (key, val) {
				if( $("#popForm").find("#"+key).length > 0 ) {
					$("#popForm").find("#"+key).val(val);
				}
				if (key == 'workRptM'){//소분류 select 코드 세팅
					selectCodeList($("#workRptM"),1);
				}
				if (key == 'workRptHour'){//작업시간 빈값 세팅
					$("#workRptHour").val("");
				}
				if (key == 'workRptRmk'){//비고 빈값 세팅
					$("#workRptRmk").val("");
				}
				if (key == 'issueYn'){//문제유무 세팅
					$("#issueYn").val("N");
				}
				if (key == 'issueTitle'){//문제제목 빈값
					$("#issueTitle").val("");
				}
			});


			$("#popForm #workRptId").val(jwt.userId);
			$("#popForm #workRptIdNm").val(jwt.userNm);
			$("#popForm #deptId").val(jwt.deptId);
			
			$("#actionBtn").text("등록");
			$('#actionBtn').on("click", function() {
				insertDailyWork();
			});

		} else if (actionType == "U" || actionType == "I") {  //"I" --> 문제현황에서 조회모드로 넘어온 파라메터임 (BM1901M01.html)
			$('.tit').text('작업일보 수정')
			selectDailyWorkInfo();

			if (actionType == "U") {
				$('#actionBtn').text("수정");
				$('#actionBtn').on("click", function() {
					updateDailyWork();
				});
			} else {
				//"I" --> 문제현황에서 조회모드로 넘어온 파라메터임 (BM1901M01.html)
				 $('#actionBtn').remove();  //"I" --> 문제현황에서 조회모드로 넘어온 파라메터임 (BM1901M01.html)
				 $('.i_search_w').remove();
				 
				//input readonly, radio.checkbox disabled
				$.each($('#popForm select, input, textarea, button'), function(idx, elem){
					var id = $(elem).attr("ID");
					if( id ) {
						var eleId = "#popForm #"+id;
						if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
						if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
						if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
						if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
						if( $(elem).prop('tagName') == "BUTTON" ) $(eleId).remove();
					} 
					
				});	
		    
			}
		}

		// Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅 
	     var paramObj1 = {
	             "coCd" : $("#popForm #coCd").val(),
	             "userId" : jwt.userId
	         }; 
	      postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){  
	          if (data.result[0] == undefined
	                || data.result[0].telNo == "") {
	              $("#popForm #telNo").val("051-312-2400");  
	          }
	          else {
	              $("#popForm #telNo").val(data.result[0].telNo);           
	          }
	      }); 
	     //---------------------------------------
	     
         
        //화면 필드 기능 추가 함수 모음
        fieldFunctionControl();
	     
		$("#field02").hide();
		authChk();						// 권한체크
	});
	
	//세션의 부서코드로 작업 대분류/중분류/소분류 자동셋팅
	function setWorkPtDept(deptId) {
		//$("#deptId").val("GUN70");//임시 GUN1010, GUN6010, TRN1099
	    if (deptId) {
	    	$("#workRptL").val(deptId.substring(0,5));
		    selectCodeList($("#workRptL"),0);
		    selectCodeList($("#workRptM"),1);
		}
	}


	//화면 필드 기능 추가 함수 모음
	function fieldFunctionControl() {
	    //---------------------------------------
	    //경비추가 버튼
		$('#addDayileRptTrpButton').click(function() {
			dailyRptTripAdd();
		});

	    //경비제거 버튼
		$('#removeDayileRptTrpButton').click(function() {
			
//	 		let tripCnt = $('.tripTable').not(':hidden').length;  //$('.tripTable:not(:visible)' --> tripTable1 display: none이 아닌 요소 선택
//	 		if ($('#tripTable' + tripCnt + ' #updCheck').val() == 'U') {
//					$('#tripTable' + tripCnt + ' #updCheck').val('D');		//DB에서 불러오면 수정임 'U', 처음 등록시 C, 제거시 'D'
//	 		} else {
//	 			$('#tripTable' + tripCnt + ' #updCheck').val('');		//처음 생성한다음 삭제인경우 처리 제외 blank
//	 		}
//	 		$('#tripTable' + tripCnt).hide();  //마지막 테이블 숨기기

			let tripCnt = $('.tripTable').length;
			if (tripCnt == 0)  return false;
			if (tripCnt == 1) $('#removeDayileRptTrpButton').hide();
			
			if ($('#tripTable' + tripCnt + ' #updCheck').val() == 'U') {
				$('#tripTable' + tripCnt + ' #updCheck').val('D');		//DB에서 불러오면 수정임 'U', 처음 등록시 C, 제거시 'D'
	    		tripRptRowDeleteArr.push(tripRptRow(tripCnt));	//삭제대상으로 저장함
			} 
			
			$('#tripTable' + tripCnt).remove();  //마지막 테이블 지우기
			
		});

		$('#tripRptCurTyp').on('change', function () {
			//결제방법인 카드인경우는 카드번호 필수임
			if (this.value == 'CURTYP01') {
				$('#tripTable' + this.idxCnt + ' #cardTh').addClass('hit');
				$('#tripTable' + this.idxCnt + ' #tripRptCardNo').attr('required', '');
			} else {
				$('#tripTable' + this.idxCnt + ' #cardTh').removeClass('hit');
				$('#tripTable' + this.idxCnt + ' #tripRptCardNo').removeAttr('required', '');
			}
		});

	}
	 

	//경비추가 버튼 기능  수행
	function dailyRptTripAdd() {
			let tripCnt = $('.tripTable').length;
			$('#removeDayileRptTrpButton').show();
			if ($('#tripTable' + tripCnt).css('display') === 'none') {
//	 	        console.log('마지막 tripTable 숨김상태');
	    		if ($('#tripTable' + tripCnt + ' #updCheck').val() == 'D') {
	 				$('#tripTable' + tripCnt + ' #updCheck').val('U');		//DB에서 불러오면 수정임 'U' --> D --> U
	    		} else {
	    			$('#tripTable' + tripCnt + ' #updCheck').val('C');		//처음 생성한다음 삭제인경우 C --> null --> C
	    		}
	    		$('#tripTable' + tripCnt).show();  //마지막 테이블 숨기기
		    } else {
//	 	        console.log('마지막 tripTable 활성상태');
				tripCnt += 1;
		
		        let newRow = $('<table id="tripTable'+ (tripCnt) +'" class="tripTable" style="margin-top: 20px; display:break"> ' +
		        	'<tr class="tripArea">' +
		            '<th class="hit">비용항목</th>' +
		            '<td>' +
		            '<select id="tripRptTyp" name="tripRptTyp" data-kind="TRPTYP" data-search="tripRptTyp" class="form-control" msg="비용항목" required>' +
		            '<option value=""></option>' +
		            '</select>' +
		            '</td>' +
		            '<th>내용</th>' +
		            '<td>' +
		            '<input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">' +
		            '<input type="hidden" id="updCheck" name="updCheck" value="C">' +
		            '<input type="hidden" id="workRptNoSeq" name="workRptNoSeq" value=' + tripCnt +'>' +
		            '<input type="text" id="tripRptRmk" name="tripRptRmk" data-search="tripRptRmk" class="form-control" msg="내용">' +
		            '</td>' +
		            '</tr>' +
		            '<tr class="tripArea">' +
		            '<th class="hit" >결제방법</th>' +
		            '<td>' +
		            '<select id="tripRptCurTyp" name="tripRptCurTyp" data-kind="CURTYP" idxCnt="' + tripCnt + '" data-search="tripRptCurTyp" class="form-control" msg="결제방법" required>' +
		            '<option value=""></option>' +
		            '</select>' +
		            '</td>' +
		            '<th id="cardTh">카드번호(끝4자리)</th>' +
		            '<td>' +
		            '<input type="text" id="tripRptCardNo" name="tripRptCardNo" idxCnt="' + tripCnt + '" maxlength="4" data-search="tripRptCardNo" class="form-control" msg="카드번호">' +
		            '</td>' +
		            '</tr>' +
		            '<tr class="tripArea">' +
		            '<th class="hit" >통화종류</th>' +
		            '<td>' +
		            '<select id="tripRptCurr" name="tripRptCurr" data-kind="CURR" data-search="tripRptCurr" class="form-control" msg="통화종류" required>' +
		            '<option value=""></option>' +
		            '</select>' +
		            '</td>' +
		            '<th class="hit" >금액</th>' +
		            '<td>' +
		            '<input type="text" id="tripRptAmt" name="tripRptAmt" value=0  data-search="tripRptAmt" class="form-control" onkeyup="onlyNumber(this);;" comma="" msg="금액" required>' +
		            '</td>' +
		            '</tr>' +
		            '<tr class="tripArea">' +
		            '<th colspan="1"></th><th>' +
		            '<button type="button" id="buttonFile3" class="btn btn-primary btn-sm" style="height: 30px; line-height: 10px;" onclick="setTripRptButton(' + tripCnt + ' );">파일선택</button>' +
		            '</th>' +
		            '<td colspan="2">' +
		            '<input type="text" id="tripRptFileNm" name="tripRptFileNm" class="form-control" readonly onclick="downloadTripRptFile(' + tripCnt +');"msg="첨부파일명">' +
		            '<input type="hidden" id="fileKey" name="fileKey" class="form-control" msg="첨부파일명">' +
		            '</td>' +
		            '</tr>' +
		            '</table>');
		        $('#dayilyRpt').append(newRow);
		
				setCommonSelect($('#tripTable' + tripCnt + ' #tripRptTyp'));
				setCommonSelect($('#tripTable' + tripCnt + ' #tripRptCurTyp'));
				setCommonSelect($('#tripTable' + tripCnt + ' #tripRptCurr'));
				
		    }
	}



	function chechChange(elm) {
		elm.value = addCommaStr(gPasFloatChk(elm.value));
	}

	function clearSalesCodeField() {
		if ($("#salesCd").val()== "") {
			clntNm.value = '';
			eqpNm.value = '';
			clntPjtNm.value = '';
			itemDivNm.value = '';
			prdtCdNm.value = '';
		}
	}
	
	//작업 대분류/중분류/소분류
	function selectCodeList(obj,idx) {
		var codeKind = $(obj).val();
		var target = $(obj).next('select.division');
		if(idx == 0){
			target = $("#workRptM");
			$('#workRptM option[value!=""]').remove();
			$('#workRptS option[value!=""]').remove();
		}else{
			target = $("#workRptS");
			$('#workRptS option[value!=""]').remove();
		}
		var paramObj = {"codeKind": codeKind};

		postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data){
			var optionHtml = '';
			var childCodeList = data.childCodeList;
			$.each(childCodeList, function(index, item) {
				// optionHtml += '<option value='+item.codeId+' >';
				//data-etc = 'Y' 이면 saledCode 필수 'N' 이면 옵션으로 설정
				optionHtml += '<option value="'+item.codeId+'" data-rprc="'+item.codeRprc+'" data-etc="'+item.codeEtc+'"">';
				optionHtml += item.codeNm;
				optionHtml += '</option>';
			});
			$(target).append(optionHtml);
			
	        selectSalesCodeSet();
		});
	}


	//Sales Code 필수 변경
	function selectSalesCodeSet() {
	    if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
	        $('#popForm .Sales_Code').addClass('hit');
	        $('#popForm input#salesCd').attr('required');
	        $("#salesTarget").attr("onclick", "wbsSalesCodeSearch();").removeClass("disabled");
	    } else {
	        $('#popForm .Sales_Code').removeClass('hit');
	        $('#popForm input#salesCd').removeAttr('required');
// 	        $("#salesTarget").removeAttr("onclick").addClass("disabled");
	    }
	}

	function selectDailyWorkInfo() {						//그리드에 뿌리는 데이터
		var formData = {
			"fileTrgtKey" : fileTrgtKey,
		}
		postAjaxSync("/user/pm/pm01/selectDailyWorkInfo", formData, null, function(data) {
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}

			});
			selectNotiInfo();
			//수정시 폼 세팅
			if ($("#issueYn").val() =='Y'){
				  $("#field01").show();
				  $("#field02").show();
			}
			else {
				$("#field01").hide();
				$("#field02").hide();
			}
			//본인 작업일보만 수정가능함.
			if ($('#workRptId').val() != jwt.userId) {
				$('#actionBtn').hide();
			}
		  	txtareaHeightResize($('#workRptRmk'));  //비고 크기 조절하기
		  	  
			//상위코드 연동으로 바뀌기 전에 저장값 설정되므로 재설정 필요함
			selectCodeList($("#workRptL"),0);
			$('#popForm #workRptM').val(data.result.workRptM);
			
			selectCodeList($("#workRptM"),1);
			$('#popForm #workRptS').val(data.result.workRptS);
    	 	//경비내용 처리를 위한 루틴
    	 	let tripRows = data.tripRows;
    	 	if (tripRows && tripRows.length > 0) {
    	 		for (var i = 0; i < tripRows.length; i++) {
    	 			dailyRptTripAdd(); //입력필드 생성
    	 			$('#tripTable' + (i+1) + ' #updCheck').val('U');		//DB에서 불러오면 수정임 'U', 처음 등록시 C, 제거시 'D'
    	            $.each(tripRows[i], function(key, value) {
    	                if ($('#tripTable' + (i+1) + ' #' + key)) {
    	                    if ($('#tripTable' + (i+1) + ' #' + key).is('[comma]')) {
	    	                    $('#tripTable' + (i+1) + ' #' + key).val(addCommaStr(value));
    	                    } else {
	    	                    $('#tripTable' + (i+1) + ' #' + key).val(value);
    	                    }
    	                }
    	            });
    	 			
   	        		//결제방법인 카드인경우는 카드번호 필수임
   	        		if (tripRows[i].tripRptCurTyp == 'CURTYP01') {
   	        			$('#tripTable' + (i+1) + ' #cardTh').addClass('hit');
   	        			$('#tripTable' + (i+1) + ' #tripRptCardNo').attr('required', '');
   	        		} else {
   	        			$('#tripTable' + (i+1) + ' #cardTh').removeClass('hit');
   	        			$('#tripTable' + (i+1) + ' #tripRptCardNo').removeAttr('required', '');
   	        		}
    	 		}
    	 	}
			
			monthCloseChk($('#workRptDt').val());
		});
	}
	
	// 등록
	function insertDailyWork() {
		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
	    	//문제여부가 이면 제목 입력은 필수처리하기 위함
	        if ($('#issueYn').val() === 'Y') {
	          if ($.trim($('#issueTitle').val()) === '') {
	            alert('문제발생시 제목입력은 필수입니다.');
	            return false;
	          }
	        }
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
			filePostAjax("/user/pm/pm01/insertDailyWork", formData,				// 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
					function(data) {
// 						alert(data.resultMessage);	
						modalStack.last().callback(data.resultCode);							// 결과 메시지를 alert으로 출력
						if (data.resultCode == 200) {	//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
							if ($("#issueYn").val() == 'Y') { 
								kakaoTodo();
							}
							modalStack.last().callback(data);
							if (typeof gridView !== 'undefined' && gridView !== null) {
								gridView.setData(0);
							}
							modalStack.close();									// 모달을 닫음
						}
					});
		}
	}

	// 수정
	function updateDailyWork() {

		if (inputValidation($('.popup_area [required]'))) {						// 필수 필드의 유효성 검사
	    	//문제여부가 이면 제목 입력은 필수처리하기 위함
	        if ($('#issueYn').val() === 'Y') {
	          if ($.trim($('#issueTitle').val()) === '') {
	            alert('문제발생시 제목입력은 필수입니다.');
	            return false;
	          }
	        }
			var formData = makeFormData();										// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성\
			for (let key of formData.keys()) {
			}
	      	filePostAjax("/user/pm/pm01/updateDailyWork", formData,function(data) {
// 						alert(data.resultMessage);
						if (data.resultCode == 200) {
							if ($("#issueYn").val() == 'Y') { 
                                kakaoTodo();
                            }
							modalStack.last().callback(data);
							gridView.setData(0);
							modalStack.close();
						}
					});
		}
	}

	//----------------------------------------------//

	function makeFormData() {
		// 금액 콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem) {
			deleteComma(elem);
		});
		// 날짜 하이픈 제거
		$.each($('.popup_area input[date]'), function(idx, elem) {
			deleteHyphen(elem);
		});
	    
// 	    if ($('#workRptS').find('option:selected').data('etc') === 'N') {
// 	    	$('#salesCd').val("");
// 	        $("#clntNm").val("");
// 	        $("#clntPjtNm").val("");
// 	        $("#prdtCdNm").val("");
// 	        $("#itemDivNm").val("");
// 	        $("#eqpNm").val("");
// 	    }
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		// 첨부파일 추가
		$.each(notiFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		if(actionType == "U"){
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		}
		//---------------------------------------------------------------
		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//---------------------------------------------------------------
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		formData.append("clntCd", $('#clntCd').val());			//첨부화일용
		formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
		formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
		formData.append("itemDiv", $('#itemDiv').val());		
		formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
		formData.append("clntPjt", $('#clntPjt').val());		

		//-------itemarr  --첨부화일 처리를 위한 부분 시작
		//formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
		formData.append("comonCd", "FITR9902");	//첨부화일용

		//---------------------------------------------------------------

        //---------------------------------------------------------------
		var fileUploadArr = [];
		var tempArr = [];

		// tempArr = treeModule.getFileArr();
		// $.each(tempArr, function(idx, obj) {
		// 	if (obj.fileKey == 0) {
        //         formData.append("files", obj.file);
        //         obj.file = '';
        //         fileUploadArr.push(obj);
		// 	}
		// });

		formData.append("uploadFileArr",  JSON.stringify(notiFileArr));
		//---------------------------------------------------------------
		//--첨부화일 처리를 위한 부분 끝
		//---------------------------------------------------------------

		//경비 테이블의 값을 arry로 변환하여 저장하기
		let tripCnt = $('.tripTable').length;
		let tripRptS = [];	//경비현황 저장,  파일정보는 별도 보관됨 rptTripFileArr에 보관되어 있음
		for (var i = 1; i < tripCnt+1; i++) {
	
		  	let tripRptCurTyp = $('#tripTable' + i + ' #tripRptCurTyp').val();
		  	let tripRptCardNo = $('#tripTable' + i + ' #tripRptCardNo').val();
	   		if (tripRptCurTyp == 'CURTYP01') {
	    		//결제방법인 카드인경우는 카드번호 필수임
	    	    if (tripRptCardNo.length == 4 && /^\d+$/.test(tripRptCardNo)) {
	    	    } else {
	    	    	alert ("카드번호 끝 4자리를 입력하세요!");
	    	    	$('#tripTable' + i + ' #tripRptCardNo').focus();
	    	    	return false;
	    	    }
	   		}
	   		
		  	let tripRptAmt = gPasFloatChk($('#tripTable' + i + ' #tripRptAmt').val());
	   		if (tripRptAmt == 0) {
		    	alert ("금액을 입력하세요!");
		    	$('#tripTable' + i + ' #tripRptAmt').focus();
		    	return false;
		    }
	
	    	tripRptS.push(tripRptRow(i));
		}
		
		//paramMap.get("tripRptS")				-->최종입력된  경비내역 정보
		//paramMap.get("tripRptRowDeleteArr")	-->수정중 삭제된 경비내역 정보
		//paramMap.get("rptTripFiles"+xx)		-->최종입력됨 경비내역 첨부파일 file object임
		// 서버에서 작업시는 paramMap.get("tripRptRowDeleteArr")를 확인후 먼저 삭제 로직 수행후 paramMap.get("tripRptS") 처리해야함.
		formData.append("tripRptS",  JSON.stringify(tripRptS)); //수정된 경비내역 서버로 전송
		formData.append("tripRptRowDeleteArr",  JSON.stringify(tripRptRowDeleteArr));  //삭제된 경비내역 서버로 전송
		formData.append("tripRptRowFileDeleteArr",  JSON.stringify(tripRptRowFileDeleteArr));  //경비내역 수정시 삭제된 첨부파일정보
		//file object만 별도 추출 
		$.each(rptTripFileArr, function(idx, obj){
			// 신규파일만 추가
			formData.append("rptTripFiles" + obj.rptTripNo, obj.file);
		});
	
		return formData;
	}


	//경비 처리 변경 내역 저장 단 U인경우 삭제된것만 저장하면됨 
	//경비테이블의 값을 추출하기
	function tripRptRow(i) {
	  	let updCheck = $('#tripTable' + i + ' #updCheck').val();
	  	let fileTrgtKey = $('#tripTable' + i + ' #fileTrgtKey').val();
	  	let workRptNoSeq = $('#tripTable' + i + ' #workRptNoSeq').val();
	  	let tripRptTyp = $('#tripTable' + i + ' #tripRptTyp').val();
	  	let tripRptRmk = $('#tripTable' + i + ' #tripRptRmk').val();
	  	let tripRptCurTyp = $('#tripTable' + i + ' #tripRptCurTyp').val();
	  	let tripRptCardNo = $('#tripTable' + i + ' #tripRptCardNo').val();
	  	let tripRptCurr = $('#tripTable' + i + ' #tripRptCurr').val();
	  	let tripRptAmt = deleteCommaStr($('#tripTable' + i + ' #tripRptAmt').val());
	  	let tripRptFileNm = $('#tripTable' + i + ' #tripRptFileNm').val();
	  	let fileKey = $('#tripTable' + i + ' #fileKey').val();
	  	let tripRps = {
	  			updCheck 		: updCheck,		//파일저장정보 인덱스
	  			fileTrgtKey 	: fileTrgtKey,		//파일저장정보 인덱스
	  			workRptNoSeq 	: workRptNoSeq,		//파일저장정보 인덱스
	  			tripRptTyp		: tripRptTyp,
	  			tripRptRmk		: tripRptRmk,
	  			tripRptCurTyp	: tripRptCurTyp,
	  			tripRptCardNo	: tripRptCardNo,
	  			tripRptCurr		: tripRptCurr,
	  			tripRptAmt		: tripRptAmt,
	  			tripRptFileNm	: tripRptFileNm,
	  			fileKey			: fileKey,
	  			

	  		    coCd			: jwt.coCd,
	  		    workRptId		: jwt.userId,
	  		    workRptNo		: $('#workRptNo').val(), //수정모드일경우만 값이 존재함.
	  		    workRptDt		: $('#workRptDt').val(),
	  		    fileTrgtKey		: fileTrgtKey,
	  		    userId			: jwt.userId,
	  		    pgmId			: "PM0101D01_M"
	  	}
	  	return tripRps;
	}
	      

    //Sales Code 검색
    function wbsSalesCodeSearch() {
        var paramObj = {
           "coCd" : $('#coCd_S').val(),
           "salesCd": $('#salesCd').val()
        };
        openSecondModal("/static/html/cmn/modal/wbsSalesCodeSearch.html", 1068, 650, "SALES CODE 검색", paramObj, function (grid){
            var row = grid.target.getList("selected")[0];
            $('#ordCoCd').val(row.coCd);
            $('#ordrsNo').val(row.ordrsNo);
            $('#salesCd').val(row.salesCd);
            $('#clntPjt').val(row.clntPjt);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#clntCd').val(row.ordrsClntCd);
            $('#clntNm').val(row.ordrsClntNm);
            $('#prdtCd').val(row.prdtCd);
			$('#prdtCdNm').val(row.prdtCdNm);
            $('#itemDiv').val(row.itemDiv);
            $('#itemDivNm').val(row.itemDivNm);
            $('#eqpNm').val(row.eqpNm);
        });
    }


	//작성자 검색 //
	function openUserTree(gbn) {
		if($('#workRptIdNm').prop("disabled")) return false;

		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"userNm": $('#workRptIdNm').val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/userSearch.html", 450, 650, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#workRptId').val(checkedNode.id);
			$('#workRptIdNm').val(checkedNode.text);
			setWorkPtDept(checkedNode.parent);//자동분류 자동선택
		});
	}

	function setWorkRptHour(_value) {
		var value = _value.replace(/[^0-9.]/g, "");
// 		value = value.toLocaleString();
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return 24;
		}
		return value;
	}

	//작업시간 포커스를 빠져나갈때 실행됨
	function setWorkRptHour2(_value) {
		var value = parseFloat(_value.replace(/[^0-9.]/g, "")).toFixed(2);
		value = value.toLocaleString();
		value = value == 'NaN' ? 0 : value;
		if(value != "" && value > 24) {
			alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
			return 24;
		}		
		if(value == 0) {
			return "";
		}
		return value;
	}


	//  업체명 검색 //
	function clntSearch() {
		var paramObj = {
				"clntDivCd": "CLNTDIV12",
				"searchType": "CLNT_NM",
				"searchValue": $('#clntNm').val(),
			};
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 650, 650, "업체명 검색", paramObj, function(grid) {
					var row = grid.target.getList("selected")[0];
// 					$('#prjctSeq').val(row.prjctSeq);
					$('#clntCd').val(row.clntCd);
					$('#clntNm').val(row.clntNm);
					$('#mngId').val(row.salesEmpId);
					$('#mngNm').val(row.salesEmpNm);

					var paramObj = {
						"coCd" : $('#coCd').val(),
						"clntCd" : row.clntCd
					}
// 					setMngInfo(paramObj);
				});
	}	
	
	//수주번호 검색
    function opendOrdrsSearch(inputValue, coCd) {
        var paramObj = {
            "searchValue" : inputValue,
            "coCd" : coCd
        };
    	openSecondModal("/static/html/cmn/modal/ordrsSearch.html", 1200, 420, "수주번호 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#ordCoCd').val(row.coCd);
            $('#ordrsNo').val(row.ordrsNo);
            $('#clntPjt').val(row.clntPjt);
            $('#clntPjtNm').val(row.clntPjtNm);
            $('#clntCd').val(row.clntCd);
            $('#clntNm').val(row.clntNm);
            $('#ctrtNm').val(row.ctrtNm);
        });
    }	
    

	//제품코드 검색
	function openPrdtSearch(){
		var paramObj = {
				"coCd": $('#coCd').val(),
				"prdtCd": $('#prdtCd').val(),
				"prdtNm": $('#prdtCdNm').val(),
				"useYn" : "Y"
		}
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$("#prdtCd").val(row.prdtCd);
			$("#prdtCdNm").val(row.prdtNm);
		});
	}
    
	$("#popForm #workRptM").change(function() {
		var workRptS = $("#workRptS").val();
		var workTime = $("#workRptHour").val();
	    var str = workRptS.substr(-5);
	    if (str == '09901'){
	    	$("#workRptHour").val("8");
	    }
	    else {
// 	    	$("#workRptHour").val("");
	    }
	});
	
	$("#popForm #workRptS").change(function() {
		var workRptS = $("#workRptS").val();
		var workTime = $("#workRptHour").val();
	    var str = workRptS.substr(-5);
	    if (str == '09901'){
	    	$("#workRptHour").val("8");
	    }
	    else {
// 	    	$("#workRptHour").val("");
	    }
	});
	
	$("#popForm #issueYn").change(function() {
		if ($("#issueYn").val() == 'Y'){
			//fileGridView.initView();
		    $("#field01").show();
		    $("#field02").show();
		}
		else {
			$("#field01").hide();
		    $("#field02").hide();
		}
	});
	
	function setNotiFileInfo(fileInfo) {
		// 첨부파일 set
		$.each(fileInfo, function(idx, obj){
			notiFileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'fileList' : obj.fileList,
		      	'fileUp' : obj.fileUp,
		      	'fileDown' : obj.fileDown,
		      	'fileDelete' : obj.fileDelete,
		      	'fileUpdate' : obj.fileUpdate,
		      	'file' : obj
			});
		});
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	function setNotiFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			var testArr = obj.name.split(".");
			notiFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : testArr[testArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj,
		      	'fileDelete':'Y'
			});
		fileGridView.setData();
		$(elem).val("");
		});
	}
	
	
	function setTripRptButton(index){
		lastPosition = index;
		tripRptFile.click();
	}
			
			
	function setTripRptFile(elem){
		debugger;
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			
	        var file = obj;
	        //첨부 저장시 이미지 변황시 사용가능 heic -->jpeg 로 변환
// 	        if (file && file.name.split('.').pop().toLowerCase() === 'heic') {
// // 	            console.log(file);
// 	            // Convert HEIC to JPG
// 	            heic2any({blob: file, toType: "image/jpeg"})
// 	                .then(function(resultBlob) {
// 	                	file = new File([resultBlob], file.name.split('.')[0] + ".jpg", {type: "image/jpeg", lastModified: new Date().getTime()});
// // 	                    console.log(file);

// 	    				var testArr = file.name.split(".");
// 	    				rptTripFileArr.push({
// 	    					'rptTripNo' : lastPosition,
// 	    					'fileKey' : 0,
// 	    			      	'fileName' : file.name,
// 	    			      	'fileType' : testArr[testArr.length-1],
// 	    			      	'fileSize' : file.size,
// 	    			      	'file' : file,
// 	    			      	'fileDelete': 'Y'
// 	    				});
// 	    				let tempFileName = $('#tripTable' + lastPosition + ' #tripRptFileNm').val();
// 	    				let tempFileKey = $('#tripTable' + lastPosition + ' #fileKey').val();
// 	    				let tempUpdCheck = $('#tripTable' + lastPosition + ' #updCheck').val();
// 	    				if (tempFileName != "" && tempFileKey != 0 && tempUpdCheck == 'U') {	//수정이면서 기존 파일명이 있고 파일 등록된 번호가 있을경우만 파일 삭제대상임 
// 	    					tripRptRowFileDeleteArr.push({
// 	    						fileKey 	: tempFileKey,
// 	    						fileName 	: tempFileName
// 	    						});
// 	    				}
// 	    				$('#tripTable' + lastPosition + ' #tripRptFileNm').val(file.name);
// 	    				$('#tripTable' + lastPosition + ' #tripRptFileNm').removeAttr('onclick');

// // 	    		        var reader = new FileReader();
// // 	                    reader.readAsDataURL(file);
// // 	                    reader.onloadend = function() {
// // 	                        var imageDataUrl = reader.result;
// // 	                        console.log(imageDataUrl);
// // 	                    };
// 	                })
// 	                .catch(function(error) {
// 	                    console.error("Conversion error:", error);
// 	                });
// 	        } else {
				var testArr = file.name.split(".");
				rptTripFileArr.push({
					'rptTripNo' : lastPosition,
					'fileKey' : 0,
			      	'fileName' : file.name,
			      	'fileType' : testArr[testArr.length-1],
			      	'fileSize' : file.size,
			      	'file' : file,
			      	'fileDelete': 'Y'
				});
				let tempFileName = $('#tripTable' + lastPosition + ' #tripRptFileNm').val();
				let tempFileKey = $('#tripTable' + lastPosition + ' #fileKey').val();
				let tempUpdCheck = $('#tripTable' + lastPosition + ' #updCheck').val();
				if (tempFileName != "" && tempFileKey != 0 && tempUpdCheck == 'U') {	//수정이면서 기존 파일명이 있고 파일 등록된 번호가 있을경우만 파일 삭제대상임 
					tripRptRowFileDeleteArr.push({
						fileKey 	: tempFileKey,
						fileName 	: tempFileName
						});
				}
				$('#tripTable' + lastPosition + ' #tripRptFileNm').val(file.name);
				$('#tripTable' + lastPosition + ' #tripRptFileNm').removeAttr('onclick');
// 	        }
		});
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
        if (notiFileArr[rowIndex].fileDelete != 'Y') {
        	alert('파일 삭제 권한이 없습니다.')
        	return false;
        };
		
		fileGridView.target.removeRow(rowIndex);
		
		if(notiFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(notiFileArr[rowIndex].fileKey);
		}
		
		notiFileArr.splice(rowIndex, 1);
	}
	
	function selectNotiInfo(){
		var paramObj = {
				"fileTrgtKey": fileTrgtKey,
				"fileTrgtTyp" : "PM0101M01",
				"userId" : jwt.userId
				};
		
		postAjax("/user/pm/pm01/selectUploadFileList", paramObj, null, function(data){
			var list = data.result;
			setNotiFileInfo(list);
		});
		
		//파일 등록 권한이 없으면 버튼 비활성화
		paramObj.comonCd = 'FITR9902';
		postAjax("/admin/cm/cm15/selectTreeAuthUserList", paramObj, null, function(data){
			if (data.userList[0].fileUp == 'Y') {
				$('#buttonFile').prop('disabled', false); // 활성화
				$('#buttonFile').css('backgroundColor', ''); // 기본 배경색으로 변경 (옵션)
	        } else {
	        	$('#buttonFile').prop('disabled', true); uttonFile.disabled = true; // 비활성화
	        	$('#buttonFile').css('backgroundColor', 'gray');  // 회색 배경색으로 변경 (옵션)
	        }	
		});	
	}

	function downloadFile(idx) {
	    if (notiFileArr[idx].fileDown != 'Y') {
	    	alert('파일 다운로드 권한이 없습니다.')
	    	return false;
	    };
		
		var fileKey = notiFileArr[idx].fileKey;
		var paramObj = {
				"fileKey" : fileKey,
				"userId" : jwt.userId
			}		
		
		postAjax("/admin/cm/cm08/fileDownInfoUser", paramObj, null, function(data){
			if(data.resultCode == 200){
				var fileInfo = data.fileInfo;
				location.href = "/admin/cm/cm08/fileDownloadAuth?fileKey="+fileKey+"&userId="+jwt.userId;
			} else {
				alert("다운로드 권한이 없습니다.");	
			}
		});
	}	

	//웹 자바스크립트에서 플로터 앱함수 fileDownloadApp call
	//플러터앱에서 다운로드 하기
	function downloadTripRptFile(i) {
	  	let fileKey = $('#tripTable' + i + ' #fileKey').val();
	    var host = window.location.origin;
	    location.href = "/admin/cm/cm08/fileDownloadAuth?fileKey="+fileKey+"&userId="+jwt.userId;
	}

	
	
	
	
	
	
	
	
	
	
	// KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
	 function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
	     let param = {
	             "tmplatDiv": "TMPLATDIV04"
	             , "coCd": $("#popForm #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
	             , "todoDiv1CodeId": "" //"TODODIV10"                 //공통코드 해당업무 - 결재
	             , "todoDiv2CodeId": "" // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
	             , "todoDiv1CodeNm": "" // "WBS문제"                        //공통코드 해당업무 - 결재 - 발주서
	             , "todoDiv2CodeNm": "" // "WBS계획문제"                       //공통코드 해당업무 - 결재 - 발주서
	             , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
	             , "todoNo": $("#popForm #workRptNo").val()
	             , "clntCd": "1"                 //발신회사는 로그인사용자 회사
	             , "clntNm": ""             //로그의 수신거래처명
	             , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
	             , "ordrgMngTelNo": $("#popForm #telNo").val()       //담당자전화번호    
	             , "creatPgm": "PM0101P01"
	             , "userId": jwt.userId
	             , "todoTitle": $("#popForm #issueTitle").val() // 문제 제목
	             , "text": $("#popForm #workRptRmk").val() // 비고
	     }
	     commKaKaoSendTodo(param);
	 }

	 function kakaoTodo() {
	        
        //message load
        if (kakaoErr.length == 0) {
	        var paramObj = {
	            "userId" : jwt.userId
	            , "codeKind" : "KAKAOMSG"
	        };
	        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
	            if(data.resultList.length > 0 ) {
	                kakaoErr = data.resultList;
	            }
	        });   
        }
    	
	    let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";
	    
	    kakaoSendBody('','', '작업일보','작업일보 문제','공유');
	        
	    if (kakaoCnt > 0) {
	        kakaoCnt = 0;
	      //alert("알림톡이 정상 발송되었습니다.");
	    }
	} 

	//to-do결재요청 알림톡
	function commKaKaoSendTodo(param) {
// 	    console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

	    //알림톡수신번호 채번
	    var maxMessageId = null;            //message id(unique key)
	    var talkMessage = null              //발송될 내용 template
	    var mobile = null                   //수신인 휴대전화번호
	    var title = null                    //todo title
	    var sendList = [];
	    let talkParam = {};
	    let talkBody = {};      
	    let sendCnt = 0;
	    postAjaxSync("/user/bm/bm18/selectPmMaxMessageIdTodo", param, null            
	                , function(data) {   
	                    if(data.resultList.length > 0 ) {
	                        if( data.resultList[0].maxMessageId != "" ) {
	                            sendList = data.resultList; 
	                        } else {
	                            alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
	                            return;
	                        } 

	                    }
	    });         
	    //user search ajax end
	    
	    //대상 loop
	    $.each(sendList, function (key, sendObj) {
	        maxMessageId = sendObj.maxMessageId;                            
	        talkMessage = sendObj.messageDesc;
	        mobile =  sendObj.telNo;
	        //로그용
	        param.rcvId = sendObj.todoId;           //todo 수신id
	        param.rcvNm = sendObj.name;             //todo 수신자명
	        param.name = sendObj.name;                //todo 수신자명
	        
	        // 알림톡 Title 자리수 제한 문자열 자르기
	        if (sendObj.todoTitl.length > 30) {
	            title = sendObj.todoTitl.substring(0,25);
	        }
	        else {
	            title = sendObj.todoTitl;   
	        }
	        
	        param.title = title; //요청내용제목
	        //------------------------
	      	     	                                   
	        param.sendDt = sendObj.sendDt;
	        
	        // 비고란 문자열 자리수 자르기 30자
            var strText = null;            
            if (param.text.length > 50) {
            	strText = param.text.substring(0, 50);
            }
            else {
            	strText = param.text;   
            }
            param.text = strText;   
            //------------------------
            
            
            
	        if(mobile == "" || mobile == null) {
	            alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
	            return;
	        }
	        if(talkMessage == "" || talkMessage == null) {
	            alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
	            return;
	        }   
	        
	        //message 치환
	        let message = talkMessage;
	        let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`); 
	        //loop
	        $.each(splitStr, function (key, val) {
	            let compKey = val.substring(1, val.length-1);
	            if( compKey != "" && compKey != "undefined" ) {
	                if( typeof(param[compKey]) != "undefined" ) {
	                    let val2 = '#'+val;
	                    message = message.replaceAll(val2, param[compKey]);
	                }
	            }
	        });
	        talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
	        talkParam.serverName = "gyitt2400";     
	        talkParam.paymentType = "P";
	        talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
	        talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값);  
			if (title.length > 50) {
				title = title.substring(0, 49); // 50자까지만 자르기
			}
	        talkBody.title = title;                 //알림톡 타이틀 -
	        talkBody.message = message;             //알림톡 메시지 (1000 byte) 
	        talkBody.mobile = mobile;               //휴대전화번호
	        talkBody.template = "10008";            //템플릿관리화면 템플릿ID - 발주서 V2
	        let talkJson = JSON.stringify(talkBody);
	        sendCnt = kakaoSendReal(talkJson, talkParam, param);        
	    });
	    //대상 loop end
	    if( sendCnt > 0 ) {
	        //alert("알림톡 정상 발송되었습니다.");  
	        kakaoCnt++;
	    }
	    
	    //한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄 
	   /*  talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
	    talkBody.mobile = "01063893764"
	    talkJson = JSON.stringify(talkBody); */
	    //kakaoSendReal(talkJson, talkParam, param);
	}


	function txtareaHeightResize(obj) {
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 4)
			obj.css('height', "52px");
		else
			obj.css('height', (rowCount * 23) + "px");
	}
	
</script>