<div id="commonPopup">
	<div class="popup_area_planTask">
		<div class="popup_table">
			<table>
				<colgroup>
					<col width="20%">
					<col width="20%">
					<col width="">
				</colgroup>
				<tr>
					<td>
						<select id="coCd_PS" name="coCd_PS" data-kind="CO" data-search="coCd" required msg="회사" onchange="ModalSalesCodeGridView.setData(0);">
						</select>
					</td>
					
					<td>
						<select data-search="searchType">
	                		<option value="SALES_CD">SALES CODE</option>
	              		</select>   
					</td>
					<td>
						<div class="search_form">
							<input type="text" id="searchValue" name="searchValue" data-search="searchValue" onblur="ModalSalesCodeGridView.setData(0);" onkeypress="if(event.keyCode == 13){ModalSalesCodeGridView.setData(0);}">
							<a onclick="ModalSalesCodeGridView.setData(0);">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>
				</tr>
			</table>
			<div class="ax5_grid" data-ax5grid="ModalSalesCode-grid" data-ax5grid-config="{}" style="height: 590px; width: 100%"></div>
		</div>
	</div>
	<div class="mobile_mid_btn">
		<button type="button" style="height: 35px;  width: 90px;" onclick="executeCallback();">선택</button>
		<button type="button" style="height: 35px;  width: 90px;" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
	<div>
	<br>
	<br>
	</div>
</div>

<script type="text/javascript">
	ax5.ui.grid.formatter["chkYn"] = function () {
		if (this.value == "Y"){ return '<img src="/static/img/color-circle_02.png" style="width: 10px;height: 10px;"></img>'; } 
		else { return ' '; }
	};

	var ModalSalesCodeGridView = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showLineNumber  : false,
                showRowSelector : true,
                // multipleSelect  : true,
                sortable : false,
                target : $('[data-ax5grid="ModalSalesCode-grid"]'),
                header : {
                    align : "center",
                    selector : false
                },
                body: {
                    columnHeight: 26,
                    onClick: function () {
                        var list = ModalSalesCodeGridView.target.getList("selected");
                        $.each(list, function(idx, obj) {
                        	ModalSalesCodeGridView.target.select(obj.__origin_index__, {selected: false});
                        });
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () { },
                    onDataChanged: function () { 
                        var list = ModalSalesCodeGridView.target.getList("selected");
                        $.each(list, function(idx, obj) {
                        	ModalSalesCodeGridView.target.select(obj.__origin_index__, {selected: false});
                        });
                        this.self.select(this.dindex);
                    }
                },
                columns: [
                    {key: "coCd",                label: "회사코드",          hidden:true},
                    {key: "clntCd",              label: "고객코드",          hidden:true},
                    {key: "clntPjt",             label: "고객사프로젝트",      hidden:true},
                    {key: "clntNm",              label: "고객명",           width: 110,  align: "left", hidden:true},
                    {key: "clntPjtNm",           label: "프로젝트명",        width: 80,   align: "left", hidden:true},
                    {key: "sjNm",                label: "과제명",           width: 160,   align: "left", hidden:true},
                    {key: "salesCd",             label: "SALES CODE",     width: 110,   align: "center", hidden:true},
                    {key: "ordrsNo",             label: "수주번호",          hidden:true},
                    {key: "verNo",               label: "Ver.",           hidden:true},
                    {key: "wbsPlanCodeKind",     label: "상위코드",         hidden:true},
                    {key: "wbsPlanCodeId",       label: "TASK",           hidden:true},
                    {key: "wbsMngNm",            label: "담당자",           hidden:true},
                    {key: "pid",             label: "상위코드",          hidden:true},
                    {key: "id",             label: "하위코드",          hidden:true},
                    {key: "lvl",                 label: "lvl",            hidden:true},
                    {key: "wbsPlanCodeNm",       label: "TASK명",         width: 180,   align: "left", hidden:false, treeControl: true},
                    {key: "wbsPlansDt",          label: "시작일",          width: 80,   align: "center"},
                    {key: "wbsPlaneDt",          label: "종료일",          width: 80,   align: "center"},
                    {label: "등록여부",
                        columns: [
                            {key: "planYn",          label: "계획",           width: 40, align: "center", formatter: "chkYn"},
                            {key: "rsltsYn",         label: "실적",           width: 40, align: "center", formatter: "chkYn"},
                        ]
                    },
                    {label: "문제정보",
                        columns: [
                            {key: "gubun",           label: "구분",           width: 40,   align: "center" },
                            {key: "issStsNm",        label: "진행상태",        width: 60,   align: "center"},
                            {key: "issSj",           label: "제목",           width: 200,   align: "left"},
                            {key: "issDivNm",        label: "유형",           width: 70,   align: "center"},
                            {key: "issCnts",         label: "내용",           width: 230,   align: "left"},
                        ]
                    },
                    {label: "조치내역",
                        columns: [
                            {key: "actIdNm",         label: "담당자",         width: 70,   align: "center"},
                            {key: "reqNo",           label: "발주요청번호",     width: 90,   align: "center"},
                            {key: "actsDt",          label: "시작일",         width: 80,   align: "center"},
                            {key: "acteDt",          label: "종료일",         width: 80,   align: "center"},
                            {key: "actMh",           label: "투입공수",        width: 70,   align: "right", formatter: "money"},
                            {key: "actAmt",          label: "투입비용",        width: 70,   align: "right", formatter: "money"},
                            {key: "actCnts",         label: "조치내용",        width: 150,   align: "left"},
                            {key: "actFdmtSolutCd",  label: "근본원인CD",        width: 200,   align: "left", hidden: true},
                            {key: "actFdmtSolutNm",  label: "근본원인",        width: 200,   align: "left"}
                        ]
                    },
                    {key: "wbsRsltssDt",         label: "시작일",         hidden:true},
                    {key: "wbsRsltseDt",         label: "종료일",         hidden:true},
                    {key: "issDiv",              label: "문제유형",       hidden:true},
                    {key: "actId",               label: "조치담당자",        hidden:true},
                    {key: "actDeptId",           label: "조치부서",        hidden:true},
                    {key: "issSts",              label: "진행상태",       hidden:true},
                    {key: "issNo",               label: "문제번호",        width: 100,   align: "center"},
                    {key: "wbsPlanNo",           label: "문제계획번호",    hidden:true},
                    {key: "wbsRsltsNo",          label: "문제실적번호",    hidden:true},
                    {key: "pPlanNo",             label: "계획번호",       width: 60,   align: "center"},
                    {key: "pRsltsNo",            label: "실적번호",       width: 60,   align: "center"},
                    {key: "pPlanTrgtKey",        label: "계획타겟키",      hidden:true},
                    {key: "pRsltsTrgtKey",       label: "실적타겟키",      hidden:true},
                    {key: "issFileTrgtKey",      label: "ISS_FILE_TRGT_KEY", hidden:true},
                    {key: "path",                label: "path", 		hidden:true},
                    {key: "mcPartCd",            label: "기계분류", 		hidden:true},
                    {key: "importantCd",         label: "중요도", 		hidden:true},
                    {key: "impactCd",            label: "영향도", 		hidden:true},
                ],
                tree: {
                    use: true,
                    indentWidth: 15,
                    arrowWidth: 15,
                    iconWidth: 18,
                    icons: {
                        openedArrow			: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                        collapsedArrow		: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        groupIcon			: '<i class="fa fa-folder-open" aria-hidden="true"></i>',
                        collapsedGroupIcon	: '<i class="fa fa-folder" aria-hidden="true"></i>',
                        itemIcon			: '<i class="fa fa-file" aria-hidden="true"></i>'
                    },
                    columnKeys: {
                        parentKey: "pid",
                        selfKey: "id",
                        //collapse:"pid"
                    },
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                    	ModalSalesCodeGridView.setData(this.page.selectPage);
                    }
                },
            });
            return this;
        },
        setData : function(_pageNo) {
            var targetObj = this.target;
            var paramObj = {
                "coCd"		: $('#coCd_PS').val(),
                "salesCd"	: $('#searchValue').val(),
                "clntPjt"	: '',
                "ordrsClntNm"	: '',
                "issSts"	: '',
				"pageNo"	: _pageNo + 1,
				"recordCnt"	: 99999,
            };

            postAjax("/user/wb/wb24/selectWbsIssueList", paramObj, null, function(data) {
                try {
                    var list = data.fileList;
                    for (let i = 0; i < list.length; i++) {
                        list[i].actMh = gPasFloatChk(list[i].actMh);
                        list[i].actAmt = gPasFloatChk(list[i].actAmt);
                    }
                    targetObj.setData({
                        list : list,
                        page : {
                            currentPage   : _pageNo,
                            pageSize      : data.paginationInfo.pageSize,
                            totalElements : data.paginationInfo.totalRecordCount,
                            totalPages    : data.paginationInfo.totalPageCount,
                        }
                    });
                } catch (error) {
                    alert("오류 발생!! 전산실 연락 바랍니다", error.message);
                    return null; // 오류 발생 시 null 반환
                } finally {
                    // console.log("함수 실행 완료.");
                }
            });
        }
    }


	$(document).ready(function() {
		$('#searchValue').focus();
		setCommonSelect($('#commonPopup select[data-kind]'));		
		$('#searchValue').val(modalStack.last().paramObj.searchValue);

		//회사 기본값지정
		if(modalStack.last().paramObj.coCd == '' || modalStack.last().paramObj.coCd == undefined){
			$("#coCd_PS").val(jwt.coCd);
		}else{
			$("#coCd_PS").val(modalStack.last().paramObj.coCd);
			//회사 비활성화
			$('#coCd_PS').css({'background-color':'#e6e6e6', 'pointer-events':'none'});
		}
		ModalSalesCodeGridView.initView().setData(0);
	});

	function executeCallback(){
		if(selectGridValidation(ModalSalesCodeGridView.target)) {
			customAlert('실적등록된 TASK를 선택하세요!');
			return;
		}
		let row = ModalSalesCodeGridView.target.getList("selected")[0];
		if(row.pRsltsNo  == undefined) {
			customAlert('실적등록된 TASK를 선택하세요!');
			return;
		} else {
			modalStack.last().callback(ModalSalesCodeGridView);
			modalStack.close();
		}
	}
</script>
