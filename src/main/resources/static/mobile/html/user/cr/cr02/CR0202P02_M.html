<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">    
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css" />
    <link rel="stylesheet" href="/static/css/jstree/style.min.css" />
    <link rel="stylesheet" href="/static/css/gnb.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/mobile/css/sub.css" />
    <link rel="stylesheet" href="/static/css/common.css" />
	<link rel="stylesheet" href="/static/css/mobile.css" />

    <script src="/static/js/jquery-latest.min.js"></script>
    <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/ax5/ax5toast.min.js"></script>
    <script src="/static/js/jstree/jstree.min.js"></script>
    <script src="/static/js/global.js"></script>
    <script src="/static/js/fileTree.js"></script>
    <!-- 공통결재 -->
	<script src="/static/js/commApprovalMobile.js"></script>
    <style type="text/css">

    .table_input tr th {
	    text-align: left;
	    font-size: 10px;
	    color: #888888;
	    padding: 2px 2px;
	    border: 1px solid #e8ebf2;
	}
	
	.table_input tr td {
	    text-align: left;
	    height: 5px;
	    font-size: 12px;
	    padding: 3px 3px;
	    border: 1px solid #e8ebf2;
	    color: blue;
	    font-weight: bold;
	}
	</style>
</head>


<body>
	<div id="head_area" class="off">
		<div class="left_btn" onclick="history.back(-1)">
			<a class="back_btn"></a>
		</div>
		<h1 class="logo">
			<img src="/static/img/Logo_gunyangitt.gif" alt="건양ITT" />
		</h1>
	</div>
<!--  //class=coAuthChk : 회사구분에 따른 권한관리용 (건양은 투루넷 권한 제거, 트루넷은 건양 권한 제거) -->

	<div id="main_area">
	    <h3 id="popupTit" class="tit">수주 상세</h4>
		<div class="contents search">
           <form id="popForm">   
            <input type="hidden" id="pgmId" name="pgmId" value="CR0202P01">
            <input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">
            <table class="table_input">
                <colgroup>
					<col width="16%">
					<col width="34%">
					<col width="17%">
					<col width="33%">
				</colgroup>
				<!-- 1행 -->
				<tr>
					<th>회사</th>
                    <td><input type="text" id="coCdNm" readonly></td>
					
					<th>수주번호</th>
					<td><input id="ordrsNo" type="text" readonly></td>
				</tr>
				<tr>
					<th></th>
					<td></td>
                    <th>차수</th>
                    <td>
                      <input type="text" id="histNo"readonly>
                    </td>
                </tr>
				<tr>
                    <th>견적서번호</th>
                    <td><input type="text" id="estNoOrdrs" readonly></td>
					<th>견적차수</th>
                    <td><input id="estDeg" type="text"readonly></td>
				</tr>
				<tr>
                    <th>수주일자</th>
                    <td><input type="text" id="ordrsDt" readonly></td>
                    <th>수주구분</th>
					<td><input type="text" id="ordrsDivNm" readonly></td>             
				</tr>
				<tr>       
                    <th>고객사</th>
					<td><input type="hidden" id="ordrsClntCd"x>
						<input type="text" id="ordrsClntNm"x readonly></td>
                    <th id="ordrsNoTh">건양수주번호</th>
                    <td><input id="oldOrdrsNo" type="hidden" readonly>
                        <input id="newOrdrsNo" type="text" readonly></td>
                </tr>
				<tr>
					<th>계약명</th>
					<td colspan="3"><input type="text" id="ctrtNm" readonly></td>
				</tr>
				<tr>
                    <th>담당자</th>
                    <td><input type="text" id="mngIdNm" readonly>
                         <input type="hidden" id="mngId"></td>
                    <th>고객PJT</th>
					<td><input type="text" id="clntPjtNm" readonly></td>
				</tr>

				<tr>
					<th>결재방법</th>
					<td><input type="text" id="pmntMtdNm" readonly></td>

					<th>발주자</th>
					<td><input type="text" id="ordrger" readonly></td>
				</tr>
				<tr>
                    <th id="ordrsAmtTh">수주금액</th>
					<td><input type="text" id="ordrsAmt" readonly></td>
                    <th id="currCdTh">통화단위</th>
                    <td><input type="text" id="currCdNm" readonly></td>
				</tr>

				<!-- 5행 -->
				<tr>
					<th>선물환</th>
					<td><input type="text" id="fwdExchChkList" readonly></td>
					<th>선물환가입일</th>
					<td><input type="text" id="fwdExchJoinDt" readonly></td>
				</tr>
				<tr>

                    <th>원화금액</th>
                    <td><input type="text" id="exchangeAmt" readonly></td>
                    <th>환율</th>
					<td><input type="text" id="exrate" comma readonly></td>
                </tr>

				<!-- 6행 -->
				<tr>
                    <th>계약문서</th>
					<td><input type="text" id="ctrtDoc" readonly></td>
                    <th>국내/해외</th>
                    <td><input type="text" id="inpexpCdNm" readonly></td>
				</tr>

				<!-- 7행 -->
				<tr>
                    <th>비고</th>
                    <td colspan="3"><textarea rows=4 cols=120 wrap="hard" id="ordrsRmk" class="form-control"  readonly></textarea></td>
                </tr>
                <tr>
                           <table class="contents_tit coAuthChk">
                               <tr>
                                 <td>※ 수금 정보</td>
                                 <td></td>
                               </tr>
                               <tr>
                                 <td colspan="2"><div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 100px; width: 100%;" ></div></td> 
                               </tr>  
                           </table>
                </tr>
                <tr>
                           <table>
                               <tr>
                                 <td>※ 설비&원가 정보</td>
                                 <td></td>
                               </tr>
                               <tr>
                                 <td colspan="2"><div class="ax5_grid" data-ax5grid="second-grid-modal" data-ax5grid-config="{}" style="height: 200px; width: 100%;" ></div></td> 
                               </tr>  
                           </table>       
                </tr>
                
                <tr>
                	<td colspan=4>
						<div>
							<!-- todo 결재 -->
							<div align="center" style="width: 100%; height: 30%;">
								<div id="wbsPopup" class="popup_area">
									<!-- 결제창 -->
									<div id="approval_area"></div>
								</div>
							</div>                 
						</div>
					</td>
                </tr>
            </table>
		</form>
	</div>
</div>
</body>

<script type="text/javascript">
function getParams() {
	var url = window.location.search.replace('?', '');
	var params = {};
	var urlArray = url.split('&');

	for ( var i in urlArray) {
		var param = urlArray[i].split('=');
		params[param[0]] = param[1];
	}
	return params;
}

/*todo 결재*/
var btnApproval = null;
//div area id 
var htmlParam = {
	htmlArea : "approval_area"
};

//세션에 정보를 활용하여 승인처리3
//JSON.parse : JSON.stringify를 받을 때 / 문자열-> 자바스크립트로 변환
var paramObj = JSON.parse(sessionStorage.getItem('paramObj'));
//sessionStorage.removeItem('paramObj');제거??
if (paramObj && paramObj != "undefined") {
	//to-do 에서 넘어온 param;
	var popParam = paramObj;
	//추가로 넣어줄 param
	var approvalParam = {
		coCd : paramObj.coCd,
		todoDiv1CodeId : paramObj.todoDiv1CodeId,
		todoDiv2CodeId : paramObj.todoDiv2CodeId,
		pgmId : paramObj.pgmId
	};
	//삭제할 키가 있으면 쓴다.
	delete popParam.sanctnSn;
	delete popParam.pgmId;
	//결재/승인버튼 생성하기
	var commApproval = new Approval(htmlParam, approvalParam, popParam);
	commApproval.makeHtml();
} else {
	window.history.back();
}

function approvalConfirm() {
	if (commApproval.confirmApproval()) {
		window.history.back();
	}
}
/*todo 결재
 * 
 */
    $(document).ready(function () {
        setCommonSelect($(".popup_area select[data-kind]"));
        fileTrgtKey = paramObj.fileTrgtKey;

        $("#mngIdNm").val(jwt.userNm);
        $("#mngId").val(jwt.userId);

		
    });  /* document.ready */

    
    /* 그리드 관련 함수 */
    // 그리드 생성
    const gridOrdrsPlan = new ax5.ui.grid();
    
    gridOrdrsPlan.setConfig({
        target : $('[data-ax5grid="first-grid-modal"]'),
        header: {
            align: "center",
            selector: false
        },
        columns: [
            {key: "seq", label: "번호", width: 40, align: "center", formatter: function () {return this.item.__index + 1;},},
            { key: "clmnPlanDiv",   label: "수금구분", align: "center",  width: 70},
            {key: "clmnDivSeq", label: "차수", width: 50, align: "center"},
            {key: "clmnRate", label: "비율", width: 50, align: "center"},
            {key: "clmnAmt",label: "수금계획금액", width: 110, align: "right",  formatter: "money"},
            {key: "clmnDt", label: "수금예정일자", width: 100, align: "center"},
            {key: "billPblsDt", label: "계산서발행예정일", width: 100, align: "center"},
            {key: "세금계산서합계", label: "계산서발행금액", width: 120, align: "right", formatter: "money", styleClass: function () {
                return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.세금계산서합계)) ? "grid-font-red" : "grid-font-blue";}
            },
            {key: "수금합계", label: "수금금액", width: 120, align: "right", formatter: "money", styleClass: function () {
                return (pasFloatChk(this.item.clmnAmt) < pasFloatChk(this.item.수금합계)) ? "grid-font-red" : "grid-font-blue";}
            },
            {key: "zzzz", label: "미수잔액", width: 120, align: "right",
                formatter: function () {
                    return addCommaStr(pasFloatChk(this.item.clmnAmt) - pasFloatChk(this.item.수금합계));
                },
                styleClass: function () {
                    return "grid-font-blue";
                }
            },
            {key: "clmnMgmtStatus", label: "수금관리상황", width: 370, align: "left"},
        ],
        footSum: [
            [
                {label: "수금합계", align: "center", colspan: 3},
                {key: "clmnRate", collector: "sum", formatter: "money", align: "right"},
                {key: "clmnAmt", collector: "sum", formatter: "money", align: "right"},
                {colspan: 2},
                {key: "세금계산서합계", collector: "sum", formatter: "money", align: "right"},
                {key: "수금합계", collector: "sum", formatter: "money", align: "right"},
                {key: "zzzz", collector:
                    function () {
                        var value = 0;
                        this.list.forEach(function (n) {
                            if (!n.__isGrouping) value += (pasFloatChk(n.clmnAmt) - pasFloatChk(n.수금합계));
                        });
                        return addCommaStr(value);
                    },
                    formatter: "money", align: "right"
                },
            ]
        ],
        page : {
            display: false,
        },
        body: {
            onClick: function () {
                this.self.clearSelect();
                this.self.select(this.dindex);
            },
        }
    });
    
    
    const gridOrdrsDetail = new ax5.ui.grid();
    
    gridOrdrsDetail.setConfig({
        multipleSelect: false,
        target : $('[data-ax5grid="second-grid-modal"]'),
        header: {
            align: "center",
            selector: false
        },
        // frozenColumnIndex: 8,
        columns: [
            {key: "seq", 			label: "No", 		width: 40, align: "center", formatter: function () { return this.item.__index + 1; }},
            {key: "ordrsDtlDiv10Nm", 	label: "입력구분", 	width: 60, align: "center"},
            {key: "eqpNm", 			label: "설비명", 		align: "left", width: 160},
            {key: "estTrgtCost", 	label: "수주목표가",align: "right", width: 80,  formatter: "money"},
            {key: "ordrsPrcMach", label: "수주기계PART", align: "right", width: 80,  formatter: "money"},
            {key: "ordrsPrcElcty", label: "수주전기PART", align: "right", width: 80,  formatter: "money"},
            {key: "ordrsPrc", label: "수주합계", align: "right", width: 80},
            {key: "ordrsQty", label: "수량", align: "right", width: 40},
            {key: "estEpctMatPrc", label: "견적 예상 재료비",align: "right", width: 110,  formatter: "money"},
        	{ key: "trgtPchsPcostMach", label: "구매목표기계", align: "right", width: 110,  formatter: "money"},
            { key: "trgtPchsPcostElcty", label: "구매목표전기", align: "right", width: 110,  formatter: "money"},
            { key: "trgtSum", label: "구매목표합계", align: "right", width: 100,  formatter: "money"},
            {key: "outtkClntNm", label: "외주턴키", align: "left", width: 120},
        	{key: "dtlRmk",      label: "비고", align: "left", width: 120},
        ],
        footSum: [
                  [
                      {label: "총합계", align: "center", colspan: 3},
                      {key: "estTrgtCost", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrcMach", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrcElcty", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsPrc", collector: "sum", formatter: "money", align: "right"},
                      {key: "ordrsQty", collector: "sum", formatter: "money", align: "right"},
                      {key: "estEpctMatPrc", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtPchsPcostMach", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtPchsPcostElcty", collector: "sum", formatter: "money", align: "right"},
                      {key: "trgtSum", collector: "sum", formatter: "money", align: "right"},
                  ]
        ],
        body: {
            onClick: function () {
                this.self.select(this.dindex);

            },
            columnHeight: 26,
            onDataChanged: function () {
            	var row = this.dindex;
			    var col = this.colIndex;
			    
            }
        },

    });


        postAjax("/user/cr/cr02/selectOrdrsInfo", paramObj, null, function (data) {
            var parsedData = data;
            Object.keys(parsedData.ordrsInfo).forEach(function (key) {
                var inputField = document.getElementById(key == 'estNo' ? 'estNoOrdrs' : key);
                if (!inputField) return;

                var value = parsedData.ordrsInfo[key];

                switch (key) {
                    case 'ordrsDt':	//바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
                    	$(".ordrsDt").val(value);
                    case 'dudtPlanDt':  //바닥의 다른 화면 필드와 겹치는 경우를 위하여 class에서 정의함.
//                     	$(".dudtPlanDt").val(value);
                    case 'ordrsAmt':
                    case 'exrate':
                        inputField.value = addCommaStr(value);
                        break;
                    case 'exchangeAmt':
                        inputField.value = addCommaStr(value);
                        break;
                    default:
                        inputField.value = value || '';
                        break;
                }
            });
            
            //수정시  로드 될떄 gridOrdrsPlan 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var pmntPlans = data.ordrsInfo.plans;
            gridOrdrsPlan.setData({
                list: pmntPlans,
                page: {
                    totalElements: pmntPlans.length
                }
            });
            //수정시  로드 될떄 orderDetails 그리드 데이터 불러오는 부분 (xml 파일에서 : resultInfoMap 해당 쿼리)
            var ordrsDetails = data.ordrsInfo.details;
            if  (jwt.userId != 'EMJ8105') {//김태호전무님 ID
     	       if ($('#popForm #coCd').val() != jwt.coCd ||  
    	    		   ($('#popForm #coCd').val()=='GUN' && jwt.deptId.slice(0,5) != 'GUN30') ||  
    	    		   ($('#popForm #coCd').val()=='TRN' && jwt.deptId.slice(0,5) != 'TRN30')) {
	            	$("#ordrsAmt").val("0");
	            	$("#exchangeAmt").val("0");
	            	for (var i = 0; i < ordrsDetails.length; i++) {
	            		ordrsDetails[i].ordrsAmt = 0;
	            		ordrsDetails[i].exchangeAmt = 0;
	            		ordrsDetails[i].ordrsPrcMach = 0;
	            		ordrsDetails[i].ordrsPrcElcty = 0;
	            		ordrsDetails[i].ordrsPrc = 0;
	            		ordrsDetails[i].estEpctMatPrc = 0;
	            		ordrsDetails[i].estTrgtCost = 0;
	                }
	            }
            }
            gridOrdrsDetail.setData({
                list: ordrsDetails,
                page: {
                    totalElements: ordrsDetails.length
                }
            });
	        gridResize(ordrsDetails.length); //그리드 높이 조정
	        
// 	        gridViewPop7.initView().setData(0);
	        
	        //사용자 테이블의 회사코드와 자료의 회사코드가 다르면  조회모드만 작동
	        if  (jwt.userId != 'EMJ8105') {//김태호전무님 ID
	 	       if ($('#popForm #coCd').val() != jwt.coCd ||  
	 	    		   ($('#popForm #coCd').val()=='GUN' && jwt.deptId.slice(0,5) != 'GUN30') ||  
	 	    		   ($('#popForm #coCd').val()=='TRN' && jwt.deptId.slice(0,5) != 'TRN30')) {
	 	           $('.coAuthChk').hide();
	 	       }
	        }
	        
        });
        
//     }

    
    function gridResize(size) {
            var tagHeight = (size) * 27 + 123 ;
            tagHeight = tagHeight > 750 ? 750 : tagHeight;
            tagHeight = tagHeight < 300 ? 300 : tagHeight;
            
            gridOrdrsDetail.setHeight(tagHeight);
    }
         
    </script>

</html>
