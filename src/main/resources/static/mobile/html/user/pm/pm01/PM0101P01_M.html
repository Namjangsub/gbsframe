<style>
.myText {
  text-align: left;
  font-size: 15px;
  font-weight: bold;
}  
tr {
  height: 40px;
}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">작업일보 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
                <input type="hidden" id="workRptNo" name="workRptNo">
                <input type="hidden" id="workRptIdNm" name="workRptIdNm">
    <div class="form-group popup_table" style="width: 340px;"">
 		<table>

        <colgroup>
          <col width="20%">
          <col width="44%">
        </colgroup>

         <tr>
            <th class="hit" >작성일자</th>
            <td>
                <input id="workRptDt" name="workRptDt" class="input_calendar form-contro" autocomplete="off" onkeyup="dateMask(this);" inputmode="numeric"  required msg="작성일자" date>
            </td>
         </tr>
         <tr>  
	         <th class="hit">업무분류</th>
	         <td>
	         		<input class="division" type="hidden" id="workRptL" name="workRptL" data-depth="0" onchange="selectCodeList(this,0);" required msg="작업대분류" >	
	                <select class="division" id="workRptM" name="workRptM" onchange="selectCodeList(this,1);" data-depth="1" class="form-control" required msg="작업중분류">
	                </select>
	         </td>
         </tr>
         <tr>
         <th class="hit">업무구분</th>
            <td>
                <select class="division" id="workRptS" name="workRptS" onchange="selectSalesCodeSet();" data-depth="2" required class="form-control" msg="작업소분류">
                </select>
            </td>
         </tr>
         <tr>
            <th class="hit">작업시간</th>
            <td>
                <input type="text" id="workRptHour" name="workRptHour" maxlength="2" inputmode="numeric" required class="form-control" required msg="작업시간"
                oninput="this.value=setWorkRptHour(this.value)">
            </td>
         </tr>
         <tr>
            <th>비고</th>
            <td>
                <textarea rows="2" id="workRptRmk" name="workRptRmk" class="form-control"  msg="비고"></textarea>
            </td>
         </tr>
         <tr>
           <th class="hit Sales_Code">Sales Code</th>
            <td>
                <div class="search_form">
                    <input type="text" id="salesCd" name="salesCd" required class="form-control" msg="Sales Code" readonly>
                    <a id="salesTarget" onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
                </div>
            </td>
         </tr>
         <tr>
            <th>고객사</th>
            <td>
                <input type="text" id="clntNm" name="clntNm" class="form-control" msg="고객사">
            </td>
         </tr>   
         <tr>
            <th>고객사PJT</th>
            <td>
                <input type="text" id="clntPjtNm" name="clntPjtNm" class="form-control" msg="고객사PJT"> 
            </td>
         </tr>
         <tr>         
            <th>제품구분</th>
            <td>
                <input type="text" id="prdtCdNm" name="prdtCdNm" class="form-control" msg="제품구분">

            </td>
         </tr>
         <tr>
            <th>아이템구분</th>
            <td>
                <input type="text" id="itemDivNm" name="itemDivNm" class="form-control" msg="아이템구분">
            </td>
         </tr>
         <tr>   
            <th>설비명</th>
            <td>
                <input type="text" id="eqpNm" name="eqpNm" class="form-control" msg="설비명">
            </td>
         </tr>
         
      </table>
      </div>
    </form>
	</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
var actionType = null;
var fileTrgtKey = null;

$(document).ready(function() {

    //작성일자//
    $('#workRptDt').datepicker({
        format : "yyyy-mm-dd",
        language : "ko",
        autoclose : true
    }).datepicker("setDate", new Date());
    
    actionType = modalStack.last().paramObj.actionType;
    fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;    

    debugger;
    setWorkPtDept();//자동분류 자동선택

    //authChk();  
    
    $("#clntNm").prop("readonly", true);
    $("#clntPjtNm").prop("readonly", true);
    $("#prdtCdNm").prop("readonly", true);
    $("#itemDivNm").prop("readonly", true);
    $("#eqpNm").prop("readonly", true);
    
    if (actionType == "C") {
        $("#actionBtn").text("등록");
        $('#actionBtn').on("click", function() {
            insertDailyWork();
        });

    } else if (actionType == "U") {
        $('.tit').text('작업일보 수정')
        
        selectDailyWorkInfo();

        $('#actionBtn').text("수정");
        $('#actionBtn').on("click", function() {
            updateDailyWork();
        });
    }
                    // 권한체크

});


//세션의 부서코드로 작업 대분류/중분류/소분류 자동셋팅
function setWorkPtDept() {
    //$("#deptId").val("GUN70");//임시 GUN1010, GUN6010, TRN1099
    var deptId = jwt.deptId;
    if (deptId) {
    	$("#workRptL").val(deptId.substring(0,5));
	    selectCodeList($("#workRptL"),0);
	    selectCodeList($("#workRptM"),1);
    }
}    

//작업 대분류/중분류/소분류
function selectCodeList(obj,idx) {
    var codeKind = $(obj).val();
    var target = $(obj).next('select.division');
    if(idx == 0){
        target = $("#workRptM");
        $('#workRptM option[value!=""]').remove();
        $('#workRptS option[value!=""]').remove();
    }else{
        target = $("#workRptS");
        $('#workRptS option[value!=""]').remove();
    }    
    
    var paramObj = {"codeKind": codeKind};
    postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data){
        var optionHtml = '';
        var childCodeList = data.childCodeList;
        $.each(childCodeList, function(index, item){
//          optionHtml += '<option value='+item.codeId+' >';
            //data-etc = 'Y' 이면 saledCode 필수 'N' 이면 옵션으로 설정
            optionHtml += '<option value="'+item.codeId+'" data-rprc="'+item.codeRprc+'" data-etc="'+item.codeEtc+'"">';
            optionHtml += item.codeNm;
            optionHtml += '</option>';
        });
        $(target).append(optionHtml);
        

        selectSalesCodeSet();
    });
}


//Sales Code 필수 변경
function selectSalesCodeSet() {
    if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
        $('#popForm .Sales_Code').addClass('hit');
        $('#popForm input#salesCd').attr('required');
        $("#salesTarget").attr("onclick", "wbsSalesCodeSearch();").removeClass("disabled");
    } else {
        $('#popForm .Sales_Code').removeClass('hit');
        $('#popForm input#salesCd').removeAttr('required');
        $("#salesTarget").removeAttr("onclick").addClass("disabled");

    }
}       

function selectDailyWorkInfo() {                        //그리드에 뿌리는 데이터
    var formData = {
        "fileTrgtKey" : fileTrgtKey,
    }
    postAjax("/user/pm/pm01/selectDailyWorkInfo", formData, null, function(data) {
			var resultData = data.result;
            $.each(resultData, function(key, value) {
                if ($('#popForm #' + key)[0]) {
                    $('#popForm #' + key).val(value);
                    if ($('#popForm #' + key).is('[comma]')) {
                        onlyNumber($('#popForm #' + key)[0]);
                    }
                }
            });
			//상위코드 연동으로 바뀌기 전에 저장값 설정되므로 재설정 필요함
       	    selectCodeList($("#workRptL"),0);
			$('#popForm #workRptM').val(data.result.workRptM);
    	    selectCodeList($("#workRptM"),1);
    	 	$('#popForm #workRptS').val(data.result.workRptS);
    });
}



 // 등록
function insertDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {                     // 필수 필드의 유효성 검사
        var formData = makeFormData();                                      // 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
        filePostAjax("/user/pm/pm01/insertDailyWork", formData,             // 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
                function(data) {
//                     alert(data.resultMessage);                              // 결과 메시지를 alert으로 출력
                    if (data.resultCode == 200) {                           //  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
                        gridView.setData(0);
                        modalStack.close();                                 // 모달을 닫음
                    }
                });
    }
}

// 수정
function updateDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {                     // 필수 필드의 유효성 검사
        var formData = makeFormData();                                      // 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성\
        filePostAjax("/user/pm/pm01/updateDailyWork", formData,function(data) {
//                     alert(data.resultMessage);
                    if (data.resultCode == 200) {
                        gridView.setData(0);
                        modalStack.close();
                    }
                });
    }
}

//----------------------------------------------//

function makeFormData() {
    // 금액 콤마 제거
    $.each($('.popup_area input[comma]'), function(idx, elem) {
        deleteComma(elem);
    });
    // 날짜 하이픈 제거
    $.each($('.popup_area input[date]'), function(idx, elem) {
        deleteHyphen(elem);
    });
    
    if ($('#workRptS').find('option:selected').data('etc') === 'N') {
    	$('#salesCd').val("");
        $("#clntNm").val("");
        $("#clntPjtNm").val("");
        $("#prdtCdNm").val("");
        $("#itemDivNm").val("");
        $("#eqpNm").val("");
    }
    // 폼데이터 생성
    var formData = new FormData($("#popForm")[0]);
    //---------------------------------------------------------------  
    //  disabled 처리시 값 전송안됨 아래에서 폼데이터 추가
    //---------------------------------------------------------------
    formData.append("coCd", jwt.coCd);
    formData.append("workRptId", jwt.userId);
    formData.append("workRptNo", $('#workRptNo').val());
    formData.append("workRptDt", $('#workRptDt').val());
    formData.append("fileTrgtKey", fileTrgtKey);
    formData.append("pgmId", "PM0101M01_M");
    
    //---------------------------------------------------------------  
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
    //---------------------------------------------------------------  
    // 유저아이디 추가
    formData.append("userId", jwt.userId);
    formData.append("clntCd", $('#vendCd').val());          //첨부화일용
    formData.append("prdtCd", $('#prdtCd').val());          //첨부화일용
    formData.append("itemCd", $('#itemDiv').val());         //첨부화일용
    formData.append("prjctCd", $('#clntPjt').val());        //첨부화일용
    formData.append("fileTrgtTyp", "PM0101M01");
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
    //formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용
    
    //---------------------------------------------------------------  
    
    //---------------------------------------------------------------  
    var fileUploadArr = [];
    var deleteloadArr = [];
    var tempArr = [];
    
    //tempArr = treeModule.getFileArr();
    //$.each(tempArr, function(idx, obj) {
    //    if (obj.fileKey == 0) {
    //        formData.append("files", obj.file);
    //        obj.file = '';
     //       fileUploadArr.push(obj);
    //    }
    //});

    formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
    formData.append("deleteFileArr", JSON.stringify(deleteloadArr));
    //---------------------------------------------------------------  
    //--첨부화일 처리를 위한 부분 끝
    //--------------------------------------------------------------- 

    return formData;
}

//Sales Code 검색
function wbsSalesCodeSearch() {
    var paramObj = {
       "coCd" : $('#coCd_S').val(),
       "salesCd": $('#salesCd').val()
    };
    openSecondModal("/static/mobile/modal/wbsSalesCodeSearch_M.html", 350, 330, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        $('#salesCd').val(row.salesCd);
        $('#clntPjt').val(row.clntPjt);
        $('#clntPjtNm').val(row.clntPjtNm);
        $('#clntCd').val(row.ordrsClntCd);
        $('#clntNm').val(row.ordrsClntNm);
        $('#prdtCd').val(row.prdtCd);
        $('#prdtCdNm').val(row.prdtCdNm);
        $('#itemDiv').val(row.itemDiv);
        $('#itemDivNm').val(row.itemDivNm);
        $('#eqpNm').val(row.eqpNm);
    });
}
        

function setWorkRptHour(_value) {
    var value = _value.replace(/[^0-9]/g,'');
    if(value != "" && value > 24) {
        alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
        return "";
    }
    return value;
}

</script>