<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
      <h4 class="tit">작업일보 등록</h4>
    </div>

  <form id="popForm" onSubmit="return false;">
    <div class="form-group popup_table">
		<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
		<input type="hidden" id="userId"     	name="userId">
		<input type="hidden" id="pgmId"     	name="pgmId"	value="PM0101P01_M">
		<input type="hidden" id="deptId"     	name="deptId">
 		<table width="350px">

        <colgroup>
          <col width="30%">
          <col width="57%">
        </colgroup>

        <tr>
			<th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">회사</th>
			<td>
				<select id="coCd" name="coCd" data-kind="CO" required msg="회사" style="text-align:left;font-size:15px;font-weight:bold;">
				</select>
			</td>
		 </tr>
		 <tr><td colspan="2" heigth="4"></td></tr>	
		 <tr>
            <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작업일보번호</th>
            <td>
                <input type="text" id="workRptNo" name="workRptNo" class="form-control" msg="작업일보번호" style="text-align:left;font-size:15px;font-weight:bold;">
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>  
         <tr>
            <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작성자</th>
            <td>
                <input type="hidden" id="workRptId" name="workRptId" msg="작성자ID">
                 <div class="search_form">
                     <input type="text" id="workRptIdNm" name="workRptIdNm" class="form-control" required msg="작성자" readonly style="text-align:left;font-size:15px;font-weight:bold;">
                     <a onclick="openUserTree();">
                    <i class="i_search_w"></i>
                  </a></div>
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>  
         <tr>
            <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작성일자</th>
            <td>
                <input id="workRptDt" name="workRptDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);"  required msg="작성일자" date style="text-align:left;font-size:15px;font-weight:bold;">
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>  
         <tr>
            <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작업대분류</th>
            <td>
                <select id="workRptL" name="workRptL" name="workRptL" data-kind="WORKRPT" onchange="selectCodeList(this,0);" data-depth="0" required msg="작업대분류" style="text-align:left;font-size:15px;font-weight:bold;">
                   <option value="">선택</option>
                </select>
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>  
	         <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작업중분류</th>
	         <td>
	                <select class="division" id="workRptM" name="workRptM" onchange="selectCodeList(this,1);" data-depth="1" required msg="작업중분류" style="text-align:left;font-size:15px;font-weight:bold;">
	                    <option value="">선택</option>
	                </select>
	         </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>
         <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작업소분류</th>
            <td>
                <select class="division" id="workRptS" name="workRptS" onchange="selectSalesCodeSet();" data-depth="2" required msg="작업소분류" style="text-align:left;font-size:15px;font-weight:bold;">
                    <option value="">선택</option>
                </select>
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>
            <th class="hit" style="text-align:left;font-size:15px;font-weight:bold;">작업시간</th>
            <td>
                <input type="text" id="workRptHour" name="workRptHour" maxlength="2" required="required" class="form-control" required msg="작업시간"
                oninput="this.value=setWorkRptHour(this.value)" style="text-align:left;font-size:15px;font-weight:bold;">
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>
           <th class="hit Sales_Code" style="text-align:left;font-size:15px;font-weight:bold;">Sales Code</th>
            <td>
                <div class="search_form">
                    <input type="text" id="salesCd" name="salesCd" required onkeyup="event.keyCode == 13 ? gridView.setData(0) : ''" required msg="Sales Code" readonly style="text-align:left;font-size:15px;font-weight:bold;">
                    <a onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
                </div>
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>
            <th>고객사</th>
            <td><input type="hidden" id="clntCd" name="clntCd" msg="고객사" >
                <input type="text" id="clntNm" name="clntNm" msg="고객사" style="text-align:left;font-size:15px;font-weight:bold;">
            </td>
         </tr>   
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>
            <th>고객사PJT</th>
            <td><input type="hidden" id="clntPjtCd" name="clntPjtCd" msg="고객사PJT">
                <input type="text" id="clntPjt" name="clntPjt" msg="고객사PJT" style="text-align:left;font-size:15px;font-weight:bold;"> 
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>
         <tr>         
            <th>제품구분</th>
            <td>
                <input type="hidden" id="prdtCd" name="prdtCd" msg="제품구분">
                <input type="text" id="prdtCdNm" name="prdtCdNm" msg="제품구분" style="text-align:left;font-size:15px;font-weight:bold;">

            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>   
         <tr>
            <th>아이템구분</th>
            <td>
                <input type="hidden" id="itemDiv" name="itemDiv" msg="아이템구분">
                <input type="text" id="itemDivNm" name="itemDivNm" msg="아이템구분" style="text-align:left;font-size:15px;font-weight:bold;">
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>   
         <tr>   
            <th>설비명</th>
            <td colspan="5">
                <input type="text" id="eqpNm" name="eqpNm" msg="설비명" style="text-align:left;font-size:15px;font-weight:bold;">
            </td>
         </tr>
         <tr><td colspan="2" heigth="4"></td></tr>   
         <tr>
            <th>비고</th>
            <td colspan="7">
                <textarea rows="3" id="workRptRmk" name="workRptRmk" class="form-control"  msg="비고" style="text-align:left;font-size:15px;font-weight:bold;"></textarea>
            </td>
         </tr>
         
      </table>
      
    </form>
	</div>
    <!-- 하단 버튼 -->
	<div class ="popup_bottom_btn">
		<button type="button" id="actionBtn" authChk>등록</button>
		<button type="button" class="close_btn"
			onclick="modalStack.close();">닫기</button>
	</div>

<script type="text/javascript">
var actionType = null;
var fileTrgtKey = null;

$(document).ready(function() {
    setCommonSelect($(".popup_area select[data-kind]"));
    setByCoCd(modalStack.last().paramObj.coCd);
    $("#popForm #userId").val(jwt.userId);
    $("#popForm #workRptId").val(jwt.userId);
    $("#popForm #workRptIdNm").val(jwt.userNm);
    $("#popForm #deptId").val(jwt.deptId);
            
    setWorkPtDept();//자동분류 자동선택
    
    //작성일자//
    $('#workRptDt').datepicker({
        format : "yyyy-mm-dd",
        language : "ko",
        autoclose : true
    }).datepicker("setDate", new Date());
    
    //authChk();                      // 권한체크

    actionType = modalStack.last().paramObj.actionType;
    fileTrgtKey = modalStack.last().paramObj.fileTrgtKey;
    
    $("#clntNm").prop("readonly", true);
    $("#clntPjt").prop("readonly", true);
    $("#prdtCdNm").prop("readonly", true);
    $("#itemDivNm").prop("readonly", true);
    $("#eqpNm").prop("readonly", true);
    //$("#matrNm").prop("readonly", true);

    $('#currCd').on('change', exrateCal);
    
    if (actionType == "C") {
        $("#coCd").prop("readonly", true);
        $("#workRptNo").prop("disabled", true);
        
        //신규일때 임시 작업일련번호 DW230523-0001
        //$('#workRptNo').val("DW"+new Date().format('yyyyMMdd')+"-****");
        
        $("#actionBtn").text("등록");
        $('#actionBtn').on("click", function() {
            insertDailyWork();
        });

    } else if (actionType == "U") {
        $("#coCd").prop("disabled", true);
        $("#workRptNo").prop("disabled", true);
        $("#workRptIdNm").prop("disabled", true);
        $("#workRptDt").prop("disabled", true);
        
        $('.tit').text('작업일보 수정')
        
        selectDailyWorkInfo();

        $('#actionBtn').text("수정");
        $('#actionBtn').on("click", function() {
            updateDailyWork();
        });
    }

});


//세션의 부서코드로 작업 대분류/중분류/소분류 자동셋팅
function setWorkPtDept() {
    //$("#deptId").val("GUN70");//임시 GUN1010, GUN6010, TRN1099
    var deptId = $("#deptId").val();
    var deptLen = deptId.length;
    var deptText = deptId.replace(/[0-9]/g,"");
    var deptNumText = deptId.replace(/[^0-9]/g,"");
    var deptNumLen = deptNumText.length;
    
    if(deptNumLen >= 4){ //번호길이가 4이면 대분류>중분류
        var workRptL_id = deptId.substring(0,deptLen-2);
        $('#workRptL').val(workRptL_id);
        if($('#workRptL').val() == null || $('#workRptL').val() == "") {
            //Option 에 값이 없다면
            $('#workRptL').val("");
        } else {
            //Option 에 값이 있다면 중분류조회
            $('#workRptL').trigger('change');
            //중분류 셋팅
            $('#workRptM').val(deptId);
            //중분류 없다면 초기화
            if($('#workRptM').val() == null || $('#workRptM').val() == "") {
                $('#workRptM').val("");
            }
        }
        
    }
    else{
        $('#workRptL').val(deptId);
        selectCodeList($('#workRptL'),0);
        if($('#workRptL').val() == null || $('#workRptL').val() == "") {
            //Option 에 값이 없다면
            $('#workRptL').val("");
        }
    }
}

//작업 대분류/중분류/소분류
function selectCodeList(obj,idx) {
    var codeKind = $(obj).val();
    var target = $(obj).next('select.division');
    if(idx == 0){
        target = $("#workRptM");
        $('#workRptM option[value!=""]').remove();
        $('#workRptS option[value!=""]').remove();
    }else{
        target = $("#workRptS");
        $('#workRptS option[value!=""]').remove();
    }
    var paramObj = {"codeKind": codeKind};
    
    postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data){
        var optionHtml = '';
        var childCodeList = data.childCodeList;
        $.each(childCodeList, function(index, item){
//          optionHtml += '<option value='+item.codeId+' >';
            //data-etc = 'Y' 이면 saledCode 필수 'N' 이면 옵션으로 설정
            optionHtml += '<option value="'+item.codeId+'" data-rprc="'+item.codeRprc+'" data-etc="'+item.codeEtc+'"">';
            optionHtml += item.codeNm;
            optionHtml += '</option>';
        });
        $(target).append(optionHtml);
    });
}

//통화단위 변경
function exrateCal() {
    var currCd = $('#currCd').val();
    var exrateVal = $('#currCd option[value="' + currCd + '"]').data('etc');
    $('#exrate').val(exrateVal ? exrateVal : '');

}       


//Sales Code 필수 변경
function selectSalesCodeSet() {
    if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
        $('#popForm .Sales_Code').addClass('hit');
        $('#popForm input#salesCd').attr('required', 'required');           
    } else {
        $('#popForm .Sales_Code').removeClass('hit');
        $('#popForm input#salesCd').removeAttr('required');
    }
}       

function selectDailyWorkInfo() {                        //그리드에 뿌리는 데이터
    var formData = {
        "fileTrgtKey" : fileTrgtKey,
    }
    postAjax("/user/pm/pm01/selectDailyWorkInfo", formData, null, function(data) {
            $.each(data.result, function(key, value) {
                if ($('#popForm #' + key)[0]) {
                    $('#popForm #' + key).val(value);
                    if ($('#popForm #' + key).is('[comma]')) {
                        onlyNumber($('#popForm #' + key)[0]);
                    }
                }
            });
            
            //작업 대분류,중분류,소분류 [수정시 자동선택]
            if($('#workRptL').val() != null && $('#workRptL').val() != "") {
                var resultData = data.result;
                var vWorkRptM = resultData.workRptM;
                var vWorkRptS = resultData.workRptS;
                $('#workRptL').trigger('change');
                $('#workRptM').val(vWorkRptM);
                if($('#workRptM').val() != null && $('#workRptM').val() != "" && vWorkRptM != null && vWorkRptM != "") {
                    $('#workRptM').trigger('change');
                    $('#workRptS').val(vWorkRptS);
                    if($('#vWorkRptS').val() == null || $('#vWorkRptS').val() == "") {
                        $('#vWorkRptS').val("");//초기화 선택
                    }
                }
                
            }
            selectSalesCodeSet();
    });
}



 // 등록
function insertDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {                     // 필수 필드의 유효성 검사
        var formData = makeFormData();                                      // 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
        filePostAjax("/user/pm/pm01/insertDailyWork", formData,             // 파일을 포함한 데이터를 서버로 전송하는 비동기적인 AJAX 요청을 수행
                function(data) {
                    alert(data.resultMessage);                              // 결과 메시지를 alert으로 출력
                    if (data.resultCode == 200) {                           //  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
                        gridView.setData(0);
                        modalStack.close();                                 // 모달을 닫음
                    }
                });
    }
}

// 수정
function updateDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {                     // 필수 필드의 유효성 검사
        var formData = makeFormData();                                      // 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성\
        for (let key of formData.keys()) {
            //console.log(key, ":", formData.get(key));
        }
        filePostAjax("/user/pm/pm01/updateDailyWork", formData,function(data) {
                    alert(data.resultMessage);
                    if (data.resultCode == 200) {
                        gridView.setData(0);
                        modalStack.close();
                    }
                });
    }
}

//----------------------------------------------//

function makeFormData() {
    // 금액 콤마 제거
    $.each($('.popup_area input[comma]'), function(idx, elem) {
        deleteComma(elem);
    });
    // 날짜 하이픈 제거
    $.each($('.popup_area input[date]'), function(idx, elem) {
        deleteHyphen(elem);
    });
    // 폼데이터 생성
    var formData = new FormData($("#popForm")[0]);
    //---------------------------------------------------------------  
    //  disabled 처리시 값 전송안됨 아래에서 폼데이터 추가
    //---------------------------------------------------------------
    formData.append("coCd", $('#coCd').val());
    formData.append("workRptNo", $('#workRptNo').val());
    formData.append("workRptIdNm", $('#workRptIdNm').val());
    formData.append("workRptDt", $('#workRptDt').val());
    
    //---------------------------------------------------------------  
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
    //---------------------------------------------------------------  
    // 유저아이디 추가
    formData.append("userId", jwt.userId);
    formData.append("clntCd", $('#vendCd').val());          //첨부화일용
    formData.append("prdtCd", $('#prdtCd').val());          //첨부화일용
    formData.append("itemCd", $('#itemDiv').val());         //첨부화일용
    formData.append("prjctCd", $('#clntPjt').val());        //첨부화일용
    
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
    //formData.append("comonCd", treeModule.getFileNodeId()); //첨부화일용
    
    //---------------------------------------------------------------  
    
    //---------------------------------------------------------------  
    var fileUploadArr = [];
    var deleteloadArr = [];
    var tempArr = [];
    
    //tempArr = treeModule.getFileArr();
    //$.each(tempArr, function(idx, obj) {
    //    if (obj.fileKey == 0) {
    //        formData.append("files", obj.file);
    //        obj.file = '';
     //       fileUploadArr.push(obj);
    //    }
    //});

    formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
    formData.append("deleteFileArr", JSON.stringify(deleteloadArr));
    //---------------------------------------------------------------  
    //--첨부화일 처리를 위한 부분 끝
    //--------------------------------------------------------------- 

    return formData;
}

//Sales Code 검색
function wbsSalesCodeSearch() {
    var paramObj = {
       "coCd" : $('#coCd_S').val(),
       "salesCd": $('#salesCd').val()
    };
    openSecondModal("/static/mobile/modal/wbsSalesCodeSearch_M.html", 350, 330, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        $('#salesCd').val(row.salesCd);
        $('#clntPjt').val(row.clntPjt);
        $('#clntCd').val(row.ordrsClntCd);
        $('#clntNm').val(row.ordrsClntNm);
        $('#prdtCd').val(row.prdtCd);
        $('#prdtCdNm').val(row.prdtCdNm);
        $('#itemDiv').val(row.itemDiv);
        $('#itemDivNm').val(row.itemDivNm);
        $('#eqpNm').val(row.eqpNm);
    });
}
        

//  업체명 검색 //
function clntSearch() {
    openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420,
            "업체명 검색", {}, function(grid) {
                var row = grid.target.getList("selected")[0];
                $('#pchsClntCd').val(row.clntCd);
                $('#pchsClntNm').val(row.clntNm);
//              $('#mngId').val(row.salesEmpId);
//              $('#mngNm').val(row.salesEmpNm);

//              var paramObj = {
//                  "coCd" : $('#coCd').val(),
//                  "clntCd" : row.clntCd
//              }
//              setMngInfo(paramObj);
            });
}

// 영업담당자 set
//function setMngInfo(paramObj) {
//  postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null,
//          function(data) {
//              if (data.mngInfo) {
//                  $('#mngId').val(data.mngInfo.salesEmpId);
//                  $('#mngNm').val(data.mngInfo.salesEmpNm);
//              } else {
//                  $('#mngId').val("");
//                  $('#mngNm').val("");
//              }
//          });
//}

//작성자 검색 //
function openUserTree(gbn) {
    if($('#workRptIdNm').prop("disabled")) return false;
    
    var paramObj = {
        "coCd" : $('#coCd').val(),
        "userId": $('#workRptId').val(),
        "userNm": $('#workRptIdNm').val(),
        "useYn": "Y"
    };
    openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
        var checkedId = tree.get_checked()[0];
        var checkedNode = tree.get_node(checkedId);
        $('#workRptId').val(checkedNode.id);
        $('#workRptIdNm').val(checkedNode.text);
//      $("#deptNm_S").val(checkedNode.original.deptNm);
//      $("#deptId_S").val(checkedNode.parent);
    });
}

function setWorkRptHour(_value) {
    var value = _value.replace(/[^0-9]/g,'');
    if(value != "" && value > 24) {
        alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
        return "";
    }
    return value;
}

function setByCoCd(value) {
    $('#coCd option:not([value="'+value+'"])').remove();
    $('#workRptL option:not([value="'+jwt.deptId+'"])').remove(); //사용자 부서 코드외 제거
    selectCodeList($('#workRptL_S'),0);
}

</script>