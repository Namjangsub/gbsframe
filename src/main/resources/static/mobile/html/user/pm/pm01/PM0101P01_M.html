<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
    <link rel="stylesheet" href="/static/css/gnb.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/sub.css" />
    <link rel="stylesheet" href="/static/css/m_common.css" />
	<link rel="stylesheet" href="/static/css/mobile.css" />

    <script src="/static/js/jquery-latest.min.js"></script>
    <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/global.js"></script>
	<script src="/static/js/jquery.blockUI.js"></script>
	<script src="/static/js/heic2any.min.js"></script>
    <style>
        tr {
          height: 26px;
        }
		#main_area{
		    padding: 0px 0px;
		    overflow: auto;
	    }
    </style>
</head>

<body>
    <div id="head_area" class="off" >
        <div class="left_btn" onclick="history.back(-1)">
              <a class="back_btn"></a>
        </div>
        <h1 class="logo">
              <img src="/static/img/Logo_gunyangitt.gif" alt="건양ITT" />
        </h1>
    </div>



<div id="main_area">
    <div class="popup_area">
        <div class="tit_contents">
            <h4 class="tit">작업일보 등록</h4>
        </div>
			<input type="file" id="notiFile" style="display:none" multiple="multiple" onchange="setNotiFile(this);"/>
	<form id="popForm" onSubmit="return false;">
            <input type="hidden" id="workRptIdNm" name="workRptIdNm">
			<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
			<input type="hidden" id="pgmId"     	name="pgmId"	value="PM0101M01">
			<input type="hidden" id="deptId"     	name="deptId">
			<input type="hidden" id="ordCoCd"     	name="ordCoCd" msg="오더도는 salesCode용 회사코드">
			<input type="hidden" id="coCd" name="coCd" required msg="회사">
			<input type="hidden" id="workRptNo" name="workRptNo" msg="작업일보번호">
			<input type="hidden" id="workRptL" name="workRptL" data-depth="0" onchange="selectCodeList(this,0);" class="division" required msg="작업대분류" >
			<input type="hidden" id="telNo"   name="telNo">
            <div class="form-group popup_table" style="width: 100%;">
                <table>

                    <colgroup>
                    <col width="28%">
                    <col width="72%">
                    </colgroup>

                    <tr>
                        <th class="hit" >작성일자</th>
                        <td>
                            <input id="workRptDt" name="workRptDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" inputmode="numeric"  required msg="작성일자" date>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit">작업분류</th>
                        <td>
                                <select class="division" id="workRptM" name="workRptM" onchange="selectCodeList(this,1);" data-depth="1" class="form-control" required msg="작업중분류">
                                </select>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit">작업구분</th>
                        <td>
                            <select class="division" id="workRptS" name="workRptS" onchange="selectSalesCodeSet();" data-depth="2" required class="form-control" msg="작업소분류">
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit">작업시간</th>
                        <td>
							<input type="text" class="form-control" id="workRptHour" name="workRptHour" maxlength="10" required="required" class="form-control" required msg="작업시간" oninput="this.value=setWorkRptHour(this.value)" onblur="this.value=setWorkRptHour2(this.value)">
						</td>
                    </tr>
                    <tr>
                        <th>비고</th>
                        <td>
                            <textarea rows="2" id="workRptRmk" name="workRptRmk" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit Sales_Code">Sales Code</th>
                        <td>
                            <div class="search_form">
                                <input type="text" id="salesCd" name="salesCd" required class="form-control" msg="Sales Code" >
                                <a id="salesTarget" onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
                            </div>
                        </td>
                    </tr>
                    <tr>
						<th>수주번호</th>
						<td>
							<div class="search_form">
								<input type="text" class="form-control" id="ordrsNo" name="ordrsNo"  onchange="clearSalesCodeField();"  msg="수주번호">
								<a id="salesTarget" onclick="opendOrdrsSearch($('#ordrsNo').val(), $('#coCd').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
                    </tr>
                    <tr>
                        <th>고객사</th>
                        <td>
			            	<input type="hidden" id="clntCd" name="clntCd" msg="고객사">
				            <div class="search_form">
				              <input type="text" id="clntNm" name="clntNm" class="form-control" onkeyup="event.keyCode == 8 ? clntCd.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''" >
				              <a onclick="clntSearch();"><i class="i_search_w"></i>
				              </a>
				            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>고객사PJT</th>
                        <td>
							<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" data-search="clntPjt" class="form-control" msg="고객사PJT">
								<option value=""></option>
            				</select>
                        </td>
                    </tr>
                    <tr>
						<th>제품유형</th>
						<td colspan= "1">
					   		<div class="search_form">
								<input type="hidden" id="prdtCd" name="prdtCd" data-search="prdtCd" class="form-control" style="text-align: center;" readonly>
					    	  	<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtNm" class="form-control" onkeyup="event.keyCode == 8 ? prdtCd.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''" >
						    	<a onclick="openPrdtSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>
                    </tr>
                    <tr>
						<th>아이템구분</th>
						<td>
							<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv" class="form-control" msg="아이템구분">
								<option value=""></option>
	            			</select>
						</td>
                    </tr>
                    <tr>
                        <th>설비명</th>
                        <td>
                            <input type="text" id="eqpNm" name="eqpNm" class="form-control" msg="설비명">
                        </td>
                    </tr>
					<tr style="display: none;">
					  <!-- <th>문제유무</th> -->
					  <td style="display: none;">
						  <select id="issueYn" name="issueYn" data-search="issueYn" class="form-control" >
							  <option value="N">NO</option>
							  <option value="Y">YES</option>
						  </select>
					  </td>
					</tr>
					<tr id="field01" style="display:none;">
						<th>문제제목</th>
						<td colspan="3">
						  <input type="text" id="issueTitle" name="issueTitle" class="form-control">
						</td>
					</tr>
					<tr id="field02">
					  <th>
						<button type="button" id="buttonFile1" class="btn btn-primary btn-sm" style="height: 40px; line-height: 15px;" onclick="fromWebToApp(1);">파일선택</button>
						<div><br></div>
						<button type="button" id="buttonFile2" class="btn btn-primary btn-sm" style="height: 40px; line-height: 15px;" onclick="fromWebToApp(2);">사진촬영</button>
					  </th>
					  <td colspan="3">
						<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
					  </td>
					</tr>
					<tr class="tripAreaButton">
						<th colspan=1>일일 출장비 내역 등록</th>
						<th><button type="button" id="addDayileRptTrpButton" class="btn btn-primary btn-sm" style="height: 35px; line-height: 15px;">경비추가</button>
						<button type="button" id="removeDayileRptTrpButton" class="btn btn-primary btn-sm" style="height: 35px; line-height: 15px; display: none;">경비삭제</button></th>
					</tr>
                </table>
            </div>
            <div  id="dayilyRpt"></div>
        </form>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
    </div>
    <!-- 하단 버튼 -->
    <div class ="mobile_mid_btn">
        <button type="button" style="height: 35px;  width: 90px;"id="actionBtn" authChk>등록</button>
        <button type="button" class="close_btn" style="height: 35px;  width: 90px;" onclick="window.history.back();">닫기</button>
    </div>
</div>



<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	var paramObj = null;
	var fileParam = null;
    var windowWidth = $(window).width();
    var windowHeight = $(window).height();

    // 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
    var kakaoErr = [];


	var notiFileArr = [];
	var deleteFileArr = [];
	var rptTripFileArr = []; //경비항목별 첨부파일 정보 임시저장
	var tripRptRowDeleteArr = []; //경비 등록내용 삭제 임시저장
	var tripRptRowFileDeleteArr = []; //경비 등록내용중 첨부파일만 삭제 임시저장
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        },
				columns: [
						{key: "fileName", label: "파일명", width: 240,
							formatter:function() {return '<button type="button" style="height: 19px; padding:0px;" onclick="downloadFile('+this.dindex+');">' + this.value + '</button>';}
						},
						{key: "fileType", label: "파일타입", width: 80, align: "center"},
						{key: "fileSize", label: "파일크기", width: 80,  align: "right", formatter: "money"},
						{key: "fileDelBtn", label: "삭제", width:50,
							formatter:function() {return (this.item.fileDelete == "Y") ? '<button style="height: 20px; padding:0px;" type="button" onclick="deleteFile('+this.dindex+')">삭제</button>' : '불가'}
						},
						{key : "fileList",  label : "list",	 width : 60, align: "center", hidden: true},
						{key : "fileUp",  label : "up",	 width : 60, align: "center", hidden: true},
						{key : "fileDown",  label : "down",	 width : 60, align: "center", hidden: true},
						{key : "fileUpdate",  label : "update",	 width : 60, align: "center", hidden: true},
						{key : "fileDelete",  label : "delete",	 width : 60, align: "center", hidden: true},
				]
			});
		},
		setData: function(){
			var targetObj = this.target;
			targetObj.setData({
				list: notiFileArr,
				page : {
					totalElements : notiFileArr.length
				}
			});
		}
	}


$(document).ready(function() {

// 	document.body.style.fontSize = "10px";
// 	document.body.style.zoom = "100%";
// 		var screenWidth = window.innerWidth || document.documentElement.clientWidth;
// 		var screenHeight = window.innerHeight || document.documentElement.clientHeight;
// 		alert('화면 너비: ' + screenWidth + ', 화면 높이: ' + screenHeight);

	$("body").css("font-size", "12px");
    $("body").css("zoom", "100%");


	var newScreenWidth = $(window).width();
	var newScreenHeight = $(window).height();
	$('.popup_area').css('min-width', (newScreenWidth-15) + 'px');

	fileGridView.initView();
    //작성일자//
    $('#workRptDt').datepicker({
        format : "yyyy-mm-dd",
        language : "ko",
        autoclose : true
    }).datepicker("setDate", new Date());

    //세션에 정보를 활용하여 승인처리
    paramObj = JSON.parse(sessionStorage.getItem('paramObj'));
    sessionStorage.removeItem('paramObj');
    if (paramObj && paramObj != "undefined") {


    	$("#popForm #coCd").val(jwt.coCd);
        actionType = paramObj.actionType;
        fileTrgtKey = paramObj.fileTrgtKey;
		$("#fileTrgtKey").val(fileTrgtKey);


		setCommonSelect($(".popup_area select[data-kind]"));
		setWorkPtDept();//자동분류 자동선택

//         $("#clntNm").prop("readonly", true);
//         $("#clntPjtNm").prop("readonly", true);
//         $("#prdtCdNm").prop("readonly", true);
//         $("#itemDivNm").prop("readonly", true);
//         $("#eqpNm").prop("readonly", true);
        //전팀이 사용 가능함
//         if (jwt.deptId.slice(0,5) != 'GUN60' && jwt.userId != 'js.nam') $('.tripAreaButton').hide();
        if (actionType == "C") {
            $("#actionBtn").text("등록");

          //modal 넘어온값만큼 만큼 루프
			$.each(paramObj, function (key, val) {
				//입고정보 SET
				if( $("#popForm").find("#"+key).length > 0 ) {
					$("#popForm").find("#"+key).val(val);
				}
				if (key == 'workRptM'){//소분류 select 코드 세팅
					selectCodeList($("#workRptM"),1);
				}
				if (key == 'workRptHour'){//작업시간 빈값 세팅
					$("#workRptHour").val("");
				}
				if (key == 'workRptRmk'){//비고 빈값 세팅
					$("#workRptRmk").val("");
				}
			});
			monthWorkReportChk();	// 작업일보고찰 등록chk

            $('#actionBtn').on("click", function() {
                insertDailyWork();
            });

        } else if (actionType == "U") {
            $('.tit').text('작업일보 수정')

            selectDailyWorkInfo();

            $('#actionBtn').text("수정");
            $('#actionBtn').on("click", function() {
                updateDailyWork();
            });
        }
		// 작성일자 변경에 따른 적용 (제약조건)
		$('#workRptDt').change(function () {
			monthWorkReportChk();
		})

        // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
        var paramObj1 = {
                "coCd" : $("#popForm #coCd").val(),
                "userId" : jwt.userId
            };
         postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
             if (data.result[0] == undefined
                   || data.result[0].telNo == "") {
                 $("#popForm #telNo").val("051-312-2400");
             }
             else {
                 $("#popForm #telNo").val(data.result[0].telNo);
             }
         });

         //화면 필드 기능 추가 함수 모음
         fieldFunctionControl();


        //authChk();   // 권한체크
		$("#field02").hide();	//파일첨부영역


    } else {
        window.history.back();
    }

});


//세션의 부서코드로 작업 대분류/중분류/소분류 자동셋팅
function setWorkPtDept() {
    //$("#deptId").val("GUN70");//임시 GUN1010, GUN6010, TRN1099
    var deptId = jwt.deptId;
    if (deptId) {
    	$("#workRptL").val(deptId.substring(0,5));
	    selectCodeList($("#workRptL"),0);
	    selectCodeList($("#workRptM"),1);
    }
}

//화면 필드 기능 추가 함수 모음
function fieldFunctionControl() {
    //---------------------------------------
    //경비추가 버튼
	$('#addDayileRptTrpButton').click(function() {
		dailyRptTripAdd();
	});

    //경비제거 버튼
	$('#removeDayileRptTrpButton').click(function() {

// 		let tripCnt = $('.tripTable').not(':hidden').length;  //$('.tripTable:not(:visible)' --> tripTable1 display: none이 아닌 요소 선택
// 		if ($('#tripTable' + tripCnt + ' #updCheck').val() == 'U') {
//				$('#tripTable' + tripCnt + ' #updCheck').val('D');		//DB에서 불러오면 수정임 'U', 처음 등록시 C, 제거시 'D'
// 		} else {
// 			$('#tripTable' + tripCnt + ' #updCheck').val('');		//처음 생성한다음 삭제인경우 처리 제외 blank
// 		}
// 		$('#tripTable' + tripCnt).hide();  //마지막 테이블 숨기기

		let tripCnt = $('.tripTable').length;
		if (tripCnt == 0)  return false;
		if (tripCnt == 1) $('#removeDayileRptTrpButton').hide();

		if ($('#tripTable' + tripCnt + ' #updCheck').val() == 'U') {
			$('#tripTable' + tripCnt + ' #updCheck').val('D');		//DB에서 불러오면 수정임 'U', 처음 등록시 C, 제거시 'D'
    		tripRptRowDeleteArr.push(tripRptRow(tripCnt));	//삭제대상으로 저장함
		}

		$('#tripTable' + tripCnt).remove();  //마지막 테이블 지우기

	});

	$('#tripRptCurTyp').on('change', function () {
		//결제방법인 카드인경우는 카드번호 필수임
		if (this.value == 'CURTYP01') {
			$('#tripTable' + this.idxCnt + ' #cardTh').addClass('hit');
			$('#tripTable' + this.idxCnt + ' #tripRptCardNo').attr('required', '');
		} else {
			$('#tripTable' + this.idxCnt + ' #cardTh').removeClass('hit');
			$('#tripTable' + this.idxCnt + ' #tripRptCardNo').removeAttr('required', '');
		}
	});

}

//작업 대분류/중분류/소분류
function selectCodeList(obj,idx) {
    var codeKind = $(obj).val();
    var target = $(obj).next('select.division');
    if(idx == 0){
        target = $("#workRptM");
        $('#workRptM option[value!=""]').remove();
        $('#workRptS option[value!=""]').remove();
    }else{
        target = $("#workRptS");
        $('#workRptS option[value!=""]').remove();
    }

    var paramObj = {"codeKind": codeKind};
    postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data){
        var optionHtml = '';
        var childCodeList = data.childCodeList;
        $.each(childCodeList, function(index, item){
            //data-etc = 'Y' 이면 saledCode 필수 'N' 이면 옵션으로 설정
            optionHtml += '<option value="'+item.codeId+'" data-rprc="'+item.codeRprc+'" data-etc="'+item.codeEtc+'"">';
            optionHtml += item.codeNm;
            optionHtml += '</option>';
        });
        $(target).append(optionHtml);


        selectSalesCodeSet();
    });
}

//Sales Code 필수 변경
function selectSalesCodeSet() {
    if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
        $('#popForm .Sales_Code').addClass('hit');
        $('#popForm input#salesCd').attr('required');
        $("#salesTarget").attr("onclick", "wbsSalesCodeSearch();").removeClass("disabled");
    } else {
        $('#popForm .Sales_Code').removeClass('hit');
        $('#popForm input#salesCd').removeAttr('required');
//         $("#salesTarget").removeAttr("onclick").addClass("disabled");

    }

    //GUN6020xx : 생산팀 출장,  xxxxx9902 : 개인 출장
//     let tempJobCode = $('#workRptS').val();
//     if (tempJobCode) {
// 	    if (tempJobCode.slice(0,7) === 'GUN6020' || tempJobCode.slice(5,9) === '9902') { //출장
// 	    	$('.tripArea').show();
// 	    } else {
// 	    	$('.tripArea').hide();
// 	    }
//     }
}

//경비추가 버튼 기능  수행
function dailyRptTripAdd() {
		let tripCnt = $('.tripTable').length;
		$('#removeDayileRptTrpButton').show();
		if ($('#tripTable' + tripCnt).css('display') === 'none') {
// 	        console.log('마지막 tripTable 숨김상태');
    		if ($('#tripTable' + tripCnt + ' #updCheck').val() == 'D') {
 				$('#tripTable' + tripCnt + ' #updCheck').val('U');		//DB에서 불러오면 수정임 'U' --> D --> U
    		} else {
    			$('#tripTable' + tripCnt + ' #updCheck').val('C');		//처음 생성한다음 삭제인경우 C --> null --> C
    		}
    		$('#tripTable' + tripCnt).show();  //마지막 테이블 숨기기
	    } else {
// 	        console.log('마지막 tripTable 활성상태');
			tripCnt += 1;

	        var newRow = $('<table id="tripTable'+ (tripCnt) +'" class="tripTable" style="margin-top: 20px; display:break"> ' +
	        	'<tr class="tripArea">' +
	            '<th class="hit">비용항목</th>' +
	            '<td>' +
	            '<select id="tripRptTyp" name="tripRptTyp" data-kind="TRPTYP" data-search="tripRptTyp" class="form-control" msg="비용항목" required>' +
	            '<option value=""></option>' +
	            '</select>' +
	            '</td>' +
	            '<th>내용</th>' +
	            '<td>' +
	            '<input type="hidden" id="fileTrgtKey" name="fileTrgtKey" value="">' +
	            '<input type="hidden" id="updCheck" name="updCheck" value="C">' +
	            '<input type="hidden" id="workRptNoSeq" name="workRptNoSeq" value=' + tripCnt +'>' +
	            '<input type="text" id="tripRptRmk" name="tripRptRmk" data-search="tripRptRmk" class="form-control" msg="내용">' +
	            '</td>' +
	            '</tr>' +
	            '<tr class="tripArea">' +
	            '<th class="hit" >결제방법</th>' +
	            '<td>' +
	            '<select id="tripRptCurTyp" name="tripRptCurTyp" data-kind="CURTYP" idxCnt="' + tripCnt + '" data-search="tripRptCurTyp" class="form-control" msg="결제방법" required>' +
	            '<option value=""></option>' +
	            '</select>' +
	            '</td>' +
	            '<th id="cardTh">카드번호(끝4자리)</th>' +
	            '<td>' +
	            '<input type="text" id="tripRptCardNo" name="tripRptCardNo" idxCnt="' + tripCnt + '" maxlength="4" data-search="tripRptCardNo" class="form-control" msg="카드번호">' +
	            '</td>' +
	            '</tr>' +
	            '<tr class="tripArea">' +
	            '<th class="hit" >통화종류</th>' +
	            '<td>' +
	            '<select id="tripRptCurr" name="tripRptCurr" data-kind="CURR" data-search="tripRptCurr" class="form-control" msg="통화종류" required>' +
	            '<option value=""></option>' +
	            '</select>' +
	            '</td>' +
	            '<th class="hit" >금액</th>' +
	            '<td>' +
	            '<input type="text" id="tripRptAmt" name="tripRptAmt" value=0  data-search="tripRptAmt" class="form-control" onkeyup="onlyNumber(this);;" comma="" msg="금액" required>' +
	            '</td>' +
	            '</tr>' +
	            '<tr class="tripArea">' +
	            '<th colspan="2">' +
	            '<button type="button" id="buttonFile3" class="btn btn-primary btn-sm" style="height: 30px; line-height: 10px;" onclick="fromWebToApp(1, 0, ' + tripCnt + ' );">파일선택</button>' +
	            '<button type="button" id="buttonFile4" class="btn btn-primary btn-sm" style="height: 30px; line-height: 10px;" onclick="fromWebToApp(2, 0, ' + tripCnt + ' );">사진촬영</button>' +
	            '</th>' +
	            '<td colspan="2">' +
	            '<input type="text" id="tripRptFileNm" name="tripRptFileNm" class="form-control" readonly onclick="downloadTripRptFile(' + tripCnt +');"msg="첨부파일명">' +
	            '<input type="hidden" id="fileKey" name="fileKey" class="form-control" msg="첨부파일명">' +
	            '</td>' +
	            '</tr>' +
	            '</table>');
	        $('#dayilyRpt').append(newRow);

			setCommonSelect($('#tripTable' + tripCnt + ' #tripRptTyp'));
			setCommonSelect($('#tripTable' + tripCnt + ' #tripRptCurTyp'));
			setCommonSelect($('#tripTable' + tripCnt + ' #tripRptCurr'));

	    }
}



function chechChange(elm) {
	elm.value = addCommaStr(gPasFloatChk(elm.value));
}

function selectDailyWorkInfo() {                        //그리드에 뿌리는 데이터
    var formData = {
        "fileTrgtKey" : paramObj.fileTrgtKey,
        "workRptNo" : paramObj.workRptNo,
        "workRptId" : paramObj.workRptId,
    }
    postAjax("/user/pm/pm01/selectDailyWorkInfo", formData, null, function(data) {
			var resultData = data.result;
            $.each(resultData, function(key, value) {
                if ($('#popForm #' + key)[0]) {
                    $('#popForm #' + key).val(value);
                    if ($('#popForm #' + key).is('[comma]')) {
                        onlyNumber($('#popForm #' + key)[0]);
                    }
                }
            });
			selectNotiInfo();
			//수정시 폼 세팅
			if ($("#issueYn").val() =='Y'){
				  $("#field01").show(); //문제제목
				  $("#field02").hide(); //파일첨부영역 -> 그리드 영역 숨김(2025-02-20 실장님 지시)
			}
			else {
				$("#field01").hide(); //문제제목
				$("#field02").hide(); //파일첨부영역
			}

			//상위코드 연동으로 바뀌기 전에 저장값 설정되므로 재설정 필요함
       	    selectCodeList($("#workRptL"),0);
			$('#popForm #workRptM').val(data.result.workRptM);
    	    selectCodeList($("#workRptM"),1);
    	 	$('#popForm #workRptS').val(data.result.workRptS);

    	 	//경비내용 처리를 위한 루틴
    	 	let tripRows = data.tripRows;
    	 	if (tripRows && tripRows.length > 0) {
    	 		for (var i = 0; i < tripRows.length; i++) {
    	 			dailyRptTripAdd(); //입력필드 생성
    	 			$('#tripTable' + (i+1) + ' #updCheck').val('U');		//DB에서 불러오면 수정임 'U', 처음 등록시 C, 제거시 'D'
    	            $.each(tripRows[i], function(key, value) {
    	                if ($('#tripTable' + (i+1) + ' #' + key)) {
    	                    if ($('#tripTable' + (i+1) + ' #' + key).is('[comma]')) {
	    	                    $('#tripTable' + (i+1) + ' #' + key).val(addCommaStr(value));
    	                    } else {
	    	                    $('#tripTable' + (i+1) + ' #' + key).val(value);
    	                    }
    	                }
    	            });

   	        		//결제방법인 카드인경우는 카드번호 필수임
   	        		if (tripRows[i].tripRptCurTyp == 'CURTYP01') {
   	        			$('#tripTable' + (i+1) + ' #cardTh').addClass('hit');
   	        			$('#tripTable' + (i+1) + ' #tripRptCardNo').attr('required', '');
   	        		} else {
   	        			$('#tripTable' + (i+1) + ' #cardTh').removeClass('hit');
   	        			$('#tripTable' + (i+1) + ' #tripRptCardNo').removeAttr('required', '');
   	        		}
    	 		}
    	 	}

			monthWorkReportChk();	// 작업일보고찰 등록chk
    });
}

 // 등록
function insertDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {
    	//문제여부가 이면 제목 입력은 필수처리하기 위함
        if ($('#issueYn').val() === 'Y') {
          if ($.trim($('#issueTitle').val()) === '') {
            alert('문제발생시 제목입력은 필수입니다.');
            return false;
          }
        }

//         $('#actionBtn').hide();
        var formData = makeFormData();
        if (formData == false) return false;
        filePostAjax("/user/pm/pm01/insertDailyWork", formData,
                function(data) {
                    if (data.resultCode == 200) {
                    	if ($("#issueYn").val() == 'Y') {
                            kakaoTodo();
                        }
                        window.history.back();
                    }
                });
    }
}

// 수정
function updateDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {
    	//문제여부가 이면 제목 입력은 필수처리하기 위함
        if ($('#issueYn').val() === 'Y') {
          if ($.trim($('#issueTitle').val()) === '') {
            alert('문제발생시 제목입력은 필수입니다.');
            return false;
          }
        }

//         $('#actionBtn').hide();
        var formData = makeFormData();
        if (formData == false) return false;
        filePostAjax("/user/pm/pm01/updateDailyWork", formData,function(data) {
                    if (data.resultCode == 200) {
                    	if ($("#issueYn").val() == 'Y') {
                            kakaoTodo();
                        }
                        window.history.back();
                    }
                });
    }
}

function makeFormData() {
    // 날짜 하이픈 제거
    $.each($('.popup_area input[date]'), function(idx, elem) {
        deleteHyphen(elem);
    });

//     if ($('#workRptS').find('option:selected').data('etc') === 'N') {
//     	$('#salesCd').val("");
//         $("#clntNm").val("");
//         $("#clntPjtNm").val("");
//         $("#prdtCdNm").val("");
//         $("#itemDivNm").val("");
//         $("#eqpNm").val("");
//     }
    // 폼데이터 생성
    var formData = new FormData($("#popForm")[0]);
	// 첨부파일 추가
	$.each(notiFileArr, function(idx, obj){
		// 신규파일만 추가
		if(obj.fileKey == 0){
			formData.append("files", obj.file);
		}
	});

	if(actionType == "U"){
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
	}
    //---------------------------------------------------------------
    //  disabled 처리시 값 전송안됨 아래에서 폼데이터 추가
    //---------------------------------------------------------------
    formData.append("coCd", jwt.coCd);
    formData.append("workRptId", jwt.userId);
    formData.append("workRptNo", $('#workRptNo').val());
    formData.append("workRptDt", $('#workRptDt').val());
    formData.append("fileTrgtKey", fileTrgtKey);
    formData.append("userId", jwt.userId);
    formData.append("pgmId", "PM0101M01_M");
	// 유저아이디 추가
	formData.append("userId", jwt.userId);
	formData.append("clntCd", $('#clntCd').val());			//첨부화일용
	formData.append("prdtCd", $('#prdtCd').val());			//첨부화일용
	formData.append("itemCd", $('#itemDiv').val());			//첨부화일용
	formData.append("itemDiv", $('#itemDiv').val());
	formData.append("prjctCd", $('#clntPjt').val());		//첨부화일용
	formData.append("clntPjt", $('#clntPjt').val());
    //-------itemarr  --첨부화일 처리를 위한 부분 시작
	//formData.append("comonCd", treeModule.getFileNodeId());	//첨부화일용
	formData.append("comonCd", "FITR9902");	//첨부화일용

	//---------------------------------------------------------------

    //---------------------------------------------------------------
	var fileUploadArr = [];
	var tempArr = [];

	// tempArr = treeModule.getFileArr();
	// $.each(tempArr, function(idx, obj) {
	// 	if (obj.fileKey == 0) {
    //         formData.append("files", obj.file);
    //         obj.file = '';
    //         fileUploadArr.push(obj);
	// 	}
	// });
	formData.append("uploadFileArr",  JSON.stringify(notiFileArr));

	//경비 테이블의 값을 arry로 변환하여 저장하기
	let tripCnt = $('.tripTable').length;
	let tripRptS = [];	//경비현황 저장,  파일정보는 별도 보관됨 rptTripFileArr에 보관되어 있음
	for (var i = 1; i < tripCnt+1; i++) {

	  	let tripRptCurTyp = $('#tripTable' + i + ' #tripRptCurTyp').val();
	  	let tripRptCardNo = $('#tripTable' + i + ' #tripRptCardNo').val();
   		if (tripRptCurTyp == 'CURTYP01') {
    		//결제방법인 카드인경우는 카드번호 필수임
    	    if (tripRptCardNo.length == 4 && /^\d+$/.test(tripRptCardNo)) {
    	    } else {
    	    	alert ("카드번호 끝 4자리를 입력하세요!");
    	    	$('#tripTable' + i + ' #tripRptCardNo').focus();
    	    	return false;
    	    }
   		}

	  	let tripRptAmt = pasFloatChk($('#tripTable' + i + ' #tripRptAmt').val());
   		if (tripRptAmt == 0) {
	    	alert ("금액을 입력하세요!");
	    	$('#tripTable' + i + ' #tripRptAmt').focus();
	    	return false;
	    }

    	tripRptS.push(tripRptRow(i));
	}

	//paramMap.get("tripRptS")				-->최종입력된  경비내역 정보
	//paramMap.get("tripRptRowDeleteArr")	-->수정중 삭제된 경비내역 정보
	//paramMap.get("rptTripFiles"+xx)		-->최종입력됨 경비내역 첨부파일 file object임
	// 서버에서 작업시는 paramMap.get("tripRptRowDeleteArr")를 확인후 먼저 삭제 로직 수행후 paramMap.get("tripRptS") 처리해야함.
	formData.append("tripRptS",  JSON.stringify(tripRptS)); //수정된 경비내역 서버로 전송
	formData.append("tripRptRowDeleteArr",  JSON.stringify(tripRptRowDeleteArr));  //삭제된 경비내역 서버로 전송
	formData.append("tripRptRowFileDeleteArr",  JSON.stringify(tripRptRowFileDeleteArr));  //경비내역 수정시 삭제된 첨부파일정보
	//file object만 별도 추출
	$.each(rptTripFileArr, function(idx, obj){
		// 신규파일만 추가
		formData.append("rptTripFiles" + obj.rptTripNo, obj.file);
	});
    return formData;
}



//경비 처리 변경 내역 저장 단 U인경우 삭제된것만 저장하면됨
//경비테이블의 값을 추출하기
function tripRptRow(i) {
  	let updCheck = $('#tripTable' + i + ' #updCheck').val();
  	let fileTrgtKey = $('#tripTable' + i + ' #fileTrgtKey').val();
  	let workRptNoSeq = $('#tripTable' + i + ' #workRptNoSeq').val();
  	let tripRptTyp = $('#tripTable' + i + ' #tripRptTyp').val();
  	let tripRptRmk = $('#tripTable' + i + ' #tripRptRmk').val();
  	let tripRptCurTyp = $('#tripTable' + i + ' #tripRptCurTyp').val();
  	let tripRptCardNo = $('#tripTable' + i + ' #tripRptCardNo').val();
  	let tripRptCurr = $('#tripTable' + i + ' #tripRptCurr').val();
  	let tripRptAmt = deleteCommaStr($('#tripTable' + i + ' #tripRptAmt').val());
  	let tripRptFileNm = $('#tripTable' + i + ' #tripRptFileNm').val();
  	let fileKey = $('#tripTable' + i + ' #fileKey').val();
  	let tripRps = {
  			updCheck 		: updCheck,		//파일저장정보 인덱스
  			fileTrgtKey 	: fileTrgtKey,		//파일저장정보 인덱스
  			workRptNoSeq 	: workRptNoSeq,		//파일저장정보 인덱스
  			tripRptTyp		: tripRptTyp,
  			tripRptRmk		: tripRptRmk,
  			tripRptCurTyp	: tripRptCurTyp,
  			tripRptCardNo	: tripRptCardNo,
  			tripRptCurr		: tripRptCurr,
  			tripRptAmt		: tripRptAmt,
  			tripRptFileNm	: tripRptFileNm,
  			fileKey			: fileKey,


  		    coCd			: jwt.coCd,
  		    workRptId		: jwt.userId,
  		    workRptNo		: $('#workRptNo').val(), //수정모드일경우만 값이 존재함.
  		    workRptDt		: $('#workRptDt').val(),
  		    fileTrgtKey		: fileTrgtKey,
  		    userId			: jwt.userId,
  		    pgmId			: "PM0101D01_M"
  	}
  	return tripRps;
}


//Sales Code 검색
function wbsSalesCodeSearch() {
    var paramObj = {
       "coCd" : $('#coCd_S').val(),
       "salesCd": $('#salesCd').val()
    };
    openSecondModal("/static/mobile/modal/wbsSalesCodeSearch_M.html", windowWidth, windowHeight-20, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        $('#ordCoCd').val(row.coCd);
        $('#ordrsNo').val(row.ordrsNo);
        $('#salesCd').val(row.salesCd);
        $('#clntPjt').val(row.clntPjt);
        $('#clntPjtNm').val(row.clntPjtNm);
        $('#clntCd').val(row.ordrsClntCd);
        $('#clntNm').val(row.ordrsClntNm);
        $('#prdtCd').val(row.prdtCd);
		$('#prdtCdNm').val(row.prdtCdNm);
        $('#itemDiv').val(row.itemDiv);
        $('#itemDivNm').val(row.itemDivNm);
        $('#eqpNm').val(row.eqpNm);
    });
}

function setWorkRptHour(_value) {
    var value = _value.replace(/[^0-9.]/g, "");
//      value = value.toLocaleString();
    if(value != "" && value > 24) {
        alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
        return 24;
    }
    return value;
}

//작업시간 포커스를 빠져나갈때 실행됨
function setWorkRptHour2(_value) {
    var value = parseFloat(_value.replace(/[^0-9.]/g, "")).toFixed(2);
    value = value.toLocaleString();
    value = value == 'NaN' ? 0 : value;
    if(value != "" && value > 24) {
        alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
        return 24;
    }
    if(value == 0) {
        return "";
    }
    return value;
}


//  업체명 검색 //
function clntSearch() {
	var paramObj = {
			"clntDivCd": "CLNTDIV12",
			"searchType": "CLNT_NM",
			"searchValue": $('#clntNm').val(),
		};
	openSecondModal("/static/mobile/modal/clntSearch_M.html", windowWidth, windowHeight-20, "업체명 검색", paramObj, function(grid) {
				var row = grid.target.getList("selected")[0];
//					$('#prjctSeq').val(row.prjctSeq);
				$('#clntCd').val(row.clntCd);
				$('#clntNm').val(row.clntNm);
				$('#mngId').val(row.salesEmpId);
				$('#mngNm').val(row.salesEmpNm);

				var paramObj = {
					"coCd" : $('#coCd').val(),
					"clntCd" : row.clntCd
				}
//					setMngInfo(paramObj);
			});
}

//수주번호 검색
function opendOrdrsSearch(inputValue, coCd) {
    var paramObj = {
        "searchValue" : inputValue,
        "coCd" : coCd
    };
	openSecondModal("/static/mobile/modal/ordrsSearch_M.html", windowWidth, windowHeight-20, "수주번호 검색", paramObj, function (grid) {
        var row = grid.target.getList("selected")[0];
        $('#ordCoCd').val(row.coCd);
        $('#ordrsNo').val(row.ordrsNo);
        $('#clntPjt').val(row.clntPjt);
        $('#clntPjtNm').val(row.clntPjtNm);
        $('#clntCd').val(row.clntCd);
        $('#clntNm').val(row.clntNm);
        $('#ctrtNm').val(row.ctrtNm);
    });
}


//제품코드 검색
function openPrdtSearch(){
	var paramObj = {
			"coCd": $('#coCd').val(),
			"prdtCd": $('#prdtCd').val(),
			"prdtNm": $('#prdtCdNm').val(),
			"useYn" : "Y"
	}
	openSecondModal("/static/mobile/modal/prdtSearch_M.html", windowWidth, windowHeight-20,  "제품 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];
		$("#prdtCd").val(row.prdtCd);
		$("#prdtCdNm").val(row.prdtNm);
	});
}

$("#popForm #workRptM").change(function() {
	var workRptS = $("#workRptS").val();
    var str = workRptS.substr(-5);
    if (str == '09901'){
    	$("#workRptHour").val("8");
    }
    else {
    	$("#workRptHour").val("");
    }
});

$("#popForm #workRptS").change(function() {
	var workRptS = $("#workRptS").val();
    var str = workRptS.substr(-5);
    if (str == '09901'){
    	$("#workRptHour").val("8");
    }
    else {
    	$("#workRptHour").val("");
    }
});

$("#popForm #issueYn").change(function() {
	if ($("#issueYn").val() == 'Y'){
// 		fileGridView.initView();
	    $("#field01").show(); //문제제목
	    $("#field02").hide(); //파일첨부영역 -> 그리드 영역 숨김(2025-02-20 실장님 지시)
	}
	else {
		$("#field01").hide(); //문제제목
	    $("#field02").hide(); //파일첨부영역
	}
});

function setNotiFileInfo(fileInfo) {
	// 첨부파일 set
	$.each(fileInfo, function(idx, obj){
		notiFileArr.push({
			'fileKey' : obj.fileKey,
	      	'fileName' : obj.fileName,
	      	'fileType' : obj.fileType,
	      	'fileSize' : obj.fileSize,
	      	'fileList' : obj.fileList,
	      	'fileUp' : obj.fileUp,
	      	'fileDown' : obj.fileDown,
	      	'fileDelete' : obj.fileDelete,
	      	'fileUpdate' : obj.fileUpdate,
	      	'file' : obj
		});
	});
	// 첨부파일 그리드 set
	fileGridView.setData();
}

function setNotiFile(elem){
	var tempFiles = elem.files;
	$.each(tempFiles, function(idx, obj){
		var testArr = obj.name.split(".");
		notiFileArr.push({
			'fileKey' : 0,
	      	'fileName' : obj.name,
	      	'fileType' : testArr[testArr.length-1],
	      	'fileSize' : obj.size,
	      	'file' : obj,
	      	'fileDelete':'Y'
		});
		//첨부파일을 upload 하기위한 준비작업
		upSetFileUpload(obj.name, testArr[testArr.length-1], obj);
// 		$('#tripTable'+lastPosition+' #tripRptFileNm').val(obj.name);
	fileGridView.setData();
	$(elem).val("");
	});
}

function deleteFile(rowIndex) {
    if (notiFileArr[rowIndex].fileDelete != 'Y') {
    	alert('파일 삭제 권한이 없습니다.')
    	return false;
    };

	fileGridView.target.removeRow(rowIndex);

	if(notiFileArr[rowIndex].fileKey){
	// 기 등록되어 있는 파일 삭제시
		deleteFileArr.push(notiFileArr[rowIndex].fileKey);
	}

	notiFileArr.splice(rowIndex, 1);
}

function selectNotiInfo(){
	var paramObj = {
			"fileTrgtKey" : fileTrgtKey,
			"fileTrgtTyp" : "PM0101M01",
			"coCd"		  : $('#coCd').val(),
			"userId" 	  : jwt.userId
			};

	postAjax("/user/pm/pm01/selectUploadFileList", paramObj, null, function(data){
		var list = data.result;
		setNotiFileInfo(list);
	});

	//파일 등록 권한이 없으면 버튼 비활성화
	paramObj.comonCd = 'FITR9902';
	postAjax("/admin/cm/cm15/selectTreeAuthUserList", paramObj, null, function(data){
		if (data.userList[0].fileUp == 'Y') {
            buttonFile1.disabled = false; // 활성화
            buttonFile1.style.backgroundColor = ""; // 기본 배경색으로 변경 (옵션)
            buttonFile2.disabled = false; // 활성화
            buttonFile2.style.backgroundColor = ""; // 기본 배경색으로 변경 (옵션)
        } else {
            buttonFile1.disabled = true; // 비활성화
            buttonFile1.style.backgroundColor = "gray"; // 회색 배경색으로 변경 (옵션)
            buttonFile2.disabled = true; // 비활성화
            buttonFile2.style.backgroundColor = "gray"; // 회색 배경색으로 변경 (옵션)
        }
	});
}

//플로터 앱에서 웹페이지 자바스크립트 call
function fromAppToWeb(msg) {
    document.querySelector("#flutterMessageTitle").innerText = msg;
    alert(msg);
}

var lastPosition = 0;
//웹 자바스크립트에서 플로터 앱함수 call
//rptPosition ==> 경비추가 영역의 인덱스 번호임
function fromWebToApp(select, fileTrgtKey = "112233", rptPosition = 0) {
    lastPosition = rptPosition;
	var paramMsg = select + ',' + fileTrgtKey;
	// toApp 이 정의되어 있고 함수일 때만 호출
    // webview_flutter: JavascriptChannel(name: 'toApp') => window.toApp.postMessage(...)
    if (window.toApp && typeof window.toApp.postMessage === 'function') {
		try {
    		window.toApp.postMessage(paramMsg);
	    } catch (e) {
	        console.error('toApp 호출 중 오류, 파일 선택으로 대체합니다.', e);
			notiFile.click();
		}
	} else {
		notiFile.click();
	}
}

//웹 자바스크립트에서 플로터 앱함수 fileDownloadApp call
//플러터앱에서 다운로드 하기
function downloadTripRptFile(i) {
	let tripRptFileNm = $('#tripTable' + i + ' #tripRptFileNm').val();
	let fileKey = $('#tripTable' + i + ' #fileKey').val();
	let tripRptTyp = $('#tripTable' + i + ' #tripRptTyp option:checked').text();
	if(fileKey == 0 || fileKey == '' || fileKey == null) {
		return false;
	}

	//이미지뷰어 call
	let tempFileName = jwt.userNm + '-' + $('#workRptDt').val() + '-' + tripRptTyp  + '-' + tripRptFileNm;
	var paramObj = {
			"fileKey" 	: fileKey,
			"fileName" 	: tempFileName,
			"userId" 	: jwt.userId,
			"coCd" 		: $('#coCd').val(),
		};
	openThirdModal("/static/mobile/modal/attachImageView_M.html", $('body').width(), $('body').height()-40, tempFileName, paramObj, function(data) {
	});
	
	return;
	
	//file download 처리
// 	try {
// 	    var host = window.location.origin;
// 		var paramMsg = host + "/admin/cm/cm08/fileDownloadAuth2?fileKey="+fileKey+"&userId="+jwt.userId +"&coCd="+$('#coCd').val();
// 		var payload = JSON.stringify({ 
// 					url: paramMsg, 
// 					fileName: tripRptFileNm,
// 					 authorization: authorizationToken
// 		});
		
// 		if (window.fileDownloadApp && typeof window.fileDownloadApp.postMessage === 'function') {
// 			window.fileDownloadApp.postMessage(payload);
// 		    return;
// 		}
		
// 		downloadFileNm(fileKey, tripRptFileNm);
// 	 } catch (e) {
// 	    	console.error('fileDownloadApp 호출 중 오류, 다운로드로 대체합니다.', e);
// 	    	downloadFileNm(fileKey, tripRptFileNm);
// 	}
	
}


//첨부파일을 upload 하기위한 준비작업
// 메모리에 파일객체 담기
// 추가 비용항목에 해당 파일 할당하기
function upSetFileUpload(fileName, fileType, file) {
	const index = rptTripFileArr.findIndex(item => item.rptTripNo === lastPosition);
	if (index > -1) { 
		// 기존에 rptTripNo 값이 있으면 대c체
		rptTripFileArr.splice(index, 1, {
	        'rptTripNo': lastPosition,
	        'fileKey': 0,
	        'fileName': fileName,
	        'fileType': fileType,
	        'fileSize': file.size,
	        'file': file,
	        'fileDelete': 'Y'
	    });
	} else {
		// 없으면 추가
		rptTripFileArr.push({
		        'rptTripNo': lastPosition,
		        'fileKey': 0,
		        'fileName': fileName,
		        'fileType': fileType,
		        'fileSize': file.size,
		        'file': file,
		        'fileDelete': 'Y'
		});
	}
	
	let tempFileName = $('#tripTable' + lastPosition + ' #tripRptFileNm').val();
	let tempFileKey = $('#tripTable' + lastPosition + ' #fileKey').val();
	let tempUpdCheck = $('#tripTable' + lastPosition + ' #updCheck').val();
	if (tempFileName != "" && tempFileKey != 0 && tempUpdCheck == 'U') {	//수정이면서 기존 파일명이 있고 파일 등록된 번호가 있을경우만 파일 삭제대상임
		tripRptRowFileDeleteArr.push({
			fileKey 	: tempFileKey,
			fileName 	: tempFileName
			});
	}
	$('#tripTable' + lastPosition + ' #tripRptFileNm').val(fileName);
}


//플로터 앱에서 웹페이지 자바스크립트에 업로드 파일 전달하는 함수 call
function uploadFile(fileName, base64ImageData, fileObj, type) {
// 	alert('파일:' + fileName + '\nfileTrgtKey:' + fileTrgtKey);
	if (fileName) {
		var typeArr = fileName.split(".");
		var fileType = typeArr[typeArr.length-1];
		var uploadDate = new Date();
		var lastModifiedDate = new Date();
		var file = "";
		var fileData = base64ImageData;

		if (type == "image") {
			file = downloadImageFromBase64(base64ImageData, fileName, fileType, type);
			file = new File([file], fileName, { type: 'image/' + fileType , lastModified: uploadDate });
		} else {
			file = base64ToFile(base64ImageData, fileName, fileType, type);
			file = new File([file], fileName, { type: 'application/octet-stream' , lastModified: uploadDate });
		}

		file['name'] = fileName;
		file['type'] = fileType;
		file['size'] = file.size;
		file['lastModified'] = uploadDate;
		file['lastModifiedDate'] = lastModifiedDate;

		if (lastPosition == 0) { //0 작업일보 문제 첨부파일임
			notiFileArr.push({
				'fileKey' : 0,
		      	'fileName' : fileName,
		      	'fileType' : fileType,
		      	'fileSize' : file.size,
		      	'file' : file,
		      	'fileDelete': 'Y'
			});
			fileGridView.setData()
		} else {		//0이 아닌경우 해당 경비항목으로 추가된 첨부화일임 (경비 1건에 첨부 1개만 가능함)
			upSetFileUpload(fileName, fileType, file);

		}
	}
}




//웹 자바스크립트에서 플로터 앱함수 fileDownloadApp call
//플러터앱에서 다운로드 하기
function downloadFile(idx) {
	var fileKey = notiFileArr[idx].fileKey;
	if(fileKey == 0 || fileKey == '' || fileKey == null) {
		return false;
	}
    var host = window.location.origin;
	var paramMsg = host + "/admin/cm/cm08/fileDownloadAuth2?fileKey="+fileKey+"&userId="+jwt.userId+"&coCd="+$('#coCd').val() +"," + notiFileArr[idx].fileName;
	fileDownloadApp.postMessage(paramMsg);
}



function downloadFileNm(_fileKey, _filename) {
	return new Promise(function(resolve, reject) {
		var xhr = new XMLHttpRequest();
		xhr.open("GET", "/admin/cm/cm08/fileDownloadAuth2?fileKey=" + _fileKey + "&userId=" + jwt.userId + "&coCd="+$('#coCd').val(), true);
		xhr.responseType = "blob";
		xhr.setRequestHeader("Authorization", authorizationToken);
		xhr.setRequestHeader("X-GBS-Source", "pdfjs-viewer");
		
		xhr.onload = function() {
			if (xhr.status === 200) {
				var contentType = xhr.getResponseHeader("Content-Type");
				// 오류 상황: Content-Type이 text/plain이면 서버가 오류 메시지를 반환한 것으로 간주
				if (contentType && contentType.indexOf("text/plain") !== -1) {
					var reader = new FileReader();
					reader.onload = function(e) {
						// reject 시, 파일명과 함께 오류 메시지 전달
						reject("[" + _filename + "] " + e.target.result);
					};
					reader.readAsText(xhr.response);
				} else {
					// 정상적인 파일이면 다운로드 진행
					var blob = xhr.response;
					var url = window.URL.createObjectURL(blob);
					var a = document.createElement('a');
					a.href = url;
					a.download = _filename;
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);
					resolve(); // 성공 시 resolve 호출
				}
			} else {
				console.error("백엔드 오류 발생: " + xhr.status + " - " + xhr.statusText);
				reject("[" + _filename + "] 백엔드 오류 발생: " + xhr.status + " - " + xhr.statusText);
			}
		};

		xhr.onerror = function() {
			console.error("네트워크 오류가 발생했습니다.");
			reject("[" + _filename + "] 네트워크 오류가 발생했습니다.");
		};

		xhr.send();
	});
}


// KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
    let param = {
            "tmplatDiv": "TMPLATDIV04"
            , "coCd": $("#popForm #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": "" //"TODODIV10"                 //공통코드 해당업무 - 결재
            , "todoDiv2CodeId": "" // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv1CodeNm": "" // "WBS문제"                        //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv2CodeNm": "" // "WBS계획문제"                       //공통코드 해당업무 - 결재 - 발주서
            , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $("#popForm #workRptNo").val()
            , "clntCd": "1"                 //발신회사는 로그인사용자 회사
            , "clntNm": ""             //로그의 수신거래처명
            , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
            , "ordrgMngTelNo": $("#popForm #telNo").val()       //담당자전화번호
            , "creatPgm": "PM0101P01_M"
            , "userId": jwt.userId
            , "todoTitle": $("#popForm #issueTitle").val() // 문제 제목
            , "text": $("#popForm #workRptRmk").val() // 비고
    }
    commKaKaoSendTodo(param);
}

function kakaoTodo() {

    //message load
    if (kakaoErr.length == 0) {
        var paramObj = {
            "userId" : jwt.userId
            , "codeKind" : "KAKAOMSG"
        };
        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
            if(data.resultList.length > 0 ) {
                kakaoErr = data.resultList;
            }
        });
    }

   let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

   kakaoSendBody('','', '작업일보','작업일보 문제','공유');

   if (kakaoCnt > 0) {
       kakaoCnt = 0;
     //alert("알림톡이 정상 발송되었습니다.");
   }
}

//to-do결재요청 알림톡
function commKaKaoSendTodo(param) {
//    console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

   //알림톡수신번호 채번
   var maxMessageId = null;            //message id(unique key)
   var talkMessage = null              //발송될 내용 template
   var mobile = null                   //수신인 휴대전화번호
   var title = null                    //todo title
   var sendList = [];
   let talkParam = {};
   let talkBody = {};
   let sendCnt = 0;
   postAjaxSync("/user/bm/bm18/selectPmMaxMessageIdTodo", param, null
               , function(data) {
                   if(data.resultList.length > 0 ) {
                       if( data.resultList[0].maxMessageId != "" ) {
                           sendList = data.resultList;
                       } else {
                           alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                           return;
                       }

                   }
   });
   //user search ajax end

   //대상 loop
   $.each(sendList, function (key, sendObj) {
       maxMessageId = sendObj.maxMessageId;
       talkMessage = sendObj.messageDesc;
       mobile =  sendObj.telNo;
       //로그용
       param.rcvId = sendObj.todoId;           //todo 수신id
       param.rcvNm = sendObj.name;             //todo 수신자명
       param.name = sendObj.name;                //todo 수신자명

       // 알림톡 Title 자리수 제한 문자열 자르기
       if (sendObj.todoTitl.length > 30) {
           title = sendObj.todoTitl.substring(0,25);
       }
       else {
           title = sendObj.todoTitl;
       }

       param.title = title; //요청내용제목
       //------------------------

       param.sendDt = sendObj.sendDt;

       // 비고란 문자열 자리수 자르기 30자
       var strText = null;
       if (param.text.length > 50) {
           strText = param.text.substring(0, 50);
       }
       else {
           strText = param.text;
       }
       param.text = strText;
       //------------------------



       if(mobile == "" || mobile == null) {
           alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
           return;
       }
       if(talkMessage == "" || talkMessage == null) {
           alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
           return;
       }

       //message 치환
       let message = talkMessage;
       let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
       //loop
       $.each(splitStr, function (key, val) {
           let compKey = val.substring(1, val.length-1);
           if( compKey != "" && compKey != "undefined" ) {
               if( typeof(param[compKey]) != "undefined" ) {
                   let val2 = '#'+val;
                   message = message.replaceAll(val2, param[compKey]);
               }
           }
       });
       talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
       talkParam.serverName = "gyitt2400";
       talkParam.paymentType = "P";
       talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
       talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값);
		if (title.length > 50) {
			title = title.substring(0, 49); // 50자까지만 자르기
		}
       talkBody.title = title;                 //알림톡 타이틀 -
       talkBody.message = message;             //알림톡 메시지 (1000 byte)
       talkBody.mobile = mobile;               //휴대전화번호
       talkBody.template = "10008";            //템플릿관리화면 템플릿ID - 발주서 V2
       let talkJson = JSON.stringify(talkBody);
       sendCnt = kakaoSendReal(talkJson, talkParam, param);
   });
   //대상 loop end
   if( sendCnt > 0 ) {
       //alert("알림톡 정상 발송되었습니다.");
       kakaoCnt++;
   }

   //한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄
  /*  talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
   talkBody.mobile = "01063893764"
   talkJson = JSON.stringify(talkBody); */
   //kakaoSendReal(talkJson, talkParam, param);
}


function pasFloatChk (ivalue) {
	let value = ivalue +' ';
	const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다.
	return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
}

// 작업일보고찰이 등록되어 있는 작업일보는 등록, 수정 방지
function monthWorkReportChk() {
	var isRegistered = false;
	var paramObj = {
		// "userId": $('#workRptId').val(),
		"userId": jwt.userId,
		"workRptDt": $('#workRptDt').val()
	};

	postAjaxSync("/user/pm/pm40/monthWorkReportChk", paramObj, null, function(data) {
		if (data.result > 0) {
			alert('작업일보 고찰이 이미 등록되어 있습니다.');
			$('#actionBtn').hide();
			isRegistered = true;
		} else {
			$('#actionBtn').show();
		}
	});

	return isRegistered;
}


</script>

</body>

</html>