<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">    
	<meta name="viewport" content="width=device-width, initial-scale=1, mimum-scale=1">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
    <link rel="stylesheet" href="/static/css/gnb.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/sub.css" />
    <link rel="stylesheet" href="/static/css/common.css" />
	<link rel="stylesheet" href="/static/css/mobile.css" />

    <script src="/static/js/jquery-latest.min.js"></script>
    <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/global.js"></script>
    <style>
        /* .myText { */
        /*   text-align: left; */
        /*   font-size: 15px; */
        /*   font-weight: bold; */
        /* }   */
        tr {
          height: 40px;
        }
        </style>    
</head>

<body>
    <div id="head_area" class="off" >
        <div class="left_btn" onclick="history.back(-1)">
              <a class="back_btn"></a>
        </div>
        <h1 class="logo">
              <img src="/static/img/Logo_gunyangitt.gif" alt="건양ITT" /> 
        </h1>	
    </div>
    
    
    
<div id="main_area">
    <div class="popup_area" style="width: 100%; height: 100%;">
        <div class="tit_contents">
            <h4 class="tit">작업일보 등록</h4>
        </div>

        <form id="popForm" onSubmit="return false;">
            <input type="hidden" id="workRptNo" name="workRptNo">
            <input type="hidden" id="workRptIdNm" name="workRptIdNm">
			<input type="hidden" id="coCd" name="coCd" required msg="회사">
            <div class="form-group popup_table" style="width: 100%;">
                <table>

                    <colgroup>
                    <col width="30%">
                    <col width="70%">
                    </colgroup>

                    <tr>
                        <th class="hit" >작성일자</th>
                        <td>
                            <input id="workRptDt" name="workRptDt" class="input_calendar form-control" autocomplete="off" onkeyup="dateMask(this);" inputmode="numeric"  required msg="작성일자" date>
                        </td>
                    </tr>
                    <tr>  
                        <th class="hit">업무분류</th>
                        <td>
                                <input class="division" type="hidden" id="workRptL" name="workRptL" data-depth="0" onchange="selectCodeList(this,0);" required msg="작업대분류" >	
                                <select class="division" id="workRptM" name="workRptM" onchange="selectCodeList(this,1);" data-depth="1" class="form-control" required msg="작업중분류">
                                </select>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit">업무구분</th>
                        <td>
                            <select class="division" id="workRptS" name="workRptS" onchange="selectSalesCodeSet();" data-depth="2" required class="form-control" msg="작업소분류">
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit">작업시간</th>
                        <td>
							<input type="text" class="form-control" id="workRptHour" name="workRptHour" maxlength="10" required="required" class="form-control" required msg="작업시간"
							oninput="this.value=setWorkRptHour(this.value)" onblur="this.value=setWorkRptHour2(this.value)">
						</td>
                    </tr>
                    <tr>
                        <th>비고</th>
                        <td>
                            <textarea rows="2" id="workRptRmk" name="workRptRmk" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="hit Sales_Code">Sales Code</th>
                        <td>
                            <div class="search_form">
                                <input type="text" id="salesCd" name="salesCd" required class="form-control" msg="Sales Code" >
                                <a id="salesTarget" onclick="wbsSalesCodeSearch();"><i class="i_search_w"></i></a>
                            </div>
                        </td>
                    </tr>
                    <tr>
						<th>수주번호</th>
						<td>
							<div class="search_form">
								<input type="text" class="form-control" id="ordrsNo" name="ordrsNo"  onchange="clearSalesCodeField();"  msg="수주번호">
								<a id="salesTarget" onclick="opendOrdrsSearch($('#ordrsNo').val(), $('#coCd').val());"><i class="i_search_w"></i></a>
							</div>
						</td>
                    </tr>
                    <tr>
                        <th>고객사</th>
                        <td>
			            	<input type="hidden" id="clntCd" name="clntCd" msg="고객사">
				            <div class="search_form">
				              <input type="text" id="clntNm" name="clntNm" class="form-control">
				              <a onclick="clntSearch();"><i class="i_search_w"></i>
				              </a>
				            </div>
                        </td>
                    </tr>   
                    <tr>
                        <th>고객사PJT</th>
                        <td>
							<select id="clntPjt" name="clntPjt" data-kind="PRJCTCD" data-search="clntPjt" class="form-control" msg="고객사PJT">
								<option value=""></option>
            				</select> 
                        </td>
                    </tr>
                    <tr> 
						<th>제품유형</th>
								<input type="text" id="prdtCd" name="prdtCd" data-search="prdtCd" class="form-control" style="text-align: center;" readonly>
						<td colspan= "1">
					   		<div class="search_form">
					    	  	<input type="text" id="prdtCdNm" name="prdtCdNm" data-search="prdtNm" class="form-control" onkeyup="event.keyCode == 8 ? prdtId_S.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''" >
						    	<a onclick="openPrdtSearch();"><i class="i_search_w"></i></a>
							</div>
						</td>
                    </tr>
                    <tr>
						<th>아이템구분</th>
						<td>
							<select id="itemDiv" name="itemDiv" data-kind="ITEMLIST" data-search="itemDiv" class="form-control" msg="아이템구분">
								<option value=""></option>
	            			</select>
						</td>
                    </tr>
                    <tr>   
                        <th>설비명</th>
                        <td>
                            <input type="text" id="eqpNm" name="eqpNm" class="form-control" msg="설비명">
                        </td>
                    </tr>
                    
                </table>
            </div>
        </form>
    </div>

    <!-- 하단 버튼 -->
    <div class ="popup_bottom_btn" style="text-align: center;">
        <button type="button" style="height: 40px;  width: 90px;"id="actionBtn" authChk>등록</button>
        <button type="button" class="close_btn" style="height: 40px;  width: 90px;" onclick="window.history.back();">닫기</button>
    </div>
</div>



<script type="text/javascript">
var actionType = null;
var fileTrgtKey = null;

$(document).ready(function() {

    //작성일자//
    $('#workRptDt').datepicker({
        format : "yyyy-mm-dd",
        language : "ko",
        autoclose : true
    }).datepicker("setDate", new Date());

    //세션에 정보를 활용하여 승인처리
    var paramObj = JSON.parse(sessionStorage.getItem('paramObj'));
    sessionStorage.removeItem('paramObj');
    if (paramObj && paramObj != "undefined") {


    	$("#popForm #coCd").val(jwt.coCd);
        actionType = paramObj.actionType;
        fileTrgtKey = paramObj.fileTrgtKey;    


		setCommonSelect($(".popup_area select[data-kind]"));
		setWorkPtDept();//자동분류 자동선택
        
//         $("#clntNm").prop("readonly", true);
//         $("#clntPjtNm").prop("readonly", true);
//         $("#prdtCdNm").prop("readonly", true);
//         $("#itemDivNm").prop("readonly", true);
//         $("#eqpNm").prop("readonly", true);
        
        if (actionType == "C") {
            $("#actionBtn").text("등록");
            $('#actionBtn').on("click", function() {
                insertDailyWork();
            });

        } else if (actionType == "U") {
            $('.tit').text('작업일보 수정')
            
            selectDailyWorkInfo();

            $('#actionBtn').text("수정");
            $('#actionBtn').on("click", function() {
                updateDailyWork();
            });
        }
        //authChk();   // 권한체크
        
    
    } else {
        window.history.back();
    }

});


//세션의 부서코드로 작업 대분류/중분류/소분류 자동셋팅
function setWorkPtDept() {
    //$("#deptId").val("GUN70");//임시 GUN1010, GUN6010, TRN1099
    var deptId = jwt.deptId;
    if (deptId) {
    	$("#workRptL").val(deptId.substring(0,5));
	    selectCodeList($("#workRptL"),0);
	    selectCodeList($("#workRptM"),1);
    }
}    

//작업 대분류/중분류/소분류
function selectCodeList(obj,idx) {
    var codeKind = $(obj).val();
    var target = $(obj).next('select.division');
    if(idx == 0){
        target = $("#workRptM");
        $('#workRptM option[value!=""]').remove();
        $('#workRptS option[value!=""]').remove();
    }else{
        target = $("#workRptS");
        $('#workRptS option[value!=""]').remove();
    }    
    
    var paramObj = {"codeKind": codeKind};
    postAjaxSync("/admin/cm/cm05/selectChildCodeList", paramObj, null, function(data){
        var optionHtml = '';
        var childCodeList = data.childCodeList;
        $.each(childCodeList, function(index, item){
            //data-etc = 'Y' 이면 saledCode 필수 'N' 이면 옵션으로 설정
            optionHtml += '<option value="'+item.codeId+'" data-rprc="'+item.codeRprc+'" data-etc="'+item.codeEtc+'"">';
            optionHtml += item.codeNm;
            optionHtml += '</option>';
        });
        $(target).append(optionHtml);
        

        selectSalesCodeSet();
    });
}

//Sales Code 필수 변경
function selectSalesCodeSet() {
    if ($('#workRptS').find('option:selected').data('etc') === 'Y') {
        $('#popForm .Sales_Code').addClass('hit');
        $('#popForm input#salesCd').attr('required');
        $("#salesTarget").attr("onclick", "wbsSalesCodeSearch();").removeClass("disabled");
    } else {
        $('#popForm .Sales_Code').removeClass('hit');
        $('#popForm input#salesCd').removeAttr('required');
//         $("#salesTarget").removeAttr("onclick").addClass("disabled");

    }
}       

function selectDailyWorkInfo() {                        //그리드에 뿌리는 데이터
    var formData = {
        "fileTrgtKey" : fileTrgtKey,
    }
    postAjax("/user/pm/pm01/selectDailyWorkInfo", formData, null, function(data) {
			var resultData = data.result;
            $.each(resultData, function(key, value) {
                if ($('#popForm #' + key)[0]) {
                    $('#popForm #' + key).val(value);
                    if ($('#popForm #' + key).is('[comma]')) {
                        onlyNumber($('#popForm #' + key)[0]);
                    }
                }
            });
			//상위코드 연동으로 바뀌기 전에 저장값 설정되므로 재설정 필요함
       	    selectCodeList($("#workRptL"),0);
			$('#popForm #workRptM').val(data.result.workRptM);
    	    selectCodeList($("#workRptM"),1);
    	 	$('#popForm #workRptS').val(data.result.workRptS);
    });
}

 // 등록
function insertDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {
        var formData = makeFormData();
        filePostAjax("/user/pm/pm01/insertDailyWork", formData,
                function(data) {
                    if (data.resultCode == 200) {
                        window.history.back();
                    }
                });
    }
}

// 수정
function updateDailyWork() {
    if (inputValidation($('.popup_area [required]'))) {
        var formData = makeFormData();
        filePostAjax("/user/pm/pm01/updateDailyWork", formData,function(data) {
                    if (data.resultCode == 200) {
                        window.history.back();
                    }
                });
    }
}

function makeFormData() {
    // 날짜 하이픈 제거
    $.each($('.popup_area input[date]'), function(idx, elem) {
        deleteHyphen(elem);
    });
    
//     if ($('#workRptS').find('option:selected').data('etc') === 'N') {
//     	$('#salesCd').val("");
//         $("#clntNm").val("");
//         $("#clntPjtNm").val("");
//         $("#prdtCdNm").val("");
//         $("#itemDivNm").val("");
//         $("#eqpNm").val("");
//     }
    // 폼데이터 생성
    var formData = new FormData($("#popForm")[0]);
    //---------------------------------------------------------------  
    //  disabled 처리시 값 전송안됨 아래에서 폼데이터 추가
    //---------------------------------------------------------------
    formData.append("coCd", jwt.coCd);
    formData.append("workRptId", jwt.userId);
    formData.append("workRptNo", $('#workRptNo').val());
    formData.append("workRptDt", $('#workRptDt').val());
    formData.append("fileTrgtKey", fileTrgtKey);
    formData.append("userId", jwt.userId);
    formData.append("pgmId", "PM0101M01_M");
    
    var fileUploadArr = [];
    formData.append("uploadFileArr", JSON.stringify(fileUploadArr));
    formData.append("deleteFileArr", JSON.stringify(fileUploadArr));

    return formData;
}

//Sales Code 검색
function wbsSalesCodeSearch() {
    var paramObj = {
       "coCd" : $('#coCd_S').val(),
       "salesCd": $('#salesCd').val()
    };
    openSecondModal("/static/mobile/modal/wbsSalesCodeSearch_M.html", 350, 330, "SALES CODE 검색", paramObj, function (grid){
        var row = grid.target.getList("selected")[0];
        $('#ordrsNo').val(row.ordrsNo);
        $('#salesCd').val(row.salesCd);
        $('#clntPjt').val(row.clntPjt);
        $('#clntPjtNm').val(row.clntPjtNm);
        $('#clntCd').val(row.ordrsClntCd);
        $('#clntNm').val(row.ordrsClntNm);
        $('#prdtCd').val(row.prdtCd);
		$('#prdtCdNm').val(row.prdtCdNm);
        $('#itemDiv').val(row.itemDiv);
        $('#itemDivNm').val(row.itemDivNm);
        $('#eqpNm').val(row.eqpNm);
    });
}
        

function setWorkRptHour(_value) {
	var value = _value.replace(/[^0-9.]/g, "");
//		value = value.toLocaleString();
	if(value != "" && value > 24) {
		alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
		return 24;
	}
	return value;
}

//작업시간 포커스를 빠져나갈때 실행됨
function setWorkRptHour2(_value) {
	var value = parseFloat(_value.replace(/[^0-9.]/g, "")).toFixed(2);
	value = value.toLocaleString();
	value = value == 'NaN' ? 0 : value;
	if(value != "" && value > 24) {
		alert("작업시간을 24시간 이상 입력 할 수 없습니다.");
		return 24;
	}		
	if(value == 0) {
		return "";
	}
	return value;
}


//  업체명 검색 //
function clntSearch() {
	var paramObj = {
			"clntDivCd": "CLNTDIV12",
			"searchType": "CLNT_NM",
			"searchValue": $('#clntNm').val(),
		};
	openSecondModal("/static/mobile/modal/clntSearch_M.html", 330, 460, "업체명 검색", paramObj, function(grid) {
				var row = grid.target.getList("selected")[0];
//					$('#prjctSeq').val(row.prjctSeq);
				$('#clntCd').val(row.clntCd);
				$('#clntNm').val(row.clntNm);
				$('#mngId').val(row.salesEmpId);
				$('#mngNm').val(row.salesEmpNm);

				var paramObj = {
					"coCd" : $('#coCd').val(),
					"clntCd" : row.clntCd
				}
//					setMngInfo(paramObj);
			});
}	

//수주번호 검색
function opendOrdrsSearch(inputValue, coCd) {
    var paramObj = {
        "searchValue" : inputValue,
        "coCd" : coCd
    };
	openSecondModal("/static/mobile/modal/ordrsSearch_M.html", 330, 830, "수주번호 검색", paramObj, function (grid) {
        var row = grid.target.getList("selected")[0];
        $('#ordrsNo').val(row.ordrsNo);
        $('#clntPjt').val(row.clntPjt);
        $('#clntPjtNm').val(row.clntPjtNm);
        $('#clntCd').val(row.clntCd);
        $('#clntNm').val(row.clntNm);
        $('#ctrtNm').val(row.ctrtNm);
    });
}	


//제품코드 검색
function openPrdtSearch(){
	var paramObj = {
			"coCd": $('#coCd').val(),
			"prdtCd": $('#prdtCd').val(),
			"prdtNm": $('#prdtCdNm').val(),
			"useYn" : "Y"
	}
	openSecondModal("/static/mobile/modal/prdtSearch_M.html", 330, 830, "제품 검색", paramObj, function (grid) {
		var row = grid.target.getList("selected")[0];
		$("#prdtCd").val(row.prdtCd);
		$("#prdtCdNm").val(row.prdtNm);
	});
}


</script>

</body>

</html>