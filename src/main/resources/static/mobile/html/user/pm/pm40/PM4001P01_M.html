<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
    <link rel="stylesheet" href="/static/css/gnb.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/sub.css" />
    <link rel="stylesheet" href="/static/css/common.css" />
	<link rel="stylesheet" href="/static/css/mobile.css" />

    <script src="/static/js/jquery-latest.min.js"></script>
    <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/global.js"></script>
    <style>
        tr {
          height: 26px;
        }
		#main_area{
		    padding: 0px 0px;
		    overflow: auto;
	    }
    </style>
</head>

<body>
    <div id="head_area" class="off" >
        <div class="left_btn" onclick="history.back(-1)">
              <a class="back_btn"></a>
        </div>
        <h1 class="logo">
              <img src="/static/img/Logo_gunyangitt.gif" alt="건양ITT" />
        </h1>
    </div>



<div id="main_area">
    <div class="popup_area">
        <div class="tit_contents">
            <h4 class="tit">작업일보 고찰 등록</h4>
        </div>
			<input type="file" id="notiFile" style="display:none" multiple="multiple" onchange="setNotiFile(this);"/>
	<form id="popForm" onSubmit="return false;">
			<input type="hidden" id="fileTrgtKey"  	name="fileTrgtKey">
			<input type="hidden" id="pgmId"     	name="pgmId" value="PM4001M01_M">
			 <input type="hidden"  id="ordrgId" name="ordrgId" >
			 <input type="hidden"  id="ordrgNm" name="ordrgNm" >
			<input type="hidden" id="deptId"     	name="deptId">
			<input type="hidden" id="deptCd"     	name="deptCd">
			<input type="hidden" id="ordCoCd"     	name="ordCoCd" msg="오더도는 salesCode용 회사코드">
			<input type="hidden" id="coCd" name="coCd" required msg="회사">
			<input type="hidden" id="writeYm"   name="writeYm"> 
			<input type="hidden" id="workNo"   name="workNo"> 
            <div class="form-group popup_table" style="width: 100%;">
                <table>

                    <colgroup>
                    <col width="28%">
                    <col width="72%">
                    </colgroup>

                    <tr>
                    <th id="workYm" colspan="1">
                    
                    </th>
                    <td id="create_td">
                    <div class="date_input">
                                <input id="cWorkYm" name="cWorkYm" class="input_calendar" autocomplete="off" onkeyup="dateMask(this);">
                     </div>
              		</td>      
                    
                    </tr>
                    <tr>
                        <th>잘된점</th>
                        <td>
                            <textarea rows="3" id="workGoodTxt" name="workGoodTxt" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th>아쉬운점</th>
                        <td>
                            <textarea rows="3" id="workBadTxt" name="workBadTxt" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr>
                     <tr>
                        <th>개선할점</th>
                        <td>
                            <textarea rows="3" id="workNeedTxt" name="workNeedTxt" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr> <tr>
                        <th>건의사항</th>
                        <td>
                            <textarea rows="3" id="workProposalTxt" name="workProposalTxt" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr> <tr>
                        <th>비고</th>
                        <td>
                            <textarea rows="3" id="workRmk" name="workRmk" class="form-control"  msg="비고"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
           
        </form>
	
    </div>
    
    <div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 700px; width: 100%; font-size:16px;"></div>
    <!-- table>
    <td colspan= 5>
	          공유대상자
	          <div class="popup_table" id="approval_trgt">
	              <table style="border: 0px;">
	                  <tr style="height:30px;">
	                    <td style="text-align: LEFT; border-right: 0px;;font-size:13px;font-weight:bold;">※ 공유 및 결재</td>
	                    <td colspan="3">
	                       <div class="add_btn_small pdl10" id="plus-minus">
	                         <a onclick="insertShareUserModal();" style="height: 30px; line-height: 28px;" authchk>+</a>
	                         <a onclick="deleteShareUser();" style="height: 30px; line-height: 28px;" authchk>-</a>
	                     </div>
	                    </td>
	                  </tr>
	                 <tr>
	                    <td colspan="4">
	                     <div>
	                   		<div class="ax5_grid" data-ax5grid="third-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div>
	                  	 </div>
	                 	</td>
	              	 </tr>
	              </table>
	          </div>
          </td>
    </table> -->
    
    
    <!-- 하단 버튼 -->
    <div class ="mobile_mid_btn">
        <button type="button" style="height: 35px;  width: 90px;"id="actionBtn" authChk>등록</button>
        <button type="button" class="close_btn" style="height: 35px;  width: 90px;" onclick="window.history.back();">닫기</button>
    </div>
</div>



<script type="text/javascript">
	var actionType = null;
	var fileTrgtKey = null;
	var paramObj = null;
	var fileParam = null;
    var windowWidth = $(window).width();
    var windowHeight = $(window).height();

    // 카톡 정상알림 카운터 변수
    var kakaoCnt = 0;
    var kakaoErr = [];

	// 결재&공유 
	/* var gridViewPop = {
		      initView : function() {
		    	  
		    	  
		           this.target = new ax5.ui.grid();
		           this.target.setConfig({
		               showRowSelector: true,
		               multipleSelect: false,
		               sortable: false,
		                target: $('[data-ax5grid="third-grid-modal"]'),
		                header: {
		                   align: "center",
		                   selector: true
		                },
		                body: {
		                    onClick: function () {
		                        this.self.select(this.dindex);
		                    },
		                    onDBLClick: function () {
		                    },
		               mergeCells : ["gb"],
		                },
		            page : {
		               navigationItemCount : 10,
		               height : 30,
		               display : true,
		               firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		               prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		               nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		               lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		               onChange : function() {
		                  gridView2.setData(this.page.selectPage);
		               }
		            },
		             columns : [
		                   {key: "gb",               label: "구분",         align: "center",   width: 40},
		                    {key: "sanctnSn",          label: "순번",       align: "center",   width: 50},
		                    {key: "coCd",               label: "coCd",      align: "center",   width: 50, hidden: true},
		                       {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
		                       //{key: "wbsSharngUserId",   label: "ID",         align: "center",   width: 130, hidden: false},
		                       {key: "usrNm",            label: "ID",         align: "center",   width: 130, hidden: true},
		                       {key: "empNo",            label: "사원번호",    align: "center",   width: 130, hidden: true},
		                       {key: "name",             label: "성명",         align: "center",   width: 80},
		                       {key: "jik",                label: "직위",         align: "center",   width: 60},
		                       {key: "creatDttm",         label: "요청일자",    align: "center",   width: 90},
		                       {key: "todoCfDt",            label: "확인일자",      align: "center",   width: 130},
		                       {key: "todoCfOpn",         label: "확인의견",    align: "left",     width: 200},
//		                        {key: "telNo",            label: "H.P",      align: "center",   width: 130},
		                       {key: "todoKey",            label: "todoKey",      align: "center",   width: 130, hidden: true},
		                       {key: "sanctnSttus",         label: "sanctnSttus",      align: "center",   width: 130, hidden: true},
		                       {key: "todoId",            label: "todoId",      align: "center",   width: 130, hidden: true},
		                       {key: "flag",               label: "flag",      align: "center",   width: 130, hidden: true}
		                     ]
		               });
		                 return this;
		              },
						
		              setData : function(_pageNo) {
		                 var targetObj = this.target;
		                 var formData = {
		                         "fileTrgtKey" : "",
		                         "reqNo" : $("#workNo").val(),
		                         "pageNo" : _pageNo + 1
		                  }

		                  postAjax("/user/pm/pm40/selectSignResUserlst", formData, null, function(data){
		                     var list = data.result;
		                     //targetObj.setData({
		                     gridViewPop.target.setData({
		                          list : list,
		                          page : {
		                                   totalElements : list.length
		                      }
		                       });
		                     gridResize1()
		                     $.each(list, function(idx, elem){
		                           if(elem.sanctnSn == 1 && elem.gb == "결재") {
		                              $('#reportRegBtn').show();
		                           }
		                     });
		                    });
		                },

		              setData2 : function(_list) {
		                 this.target.setData({
		                          list : _list,
		                          page : {
		                                   totalElements :  _list.length,
		                      }
		                       });
		                 gridResize1();
		                }
		                ,
		              setData3 : function(_pageNo) {
		                 var targetObj = this.target;
		                 var paramObj = { "userId": $("#ordrgId").val()
		                             , "appDiv": 'APPDIV02'
		                 };
		                  postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
		                  var list = data.result;
		                     targetObj.setData({
		                          list : list,
		                          page : { totalElements : list.length }
		                       });
		                    });
		                  gridResize1();
		                }
		     } */
	
	var gridView = {
		    initView : function() {
		            this.target = new ax5.ui.grid();
		            this.target.setConfig({
		                showRowSelector: false,
		                multipleSelect: false,
		                sortable: false,
		                target: $('[data-ax5grid="first-grid"]'),
		                header: {
		                    align: "center",
		                    selector: false,
		                    columnHeight: 40,
		                },
		                body: {
		                    columnHeight:40,
		                    mergeCells : ["codeDiv", "codeKind", "codeDesc", "codeNm"],
		                     onClick: function () {
		                        this.self.select(this.dindex);                  
		                    },
		                    onDBLClick: function () {
		                       // insertDailyWorkModal("U");      
		                    },
				            grouping: {
				            	by: ["codeDesc" ],
			                    columns: [
			                    	{
			                            label: function () {
			                                return this.groupBy.labels.join(", ") + " 소계";
			                            }, colspan: 2, align: "center"
			                        },
			                        {key: "totHours", collector: "sum", formatter: "money", align: "center"},
			                        {key: "totPct", collector: "sum", formatter: "money", align: "center"},
			                    ]
			                }		
		                },

		            page : {
		                display : false,
		            },
		            columns : [
		            	 {key: "codeDiv",	    label: "부서구분",			width: 70,		align: "center" , hidden: true}
							,{key: "codeDesc",	    label: "업무분류",			width: 70,		align: "center"}
							,{key: "codeNm",		label: "업무일지", 	    width: 250,		align: "left"}
							,{key: "totHours",		label: "시간", 	    	width: 90,		align: "right"}
							,{key: "totPct",		label: "백분율", 	    	width: 90,		align: "right"}
		                ],
					}).setColumnSort({
					      "workRptDt": {orderBy: "desc", seq: 0},
					      "workRptMNm": {orderBy: "asc", seq: 1}
					});
		             return this;
		        },

		    setData : function() {
		        var targetObj = this.target;
		        var resDay = $('#writeYm').val().replace('-',''); //사용자가 등록하려는 년월
		        var formData = {
		            "coCd"          : jwt.coCd,
		            "userId"     : jwt.userId,
		            "workYm"     : resDay,
		            "sortType"      : "DATE",	
		            "prdtCd" : "",
		            "recordCnt" 	: 9999999	
		        }
		        
		        postAjax("/user/pm/pm40/selectYearWorkMainList", formData, null, function(data){
		         	var list = data.result;
		         	if (list) {
			            targetObj.setData({
			                    list : list,
			                    page : {
			                        totalElements : list.length
			                    }
			                });
		         	}
				});
			}
		}
	function gridHeightSet() {
		const grdiHeight = $(window).height()-800;
		gridView.target.setHeight(grdiHeight< 400 ? 400 : grdiHeight);
	}
	
	
$(document).ready(function() {

	
	$("#popForm #ordrgId").val(jwt.userId);
	$("#popForm #ordrgNm").val(jwt.userNm);
	$("#popForm #deptCd").val(jwt.deptId);
	
    // 년월 select 세팅
	SetYm();
    gridView.initView().setData(0);
    gridHeightSet()
    //authChk();
	
 //   gridViewPop.initView();
    
	$("body").css("font-size", "12px");
    $("body").css("zoom", "100%");

	var newScreenWidth = $(window).width();
	var newScreenHeight = $(window).height();
	$('.popup_area').css('min-width', (newScreenWidth-15) + 'px');

    //작성일자//
    $('#workRptDt').datepicker({
        format : "yyyy-mm-dd",
        language : "ko",
        autoclose : true
    }).datepicker("setDate", new Date());

	const now = moment().startOf("month");
	var beDay = now.add(-2, "M").format("YYYY-MM-DD");	
    $('#cWorkYm').datepicker({
			format : "yyyy-mm",
			minViewMode: 1,
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", new Date())
		.on("changeDate", function(){
			$('#writeYm').val( $('#cWorkYm').val());
  			gridView.setData(0);
		});
    $('.popup_area').css('min-width', (newScreenWidth-15) + 'px');
    //세션에 정보를 활용하여 승인처리
    paramObj = JSON.parse(sessionStorage.getItem('paramObj'));
    sessionStorage.removeItem('paramObj');
    if (paramObj && paramObj != "undefined") {


    	$("#popForm #coCd").val(jwt.coCd);
        actionType = paramObj.actionType;
        fileTrgtKey = paramObj.fileTrgtKey;
		$("#fileTrgtKey").val(fileTrgtKey);

		setCommonSelect($(".popup_area select[data-kind]"));
		//setWorkPtDept();//자동분류 자동선택

        if (actionType == "C") {
            $("#actionBtn").text("등록");

          //modal 넘어온값만큼 만큼 루프
			$.each(paramObj, function (key, val) {
				//입고정보 SET
				if( $("#popForm").find("#"+key).length > 0 ) {
					$("#popForm").find("#"+key).val(val);
				}
				if (key == 'workGoodTxt'){//빈값 세팅
					selectCodeList($("#workGoodTxt"),1);
				}
				if (key == 'workBadTxt'){//작업시간 빈값 세팅
					$("#workBadTxt").val("");
				}
				if (key == 'workNeedTxt'){//비고 빈값 세팅
					$("#workNeedTxt").val("");
				}
				if (key == 'workProposalTxt'){//비고 빈값 세팅
					$("#workProposalTxt").val("");
				}if (key == 'workRmk'){//비고 빈값 세팅
					$("#workRmk").val("");
				}
			});
			 $('#workYm').text('고찰년월');
            $('#actionBtn').on("click", function() {
                insert_pm40();
            });

        } else if (actionType == "U") {
            $('.tit').text('작업일보 수정')

            select_pm40_Info();
         	// 1. <th> 태그의 colspan 속성 변경
            $('#workYm').attr('colspan', '2');

            // 2. <td> 태그를 숨김 처리
            $('#create_td').css('display', 'none');
           
          //modal 넘어온값만큼 만큼 루프
			$.each(paramObj, function (key, val) {
				//입고정보 SET
				if( $("#popForm").find("#"+key).length > 0 ) {
					$("#popForm").find("#"+key).val(val);
				}
				
				
				
				
				if (key == 'workYm'){//소분류 select 코드 세팅
					
					$('#writeYm').val(val);
					  $('#workYm').text(val.substring(0, 4)+"-"+val.substring(4, 6));
				}
				
			});
            
            gridView.setData(0);
            
            
            $('#actionBtn').text("수정");
            $('#actionBtn').on("click", function() {
                update_pm40();
            });
        }

        // Kakao 알림톡 보내는사람(userID) 연락처 조회 값 세팅
        var paramObj1 = {
                "coCd" : $("#popForm #coCd").val(),
                "userId" : jwt.userId
            };
         postAjaxSync("/user/wb/wb24/selectMemberTelNo", paramObj1, null, function(data){
             if (data.result[0] == undefined
                   || data.result[0].telNo == "") {
                 $("#popForm #telNo").val("051-312-2400");
             }
             else {
                 $("#popForm #telNo").val(data.result[0].telNo);
             }
         });

        //authChk();   // 권한체크



    } else {
        window.history.back();
    }

});



function chechChange(elm) {
	elm.value = addCommaStr(gPasFloatChk(elm.value));
}


//입력정보
function select_pm40_Info() {
	var formData = {
		"workNo" : paramObj.workNo,
	}
	
	postAjaxSync("/user/pm/pm40/select_pm40_Info", formData, null, function(data) {
		if (data.result.workNo) {	//해당 자료가 존재해야함
			$.each(data.result, function(key, value) {
				if ($('#popForm #' + key)[0]) {
					$('#popForm #' + key).val(value);
					if ($('#popForm #' + key).is('[comma]')) {
						onlyNumber($('#popForm #' + key)[0]);
					}
				}
				if (key === "userNm") {
		            $("#popForm #ordrgNm").val(value);
		        }
				if (key === "userId") {
		            $("#popForm #ordrgId").val(value);
		            
		            if (value != jwt.userId ) {	//수정 버튼 작성자이면 수정 가능하게 하고 아니면 수정버튼 숨김
						$('.popup_area #actionBtn').hide();
					} else {
						$('.popup_area #actionBtn').show();
					}
		        }
			});

			// 크기 조절할 textarea ID 리스트
			const textAreas = [
			    '#workGoodTxt',  // 잘한점
			    '#workBadTxt',   // 아쉬운점
			    '#workNeedTxt',  // 개선할점
			    '#workProposalTxt', // 건의사항
			    '#workRmk'       // 비고
			];
			// 각 textarea에 대해 크기 조절 함수 호출
			textAreas.forEach(textAreaId => {
			    txtareaHeightResize($(textAreaId));
			});
			
			selectApprovalCheck(data.result.workNo);
			
			
		} else {
			alert('해당 고찰 자료가 없습니다.  전산실 확인 바랍!')
		}
	});
}

//등록
function insert_pm40() {
	if (inputValidation($('.popup_area [required]'))) {		// 필수 필드의 유효성 검사
		var formData = makeFormData();						// 요청이 통과하면 makeFormData() 함수를 이용해 formData를 생성
		filePostAjax("/user/pm/pm40/insert_pm40", formData,	function(data) {
			alert(data.resultMessage);
			if (data.resultCode == 200) {		//  요청이 성공(200)한 경우, gridView.setData(0)를 호출하여 그리드 뷰를 업데이트하고,
				$('#workNo').val(data.workNo);
				//kakaoTodo();
				
				 window.history.back();			// 모달을 닫음
			}
		});
	}
}


// 수정
function update_pm40() {
    if (inputValidation($('.popup_area [required]'))) {
    	//문제여부가 이면 제목 입력은 필수처리하기 위함
        

        $('#actionBtn').hide();
        var formData = makeFormData();
         filePostAjax("/user/pm/pm40/update_pm40", formData,function(data) {
        	 
        	 alert(data.resultMessage);
                    if (data.resultCode == 200) {
                    	
                            kakaoTodo();
                       
                        window.history.back();
                    }
                }); 
    }
}

function makeFormData() {
    // 날짜 하이픈 제거
    $.each($('.popup_area input[date]'), function(idx, elem) {
        deleteHyphen(elem);
    });


    // 폼데이터 생성
    var formData = new FormData($("#popForm")[0]);

		
		var writeDt = $("#cWorkYm").val().replace(/\-/g, '');
		$("#deptCd").val(jwt.deptId.slice(0,5));
		formData.append("userId", $("#popForm #ordrgId").val());
		formData.append("workYm", writeDt);
		formData.append("workDiv", "개인");
		formData.append("deptCd", $("#deptCd").val());


    return formData;
}


// KAKAO 알림톡 모듈 부분 //////////////////////////////////////////
function kakaoSendBody(todoDiv1CodeId, todoDiv2CodeId, todoDiv1CodeNm, todoDiv2CodeNm, gubun) {
    let param = {
            "tmplatDiv": "TMPLATDIV04"
            , "coCd": $("#popForm #coCd").val()             //해당업무의 coCd(트르넷발주 TRN )
            , "todoDiv1CodeId": "" //"TODODIV10"                 //공통코드 해당업무 - 결재
            , "todoDiv2CodeId": "" // "TODODIV1030"                   //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv1CodeNm": "" // "WBS문제"                        //공통코드 해당업무 - 결재 - 발주서
            , "todoDiv2CodeNm": "" // "WBS계획문제"                       //공통코드 해당업무 - 결재 - 발주서
            , "sanctnDiv2": gubun                            //템플릿 결재구분2    #{sanctnDiv2} 처리 바랍니다.
            , "todoNo": $("#popForm #workRptNo").val()
            , "clntCd": "1"                 //발신회사는 로그인사용자 회사
            , "clntNm": ""             //로그의 수신거래처명
            , "ordrgMngNm": jwt.userNm        //발주작성자(담당자)
            , "ordrgMngTelNo": $("#popForm #telNo").val()       //담당자전화번호
            , "creatPgm": "PM0101P01_M"
            , "userId": jwt.userId
            , "todoTitle": $("#popForm #issueTitle").val() // 문제 제목
            , "text": $("#popForm #workRptRmk").val() // 비고
    }
    commKaKaoSendTodo(param);
}

function kakaoTodo() {

    //message load
    if (kakaoErr.length == 0) {
        var paramObj = {
            "userId" : jwt.userId
            , "codeKind" : "KAKAOMSG"
        };
        postAjaxSync("/user/sm/sm02/selectCurrToday", paramObj, null, function(data) {
            if(data.resultList.length > 0 ) {
                kakaoErr = data.resultList;
            }
        });
    }

   let clntNm = (jwt.coCd=="GUN") ? "(주)건양ITT" : "트루넷";

   kakaoSendBody('','', '작업일보','작업일보 문제','공유');

   if (kakaoCnt > 0) {
       kakaoCnt = 0;
     //alert("알림톡이 정상 발송되었습니다.");
   }
}

//to-do결재요청 알림톡
function commKaKaoSendTodo(param) {
//    console.log('---카카오 발주서 발행 알림톡발송시작 --' + param);

   //알림톡수신번호 채번
   var maxMessageId = null;            //message id(unique key)
   var talkMessage = null              //발송될 내용 template
   var mobile = null                   //수신인 휴대전화번호
   var title = null                    //todo title
   var sendList = [];
   let talkParam = {};
   let talkBody = {};
   let sendCnt = 0;
   postAjaxSync("/user/bm/bm18/selectPmMaxMessageIdTodo", param, null
               , function(data) {
                   if(data.resultList.length > 0 ) {
                       if( data.resultList[0].maxMessageId != "" ) {
                           sendList = data.resultList;
                       } else {
                           alert("알림톡 발송을 위한 messageId 생성에 실패 했습니다.");
                           return;
                       }

                   }
   });
   //user search ajax end

   //대상 loop
   $.each(sendList, function (key, sendObj) {
       maxMessageId = sendObj.maxMessageId;
       talkMessage = sendObj.messageDesc;
       mobile =  sendObj.telNo;
       //로그용
       param.rcvId = sendObj.todoId;           //todo 수신id
       param.rcvNm = sendObj.name;             //todo 수신자명
       param.name = sendObj.name;                //todo 수신자명

       // 알림톡 Title 자리수 제한 문자열 자르기
       if (sendObj.todoTitl.length > 30) {
           title = sendObj.todoTitl.substring(0,25);
       }
       else {
           title = sendObj.todoTitl;
       }

       param.title = title; //요청내용제목
       //------------------------

       param.sendDt = sendObj.sendDt;

       // 비고란 문자열 자리수 자르기 30자
       var strText = null;
       if (param.text.length > 50) {
           strText = param.text.substring(0, 50);
       }
       else {
           strText = param.text;
       }
       param.text = strText;
       //------------------------



       if(mobile == "" || mobile == null) {
           alert('수신전화번호가 없습니다.\r\n['+clntNm+'] 거래처관리의 사업부 첫번째 항목을 확인해 주십시오.');
           return;
       }
       if(talkMessage == "" || talkMessage == null) {
           alert('발송할 내용이 없습니다.\r\n알림톡템플릿관리를 확인해 주십시오.');
           return;
       }

       //message 치환
       let message = talkMessage;
       let splitStr = Array.from(message.matchAll('\\{(.*?)\\}'), match => `${match[0]}`);
       //loop
       $.each(splitStr, function (key, val) {
           let compKey = val.substring(1, val.length-1);
           if( compKey != "" && compKey != "undefined" ) {
               if( typeof(param[compKey]) != "undefined" ) {
                   let val2 = '#'+val;
                   message = message.replaceAll(val2, param[compKey]);
               }
           }
       });
       talkParam.authToken = "e/eDfZOFCsrBqadaECQ0+g==";
       talkParam.serverName = "gyitt2400";
       talkParam.paymentType = "P";
       talkBody.service = "2310086157";                //서비스번호(1000000000 - 예시  real : 2310086157
       talkBody.messageId = maxMessageId;          //고객사에서 관리하는 메시지No - 40byte (unique 값);
		if (title.length > 50) {
			title = title.substring(0, 49); // 50자까지만 자르기
		}
       talkBody.title = title;                 //알림톡 타이틀 -
       talkBody.message = message;             //알림톡 메시지 (1000 byte)
       talkBody.mobile = mobile;               //휴대전화번호
       talkBody.template = "10008";            //템플릿관리화면 템플릿ID - 발주서 V2
       let talkJson = JSON.stringify(talkBody);
       sendCnt = kakaoSendReal(talkJson, talkParam, param);
   });
   //대상 loop end
   if( sendCnt > 0 ) {
       //alert("알림톡 정상 발송되었습니다.");
       kakaoCnt++;
   }

   //한번대 보낼경우 이곳 사용 - 남실장님 한번더 보냄
  /*  talkBody.messageId = 'KAKAO'+Number(talkBody.messageId.substring(5, 20))+1;
   talkBody.mobile = "01063893764"
   talkJson = JSON.stringify(talkBody); */
   //kakaoSendReal(talkJson, talkParam, param);
}

function selectApprovalCheck(value) {
    var formData = {
          "reqNo" : value
    }
    postAjaxSync("/user/qm/qm01/selectApprovalChk", formData, null, function(data) {//결재가 진행이 되었는지 안되었는지 DB체크
       var list = data.result[0]
        if (list == 'Y'){//결재가 한개라도 진행이 되었으면 알림창

            //input readonly, radio.checkbox disabled
          $.each($('#popForm select, input, textarea'), function(idx, elem){
             var id = $(elem).attr("ID");
             if( id ) {
                var eleId = "#popForm #"+id;
                if( $(elem).prop('tagName') == "INPUT" ) $(eleId).attr("readonly", true);
                if( $(elem).prop('tagName') == "TEXTAREA" ) $(eleId).attr("readonly", true);
                if( $(elem).prop('tagName') == "SELECT" ) $(eleId).css({'background-color':'#e6e6e6', 'pointer-events':'none'});
                if( $(elem).prop('type') == "checkbox" || $(elem).prop('type') == "radio") $(eleId).on('click', function(e) {e.preventDefault();});
             }

          });

          $('#popForm #actionBtn').remove();
            $("#plus-minus").remove();
        }
    });
 }



function SetYm(){
	var now = new Date();
	var nyear = now.getFullYear();
	var nmon =  (now.getMonth()+1) > 9 ? ''+(now.getMonth()+1) : '0'+(now.getMonth()+1);
	
	$('#writeYm').val(`${nyear}-${nmon}`);
	$('#workYm').text(`${nyear}-${nmon}`);
	
}

function pasFloatChk (ivalue) {
	let value = ivalue +' ';
	const cvtValue = parseFloat(value.replace(/[^0-9.-]/g, '')); //숫자(0-9), 빼기 기호(-)가 아닌 모든 문자를 바꿉니다.
	return isNaN(cvtValue) ? 0 : cvtValue; //NaN이면 0로 대체 --> minus기호만 있는경우
}

 //결재 여부
 function approvalYn() {
   var gridList = gridViewPop.target.getList();
   var inCnt = 0;
   if( gridList.length > 0 ) {
        var msgArr = [];
        $.each(gridList, function (idx, elem) {
           //결재자가 본인이 아니면서 상태가 Y인 경우
           if( elem.todoId != jwt.userId && elem.sanctnSttus == "Y" ) inCnt++;
        })
   }
   return inCnt;
} 
	

 
 

//공유대상자 추가//
function insertShareUserModal() {
   if( approvalYn() ) {
     alert("결재가 이미 진행중입니다.");
     return;
  }

    var paramObj = {};
    var appshaList = gridViewPop.target.list;
    paramObj["coCd"] = $('#coCd').val();
    paramObj["useYn"] =  "Y";
    paramObj["userId"] =  $('#ordrgId').val();
    paramObj["userNm"] =  $('#ordrgNm').val();
    paramObj["approvalGrid"] = $.grep(appshaList, function(item) {return item.gb === "결재";
          }).map(function(item) {
                  return {
                    gb: "결재",
                    id: item.usrNm,
                    text: item.name,
                    parent: item.jik,
                    deptNm: item.dtNm,
                    telNo: item.telNo,
                    offTelNo: item.offTelNo,
                    email: item.email
                    , id: item.todoId
                    , todoKey: item.todoKey
                    , sanctnSn: item.sanctnSn
                    , sanctnSttus: item.sanctnSttus
                     , todoCfDt: item.todoCfDt
                     , todoCfOpn: item.todoCfOpn
                    , flag: item.flag
                    , coCd: item.coCd
                };
          });
    paramObj["shareGrid"] =  $.grep(appshaList, function(item) { return item.gb === "공유";
          }).map(function(item) {
                return {
                  gb: "공유",
                  id: item.usrNm,
                  text: item.name,
                  parent: item.jik,
                  deptNm: item.dtNm,
                  telNo: item.telNo,
                  offTelNo: item.offTelNo,
                  email: item.email
                  , id: item.todoId
                    , todoKey: item.todoKey
                    , sanctnSn: item.sanctnSn
                    , sanctnSttus: item.sanctnSttus
                     , todoCfDt: item.todoCfDt
                     , todoCfOpn: item.todoCfOpn
                    , flag: item.flag
                    , coCd: item.coCd
              };
        });

    openSecondModal("/static/html/cmn/modal/userLstSearch.html", 430, 500, "작성자 검색", paramObj, function (approvalGrid, shareGrid){
//       console.log('결재라인 : ', approvalGrid.target.list);
//       console.log('공유라인 : ', shareGrid.target.list);

      var appArray = approvalGrid.target.list.map(function(item) {
           return {
                 gb: "결재",
                 usrNm: item.id,
                 name: item.text,
              jik: item.parent,
              dtNm: item.deptNm,
              telNo: item.telNo,
              offTelNo: item.offTelNo,
              email: item.email,
              todoId: item.id
                 , todoKey: item.todoKey
                 , sanctnSn: item.sanctnSn
                 , sanctnSttus: item.sanctnSttus
                  , todoCfDt: item.todoCfDt
                  , todoCfOpn: item.todoCfOpn
                 , flag: item.flag
                 , coCd: item.coCd
           };
     });
      var shaArray = shareGrid.target.list.map(function(item) {
         return {
                  gb: "공유",
              usrNm: item.id,
              name: item.text,
              jik: item.parent,
              dtNm: item.deptNm,
              telNo: item.telNo,
              offTelNo: item.offTelNo,
              email: item.email,
              todoId: item.id
                 , todoKey: item.todoKey
                 , sanctnSn: item.sanctnSn
                 , sanctnSttus: item.sanctnSttus
                  , todoCfDt: item.todoCfDt
                  , todoCfOpn: item.todoCfOpn
                 , flag: item.flag
                 , coCd: item.coCd
           };
     });
       gridViewPop.setData2(appArray.concat(shaArray));

    });

}

function deleteShareUser(){

    if( approvalYn() ) {
      alert("결재가 이미 진행중입니다.");
      return;
   }

    var selRow = parseInt(gridViewPop.target.selectedDataIndexs);
    if( isNaN(selRow) ) {
//        alert("선택된 행이 없습니다.");
       return;
    } else {
          if( selRow > -1 ) {
             //gridViewPop.target.removeRow(selRow);
             var todoKey = gridViewPop.target.getList()[selRow].todoKey;
             var gridList = gridViewPop.target.getList("selected")[0];
         if( typeof(todoKey) == "undefined" ) {
            gridViewPop.target.removeRow(selRow);
            $.gridNoSet(gridViewPop, "sanctnSn");
         } else {
            var paramObj = {
                  todoNo: $("#popForm #workNo").val(),
                  todoKey: gridList.todoKey,
                  sanctnSn: gridList.sanctnSn,
                  todoDiv1CodeId: gridList.todoDiv1CodeId,
                  todoDiv2CodeId: gridList.todoDiv2CodeId
            }
            if( confirm("선택행을 삭제하시겠습니까?")) {
               deleteAjax("/user/wb/wb20/deleteTodoMaster", paramObj, null, function(data) {
                  if (data.resultCode == 200) {
                     alert(data.resultMessage);
                     gridViewPop.setData(0);
                  } else {
                     alert("삭제중 오류가 발생했습니다");
                  }
               });
            }
         }
       }
    }
 }
function txtareaHeightResize(obj) {
	const rowCount = obj.val().split(/\r\n|\r|\n/).length;

	if(rowCount < 4)
		obj.css('height', "60px");
	else
		obj.css('height', (rowCount * 20) + "px");
}

</script>

</body>

</html>