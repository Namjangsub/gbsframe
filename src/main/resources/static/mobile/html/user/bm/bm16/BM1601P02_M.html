<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">    
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css" />
    <link rel="stylesheet" href="/static/css/jstree/style.min.css" />
    <link rel="stylesheet" href="/static/css/gnb.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/mobile/css/sub.css" />
    <link rel="stylesheet" href="/static/css/common.css" />
	<link rel="stylesheet" href="/static/css/mobile.css" />

    <script src="/static/js/jquery-latest.min.js"></script>
    <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/ax5/ax5toast.min.js"></script>
    <script src="/static/js/jstree/jstree.min.js"></script>
    <script src="/static/js/global.js"></script>
    <script src="/static/js/fileTree.js"></script>
    <!-- 공통결재 -->
	<script src="/static/js/commApprovalMobile.js"></script>
    <style type="text/css">

    .table_input tr th {
	    text-align: left;
	    font-size: 10px;
	    color: #888888;
	    padding: 2px 2px;
	    border: 1px solid #e8ebf2;
	}
	
	.table_input tr td {
	    text-align: left;
	    height: 5px;
	    font-size: 12px;
	    padding: 3px 3px;
	    border: 1px solid #e8ebf2;
	    color: blue;
	    font-weight: bold;
	}
	</style>
</head>


<body>
	<div id="head_area" class="off">
		<div class="left_btn" onclick="history.back(-1)">
			<a class="back_btn"></a>
		</div>
		<h1 class="logo">
			<img src="/static/img/Logo_gunyangitt.gif" alt="건양ITT" />
		</h1>
	</div>

	<div id="main_area">
	    <h3 id="popupTit" class="tit">프로젝트 이슈관리</h4>
		<div class="contents search">
	
		<form id="popForm" onSubmit="return false;">
			<div class="form-group popup_table">
				<input type="hidden" id="coCd"     name="coCd">
				<input type="hidden" id="pgmId"    name="pgmId" value="BM1601P02_M">
				
				<table class="table_input">
					<colgroup>
					<col width="16%">
					<col width="34%">
					<col width="17%">
					<col width="33%">
					</colgroup>
					
					<tr>
						<th>고객사</th>
						<td><input type="hidden" id="clntCd" name="clntCd" readonly>
							<input type="text" id="clntNm" name="clntNm" readonly></td>
	
						<th>계약년월</th>
						<td><input  type="text" id="yyyymm" name="yyyymm" readonly></td>
					</tr>
					
					<tr>
						<th>고객사PJT</th>
						<td><input type="text" id="prjctCdNm" name="prjctCdNm" readonly></td>
						
						<th>계약명</th>
						<td><input type="text" id="prjctNm" name="prjctNm" readonly></td>
					</tr>
	
					<tr>
						<th>주요설비명</th>
						<td><input type="text" id="eqpNm" name="eqpNm" readonly></td>
	
						<th>수주예정일</th>
						<td><input  type="text" id="ordrsPlanDt" name="ordrsPlanDt" readonly></td>
					</tr>
	
					<tr>
						<th>수량</th>
						<td><input type="text" id="eqpQty" name="eqpQty" readonly></td>
	
						<th>예상납기일</th>
						<td><input  type="text" id="dudtPlanDt" name="dudtPlanDt" readonly></td>
					</tr>
		
			        <tr>
			          <th>이슈일자</th>
			          <td><input type="text" id="issDt" name="issDt" readonly></td>        
			          <th>진행상태</th>
			          <td><input type="text" id="issSts" name="issSts" readonly></td>  
			        </tr>
			
			        <tr>
			          <th>이슈번호</th>
			          <td><input type="text" id="fileTrgtKey" name="fileTrgtKey" readonly></td>
			          <th>완료일자</th>
			          <td><input type="text" id="actDt" name="actDt" readonly></td>        
			        </tr>
			
			        <tr>
			          <th>이슈내용</th>
			          <td colspan="3"><textarea id="issCnts" name="issCnts" readonly></textarea></td>
			        </tr>
			
			        <tr>
			          <th>원인</th>
			          <td colspan="3"><textarea id="causeCnts" name="causeCnts" readonly></textarea></td>
			        </tr>
			
			        <tr>
			          <th>조치내용</th>
			          <td colspan="3"><textarea id="actCnts" name="actCnts" readonly></textarea></td>
			        </tr>
			
		            <tr>
		                 <table>
		                     <tr>
		                       <td>※ 공유 및 결재</td>
		                       <td></td>
		                     </tr>
		                     <tr>
		                       <td colspan="2"><div class="ax5_grid" data-ax5grid="first-grid-modal" data-ax5grid-config="{}" style="height: 150px; width: 100%;" ></div></td> 
		                     </tr>  
		                 </table>       
		            </tr>
				</table>
			</div>
	    </form>
	</div>
	
    <div class="contents search">     
        <table class="table_input">
            <tr>
				<!-- todo 결재 -->
				<div align="center" style="width: 100%; height: 30%;">
					<div id="wbsPopup" class="popup_area">
						<!-- 결제창 -->
						<div id="approval_area"></div>
					</div>
				</div>  
            </tr>
        </table>    
	</div>           

</body>
<script type="text/javascript">

function getParams() {
	var url = window.location.search.replace('?', '');
	var params = {};
	var urlArray = url.split('&');

	for ( var i in urlArray) {
		var param = urlArray[i].split('=');
		params[param[0]] = param[1];
	}
	return params;
}

/*todo 결재*/
var btnApproval = null;
//div area id 
var htmlParam = {
	htmlArea : "approval_area"
};

//세션에 정보를 활용하여 승인처리3
//JSON.parse : JSON.stringify를 받을 때 / 문자열-> 자바스크립트로 변환
var paramObj = JSON.parse(sessionStorage.getItem('paramObj'));
//sessionStorage.removeItem('paramObj');제거??
if (paramObj && paramObj != "undefined") {
	//to-do 에서 넘어온 param;
	var popParam = paramObj;
	//추가로 넣어줄 param
	var approvalParam = {
		coCd : paramObj.coCd,
		todoDiv1CodeId : paramObj.todoDiv1CodeId,
		todoDiv2CodeId : paramObj.todoDiv2CodeId,
		pgmId : paramObj.pgmId
	};
	//삭제할 키가 있으면 쓴다.
	delete popParam.sanctnSn;
	delete popParam.pgmId;
	//결재/승인버튼 생성하기
	var commApproval = new Approval(htmlParam, approvalParam, popParam);
	commApproval.makeHtml();
} else {
	window.history.back();
}

// function approvalConfirm() {
// 	if (commApproval.confirmApproval()) {
// 		window.history.back();
// 	}
// }

var actionType = 'I';  //C:생성, U:수정,  I:조회
var paramPrjctSeq = null;
var paramIssNo = null;

$(document).ready(function() {
	$("#userId").val(jwt.userId);
	
	//fileTrgtKey 는 프로젝트번호-이슈일련번호 형태로 저장되어 있음.
	const parts = paramObj.fileTrgtKey.split("-"); //[0]프로젝트번호, [1]이슈일련번호
	paramPrjctSeq = parts[0];
	paramIssNo = parts[1];
	issNo      = parts[1];

	selectPrjctIssueInfo();	

	gridViewPop.initView().setData(0);
	
      if (actionType =='U' || actionType =='I') {
	  	  txtareaHeightResize($('#issCnts'));  //이슈현황 크기 조절하기
	  	  txtareaHeightResize($('#causeCnts'));  //원인 크기 조절하기
	  	  txtareaHeightResize($('#actCnts'));  //조치내용 크기 조절하기
      }
});

var gridViewPop = {
        initView : function() {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                showRowSelector: true,
                multipleSelect: false,
                sortable: false,
                target: $('[data-ax5grid="first-grid-modal"]'),
                header: {
                    align: "center",
                    selector: true
                },
                body: {
                     onClick: function () {
                        this.self.select(this.dindex);
                    },
                    onDBLClick: function () {
                    },
                    mergeCells : ["gb"],
                },
                page : {
                    navigationItemCount : 10,
                    height : 30,
                    display : true,
                    firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange : function() {
                        gridView.setData(this.page.selectPage);
                    }
                },
                columns : [
                        {key: "gb",                 label: "구분",        align: "center",   width: 40},
                        {key: "wbsPlancoCdNm",      label: "회사명",      align: "center",   width: 130, hidden: true},
                        //{key: "wbsSharngUserId",  label: "ID",        align: "center",   width: 130, hidden: false},
                        {key: "usrNm",              label: "ID",        align: "center",   width: 130, hidden: true},
                        {key: "empNo",              label: "사원번호",  align: "center",   width: 130, hidden: true},
                        {key: "name",               label: "성명",        align: "center",   width: 80},
                        {key: "jik",                label: "직위",        align: "center",   width: 60},
                        {key: "reqDate",            label: "요청일자",  align: "center",   width: 90},
                        {key: "todoCfDt",           label: "확인일자",      align: "center",   width: 130},
                        {key: "todoCfOpn",          label: "확인의견",  align: "left",     width: 200},
                        {key: "telNo",              label: "H.P",       align: "center",   width: 130},
                        {key: "sanctnSttus",        label: "sanctnSttus",  align: "center",   width: 130, hidden: true},
                      ]
                    });
                    return this;
                },

                setData : function(_pageNo) {
                    var targetObj = this.target;
                    var formData = {
                            "fileTrgtKey" : $("#popForm #fileTrgtKey").val(),
                            "reqNo" :  $("#popForm #fileTrgtKey").val(), 
                            "flag" : "N",
                            "pageNo" : _pageNo + 1
                    }
                    postAjax("/user/qm/qm01/selectShareUserlst", formData, null, function(data){ 
                    	if (data.result.length > 0) {   	
		                    var list = data.result;
		                        targetObj.setData({
		                            list : list,
		                            page : {
		                                  totalElements :  data.paginationInfo.totalRecordCount,
		                            } 
		                        });

		    					$.each(list, function(idx, elm) {
		    						if (list[idx].todoCfDt) {
										$("#prjctActionBtn").hide();
										$("#prjctCompleteBtn").show();
		    						}
		    					});
		          		      gridResize(); //그리드 높이 조정
                    	}
                    	else {
                    		 var paramObj = { 
                                     "userId": jwt.userId
                                     ,"appDiv": 'APPDIV07'
                             };
                             postAjax("/user/wb/wb20/selectSignResUserlstInit", paramObj, null, function(data){
	                             var list = data.result;
	                                 targetObj.setData({
	                                     list : list,
	                                     page : { totalElements : list.length } 
	                                 });
			          		      gridResize(); //그리드 높이 조정
                             });
                    	}
                    });
                },
    }


	function selectPrjctIssueInfo() {						//화면에 뿌리는 데이터
		var formData = {
			"prjctSeq" : paramPrjctSeq,
			"issNo"    : paramIssNo,
		}
		postAjaxSync("/admin/bm/bm16/selectPrjctIssueInfo", formData, null, function(data) {
				//프로젝트 정보
				if (data.PrjctInfo) {
					$.each(data.PrjctInfo, function(key, value) {
						if ($('#popForm #' + key)[0]) {
							$('#popForm #' + key).val(value);
							if ($('#popForm #' + key).is('[comma]')) {
								onlyNumber($('#popForm #' + key)[0]);
							}
						}
					});
				}
				//이슈 정보
				if (data.result) {
					$.each(data.result, function(key, value) {
						if ($('#popForm #' + key)[0]) {
							$('#popForm #' + key).val(value);
							if ($('#popForm #' + key).is('[comma]')) {
								onlyNumber($('#popForm #' + key)[0]);
							}
						}
					});
					
					$('.tit').text('프로젝트 이슈 수정');

					
				} else {
				} 
					
		});
	}

	
	function txtareaHeightResize(obj) {
		const rowCount = obj.val().split(/\r\n|\r|\n/).length;

		if(rowCount < 4)
			obj.css('height', "52px");
		else
			obj.css('height', (rowCount * 21) + "px");
	}
	
    function gridResize() {
    	let size = gridViewPop.target.list.length;
        let tagHeight = (size) * 27 + 50 ;
        tagHeight = tagHeight > 750 ? 750 : tagHeight;
        tagHeight = tagHeight < 100 ? 100 : tagHeight;
        gridViewPop.target.setHeight(tagHeight);
    }
</script>
</html>
