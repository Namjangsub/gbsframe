<!DOCTYPE html>
<html lang="ko">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/gnb.css" />
<link rel="stylesheet" href="/static/css/main.css" />
<link rel="stylesheet" href="/static/css/sub.css" />
<!-- <link rel="stylesheet" href="/static/css/common.css" /> -->
<link rel="stylesheet" href="/static/css/m_common.css" />
<link rel="stylesheet" href="/static/css/mobile.css" />

<script src="/static/js/jquery-3.5.1.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/js/global.js"></script>
</head>


<body>
	<div id="head_area" class="off">
		<h1 class="logo">
			<img src="/static/img/GUNCI.png" alt="건양ITT" />
		</h1>
    	<div class="menu_off" onclick="mobilelogoutClick();">
		    <a class="off_btn"></a>
		</div>
	</div>
	<div id="main_area">
		<ul class="mobile_menu">
<!--  		    <li><a class="btn type01" data-index="1"></a></li>	To-Do 결재 -->
<!-- 		    <li><a class="btn type02" data-index="2"></a></li>	개인작업일보 -->
<!-- 		    <li><a class="btn type09" data-index="9"></a></li>	출장비현황 -->
<!-- 		    <li><a class="btn type03" data-index="3"></a></li>	출장/휴가자현황 -->
<!-- 		    <li><a class="btn type04" data-index="4"></a></li>	매출/이익현황 -->
<!-- 		    <li><a class="btn type05" data-index="5"></a></li>	수주 현황 -->
<!-- 		    <li><a class="btn type06" data-index="6"></a></li>	매입 현황 -->
<!-- 		    <li><a class="btn type07" data-index="7"></a></li>	일정지연현황 -->
<!-- 		    <li><a class="btn type08" data-index="8"></a></li>	문제발생현황 -->
<!-- 		    <li><a class="btn type10" data-index="10"></a></li>	작업일보고찰 -->
<!-- 		    <li><a class="btn type09" data-index="12"></a></li>	관리자 문제등록 -->
<!-- 		    <li><a class="btn type11" data-index="11"></a></li>	출장자 사진 Upload -->
    
		</ul>
	</div>
	<script type="text/javascript">

		// 1) 메뉴 정의(권한/URL/아이콘을 한 곳에서 관리)
		const MENU_CONFIG = [
			{ id: 1,  url: '/static/mobile/admin/cm/cm11/M08.html',                icon: '/static/img/svg/customer.svg',  				text: 'To-Do 결재'		},
			{ id: 2,  url: '/static/mobile/html/user/pm/pm01/PM0101M01_M.html',    icon: '/static/img/svg/menu-board-svgrepo-com.svg',  text: '개인 작업 일보'		},
			{ id: 10, url: '/static/mobile/html/user/pm/pm40/PM4001M01_M.html',    icon: '/static/img/svg/mobile_menu02.svg', 			text: '작업 일보 고찰'		},
			{ id: 9,  url: '/static/mobile/admin/cm/cm11/M10.html',                icon: '/static/img/svg/menu-svgrepo-com.svg',  		text: '출장비 현황'		},
			{ id: 3,  url: '/static/mobile/html/user/pm/pm05/PM0501M01_M.html',    icon: '/static/img/svg/menu-svgrepo.svg',  			text: '출장/휴가자 현황'	},
			
			// 기존 코드에서 AUTH100 없으면 제거하던 메뉴들(4/5/6)
			{ id: 4,  url: '/static/mobile/admin/cm/cm11/M05.html',                icon: '/static/img/svg/mobile_menu04.svg',  			text: '매출/이익 현황',  	authAny: ['AUTH100'] },
			{ id: 5,  url: '/static/mobile/admin/cm/cm11/M03.html',                icon: '/static/img/svg/mobile_menu02.svg',  			text: '수주 현황',  		authAny: ['AUTH100'] },
			{ id: 6,  url: '/static/mobile/admin/cm/cm11/M02.html',                icon: '/static/img/svg/mobile_menu03.svg',  			text: '매입 현황',  		authAny: ['AUTH100'] },
			
			{ id: 7,  url: '/static/mobile/admin/cm/cm11/M09.html',                icon: '/static/img/svg/expired.svg',  				text: '일정 지연 현황'		},
			{ id: 8,  url: '/static/mobile/admin/cm/cm11/M07.html',    			   icon: '/static/img/svg/problem-solved.svg',  		text: '문제 발생 현황'		},
			{ id: 12, url: '/static/mobile/html/user/wb/wb24/WB2401P11_M.html',    icon: '/static/img/svg/user_helpdesk_contact.svg', 	text: '관리자 문제 등록'	},
			{ id: 11, url: '/static/mobile/html/user/pm/pm50/PM5001M01_M.html',    icon: '/static/img/svg/Images-04.svg', 				text: '출장자 사진 Upload'},
		];
		
		// 2) 권한 유틸 (jwt.authInfo가 문자열이라는 전제 유지)
		function buildAuthSet(authInfo) {
			const raw = (authInfo || '').toString();
			// "AUTH100,AUTH200" / "AUTH100 AUTH200" 등 혼합 케이스까지 방어
			return new Set(raw.split(/[\s,]+/).filter(Boolean));
		}
		
		function isAllowed(menu, authSet) {
			// authAny: 배열 중 하나라도 있으면 통과
			if (!menu.authAny || menu.authAny.length === 0) return true;
			for (const a of menu.authAny) if (authSet.has(a)) return true;
			return false;
		}
		
		// 3) DOM 렌더(필요한 메뉴만 1번을 출력)
		function renderMobileMenu(list, authSet) {
			const $ul = $('.mobile_menu');
			const html = list
				.filter(m => isAllowed(m, authSet))
				.map(m => {
					// type01.. 클래스 제거: CSS 변수로 아이콘 URL 주입(동적 메뉴에 최적)
					return `
						<li><a class="btn" data-index="${m.id}" data-url="${m.url}" aria-label="${m.text}" style="--icon-url: url('${m.icon}')"><span class="menu_text">${m.text}</span></a></li>`;
				}) .join('');
			$ul.html(html);
		}
		
		// 4) 이동(기존 insertPgmHistory 사용)
		function goUrl(url) {
		  if (!url) return;
		  try { insertPgmHistory(url); } catch (e) {}
		  location.href = url;
		}
		
		
		$(document).ready(function () {
			// 토큰 없으면 로그아웃 처리 유지
			if (!authorizationToken) {
				mobilelogoutClick();
				return;
			}
			
			const authSet = buildAuthSet(jwt && jwt.authInfo); //AUTH100 추출
			renderMobileMenu(MENU_CONFIG, authSet);
			
			// 이벤트 위임: 동적 생성된 a.btn도 동일하게 처리
			$('#main_area').on('click', '.mobile_menu a.btn', function (e) {
				e.preventDefault();
				goUrl(this.dataset.url);
			});
			
			applyResponsiveViewport.applyResponsive(1920, { mode: 'physical', designHeight: 911, lockScale: false, scalable: true });
		});

		
		//로그아웃
		function mobilelogoutClick(){
			localStorage.removeItem("access_token");
			localStorage.removeItem("authArr");

			deleteCookie("menuIdx");
			deleteCookie("menuSaveYn");
			
			$.ajax({
			    type: "GET",
			    url: "/customLogout?userId=" + jwt.userId,
			    beforeSend: function (request) {
		            request.setRequestHeader("Authorization", authorizationToken);
		        },
			    xhrFields: { withCredentials: true }, 
			    success: function() {
// 			        location.href = "/";
			    }
			});
			
			location.href = "/static/mobile/index.html";
		}

	</script>
</body>
</html>